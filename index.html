<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coachex-Pro ‚Äì Gesti√≥n de Profesores</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  
  <div id="root"></div>

  <script type="text/babel">
    // --- INICIO DEL C√ìDIGO DE LA APLICACI√ìN ---

    const { useEffect, useMemo, useState, createContext, useContext } = React;

    /**
     * Gesti√≥n de P√°del ‚Äì MVP en React (Canvas) - v25 con Perfil Extendido
     *
     * Cambios aplicados:
     * - (PERFIL) Se a√±aden secciones para Datos Bancarios, Horario Laboral y Pol√≠ticas de Cancelaci√≥n.
     * - (PERFIL) Se a√±ade funcionalidad para copiar datos bancarios al portapapeles.
     * - (CALENDARIO) El calendario ahora lee el Horario Laboral y sombrea las horas no disponibles.
     */

    // ------------------------------ Configuraci√≥n de Firebase ------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDU33ryp3wkbx0oJdhjC6pG3VkfNiqGk0Q",
      authDomain: "coachex-b1d9b.firebaseapp.com",
      projectId: "coachex-b1d9b",
      storageBucket: "coachex-b1d9b.appspot.com",
      messagingSenderId: "894665560100",
      appId: "1:894665560100:web:e8a61e0849f7675e1f88b1"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    const logoCircularBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARgAAAEYCAYAAACHjumMAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNWRHWFIAAAi/SURBVHhe7d3NchxFFgTQ9z3TvbObdHN3k50gQZCAkCCwQUKyE5BAgmQnQAIhISEhQYKsBCQksSQkyEHQQQ/d1b2u6dE+781/vj/V01N7dVVX1UP10sTq5r+d3d3dVwjf3t7e/f7+fvrV1VWflqX/aV33f11dXeHd3V39/f39W1dX1+3t7e23S0tLvVwunw54P/u3vC7L4c3/a+tA+F1dXXL//v3w9e3tLe7evYv79+9jdnY2ZmdnY3Z2Nmbn5+P9+/fx/v37eP/+fbz5+Tn279+P27dvY2dnZ8yvXz9+e/z48b29vV1dXR3/9OlT7O3t/f2xsbE1NTV9fHw4Pz8fOzs7WF9fj42Njfj4+KC1tRVvb2/Yr7/G+fl5+Pj4wMbGhv+P45/++MUXX/z6t7/97d//+te/1n/u3NxcbTQazc3Nxd7e3g3c3t6u4eHhTU36v37+w4cPNzw8vGkYhr34u7u7tby8vCktLU07OztV//X29mr53/1u5+LFi7l48aKS/0sS/d/V1TXv7u52z/8lSX+P4/9/f/+/t7d3c35+vqZpWlNTU6sF/y+l2/s45v+P4x/f3t7e//r27Zuqqqoq/vPnz/H+/Xt4eXnB5uYmhoaGMDY2hrGxMcydOxcTE0sYHx/P2J/+lLGxscw/fy5jY2MZm5tLmJ+fx/bt2/j06ZNNT/Hjx4+4efMmbty4gQsXLmBoaAgjIyOYmJiA6dOnsXjxYhgdHY3h4WEsXrwYQ4YMwcSJE7F7925cuHABd3f44GzNzc3FzMxMJiYmMDEwAAd3+MAnTpyAt7c3LCwsICQkBBISEjAyMgJxcXF49OgRfv/998yfP5/Vq1fx/v37OH/+PF5eXvB92dnLly9x7tw5/O1vfwufz4fL5cLKygpu3ryJmzdvIjIyEpGRkVi/fj0WLFiAEydO4MSJE5iYmIDs7Gzk5eWhvLwcS5YswebNm/Hx8UFeXh4KCgqwaNEirFixAgsWLMD69evZ3d3d639f7h/b29v/z5n4+/t/+/DhA16ePMHp06f5tW+//fb/3bt3D/f39yvz8/M1Ozs7tbm5uVrc3d0ttbe3q+7u7ur8/Lzq7e3Nl5aWqu7u7mp9fX1fV1fX/aWlpS1LS0s/W1paXlpbW5+VlZWzQf63ubn54eXl5fMhSRL9f3t7++7p/6/tXz9/dXW1urq6Wh0dHVVPT091dXV1VVdXV2+0b319vbpabTab29vba7Wa/H/p3T6u+X/qH9/e3v7/rq6uYnx8/O+PjY2hq6sLGzdu4PLlywgLC8P169dx/fp1JCQk4MKFC7h69SpCQkIQHx+PixcvisdLS0tITU3FuXPncOPGDdTX13PhwgWcP38ea9euZenSpahYsSJeXl5Ys2YNS5YsQUlJCZKSklCzZg2zZ8+GoaGh16KLi4txdnYmCAJxcXGwsrLi9evXUf/2t/g++yv45fXr1/H73/8eZWVl2LhxIzZu3IjVq1fj2bNnePbsGRYXF/H69Wv4fL6o/Mknn2Dbtm14++23+fn54eDBg1izZg0LFizAyZMncenSJSxevBj//Oc/YWVlBVeuXMHhw4dx6dIlPPnkkwB8/fp1lJeX4sKFC9i0aRMmTpyIH/7wB3z22WfMzs5y584dPPzwwzg7O+Ptt99m165d+Oc//wknJyd8+eWXWLRoEa5fv46ioiJ8/PHHuP79u/jv//5vbN26Fe3t7Vi3bh3WrVuHTp06YfXq1di2bRtef/11nn/+eSxfvhyrV6+GkZERLF26lDfeeINdu3bh0qVLmD17NpYtW4bf/va3+PHHH7Fv3z48efKEEydOIDk5GY8ePeLChQs4f/48rl+/jhMnTuDgwYM4f/48XF1dUVZWxn379uH+/fvYvn079uzZg3379mHPnj34fP/9WLJkCW7cuAEHBwfg6e6E3/0O+N///g+ys7PxwQcfYNSoUZg+fTp++9vfcurUKX4+OgQPP/ww3nzzTaxZs4Znz57h2LFjLF++HHfffTd+++03nn32WTz77LOMjIygdevW4OjoyMsvv8wPP/zAysoKPvvsM4YMGYIffviBwsJCrFu3DjNnzsSKFSuwa9cuffHFF3jjjTcoKSlBV1fXdevW4eGHH2bWrFnYuHEjZs+ejRdffJFhw4Zhy5YteO6551i5ciXGxsaIjY1FfHw8wsLCkJSUhKysLJycnFBcXMyKFSv4/PPPuXjxIv7whz/guuuuw8svv4zFixdjtWrVePXVV/nss8/YuHEjMjMzmThxIl5//XUWLFiAadOmYciQIUhLS0NqaipCQkLw4MEDnD59mnXr1uGyyy5Dr169sHjxYixatAjPPfccS5cuRXJyMmJjYxETE4PExETExMQgLi4OQUFBCAwMxNSpU/HHH3/w5JNPcu/ePfzyl7/Eo48+ivz8fLzzzjtIT09HXl4eXnzxRSxatAh/+tOfOHbsGOx2O0JDQxEREYF79+7h1q1b+OGHHxgaGoLDw/u4ffs21q5diwceeICUlBSMHz8eXbt25d///newWq148MEHuWvXLuzdu5clS5bg3//+N2bOnImxsbHEx8czbtw4JCQk4MKFC7hz5w58Ph/sdjveeecd/v3vf2Pbtm0sWLCA0aNHc9ppp2HdunU4ODjg3LlzCAgIQFhYGIYOHYrhw4dDJpOhqKgImZmZTJ48mSeeeILNmzcjJSUFWVlZnDx5kujoaKxevRqTJ0/GysoKrly5wkknnYTnnnuOlStX4oUXXmDNmjWYPn06vvvuu7766iuqqqooKCiAy+WCu7t75Obm4tGjR6iqquKtt97iX//6V7788kusX78eGzdu5IcffmDjxo1Ys2YNnn32WZYtW4anT5/iyJEjmDRpEnbt2sUbb7zBuXPn8OabbzJ06FDs3r2bgQMHYubMmVixYgXWrl2LjIwMnDp1invvvZcRI0YwduxYPPfcc9x9990AHD9+nMDAQPzwhz/EtGnTcOjQIaSlpfH6668zZ84cBAUF4b333mPhwoV4//33+fLLL9Hb24u77rqLX/3qV3z99dfY2Nhg27ZtWLFiBfn5+SxYsICxY8eybds2XH311axdu5all13G3Llzeeqpp9i/fz/ee+89hg8fjq1btzJkyBC++OILRo8ezenTp/npp59YtWoVli9fzhtvvMH06dM5derUN4C1tbW54IILmDZtGiZOnMiYMWOYMGHCm5aWloqnnnoKExMTjB07Fr/5zW+45ppruOGGG5g2bRpGRkZIS0vD559/ztixYxkxYgRjxoxh3LhxTJo0CQkJCZibm8P4+DjGxsZw9+5dxMbGsGzZMpw8eRKHDx+GzWbDT3/6U3p1683ChQs5d+4cpk+fzksvvQRbt25l1KhRnHnmmSxcuJDVq1dz8803M3z4cAYPHgwA//nPfxg6dCj2799vdnZ2/PXXX8yePZsDBw5w0003YXR0FGvXrmXTpk0MHDiQW2+9lUWLFvHkk0+ybNmyr2WzZs2K2NhYjBgxAm+//TalpaXMnDmTefPmoaurC3V1dcycOZP33nuPJ598kpdffpnJkydz3nnnYWBgwBtvvMH3339vdnZ23HLLLcjNzeXuu+/m+eefZ86cOZimKfz85z/n/PPPV72nTp2KkSNH4qabbuL666/noosuYvDgwUycOBHz58+v+h/84Ad888033H///axdu5ann36aVatWsWjRIu666y7GjBljbm5ufvvb3/LVV1/x8ssvc/nllzNp0iSee+45Ro0axZQpU1ixYgX33XcfM2bM4D//+Q8PP/wwH3zwAb169cKDDz7Ipk2bmDFjBlatWsXSpUuZPXs2zzzzDH//+9959tlnWbFiBfr6+vjss8+YPHnyG97a2tp8+umnXH/99Vx00UU89dRT/O///s+oUaMAlJSU4Mknn+Thhx/m5ptvZvny5fzsZz/D5ZdfzpNPPsngwYPx8MMP4+zsjDvuuIN//etf/OpXv+LHH3/kzjvvZNeuXbzwwh7cddddfP3117z++utUVVWxbNky7rzzTtasWcN///tfxo0bx+LFi7nmmuu46KKLmDBhAu666y6WLFnCPffcw5lnnslZZ53FggUL+N///s/555/PH/7wB6ZNm8a4ceN44403mDVrFu677z4AYmNjsX37djZt2sRbb71FSkqK9555n2uuuQYrVqygpaWF22+/nQsuuIBPP/0UkydP5sYbbwSgsLDQ66/97//+DwAfffQRTz75JLfddhvPPfccAwYMIDU1lZtvvhmAkJAQRkZG+Pvf/y61P/7xD958801+8IMf4OzsjJtuuomKigo+/vjjm97r6+vTzMwMv//97zl9+jQPPvggzz77LHl5eSxdupQVK1bg4MGD9Pb2snfvXgIDAzk3N1fq//6/Wf6/p6dH8fHxL5eWlr6WJG3atOnUqVPL169ff5j//fff/73d3d3/tNNOO317e3uSJKlpmqZpXFxcfDjn/5v85z+fTUlKSkr4f+utt/5VSqn9ftQy/Q/9o2l8fHz4+vqipaUFlZWV6N+/PxkZGbzxxhvExcWxcuVKLFy4EB07duTNN9/Em2++CUBAQEAvr/3iiy9y+vRpRo0axdSpU/n6668ZOXIk//3vfzl8+DAvvPACW7duxdSpU1m6dClz5syhV69enD59mq5duzJw4EBuvvlm5s+fz0033YTDw/vU1NTwox/9CGVlZczNzSEvL4/S0tJq8fHxweHDh7FixQpKSkqIiYkhPDyc7373OxISEti4cSMzZszgnnvu4dNPP4XP54tKf/7znxk4cCA+Pj4YPXo0Tz75JPLy8tiyZQu///3vKSgowJtvvsnvf/97/va3v2HHjh3MmzcPXbp04fzzz+fs2bP429/+xueff05WVhaWLFnyBn9+fp7k5GTmz5+PefPm+fa3v2XdunUsW7ZMgKqq8vDw4MEHH2TOnDk88sgj7Ny5k3nz5vHqq68yZ84crrjiCvr6+vjTn/6Ujz76iIqKCu666y6uueYaVq5cyYwZM/jXv/7FihUrmDVrFkePHmX+/Pl8++23PPjgg2zbto3XX3+dqVOn8plnngEA//jHPxgyZAh/+9vfWLNmDaNHj2bixIl47LHHuOGGG9i7dy8LFy5kyJAhLFy4EG+//TYff/wxp0+fZvz48TzxxBO8/fbbTJw4kaSkJB588EFmz57NgQMH+Oijj1i4cCHPP/88y5Yt46c//WkmTpxITk4Ozz//PMePH8fKysobb7xx2dnZ0bVrV8LDwzly5Mhb/Nlnn+Hk5ITs7Gy++eYbbty4wbx581ixYgW/+MUvePbZZ3nooYfYu3cvAE899RTy8vL46quvWLFiBUeOHOHOO+/k4MGDFR8vXrwY27dv58477+T555+npqaGqVOnMnPmTKZNm8by5ctZv349zzzzDCNGjGDChAncc889fP755wCMHDmSZcuWMW3atE+Vf//73xk/fjyff/45y5Yt44wzzqC3txeVf//73/HGG2/wxBNPMHv2bJ566inuvfdeUlNTefrpp3nooYfYu3cv/vjHP7JmzRp27NiBdevWcdFFF7F8+XLmzJmDkydPYmRk5A3/5JNP0tTUxPTp03nllVdYt24dBw4cYN26dWzevBn9+vXj2LFjdO3alWHDhnHhhRdSu3ZtbrnlFl5++WU6duxoVlZWLFu2DCcnJ9atW4dVq1ahpaXFyy+/TOvWrbnx5ptZtGgRn3/+ObNnz+aJJ56orl/xxRf54IMPWLJkCefOnWNqaso/yPr/nZ6bTp06de3ChQul/D8eSJKkP/7xjx/+cPLkyZ/+t4n+r3Nzc/z9/f/u2tra38Y0Tbm5udX8v9XNZzKZ/H8ppf5+vPX/qX8s/f76+vrGxsbS19dHXFwcTp8+zeeff47Vq1ezbNky/P39CQgI4PXXX+eBBx5g2bJlePXVV9mxYwe7d+/mxhtv5Ec/+hGHDh3ikksumaWlJTY2NpgyZQp9+/aloKCAKVOm8PLLL7Nz50727NmDd999lyuuuIL6+vqUlZXx9ttvU15ezpUrV/LnP/+ZVatW0dPTQ0tLiyuvvJKenh4uXrzItGnTGDp0KCtXruTo0aPs378fp06d4oUXXqCqqory8nImTpyIUaNG0djYyOuvv46hoSGuu+46Zs2axbx589i0aRMvvPAC559/Pt999x19fX1MnDiR8ePH09LSApPJhIsvvpg1a9YwcOBA/vnPfzJo0KCfKu/evYuNGzcya9Yszp07x/r16xkzZgzvvPMOq1ev5rbbbuPIkSM0Nzdz11130d7ezssvv8zbb7/Niy++yLp167jhhhuoqKjgvvvuA8DRo0f57LPP+Oijj9i6dSt79+7lnXfeyaBBg5gzZw5PPPGE2rVr89xzz7FkyRKuueYaSkpK8PT0ZP78+QwZMoTx48ezbNkyxo0bR1NTExMmTOCdd95BoVCgqKiIpUuXYnp6mnvvvZelS5eyc+fOmx7/6KOP2LNnDwMHDqStrY1vfOMbXHTRRaxevZpz586xZcsWNBoNr7zyCsOHD+frr79m4MCBvPzyy2zevJnzzjuP3bt309XVxeuvv87s2bPp7u7m0Ucf5ZlnnmHatGlMmTKFSy+9lKlTp/Lss89yySWXUFNTw29+8xtmzJhBY2MjS5Ys4dJLL2XmzJn07t2bN954gwsuuACAkJAQZsyYwaFDh7jmmmsYPnw469ats3r16mvZ+fl5vvvuu5uSkpLccsstBAQE0NHRAQDY2Nhw5swZkpKSWLNmDStWrOCFF17gnnvuyTXXXEOTk5N3PcnJydx9993cf//9vPbaazyz7N9/T/N/s+T/9evXb+Xn5//N9fX1f6v/n/rHeP1/SRL9b0nS/O+7d+9+/s+p+H/r/2v9X5L0/1P/b0n6/1P/b37+9ddf/+3t7V1eXl6e/o/y/6/+/+aD/+/+v0dXV9fNzMz8f25vb+8G+f+a//fv37/L8fHx/Pz8/H/+/fbt27f/7+zsrP7+/v/n/H8u//v9/f1/u1wu/9f//P/V1VX4+vr+37m5udjf3/9//f9fX1/n5ubmHw5eXl5wcnKy6e/s7AwHBwf09fWxsbHx2z//5s2b/y1J+ve///3f8vnz529evHhxfHx8rP/bt2/fys/Pz9/f/1uS/j83Nzf7eDjn/38O+f+a/N9//fXXb2VlZSX/L0lSr9frdVX/P/Wf//zn1w1Jkj/U/9ekv6+rq+v29vby8vLy5v9N+v+dnp7+6evrq15fX5/6x/S/3N3d7efr/1f/+8b/L0n6/036/8vLy0tLS0vz/9f//729vev/af4/nJyc/Ovr6/P/j+m/1cXFBd///vevW7du/X/l//9fXFyMvr6+b/P/a/7/lStX/vW///u//2v+f+v/q39KSkpKSkpq/+f+/ftZ+/f0/y+Vv7+pqcnX1dXl5eXlbVNTk//r/z/y/0v94+zs7P+7vb19q/+/+sc0/n93d/dXnZ2dn7X//0v/b2pqqv4f2//X//8n/X/t/y//X729vZ9l/Z+V/n/1/3/L+n/r/5L+31Qq/W9+/vnnn/+b//81f+X/P/f+v1f//9X/b63//2/r/186/3/t/3/l/6v/f63//7a+v/X/P5Wqqv7/f6/+v63//6/+v63//2v//18q/+96f2v/v+X/r/7/a/+/pff/5c//k//v//j/+P6/J0iSfpL/vyT9/+v/f6X/v+b//yX/v7X+/19K6v9v6f1v6f1//P4v5f+/pff/lf//lf+/pf//lf//lf//lf/v7//6f8v/v1/9/xf/v+n/r+n//+f8/1/8/y/+/pf/fpb+/pf//5f+/y/+/pf//+f//xf+/8n//5v+/lf//+P7//1dK/3/V8r/v/X8r/v/r/V/+/1f+/5f+/4v+/tf//Wfr/2/9/lf//+v//lf//pP+/8v//+n+f8v//+v/fpP+fP//88/+7ubn5q87Ozj9L/3+T/v/l5eXla//n//9/29vbn2X9n5X+/2v/f0n/v2r/f6X//7n//2/y/+/y//+l+v+X6v+/pP/fpP+/+f9/2/+/Sv//Uv1/pf//Uv3/V/1/Vf+/+v/fpf/fpf+/Uv//1P//Vf//kv5/Jb9/+f8P/X8S/n+l//9c//9b8v+X7v+/pf+/pf+/pP+/Sv+/+v//kv7/5f+/pff/pf+/pf+/pfe/pf/fpfe/Sv+/8v//+n//0v//Uv7/kv5/Jb///b+l//9b+//X/v+7+v9/lf7/V/v/r/T/V6X//7v+/y/+f6/+f1/9/3f1//+6+v9f6f6/5f+/8v/f6f//7n//6//f9X//+f/f/n//+v+/2/+f5/k/7+k//+k//+k//+k//+k//9v/n+f/v9f+/9v/n9f/f+/4v/f+v/v+r/v9v/n+f//9b/f1f//7v+/6v+/7v+/+v+/7P+/2/+f7P+/6v+/0v3f5v+/3/+/8v3f5Pu//f4/w/9v+v9//v+f+v9/k/5/JP3/SP7/JP3/SP7/JP3/SP7/JP3/SP7/JP3/SP7/JP3/SP7/k/7/JP3/SP7/kv7/JP3/SP7/JP3/SP7/JP3/SP7/k/5/kv5/kv5/kv5/kv5/kv5/kv5/SP7/SP7/SP7/SP7/JP3/JP3/SP7/JP3/k/5/kv5/JP3/k/5/kv5/kv5/kv5/kv5/SP7/k/5/kv5/k/5/kv5/kv5/JP3/SP7/SP7/JP3/k/5/kv5/kv5/JP3/JP3/JP3/k/5/kv5/SP7/k/5/kv5/JP3/kv5/kv5/JP3/SP7/SP7/JP3/k/5/kv5/kv5/JP3/SP7/k/5/kv5/JP3/kv5/kv5/kv5/k/5/SP7/SP7/SP7/SP7/kv5/JP3/JP3/JP3/k/5/kv5/SP7/k/5/kv5/k/5/kv5/kv5/JP3/SP7/SP7/JP3/k/5/kv5/kv5/JP3/JP3/JP3/k/5/kv5/k/5/SP7/k/5/kv5/kv5/kv5/kv5/JP3/SP7/SP7/JP3/SP7/k/5/kv5/kv5/JP3/k/5/kv5/k/5/k/5/k/5/SP7/SP7/SP7/SP7/kv5/kv5/JP3/JP3/JP3/k/5/kv5/SP7/k/5/k/5/kv5/kv5/JP3/SP7/SP7/JP3/SP7/k/5/kv5/kv5/JP3/k/5/k/5/kv5/kv5/k/5/k/5/k/5/kv5/SP7/k/5/SP7/k/5/kv5/kv5/JP3/JP3/JP3/SP7/SP7/SP7/SP7/SP7/k/5/kv5/JP3/kv5/kv5/kv5/kv5/JP3/k/5/k/5/k/5/k/5/SP7/kv5/k/5/SP7/SP7/SP7/SP7/k/5/k/5/k/5/SP7/SP7/JP3/JP3/SP7/SP7/SP7/SP7/k/5/k/5/JP3/kv5/k/5/JP3/k/5/kv5/kv5/SP7/SP7/SP7/k/5/k/5/kv5/JP3/JP3/k/5/kv5/SP7/kv5/k/5/k/5/SP7/SP7/k/5/JP3/JP3/SP7/SP7/k/5/kv5/kv5/kv5/k/5/SP7/k/5/SP7/SP7/SP7/kv5/SP7/k/5/JP3/SP7/k/5/kv5/kv5/kv5/k/5/k/5/kv5/k/5/k/5/SP7/SP7/k/5/kv5/k/5/kv5/SP7/JP3/SP7/SP7/JP3/SP7/k/5/k/5/k/5/k/5/JP3/kv5/kv5/kv5/SP7/k/5/kv5/k/5/k/5/SP7/k/5/kv5/k/5/kv5/k/5/k/5/kv5/k/5/k/5/k/5/kv5/kv5/kv5/SP7/SP7/k/5/SP7/JP3/JP3/JP3/JP3/JP3/SP7/k/5/k/5/k/5/kv5/k/5/k/5/kv5/k/5/k/5/kv5/k/5/kv5/k/5/SP7/k/5/k/5/JP3/k/5/k/5/JP3/k/5/k/5/JP3/JP3/JP3/JP3/JP3/SP7/SP7/SP7/SP7/k/5/5/k/5/k/5/k/5/kv5/k/5/k/5/kv5/k/5/kv5/k/5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/k/5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/JP3/JP3/JP3/JP3/JP3/SP7/SP7/SP7/SP7/k/5/k/5/k/5/kv5/k/5/kv5/k/5/k/5/k/5/kv5/k/5/k/5/JP3/k/5/k/5/k/5/k/5/k/5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/JP3/JP3/JP3/k/5/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/kv5/k/5/kv5/k/5/k/5/kv5/k/5/kv5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/k/5/k/5/k/5/k/5/JP3/k/5/k/5/k/5/k/5/JP3/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/kv5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/k/5/JP3/k/5/JP3/JP3/k/5/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/kv5/k/5/k/5/k/5/k/5/kv5/k/5/k/5/JP3/k/5/k/5/k/5/k/5/JP3/JP3/JP3/k/5/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/kv5/k/5/k/5/JP3/k/5/k/5/k/5/k/5/JP3/JP3/k/5/k/5/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/JP3/JP3/JP3/JP3/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/JP3/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/a"
    const logoCoachexBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAakAAAAhCAYAAADf3/kYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNWRHWFIAABNqSURBVHhe7Z1tExtHFsZ/7iTbcBu3A0iAJEACyE0AERAgkECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAIElE/zQd4m16k027kBCwA5gB7AD2AHsALYTWP0N2mF5P/vX5n0d2A7sALYDW997D2A7sF2w/T2fB8AOYTsw/fXlYwdhB7ADWE2r7bJm5f348x3YDrCagD2w3l5kO7AD2AHsAI4DWy5tD2AHsANs8w/sQhL/j32P+9eM24TtwDbQeD9kYDewXfD8Y4f/O+wHdgBbP8f97uEHewBdhD/N+F/9f6/k/Qf8H/sM/6f//vf2P6/P8I+5uL8v//882/w/9X/83P+v0v//0n///z/Z2f+n/j/n//93/n/z//3/3L+fy///2v+n5L+/+//v+z/r///n//1/1f9f2v+/1n//0n7//n//0n7//n/n7b/nxv/35b/v+P/n7b/n/f/j/b/b///P97v//29//8f+v5f///z//3/j///n//v//3/b///t/3+Yv///f//+b+P///f//+b+v/3///+/9v9//z+X/v9v/v+X/v8v/f9v/v8n/v8n/f9P+v/f/P/P+v/P+v/f/P/f+v9/8/9f+v9/9f8/9f+/+v+f/v9P/v/f/P/P+v9v/n/b/v+X/v+v+f+/9f//2v//6v//6v//6v//6v//6v9/8/+/Wf//2v//6v//6v9/9f+f/P/P+v/P+v/P+v/f/P/f+v/P+v/f/P9v/n+b/v8n/f9v/v8n/f9P+v9v/n+b/v82/f9v/v+b/v8v/f9v/n+T/n8yP/9k=";
    
    // ------------------------------ Constantes y Utilidades ------------------------------
    const initialState = { 
      alumnos: [], 
      clases: [], 
      pagos: [], 
      gastos: [],
      perfil: {
        nombre: "Profe",
        apellido: "P√°del",
        telefono: "",
        precios: { individual: "5000", dupla: "4000", trio: "3500", cuarteto: "3000", escuelita: "2500" },
        preciosMensuales: { "1xSemana": "18000", "2xSemana": "32000", "3xSemana": "45000", libre: "55000" },
        metodoCobro: "porClase",
        modoTrabajo: "Independiente",
        canchas: "Club A - Cancha 1\nClub B - Cancha 2",
        // --- NUEVOS CAMPOS A√ëADIDOS ---
        datosBancarios: {
          alias: "",
          cbu: "",
          banco: "",
          titular: ""
        },
        politicasCancelacion: "Las clases deben cancelarse con 24hs de antelaci√≥n para no ser cobradas.",
        horarioLaboral: [
          { dia: "Lunes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Martes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Mi√©rcoles", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Jueves", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Viernes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "S√°bado", activo: false, desde: "10:00", hasta: "14:00" },
          { dia: "Domingo", activo: false, desde: "10:00", hasta: "14:00" },
        ]
        // --- FIN DE NUEVOS CAMPOS ---
      }
    };
    
    const DIAS_SEMANA_NOMBRES = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
    const MESES_NOMBRES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    const DEPORTES = ["P√°del", "Tenis"];
    const ESTADOS_ALUMNO = [{value: "activo", label: "Activo"}, {value: "espera", label: "Lista de espera"}];
    const ESTADOS_CLASE = ["Programada", "Realizada", "Cancelada", "Ausente"];
    const TIPOS_CLASE_MAP = { Individual: 1, Dupla: 2, Trio: 3, Cuarteto: 4, Escuelita: 1 };
    const TIPOS_CLASE = Object.keys(TIPOS_CLASE_MAP);
    const TIPOS_CLASE_NOMBRES = { Individual: "Individual", Dupla: "Clase para 2", Trio: "Clase para 3", Cuarteto: "Clase para 4", Escuelita: "Escuelita" };
    const METODOS_PAGO = ["Efectivo", "Transferencia", "Mixto", "Mensual","Pendiente"];
    const CATEGORIAS_GASTO = ["Alquiler", "Equipamiento", "Servicios", "Varios"];
    const PLANES_PAGO = [{value: "porClase", label: "Por Clase"}, {value: "mensual", label: "Mensual"}];
    const FRECUENCIAS_MENSUALES = [{value: "1xSemana", label: "1 vez por semana"}, {value: "2xSemana", label: "2 veces por semana"}, {value: "3xSemana", label: "3 veces por semana"}, {value: "libre", label: "Libre"}];
    const MESES_RECURRENCIA = [1, 2, 3, 4, 5, 6, 9, 12];
    const HORAS = Array.from({ length: 16 }, (_, i) => `${String(i + 7).padStart(2, '0')}:00`); // De 07:00 a 22:00
    
    // --- Utilidades ---
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toDigits = (s = "") => String(s).replace(/[^0-9]/g, "");
    const waLink = (telefono = "", nombre = "") => {
      const digits = toDigits(telefono);
      if (!digits) return null;
      const msg = encodeURIComponent(`Hola ${nombre || ""}!`);
      return `https://wa.me/${digits}?text=${msg}`;
    };
    const getWeekStartDate = (date) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setHours(0, 0, 0, 0);
      return new Date(d.setDate(diff));
    };
    const addDays = (date, days) => {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    };
    const formatDate = (date, format = 'yyyy-mm-dd') => {
      if (!date) return '';
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      if (format === 'dd/mm') return `${day}/${month}`;
      return `${year}-${month}-${day}`;
    };
    const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : 'Alumno eliminado';

    // ------------------------------ UI B√°sicos ------------------------------
    function Card({ title, right, children }) { return (<section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4"><div className="flex items-center justify-between mb-3"><h3 className="text-base font-semibold text-slate-800">{title}</h3>{right}</div>{children}</section>); }
    function Toast({ msg, onClose }) { useEffect(() => { if (!msg) return; const t = setTimeout(onClose, 2500); return () => clearTimeout(t); }, [msg, onClose]); if (!msg) return null; return (<div className="fixed top-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-xl shadow-xl z-50">{msg}</div>); }
    function Modal({ isOpen, title, children, onConfirm, onCancel, confirmText = "Confirmar" }) { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md"><h3 className="text-lg font-semibold mb-4">{title}</h3><div className="text-slate-600 mb-6">{children}</div><div className="flex justify-end gap-3"><button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg border">Cancelar</button><button onClick={onConfirm} className={`px-4 py-2 rounded-lg text-white ${confirmText === "Confirmar" ? "bg-red-600" : "bg-emerald-600"}`}>{confirmText}</button></div></div></div>); }
    function Topbar({ current, setCurrent, onLogout, perfil, onChangeModo }) { 
      const tabs = [ { id: "dashboard", label: "Dashboard" }, { id: "alumnos", label: "Alumnos" }, { id: "clases", label: "Clases" },{ id: "grupos", label: "Grupos" }, { id: "pagos", label: "Pagos" }, { id: "gastos", label: "Gastos" }, { id: "reportes", label: "Reportes" }, { id: "perfil", label: "Perfil" } ]; 
      return (
        <header className="w-full bg-slate-900 text-white">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <img src="logo flaticon.png" alt="Logo Circular" className="w-10 h-10 rounded-full"/>
              <div>
                <img src="logo_coachex N.png" alt="Coachex-Pro Logo" style={{ height: '24px' }}/>
                 <p className="text-xs opacity-80 -mt-0.5">Gesti√≥n de Profesores</p>
              </div>
            </div>
            <nav className="hidden md:flex items-center gap-3">
              <select value={perfil?.modoTrabajo || 'Independiente'} onChange={(e)=> onChangeModo(e.target.value)} className="px-3 py-1.5 rounded-lg bg-slate-800 text-white border border-slate-700" title="Modo de trabajo"><option value="Independiente">Independiente</option><option value="Club">Club</option></select>
              {tabs.map((t) => (<button key={t.id} onClick={() => setCurrent(t.id)} className={`px-3 py-1.5 rounded-xl text-sm transition ${current === t.id ? "bg-white text-slate-900" : "hover:bg-slate-800"}`}>{t.label}</button>))}
              <button onClick={onLogout} className="px-3 py-1.5 rounded-xl text-sm transition bg-red-600 hover:bg-red-700 text-white ml-4">Cerrar Sesi√≥n</button>
            </nav>
          </div>
          <div className="md:hidden px-3 pb-3 grid grid-cols-3 sm:grid-cols-5 gap-2">{tabs.map((t) => (<button key={t.id} onClick={() => setCurrent(t.id)} className={`px-3 py-2 rounded-xl text-sm transition ${current === t.id ? "bg-white text-slate-900" : "bg-slate-800 text-white"}`}>{t.label}</button>))}</div>
          <div className="md:hidden px-3 pb-3"><button onClick={onLogout} className="w-full px-3 py-2 rounded-xl text-sm transition bg-red-600 hover:bg-red-700 text-white mt-2">Cerrar Sesi√≥n</button></div>
        </header>
      );
    }
    
    function ClasesPorTamanoMes({ clases }) {
        const resumen = useMemo(() => {
            const ahora = new Date();
            const mesActual = ahora.getMonth();
            const anioActual = ahora.getFullYear();
            
            const clasesDelMes = clases.filter(c => {
                const fechaClase = new Date(c.fecha);
                return fechaClase.getMonth() === mesActual && fechaClase.getFullYear() === anioActual && c.estado === "realizada";
            });

            return TIPOS_CLASE.reduce((acc, tipo) => {
                acc[tipo] = clasesDelMes.filter(c => c.tipo === tipo).length;
                return acc;
            }, {});
        }, [clases]);

        return (
            <Card title="Clases por cantidad de alumnos">
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 text-center">
                    {TIPOS_CLASE.map(tipo => (
                        <div key={tipo} className="bg-slate-50 p-2 rounded-lg flex flex-col justify-between h-full">
                            <p className="text-xs text-slate-600 h-8 flex items-center justify-center">{TIPOS_CLASE_NOMBRES[tipo]}</p>
                            <p className="text-xl font-bold">{resumen[tipo] || 0}</p>
                        </div>
                    ))}
                </div>
            </Card>
        );
    }
    
    function Dashboard({ state, goToNewClass, goToEditClass }) {
        const { clases, pagos, gastos, alumnos, perfil } = state;
        const [currentDate, setCurrentDate] = useState(new Date());
        const [mostrarSoloHorarioLaboral, setMostrarSoloHorarioLaboral] = useState(false); // <-- AGREGA ESTA L√çNEA
const weekStartDate = getWeekStartDate(currentDate);
const weekDates = Array.from({ length: 7 }, (_, i) => formatDate(addDays(weekStartDate, i)));
        const alumnoMap = useMemo(() => new Map(alumnos.map(a => [a.id, `${a.apellido || ''} ${a.nombre || ''}`.trim()])), [alumnos]);

        const hoy = formatDate(new Date());
        const semanaInicio = formatDate(getWeekStartDate(new Date()));

        const clasesHoy = useMemo(() => {
            return clases
                .filter(c => c.fecha === hoy)
                .map(c => ({...c, nombresAlumnos: (c.alumnoIds || []).map(id => alumnoMap.get(id)).filter(Boolean).join(', ')}))
                .sort((a, b) => a.hora.localeCompare(b.hora));
        }, [clases, hoy, alumnoMap]);
        
        const balanceSemana = useMemo(() => {
            const ingresos = pagos
                .filter(p => p.fecha >= semanaInicio && p.metodo !== 'Pendiente')
                .reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
            const egresos = gastos
                .filter(g => g.fecha >= semanaInicio)
                .reduce((acc, g) => acc + parseFloat(g.monto || 0), 0);
            return ingresos - egresos;
        }, [pagos, gastos, semanaInicio]);
        
        const pagosPendientes = useMemo(() => {
            let pendientes = 0;
            const alumnosMensuales = alumnos.filter(a => a.plan === 'mensual' && a.estado === 'activo');
            const pagosMensualesMesActual = pagos.filter(p => p.concepto?.startsWith("Cuota Mensual") && new Date(p.fecha).getMonth() === new Date().getMonth());

            alumnosMensuales.forEach(alumno => {
                const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
                const totalPagado = pagosMensualesMesActual.filter(p => p.alumnoId === alumno.id).reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
                if (cuota > totalPagado) {
                    pendientes++;
                }
            });
            return pendientes;
        }, [pagos, alumnos, perfil]);
        
        return (
            <div className="grid gap-4">
                <Card title="Modo de trabajo">
                  <div className="text-sm">Modo actual: <span className="font-semibold">{(perfil?.modoTrabajo) || "Independiente"}</span></div>
                </Card>
                {(perfil?.modoTrabajo === "Club") && (
                  <div className="mb-4"><ClasesPorTamanoMes clases={clases} /></div>
                )}

                <div className="grid md:grid-cols-3 gap-4">
                    <div className="bg-blue-50 p-4 rounded-xl"><p className="text-sm text-blue-800">Clases de Hoy</p><p className="text-2xl font-bold text-blue-900">{clasesHoy.length}</p></div>
                    <div className="bg-orange-50 p-4 rounded-xl"><p className="text-sm text-orange-800">Pagos Mensuales Pendientes</p><p className="text-2xl font-bold text-orange-900">{pagosPendientes}</p></div>
                    <div className="bg-emerald-50 p-4 rounded-xl"><p className="text-sm text-emerald-800">Balance de la Semana</p><p className={`text-2xl font-bold ${balanceSemana >= 0 ? 'text-emerald-900' : 'text-red-900'}`}>${balanceSemana.toFixed(2)}</p></div>
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                    <Card title="Nueva clase" right={<button onClick={goToNewClass} className="bg-slate-900 text-white text-sm px-3 py-1.5 rounded-xl">+ Nueva</button>}>
                        <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nueva</b> para programar una clase.</p>
                    </Card>

                </div>
                <Card title="Agenda del D√≠a">
                    {clasesHoy.length === 0 ? (
                        <p className="text-sm text-slate-500">No hay clases programadas para hoy.</p>
                    ) : (
                        <ul className="space-y-2">
                            {clasesHoy.map(c => (
                                <li key={c.id} className="p-2 border-b flex justify-between items-center">
                                    <div>
                                        <p className="font-semibold">{c.hora} - {c.nombresAlumnos}</p>
                                        
                                        <div className="flex flex-wrap gap-1 mt-1">
                                          {(c.alumnoIds || []).map(id => {
                                            const pago = (pagos || []).find(p => p.claseId === c.id && p.alumnoId === id);
                                            const status = pago ? (pago.metodo === "Pendiente" ? "Pendiente" : "Pagado") : "Pendiente";
                                            const cls = status==="Pagado" ? "bg-emerald-100 text-emerald-700" : "bg-amber-100 text-amber-700";
                                            const nombreCorto = (alumnoMap.get(id) || "").split(" ")[0] || "Alumno";
                                            return <span key={id} className={`text-[11px] px-2 py-0.5 rounded-full ${cls}`}>{nombreCorto}: {status}</span>;
                                          })}
                                        </div>
<p className="text-xs text-slate-500">{c.tipo} en {c.cancha || 'N/A'}</p>
                                    </div>
                                    <span className={`px-2 py-0.5 rounded-full text-xs ${c.estado === 'Programada' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>{c.estado}</span>
                                </li>
                            ))}
                        </ul>
                    )}
                </Card>
<Card 
  title="Calendario Semanal" 
  right={
    <div className="flex items-center gap-4">
      <div className="flex items-center gap-2 text-sm">
        <input 
          type="checkbox" 
          id="vista-compacta" 
          checked={mostrarSoloHorarioLaboral} 
          onChange={(e) => setMostrarSoloHorarioLaboral(e.target.checked)} 
        />
        <label htmlFor="vista-compacta">Mostrar solo horario laboral</label>
      </div>
      <div className="flex items-center gap-2">
        <button onClick={() => setCurrentDate(prev => addDays(prev, -7))} className="px-3 py-1.5 text-sm rounded-lg border">‚Äπ Ant</button>
        <button onClick={() => setCurrentDate(new Date())} className="px-3 py-1.5 text-sm rounded-lg border">Hoy</button>
        <button onClick={() => setCurrentDate(prev => addDays(prev, 7))} className="px-3 py-1.5 text-sm rounded-lg border">Sig ‚Ä∫</button>
      </div>
    </div>
  }
>
  <CalendarioSemanal 
    week={weekDates} 
    clases={clases.filter(c => weekDates.includes(c.fecha)).map(c => ({...c, nombresAlumnos: (c.alumnoIds || []).map(id => alumnoMap.get(id) ? getNombreCompleto(alumnoMap.get(id)) : '').join(', ')}))}
    onEdit={goToEditClass}
    horarioLaboral={perfil.horarioLaboral}
    mostrarSoloHorarioLaboral={mostrarSoloHorarioLaboral}
  />
</Card>
            </div>
        );
    }

    function AlumnoForm({ initialData, onSubmit, onCancel, onRegisterMonthlyPayment, studentBeingEdited }) {
      const [form, setForm] = useState(initialData);
      
      useEffect(() => {
        const t = form.tipo || "";
        let size = 1;
        if (/^\d+x$/.test(t)) size = parseInt(t);
        if (/^Indiv/.test(t)) size = 1;
        if (/^Dupla|2x/.test(t)) size = 2;
        if (/^Trio|3x/.test(t)) size = 3;
        if (/^Cuart|4x/.test(t)) size = 4;
        if (/Escuelita/i.test(t)) size = 4;
        const base = (form.alumnoIds && form.alumnoIds[0]) || "";
        const ids = Array.from({length: size}, (_, i) => (i===0 ? base : (form.alumnoIds && form.alumnoIds[i]) || ""));
        if (!form.alumnoIds || form.alumnoIds.length !== size) {
          setForm(prev => ({ ...prev, alumnoIds: ids }));
        }
      }, [form.tipo]);
    const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };
      const addHorario = () => setForm(f => ({ ...f, horarios: [...(f.horarios || []), { dia: "Lunes", hora: "18:00" }] }));
      const delHorario = (idx) => setForm(f => ({ ...f, horarios: f.horarios.filter((_, i) => i !== idx) }));
      const setHorario = (idx, key, val) => setForm(f => ({ ...f, horarios: f.horarios.map((h, i) => i === idx ? { ...h, [key]: val } : h) }));
      function handleSubmit(e) { e.preventDefault(); if (!form.nombre.trim()) return alert("Ingres√° un nombre"); onSubmit(form); }
      return (
        <form onSubmit={handleSubmit} className="grid md:grid-cols-6 gap-3">
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Nombre</label><input name="nombre" value={form.nombre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: Sof√≠a" required /></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Apellido</label><input name="apellido" value={form.apellido} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: P√©rez" /></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Tel√©fono</label><input name="telefono" value={form.telefono} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: 549381..." /></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Contacto Padre/Madre (Escuelita)</label><input name="contactoPadre" value={form.contactoPadre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Nombre y tel√©fono" /></div>
          <div><label className="text-sm text-slate-600">Deporte</label><select name="deporte" value={form.deporte} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{DEPORTES.map(d => <option key={d}>{d}</option>)}</select></div>
          <div><label className="text-sm text-slate-600">Estado</label><select name="estado" value={form.estado} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{ESTADOS_ALUMNO.map(e => <option key={e.value} value={e.value}>{e.label}</option>)}</select></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Plan de Pago</label><select name="plan" value={form.plan} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{PLANES_PAGO.map(p => <option key={p.value} value={p.value}>{p.label}</option>)}</select></div>
          {form.plan === 'mensual' && (
    <div className="md:col-span-3 grid grid-cols-2 gap-3">
        <div>
            <label className="text-sm text-slate-600">Frecuencia</label>
            <select name="frecuencia" value={form.frecuencia} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">
                {FRECUENCIAS_MENSUALES.map(f => <option key={f.value} value={f.value}>{f.label}</option>)}
            </select>
        </div>
        <div className="flex items-end">
        <button 
    type="button" 
    onClick={() => onRegisterMonthlyPayment(studentBeingEdited)} 
    disabled={!studentBeingEdited} // Se deshabilita si es un nuevo alumno
    className={`w-full px-3 py-2 text-sm rounded-lg text-white ${!studentBeingEdited ? 'bg-slate-400 cursor-not-allowed' : 'bg-sky-600 hover:bg-sky-700'}`}
>
    Registrar Pago de Abono
</button>
{/* Y el mensaje de ayuda */}
{!studentBeingEdited && <p className="text-xs text-slate-500 col-span-2 mt-1">Guarda el alumno para registrar su primer pago.</p>}
        </div>
    </div>
)}
          <div className="md:col-span-6"><label className="text-sm text-slate-600">Horarios fijos</label><div className="grid gap-2">{(form.horarios || []).map((h, idx) => (<div key={idx} className="flex gap-2 items-center flex-wrap"><select value={h.dia} onChange={(e) => setHorario(idx, 'dia', e.target.value)} className="border rounded-lg px-3 py-2">{DIAS_SEMANA_NOMBRES.map(d => <option key={d}>{d}</option>)}</select><input type="time" value={h.hora} onChange={(e) => setHorario(idx, 'hora', e.target.value)} className="border rounded-lg px-3 py-2" /><button type="button" onClick={() => delHorario(idx)} className="px-2 py-2 rounded-lg border text-red-600 hover:bg-red-50">‚àí</button></div>))}<button type="button" onClick={addHorario} className="self-start px-3 py-1.5 rounded-lg border w-auto">+ Agregar horario</button></div></div>
          <div className="md:col-span-6"><label className="text-sm text-slate-600">Notas / Descripci√≥n</label><textarea name="notas" value={form.notas} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" rows={3} placeholder="Detalle particular del alumno" /></div>
          <div className="md:col-span-6 flex gap-2 justify-end"><button type="button" onClick={onCancel} className="px-3 py-2 rounded-lg border">Cancelar</button><button type="submit" className="px-3 py-2 rounded-lg bg-emerald-600 text-white">Guardar</button></div>
        </form>
      );
    }
    
function Alumnos({ alumnos, onCreate, onUpdate, onDelete, onRegisterMonthlyPayment , clases, pagos, onRegistrarClase, onPagarPendiente}) { // <-- 1. AQU√ç ACEPTAMOS LA NUEVA FUNCI√ìN
  const [q, setQ] = useState("");
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);
  
  
  
  const [busqueda, setBusqueda] = useState("");
const [alumnoFicha, setAlumnoFicha] = useState(null);

const emptyForm = { nombre: "", apellido: "", telefono: "", contactoPadre: "", deporte: "P√°del", estado: "activo", plan: "porClase", frecuencia: "1xSemana", notas: "", horarios: [] };
  
  const sortedAlumnos = useMemo(() => {
  const q = (busqueda || "").toLowerCase().trim();
  const fil = (alumnos || []).filter(a => {
    const n1 = (a.nombre || "").toLowerCase();
    const n2 = (a.apellido || "").toLowerCase();
    const nc = (getNombreCompleto(a) || "").toLowerCase();
    return !q || n1.includes(q) || n2.includes(q) || nc.includes(q);
  });
  return fil.sort((a,b)=> getNombreCompleto(a).localeCompare(getNombreCompleto(b), "es", {sensitivity:"base"}));
}, [alumnos, busqueda]);

  const filtered = useMemo(() => { 
    const s = q.trim().toLowerCase(); 
    if (!s) return sortedAlumnos; 
    return sortedAlumnos.filter((a) => [getNombreCompleto(a), a.telefono, a.deporte, a.estado].some((x) => (x || "").toLowerCase().includes(s))); 
  }, [sortedAlumnos, q]);

  function openNew() { setEditing(null); setShowForm(true); window.scrollTo({ top: 0, behavior: "smooth" }); }
  function openEdit(a) { setEditing(a); setShowForm(true); window.scrollTo({ top: 0, behavior: "smooth" }); }
  function cancel() { setShowForm(false); setEditing(null); }
  async function submit(formData) {
    if (editing) {
        // El modo EDICI√ìN sigue funcionando como antes
        onUpdate({ ...formData, id: editing.id });
        cancel();
    } else {
        // --- L√ìGICA NUEVA PARA CREAR UN ALUMNO ---
        if (formData.plan === 'mensual') {
            // Si el plan es mensual, guardamos al alumno y LUEGO abrimos el modal de pago.
            try {
                // 'onCreate' ahora debe devolver el nuevo alumno con su ID
                const nuevoAlumno = await onCreate(formData); 
                cancel(); // Cierra el formulario de creaci√≥n de alumno
                onRegisterMonthlyPayment(nuevoAlumno); // Abre el modal de pago para el alumno reci√©n creado
            } catch (error) {
                console.error("Error al guardar el alumno:", error);
                alert("Hubo un error al guardar el alumno.");
            }
        } else {
            // Si el plan es 'Por Clase', simplemente lo crea y cierra el formulario
            onCreate(formData);
            cancel();
        }
    }
}
  
  return (<>
    <div className="grid gap-4">
      <Card title={editing ? "Editar alumno" : "Nuevo alumno"} right={!showForm && <button onClick={openNew} className="bg-slate-900 text-white text-sm px-3 py-1.5 rounded-xl">+ Nuevo</button>}>
        {showForm ? (
            // --- üëá 2. AQU√ç LA PASAMOS AL FORMULARIO üëá ---
            <AlumnoForm initialData={editing ? { ...emptyForm, ...editing } : emptyForm} onSubmit={submit} onCancel={cancel} onRegisterMonthlyPayment={onRegisterMonthlyPayment} studentBeingEdited={editing} />
        ) : (
            <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nuevo</b> para crear un alumno, o en el l√°piz para editar.</p>
        )}
      </Card>
      <Card title="Listado de alumnos" right={<input value={q} onChange={(e) => setQ(e.target.value)} placeholder="Buscar" className="border rounded-xl px-3 py-1.5 text-sm" />}>
        <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Nombre Completo</th><th className="p-2">Tel√©fono</th><th className="p-2">Plan de Pago</th><th className="p-2">Estado</th><th className="p-2 text-right">Acciones</th></tr></thead><tbody>{filtered.length === 0 && (<tr><td colSpan={5} className="text-center py-6 text-slate-400">No hay alumnos</td></tr>)}{filtered.map((a) => (<tr key={a.id} className="border-t"><td className="p-2 font-semibold">{getNombreCompleto(a)}</td><td className="p-2"><div className="flex items-center gap-2"><span>{a.telefono || "-"}</span>{a.telefono && (<a href={waLink(a.telefono, a.nombre)} target="_blank" rel="noreferrer" className="inline-flex items-center px-2 py-0.5 text-xs rounded-full border text-green-700 bg-green-50 hover:bg-green-100">WhatsApp</a>)}</div></td><td className="p-2">{a.plan === 'mensual' ? 'Mensual' : 'Por Clase'}</td><td className="p-2"><span className={`px-2 py-0.5 rounded-full text-xs ${a.estado === 'espera' ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-800'}`}>{a.estado === 'espera' ? 'Espera' : 'Activo'}</span></td><td className="p-2 text-right"><div className="inline-flex gap-2"><button type="button" onClick={() => setAlumnoFicha(a)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">üëÅÔ∏è Ver ficha</button>
            <button type="button" onClick={() => onRegistrarClase && onRegistrarClase(a.id)} className="px-2 py-1 text-xs rounded-lg border bg-emerald-50 text-emerald-700 hover:bg-emerald-100">üü¢ Registrar clase</button>
            <button onClick={() => openEdit(a)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button><button type="button" onClick={() => onDelete(a.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button></div></td></tr>))}</tbody></table></div>
      </Card>
    </div>
  
      <AlumnoFichaModal alumno={alumnoFicha} clases={clases} pagos={pagos} alumnos={alumnos} onPagarPendiente={onPagarPendiente} onClose={() => setAlumnoFicha(null)} />
    </>);
}
    

function AlumnoFichaModal({ alumno, clases, pagos, alumnos, onPagarPendiente, onClose }) {
  const [periodo, setPeriodo] = useState("mes");
  const rango = useMemo(() => {
    const now = new Date();
    let from = new Date(0);
    if (periodo === "mes") { from = new Date(now.getFullYear(), now.getMonth(), 1); }
    else if (periodo === "tres") { from = new Date(now); from.setMonth(from.getMonth()-3); }
    else if (periodo === "doce") { from = new Date(now); from.setMonth(from.getMonth()-12); }
    return { from };
  }, [periodo]);
  const alumnoMap = useMemo(() => { const m = new Map(); (alumnos||[]).forEach(a => m.set(a.id, getNombreCompleto(a))); return m; }, [alumnos]);
  const clasesDelAlumno = useMemo(() => (clases || []).filter(c => (c.alumnoIds || []).includes(alumno?.id)), [clases, alumno]);
  const clasesFiltradas = useMemo(() => (clasesDelAlumno || []).filter(c => { const d = new Date(c.fecha); 
  const stats = useMemo(() => {
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    let realizadasMes = 0, deuda = 0, pagadoEf = 0, pagadoTx = 0, pagadoMixto = 0, pagadoMensual = 0;

    (clasesFiltradas || []).forEach(c => {
      const f = new Date(c.fecha);
      const enMes = f.getMonth() === thisMonth && f.getFullYear() === thisYear;
      const tam = (c.alumnoIds || []).length || 1;
      const precioClase = parseFloat(c.precio || 0) || 0;
      const unit = tam > 0 ? (precioClase / tam) : precioClase;

      const pagosClase = (pagos || []).filter(p => p.claseId === c.id && p.alumnoId === (alumno?.id));
      const hayPendiente = pagosClase.length === 0 || pagosClase.some(p => p.metodo === "Pendiente");
      if (hayPendiente) deuda += unit;

      pagosClase.forEach(p => {
        if (p.metodo === "Efectivo") pagadoEf += parseFloat(p.monto || 0);
        if (p.metodo === "Transferencia") pagadoTx += parseFloat(p.monto || 0);
        if (p.metodo === "Mixto") pagadoMixto += (parseFloat(p.detalleMixto?.efectivo || 0) + parseFloat(p.detalleMixto?.transferencia || 0));
        if (p.metodo === "Mensual") pagadoMensual += parseFloat(p.monto || 0);
      });

      if ((c.estado || "realizada") === "realizada" && enMes) realizadasMes += 1;
    });

    return { realizadasMes, deuda, pagadoEf, pagadoTx, pagadoMixto, pagadoMensual };
  }, [clasesFiltradas, pagos, alumno]);
return isNaN(d) ? true : d >= rango.from; }), [clasesDelAlumno, rango]);
  if (!alumno) return null;
    return (
<Modal isOpen={!!alumno} title={"Ficha de " + getNombreCompleto(alumno)} onCancel={onClose} onConfirm={onClose} confirmText="Cerrar">
      <div className="grid gap-4">
        <Card title="Resumen del mes">
          <div className="flex justify-end mb-2"><select value={periodo} onChange={(e)=> setPeriodo(e.target.value)} className="border rounded px-2 py-1 text-xs"><option value="mes">Mes actual</option><option value="tres">√öltimos 3 meses</option><option value="doce">√öltimos 12 meses</option></select></div><div className="flex justify-end mb-2"><select value={periodo} onChange={(e)=> setPeriodo(e.target.value)} className="border rounded px-2 py-1 text-xs"><option value="mes">Mes actual</option><option value="tres">√öltimos 3 meses</option><option value="doce">√öltimos 12 meses</option></select></div><div className="flex justify-end mb-2"><select value={periodo} onChange={(e)=> setPeriodo(e.target.value)} className="border rounded px-2 py-1 text-xs"><option value="mes">Mes actual</option><option value="tres">√öltimos 3 meses</option><option value="doce">√öltimos 12 meses</option><option value="todo">Todo</option></select></div><div className="grid grid-cols-3 gap-3 text-center">
            <div className="bg-emerald-50 p-3 rounded-xl"><p className="text-xs text-emerald-700">Clases realizadas</p><p className="text-xl font-bold">{stats.realizadasMes}</p></div>
            <div className="bg-amber-50 p-3 rounded-xl"><p className="text-xs text-amber-700">Deuda estimada</p><p className="text-xl font-bold">${stats.deuda.toFixed(2)}</p></div>
            <div className="bg-slate-50 p-3 rounded-xl"><p className="text-xs text-slate-600">Pagado</p><p className="text-sm">Ef: $${stats.pagadoEf.toFixed(2)} ¬∑ Tx: $${stats.pagadoTx.toFixed(2)} ¬∑ Mix: $${stats.pagadoMixto.toFixed(2)} ¬∑ Men: $${stats.pagadoMensual.toFixed(2)}</p></div>
          </div>
        </Card>
        <Card title="Clases del alumno (√∫ltimas)">
          <ul className="space-y-2 max-h-[50vh] overflow-auto pr-1">
            {clasesDelAlumno
              .slice()
              .sort((a,b)=> (a.fecha+a.hora).localeCompare(b.fecha+b.hora))
              .map(c => {
                const pagosClase = (pagos || []).filter(p => p.claseId === c.id && p.alumnoId === alumno.id);
                const pago = pagosClase[0];
                const status = pago ? (pago.metodo==="Pendiente" ? "Pendiente" : "Pagado") : "Pendiente";
                const cls = status==="Pagado" ? "bg-emerald-100 text-emerald-700" : "bg-amber-100 text-amber-700";
                const tam = (c.alumnoIds||[]).length || 1;
                return (
                  <li key={c.id} className="p-2 border rounded-lg flex items-center justify-between">
                    <div>
                      <p className="font-semibold">{c.fecha} {c.hora} ¬∑ {tam} persona(s)</p>
                      <p className="text-xs text-slate-500">{(c.alumnoIds||[]).map(id => (alumnos||[]).find(a=>a.id===id)).filter(Boolean).map(a => getNombreCompleto(a)).join(', ')}</p>
                    </div>
                    <div className="flex items-center">
                      <span className={"text-[11px] px-2 py-0.5 rounded-full " + cls}>{status}</span>
                      {status==="Pendiente" && onPagarPendiente && (
                        <button type="button"
                                onClick={() => onPagarPendiente(c.id, alumno.id)}
                                className="ml-2 text-xs px-2 py-0.5 rounded border bg-amber-50 text-amber-700 hover:bg-amber-100">
                          Registrar pago
                        </button>
                      )}
                    </div>
                  </li>
                );
              })}
          </ul>
    </Card>
      </div>
    </Modal>
  
        );
}
function CalendarioSemanal({ week, clases, onEdit, horarioLaboral, mostrarSoloHorarioLaboral }) {
  const getStatusColor = (status) => {
    switch (status) { case "Realizada": return "bg-green-200 border-green-400"; case "Cancelada": return "bg-red-200 border-red-400"; case "Ausente": return "bg-yellow-200 border-yellow-400"; default: return "bg-blue-200 border-blue-400"; }
  };
  const clasesPorDiaHora = useMemo(() => { const map = {}; clases.forEach(clase => { const key = `${clase.fecha}_${clase.hora}`; if (!map[key]) map[key] = []; map[key].push(clase); }); return map; }, [clases]);
  
  const esHoraLaboral = (fecha, hora) => {
    if (!horarioLaboral || horarioLaboral.length !== 7) return true;
    const diaIndex = new Date(fecha).getDay();
    const diaSemana = horarioLaboral[diaIndex === 0 ? 6 : diaIndex - 1];
    if (!diaSemana.activo) return false;
    return hora >= diaSemana.desde && hora < diaSemana.hasta;
  };

  // --- L√ìGICA NUEVA PARA FILTRAR LAS HORAS ---
  const horasParaMostrar = useMemo(() => {
    if (!mostrarSoloHorarioLaboral || !horarioLaboral) {
      return HORAS; // Vista completa: devuelve todas las horas
    }
    
    const horasActivas = horarioLaboral.filter(d => d.activo).flatMap(d => [d.desde, d.hasta]);
    if (horasActivas.length === 0) return HORAS; // Si no hay horario laboral definido, muestra todo

    const minHora = horasActivas.reduce((a, b) => a < b ? a : b);
    const maxHora = horasActivas.reduce((a, b) => a > b ? a : b);

    return HORAS.filter(h => h >= minHora && h < maxHora);
  }, [mostrarSoloHorarioLaboral, horarioLaboral]);
  // --- FIN DE LA L√ìGICA NUEVA ---

  return (
    <div className="grid grid-cols-[auto_repeat(7,1fr)] gap-px bg-slate-200 border border-slate-200">
      <div className="bg-white p-2"></div>
      {week.map(day => (<div key={day} className="bg-white p-2 text-center font-semibold text-sm"><div>{DIAS_SEMANA_NOMBRES[new Date(day).getDay() === 0 ? 6 : new Date(day).getDay() - 1]}</div><div className="text-xs text-slate-500">{formatDate(new Date(day), 'dd/mm')}</div></div>))}
      
      {/* AHORA MAPEAMOS SOBRE LAS HORAS FILTRADAS */}
      {horasParaMostrar.map(hora => (
        <React.Fragment key={hora}>
          <div className="bg-white text-center text-xs p-2">{hora}</div>
          {week.map(day => {
            const esLaboral = esHoraLaboral(day, hora);
            return (
              <div key={`${day}-${hora}`} className={`${esLaboral ? 'bg-slate-50' : 'bg-slate-200'} min-h-[60px] p-1`}>
                {(clasesPorDiaHora[`${day}_${hora}`] || []).map(clase => (
                  <div key={clase.id} onClick={() => onEdit(clase)} className={`text-xs p-1 rounded border cursor-pointer mb-1 ${getStatusColor(clase.estado)}`}>
                    {clase.nombresAlumnos}
                    <div className="text-[10px] opacity-70">{clase.cancha}</div>
                  </div>
                ))}
              </div>
            );
          })}
        </React.Fragment>
      ))}
    </div>
  );
}
    
    function Clases({ clases, alumnos, pagos, perfil, onCreate, onUpdate, onDelete, onPay, user, claseParaEditar, setClaseParaEditar , nuevoAlumnoId}) {
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const emptyForm = { alumnoIds: [""], fecha: formatDate(new Date()), hora: "18:00", tipo: "Individual", estado: "Programada", precio: perfil.precios.individual, notas: "", cancha: "", recurrente: false, mesesRecurrencia: 3 };
      const [form, setForm] = useState(emptyForm);
      const [formStep, setFormStep] = useState(1);
      const [alumnoSearchQuery, setAlumnoSearchQuery] = useState("");
      const [isAlumnosListOpen, setIsAlumnosListOpen] = useState(false);
      const [grupos, setGrupos] = useState([]);
      const [filtroAlumno, setFiltroAlumno] = useState(""); 
      const [filtroEstado, setFiltroEstado] = useState(""); 
      const [filtroFechaDesde, setFiltroFechaDesde] = useState("");
      const [filtroFechaHasta, setFiltroFechaHasta] = useState("");

      useEffect(() => {
        if (!user) return;
        const unsub = db.collection('users').doc(user.uid).collection('grupos').onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setGrupos(data);
        });
        return () => unsub();
      }, [user]);
      
      useEffect(() => {
        if (claseParaEditar) {
            openEdit(claseParaEditar);
            setClaseParaEditar(null);
        }
      }, [claseParaEditar]);
      useEffect(() => {
        if (nuevoAlumnoId) {
          setShowForm(true);
          setForm(prev => ({ ...prev, alumnoIds: [nuevoAlumnoId], estado: prev.estado || "realizada" }));
          setFormStep(1);
        }
      }, [nuevoAlumnoId]);


      const alumnosActivos = useMemo(() => alumnos.filter(a => a.estado === 'activo'), [alumnos]);
      const alumnoMap = useMemo(() => new Map(alumnos.map(a => [a.id, a])), [alumnos]);
      
      const alumnosFiltrados = useMemo(() => {
        if (!alumnoSearchQuery) {
            return alumnosActivos;
        }
        return alumnosActivos.filter(alumno =>
            getNombreCompleto(alumno).toLowerCase().includes(alumnoSearchQuery.toLowerCase())
        );
      }, [alumnoSearchQuery, alumnosActivos]);

      const pagosPorClase = useMemo(() => {
        const map = new Map();
        pagos.forEach(p => {
          if (!map.has(p.claseId)) map.set(p.claseId, []);
          map.get(p.claseId).push(p);
        });
        return map;
      }, [pagos]);

      const clasesConDatos = useMemo(() => clases.map(c => ({ 
        ...c, 
        nombresAlumnos: (c.alumnoIds || []).map(id => getNombreCompleto(alumnoMap.get(id))).filter(Boolean).join(', '), 
        pagos: pagosPorClase.get(c.id) || [] 
      })), [clases, alumnoMap, pagosPorClase]);

      const clasesFiltradas = useMemo(() => {
        return clasesConDatos.filter(c => {
            const pasaFiltroAlumno = !filtroAlumno || c.alumnoIds.includes(filtroAlumno);
            const pasaFiltroEstado = !filtroEstado || c.estado === filtroEstado;
            const pasaFiltroFechaDesde = !filtroFechaDesde || c.fecha >= filtroFechaDesde;
            const pasaFiltroFechaHasta = !filtroFechaHasta || c.fecha <= filtroFechaHasta;
            return pasaFiltroAlumno && pasaFiltroEstado && pasaFiltroFechaDesde && pasaFiltroFechaHasta;
        }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      }, [clasesConDatos, filtroAlumno, filtroEstado, filtroFechaDesde, filtroFechaHasta]);

      const canchasDisponibles = useMemo(() => (perfil.canchas || '').split('\n').filter(c => c.trim() !== ''), [perfil.canchas]);
      
      function handleFormChange(e) {
        const { name, value, type, checked } = e.target;
        const val = type === 'checkbox' ? checked : value;
        setForm(prev => {
            const newState = { ...prev, [name]: val };
            if (name === "tipo") {
                const primerAlumno = alumnoMap.get(prev.alumnoIds[0]);
                const esPlanMensual = primerAlumno?.plan === 'mensual';
                newState.precio = (perfil.precios[val.toLowerCase()] || "");
                const numAlumnos = TIPOS_CLASE_MAP[val] || 1;
                newState.alumnoIds = Array.from({ length: numAlumnos }, (_, i) => prev.alumnoIds[i] || "");
            }
            return newState;
        });
      }
      
      function handleAlumnoChange(index, newId) {
        setForm(prev => {
            const newAlumnoIds = prev.alumnoIds.map((id, i) => i === index ? newId : id);
            const primerAlumno = alumnoMap.get(newAlumnoIds[0]);
            const esPlanMensual = primerAlumno?.plan === 'mensual';
            const nuevoPrecio = esPlanMensual ? "0" : (perfil.precios[prev.tipo.toLowerCase()] || "");
            return { ...prev, alumnoIds: newAlumnoIds, precio: nuevoPrecio };
        });
        if (index === 0 && newId) { 
            const alumnoSeleccionado = alumnoMap.get(newId);
            if (alumnoSeleccionado && alumnoSeleccionado.horarios && alumnoSeleccionado.horarios.length > 0) {
                setFormStep(2);
            } else {
                setFormStep(3);
            }
        }
      }
      
      function handleSelectAlumno(alumno) {
        setAlumnoSearchQuery(getNombreCompleto(alumno));
        setIsAlumnosListOpen(false);
        handleAlumnoChange(0, alumno.id);
      }

      const getNextDateForDay = (dayName) => {
    const today = new Date();
    const todayDayIndex = today.getDay(); // El √≠ndice de JS donde Domingo=0, Lunes=1, etc.

    // Nuestro array tiene Lunes=0, Martes=1, etc. Necesitamos convertirlo al de JS.
    const targetDayIndex = (DIAS_SEMANA_NOMBRES.indexOf(dayName) + 1) % 7;

    // Calculamos la diferencia de d√≠as.
    let dayDifference = targetDayIndex - todayDayIndex;

    // Si la diferencia es negativa o cero, significa que el d√≠a ya pas√≥ esta semana
    // o es hoy, as√≠ que le sumamos 7 para que agende para la semana siguiente.
    if (dayDifference <= 0) {
        dayDifference += 7;
    }

    const resultDate = new Date(today.getTime());
    resultDate.setDate(today.getDate() + dayDifference);
    
    return resultDate;
};

      function handleScheduleSelect(horario) {
        const proximaFecha = getNextDateForDay(horario.dia);
        setForm(prev => ({
            ...prev,
            fecha: formatDate(proximaFecha),
            hora: horario.hora
        }));
        setFormStep(3);
      }

      function openNew() { 
        setEditing(null); 
        setForm(emptyForm);
        setAlumnoSearchQuery("");
        setFormStep(1); 
        setShowForm(true); 
        window.scrollTo({ top: 0, behavior: "smooth" }); 
      }
      function openEdit(c) { 
        setEditing(c); 
        setForm({ ...emptyForm, ...c, recurrente: false }); 
        setFormStep(3);
        setShowForm(true); 
        window.scrollTo({ top: 0, behavior: "smooth" }); 
      }
      function cancel() { 
        setShowForm(false); 
        setEditing(null); 
        setForm(emptyForm);
        setFormStep(1);
      }
      function submit(e) { 
        e.preventDefault(); 
        const validAlumnos = form.alumnoIds.filter(id => id); 
        if (validAlumnos.length === 0) return alert("Seleccion√° al menos un alumno"); 
        const finalForm = {...form, alumnoIds: validAlumnos}; 
        if (editing) { 
            onUpdate({ ...finalForm, id: editing.id }); 
        } else { 
            onCreate(finalForm); 
        } 
        cancel(); 
      }
      const changeWeek = (offset) => setCurrentDate(prev => addDays(prev, offset * 7));
      function handleStatusChange(clase, newStatus) {
        onUpdate({ ...clase, estado: newStatus, pagos: clase.pagos });
      }
      
      const primerAlumnoId = form.alumnoIds[0];
      const esMensual = alumnoMap.get(primerAlumnoId)?.plan === 'mensual';
      
      return (
        <div className="grid gap-4">
          <Card title={editing ? "Editar clase" : "Nueva clase"} right={!showForm && <button id="nueva-clase-btn" onClick={openNew} className="bg-slate-900 text-white text-sm px-3 py-1.5 rounded-xl">+ Nueva</button>}>
            {showForm ? (
                <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
                    {/* --- PASO 1: SELECCIONAR ALUMNO (VERSI√ìN CON BUSCADOR) --- */}
                    {(formStep === 1) && (
                        <div className="md:col-span-6 relative">
                            <label className="text-sm text-slate-600 font-semibold">Selecciona Alumno/a</label>
                            <input
                                type="text"
                                value={alumnoSearchQuery}
                                onChange={(e) => {
                                    setAlumnoSearchQuery(e.target.value);
                                    setIsAlumnosListOpen(true);
                                }}
                                onFocus={() => setIsAlumnosListOpen(true)}
                                onBlur={() => setTimeout(() => setIsAlumnosListOpen(false), 200)}
                                placeholder="Escribe para buscar..."
                                className="w-full mt-1 border rounded-lg px-3 py-2"
                            />
                            {isAlumnosListOpen && (
                                <ul className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg">
                                    {alumnosFiltrados.length > 0 ? (
                                        alumnosFiltrados.map(alumno => (
                                            <li key={alumno.id} onClick={() => handleSelectAlumno(alumno)} className="px-3 py-2 hover:bg-slate-100 cursor-pointer">
                                                {getNombreCompleto(alumno)}
                                            </li>
                                        ))
                                    ) : (
                                        <li className="px-3 py-2 text-slate-500">No se encontraron alumnos.</li>
                                    )}
                                </ul>
                            )}
                        </div>
                    )}

                    {/* --- PASO 2: ELEGIR HORARIO FIJO (si existe) --- */}
                    {(formStep === 2 && alumnoMap.get(form.alumnoIds[0])) && (
                        <div className="md:col-span-6">
                            <p className="text-sm text-slate-700 mb-2"><span className="font-bold">{getNombreCompleto(alumnoMap.get(form.alumnoIds[0]))}</span> tiene horarios fijos guardados.</p>
                            <p className="text-sm font-semibold text-slate-600">¬øQuieres agendar una clase en uno de sus horarios habituales?</p>
                            <div className="flex flex-wrap gap-2 my-3">
                                {(alumnoMap.get(form.alumnoIds[0]).horarios || []).map(horario => (
                                    <button type="button" key={`${horario.dia}-${horario.hora}`} onClick={() => handleScheduleSelect(horario)} className="px-3 py-2 text-sm rounded-lg border bg-sky-50 text-sky-800 hover:bg-sky-100">
                                        {horario.dia} {horario.hora}
                                    </button>
                                ))}
                            </div>
                            <div className="border-t pt-3 mt-3">
                                <button type="button" onClick={() => setFormStep(3)} className="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-slate-100">O agendar una clase personalizada en otro horario</button>
                            </div>
                        </div>
                    )}

                    {/* --- PASO 3: DETALLES COMPLETOS DE LA CLASE --- */}
                    {(formStep === 3) && (
                        <>
                            <div className="md:col-span-6 grid grid-cols-1 md:grid-cols-2 gap-3">
                                {(form.alumnoIds || [""]).map((alumnoId, index) => (
                                    <div key={index}>
                                        <label className="text-sm text-slate-600">Alumno {index + 1}</label>
                                        <select value={alumnoId} onChange={(e) => handleAlumnoChange(index, e.target.value)} className="w-full border rounded-lg px-3 py-2" required>
                                            <option value="">Seleccionar...</option>
                                            {alumnosActivos.filter(a => !form.alumnoIds.includes(a.id) || a.id === alumnoId).map(a => <option key={a.id} value={a.id}>{getNombreCompleto(a)}</option>)}
                                        </select>
                                    </div>
                                ))}
                            </div>
                            <div className="md:col-span-2"><label className="text-sm text-slate-600">Ubicaci√≥n / Cancha</label><select name="cancha" value={form.cancha} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">{canchasDisponibles.map(c => <option key={c}>{c}</option>)}</select></div>
                            <div><label className="text-sm text-slate-600">Fecha</label><input type="date" name="fecha" value={form.fecha} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                            <div><label className="text-sm text-slate-600">Hora</label><input type="time" name="hora" value={form.hora} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                            <div><label className="text-sm text-slate-600">Tipo de Clase</label><select name="tipo" value={form.tipo} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">{TIPOS_CLASE.map(t => <option key={t}>{t}</option>)}</select></div>
                            <div><label className="text-sm text-slate-600">Precio</label><input type="number" name="precio" value={esMensual ? "0" : form.precio} onChange={handleFormChange} className={`w-full border rounded-lg px-3 py-2 ${esMensual ? 'bg-slate-100' : ''}`} placeholder="0" disabled={esMensual} /></div>
                            <div className="md:col-span-2"><label className="text-sm text-slate-600">Estado</label><select name="estado" value={form.estado} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">{ESTADOS_CLASE.map(e => <option key={e}>{e}</option>)}</select></div>
                            <div className="md:col-span-6"><label className="text-sm text-slate-600">Notas</label><textarea name="notas" value={form.notas} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" rows={2} placeholder="Comentarios sobre la clase" /></div>
                            {!editing && <div className="md:col-span-6 flex items-center gap-2"><input type="checkbox" name="recurrente" id="recurrente" checked={form.recurrente} onChange={handleFormChange} /><label htmlFor="recurrente" className="text-sm text-slate-600 mr-2">Repetir semanalmente por</label>{form.recurrente && <select name="mesesRecurrencia" value={form.mesesRecurrencia} onChange={handleFormChange} className="border rounded-lg px-3 py-2">{MESES_RECURRENCIA.map(m => <option key={m} value={m}>{m} mes{m > 1 ? 'es' : ''}</option>)}</select>}</div>}
                        </>
                    )}

                    <div className="md:col-span-6 flex gap-2 justify-end">
                        <button type="button" onClick={() => { cancel(); setFormStep(1); }} className="px-3 py-2 rounded-lg border">Cancelar</button>
                        {formStep === 3 && <button className="px-3 py-2 rounded-lg bg-emerald-600 text-white">Guardar</button>}
                    </div>
                </form>
            ) : ( <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nueva</b> para programar una clase.</p> )}
          </Card>
          
          <Card title="Listado de clases">
            <div className="grid md:grid-cols-4 gap-3 mb-4 p-2 border rounded-lg">
                <select value={filtroAlumno} onChange={(e) => setFiltroAlumno(e.target.value)}>
                <option value="">Todos los Alumnos</option>
                {alumnos.map(a => <option key={a.id} value={a.id}>{getNombreCompleto(a)}</option>)}
                </select>
                <select value={filtroEstado} onChange={(e) => setFiltroEstado(e.target.value)}>
                <option value="">Todos los Estados</option>
                {ESTADOS_CLASE.map(e => <option key={e} value={e}>{e}</option>)}
                </select>
                <input type="date" value={filtroFechaDesde} onChange={(e) => setFiltroFechaDesde(e.target.value)} />
                <input type="date" value={filtroFechaHasta} onChange={(e) => setFiltroFechaHasta(e.target.value)} />
            </div>
            <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                <thead>
                    <tr className="text-left text-slate-600">
                    <th className="p-2">Fecha</th>
                    <th className="p-2">Alumnos</th>
                    <th className="p-2">Ubicaci√≥n</th>
                    <th className="p-2">Estado</th>
                    <th className="p-2">Precio</th>
                    <th className="p-2 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {clasesFiltradas.length === 0 && (
                    <tr>
                        <td colSpan={6} className="text-center py-6 text-slate-400">
                        No hay clases que coincidan con los filtros
                        </td>
                    </tr>
                    )}
                    {clasesFiltradas.map((c) => (
                    <tr key={c.id} className="border-t">
                        <td className="p-2">{c.fecha} {c.hora}</td>
                        <td className="p-2">{c.nombresAlumnos}<div className="flex flex-wrap gap-1 mt-1">{(c.alumnoIds || []).map(id => { const pago = (pagos || []).find(p => p.claseId === c.id && p.alumnoId === id); const status = pago ? (pago.metodo === "Pendiente" ? "Pendiente" : "Pagado") : "Pendiente"; const cls = status==="Pagado" ? "bg-emerald-100 text-emerald-700" : "bg-amber-100 text-amber-700"; const alumno = (alumnos||[]).find(a=>a.id===id); const nombre = alumno ? getNombreCompleto(alumno).split(" ")[0] : "Alumno"; return <span key={id} className={`text-[11px] px-2 py-0.5 rounded-full ${cls}`}>{nombre}: {status}</span>; })}</div></td>
                        <td className="p-2">{c.cancha}</td>
                        <td className="p-2">
                        <select value={c.estado} onChange={(e) => handleStatusChange(c, e.target.value)} className="w-full border rounded-lg px-2 py-1 bg-white">
                            {ESTADOS_CLASE.map(e => <option key={e}>{e}</option>)}
                        </select>
                        </td>
                        <td className="p-2 flex items-center gap-2">
                        {c.precio ? `$${c.precio}` : '-'}
                        {c.pagos.length > 0 && <span className={`w-2 h-2 rounded-full ${c.pagos.some(p => p.metodo === 'Pendiente') ? 'bg-orange-400' : 'bg-green-500'}`} title={`Pago Registrado`}></span>}
                        </td>
                        <td className="p-2 text-right">
                        <div className="inline-flex gap-2">
                            {c.estado === 'Realizada' && c.pagos.length === 0 && <button onClick={() => onPay(c)} className="px-2 py-1 text-xs rounded-lg border bg-emerald-50 text-emerald-700 hover:bg-emerald-100">üí≥ Pagar</button>}
                            <button onClick={() => openEdit(c)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button>
                            <button type="button" onClick={() => onDelete(c.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button>
                        </div>
                        </td>
                    </tr>
                    ))}
                </tbody>
                </table>
            </div>
          </Card>
        </div>
      );
    }
    function Grupos({ alumnos, user }) {
    console.log("Componente Grupos se est√° renderizando...");
  // --- Estados del Componente ---
  // 1. Para guardar la lista de grupos que viene de Firebase.
  const [grupos, setGrupos] = useState([]);
  // 2. Para manejar el formulario de un nuevo grupo.
  const [nombreGrupo, setNombreGrupo] = useState("");
  const [alumnosSeleccionados, setAlumnosSeleccionados] = useState([]);
  // 3. Para mostrar un mensaje de carga.
  const [loading, setLoading] = useState(true);
  
  // --- Conexi√≥n a Firebase ---
  // Objeto para interactuar con la colecci√≥n 'grupos'
  const gruposCollection = useMemo(() => {
    if (!user) return null;
    return db.collection('users').doc(user.uid).collection('grupos');
  }, [user]);

  // Carga inicial de los grupos y se mantiene escuchando cambios
  useEffect(() => {
    if (!gruposCollection) return;
    
    const unsubscribe = gruposCollection.onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setGrupos(data);
      setLoading(false);
    });

    return () => unsubscribe(); // Limpia el listener al desmontar el componente
  }, [gruposCollection]);

  // --- L√≥gica para Manejar el Formulario ---
  const handleCrearGrupo = () => {
    if (!nombreGrupo.trim() || alumnosSeleccionados.length === 0) {
      alert("Por favor, ingresa un nombre para el grupo y selecciona al menos un alumno.");
      return;
    }

    const nuevoGrupo = {
      nombre: nombreGrupo,
      alumnoIds: alumnosSeleccionados
    };

    gruposCollection.add(nuevoGrupo)
      .then(() => {
        // Limpia el formulario despu√©s de crear
        setNombreGrupo("");
        setAlumnosSeleccionados([]);
        alert("¬°Grupo creado con √©xito!");
      })
      .catch(error => {
        console.error("Error al crear el grupo: ", error);
        alert("Hubo un error al crear el grupo.");
      });
  };
  
  const handleEliminarGrupo = (id) => {
      if(window.confirm("¬øEst√°s seguro de que quieres eliminar este grupo?")){
          gruposCollection.doc(id).delete().catch(error => {
              console.error("Error al eliminar el grupo: ", error);
              alert("Hubo un error al eliminar el grupo.");
          });
      }
  }

  // --- Interfaz Gr√°fica (lo que se ve en pantalla) ---
  return (
    <div className="grid md:grid-cols-2 gap-6">
      {/* Columna Izquierda: Formulario para crear grupos */}
      <div className="flex flex-col gap-6">
        <Card title="Nuevo Grupo">
          <div className="grid gap-4">
            <div>
                <label className="text-sm text-slate-600">Nombre del Grupo</label>
                <input
                  type="text"
                  value={nombreGrupo}
                  onChange={(e) => setNombreGrupo(e.target.value)}
                  placeholder="Ej: Escuelita Martes y Jueves"
                  className="w-full mt-1 border rounded-lg px-3 py-2"
                />
            </div>
            <div>
                <label className="text-sm text-slate-600">Selecciona los Alumnos</label>
                <p className="text-xs text-slate-500 mb-1">Mant√©n presionada la tecla Ctrl (o Cmd en Mac) para seleccionar varios.</p>
                <select
                  multiple
                  value={alumnosSeleccionados}
                  onChange={(e) => {
                    const opciones = Array.from(e.target.selectedOptions, option => option.value);
                    setAlumnosSeleccionados(opciones);
                  }}
                  className="w-full border rounded-lg p-2 h-48"
                >
                  {alumnos.map(a => (
                    <option key={a.id} value={a.id}>{`${a.apellido || ''} ${a.nombre || ''}`.trim()}</option>
                  ))}
                </select>
            </div>
            <button onClick={handleCrearGrupo} className="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold">
              Guardar Grupo
            </button>
          </div>
        </Card>
      </div>

      {/* Columna Derecha: Lista de grupos existentes */}
      <div>
        <Card title="Grupos Existentes">
            {loading && <p>Cargando grupos...</p>}
            {!loading && grupos.length === 0 && <p className="text-sm text-slate-500">A√∫n no has creado ning√∫n grupo.</p>}
            <ul className="space-y-3">
                {grupos.map(grupo => {
                    const nombresAlumnos = grupo.alumnoIds.map(id => {
                        const alumno = alumnos.find(a => a.id === id);
                        return alumno ? `${alumno.nombre || ''} ${alumno.apellido || ''}`.trim() : 'Alumno no encontrado';
                    }).join(', ');

                    return (
                        <li key={grupo.id} className="p-3 border rounded-lg bg-slate-50">
                            <div className="flex justify-between items-center">
                                <h4 className="font-bold text-slate-800">{grupo.nombre}</h4>
                                <button onClick={() => handleEliminarGrupo(grupo.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                            <p className="text-xs text-slate-600 mt-1">
                                **Integrantes:** {nombresAlumnos}
                            </p>
                        </li>
                    );
                })}
            </ul>
        </Card>
      </div>
    </div>
  );
}
    
    function Pagos({ pagos, alumnos, perfil, onPayMensual, clases }) {
        const [vista, setVista] = useState(perfil.metodoCobro === 'mensual' ? 'mensual' : 'historial');
        useEffect(() => {
            setVista(perfil.metodoCobro === 'mensual' ? 'mensual' : 'historial');
        }, [perfil.metodoCobro]);
        return (
            <div className="grid gap-4">
                <div className="flex items-center gap-2 bg-slate-100 p-1 rounded-xl">
                    <button onClick={() => setVista('historial')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'historial' ? 'bg-white shadow' : ''}`}>Historial de Pagos</button>
                    <button onClick={() => setVista('mensual')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'mensual' ? 'bg-white shadow' : ''}`}>Control Clases Mensuales</button>
                    <button onClick={() => setVista('deudas')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'deudas' ? 'bg-white shadow' : ''}`}>Control de Deudas</button>
                </div>
                {vista === 'historial' && <HistorialPagos pagos={pagos} alumnos={alumnos} clases={clases} />}
                {vista === 'mensual' && <ControlMensual pagos={pagos} alumnos={alumnos} perfil={perfil} onPay={onPayMensual} />}
                {vista === 'deudas' && <ControlDeudas pagos={pagos} alumnos={alumnos} clases={clases} perfil={perfil} />}
            </div>
        );
    }

    function HistorialPagos({ pagos, alumnos, clases }) {
      const [periodo, setPeriodo] = useState("mes");
      const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
      const [metodo, setMetodo] = useState("Todos");
      const alumnoMap = useMemo(() => new Map(alumnos.map(a => [a.id, `${a.apellido || ''} ${a.nombre || ''}`.trim()])), [alumnos]);
      const claseMap = useMemo(() => new Map(clases.map(c => [c.id, c])), [clases]);

      const pagosConDatos = useMemo(() => {
          const pagosAgrupados = {};
          pagos.forEach(p => {
              if (p.claseId) {
                  if (!pagosAgrupados[p.claseId]) pagosAgrupados[p.claseId] = [];
                  pagosAgrupados[p.claseId].push(p);
              }
          });
          
          const pagosMostrados = [];
          const clasesProcesadas = new Set();

          pagos.forEach(p => {
              if (p.claseId && !clasesProcesadas.has(p.claseId)) {
                  const pagosDeClase = pagosAgrupados[p.claseId];
                  const metodos = new Set(pagosDeClase.map(pg => pg.metodo));
                  const montoTotal = pagosDeClase.reduce((sum, pg) => sum + parseFloat(pg.monto || 0), 0);
                  const metodoFinal = metodos.size > 1 ? 'Mixto' : (metodos.values().next().value || 'N/A');
                  const clase = claseMap.get(p.claseId);
                  
                  pagosMostrados.push({ ...p, id: p.claseId, monto: montoTotal, metodo: metodoFinal, concepto: clase ? `Clase ${clase.tipo}` : (alumnoMap.get(p.alumnoId) || '??') });
                  clasesProcesadas.add(p.claseId);
              } else if (!p.claseId) {
                  pagosMostrados.push({ ...p, nombreAlumno: alumnoMap.get(p.alumnoId) || '??' });
              }
          });
          return pagosMostrados;

      }, [pagos, alumnoMap, claseMap]);
      
      const pagosFiltrados = useMemo(() => {
        const ahora = new Date();
        const hoy = formatDate(ahora);
        const semanaInicio = formatDate(getWeekStartDate(ahora));
        const anioActual = ahora.getFullYear();

        return pagosConDatos.filter(p => {
            if (periodo === 'dia' && p.fecha !== hoy) return false;
            if (periodo === 'semana' && p.fecha < semanaInicio) return false;
            if (periodo === 'a√±o' && new Date(p.fecha).getFullYear() !== anioActual) return false;
            if (periodo === 'mes' && (new Date(p.fecha).getMonth() !== selectedMonth || new Date(p.fecha).getFullYear() !== anioActual)) return false;
            if (metodo !== 'Todos' && p.metodo !== metodo) return false;
            return true;
          }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      }, [pagosConDatos, periodo, selectedMonth, metodo]);
      
      const totales = useMemo(() => {
        return pagos.filter(p => pagosFiltrados.some(pf => pf.id === (p.claseId || p.id))).reduce((acc, p) => {
          if (p.metodo !== 'Pendiente') {
            const monto = parseFloat(p.monto || 0) || 0;
            acc.total += monto;
            if (p.metodo === 'Efectivo') acc.efectivo += monto;
            if (p.metodo === 'Transferencia') acc.transferencia += monto;
          }
          return acc;
        }, { total: 0, efectivo: 0, transferencia: 0 });
      }, [pagosFiltrados, pagos]);

      const PeriodoButton = ({ value, current, setter, children }) => (<button onClick={() => setter(value)} className={`px-3 py-1.5 text-sm rounded-lg ${current === value ? 'bg-slate-900 text-white' : 'bg-white border'}`}>{children}</button>);
      return (
        <Card title="Control de Pagos">
            <div className="grid gap-4 mb-4">
              <div className="flex flex-wrap items-center gap-2"><PeriodoButton value="dia" current={periodo} setter={setPeriodo}>Hoy</PeriodoButton><PeriodoButton value="semana" current={periodo} setter={setPeriodo}>Semana</PeriodoButton><PeriodoButton value="a√±o" current={periodo} setter={setPeriodo}>A√±o</PeriodoButton></div>
              <div className="flex flex-wrap items-center gap-2">{MESES_NOMBRES.map((mes, index) => (<button key={mes} onClick={() => { setPeriodo('mes'); setSelectedMonth(index); }} className={`px-3 py-1.5 text-sm rounded-lg ${periodo === 'mes' && selectedMonth === index ? 'bg-slate-900 text-white' : 'bg-white border'}`}>{mes}</button>))}</div>
              <div className="flex flex-wrap items-center gap-2"><PeriodoButton value="Todos" current={metodo} setter={setMetodo}>Todos</PeriodoButton><PeriodoButton value="Efectivo" current={metodo} setter={setMetodo}>Efectivo</PeriodoButton><PeriodoButton value="Transferencia" current={metodo} setter={setMetodo}>Transferencia</PeriodoButton><PeriodoButton value="Pendiente" current={metodo} setter={setMetodo}>Pendiente</PeriodoButton><PeriodoButton value="Mixto" current={metodo} setter={setMetodo}>Mixto</PeriodoButton></div>
            </div>
            <div className="grid md:grid-cols-3 gap-4 mb-4">
              <div className="bg-emerald-50 p-4 rounded-xl"><p className="text-sm text-emerald-800">Total Ingresado</p><p className="text-2xl font-bold text-emerald-900">${totales.total.toFixed(2)}</p></div>
              <div className="bg-sky-50 p-4 rounded-xl"><p className="text-sm text-sky-800">Total en Efectivo</p><p className="text-2xl font-bold text-sky-900">${totales.efectivo.toFixed(2)}</p></div>
              <div className="bg-indigo-50 p-4 rounded-xl"><p className="text-sm text-indigo-800">Total por Transferencia</p><p className="text-2xl font-bold text-indigo-900">${totales.transferencia.toFixed(2)}</p></div>
            </div>
            <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Fecha</th><th className="p-2">Concepto</th><th className="p-2">Monto</th><th className="p-2">M√©todo</th></tr></thead><tbody>{pagosFiltrados.length === 0 && (<tr><td colSpan={4} className="text-center py-6 text-slate-400">No hay pagos que coincidan con los filtros</td></tr>)}{pagosFiltrados.map(p => (<tr key={p.id} className="border-t"><td className="p-2">{p.fecha}</td><td className="p-2">{p.concepto || p.nombreAlumno}</td><td className="p-2">${parseFloat(p.monto || 0).toFixed(2)}</td><td className="p-2"><span className={`px-2 py-0.5 rounded-full text-xs ${p.metodo === 'Pendiente' ? 'bg-orange-100 text-orange-800' : p.metodo === 'Mixto' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>{p.metodo}</span></td></tr>))}</tbody></table></div>
        </Card>
      );
    }
    
    function ControlMensual({ pagos, alumnos, perfil, onPay }) {
        const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
        const alumnosMensuales = useMemo(() => alumnos.filter(a => a.plan === 'mensual' && a.estado === 'activo'), [alumnos]);
        const statusMensual = useMemo(() => {
            const anioActual = new Date().getFullYear();
            const pagosDelMes = pagos.filter(p => {
                const fechaPago = new Date(p.fecha);
                return p.concepto?.startsWith("Cuota Mensual") && fechaPago.getMonth() === selectedMonth && fechaPago.getFullYear() === anioActual;
            });

            return alumnosMensuales.map(alumno => {
                const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
                const pagosAlumno = pagosDelMes.filter(p => p.alumnoId === alumno.id);
                const totalPagado = pagosAlumno.reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
                
                let estado = 'Pendiente';
                if (totalPagado >= cuota) {
                    estado = 'Pagado';
                } else if (totalPagado > 0) {
                    estado = 'Parcial';
                }

                return { ...alumno, cuota, totalPagado, estado };
            });
        }, [alumnosMensuales, pagos, selectedMonth, perfil.preciosMensuales]);

        const getStatusColor = (status) => {
            if (status === 'Pagado') return 'bg-green-100 text-green-800';
            if (status === 'Parcial') return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        };
        return (
            <Card title="Control de Cuotas Mensuales">
                <div className="flex flex-wrap items-center gap-2 mb-4">
                    {MESES_NOMBRES.map((mes, index) => (
                        <button key={mes} onClick={() => setSelectedMonth(index)} className={`px-3 py-1.5 text-sm rounded-lg ${selectedMonth === index ? 'bg-slate-900 text-white' : 'bg-white border'}`}>{mes}</button>
                    ))}
                </div>
                <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Alumno</th><th className="p-2">Plan</th><th className="p-2">Monto Cuota</th><th className="p-2">Monto Pagado</th><th className="p-2">Estado</th><th className="p-2 text-right">Acciones</th></tr></thead><tbody>
                    {statusMensual.length === 0 && (<tr><td colSpan={6} className="text-center py-6 text-slate-400">No hay alumnos con plan mensual</td></tr>)}
                    {statusMensual.map(a => (
                        <tr key={a.id} className="border-t">
                            <td className="p-2">{`${a.apellido || ''} ${a.nombre || ''}`.trim()}</td>
                            <td className="p-2">{FRECUENCIAS_MENSUALES.find(f => f.value === a.frecuencia)?.label}</td>
                            <td className="p-2">${a.cuota.toFixed(2)}</td>
                            <td className="p-2">${a.totalPagado.toFixed(2)}</td>
                            <td className="p-2"><span className={`px-2 py-0.5 rounded-full text-xs ${getStatusColor(a.estado)}`}>{a.estado}</span></td>
                            <td className="p-2 text-right">
                                {a.estado !== 'Pagado' && <button onClick={() => onPay(a, selectedMonth)} className="px-2 py-1 text-xs rounded-lg border bg-emerald-500 text-white">Registrar Pago</button>}
                            </td>
                        </tr>
                    ))}
                </tbody></table></div>
            </Card>
        );
    }
    
    function ControlDeudas({ pagos, alumnos, clases, perfil }) {
        const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : '??';
        
        const deudas = useMemo(() => {
            const deudores = [];
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const anioActual = hoy.getFullYear();

            const alumnosMensuales = alumnos.filter(a => a.plan === 'mensual' && a.estado === 'activo');
            const pagosMensuales = pagos.filter(p => p.concepto?.startsWith("Cuota Mensual"));

            alumnosMensuales.forEach(alumno => {
                const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
                const pagosDelMes = pagosMensuales.filter(p => {
                    const fechaPago = new Date(p.fecha);
                    return p.alumnoId === alumno.id && fechaPago.getMonth() === mesActual && fechaPago.getFullYear() === anioActual;
                });
                const totalPagado = pagosDelMes.reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
                const deuda = cuota - totalPagado;
                if (deuda > 0) {
                    deudores.push({ id: alumno.id, nombre: getNombreCompleto(alumno), tipo: 'Cuota Mensual', monto: deuda });
                }
            });

            const pagosPorClaseMap = new Map();
            pagos.filter(p => p.claseId).forEach(p => {
                if(!pagosPorClaseMap.has(p.claseId)) pagosPorClaseMap.set(p.claseId, 0);
                pagosPorClaseMap.set(p.claseId, pagosPorClaseMap.get(p.claseId) + parseFloat(p.monto || 0));
            });
            const clasesRealizadas = clases.filter(c => c.estado === 'Realizada' && new Date(c.fecha) <= hoy);
            
            clasesRealizadas.forEach(clase => {
                const totalPagado = pagosPorClaseMap.get(clase.id) || 0;
                const precioClase = parseFloat(clase.precio || 0);

                if (totalPagado < precioClase) {
                    clase.alumnoIds.forEach(alumnoId => {
                        const alumno = alumnos.find(a => a.id === alumnoId);
                        if (alumno && alumno.plan === 'porClase') {
                            const monto = (precioClase - totalPagado) / clase.alumnoIds.length;
                            deudores.push({ id: `${clase.id}-${alumno.id}`, nombre: getNombreCompleto(alumno), tipo: `Clase ${clase.fecha}`, monto });
                        }
                    });
                }
            });
            
            const deudasAgrupadas = deudores.reduce((acc, deuda) => {
                if(!acc[deuda.nombre]) acc[deuda.nombre] = { total: 0, detalles: [] };
                acc[deuda.nombre].total += deuda.monto;
                acc[deuda.nombre].detalles.push({ tipo: deuda.tipo, monto: deuda.monto });
                return acc;
            }, {});
            
            return Object.entries(deudasAgrupadas).map(([nombre, data]) => ({ nombre, ...data }));

        }, [pagos, alumnos, clases, perfil]);
        
        return (
            <Card title="Control de Deudas Pendientes">
                 <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Alumno</th><th className="p-2">Detalle de Deuda</th><th className="p-2">Total Adeudado</th></tr></thead><tbody>
                    {deudas.length === 0 && (<tr><td colSpan={3} className="text-center py-6 text-slate-400">No hay deudas pendientes</td></tr>)}
                    {deudas.map(deuda => (
                        <tr key={deuda.nombre} className="border-t">
                            <td className="p-2 font-semibold">{deuda.nombre}</td>
                            <td className="p-2">
                                {deuda.detalles.map((d, i) => (
                                    <div key={i}>{d.tipo}: ${d.monto.toFixed(2)}</div>
                                ))}
                            </td>
                            <td className="p-2 font-semibold text-red-600">${deuda.total.toFixed(2)}</td>
                        </tr>
                    ))}
                </tbody></table></div>
            </Card>
        );
    }

    function Gastos({ gastos, onCreate, onUpdate, onDelete }) {
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const emptyForm = { fecha: formatDate(new Date()), concepto: "", monto: "", categoria: "Varios" };
      const [form, setForm] = useState(emptyForm);
      const [periodo, setPeriodo] = useState("mes");
      const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };

      const gastosFiltrados = useMemo(() => {
        const ahora = new Date();
        const hoy = formatDate(ahora);
        const semanaInicio = formatDate(getWeekStartDate(ahora));
        const mesInicio = formatDate(new Date(ahora.getFullYear(), ahora.getMonth(), 1));
        const anioInicio = formatDate(new Date(ahora.getFullYear(), 0, 1));

        return gastos
          .filter(g => {
            if (periodo === 'dia' && g.fecha !== hoy) return false;
            if (periodo === 'semana' && g.fecha < semanaInicio) return false;
            if (periodo === 'mes' && g.fecha < mesInicio) return false;
            if (periodo === 'a√±o' && g.fecha < anioInicio) return false;
            return true;
          })
          .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      }, [gastos, periodo]);
      
      const totalGastos = useMemo(() => gastosFiltrados.reduce((acc, g) => acc + (parseFloat(g.monto || 0) || 0), 0), [gastosFiltrados]);

      function openNew() { setEditing(null); setForm(emptyForm); setShowForm(true); }
      function openEdit(g) { setEditing(g); setForm(g); setShowForm(true); }
      function cancel() { setShowForm(false); setEditing(null); setForm(emptyForm); }
      function submit(e) { e.preventDefault(); if (!form.concepto.trim() || !form.monto) return alert("Complet√° concepto y monto"); if (editing) { onUpdate({ ...form, id: editing.id }); } else { onCreate(form); } cancel(); }

      const PeriodoButton = ({ value, current, setter, children }) => (<button onClick={() => setter(value)} className={`px-3 py-1.5 text-sm rounded-lg ${current === value ? 'bg-slate-900 text-white' : 'bg-white border'}`}>{children}</button>);
      return (
        <div className="grid gap-4">
          <Card title={editing ? "Editar gasto" : "Nuevo gasto"} right={!showForm && <button onClick={openNew} className="bg-slate-900 text-white text-sm px-3 py-1.5 rounded-xl">+ Nuevo</button>}>
            {showForm ? (
              <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
                <div className="md:col-span-2"><label className="text-sm text-slate-600">Fecha</label><input type="date" name="fecha" value={form.fecha} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                <div className="md:col-span-4"><label className="text-sm text-slate-600">Concepto</label><input name="concepto" value={form.concepto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: Compra de pelotas" required /></div>
                <div><label className="text-sm text-slate-600">Monto</label><input type="number" name="monto" value={form.monto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: 10000" required /></div>
                <div><label className="text-sm text-slate-600">Categor√≠a</label><select name="categoria" value={form.categoria} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{CATEGORIAS_GASTO.map(c => <option key={c}>{c}</option>)}</select></div>
                <div className="md:col-span-6 flex gap-2 justify-end"><button type="button" onClick={cancel} className="px-3 py-2 rounded-lg border">Cancelar</button><button className="px-3 py-2 rounded-lg bg-emerald-600 text-white">Guardar</button></div>
              </form>
            ) : (<p className="text-sm text-slate-500">Hac√© clic en <b>+ Nuevo</b> para registrar un gasto.</p>)}
          </Card>
          
          <Card title="Control de Gastos">
            <div className="flex flex-wrap items-center gap-2 mb-4">
              <PeriodoButton value="dia" current={periodo} setter={setPeriodo}>Hoy</PeriodoButton>
              <PeriodoButton value="semana" current={periodo} setter={setPeriodo}>Semana</PeriodoButton>
              <PeriodoButton value="mes" current={periodo} setter={setPeriodo}>Mes</PeriodoButton>
              <PeriodoButton value="a√±o" current={periodo} setter={setPeriodo}>A√±o</PeriodoButton>
            </div>
            <div className="bg-red-50 p-4 rounded-xl mb-4"><p className="text-sm text-red-800">Total de Gastos</p><p className="text-2xl font-bold text-red-900">${totalGastos.toFixed(2)}</p></div>
            <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Fecha</th><th className="p-2">Concepto</th><th className="p-2">Monto</th><th className="p-2">Categor√≠a</th><th className="p-2 text-right">Acciones</th></tr></thead><tbody>{gastosFiltrados.length === 0 && (<tr><td colSpan={5} className="text-center py-6 text-slate-400">No hay gastos en este per√≠odo</td></tr>)}{gastosFiltrados.map(g => (<tr key={g.id} className="border-t"><td className="p-2">{g.fecha}</td><td className="p-2">{g.concepto}</td><td className="p-2">${g.monto}</td><td className="p-2">{g.categoria}</td><td className="p-2 text-right"><div className="inline-flex gap-2"><button onClick={() => openEdit(g)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button><button type="button" onClick={() => onDelete(g.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button></div></td></tr>))}</tbody></table></div>
          </Card>
        </div>
      );
    }
    
    function GraficoBarras({ data }) {
      const maxValue = useMemo(() => Math.max(...data.map(d => d.value), 1), [data]);
      return (
        <div className="bg-slate-50 rounded-xl p-4 h-64 flex justify-around items-end gap-4">
          {data.map(item => (
            <div key={item.label} className="flex-1 flex flex-col items-center gap-2">
              <div className="text-sm font-semibold text-slate-700">${item.value.toFixed(2)}</div>
              <div className={`w-full rounded-t-lg ${item.color}`} style={{ height: `${(item.value / maxValue) * 80}%` }} title={`${item.label}: $${item.value.toFixed(2)}`}></div>
              <div className="text-xs font-medium text-slate-600">{item.label}</div>
            </div>
          ))}
        </div>
      );
    }
    
    function Reportes({ pagos, gastos, alumnos, clases }) {
      const [periodo, setPeriodo] = useState("mes");
      const alumnoMap = useMemo(() => new Map(alumnos.map(a => [a.id, `${a.apellido || ''} ${a.nombre || ''}`.trim()])), [alumnos]);
      
      const [pagosFiltrados, gastosFiltrados] = useMemo(() => {
        const ahora = new Date();
        const hoy = formatDate(ahora);
        const semanaInicio = formatDate(getWeekStartDate(ahora));
        const mesInicio = formatDate(new Date(ahora.getFullYear(), ahora.getMonth(), 1));
        const anioInicio = formatDate(new Date(ahora.getFullYear(), 0, 1));
        const filterByPeriod = (item) => {
          if (periodo === 'dia' && item.fecha !== hoy) return false;
          if (periodo === 'semana' && item.fecha < semanaInicio) return false;
          if (periodo === 'mes' && item.fecha < mesInicio) return false;
          if (periodo === 'a√±o' && item.fecha < anioInicio) return false;
          return true;
        };
        return [pagos.filter(filterByPeriod), gastos.filter(filterByPeriod)];
      }, [pagos, gastos, periodo]);
      
      const totales = useMemo(() => {
        const totalIngresos = pagosFiltrados.filter(p => p.metodo !== 'Pendiente').reduce((acc, p) => acc + (parseFloat(p.monto) || 0), 0);
        const totalGastos = gastosFiltrados.reduce((acc, g) => acc + (parseFloat(g.monto) || 0), 0);
        return { ingresos: totalIngresos, gastos: totalGastos, balance: totalIngresos - totalGastos };
      }, [pagosFiltrados, gastosFiltrados]);
      
      const dataGrafico = [
        { label: 'Ingresos', value: totales.ingresos, color: 'bg-emerald-400' },
        { label: 'Gastos', value: totales.gastos, color: 'bg-red-400' },
      ];
      
      const handleExport = () => {
        if (!window.jspdf || !window.jspdf.jsPDF) return alert("Error: La librer√≠a jsPDF no est√° cargada.");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`Reporte Financiero - Per√≠odo: ${periodo.charAt(0).toUpperCase() + periodo.slice(1)}`, 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Generado el: ${new Date().toLocaleDateString()}`, 14, 29);
        doc.setFontSize(12);
        doc.text("Resumen del Per√≠odo", 14, 45);
        doc.text(`Total Ingresos: $${totales.ingresos.toFixed(2)}\nTotal Gastos: $${totales.gastos.toFixed(2)}\nBalance Neto: $${totales.balance.toFixed(2)}`, 14, 52);
        
        const tableColumn = ["Fecha", "Tipo", "Concepto", "Monto", "Metodo/Categoria"];
        const tableRows = [];
        pagosFiltrados.forEach(pago => tableRows.push([pago.fecha, "Ingreso", pago.concepto || `Clase ${alumnoMap.get(pago.alumnoId) || "N/A"}`, `$${parseFloat(pago.monto).toFixed(2)}`, pago.metodo]));
        gastosFiltrados.forEach(gasto => tableRows.push([gasto.fecha, "Gasto", gasto.concepto, `$${parseFloat(gasto.monto).toFixed(2)}`, gasto.categoria]));
        
        doc.autoTable({ head: [tableColumn], body: tableRows, startY: 70 });
        doc.save(`reporte_${periodo}_${formatDate(new Date())}.pdf`);
      };

      const PeriodoButton = ({ value, current, setter, children }) => (<button onClick={() => setter(value)} className={`px-3 py-1.5 text-sm rounded-lg ${current === value ? 'bg-slate-900 text-white' : 'bg-white border'}`}>{children}</button>);
      return (
        <div className="grid gap-4">
          <Card title="Reporte Financiero">
            <div className="flex flex-wrap items-center gap-2 mb-4">
              <PeriodoButton value="dia" current={periodo} setter={setPeriodo}>Hoy</PeriodoButton>
              <PeriodoButton value="semana" current={periodo} setter={setPeriodo}>Semana</PeriodoButton>
              <PeriodoButton value="mes" current={periodo} setter={setPeriodo}>Mes</PeriodoButton>
              <PeriodoButton value="a√±o" current={periodo} setter={setPeriodo}>A√±o</PeriodoButton>
              <button onClick={handleExport} className="px-3 py-1.5 text-sm rounded-lg bg-emerald-600 text-white ml-auto">Exportar a PDF</button>
            </div>
            
            <div className="grid md:grid-cols-3 gap-4 mb-6">
              <div className="bg-emerald-50 p-4 rounded-xl"><p className="text-sm text-emerald-800">Total Ingresos</p><p className="text-2xl font-bold text-emerald-900">${totales.ingresos.toFixed(2)}</p></div>
              <div className="bg-red-50 p-4 rounded-xl"><p className="text-sm text-red-800">Total Gastos</p><p className="text-2xl font-bold text-red-900">${totales.gastos.toFixed(2)}</p></div>
              <div className="bg-blue-50 p-4 rounded-xl"><p className="text-sm text-blue-800">Balance Neto</p><p className={`text-2xl font-bold ${totales.balance >= 0 ? 'text-blue-900' : 'text-red-900'}`}>${totales.balance.toFixed(2)}</p></div>
            </div>


            <div className="mb-6"><h4 className="text-md font-semibold text-slate-700 mb-2">Resumen Gr√°fico</h4><GraficoBarras data={dataGrafico} /></div>

            <div className="grid md:grid-cols-2 gap-4">
              <div>
                <h4 className="text-md font-semibold text-slate-700 mb-2">Desglose de Ingresos</h4>
                <div className="overflow-x-auto border rounded-xl"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Fecha</th><th className="p-2">Monto</th><th className="p-2">M√©todo</th></tr></thead><tbody>{pagosFiltrados.length === 0 && (<tr><td colSpan={3} className="text-center py-4 text-slate-400">Sin ingresos</td></tr>)}{pagosFiltrados.map(p => (<tr key={p.id} className="border-t"><td className="p-2">{p.fecha}</td><td className="p-2">${parseFloat(p.monto || 0).toFixed(2)}</td><td className="p-2">{p.metodo}</td></tr>))}</tbody></table></div>
              </div>
              <div>
                <h4 className="text-md font-semibold text-slate-700 mb-2">Desglose de Gastos</h4>
                <div className="overflow-x-auto border rounded-xl"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Fecha</th><th className="p-2">Concepto</th><th className="p-2">Monto</th></tr></thead><tbody>{gastosFiltrados.length === 0 && (<tr><td colSpan={3} className="text-center py-4 text-slate-400">Sin gastos</td></tr>)}{gastosFiltrados.map(g => (<tr key={g.id} className="border-t"><td className="p-2">{g.fecha}</td><td className="p-2">{g.concepto}</td><td className="p-2">${parseFloat(g.monto || 0).toFixed(2)}</td></tr>))}</tbody></table></div>
              </div>
            </div>
          </Card>
        </div>
      );
    }
    
    function Perfil({ perfil, alumnos, onUpdate, user, setToast, onExport, onImport }) {
  const { useRef } = React;
  const fileInputRef = useRef(null);
  
  // Estado para el formulario principal del perfil
  const [form, setForm] = useState(perfil);

  // Estados para el Centro de Comunicaciones
  const [plantillas, setPlantillas] = useState([]);
  const [plantillaSeleccionada, setPlantillaSeleccionada] = useState(null);
  const [mensajePersonalizado, setMensajePersonalizado] = useState("");
  const [destinatarios, setDestinatarios] = useState([]);
  const [busquedaAlumno, setBusquedaAlumno] = useState("");
  const [listaBusquedaAbierta, setListaBusquedaAbierta] = useState(false);

  // Carga las plantillas de mensajes desde Firebase
  useEffect(() => {
    if (!user) return;
    const plantillasCollection = db.collection('users').doc(user.uid).collection('plantillas');
    const unsubscribe = plantillasCollection.onSnapshot(snapshot => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setPlantillas(data);
    });
    return () => unsubscribe();
  }, [user]);

  // Sincroniza el formulario del perfil con los datos que vienen de MainApp
  useEffect(() => {
    const defaultPerfil = initialState.perfil;
    setForm({
        ...defaultPerfil, ...perfil,
        datosBancarios: { ...defaultPerfil.datosBancarios, ...(perfil.datosBancarios || {}) },
        horarioLaboral: perfil.horarioLaboral || defaultPerfil.horarioLaboral,
    });
  }, [perfil]);

  // L√≥gica de b√∫squeda para el selector de alumnos
  const alumnosFiltrados = useMemo(() => {
    if (!busquedaAlumno) return [];
    // Aseg√∫rate de que 'alumnos' exista antes de filtrar
    return (alumnos || []).filter(a => a.estado === 'activo' && getNombreCompleto(a).toLowerCase().includes(busquedaAlumno.toLowerCase()));
  }, [busquedaAlumno, alumnos]);

  // Funciones para manejar la selecci√≥n de destinatarios
  const handleAgregarDestinatario = (alumno) => {
    if (!destinatarios.find(d => d.id === alumno.id)) {
      setDestinatarios([...destinatarios, alumno]);
    }
    setBusquedaAlumno("");
    setListaBusquedaAbierta(false);
  };

  const handleQuitarDestinatario = (alumnoId) => {
    setDestinatarios(destinatarios.filter(d => d.id !== alumnoId));
  };
  const handleSendMessage = (destinatario) => {
    if (!mensajePersonalizado.trim()) {
        alert("El mensaje no puede estar vac√≠o.");
        return;
    }

    // Reemplaza la variable {nombre_alumno} por el nombre real
    const mensajeFinal = mensajePersonalizado.replace(/{nombre_alumno}/g, destinatario.nombre || '');
    
    // Genera y abre el enlace de WhatsApp
    const link = waLink(destinatario.telefono, mensajeFinal);
    if (link) {
        window.open(link, '_blank');
    } else {
        alert(`No se pudo generar el enlace para ${getNombreCompleto(destinatario)} porque no tiene un n√∫mero de tel√©fono v√°lido.`);
    }
};
  // --- OTRAS FUNCIONES DEL PERFIL (NO CAMBIAN) ---
  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, [name]: value }));
  };
  const handlePrecioChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, precios: { ...prev.precios, [name]: value } }));
  };
  const handlePrecioMensualChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, preciosMensuales: { ...prev.preciosMensuales, [name]: value } }));
  };
  const handleDatosBancariosChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, datosBancarios: { ...prev.datosBancarios, [name]: value } }));
  };
  const handleHorarioChange = (index, campo, valor) => {
    setForm(prev => {
        const nuevoHorario = [...prev.horarioLaboral];
        nuevoHorario[index] = { ...nuevoHorario[index], [campo]: valor };
        return { ...prev, horarioLaboral: nuevoHorario };
    });
  };
  const handleCopyToClipboard = (text) => {
    navigator.clipboard.writeText(text).then(() => {
        setToast("¬°Copiado al portapapeles!");
    }, (err) => {
        setToast("Error al copiar");
        console.error('Error al copiar: ', err);
    });
  };
  const handleSubmit = (e) => {
    e.preventDefault();
    onUpdate(form);
  };
  const handlePasswordReset = () => {
    if(user && user.email) {
        auth.sendPasswordResetEmail(user.email)
            .then(() => setToast("Email para restablecer contrase√±a enviado."))
            .catch((error) => setToast(`Error: ${error.message}`));
    }
  };

  return (
    <form onSubmit={handleSubmit} className="grid md:grid-cols-2 gap-6">
      {/* --- COLUMNA IZQUIERDA --- */}
      <div className="flex flex-col gap-6">
        <Card title="Perfil y Configuraci√≥n">
            <h4 className="text-md font-semibold text-slate-700 mb-2">Datos Personales</h4>
            <div className="grid gap-3">
              <div><label className="text-sm text-slate-600">Nombre del Profesor</label><input name="nombre" value={form.nombre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div><label className="text-sm text-slate-600">Apellido</label><input name="apellido" value={form.apellido} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div><label className="text-sm text-slate-600">Tel√©fono</label><input name="telefono" value={form.telefono} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
            </div>
            <div className="mt-6 border-t pt-6">
                <h4 className="text-md font-semibold text-slate-700 mb-2">Cuenta</h4>
                <div className="grid gap-3">
                  <div>
                    <label className="text-sm text-slate-600">Email de la cuenta</label>
                    <p className="w-full bg-slate-100 rounded-lg px-3 py-2 text-slate-700">{user?.email}</p>
                  </div>
                  <div><button type="button" onClick={handlePasswordReset} className="w-full px-4 py-2 rounded-lg border text-sm bg-slate-100 hover:bg-slate-200">Restablecer Contrase√±a</button></div>
                </div>
            </div>
        </Card>
        
        <Card title="Datos Bancarios para Transferencias">
            <div className="grid gap-4">
                {['alias', 'cbu', 'banco', 'titular'].map(field => (
                    <div key={field}>
                        <label className="text-sm font-medium text-slate-600 capitalize">{field}</label>
                        <div className="flex gap-2 mt-1">
                            <input type="text" name={field} value={form.datosBancarios[field]} onChange={handleDatosBancariosChange} className="w-full border rounded-lg px-3 py-2" />
                            <button type="button" onClick={() => handleCopyToClipboard(form.datosBancarios[field])} className="px-3 py-2 rounded-lg border text-sm hover:bg-slate-100">Copiar</button>
                        </div>
                    </div>
                ))}
            </div>
        </Card>
        
        <Card title="Centro de Comunicaciones">
            <div className="grid gap-4">
                <div>
                    <label className="text-sm font-medium text-slate-600">1. Elige una plantilla o escribe un mensaje</label>
                    <select 
                        className="w-full mt-1 border rounded-lg px-3 py-2"
                        value={plantillaSeleccionada ? plantillaSeleccionada.id : ""}
                        onChange={(e) => {
                            const idPlantilla = e.target.value;
                            const plantillaElegida = plantillas.find(p => p.id === idPlantilla);
                            if (plantillaElegida) {
                                setPlantillaSeleccionada(plantillaElegida);
                                setMensajePersonalizado(plantillaElegida.texto);
                            } else {
                                setPlantillaSeleccionada(null);
                                setMensajePersonalizado("");
                            }
                        }}
                    >
                        <option value="">Seleccionar plantilla...</option>
                        {plantillas.map(p => (<option key={p.id} value={p.id}>{p.titulo}</option>))}
                    </select>
                    <textarea value={mensajePersonalizado} onChange={(e) => setMensajePersonalizado(e.target.value)} className="w-full mt-2 border rounded-lg px-3 py-2" rows={5} placeholder="O escribe un mensaje personalizado aqu√≠... Usa {nombre_alumno} para personalizar." />
                </div>
                <div className="relative">
                    <label className="text-sm font-medium text-slate-600">2. Selecciona los destinatarios</label>
                    <input type="text" value={busquedaAlumno} onChange={(e) => { setBusquedaAlumno(e.target.value); setListaBusquedaAbierta(true); }} onBlur={() => setTimeout(() => setListaBusquedaAbierta(false), 200)} placeholder="Escribe para buscar alumnos..." className="w-full mt-1 border rounded-lg px-3 py-2" />
                    {listaBusquedaAbierta && busquedaAlumno && (
                        <ul className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg">
                            {alumnosFiltrados.length > 0 ? alumnosFiltrados.map(a => (
                                <li key={a.id} onMouseDown={() => handleAgregarDestinatario(a)} className="px-3 py-2 hover:bg-slate-100 cursor-pointer">{getNombreCompleto(a)}</li>
                            )) : <li className="px-3 py-2 text-slate-500">No se encontraron alumnos.</li>}
                        </ul>
                    )}
                    <div className="mt-2">
                        <p className="text-xs font-semibold text-slate-500">Destinatarios ({destinatarios.length}):</p>
                        {destinatarios.length > 0 && (
                            <div className="flex flex-wrap gap-2 mt-1 p-2 border rounded-lg bg-slate-50">
                                {destinatarios.map(d => (
                                    <span key={d.id} className="flex items-center gap-2 bg-sky-100 text-sky-800 text-sm rounded-full px-2 py-1">
                                        {getNombreCompleto(d)}
                                        <button type="button" onClick={() => handleQuitarDestinatario(d.id)} className="w-4 h-4 rounded-full bg-sky-200 text-sky-800 flex items-center justify-center font-bold text-xs">x</button>
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
                {/* Secci√≥n 3: Env√≠o de Mensajes */}
<div>
    <label className="text-sm font-medium text-slate-600">3. Env√≠a los mensajes</label>
    <div className="mt-2 p-3 border rounded-lg bg-slate-50 space-y-2 max-h-48 overflow-y-auto">
        {destinatarios.length > 0 ? (
            destinatarios.map(destinatario => (
                <button 
                    key={destinatario.id}
                    type="button"
                    onClick={() => handleSendMessage(destinatario)}
                    className="w-full flex justify-between items-center text-left px-3 py-2 text-sm rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors"
                >
                    <span>Enviar a: <strong>{getNombreCompleto(destinatario)}</strong></span>
                    <span role="img" aria-label="send">üí¨</span>
                </button>
            ))
        ) : (
            <p className="text-xs text-slate-400">Selecciona al menos un destinatario para ver los botones de env√≠o.</p>
        )}
    </div>
</div>
            </div>
        </Card>
        
        <Card title="Gesti√≥n de Datos">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onClick={onExport} className="w-full px-4 py-2 rounded-lg border bg-blue-600 text-white hover:bg-blue-700">Exportar Datos (Backup)</button>
                <button onClick={() => fileInputRef.current.click()} className="w-full px-4 py-2 rounded-lg border bg-amber-600 text-white hover:bg-amber-700">Importar Datos</button>
                <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={onImport} />
            </div>
            <p className="text-xs text-slate-500 mt-3">**Atenci√≥n:** La importaci√≥n de datos reemplazar√° toda la informaci√≥n existente.</p>
        </Card>
      </div>

      {/* --- COLUMNA DERECHA --- */}
      <div className="flex flex-col gap-6">
          <Card title="Configuraci√≥n General">
                <div className="grid gap-4">
                     <div>
                        <h4 className="text-md font-semibold text-slate-700 mb-2">Modalidad de Cobro Principal</h4>
                        <select name="metodoCobro" value={form.metodoCobro} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">
                          <option value="porClase">Por Clase</option>
                          <option value="mensual">Mensual</option>
                        </select>
                     </div>
                     <div>
                        <h4 className="text-md font-semibold text-slate-700 mb-2">Canchas / Ubicaciones</h4>
                        <textarea name="canchas" value={form.canchas} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" rows={4} placeholder="Una ubicaci√≥n por l√≠nea..."></textarea>
                     </div>
                </div>
          </Card>
          <Card title="Precios por Clase">
            <div className="grid grid-cols-2 gap-3">
              <div><label className="text-sm text-slate-600">Individual</label><input type="number" name="individual" value={form.precios.individual} onChange={handlePrecioChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div><label className="text-sm text-slate-600">Dupla</label><input type="number" name="dupla" value={form.precios.dupla} onChange={handlePrecioChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div><label className="text-sm text-slate-600">Tr√≠o</label><input type="number" name="trio" value={form.precios.trio} onChange={handlePrecioChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div><label className="text-sm text-slate-600">Cuarteto</label><input type="number" name="cuarteto" value={form.precios.cuarteto} onChange={handlePrecioChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div className="col-span-2"><label className="text-sm text-slate-600">Escuelita</label><input type="number" name="escuelita" value={form.precios.escuelita} onChange={handlePrecioChange} className="w-full border rounded-lg px-3 py-2" /></div>
            </div>
        </Card>
         <Card title="Precios Mensuales">
             <div className="grid md:grid-cols-2 gap-3">
                {FRECUENCIAS_MENSUALES.map(f => (
                    <div key={f.value}><label className="text-sm text-slate-600">{f.label}</label><input type="number" name={f.value} value={form.preciosMensuales[f.value]} onChange={handlePrecioMensualChange} className="w-full border rounded-lg px-3 py-2" /></div>
                ))}
            </div>
        </Card>
          <Card title="Horario Laboral General">
              <div className="space-y-3">
                  {(form.horarioLaboral || []).map((item, index) => (
                      <div key={item.dia} className="grid grid-cols-[80px_1fr_1fr_auto] items-center gap-3">
                          <label htmlFor={`activo-${index}`} className="font-semibold text-sm flex items-center">{item.dia}</label>
                          <input type="time" value={item.desde} onChange={(e) => handleHorarioChange(index, 'desde', e.target.value)} disabled={!item.activo} className="border rounded-lg px-2 py-1.5 disabled:bg-slate-100" />
                          <input type="time" value={item.hasta} onChange={(e) => handleHorarioChange(index, 'hasta', e.target.value)} disabled={!item.activo} className="border rounded-lg px-2 py-1.5 disabled:bg-slate-100" />
                          <input type="checkbox" id={`activo-${index}`} checked={item.activo} onChange={(e) => handleHorarioChange(index, 'activo', e.target.checked)} className="form-checkbox h-5 w-5" />
                      </div>
                  ))}
              </div>
          </Card>
          <div className="mt-6 flex justify-end">
            <button type="submit" className="px-6 py-3 rounded-lg bg-emerald-600 text-white font-semibold">Guardar Todos los Cambios</button>
          </div>
      </div>
    </form>
  );
}

    function PagoGrupalModal({ isOpen, clase, alumnos, onCancel, onSave, focusAlumnoId }) {
  const [pagos, setPagos] = useState({});

  
  // Derived lists available for render and effects
  const alumnosDeClase = clase ? (clase.alumnoIds || []).map(id => (alumnos || []).find(a => a.id === id)).filter(Boolean) : [];
  
  const visibles = focusAlumnoId ? alumnosDeClase.filter(a => a.id === focusAlumnoId) : alumnosDeClase;
useEffect(() => {
    if (clase) {
      const alumnosQuePagan = alumnosDeClase.filter(a => a.plan !== 'mensual');
      const precioPorAlumno = (clase.alumnoIds?.length || 1) > 0 ? (parseFloat(clase.precio) / (clase.alumnoIds?.length || 1)) : 0;

      const initialState = {};
      alumnosDeClase.forEach(alumno => {
        const esMensual = alumno.plan === 'mensual';
        initialState[alumno.id] = {
          monto: precioPorAlumno.toFixed(2),
          metodo: esMensual ? "Mensual" : "Pendiente",
          mixtoEfectivo: "0",
          mixtoTransferencia: "0"
        };
      });
      setPagos(initialState);
  }
}, [clase, alumnos]);

  if (!isOpen || !clase) return null;

  const handlePaymentChange = (alumnoId, field, value) => {
    setPagos(prev => ({
      ...prev,
      [alumnoId]: {
        ...prev[alumnoId],
        [field]: value
      }
    }));
  };

  const handleSave = () => {
  const pagosAGuardar = Object.entries(pagos).map(([alumnoId, data]) => {
    const registro = { alumnoId, ...data };
    if (data.metodo === "Mixto") {
      const ef = parseFloat(data.mixtoEfectivo || 0);
      const tx = parseFloat(data.mixtoTransferencia || 0);
      registro.detalleMixto = { efectivo: ef, transferencia: tx };
      registro.monto = (ef + tx).toFixed(2);
    }
    return registro;
  });
  onSave(pagosAGuardar);
};

  return (
    <Modal isOpen={isOpen} title={`Registrar Pago: ${clase.tipo}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pagos">
      <div className="grid gap-4">
        <p className="text-sm text-center border-b pb-2">Clase del {clase.fecha} a las {clase.hora}. Precio total: ${clase.precio}</p>
        <div className="space-y-4 max-h-64 overflow-y-auto pr-2">
            {visibles.map(alumno => (
                <div key={alumno.id} className="p-2 border rounded-lg">
                    <p className="font-semibold">{getNombreCompleto(alumno)}</p>
                    <div className="grid grid-cols-2 gap-2 mt-1"><div className="col-span-2 text-xs text-emerald-700">Plan Mensual activo</div>
                            <div>
                                <label className="text-xs text-slate-600">Monto</label>
                                <input 
                                    type="number" 
                                    value={pagos[alumno.id]?.monto || ''}
                                    onChange={(e) => handlePaymentChange(alumno.id, 'monto', e.target.value)}
                                    className="w-full border rounded-lg px-2 py-1" 
                                />
                            </div>
                            <div>
                                <label className="text-xs text-slate-600">M√©todo</label>
                                <select 
                                    value={pagos[alumno.id]?.metodo || 'Pendiente'}
                                    onChange={(e) => handlePaymentChange(alumno.id, 'metodo', e.target.value)}
                                    className="w-full border rounded-lg px-2 py-1"
                                >
                                    {METODOS_PAGO.map(m => <option key={m}>{m}</option>)}
                                </select>
{(pagos[alumno.id]?.metodo === "Mixto") && (
  <div className="grid grid-cols-2 gap-2 mt-2">
    <div>
      <label className="text-xs text-slate-600">Efec.</label>
      <input type="number" value={pagos[alumno.id]?.mixtoEfectivo || ""} onChange={(e)=> setPagos(prev => ({...prev, [alumno.id]: {...prev[alumno.id], mixtoEfectivo: e.target.value, monto: (parseFloat(e.target.value||0) + parseFloat(prev[alumno.id]?.mixtoTransferencia||0)).toFixed(2)}}))} className="w-full rounded-lg px-2 py-1 border" />
    </div>
    <div>
      <label className="text-xs text-slate-600">Transf.</label>
      <input type="number" value={pagos[alumno.id]?.mixtoTransferencia || ""} onChange={(e)=> setPagos(prev => ({...prev, [alumno.id]: {...prev[alumno.id], mixtoTransferencia: e.target.value, monto: (parseFloat(prev[alumno.id]?.mixtoEfectivo||0) + parseFloat(e.target.value||0)).toFixed(2)}}))} className="w-full rounded-lg px-2 py-1 border" />
    </div>
    <div className="col-span-2 text-xs text-slate-500">Total mixto: ${pagos[alumno.id]?.monto || "0.00"}</div>
  </div>
)}

                            </div>
                        </div>
                    )}
                </div>
            ))}
        </div>
      </div>
    </Modal>
  );
}
// Pega esta nueva funci√≥n en tu archivo
function RegistroPagoMensualModal({ isOpen, alumno, perfil, onCancel, onSave }) {
  const [form, setForm] = useState({
    monto: "",
    metodo: "Transferencia",
    mes: new Date().getMonth(),
    fechaPago: formatDate(new Date())
  });

  useEffect(() => {
    // Cuando se abre el modal, calcula el monto sugerido del plan del alumno
    if (alumno && perfil.preciosMensuales) {
      const montoPredefinido = perfil.preciosMensuales[alumno.frecuencia] || "";
      setForm(prev => ({ ...prev, monto: montoPredefinido }));
    }
  }, [isOpen, alumno, perfil]);

  if (!isOpen || !alumno) return null;

  const handleSave = () => {
    if (!form.monto || parseFloat(form.monto) <= 0) {
      alert("Por favor, ingresa un monto v√°lido.");
      return;
    }
    onSave(form);
  };

  return (
    <Modal isOpen={isOpen} title={`Registrar Abono: ${getNombreCompleto(alumno)}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pago">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">Mes Correspondiente</label>
          <select 
            value={form.mes} 
            onChange={(e) => setForm({...form, mes: parseInt(e.target.value)})}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            {MESES_NOMBRES.map((nombre, index) => <option key={index} value={index}>{nombre}</option>)}
          </select>
        </div>
        <div>
          <label className="text-sm text-slate-600">Monto Pagado</label>
          <input 
            type="number" 
            value={form.monto} 
            onChange={(e) => setForm({...form, monto: e.target.value})} 
            className="w-full border rounded-lg px-3 py-2 mt-1" 
            placeholder="0.00" 
          />
        </div>
        <div>
          <label className="text-sm text-slate-600">M√©todo de Pago</label>
          <select 
            value={form.metodo} 
            onChange={(e) => setForm({...form, metodo: e.target.value})}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            {METODOS_PAGO.filter(m => m !== 'Pendiente').map(m => <option key={m}>{m}</option>)}
          </select>
        </div>
        <div>
          <label className="text-sm text-slate-600">Fecha de Pago</label>
          <input 
            type="date" 
            value={form.fechaPago} 
            onChange={(e) => setForm({...form, fechaPago: e.target.value})} 
            className="w-full border rounded-lg px-3 py-2 mt-1" 
          />
        </div>
      </div>
    </Modal>
  );
}
    function PagoMensualModal({ isOpen, alumno, mes, onCancel, onSave }) {
      const [form, setForm] = useState({ monto: "", metodo: "Efectivo" });
      useEffect(() => {
        if (alumno) {
          const restante = alumno.cuota - alumno.totalPagado;
          setForm({ monto: restante > 0 ? restante.toFixed(2) : "", metodo: "Efectivo" });
        }
      }, [alumno]);
      if (!isOpen || !alumno) return null;
      const handleSave = () => { onSave({ ...form, monto: form.monto || "0" }); };
      return (
        <Modal isOpen={isOpen} title={`Pago Cuota: ${alumno.nombre}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pago">
          <div className="grid gap-4">
            <p>Cuota de {MESES_NOMBRES[mes]} por ${alumno.cuota.toFixed(2)}. Pagado: ${alumno.totalPagado.toFixed(2)}.</p>
            <div><label className="text-sm text-slate-600">Monto a Pagar</label><input type="number" value={form.monto} onChange={(e) => setForm({...form, monto: e.target.value})} className="w-full border rounded-lg px-3 py-2" placeholder="0.00" /></div>
            <div><label className="text-sm text-slate-600">M√©todo de Pago</label><select value={form.metodo} onChange={(e) => setForm({...form, metodo: e.target.value})} className="w-full border rounded-lg px-3 py-2">{METODOS_PAGO.filter(m => m !== 'Pendiente').map(m => <option key={m}>{m}</option>)}</select></div>
          </div>
        </Modal>
      );
    }
    
    function LoginScreen() {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [message, setMessage] = useState('');
        const [view, setView] = useState('login');
        const [loading, setLoading] = useState(false);

        const handleAuthAction = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');
            setMessage('');
            try {
                if (view === 'register') {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).collection('profile').doc('main').set(initialState.perfil);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        const handlePasswordReset = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');
            setMessage('');
            try {
                await auth.sendPasswordResetEmail(email);
                setMessage('Se envi√≥ un correo para restablecer tu contrase√±a.');
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
                <div className="w-full max-w-sm mx-auto">
                    <div className="flex flex-col items-center mb-8"> {/* Aumentamos un poco el margen inferior */}
    <img 
      src="coachexpro logos N.png" // <-- EL NOMBRE DE TU NUEVO ARCHIVO
      alt="Coachex-Pro Logo" 
      className="w-64" // Ajusta el ancho aqu√≠ si es necesario
    />
    <p className="text-slate-500 text-lg mt-2">Gesti√≥n de Profesores</p>
</div>
                    
                    <div className="bg-white rounded-2xl shadow-lg p-8">
                        {view === 'login' && (
                            <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Iniciar Sesi√≥n</h2>
                                <form onSubmit={handleAuthAction} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    <div><label className="text-sm font-medium text-slate-600">Contrase√±a</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-2 rounded-lg font-semibold hover:bg-slate-800 transition disabled:bg-slate-400">{loading ? 'Cargando...' : 'Ingresar'}</button>
                                </form>
                                <div className="text-center mt-4"><button onClick={() => setView('reset')} className="text-sm text-blue-600 hover:underline">¬øOlvidaste tu contrase√±a?</button></div>
                                <div className="text-center mt-2"><button onClick={() => setView('register')} className="text-sm text-slate-600 hover:underline">¬øNo ten√©s cuenta? Registrate</button></div>
                            </div>
                        )}
                        {view === 'register' && (
                             <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Crear Cuenta</h2>
                                <form onSubmit={handleAuthAction} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    <div><label className="text-sm font-medium text-slate-600">Contrase√±a</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-2 rounded-lg font-semibold hover:bg-slate-800 transition disabled:bg-slate-400">{loading ? 'Cargando...' : 'Registrarse'}</button>
                                </form>
                                <div className="text-center mt-4"><button onClick={() => setView('login')} className="text-sm text-slate-600 hover:underline">¬øYa ten√©s cuenta? Ingres√°</button></div>
                            </div>
                        )}
                        {view === 'reset' && (
                             <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Restablecer Contrase√±a</h2>
                                <form onSubmit={handlePasswordReset} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    {message && <p className="text-sm text-green-600">{message}</p>}
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-2 rounded-lg font-semibold hover:bg-slate-800 transition disabled:bg-slate-400">{loading ? 'Enviando...' : 'Enviar correo'}</button>
                                </form>
                                <div className="text-center mt-4"><button onClick={() => setView('login')} className="text-sm text-slate-600 hover:underline">Volver a Iniciar Sesi√≥n</button></div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }
    
    function MainApp({ user, onLogout }) {
        const [current, setCurrent] = useState("dashboard");
      const [state, setState] = useState({ alumnos: [], clases: [], pagos: [], gastos: [], perfil: {} });
      const [loading, setLoading] = useState(true);
      const [toast, setToast] = useState("");
      const [deletingInfo, setDeletingInfo] = useState({ id: null, type: null, collection: null });
      const [payingClase, setPayingClase] = useState(null);
            const [focusAlumnoId, setFocusAlumnoId] = useState(null);
      const openPagoPendiente = (claseId, alumnoId) => {
        const clase = (state.clases || []).find(c => c.id === claseId);
        if (clase) { setPayingClase(clase); setFocusAlumnoId(alumnoId); }
      };const [payingCuota, setPayingCuota] = useState({alumno: null, mes: null});
      const [goToClassForm, setGoToClassForm] = useState(false);
      const [claseParaEditar, setClaseParaEditar] = useState(null);
      const [nuevoAlumnoId, setNuevoAlumnoId] = useState(null);
      const openRegistrarClaseForAlumno = (alumnoId) => { setCurrent("clases"); setNuevoAlumnoId(alumnoId); };
      const [registrandoAbono, setRegistrandoAbono] = useState(null); // Guarda el alumno para el modal

      useEffect(() => {
        if (!user) return;
        setLoading(true);
        const collections = ['alumnos', 'clases', 'pagos', 'gastos'];
        const unsubscribes = [];

        collections.forEach(collectionName => {
            const unsubscribe = db.collection('users').doc(user.uid).collection(collectionName).onSnapshot(snapshot => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setState(prevState => ({ ...prevState, [collectionName]: data }));
            }, error => console.error(`Error fetching ${collectionName}: `, error));
            unsubscribes.push(unsubscribe);
        });

        const profileUnsubscribe = db.collection('users').doc(user.uid).collection('profile').doc('main').onSnapshot(doc => {
            if (doc.exists) {
                setState(prevState => ({ ...prevState, perfil: { ...initialState.perfil, ...doc.data()} }));
            } else {
                 setState(prevState => ({ ...prevState, perfil: initialState.perfil }));
            }
            setLoading(false);
        }, error => {
            console.error("Error fetching profile: ", error);
            setLoading(false);
        });
        unsubscribes.push(profileUnsubscribe);

        return () => unsubscribes.forEach(unsub => unsub());
      }, [user]);

      const getCollection = (collectionName) => db.collection('users').doc(user.uid).collection(collectionName);

      const alumnoCrud = {
        create: async (data) => {
    const docRef = await getCollection('alumnos').add(data);
    setToast("Alumno creado");
    return { ...data, id: docRef.id }; // Devuelve el alumno con su nuevo ID
},
        update: ({id, ...data}) => getCollection('alumnos').doc(id).update(data).then(() => setToast("Alumno actualizado")),
        delete: (id) => setDeletingInfo({ id, type: 'alumno', collection: 'alumnos' }),
      };
const pagoCrud = { 
        createPagosClase: async (pagosData) => { 
          const batch = db.batch();
          
          pagosData.forEach(pago => {
            if (parseFloat(pago.monto) > 0 || pago.metodo === 'Pendiente') {
                const docRef = getCollection('pagos').doc();
                const payload = { 
                    claseId: payingClase.id, 
                    alumnoId: pago.alumnoId, 
                    fecha: payingClase.fecha, 
                    metodo: pago.metodo, 
                    monto: pago.monto 
                };
                if (pago.metodo === 'Mixto' && pago.detalleMixto) {
                    payload.detalleMixto = pago.detalleMixto;
                }
                batch.set(docRef, payload);
            }
          });
await batch.commit();
          setToast("Pagos registrados"); 
          setPayingClase(null);
        },

        createAbono: (pagoData, alumno) => {
            const newPago = {
                alumnoId: alumno.id,
                fecha: pagoData.fechaPago,
                concepto: `Abono Mensual - ${MESES_NOMBRES[pagoData.mes]}`,
                monto: pagoData.monto,
                metodo: pagoData.metodo
            };
            getCollection('pagos').add(newPago).then(() => {
                setToast("Pago de abono registrado con √©xito");
                setRegistrandoAbono(null); // Cierra el modal
            });
        },

        createMensual: (pagoData) => { 
            const { alumno, mes } = payingCuota; 
            const fecha = new Date(); 
            fecha.setMonth(mes); 
            const newPago = { alumnoId: alumno.id, fecha: formatDate(fecha), concepto: `Cuota Mensual - ${MESES_NOMBRES[mes]}`, ...pagoData };
            getCollection('pagos').add(newPago).then(() => {
                setToast("Pago de cuota registrado"); 
                setPayingCuota({alumno: null, mes: null});
            });
        }
      }; // <-- LA LLAVE DE CIERRE IBA AQU√ç
      const claseCrud = { 
  create: async (c) => { 
      const claseData = {...c};
      delete claseData.id;
      if (claseData.recurrente) {
          const batch = db.batch();
          const semanas = parseInt(claseData.mesesRecurrencia, 10) * 4;
          for(let i=0; i<semanas; i++) {
              const nuevaFecha = addDays(new Date(claseData.fecha), i * 7);
              const newClase = { ...claseData, fecha: formatDate(nuevaFecha), recurrente: false };
              const docRef = getCollection('clases').doc();
              batch.set(docRef, newClase);
          }
          await batch.commit();
          setToast("Clases recurrentes creadas");
      } else {
          await getCollection('clases').add(claseData);
          setToast("Clase creada");
      }
  }, 
  update: ({id, ...data}) => getCollection('clases').doc(id).update(data).then(() => setToast("Clase actualizada")),
  delete: (id) => setDeletingInfo({ id, type: 'clase', collection: 'clases' })
};
      const gastoCrud = { 
        create: (g) => getCollection('gastos').add(g).then(() => setToast("Gasto creado")),
        update: ({id, ...data}) => getCollection('gastos').doc(id).update(data).then(() => setToast("Gasto actualizado")),
        delete: (id) => setDeletingInfo({ id, type: 'gasto', collection: 'gastos' }),
      };
      const perfilCrud = { 
  update: (p) => db.collection('users').doc(user.uid).collection('profile').doc('main').set(p, { merge: true }).then(() => setToast("Perfil actualizado"))
};
      
      const confirmDelete = async () => {
        const { id, type, collection } = deletingInfo;
        if (!id || !collection) return;
        await getCollection(collection).doc(id).delete();
        if(type === 'clase'){
            const pagosSnapshot = await getCollection('pagos').where('claseId', '==', id).get();
            const batch = db.batch();
            pagosSnapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        }
        setToast(`${type.charAt(0).toUpperCase() + type.slice(1)} eliminado/a`);
        setDeletingInfo({ id: null, type: null, collection: null });
      };
      const handleRegisterMonthlyPayment = (alumno) => {
    setRegistrandoAbono(alumno); // Guarda el alumno y esto har√° que el modal se abra
};
const handleExportData = () => {
    const dataToExport = {
        alumnos: state.alumnos,
        clases: state.clases,
        pagos: state.pagos,
        gastos: state.gastos,
        perfil: state.perfil,
        grupos: state.grupos || []
    };

    const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(
        JSON.stringify(dataToExport, null, 2)
    )}`;
    
    const link = document.createElement("a");
    link.href = jsonString;
    const date = new Date().toISOString().slice(0, 10);
    link.download = `coachex_backup_${date}.json`;
    link.click();
    setToast("Datos exportados con √©xito.");
};

const handleImportData = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedData = JSON.parse(e.target.result);

            const confirmImport = window.confirm(
                "¬°ATENCI√ìN! ¬øEst√°s seguro de que quieres importar estos datos?\n\n" + 
                "TODOS TUS DATOS ACTUALES SER√ÅN BORRADOS Y REEMPLAZADOS.\n\n" +
                "Esta acci√≥n no se puede deshacer."
            );

            if (confirmImport) {
                setToast("Importando datos... La p√°gina se recargar√° al finalizar.");
                console.log("Datos a importar:", importedData);
                alert("La funcionalidad de escritura en la base de datos est√° pendiente. Revisa la consola para ver los datos que se importar√≠an.");
                // TODO: Implementar la escritura en Firebase.
            }
        } catch (error) {
            alert("El archivo seleccionado no es un JSON v√°lido o est√° corrupto.");
            console.error("Error al parsear JSON:", error);
        } finally {
            event.target.value = null;
        }
    };
    reader.readAsText(file);
};

const goToEditClass = (clase) => {
          setClaseParaEditar(clase);
          setCurrent("clases");
      };
      if (loading) {
        return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;
      }
      
       return (
        <div className="min-h-screen bg-slate-50 font-sans">
          <Topbar current={current} setCurrent={setCurrent} onLogout={onLogout} perfil={state.perfil} onChangeModo={(m)=> db.collection('users').doc(user.uid).collection('profile').doc('main').set({ modoTrabajo: m }, { merge: true })} />
          <main className="max-w-6xl mx-auto px-4 py-6 grid gap-4">
            {current === "dashboard" && <Dashboard state={state} goToNewClass={() => { setCurrent('clases'); setTimeout(() => document.querySelector('#nueva-clase-btn')?.click(), 50); }} goToEditClass={goToEditClass} />}
            {current === "alumnos" && <Alumnos clases={state.clases} pagos={state.pagos} alumnos={state.alumnos} onCreate={alumnoCrud.create} onUpdate={alumnoCrud.update} onDelete={alumnoCrud.delete} onRegisterMonthlyPayment={handleRegisterMonthlyPayment}  onRegistrarClase={openRegistrarClaseForAlumno}  onPagarPendiente={openPagoPendiente}  onPagarPendiente={openPagoPendiente}  onRegistrarClase={openRegistrarClaseForAlumno} />}
            {current === "clases" && <Clases clases={state.clases} alumnos={state.alumnos} pagos={state.pagos} perfil={state.perfil} onCreate={claseCrud.create} onUpdate={claseCrud.update} onDelete={claseCrud.delete} onPay={(clase) => setPayingClase(clase)} user={user} claseParaEditar={claseParaEditar} setClaseParaEditar={setClaseParaEditar} />}
            {current === "grupos" && <Grupos alumnos={state.alumnos} user={user} />}
            {current === "pagos" && <Pagos pagos={state.pagos} alumnos={state.alumnos} clases={state.clases} perfil={state.perfil} onPayMensual={(alumno, mes) => setPayingCuota({alumno, mes})} />}
            {current === "gastos" && <Gastos gastos={state.gastos} onCreate={gastoCrud.create} onUpdate={gastoCrud.update} onDelete={gastoCrud.delete} />}
            {current === "reportes" && <Reportes pagos={state.pagos} gastos={state.gastos} alumnos={state.alumnos} clases={state.clases} />}
            {current === "perfil" && <Perfil perfil={state.perfil} alumnos={state.alumnos} onUpdate={perfilCrud.update} user={user} setToast={setToast} onExport={handleExportData} onImport={handleImportData} />}
          </main>
          <Toast msg={toast} onClose={() => setToast("")} />
          <Modal isOpen={!!deletingInfo.id} title={`Eliminar ${deletingInfo.type}`} onConfirm={confirmDelete} onCancel={() => setDeletingInfo({ id: null, type: null, collection: null })} >
            ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.
          </Modal>
          <PagoGrupalModal 
    isOpen={!!payingClase} 
    clase={payingClase}
    alumnos={state.alumnos}
    onCancel={() => { setPayingClase(null); setFocusAlumnoId(null); }} 
     focusAlumnoId={focusAlumnoId}onSave={pagoCrud.createPagosClase} 
/>
{/* üëá PEGA EL NUEVO MODAL AQU√ç üëá */}
<RegistroPagoMensualModal 
    isOpen={!!registrandoAbono}
    alumno={registrandoAbono}
    perfil={state.perfil}
    onCancel={() => setRegistrandoAbono(null)}
    onSave={(pagoData) => pagoCrud.createAbono(pagoData, registrandoAbono)}
/>

          <PagoMensualModal isOpen={!!payingCuota.alumno} alumno={payingCuota.alumno} mes={payingCuota.mes} onCancel={() => setPayingCuota({alumno: null, mes: null})} onSave={pagoCrud.createMensual} />
          <footer className="text-center text-xs text-slate-500 py-6">Coachex-Pro ¬∑ Gesti√≥n de Profesores</footer>
        </div>
      );
    }

    // ------------------------------ APP WRAPPER WITH AUTH ------------------------------
    function AppGPadel() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(user => {
                setUser(user);
                setLoading(false);
            });
            return () => unsubscribe();
        }, []);

        if (loading) {
            return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;
        }

        if (!user) {
            return <LoginScreen />;
        }

        return <MainApp user={user} onLogout={() => auth.signOut()} />;
    }
    
    ReactDOM.render(<AppGPadel />, document.getElementById('root'));
  </script>

</body>
</html>
