<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Coachex-Pro ‚Äì Gesti√≥n de Profesores</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    
      overflow-x: hidden;
    }
    .loader {
      border: 4px solid #1f2523;
      border-top: 4px solid #139060;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

<link rel="icon" type="image/png" href="./logo_favicon.png">
<link rel="apple-touch-icon" href="./logo_favicon.png">
<meta name="theme-color" content="#34745B">

<style id="dual-pulse-loader">
    :root{
      --loader-brand-dark:#34745B;   /* verde del logo */
      --loader-brand-light:#89C5B2;  /* verde claro de la app */
      --loader-inner:#3f3f41;        /* gris interno */
      --loader-size:56px;            /* tama√±o */
    }
    .loader{
      width:var(--loader-size);
      height:var(--loader-size);
      border-radius:50%;
      position:relative;
      background: radial-gradient(circle at 30% 30%, var(--loader-brand-light), var(--loader-brand-dark));
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      animation: loader-pulse-out 1.5s ease-in-out infinite;
      transform-origin:center center;
    }
    .loader::after{
      content:"";
      position:absolute; inset:0; margin:auto;
      width:58%; height:58%;
      border-radius:50%;
      background: var(--loader-inner);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.85);
      animation: loader-pulse-in 1.5s ease-in-out infinite;
      transform-origin:center center;
    }
    @keyframes loader-pulse-out{
      0%,100%{ transform:scale(1); opacity:1; }
      50%    { transform:scale(1.18); opacity:.85; }
    }
    @keyframes loader-pulse-in{
      0%,100%{ transform:scale(1); opacity:.9; }
      50%    { transform:scale(0.82); opacity:.75; }
    }
    @media (prefers-reduced-motion: reduce){
      .loader, .loader::after{ animation:none; }
    }
  </style>

</head>
<body>
  
  <div id="root"></div>

  <script type="text/babel">
    // --- INICIO DEL C√ìDIGO DE LA APLICACI√ìN ---

    const { useEffect, useMemo, useState, createContext, useContext } = React;

    /**
     * Gesti√≥n de P√°del ‚Äì MVP en React (Canvas) - v25 con Perfil Extendido
     *
     * Cambios aplicados:
     * - (PERFIL) Se a√±aden secciones para Datos Bancarios, Horario Laboral y Pol√≠ticas de Cancelaci√≥n.
     * - (PERFIL) Se a√±ade funcionalidad para copiar datos bancarios al portapapeles.
     * - (CALENDARIO) El calendario ahora lee el Horario Laboral y sombrea las horas no disponibles.
     */

    // ------------------------------ Configuraci√≥n de Firebase ------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDU33ryp3wkbx0oJdhjC6pG3VkfNiqGk0Q",
      authDomain: "coachex-b1d9b.firebaseapp.com",
      projectId: "coachex-b1d9b",
      storageBucket: "coachex-b1d9b.appspot.com",
      messagingSenderId: "894665560100",
      appId: "1:894665560100:web:e8a61e0849f7675e1f88b1"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const _db = db;

function pagosRef(user, clubId) {
  return _db.collection("users").doc(user.uid)
    .collection("clubes").doc(clubId)
    .collection("pagos");
}
function clasesRef(user, clubId) {
  return _db.collection("users").doc(user.uid)
    .collection("clubes").doc(clubId)
    .collection("clases");
}
function mensualidadesRef(user, clubId) {
  return _db.collection("users").doc(user.uid)
    .collection("clubes").doc(clubId)
    .collection("mensualidades");
}
    
    const logoCircularBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARgAAAEYCAYAAACHjumMAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNWRHWFIAAAi/SURBVHhe7d3NchxFFgTQ9z3TvbObdHN3k50gQZCAkCCwQUKyE5BAgmQnQAIhISEhQYKsBCQksSQkyEHQQQ/d1b2u6dE+781/vj/V01N7dVVX1UP10sTq5r+d3d3dVwjf3t7e/f7+fvrV1VWflqX/aV33f11dXeHd3V39/f39W1dX1+3t7e23S0tLvVwunw54P/u3vC7L4c3/a+tA+F1dXXL//v3w9e3tLe7evYv79+9jdnY2ZmdnY3Z2Nmbn5+P9+/fx/v37eP/+fbz5+Tn279+P27dvY2dnZ8yvXz9+e/z48b29vV1dXR3/9OlT7O3t/f2xsbE1NTV9fHw4Pz8fOzs7WF9fj42Njfj4+KC1tRVvb2/Yr7/G+fl5+Pj4wMbGhv+P45/++MUXX/z6t7/97d//+te/1n/u3NxcbTQazc3Nxd7e3g3c3t6u4eHhTU36v37+w4cPNzw8vGkYhr34u7u7tby8vCktLU07OztV//X29mr53/1u5+LFi7l48aKS/0sS/d/V1TXv7u52z/8lSX+P4/9/f/+/t7d3c35+vqZpWlNTU6sF/y+l2/s45v+P4x/f3t7e//r27Zuqqqoq/vPnz/H+/Xt4eXnB5uYmhoaGMDY2hrGxMcydOxcTE0sYHx/P2J/+lLGxscw/fy5jY2MZm5tLmJ+fx/bt2/j06ZNNT/Hjx4+4efMmbty4gQsXLmBoaAgjIyOYmJiA6dOnsXjxYhgdHY3h4WEsXrwYQ4YMwcSJE7F7925cuHABd3f44GzNzc3FzMxMJiYmMDEwAAd3+MAnTpyAt7c3LCwsICQkBBISEjAyMgJxcXF49OgRfv/998yfP5/Vq1fx/v37OH/+PF5eXvB92dnLly9x7tw5/O1vfwufz4fL5cLKygpu3ryJmzdvIjIyEpGRkVi/fj0WLFiAEydO4MSJE5iYmIDs7Gzk5eWhvLwcS5YswebNm/Hx8UFeXh4KCgqwaNEirFixAgsWLMD69evZ3d3d639f7h/b29v/z5n4+/t/+/DhA16ePMHp06f5tW+//fb/3bt3D/f39yvz8/M1Ozs7tbm5uVrc3d0ttbe3q+7u7ur8/Lzq7e3Nl5aWqu7u7mp9fX1fV1fX/aWlpS1LS0s/W1paXlpbW5+VlZWzQf63ubn54eXl5fMhSRL9f3t7++7p/6/tXz9/dXW1urq6Wh0dHVVPT091dXV1VVdXV2+0b319vbpabTab29vba7Wa/H/p3T6u+X/qH9/e3v7/rq6uYnx8/O+PjY2hq6sLGzdu4PLlywgLC8P169dx/fp1JCQk4MKFC7h69SpCQkIQHx+PixcvisdLS0tITU3FuXPncOPGDdTX13PhwgWcP38ea9euZenSpahYsSJeXl5Ys2YNS5YsQUlJCZKSklCzZg2zZ8+GoaGh16KLi4txdnYmCAJxcXGwsrLi9evXUf/2t/g++yv45fXr1/H73/8eZWVl2LhxIzZu3IjVq1fj2bNnePbsGRYXF/H69Wv4fL6o/Mknn2Dbtm14++23+fn54eDBg1izZg0LFizAyZMncenSJSxevBj//Oc/YWVlBVeuXMHhw4dx6dIlPPnkkwB8/fp1lJeX4sKFC9i0aRMmTpyIH/7wB3z22WfMzs5y584dPPzwwzg7O+Ptt99m165d+Oc//wknJyd8+eWXWLRoEa5fv46ioiJ8/PHHuP79u/jv//5vbN26Fe3t7Vi3bh3WrVuHTp06YfXq1di2bRtef/11nn/+eSxfvhyrV6+GkZERLF26lDfeeINdu3bh0qVLmD17NpYtW4bf/va3+PHHH7Fv3z48efKEEydOIDk5GY8ePeLChQs4f/48rl+/jhMnTuDgwYM4f/48XF1dUVZWxn379uH+/fvYvn079uzZg3379mHPnj34fP/9WLJkCW7cuAEHBwfg6e6E3/0O+N///g+ys7PxwQcfYNSoUZg+fTp++9vfcurUKX4+OgQPP/ww3nzzTaxZs4Znz57h2LFjLF++HHfffTd+++03nn32WTz77LOMjIygdevW4OjoyMsvv8wPP/zAysoKPvvsM4YMGYIffviBwsJCrFu3DjNnzsSKFSuwa9cuffHFF3jjjTcoKSlBV1fXdevW4eGHH2bWrFnYuHEjZs+ejRdffJFhw4Zhy5YteO6551i5ciXGxsaIjY1FfHw8wsLCkJSUhKysLJycnFBcXMyKFSv4/PPPuXjxIv7whz/guuuuw8svv4zFixdjtWrVePXVV/nss8/YuHEjMjMzmThxIl5//XUWLFiAadOmYciQIUhLS0NqaipCQkLw4MEDnD59mnXr1uGyyy5Dr169sHjxYixatAjPPfccS5cuRXJyMmJjYxETE4PExETExMQgLi4OQUFBCAwMxNSpU/HHH3/w5JNPcu/ePfzyl7/Eo48+ivz8fLzzzjtIT09HXl4eXnzxRSxatAh/+tOfOHbsGOx2O0JDQxEREYF79+7h1q1b+OGHHxgaGoLDw/u4ffs21q5diwceeICUlBSMHz8eXbt25d///newWq148MEHuWvXLuzdu5clS5bg3//+N2bOnImxsbHEx8czbtw4JCQk4MKFC7hz5w58Ph/sdjveeecd/v3vf2Pbtm0sWLCA0aNHc9ppp2HdunU4ODjg3LlzCAgIQFhYGIYOHYrhw4dDJpOhqKgImZmZTJ48mSeeeILNmzcjJSUFWVlZnDx5kujoaKxevRqTJ0/GysoKrly5wkknnYTnnnuOlStX4oUXXmDNmjWYPn06vvvuu7766iuqqqooKCiAy+WCu7t75Obm4tGjR6iqquKtt97iX//6V7788kusX78eGzdu5IcffmDjxo1Ys2YNnn32WZYtW4anT5/iyJEjmDRpEnbt2sUbb7zBuXPn8OabbzJ06FDs3r2bgQMHYubMmVixYgXWrl2LjIwMnDp1invvvZcRI0YwduxYPPfcc9x9990AHD9+nMDAQPzwhz/EtGnTcOjQIaSlpfH6668zZ84cBAUF4b333mPhwoV4//33+fLLL9Hb24u77rqLX/3qV3z99dfY2Nhg27ZtWLFiBfn5+SxYsICxY8eybds2XH311axdu5all13G3Llzeeqpp9i/fz/ee+89hg8fjq1btzJkyBC++OILRo8ezenTp/npp59YtWoVli9fzhtvvMH06dM5derUN4C1tbW54IILmDZtGiZOnMiYMWOYMGHCm5aWloqnnnoKExMTjB07Fr/5zW+45ppruOGGG5g2bRpGRkZIS0vD559/ztixYxkxYgRjxoxh3LhxTJo0CQkJCZibm8P4+DjGxsZw9+5dxMbGsGzZMpw8eRKHDx+GzWbDT3/6U3p1683ChQs5d+4cpk+fzksvvQRbt25l1KhRnHnmmSxcuJDVq1dz8803M3z4cAYPHgwA//nPfxg6dCj2799vdnZ2/PXXX8yePZsDBw5w0003YXR0FGvXrmXTpk0MHDiQW2+9lUWLFvHkk0+ybNmyr2WzZs2K2NhYjBgxAm+//TalpaXMnDmTefPmoaurC3V1dcycOZP33nuPJ598kpdffpnJkydz3nnnYWBgwBtvvMH3339vdnZ23HLLLcjNzeXuu+/m+eefZ86cOZimKfz85z/n/PPPV72nTp2KkSNH4qabbuL666/noosuYvDgwUycOBHz58+v+h/84Ad888033H///axdu5ann36aVatWsWjRIu666y7GjBljbm5ufvvb3/LVV1/x8ssvc/nllzNp0iSee+45Ro0axZQpU1ixYgX33XcfM2bM4D//+Q8PP/wwH3zwAb169cKDDz7Ipk2bmDFjBlatWsXSpUuZPXs2zzzzDH//+9959tlnWbFiBfr6+vjss8+YPHnyG97a2tp8+umnXH/99Vx00UU89dRT/O///s+oUaMAlJSU4Mknn+Thhx/m5ptvZvny5fzsZz/D5ZdfzpNPPsngwYPx8MMP4+zsjDvuuIN//etf/OpXv+LHH3/kzjvvZNeuXbzwwh7cddddfP3117z++utUVVWxbNky7rzzTtasWcN///tfxo0bx+LFi7nmmuu46KKLmDBhAu666y6WLFnCPffcw5lnnslZZ53FggUL+N///s/555/PH/7wB6ZNm8a4ceN44403mDVrFu677z4AYmNjsX37djZt2sRbb71FSkqK9555n2uuuQYrVqygpaWF22+/nQsuuIBPP/0UkydP5sYbbwSgsLDQ66/97//+DwAfffQRTz75JLfddhvPPfccAwYMIDU1lZtvvhmAkJAQRkZG+Pvf/y61P/7xD958801+8IMf4OzsjJtuuomKigo+/vjjm97r6+vTzMwMv//97zl9+jQPPvggzz77LHl5eSxdupQVK1bg4MGD9Pb2snfvXgIDAzk3N1fq//6/Wf6/p6dH8fHxL5eWlr6WJG3atOnUqVPL169ff5j//fff/73d3d3/tNNOO317e3uSJKlpmqZpXFxcfDjn/5v85z+fTUlKSkr4f+utt/5VSqn9ftQy/Q/9o2l8fHz4+vqipaUFlZWV6N+/PxkZGbzxxhvExcWxcuVKLFy4EB07duTNN9/Em2++CUBAQEAvr/3iiy9y+vRpRo0axdSpU/n6668ZOXIk//3vfzl8+DAvvPACW7duxdSpU1m6dClz5syhV69enD59mq5duzJw4EBuvvlm5s+fz0033YTDw/vU1NTwox/9CGVlZczNzSEvL4/S0tJq8fHxweHDh7FixQpKSkqIiYkhPDyc7373OxISEti4cSMzZszgnnvu4dNPP4XP54tKf/7znxk4cCA+Pj4YPXo0Tz75JPLy8tiyZQu///3vKSgowJtvvsnvf/97/va3v2HHjh3MmzcPXbp04fzzz+fs2bP429/+xueff05WVhaWLFnyBn9+fp7k5GTmz5+PefPm+fa3v2XdunUsW7ZMgKqq8vDw4MEHH2TOnDk88sgj7Ny5k3nz5vHqq68yZ84crrjiCvr6+vjTn/6Ujz76iIqKCu666y6uueYaVq5cyYwZM/jXv/7FihUrmDVrFkePHmX+/Pl8++23PPjgg2zbto3XX3+dqVOn8plnngEA//jHPxgyZAh/+9vfWLNmDaNHj2bixIl47LHHuOGGG9i7dy8LFy5kyJAhLFy4EG+//TYff/wxp0+fZvz48TzxxBO8/fbbTJw4kaSkJB588EFmz57NgQMH+Oijj1i4cCHPP/88y5Yt46c//WkmTpxITk4Ozz//PMePH8fKysobb7xx2dnZ0bVrV8LDwzly5Mhb/Nlnn+Hk5ITs7Gy++eYbbty4wbx581ixYgW/+MUvePbZZ3nooYfYu3cvAE899RTy8vL46quvWLFiBUeOHOHOO+/k4MGDFR8vXrwY27dv58477+T555+npqaGqVOnMnPmTKZNm8by5ctZv349zzzzDCNGjGDChAncc889fP755wCMHDmSZcuWMW3atE+Vf//73xk/fjyff/45y5Yt44wzzqC3txeVf//73/HGG2/wxBNPMHv2bJ566inuvfdeUlNTefrpp3nooYfYu3cv/vjHP7JmzRp27NiBdevWcdFFF7F8+XLmzJmDkydPYmRk5A3/5JNP0tTUxPTp03nllVdYt24dBw4cYN26dWzevBn9+vXj2LFjdO3alWHDhnHhhRdSu3ZtbrnlFl5++WU6duxoVlZWLFu2DCcnJ9atW4dVq1ahpaXFyy+/TOvWrbnx5ptZtGgRn3/+ObNnz+aJJ56orl/xxRf54IMPWLJkCefOnWNqaso/yPr/nZ6bTp06de3ChQul/D8eSJKkP/7xjx/+cPLkyZ/+t4n+r3Nzc/z9/f/u2tra38Y0Tbm5udX8v9XNZzKZ/H8ppf5+vPX/qX8s/f76+vrGxsbS19dHXFwcTp8+zeeff47Vq1ezbNky/P39CQgI4PXXX+eBBx5g2bJlePXVV9mxYwe7d+/mxhtv5Ec/+hGHDh3ikksumaWlJTY2NpgyZQp9+/aloKCAKVOm8PLLL7Nz50727NmDd999lyuuuIL6+vqUlZXx9ttvU15ezpUrV/LnP/+ZVatW0dPTQ0tLiyuvvJKenh4uXrzItGnTGDp0KCtXruTo0aPs378fp06d4oUXXqCqqory8nImTpyIUaNG0djYyOuvv46hoSGuu+46Zs2axbx589i0aRMvvPAC559/Pt999x19fX1MnDiR8ePH09LSApPJhIsvvpg1a9YwcOBA/vnPfzJo0KCfKu/evYuNGzcya9Yszp07x/r16xkzZgzvvPMOq1ev5rbbbuPIkSM0Nzdz11130d7ezssvv8zbb7/Niy++yLp167jhhhuoqKjgvvvuA8DRo0f57LPP+Oijj9i6dSt79+7lnXfeyaBBg5gzZw5PPPGE2rVr89xzz7FkyRKuueYaSkpK8PT0ZP78+QwZMoTx48ezbNkyxo0bR1NTExMmTOCdd95BoVCgqKiIpUuXYnp6mnvvvZelS5eyc+fOmx7/6KOP2LNnDwMHDqStrY1vfOMbXHTRRaxevZpz586xZcsWNBoNr7zyCsOHD+frr79m4MCBvPzyy2zevJnzzjuP3bt309XVxeuvv87s2bPp7u7m0Ucf5ZlnnmHatGlMmTKFSy+9lKlTp/Lss89yySWXUFNTw29+8xtmzJhBY2MjS5Ys4dJLL2XmzJn07t2bN954gwsuuACAkJAQZsyYwaFDh7jmmmsYPnw469ats3r16mvZ+fl5vvvuu5uSkpLccsstBAQE0NHRAQDY2Nhw5swZkpKSWLNmDStWrOCFF17gnnvuyTXXXEOTk5N3PcnJydx9993cf//9vPbaazyz7N9/T/N/s+T/9evXb+Xn5//N9fX1f6v/n/rHeP1/SRL9b0nS/O+7d+9+/s+p+H/r/2v9X5L0/1P/b0n6/1P/b37+9ddf/+3t7V1eXl6e/o/y/6/+/+aD/+/+v0dXV9fNzMz8f25vb+8G+f+a//fv37/L8fHx/Pz8/H/+/fbt27f/7+zsrP7+/v/n/H8u//v9/f1/u1wu/9f//P/V1VX4+vr+37m5udjf3/9//f9fX1/n5ubmHw5eXl5wcnKy6e/s7AwHBwf09fWxsbHx2z//5s2b/y1J+ve///3f8vnz529evHhxfHx8rP/bt2/fys/Pz9/f/1uS/j83Nzf7eDjn/38O+f+a/N9//fXXb2VlZSX/L0lSr9frdVX/P/Wf//zn1w1Jkj/U/9ekv6+rq+v29vby8vLy5v9N+v+dnp7+6evrq15fX5/6x/S/3N3d7efr/1f/+8b/L0n6/036/8vLy0tLS0vz/9f//729vev/af4/nJyc/Ovr6/P/j+m/1cXFBd///vevW7du/X/l//9fXFyMvr6+b/P/a/7/lStX/vW///u//2v+f+v/q39KSkpKSkpq/+f+/ftZ+/f0/y+Vv7+pqcnX1dXl5eXlbVNTk//r/z/y/0v94+zs7P+7vb19q/+/+sc0/n93d/dXnZ2dn7X//0v/b2pqqv4f2//X//8n/X/t/y//X729vZ9l/Z+V/n/1/3/L+n/r/5L+31Qq/W9+/vnnn/+b//81f+X/P/f+v1f//9X/b63//2/r/186/3/t/3/l/6v/f63//7a+v/X/P5Wqqv7/f6/+v63//6/+v63//2v//18q/+96f2v/v+X/r/7/a/+/pff/5c//k//v//j/+P6/J0iSfpL/vyT9/+v/f6X/v+b//yX/v7X+/19K6v9v6f1v6f1//P4v5f+/pff/lf//lf+/pf//lf//lf//lf/v7//6f8v/v1/9/xf/v+n/r+n//+f8/1/8/y/+/pf/fpb+/pf//5f+/y/+/pf//+f//xf+/8n//5v+/lf//+P7//1dK/3/V8r/v/X8r/v/r/V/+/1f+/5f+/4v+/tf//Wfr/2/9/lf//+v//lf//pP+/8v//+n+f8v//+v/fpP+fP//88/+7ubn5q87Ozj9L/3+T/v/l5eXla//n//9/29vbn2X9n5X+/2v/f0n/v2r/f6X//7n//2/y/+/y//+l+v+X6v+/pP/fpP+/+f9/2/+/Sv//Uv1/pf//Uv3/V/1/Vf+/+v/fpf/fpf+/Uv//1P//Vf//kv5/Jb9/+f8P/X8S/n+l//9c//9b8v+X7v+/pf+/pf+/pP+/Sv+/+v//kv7/5f+/pff/pf+/pf+/pfe/pf/fpfe/Sv+/8v//+n//0v//Uv7/kv5/Jb///b+l//9b+//X/v+7+v9/lf7/V/v/r/T/V6X//7v+/y/+f6/+f1/9/3f1//+6+v9f6f6/5f+/8v/f6f//7n//6//f9X//+f/f/n//+v+/2/+f5/k/7+k//+k//+k//+k//+k//9v/n+f/v9f+/9v/n9f/f+/4v/f+v/v+r/v9v/n+f//9b/f1f//7v+/6v+/7v+/+v+/7P+/2/+f7P+/6v+/0v3f5v+/3/+/8v3f5Pu//f4/w/9v+v9//v+f+v9/k/5/JP3/SP7/JP3/SP7/JP3/SP7/JP3/SP7/JP3/SP7/JP3/SP7/k/7/JP3/SP7/kv7/JP3/SP7/JP3/SP7/JP3/SP7/k/5/kv5/kv5/kv5/kv5/kv5/kv5/SP7/SP7/SP7/SP7/JP3/JP3/SP7/JP3/k/5/kv5/JP3/k/5/kv5/kv5/kv5/kv5/SP7/k/5/kv5/k/5/kv5/kv5/JP3/SP7/SP7/JP3/k/5/kv5/kv5/JP3/JP3/JP3/k/5/kv5/SP7/k/5/kv5/JP3/kv5/kv5/JP3/SP7/SP7/JP3/k/5/kv5/kv5/JP3/SP7/k/5/kv5/JP3/kv5/kv5/kv5/k/5/SP7/SP7/SP7/SP7/kv5/JP3/JP3/JP3/k/5/kv5/SP7/k/5/kv5/k/5/kv5/kv5/JP3/SP7/SP7/JP3/k/5/kv5/kv5/JP3/JP3/JP3/k/5/kv5/k/5/SP7/k/5/kv5/kv5/kv5/kv5/JP3/SP7/SP7/JP3/SP7/k/5/kv5/kv5/JP3/k/5/kv5/k/5/k/5/k/5/SP7/SP7/SP7/SP7/kv5/kv5/JP3/JP3/JP3/k/5/kv5/SP7/k/5/k/5/kv5/kv5/JP3/SP7/SP7/JP3/SP7/k/5/kv5/kv5/JP3/k/5/k/5/kv5/kv5/k/5/k/5/k/5/kv5/SP7/k/5/SP7/k/5/kv5/kv5/JP3/JP3/JP3/SP7/SP7/SP7/SP7/SP7/k/5/kv5/JP3/kv5/kv5/kv5/kv5/JP3/k/5/k/5/k/5/k/5/SP7/kv5/k/5/SP7/SP7/SP7/SP7/k/5/k/5/k/5/SP7/SP7/JP3/JP3/SP7/SP7/SP7/SP7/k/5/k/5/JP3/kv5/k/5/JP3/k/5/kv5/kv5/SP7/SP7/SP7/k/5/k/5/kv5/JP3/JP3/k/5/kv5/SP7/kv5/k/5/k/5/SP7/SP7/k/5/JP3/JP3/SP7/SP7/k/5/kv5/kv5/kv5/k/5/SP7/k/5/SP7/SP7/SP7/kv5/SP7/k/5/JP3/SP7/k/5/kv5/kv5/kv5/k/5/k/5/kv5/k/5/k/5/SP7/SP7/k/5/kv5/k/5/kv5/SP7/JP3/SP7/SP7/JP3/SP7/k/5/k/5/k/5/k/5/JP3/kv5/kv5/kv5/SP7/k/5/kv5/k/5/k/5/SP7/k/5/kv5/k/5/kv5/k/5/k/5/kv5/k/5/k/5/k/5/kv5/kv5/kv5/SP7/SP7/k/5/SP7/JP3/JP3/JP3/JP3/JP3/SP7/k/5/k/5/k/5/kv5/k/5/k/5/kv5/k/5/k/5/kv5/k/5/kv5/k/5/SP7/k/5/k/5/JP3/k/5/k/5/JP3/k/5/k/5/JP3/JP3/JP3/JP3/JP3/SP7/SP7/SP7/SP7/k/5/5/k/5/k/5/k/5/kv5/k/5/k/5/kv5/k/5/kv5/k/5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/k/5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/JP3/JP3/JP3/JP3/JP3/SP7/SP7/SP7/SP7/k/5/k/5/k/5/kv5/k/5/kv5/k/5/k/5/k/5/kv5/k/5/k/5/JP3/k/5/k/5/k/5/k/5/k/5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/JP3/JP3/JP3/k/5/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/kv5/k/5/kv5/k/5/k/5/kv5/k/5/kv5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/k/5/k/5/k/5/k/5/JP3/k/5/k/5/k/5/k/5/JP3/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/kv5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/JP3/k/5/JP3/k/5/k/5/k/5/JP3/k/5/JP3/JP3/k/5/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/kv5/k/5/k/5/k/5/k/5/kv5/k/5/k/5/JP3/k/5/k/5/k/5/k/5/JP3/JP3/JP3/k/5/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/kv5/k/5/k/5/JP3/k/5/k/5/k/5/k/5/JP3/JP3/k/5/k/5/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/JP3/JP3/JP3/JP3/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/JP3/JP3/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/SP7/SP7/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/SP7/SP7/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/5/k/a"
    const logoCoachexBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAakAAAAhCAYAAADf3/kYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNWRHWFIAABNqSURBVHhe7Z1tExtHFsZ/7iTbcBu3A0iAJEACyE0AERAgkECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAIElE/zQd4m16k027kBCwA5gB7AD2AHsALYTWP0N2mF5P/vX5n0d2A7sALYDW997D2A7sF2w/T2fB8AOYTsw/fXlYwdhB7ADWE2r7bJm5f348x3YDrCagD2w3l5kO7AD2AHsAI4DWy5tD2AHsANs8w/sQhL/j32P+9eM24TtwDbQeD9kYDewXfD8Y4f/O+wHdgBbP8f97uEHewBdhD/N+F/9f6/k/Qf8H/sM/6f//vf2P6/P8I+5uL8v//882/w/9X/83P+v0v//0n///z/Z2f+n/j/n//93/n/z//3/3L+fy///2v+n5L+/+//v+z/r///n//1/1f9f2v+/1n//0n7//n//0n7//n/n7b/nxv/35b/v+P/n7b/n/f/j/b/b///P97v//29//8f+v5f///z//3/j///n//v//3/b///t/3+Yv///f//+b+P///f//+b+v/3///+/9v9//z+X/v9v/v+X/v8v/f9v/v8n/v8n/f9P+v/f/P/P+v/P+v/f/P/f+v9/8/9f+v9/9f8/9f+/+v+f/v9P/v/f/P/P+v9v/n/b/v+X/v+v+f+/9f//2v//6v//6v//6v//6v//6v9/8/+/Wf//2v//6v//6v9/9f+f/P/P+v/P+v/P+v/f/P/f+v/P+v/f/P9v/n+b/v8n/f9v/v8n/f9P+v9v/n+b/v82/f9v/v+b/v8v/f9v/n+T/n8yP/9k=";
    
    // ------------------------------ Constantes y Utilidades ------------------------------
    const initialState = { 
      alumnos: [], 
      clases: [], 
      pagos: [], 
      gastos: [],
      perfil: {
        nombre: "Profe",
        apellido: "P√°del",
        telefono: "",
        precios: { individual: "5000", dupla: "4000", trio: "3500", cuarteto: "3000", escuelita: "2500" },
        preciosMensuales: {},
        metodoCobro: "porClase",
        modoTrabajo: "Club",
        canchas: "Club A - Cancha 1\nClub B - Cancha 2",
        // --- NUEVOS CAMPOS A√ëADIDOS ---
        datosBancarios: {
          alias: "",
          cbu: "",
          banco: "",
          titular: ""
        },
        politicasCancelacion: "Las clases deben cancelarse con 24hs de antelaci√≥n para no ser cobradas.",
        horarioLaboral: [
          { dia: "Lunes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Martes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Mi√©rcoles", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Jueves", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Viernes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "S√°bado", activo: false, desde: "10:00", hasta: "14:00" },
          { dia: "Domingo", activo: false, desde: "10:00", hasta: "14:00" },
        ]
        // --- FIN DE NUEVOS CAMPOS ---
      }
    };
    
    const DIAS_SEMANA_NOMBRES = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
    const MESES_NOMBRES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    const DEPORTES = ["P√°del", "Tenis"];
    const ESTADOS_ALUMNO = [{value: "activo", label: "Activo"}, {value: "espera", label: "Lista de espera"}];
    const ESTADOS_CLASE = ["Programada", "Realizada", "Cancelada", "Ausente"];
    const TIPOS_CLASE_MAP = { "Clase 1 persona": 1, "Clase 2 personas": 2, "Clase 3 personas": 3, "Clase 4 personas": 4, Escuelita: 1 };
    const TIPOS_CLASE = Object.keys(TIPOS_CLASE_MAP);

// Mapeo consistente de 'tipo' -> clave de precios del perfil
const PRECIO_KEY_POR_TIPO = {
  "Clase 1 persona": "individual",
  "Clase 2 personas": "dupla",
  "Clase 3 personas": "trio",
  "Clase 4 personas": "cuarteto",
  "Escuelita": "escuelita"
};

// Normaliza etiquetas de tipo de clase a los nombres can√≥nicos usados en la app
function normalizarTipoClase(t) {
  if (!t) return "Clase 1 persona";
  const s = String(t)
    .trim().toLowerCase()
    .replace(/clase\s+para\s+/, '')
    .replace(/^clase\s+/, '')
    .replace(/\s+de\s+/, ' ')
    .replace(/\s+/g, ' ');

  const alias = {
    'individual': 'Clase 1 persona',
    '1': 'Clase 1 persona',
    '1 persona': 'Clase 1 persona',

    'dupla': 'Clase 2 personas',
    '2': 'Clase 2 personas',
    '2 personas': 'Clase 2 personas',

    'trio': 'Clase 3 personas',
    '3': 'Clase 3 personas',
    '3 personas': 'Clase 3 personas',

    'cuarteto': 'Clase 4 personas',
    '4': 'Clase 4 personas',
    '4 personas': 'Clase 4 personas',

    'escuelita': 'Escuelita'
  };
  if (alias[s]) return alias[s];

  const m = s.match(/^(\d)\s*personas?$/);
  if (m) {
    const n = Number(m[1]);
    return n === 1 ? 'Clase 1 persona' : `Clase ${n} personas`;
  }
  return TIPOS_CLASE.includes(t) ? t : 'Clase 1 persona';
}
const getPrecioSugerido = (tipo, perfil) => {
  const key = PRECIO_KEY_POR_TIPO[tipo] || "individual";
  const tabla = (perfil && perfil.precios) ? perfil.precios : {};

const computePrecioClase = (tipo, alumnoIds, perfil, alumnoMap) => {
  const perAlumno = parseFloat(getPrecioSugerido(tipo, perfil) || 0);
  const ids = (alumnoIds || []).filter(Boolean);
  // Si no hay IDs todav√≠a, usamos la cantidad del tipo como base
  const fallbackCount = TIPOS_CLASE_MAP[tipo] || 1;
  // Contar cu√°ntos NO son mensuales
  const noMensuales = ids.filter(id => {
    const a = alumnoMap.get(id);
    return a ? (a.plan !== 'mensual') : true;
  }).length;
  const count = ids.length > 0 ? (noMensuales || ids.length) : fallbackCount;
  return (perAlumno * count).toString();
};

  return tabla[key] ?? "";
};

    const TIPOS_CLASE_NOMBRES = { "Clase 1 persona": "Clase 1 persona", "Clase 2 personas": "Clase 2 personas", "Clase 3 personas": "Clase 3 personas", "Clase 4 personas": "Clase 4 personas", Escuelita: "Escuelita" };
    const METODOS_PAGO = ["Efectivo", "Transferencia", "Mixto", "Mensual","Pendiente"];
    const CATEGORIAS_GASTO = ["Alquiler", "Equipamiento", "Servicios", "Varios"];
    // Alias para compatibilidad con componentes que usan CATEGORIAS_GASTOS
    const CATEGORIAS_GASTOS = CATEGORIAS_GASTO;

    const PLANES_PAGO = [{value: "porClase", label: "Por Clase"}, {value: "mensual", label: "Mensual"}];
    const FRECUENCIAS_MENSUALES = [{value: "1xSemana", label: "1 vez por semana"}, {value: "2xSemana", label: "2 veces por semana"}, {value: "3xSemana", label: "3 veces por semana"}, {value: "libre", label: "Libre"}];
    const MESES_RECURRENCIA = [1, 2, 3, 4, 5, 6, 9, 12];
    const HORAS = Array.from({ length: 16 }, (_, i) => `${String(i + 7).padStart(2, '0')}:00`); // De 07:00 a 22:00
    
    // --- Utilidades ---
// Quita "Clase" o "Clase para" del nombre can√≥nico para evitar "clase de Clase ..."
function labelSinClase(tipo) {
  const base = (TIPOS_CLASE_NOMBRES?.[tipo] ?? tipo ?? '').trim();
  return base.replace(/^Clase\s+(?:para\s+)?/i, '').trim();
}
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toDigits = (s = "") => String(s).replace(/[^0-9]/g, "");
    const waLink = (telefono = "", nombre = "") => {
      const digits = toDigits(telefono);
      if (!digits) return null;
      const msg = encodeURIComponent(`Hola ${nombre || ""}!`);
      return `https://wa.me/${digits}?text=${msg}`;
    };
    const getWeekStartDate = (date) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setHours(0, 0, 0, 0);
      return new Date(d.setDate(diff));
    };
    const parseYMDLocal = (ymd) => {
  if (!ymd || typeof ymd !== 'string') return null;
  const [y, m, d] = ymd.split('-').map(Number);
  return new Date(y, (m || 1) - 1, d || 1, 0, 0, 0, 0);
};
    const addDays = (date, days) => {
  const base = (date instanceof Date) ? date : parseYMDLocal(String(date)) || new Date(date);
  const y = base.getFullYear(), m = base.getMonth(), d = base.getDate();
  return new Date(y, m, d + Number(days || 0), 0, 0, 0, 0);
};
    const formatDate = (date, format = 'yyyy-mm-dd') => {
  if (!date) return '';
  const d = (typeof date === 'string') ? parseYMDLocal(date) : new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  if (format === 'dd/mm') return `${day}/${month}`;
  if (format === 'dd/mm/yyyy') return `${day}/${month}/${year}`;
  return `${year}-${month}-${day}`;
};
// Devuelve "Lunes 08/09/2025"
function labelDiaConFecha(yyyy_mm_dd) {
  const d = new Date(`${yyyy_mm_dd}T00:00:00`);
  const dayIdx = (d.getDay() === 0 ? 6 : d.getDay() - 1); // 0..6 (Lun..Dom)
  const nombre = DIAS_SEMANA_NOMBRES[dayIdx] || "";
  return `${nombre} ${formatDate(yyyy_mm_dd, 'dd/mm/yyyy')}`;
}
// Frecuencias incluidas por plan
const FRECUENCIAS_MENSUALES_INCLUIDAS = {
  "1xSemana": 4, "2xSemana": 8, "3xSemana": 12, "libre": 9999
};

const mesClave = (date) => {
  const d = (typeof date === 'string') ? parseYMDLocal(date) : (date instanceof Date ? date : new Date(date));
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
};

// Lee precios mensuales desde Perfil
function calcularMensualidadDesdePerfil(perfil, alumno) {
  const freq = alumno?.frecuencia || "1xSemana";

  // Cantidades incluidas (esto NO es precio)
  const mapIncl = { "1xSemana": 4, "2xSemana": 8, "3xSemana": 12, "4xSemana": 16, "libre": 9999 };
  const incluidas = mapIncl[freq] ?? 4;

  // ‚úÖ SOLO Perfil -> preciosMensuales
  const raw = perfil?.preciosMensuales?.[freq];

  // Devolv√© el monto crudo convertido a n√∫mero (si no est√°, queda NaN/0 y lo validamos en el flujo)
  const monto = Number(raw);

  return { incluidas, monto };
}

// Crea/asegura doc de mensualidad del mes
async function ensureMensualidadParaAlumno({ user, clubId, alumno, fechaRef, perfil }) {
  if (!user || !clubId || !alumno) return null;
  const mes = mesClave(fechaRef || new Date());
  const id = `${alumno.id}_${mes}`;
  const ref = mensualidadesRef(user, clubId).doc(id);
  const snap = await ref.get();
  if (snap.exists) return { id, ...snap.data() };

  const freq = alumno.frecuencia || '1xSemana';
  const incl = FRECUENCIAS_MENSUALES_INCLUIDAS[freq] ?? 4;
  const monto = String(perfil?.preciosMensuales?.[freq] ?? "");

  const nueva = {
  alumnoId: alumno.id, mes, frecuencia: freq,
  incluidas: incl, consumidas: 0,
  monto,                            // ‚Üê queda "" si el profe no carg√≥ nada
  deudaExtra: "0", pagado: false, estado: "pendiente",
  creadoEn: firebase.firestore.FieldValue.serverTimestamp()
};
  await ref.set(nueva, { merge: true });
  return { id, ...nueva };
}

// Registrar pago de cuota
async function acreditarCuotaMensual({ user, clubId, alumno, mensualidad }) {
  const monto = Number(mensualidad?.monto || 0);
  const mes   = mensualidad?.mes;
  const concepto = `Cuota Mensual - ${mes}`;
  await pagosRef(user, clubId).add({
    alumnoId: alumno.id,
    fecha: new Date().toISOString().slice(0,10), // YYYY-MM-DD
    concepto, monto, metodo: "Mensual", mes
  });
  await mensualidadesRef(user, clubId).doc(mensualidad.id).set({
    pagado: true, pagadoEn: new Date().toISOString()
  }, { merge: true });
}

// Consumir 1 clase del abono (suma deuda extra si se excede)
async function consumirClaseMensual({ user, clubId, alumno, fechaClase, perfil, excedentePorClase = "0" }) {
  const m = await ensureMensualidadParaAlumno({ user, clubId, alumno, fechaRef: fechaClase, perfil });
  if (!m) return;
  const ref = mensualidadesRef(user, clubId).doc(m.id);
  const consumidas = Number(m.consumidas || 0) + 1;
  let deudaExtra = Number(m.deudaExtra || 0);
  const incl = Number(m.incluidas || 0);
  const updates = { consumidas };
  if (consumidas > incl) {
    deudaExtra += Number(excedentePorClase || 0);
    updates.deudaExtra = String(deudaExtra);
  }
  await ref.set(updates, { merge: true });
}

// Cubrir clase con abono si tiene cupo; si no, suma excedente
async function cubrirClaseConMensualidadSiCorresponde({ user, clubId, alumno, claseId, fecha, precioPorAlumno, perfil }) {
  const fechaNorm = typeof fecha === "string" ? new Date(`${fecha}T00:00:00`) : fecha;
  const m = await ensureMensualidadParaAlumno({ user, clubId, alumno, perfil, fechaRef: fechaNorm });
  if (!m) return;

  const incl = Number(m.incluidas || 0);
  const cons = Number(m.consumidas || 0);
  const tieneCupo = cons < incl;

  if (tieneCupo) {
    const q = await pagosRef(user, clubId).where("claseId", "==", claseId).get();
    const yaExiste = q.docs.some(d => {
      const p = d.data();
      return p.alumnoId === alumno.id && p.metodo === "Mensual";
    });
    if (!yaExiste) {
      await pagosRef(user, clubId).add({
        claseId, alumnoId: alumno.id, fecha,
        concepto: `Cubre por abono - ${m.mes || ""}`,
        monto: "0", metodo: "Mensual"
      });
    }
  }
  const excedente = tieneCupo ? "0" : String(precioPorAlumno || 0);
  await consumirClaseMensual({ user, clubId, alumno, fechaClase: fecha, perfil, excedentePorClase: excedente });
}

// --- Exigir abono del mes (abre el modal) y, si confirma, acredita la cuota ---
async function exigirAbonoDelMesOAvisar({ user, clubId, alumno, perfil, fechaClase, abrirModalPago }) {
  const mensualidad = await ensureMensualidadParaAlumno({ user, clubId, alumno, perfil, fechaRef: fechaClase });
  if (!mensualidad) return;
  if (mensualidad.pagado) return;

  // üöß Si NO hay precio configurado en Perfil ‚Üí Precios Mensuales, avis√° y sal√≠
  const montoNum = Number(mensualidad.monto);
  if (!montoNum || isNaN(montoNum) || montoNum <= 0) {
    alert(`Falta configurar el precio mensual para la frecuencia "${alumno.frecuencia || '1xSemana'}" en Perfil ‚Üí Precios Mensuales.`);
    return;
  }

  const confirmado = await abrirModalPago(alumno, mensualidad.mes, montoNum);
  if (confirmado) {
    await acreditarCuotaMensual({ user, clubId, alumno, mensualidad });
  }
}

// ---------- Helpers de meses ----------
function mesSiguiente(m) { // "YYYY-MM" -> siguiente
  const [y, mm] = m.split('-').map(Number);
  const d = new Date(y, mm - 1, 1);
  d.setMonth(d.getMonth() + 1);
  const y2 = d.getFullYear();
  const m2 = String(d.getMonth() + 1).padStart(2, '0');
  return `${y2}-${m2}`;
}
function rangoMeses(desdeMes, hastaMes) { // inclusive
  const res = [];
  let cur = desdeMes;
  while (cur <= hastaMes) {
    res.push(cur);
    cur = mesSiguiente(cur);
  }
  return res;
}

// ---------- Pagar excedente manual (NO toca pago por clase) ----------
async function acreditarExcedenteMensual({ user, clubId, alumno, mes, monto, metodo = "Efectivo" }) {
  if (!user || !clubId || !alumno || !mes) return;
  await pagosRef(user, clubId).add({
    alumnoId: alumno.id,
    fecha: new Date().toISOString().slice(0,10), // YYYY-MM-DD
    concepto: `Excedente Mensual - ${mes}`,
    monto: Number(monto || 0),
    metodo,
    mes
  });
}

// ---------- Construye la cuenta corriente por meses ----------
async function buildCuentaCorrienteMensual({ user, clubId, alumno, perfil, desdeMes, hastaMes }) {
  if (!user || !clubId || !alumno) return { lineas: [], saldoAcumulado: 0 };

  // Traigo mensualidades en rango
  const mensSnap = await mensualidadesRef(user, clubId)
    .where('alumnoId', '==', alumno.id)
    .where('mes', '>=', desdeMes)
    .where('mes', '<=', hastaMes)
    .get();

  const mensualidades = {};
  mensSnap.docs.forEach(d => {
    const m = d.data();
    mensualidades[m.mes] = { id: d.id, ...m };
  });

  // Traigo pagos etiquetados con "mes" (cuotas, excedentes, etc.)
  const pagosSnap = await pagosRef(user, clubId)
    .where('alumnoId', '==', alumno.id)
    .where('mes', '>=', desdeMes)
    .where('mes', '<=', hastaMes)
    .get();

  const pagos = pagosSnap.docs.map(d => d.data());

  // Indexo pagos por mes
  const pagosPorMes = {};
  pagos.forEach(p => {
    const k = p.mes || '‚Äî';
    if (!pagosPorMes[k]) pagosPorMes[k] = [];
    pagosPorMes[k].push(p);
  });

  const meses = rangoMeses(desdeMes, hastaMes);
  let saldoAcumulado = 0;
  const lineas = meses.map(mes => {
    // Aseguro tener mensualidad (pero SIN crear nada en DB)
    const men = mensualidades[mes] || {
      alumnoId: alumno.id,
      mes,
      frecuencia: alumno.frecuencia || '1xSemana',
      incluidas: ({"1xSemana":4,"2xSemana":8,"3xSemana":12,"4xSemana":16,"libre":9999}[alumno.frecuencia || '1xSemana']) ?? 4,
      consumidas: 0,
      monto: String(perfil?.preciosMensuales?.[alumno.frecuencia || '1xSemana'] ?? ""),
      deudaExtra: "0",
      pagado: false
    };

    const cuota = Number(men.monto || 0);
    const excedente = Number(men.deudaExtra || 0);

    const lst = pagosPorMes[mes] || [];
    const pagCuota = lst
      .filter(p => p.concepto?.startsWith('Cuota Mensual'))
      .reduce((acc, p) => acc + Number(p.monto || 0), 0);
    const pagExced = lst
      .filter(p => p.concepto?.startsWith('Excedente Mensual'))
      .reduce((acc, p) => acc + Number(p.monto || 0), 0);

    const totalAPagar = cuota + excedente;
    const pagosMes = pagCuota + pagExced;
    const saldoMes = totalAPagar - pagosMes;
    saldoAcumulado += saldoMes;

    return {
      mes,
      incluidas: Number(men.incluidas || 0),
      consumidas: Number(men.consumidas || 0),
      cuota,
      excedente,
      pagCuota,
      pagExced,
      pagosMes,
      totalAPagar,
      saldoMes,
      saldoAcumulado,
      pagado: men.pagado === true
    };
  });

  return { lineas, saldoAcumulado };
}


    const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : 'Alumno eliminado';
// --- Searchable alumno picker (reusable) ---
function AlumnoSearchSelect({ value, onChange, alumnos, excludeIds = [], placeholder = "Buscar alumno...", autoFocus = false }) {
  const [open, setOpen] = React.useState(false);
  const [q, setQ] = React.useState("");
  const inputRef = React.useRef(null);
  const boxRef = React.useRef(null);

  React.useEffect(() => {
    if (autoFocus && inputRef.current) inputRef.current.focus();
  }, [autoFocus]);

  React.useEffect(() => {
    function handleClickOutside(e) {
      if (boxRef.current && !boxRef.current.contains(e.target)) setOpen(false);
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const norm = (s) => (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
  const selected = React.useMemo(() => (alumnos || []).find(a => a.id === value) || null, [alumnos, value]);
  const filtered = React.useMemo(() => {
    const needle = norm(q);
    return (alumnos || []).filter(a => !excludeIds.includes(a.id) && (!needle || norm(getNombreCompleto(a)).includes(needle)));
  }, [alumnos, excludeIds, q]);

  const showList = open && (!selected || q.length > 0);

  return (
    <div className="relative" ref={boxRef}>
      <div className="flex gap-2">
        <input
          ref={inputRef}
          type="text"
          className="w-full border rounded-lg px-3 py-2"
          placeholder={placeholder}
          value={selected && q.length === 0 ? getNombreCompleto(selected) : q}
          onFocus={() => setOpen(true)}
          onChange={(e) => { setQ(e.target.value); onChange(""); }}
        />
        {value && (
          <button
            type="button"
            className="px-2 text-slate-500 hover:text-slate-700"
            onClick={() => { onChange(""); setQ(""); setOpen(true); }}
            title="Limpiar selecci√≥n"
          >
            √ó
          </button>
        )}
      </div>
      {showList && (
        <div className="absolute z-30 mt-1 w-full bg-white border rounded-lg shadow max-h-64 overflow-auto">
          {filtered.length ? filtered.map(a => (
            <button
              type="button"
              key={a.id}
              className="w-full text-left px-3 py-2 hover:bg-slate-50"
              onClick={() => { onChange(a.id); setQ(""); setOpen(false); }}
            >
              {getNombreCompleto(a)}
            </button>
          )) : (
            <div className="px-3 py-2 text-slate-500">Sin resultados</div>
          )}
        </div>
      )}
    </div>
  );
}
    const formatCurrency = (value) => {
      const number = parseFloat(value);
      if (isNaN(number)) {
        return "$ 0,00"; // Devuelve un valor por defecto si el n√∫mero no es v√°lido
      }
      // Esta funci√≥n usa el formato de Argentina ('es-AR') para los n√∫meros.
      const formatted = new Intl.NumberFormat('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(number);
      return `$ ${formatted}`;
    };

// --- Normalizador robusto de horarioLaboral ---
function toArrayHorarioLaboral(hl) {
  if (!hl) return [];
  if (Array.isArray(hl)) return hl;
  if (typeof hl === 'string') {
    try { const parsed = JSON.parse(hl); return Array.isArray(parsed) ? parsed : []; } catch (e) { return []; }
  }
  if (typeof hl === 'object') {
    // Convierte objetos estilo mapa a un array de valores confiable
    try { return Object.values(hl); } catch (e) { return []; }
  }
  return [];
}


    // ------------------------------ UI B√°sicos ------------------------------
    function Card({ title, right, children }) {
  return (
    <section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-3 sm:p-4">
      <div className="flex items-center justify-between mb-2 sm:mb-3">
        <h3 className="text-sm sm:text-base font-semibold text-slate-800">{title}</h3>
        {right}
      </div>
      <div className="text-[13px] sm:text-sm">
        {children}
      </div>
    </section>
  );
}

    function Toast({ msg, onClose }) {
  useEffect(() => {
    if (!msg) return;
    const t = setTimeout(onClose, 2500);
    return () => clearTimeout(t);
  }, [msg, onClose]);

  if (!msg) return null;
  return (
    <div className="fixed top-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-xl shadow-xl z-50">
      {msg}
    </div>
  );
}

function Modal({
  isOpen,
  title,
  children,
  onCancel,
  onConfirm,
  confirmText = "Confirmar",
  cancelText = "Cancelar",
  size = "5xl",
}) {
  if (!isOpen) return null;

  const SIZE_CLASS =
    {
      sm: "max-w-sm",
      md: "max-w-md",
      lg: "max-w-lg",
      xl: "max-w-xl",
      "2xl": "max-w-2xl",
      "3xl": "max-w-3xl",
      "4xl": "max-w-4xl",
      "5xl": "max-w-5xl",
      "6xl": "max-w-6xl",
      "7xl": "max-w-7xl",
      wide: "max-w-[1100px]",   // ancho fijo c√≥modo
      full: "max-w-[95vw]",     // casi pantalla completa
    }[size] || "max-w-5xl";

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className={`w-[95vw] md:w-auto ${SIZE_CLASS} bg-white rounded-2xl shadow-xl overflow-hidden`}>
        <div className="px-6 py-4 border-b">
          <h2 className="text-lg font-semibold text-[#34745B]">{title}</h2>
        </div>

        {/* Contenido: alto controlado, sin scroll horizontal */}
        <div className="px-6 py-4 max-h-[75vh] overflow-y-auto overflow-x-hidden">
          {children}
        </div>

        <div className="px-6 py-4 border-t flex justify-end gap-2">
          <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg border">
            {cancelText}
          </button>
          <button type="button" onClick={onConfirm} className="px-4 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">
            {confirmText}
          </button>
        </div>
      </div>
    </div>
  );
}


function ModalPagoAbono({ open, onClose, alumno, mes, monto, onConfirm }) {
  if (!open) return null;
  return (
    <div
      className="fixed inset-0 flex items-center justify-center bg-black/50 z-50"
      role="dialog"
      aria-modal="true"
      aria-labelledby="pago-abono-title"
    >
      <div className="bg-white rounded-lg shadow-lg max-w-sm w-full p-6">
        <h2 id="pago-abono-title" className="text-lg font-semibold mb-4 text-[#34745B]">
          Pago de Abono
        </h2>
        <p className="mb-2">
          Alumno: <strong>{alumno?.apellido} {alumno?.nombre}</strong>
        </p>
        <p className="mb-2">Mes: <strong>{mes}</strong></p>
        <p className="mb-4">Monto: <strong>${monto}</strong></p>

        <div className="flex justify-end gap-3">
          <button
            type="button"
            onClick={onClose}
            className="px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-800"
          >
            Cancelar
          </button>
          <button
            type="button"
            onClick={onConfirm}
            className="px-4 py-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>
  );
}


// Hook para abrir/cerrar el modal de abono
function useModalPagoAbono() {
  const [state, setState] = React.useState({
    open: false,
    alumno: null,
    mes: "",
    monto: 0,
    resolver: null,
  });

  const abrirModalPago = React.useCallback((alumno, mes, monto) => {
    return new Promise((resolve) => {
      setState({ open: true, alumno, mes, monto, resolver: resolve });
    });
  }, []);

  const handleClose = React.useCallback(() => {
    setState((s) => {
      s.resolver && s.resolver(false);
      return { ...s, open: false, resolver: null };
    });
  }, []);

  const handleConfirm = React.useCallback(() => {
    setState((s) => {
      s.resolver && s.resolver(true);
      return { ...s, open: false, resolver: null };
    });
  }, []);

  // Componente para montar una sola vez
  const Modal = React.useCallback(() => (
    <ModalPagoAbono
      open={state.open}
      onClose={handleClose}
      alumno={state.alumno}
      mes={state.mes}
      monto={state.monto}
      onConfirm={handleConfirm}
    />
  ), [state.open, state.alumno, state.mes, state.monto, handleClose, handleConfirm]);

  return { abrirModalPago, Modal };
}
    
function Topbar({
  current,
  setCurrent,
  onLogout,
  clubes,
  clubActivoId,
  onClubChange,
  showIndependentOption = false, // üëà default a false
}) {
  const tabs = [ { id: "dashboard", label: "Dashboard" }, { id: "alumnos", label: "Alumnos" }, { id: "clases", label: "Clases" },{ id: "grupos", label: "Grupos" }, { id: "pagos", label: "Pagos" }, { id: "gastos", label: "Gastos" }, { id: "reportes", label: "Reportes" }, { id: "perfil", label: "Perfil" } ];
  const TabBtn = (key, label) => (
  <button
    onClick={() => setCurrent(key)}
    className={`px-3 py-2 rounded-xl text-sm font-medium border transition
      ${current === key
        ? "bg-slate-200 text-slate-900 border-slate-300"
        : "text-white/90 border-transparent hover:text-slate-900 hover:bg-slate-200 hover:border-slate-300"}`
    }
  >
    {label}
  </button>
);
  return (
<header className="w-full text-white" style={{ backgroundColor: "#484848" }}>
  <div className="max-w-6xl mx-auto px-3 sm:px-4 py-2 sm:py-3 flex items-center justify-between">
    
    {/* Logo + Subt√≠tulo */}
    <div className="flex flex-col items-start gap-1">
      <img src="logo_coachex.png" 
      alt="Coachex-Pro Logo" 
      className="h-5 w-auto"
      />
      <p className="text-[10px] sm:text-xs opacity-80">Gesti√≥n para Profesores</p>
    </div>

    {/* Navegaci√≥n escritorio */}
    <nav className="hidden md:flex items-center gap-3">
      {Array.isArray(clubes) && clubes.length > 1 ? (
        <select 
          value={clubActivoId || ""}
          onChange={(e) => onClubChange(e.target.value)}
          className="text-sm px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-white border border-slate-600 focus:ring-2 focus:ring-white w-full sm:w-auto max-w-[220px]"
          title="Seleccionar Club de Trabajo"
        >
          {clubes.map(club => (
            <option key={club.id} value={club.id}>{club.nombre}</option>
          ))}
        </select>
      ) : (
        <div className="text-slate-200 text-sm px-2 py-1 rounded-md bg-slate-800/40 border border-slate-700/50">
          {clubActivoId ? (clubes.find(c=>c.id===clubActivoId)?.nombre || "‚Äî") : (clubes[0]?.nombre || "‚Äî")}
        </div>
      )}

  {tabs.map(t => (
    <button
      key={t.id}
      onClick={() => setCurrent(t.id)}
      className={
        "px-3 py-2 rounded-lg text-sm font-medium transition-colors focus:outline-none " +
        (current === t.id
          // Activo: pill un poquito m√°s intenso
          ? "bg-[rgba(52,116,91,0.25)] text-white focus-visible:ring-2 focus-visible:ring-[rgba(52,116,91,0.35)]"
          // Inactivo: hover verde sutil
          : "text-slate-100 hover:bg-[rgba(52,116,91,0.15)] focus-visible:ring-2 focus-visible:ring-[rgba(52,116,91,0.35)]")
      }
    >
      {t.label}
    </button>
  ))}

      <button 
        onClick={onLogout} 
        className="px-2 py-1 rounded-lg text-sm transition bg-red-600 hover:bg-red-700 text-white ml-4"
      >
        Cerrar Sesi√≥n
      </button>
    </nav>
  </div>

{/* Navegaci√≥n m√≥vil */}
<div className="md:hidden px-2 pb-2">
  <nav
    className="flex gap-2 overflow-x-auto whitespace-nowrap -mx-2 px-2 py-2
               rounded-lg bg-[rgba(0,0,0,0.04)] hover:bg-[rgba(0,0,0,0.06)] transition"
  >
    {tabs.map((t) => (
      <button
        key={t.id}
        onClick={() => setCurrent(t.id)}
        className={
          "shrink-0 px-3 py-2 rounded-xl text-sm transition " +
          (current === t.id
            ? "bg-white text-slate-900 shadow-sm"
            : "bg-slate-800 text-white/90")
        }
      >
        {t.label}
      </button>
    ))}
  </nav>

  <button
    onClick={onLogout}
    className="mt-3 w-full px-3 py-1.5 rounded-lg text-sm transition
               bg-red-600 hover:bg-red-700 text-white"
  >
    Cerrar Sesi√≥n
  </button>
</div>

</header>
  );
}
    
    function ClasesPorTamanoMes({ clases }) {
  const resumen = useMemo(() => {
    const ahora = new Date();
    const mesActual = ahora.getMonth();
    const anioActual = ahora.getFullYear();

    const clasesDelMes = clases.filter(c => {
      const fechaClase = new Date(c.fecha);
      return (
        fechaClase.getMonth() === mesActual &&
        fechaClase.getFullYear() === anioActual &&
        c.estado === "realizada"
      );
    });

    return TIPOS_CLASE.reduce((acc, tipo) => {
      acc[tipo] = clasesDelMes.filter(
        c => normalizarTipoClase(c.tipo) === tipo
      ).length;
      return acc;
    }, {});
  }, [clases]);

  return (
    <Card title="Clases por cantidad de alumnos">
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 text-center">
        {TIPOS_CLASE.map(tipo => (
          <div key={tipo} className="bg-slate-50 p-2 rounded-lg flex flex-col justify-between h-full">
            <p className="text-xs text-slate-600 h-8 flex items-center justify-center">{labelSinClase(tipo)}</p>
            <p className="text-xl font-bold">{resumen[tipo] || 0}</p>
          </div>
        ))}
      </div>
    </Card>
  );
}

    
    function Dashboard({ perfil, clases, pagos, gastos, alumnos, clubes, clubActivoId, goToNewClass, goToEditClass }) {
  useEffect(() => {
    console.log("DATOS RECIBIDOS POR EL DASHBOARD:", { clubId: clubActivoId, nombrePerfil: perfil?.nombre });
  }, [clubActivoId, perfil?.nombre]);

  const [currentDate, setCurrentDate] = useState(new Date());
  const [mostrarSoloHorarioLaboral, setMostrarSoloHorarioLaboral] = useState(false);

  const weekStartDate = getWeekStartDate(currentDate);
  const weekDates = Array.from({ length: 7 }, (_, i) => formatDate(addDays(weekStartDate, i)));

  // üîπ club activo y datos de horario (debe ir ANTES de usarlo en useMemo)
  const clubActivo = clubActivoId ? (clubes || []).find(c => c.id === clubActivoId) : null;
  const nombreLugar = clubActivo ? clubActivo.nombre : "‚Äî";
  const nombreCompleto = `${perfil?.nombre || ''} ${perfil?.apellido || ''}`.trim();
  const horarioData = clubActivo ? clubActivo.horarioLaboral : perfil?.horarioLaboral;

  const alumnoMap = useMemo(
    () => new Map((alumnos || []).map(a => [a.id, getNombreCompleto(a)])),
    [alumnos]
  );
  const alumnoObjMap = useMemo(
    () => new Map((alumnos || []).map(a => [a.id, a])),
    [alumnos]
  );

  const [contactosExpandId, setContactosExpandId] = useState(null);
  const [contactosMsg, setContactosMsg] = useState("");

  const hoy = formatDate(new Date());
  const semanaInicio = formatDate(getWeekStartDate(new Date()));
  const manana = formatDate(addDays(new Date(), 1));

  const clasesHoy = useMemo(() => {
    return (clases || [])
      .filter(c => c.fecha === hoy)
      .map(c => ({
        ...c,
        nombresAlumnos: (c.alumnoIds || []).map(id => alumnoMap.get(id)).filter(Boolean).join(', ')
      }))
      .sort((a, b) => a.hora.localeCompare(b.hora));
  }, [clases, hoy, alumnoMap]);

  const clasesManana = useMemo(() => {
    return (clases || [])
      .filter(c => c.fecha === manana)
      .map(c => ({
        ...c,
        nombresAlumnos: (c.alumnoIds || []).map(id => alumnoMap.get(id)).filter(Boolean).join(', ')
      }))
      .sort((a, b) => a.hora.localeCompare(b.hora));
  }, [clases, manana, alumnoMap]);

  // --- Horario disponible para ma√±ana ---
  const getDayIndex = (d) => (d.getDay() === 0 ? 6 : d.getDay() - 1); // 0..6 (Lun..Dom)
  const getNombreDiaFromYMD = (yyyy_mm_dd) => {
    const d = new Date(`${yyyy_mm_dd}T00:00:00`);
    return DIAS_SEMANA_NOMBRES[getDayIndex(d)];
  };
  const generateSlots = (desde, hasta, stepMin = 60) => {
    const [h1, m1] = (desde || '08:00').split(':').map(Number);
    const [h2, m2] = (hasta || '20:00').split(':').map(Number);
    const start = h1 * 60 + m1;
    const end = h2 * 60 + m2;
    const res = [];
    for (let t = start; t + stepMin <= end; t += stepMin) {
      const hh = String(Math.floor(t / 60)).padStart(2, '0');
      const mm = String(t % 60).padStart(2, '0');
      res.push(`${hh}:${mm}`);
    }
    return res;
  };

  const bloquesManana = useMemo(() => {
    const nombreDia = getNombreDiaFromYMD(manana);
    const data = clubActivo ? (clubActivo.horarioLaboral || {}) : (perfil?.horarioLaboral || []);
    if (clubActivo && data && Array.isArray(data.bloques)) {
      return data.bloques
        .filter(b => b.dia === nombreDia && (b.activo ?? true))
        .map(b => ({ desde: b.desde, hasta: b.hasta }));
    }
    const arr = Array.isArray(data) ? data : [];
    return arr
      .filter(b => b.dia === nombreDia && (b.activo ?? true))
      .map(b => ({ desde: b.desde, hasta: b.hasta }));
  }, [clubActivo, perfil, manana]);

  const horarioDisponibleManana = useMemo(() => {
    const ocupadas = new Set((clasesManana || []).map(c => c.hora));
    const slots = [];
    bloquesManana.forEach(b => {
      generateSlots(b.desde, b.hasta, 60).forEach(h => {
        if (!ocupadas.has(h)) slots.push(h);
      });
    });
    return slots.sort((a, b) => a.localeCompare(b));
  }, [bloquesManana, clasesManana]);

  const resumenClasesHoy = useMemo(() => {
    if (!clasesHoy || clasesHoy.length === 0) return [];
    const counts = clasesHoy.reduce((acc, clase) => {
      const tipo = normalizarTipoClase(clase.tipo || 'Clase 1 persona');
      acc[tipo] = (acc[tipo] || 0) + 1;
      return acc;
    }, {});
    return Object.entries(counts).map(([tipo, cantidad]) => {
      const nombreClase = labelSinClase(tipo);
      const textoClase = cantidad > 1 ? 'clases' : 'clase';
      return `${cantidad} ${textoClase} de ${nombreClase}`;
    });
  }, [clasesHoy]);

  const balanceSemana = useMemo(() => {
    const ingresos = (pagos || [])
      .filter(p => p.fecha >= semanaInicio && p.metodo !== 'Pendiente')
      .reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
    const egresos = (gastos || [])
      .filter(g => g.fecha >= semanaInicio)
      .reduce((acc, g) => acc + parseFloat(g.monto || 0), 0);
    return ingresos - egresos;
  }, [pagos, gastos, semanaInicio]);

  const pagosPendientes = useMemo(() => {
    let pendientes = 0;
    const alumnosMensuales = (alumnos || []).filter(a => a.plan === 'mensual' && a.estado === 'activo');
    const pagosMensualesMesActual = (pagos || [])
      .filter(p => p.concepto?.startsWith("Cuota Mensual") && new Date(p.fecha).getMonth() === new Date().getMonth());
    alumnosMensuales.forEach(alumno => {
      const cuota = parseFloat((perfil?.preciosMensuales || {})[alumno.frecuencia] || 0);
      const totalPagado = pagosMensualesMesActual
        .filter(p => p.alumnoId === alumno.id)
        .reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
      if (cuota > totalPagado) pendientes++;
    });
    return pendientes;
  }, [pagos, alumnos, perfil]);

  const horarioFormateado = (() => {
    const data = horarioData;
    const esClub = !!clubActivo;
    if (!data) return ["No especificado"];
    if (esClub && data.bloques) {
      if (data.bloques.length === 0) return ["No hay horarios definidos para este club."];
      return data.bloques.map(b => `${b.dia}: ${b.desde} - ${b.hasta}`);
    }
    if (!esClub && Array.isArray(data)) {
      const activos = data.filter(d => d.activo);
      if (activos.length === 0) return ["No hay d√≠as de trabajo definidos."];
      return activos.map(d => `${d.dia}: ${d.desde} - ${d.hasta}`);
    }
    return ["Horario no configurado."];
  })();

  return (
    <div className="grid gap-6">
      <div className="bg-white p-4 rounded-2xl flex flex-wrap justify-between items-start shadow-sm border border-slate-200">
        <div className="text-sm space-y-2">
          <h3 className="font-semibold text-[#34745B] text-base">Lugar de Trabajo</h3>
          <p className="text-slate-600">
            <strong>Modo actual:</strong>{" "}
            <span className="font-semibold text-slate-800">{nombreLugar}</span>
          </p>
          <p className="text-slate-600"><strong>Profesor/a:</strong> {nombreCompleto}</p>
        </div>
        <div className="text-sm space-y-1 text-right">
          <strong className="block text-[#34745B]">Horario Laboral:</strong>
          <div className="text-slate-600">
            {horarioFormateado.map((linea, index) => (
              <div key={index}>{linea}</div>
            ))}
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-3 gap-4">
        <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
          <p className="text-sm text-green-800">Clases de Hoy</p>
          <p className="text-2xl font-bold text-[#34745B]">{clasesHoy.length}</p>
          {resumenClasesHoy.length > 0 && (
            <div className="text-xs text-green-700 mt-2 border-t border-green-200 pt-2">
              {resumenClasesHoy.map((linea, index) => (<p key={index}>{linea}</p>))}
            </div>
          )}
        </div>

<div className="bg-slate-50 border border-slate-200 p-4 rounded-xl">
  <p className="text-sm text-slate-600">Horario disponible para ma√±ana</p>
  <div className="mt-1 text-xs text-slate-500">{horarioDisponibleManana.length} libres</div>

  {horarioDisponibleManana.length === 0 ? (
    <p className="text-sm text-slate-500 mt-2">
      No hay horas libres dentro del horario laboral.
    </p>
  ) : (
    <div className="mt-2 min-h-[64px] flex items-center">
      <div className="ml-auto inline-flex items-center gap-3">
        <span className="inline-flex h-8 items-center px-3 rounded-full border bg-white text-slate-700 text-sm">
          {horarioDisponibleManana[0]}
        </span>
        <button
          type="button"
          onClick={() =>
            goToNewClass && goToNewClass({ fecha: manana, hora: horarioDisponibleManana[0] })
          }
          className="text-xs px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700"
          title="Agendar clase en este horario"
        >
          Agendar
        </button>
      </div>
    </div>
  )}
</div>


        <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
          <p className="text-sm text-green-800">Balance de la Semana</p>
          <p className={`text-2xl font-bold ${balanceSemana >= 0 ? 'text-[#34745B]' : 'text-red-900'}`}>
            {formatCurrency(balanceSemana)}
          </p>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-4">
        <Card title={<span className="text-[#34745B]">Agenda del D√≠a</span>}>
          {clasesHoy.length === 0 ? (
            <p className="text-sm text-slate-500">No hay clases programadas para hoy.</p>
          ) : (
            <ul className="space-y-2">
  {clasesHoy.map(c => {
    const nombres = (c.alumnoIds || [])
      .map(id => alumnoMap.get(id))
      .filter(Boolean)
      .join(', ') || 'Sin alumno';

    return (
      <li key={c.id} className="p-2 border-b flex justify-between items-center">
        <div>
          <p className="font-semibold text-slate-700 break-words">{c.hora} - {nombres}</p>
          <p className="text-xs text-slate-500">
            {c.tipo}{c.cancha ? ` en ${c.cancha}` : ''}
          </p>
        </div>
        {c.estado !== 'Programada' && (
          <span
            className={`px-2 py-0.5 rounded-full text-xs font-semibold ${
              c.estado === 'Realizada' ? 'bg-green-100 text-green-800' :
              c.estado === 'Ausente'    ? 'bg-orange-100 text-orange-800' :
              c.estado === 'Cancelada'  ? 'bg-red-100 text-red-800' : ''
            }`}
          >
            {c.estado}
          </span>
        )}
      </li>
    );
  })}
</ul>

          )}
        </Card>

        <Card title={<span className="text-[#34745B]">Agenda de Ma√±ana ¬∑ Contactos</span>}>
  {clasesManana.length === 0 ? (
    <p className="text-sm text-slate-500">No hay clases programadas para ma√±ana.</p>
  ) : (
    <ul className="space-y-2">
      {clasesManana.map(c => {
        const nombres = (c.alumnoIds || [])
          .map(id => alumnoMap.get(id))
          .filter(Boolean)
          .join(', ') || 'Sin alumno';

        return (
          <li key={c.id} className="p-2 border rounded-lg">
            <div className="flex justify-between items-center">
              <div>
                <p className="font-semibold text-slate-700 break-words">{c.hora} - {nombres}</p>
                <p className="text-xs text-slate-500">
                  {c.tipo}{c.cancha ? ` en ${c.cancha}` : ''}
                </p>
              </div>

              <div className="flex items-center gap-2">
                <span className="px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-800">
                  {c.estado}
                </span>
                <button
                  type="button"
                  onClick={() => {
                    const canchaTxt = c.cancha ? ` en ${c.cancha}` : "";
                    const def = `Hola! Te recuerdo tu clase ${c.tipo}${canchaTxt} el ${c.fecha} a las ${c.hora}.`;
                    setContactosMsg(def);
                    setContactosExpandId(contactosExpandId === c.id ? null : c.id);
                  }}
                  className="text-xs px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-50"
                >
                  Contactos
                </button>
              </div>
            </div>

                  {contactosExpandId === c.id && (
                    <div className="mt-3 p-3 bg-slate-50 rounded-lg border">
                      <div className="mb-3">
                        <label className="text-xs text-slate-500 block mb-1">Mensaje (editable)</label>
                        <textarea
                          value={contactosMsg}
                          onChange={(e)=>setContactosMsg(e.target.value)}
                          className="w-full border rounded-lg px-2 py-1 text-sm"
                          rows="2"
                        />
                      </div>

                      <table className="w-full text-sm">
                        <thead>
                          <tr className="text-slate-500">
                            <th className="text-left px-2 py-1">Alumno</th>
                            <th className="text-left px-2 py-1">Tel√©fono</th>
                            <th className="text-left px-2 py-1">Acci√≥n</th>
                          </tr>
                        </thead>
                        <tbody>
                          {(c.alumnoIds || []).filter(Boolean).map(id => {
                            const a = alumnoObjMap.get(id);
                            if (!a) return null;
                            const nombre = getNombreCompleto(a);
                            const telRaw = (a.telefono || a.contactoPadre || "").toString();
                            const digits = telRaw.replace(/\D/g, "");
                            const canchaTxt = c.cancha ? ` en ${c.cancha}` : "";
                            const base = `Hola! Te recuerdo tu clase ${c.tipo}${canchaTxt} el ${c.fecha} a las ${c.hora}.`;
                            const msg = contactosExpandId === c.id && contactosMsg ? contactosMsg : base;
                            const wa = `https://api.whatsapp.com/send?phone=${digits}&text=${encodeURIComponent(msg)}`;
                            return (
                              <tr key={id} className="border-t">
                                <td className="px-2 py-1">{nombre}</td>
                                <td className="px-2 py-1">{telRaw || '-'}</td>
                                <td className="px-2 py-1">
                                  <a className="text-emerald-700 underline" href={wa} target="_blank" rel="noopener">WhatsApp</a>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                </li>
        );
      })}
    </ul>
  )}
</Card>
      </div>

      <Card
        title={<span className="text-[#34745B]">Calendario Semanal</span>}
        right={
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                id="vista-compacta"
                checked={mostrarSoloHorarioLaboral}
                onChange={(e) => setMostrarSoloHorarioLaboral(e.target.checked)}
              />
              <label htmlFor="vista-compacta" className="text-slate-600">Mostrar solo horario laboral</label>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCurrentDate(prev => addDays(prev, -7))} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">‚Äπ Ant</button>
              <button onClick={() => setCurrentDate(new Date())} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">Hoy</button>
              <button onClick={() => setCurrentDate(prev => addDays(prev, 7))} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">Sig ‚Ä∫</button>
            </div>
          </div>
        }
      >
        <CalendarioSemanal
          week={weekDates}
          clases={(clases || []).filter(c => weekDates.includes(c.fecha))}
          alumnos={alumnos || []}                  
          onEdit={goToEditClass}
          horarioLaboral={horarioData}
          mostrarSoloHorarioLaboral={mostrarSoloHorarioLaboral}
        />
      </Card>
    </div>
  );
}


    function AlumnoForm({ initialData, onSubmit, onCancel, onRegisterMonthlyPayment, studentBeingEdited }) {
      const [form, setForm] = useState(initialData)

      const isMensual = form.plan === 'mensual';
      const canRegisterAbono = isMensual && Boolean(studentBeingEdited?.id);
      
      useEffect(() => {
        const t = form.tipo || "";
        let size = 1;
        if (/^\d+x$/.test(t)) size = parseInt(t);
        if (/^Indiv/.test(t)) size = 1;
        if (/^Dupla|2x/.test(t)) size = 2;
        if (/^Trio|3x/.test(t)) size = 3;
        if (/^Cuart|4x/.test(t)) size = 4;
        if (/Escuelita/i.test(t)) size = 4;
        const base = (form.alumnoIds && form.alumnoIds[0]) || "";
        const ids = Array.from({length: size}, (_, i) => (i===0 ? base : (form.alumnoIds && form.alumnoIds[i]) || ""));
        if (!form.alumnoIds || form.alumnoIds.length !== size) {
          setForm(prev => ({ ...prev, alumnoIds: ids }));
        }
      }, [form.tipo]);
    const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };
      const addHorario = () => setForm(f => ({ ...f, horarios: [...(f.horarios || []), { dia: "Lunes", hora: "18:00" }] }));
      const delHorario = (idx) => setForm(f => ({ ...f, horarios: f.horarios.filter((_, i) => i !== idx) }));
      const setHorario = (idx, key, val) => setForm(f => ({ ...f, horarios: f.horarios.map((h, i) => i === idx ? { ...h, [key]: val } : h) }));
      function handleSubmit(e) { e.preventDefault(); if (!form.nombre.trim()) return alert("Ingres√° un nombre"); onSubmit(form); }
      return (
        <form onSubmit={handleSubmit} className="grid md:grid-cols-6 gap-3">
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Nombre</label><input name="nombre" value={form.nombre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: Sof√≠a" required /></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Apellido</label><input name="apellido" value={form.apellido} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: P√©rez" /></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Tel√©fono</label><input name="telefono" value={form.telefono} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: 549381..." /></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Contacto Padre/Madre (Escuelita)</label><input name="contactoPadre" value={form.contactoPadre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Nombre y tel√©fono" /></div>
          <div><label className="text-sm text-slate-600">Deporte</label><select name="deporte" value={form.deporte} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{DEPORTES.map(d => <option key={d}>{d}</option>)}</select></div>
          <div><label className="text-sm text-slate-600">Estado</label><select name="estado" value={form.estado} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{ESTADOS_ALUMNO.map(e => <option key={e.value} value={e.value}>{e.label}</option>)}</select></div>
          {/* Plan de Pago + Frecuencia (si mensual) + Bot√≥n Registrar */}
<div className="md:col-span-6 grid grid-cols-1 md:grid-cols-[1fr_auto] items-end gap-3">
  {/* Columna izquierda: selects */}
  <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
    <div className="md:col-span-1">
      <label className="text-sm text-slate-600">Plan de Pago</label>
      <select
        name="plan"
        value={form.plan}
        onChange={handleChange}
        className="w-full border rounded-lg px-3 py-2"
      >
        {PLANES_PAGO.map(p => (
          <option key={p.value} value={p.value}>{p.label}</option>
        ))}
      </select>
    </div>

    {isMensual && (
      <div className="md:col-span-2">
        <label className="text-sm text-slate-600">Frecuencia</label>
        <select
          name="frecuencia"
          value={form.frecuencia}
          onChange={handleChange}
          className="w-full border rounded-lg px-3 py-2"
        >
          {FRECUENCIAS_MENSUALES.map(f => (
            <option key={f.value} value={f.value}>{f.label}</option>
          ))}
        </select>
      </div>
    )}
  </div>

  {/* Columna derecha: bot√≥n */}
  {isMensual && (
    <button
      type="button"
      disabled={!canRegisterAbono}
      onClick={() => onRegisterMonthlyPayment?.(studentBeingEdited)}
      title={
        canRegisterAbono
          ? 'Registrar pago de abono'
          : 'Guard√° el alumno para registrar su primer pago'
      }
      className={
        "inline-flex items-center justify-center gap-2 h-10 px-4 rounded-lg text-sm font-medium transition " +
        (canRegisterAbono
          ? "bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm"
          : "bg-white border border-slate-200 text-slate-400 cursor-not-allowed")
      }
    >
      üí≥ <span>Registrar pago</span>
    </button>
  )}
</div>

{/* Leyenda cuando el bot√≥n est√° deshabilitado */}
{isMensual && !canRegisterAbono && (
  <p className="md:col-span-6 text-xs text-slate-500 -mt-2">
    Guard√° el alumno para registrar su primer pago.
  </p>
)}

          <div className="md:col-span-6"><label className="text-sm text-slate-600">Horarios fijos</label><div className="grid gap-2">{(form.horarios || []).map((h, idx) => (<div key={idx} className="flex gap-2 items-center flex-wrap"><select value={h.dia} onChange={(e) => setHorario(idx, 'dia', e.target.value)} className="border rounded-lg px-3 py-2">{DIAS_SEMANA_NOMBRES.map(d => <option key={d}>{d}</option>)}</select><input type="time" value={h.hora} onChange={(e) => setHorario(idx, 'hora', e.target.value)} className="border rounded-lg px-3 py-2" /><button type="button" onClick={() => delHorario(idx)} className="px-2 py-2 rounded-lg border text-red-600 hover:bg-red-50">‚àí</button></div>))}<button type="button" onClick={addHorario} className="self-start px-3 py-1.5 rounded-lg border w-auto">+ Agregar horario</button></div></div>
          <div className="md:col-span-6"><label className="text-sm text-slate-600">Notas / Descripci√≥n</label><textarea name="notas" value={form.notas} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" rows={3} placeholder="Detalle particular del alumno" /></div>
          <div className="md:col-span-6 flex gap-2 justify-end"><button type="button" onClick={onCancel} className="px-3 py-2 rounded-lg border">Cancelar</button><button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">Guardar</button></div>
        </form>
      );
    }
function CuentaCorrienteAlumno({ user, clubId, alumno, perfil, desdeMes, hastaMes }) {
  const { abrirModalPago, Modal: ModalAbono } = useModalPagoAbono();
  const [lineas, setLineas] = React.useState([]);
  const [loading, setLoading] = React.useState(true);
  const [error, setError] = React.useState(null);

  const refetch = React.useCallback(async () => {
    try {
      setLoading(true);
      const { lineas } = await buildCuentaCorrienteMensual({
        user, clubId, alumno, perfil, desdeMes, hastaMes
      });
      setLineas(lineas);
      setError(null);
    } catch (e) {
      console.error(e);
      setError('No se pudo cargar la cuenta corriente.');
    } finally {
      setLoading(false);
    }
  }, [user, clubId, alumno, perfil, desdeMes, hastaMes]);

  React.useEffect(() => { refetch(); }, [refetch]);

  const pagarCuota = async (mes, monto) => {
    const ok = await abrirModalPago(alumno, mes, Number(monto || 0));
    if (ok) {
      // aseguro doc y acredito cuota
      const m = await ensureMensualidadParaAlumno({
        user, clubId, alumno, perfil, fechaRef: `${mes}-01`
      });
      await acreditarCuotaMensual({ user, clubId, alumno, mensualidad: m });
      await refetch();
    }
  };

  const pagarExcedente = async (mes) => {
    const monto = prompt(`Importe a registrar como pago de Excedente del mes ${mes}:`, "0");
    const val = Number(monto || 0);
    if (!isFinite(val) || val <= 0) return;
    await acreditarExcedenteMensual({ user, clubId, alumno, mes, monto: val, metodo: "Efectivo" });
    await refetch();
  };

  if (loading) return <div className="p-3 text-sm text-slate-500">Cargando cuenta corriente‚Ä¶</div>;
  if (error)   return <div className="p-3 text-sm text-red-600">{error}</div>;

  const saldoFinal = lineas.length ? lineas[lineas.length - 1].saldoAcumulado : 0;

  return (
    <div className="bg-white border border-slate-200 rounded-2xl p-4">
      <div className="flex items-center justify-between mb-3">
        <h3 className="font-semibold text-[#34745B]">
          Cuenta Corriente ‚Äî {getNombreCompleto(alumno)}
        </h3>
        <div className={`text-sm font-semibold ${saldoFinal >= 0 ? 'text-slate-700' : 'text-red-700'}`}>
          Saldo acumulado: {formatCurrency(saldoFinal)}
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="min-w-full text-sm">
          <thead className="text-left text-slate-600">
            <tr>
              <th className="py-2 pr-3">Mes</th>
              <th className="py-2 pr-3">Incl./Cons.</th>
              <th className="py-2 pr-3">Cuota</th>
              <th className="py-2 pr-3">Excedente</th>
              <th className="py-2 pr-3">Pagos cuota</th>
              <th className="py-2 pr-3">Pagos exced.</th>
              <th className="py-2 pr-3">Saldo Mes</th>
              <th className="py-2 pr-3">Saldo Acum.</th>
              <th className="py-2 pr-3">Acciones</th>
            </tr>
          </thead>
          <tbody className="align-top">
            {lineas.map(l => (
              <tr key={l.mes} className="border-t">
                <td className="py-2 pr-3 whitespace-nowrap">{l.mes}</td>
                <td className="py-2 pr-3">{l.incluidas}/{l.consumidas}</td>
                <td className="py-2 pr-3">{formatCurrency(l.cuota)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.excedente)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.pagCuota)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.pagExced)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.saldoMes)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.saldoAcumulado)}</td>
                <td className="py-2 pr-3">
                  <div className="flex gap-2">
                    <button
                      type="button"
                      onClick={() => pagarCuota(l.mes, l.cuota)}
                      className="px-2 py-1 rounded border text-xs bg-emerald-600 text-white hover:bg-emerald-700"
                    >
                      Pagar cuota
                    </button>
                    <button
                      type="button"
                      onClick={() => pagarExcedente(l.mes)}
                      className="px-2 py-1 rounded border text-xs bg-sky-600 text-white hover:bg-sky-700"
                    >
                      Pagar exced.
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Mont√° el modal UNA sola vez */}
      <ModalAbono />
    </div>
  );
}

    
function Alumnos({
  alumnos,
  onCreate, onUpdate, onDelete,
  onRegisterMonthlyPayment,
  clases, pagos,
  onRegistrarClase, onPagarPendiente, onEditarPago, onDeletePago,
  // üëá agregamos estas props para la cuenta corriente
  user,
  clubActivoId,
  perfil
}) {
  const [q, setQ] = useState("");
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);
  const [alumnoFicha, setAlumnoFicha] = useState(null);
  const emptyForm = {
    nombre: "", apellido: "", telefono: "", contactoPadre: "",
    deporte: "P√°del", estado: "activo", plan: "porClase",
    frecuencia: "1xSemana", notas: "", horarios: []
  };

  const [currentPage, setCurrentPage] = useState(1);
  const ITEMS_PER_PAGE = 10;

  // üëâ rango meses para la cuenta corriente (√∫ltimos 6 meses)
  const hastaMesCC = mesClave(new Date());
  const desdeMesCC = (() => {
    const d = new Date();
    d.setMonth(d.getMonth() - 5); // √∫ltimos 6 meses incl. el actual
    d.setDate(1);
    return mesClave(d);
  })();

  const sortedAlumnos = useMemo(() => {
    const qLower = q.trim().toLowerCase();
    const fil = (alumnos || []).filter(a => !qLower || getNombreCompleto(a).toLowerCase().includes(qLower));
    return fil.sort((a,b)=> getNombreCompleto(a).localeCompare(getNombreCompleto(b), "es", {sensitivity:"base"}));
  }, [alumnos, q]);

  const totalPages = Math.ceil(sortedAlumnos.length / ITEMS_PER_PAGE);

  const paginatedAlumnos = useMemo(() => {
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    return sortedAlumnos.slice(startIndex, startIndex + ITEMS_PER_PAGE);
  }, [sortedAlumnos, currentPage]);

  useEffect(() => { setCurrentPage(1); }, [q]);

  function openNew() {
    setEditing(null);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function openEdit(a) {
    setEditing(a);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function cancel() {
    setShowForm(false);
    setEditing(null);
  }

  async function submit(formData) {
    if (editing) {
      onUpdate({ ...formData, id: editing.id });
      cancel();
    } else {
      if (formData.plan === 'mensual') {
        try {
          const nuevoAlumno = await onCreate(formData);
          cancel();
          onRegisterMonthlyPayment(nuevoAlumno);
        } catch (error) {
          console.error("Error al guardar el alumno:", error);
          alert("Hubo un error al guardar el alumno.");
        }
      } else {
        onCreate(formData);
        cancel();
      }
    }
  }

  return (
    <>
      <div className="grid gap-4">
        <Card
          title={<span className="text-[#34745B]">{editing ? "Editar alumno" : "Nuevo alumno"}</span>}
          right={!showForm && (
            <button onClick={openNew} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">
              + Nuevo
            </button>
          )}
        >
          {showForm ? (
            <AlumnoForm
              initialData={editing ? { ...emptyForm, ...editing } : emptyForm}
              onSubmit={submit}
              onCancel={cancel}
              onRegisterMonthlyPayment={onRegisterMonthlyPayment}
              studentBeingEdited={editing}
            />
          ) : (
            <p className="text-sm text-slate-500">
              Hac√© clic en <b>+ Nuevo</b> para crear un alumno, o en el l√°piz para editar.
            </p>
          )}
        </Card>

        <Card
          title={<span className="text-[#34745B]">Listado de alumnos</span>}
          right={
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              placeholder="Buscar por nombre..."
              className="border rounded-xl px-3 py-1.5 text-sm"
            />
          }
        >
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="text-left text-slate-600">
                  <th className="p-2">Nombre Completo</th>
                  <th className="p-2">Tel√©fono</th>
                  <th className="p-2">Plan de Pago</th>
                  <th className="p-2">Estado</th>
                  <th className="p-2 text-right">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {paginatedAlumnos.length === 0 && (
                  <tr>
                    <td colSpan={5} className="text-center py-6 text-slate-400">
                      No se encontraron alumnos.
                    </td>
                  </tr>
                )}

                {paginatedAlumnos.map((a) => (
                  <tr key={a.id} className="border-t">
                    <td className="p-2 font-semibold">{getNombreCompleto(a)}</td>
                    <td className="p-2">
                      <div className="flex items-center gap-2">
                        <span>{a.telefono || "-"}</span>
                        {a.telefono && (
                          <a
                            href={waLink(a.telefono, a.nombre)}
                            target="_blank"
                            rel="noreferrer"
                            className="inline-flex items-center px-2 py-0.5 text-xs rounded-full border text-green-700 bg-green-50 hover:bg-green-100"
                          >
                            WhatsApp
                          </a>
                        )}
                      </div>
                    </td>
                    <td className="p-2">{a.plan === 'mensual' ? 'Mensual' : 'Por Clase'}</td>
                    <td className="p-2">
                      <span
                        className={`px-2 py-0.5 rounded-full text-xs ${
                          a.estado === 'espera'
                            ? 'bg-amber-100 text-amber-800'
                            : 'bg-emerald-100 text-emerald-800'
                        }`}
                      >
                        {a.estado === 'espera' ? 'Espera' : 'Activo'}
                      </span>
                    </td>
                    <td className="p-2 text-right">
                      <div className="inline-flex gap-2">
                        <button
                          type="button"
                          onClick={() => setAlumnoFicha(a)}
                          className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50"
                        >
                          üëÅÔ∏è Ver ficha
                        </button>
                        <button
                          type="button"
                          onClick={() => onRegistrarClase && onRegistrarClase(a.id)}
                          className="px-2 py-1 text-xs rounded-lg border bg-green-50 text-green-800 hover:bg-green-100"
                        >
                          üü¢ Registrar clase
                        </button>
                        <button
                          onClick={() => openEdit(a)}
                          className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50"
                        >
                          ‚úèÔ∏è Editar
                        </button>
                        <button
                          type="button"
                          onClick={() => onDelete(a.id)}
                          className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50"
                        >
                          üóëÔ∏è Eliminar
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {totalPages > 1 && (
            <div className="mt-4 flex justify-center items-center gap-2">
              <button
                onClick={() => setCurrentPage(p => Math.max(p - 1, 1))}
                disabled={currentPage === 1}
                className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50"
              >
                Anterior
              </button>
              <span className="text-sm text-slate-600">
                P√°gina {currentPage} de {totalPages}
              </span>
              <button
                onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))}
                disabled={currentPage === totalPages}
                className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50"
              >
                Siguiente
              </button>
            </div>
          )}
        </Card>

        {/* üëâ CUENTA CORRIENTE visible cuando abr√≠s la ficha de un alumno mensual */}
        {alumnoFicha && alumnoFicha.plan === 'mensual' && (
          <Card title={<span className="text-[#34745B]">Cuenta Corriente (Plan Mensual)</span>}>
            <CuentaCorrienteAlumno
              user={user}
              clubId={clubActivoId}
              alumno={alumnoFicha}
              perfil={perfil}
              desdeMes={desdeMesCC}
              hastaMes={hastaMesCC}
            />
          </Card>
        )}
      </div>

      {/* tu modal de ficha existente */}
      <AlumnoFichaModal
        alumno={alumnoFicha}
        clases={clases}
        pagos={pagos}
        alumnos={alumnos}
        onPagarPendiente={onPagarPendiente}
        onClose={() => setAlumnoFicha(null)}
        onRegistrarPago={onRegisterMonthlyPayment}
        onEditarPago={onEditarPago}
        onDeletePago={onDeletePago}
      />
    </>
  );
}
    
// ========= NUEVO PANEL RESUMEN (uso interno del modal) =========
function CuentaCorrientePanel({ alumno, clases = [], pagos = [], onRegistrarPago }) {
  // Frecuencias incluidas (solo para el resumen visual)
  const INCL = { "1xSemana": 4, "2xSemana": 8, "3xSemana": 12, "4xSemana": 16, "libre": 9999 };

  const hoy = new Date();
  const y = hoy.getFullYear();
  const m = String(hoy.getMonth() + 1).padStart(2, '0'); // 01..12
  const mesClave = `${y}-${m}`; // "YYYY-MM"

  // Clases realizadas este mes por el alumno
  const clasesMes = (clases || []).filter(c =>
    (c.fecha || '').startsWith(mesClave) &&
    (c.estado === 'Realizada') &&
    Array.isArray(c.alumnoIds) &&
    c.alumnoIds.includes(alumno.id)
  );
  const consumidas = clasesMes.length;

  // Incluidas seg√∫n frecuencia
  const incluidas = INCL[alumno.frecuencia] ?? 4;
  const restantes = Math.max(0, incluidas - consumidas);

  // Pagos mensuales del mes (detecta "Cuota", "Abono" o m√©todo "Mensual")
  const pagosMes = (pagos || []).filter(p =>
    p.alumnoId === alumno.id &&
    (p.fecha || '').startsWith(mesClave) &&
    (p.metodo === 'Mensual' || /cuota|abono/i.test(p.concepto || ''))
  );
  const montoPagadoMes = pagosMes.reduce((acc, p) => acc + Number(p.monto || 0), 0);
  const cuotaPagada = montoPagadoMes > 0;

  return (
    <div className="grid gap-4">
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div className="p-3 rounded-xl border bg-white">
          <p className="text-xs text-slate-500">Frecuencia</p>
          <p className="font-semibold">{alumno.frecuencia || '‚Äî'}</p>
        </div>
        <div className="p-3 rounded-xl border bg-white">
          <p className="text-xs text-slate-500">Incluidas este mes</p>
          <p className="font-semibold">{incluidas}</p>
        </div>
        <div className="p-3 rounded-xl border bg-white">
          <p className="text-xs text-slate-500">Consumidas</p>
          <p className="font-semibold">{consumidas}</p>
        </div>
        <div className="p-3 rounded-xl border bg-white">
          <p className="text-xs text-slate-500">Restantes</p>
          <p className="font-semibold">{restantes}</p>
        </div>
      </div>

      <div className="flex items-center justify-between p-3 rounded-xl border bg-slate-50">
        <div>
          <p className="text-sm text-slate-600">Cuota del mes ({mesClave})</p>
          <p className={`text-sm font-semibold ${cuotaPagada ? 'text-emerald-700' : 'text-red-700'}`}>
            {cuotaPagada ? `Pagada ¬∑ $${montoPagadoMes}` : 'Pendiente'}
          </p>
        </div>
        <button
          type="button"
          onClick={() => onRegistrarPago && onRegistrarPago(alumno)}
          className="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm"
        >
          Registrar cuota
        </button>
      </div>

      <div>
        <p className="text-sm font-semibold text-slate-700 mb-2">Clases realizadas este mes</p>
        {clasesMes.length === 0 ? (
          <p className="text-sm text-slate-500">Sin clases realizadas a√∫n en {mesClave}.</p>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="text-left text-slate-500">
                  <th className="p-2">Fecha</th>
                  <th className="p-2">Hora</th>
                  <th className="p-2">Tipo</th>
                  <th className="p-2">Estado</th>
                </tr>
              </thead>
              <tbody>
                {clasesMes.sort((a,b)=>a.hora.localeCompare(b.hora)).map(c => (
                  <tr key={c.id} className="border-t">
                    <td className="p-2">{c.fecha}</td>
                    <td className="p-2">{c.hora}</td>
                    <td className="p-2">{c.tipo}</td>
                    <td className="p-2">
                      <span className="px-2 py-0.5 rounded-full text-xs bg-emerald-100 text-emerald-800">
                        {c.estado}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

// ========= REEMPLAZ√Å TU AlumnoFichaModal POR ESTE =========
function AlumnoFichaModal({
  alumno,
  alumnos = [],
  clases = [],
  pagos = [],
  onClose,
  onPagarPendiente,
  onRegistrarPago,   // <- para registrar cuota mensual
  onEditarPago,
  onDeletePago
}) {
  const a = alumno;
  const [tab, setTab] = React.useState('clases');
  if (!a) return null;

  const nombreCompleto = `${a.apellido || ''} ${a.nombre || ''}`.trim() || 'Alumno';

  // Utilidades de listas existentes (no tocamos flujo por clase)
  const clasesDelAlumno = (clases || []).filter(c => Array.isArray(c.alumnoIds) && c.alumnoIds.includes(a.id));
  const pagosDelAlumno  = (pagos || []).filter(p => p.alumnoId === a.id);

  return (
    <Modal
      isOpen={!!alumno}
  title={`Ficha de ${getNombreCompleto(alumno)}`}
  size="7xl"        // o "wide" si prefer√≠s el ancho fijo de 1100px
  confirmText="Cerrar"
  onConfirm={onClose}
  onCancel={onClose}
    >
      <div className="grid md:grid-cols-[280px_1fr] gap-6">
        {/* Lado izquierdo: resumen */}
        <div className="p-4 rounded-2xl bg-slate-50 border">
          <h3 className="text-lg font-bold text-slate-800 mb-3">{nombreCompleto}</h3>
          <ul className="space-y-2 text-sm">
            <li>üè∏ Deporte: <strong>{a.deporte || '‚Äî'}</strong></li>
            <li>‚úÖ Estado: <strong>{a.estado === 'activo' ? 'Activo' : 'Espera'}</strong></li>
            <li>üí≥ Plan de Pago: <strong>{a.plan === 'mensual' ? 'Mensual' : 'Por clase'}</strong></li>
            {a.plan === 'mensual' && <li>üìÜ Frecuencia: <strong>{a.frecuencia || '‚Äî'}</strong></li>}
          </ul>
        </div>

        {/* Lado derecho: pesta√±as */}
        <div className="min-w-0">
          <div className="flex gap-6 border-b mb-4">
            <button
              className={`pb-2 -mb-px border-b-2 ${tab === 'clases' ? 'border-emerald-600 text-emerald-700' : 'border-transparent text-slate-500'}`}
              onClick={() => setTab('clases')}
            >
              Clases ({clasesDelAlumno.length})
            </button>
            <button
              className={`pb-2 -mb-px border-b-2 ${tab === 'pagos' ? 'border-emerald-600 text-emerald-700' : 'border-transparent text-slate-500'}`}
              onClick={() => setTab('pagos')}
            >
              Pagos ({pagosDelAlumno.length})
            </button>
            {a.plan === 'mensual' && (
              <button
                className={`pb-2 -mb-px border-b-2 ${tab === 'cuenta' ? 'border-emerald-600 text-emerald-700' : 'border-transparent text-slate-500'}`}
                onClick={() => setTab('cuenta')}
              >
                Cuenta Corriente
              </button>
            )}
          </div>

          {/* CONTENIDOS */}
          {tab === 'clases' && (
            <div>
              <h4 className="text-base font-semibold text-slate-700 mb-2">Historial de Clases</h4>
              {clasesDelAlumno.length === 0 ? (
                <p className="text-sm text-slate-500">Sin clases a√∫n.</p>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="text-left text-slate-500">
                        <th className="p-2">Fecha</th>
                        <th className="p-2">Tipo</th>
                        <th className="p-2">Precio</th>
                        <th className="p-2">Estado</th>
                        <th className="p-2 text-right">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      {clasesDelAlumno
                        .sort((a,b)=> (a.fecha+b.hora).localeCompare(b.fecha+a.hora))
                        .map(c => {
                          const totalPagado = (pagos || [])
                            .filter(p => p.claseId === c.id && p.alumnoId === a.id)
                            .reduce((acc,p)=> acc + Number(p.monto || 0), 0);
                          const precio = Number(c.precio || 0) / Math.max(1, (c.alumnoIds || []).length);
                          const pendiente = totalPagado < precio;

                          return (
                            <tr key={c.id} className="border-t">
                              <td className="p-2">{c.fecha}</td>
                              <td className="p-2">{c.tipo}</td>
                              <td className="p-2">${precio}</td>
                              <td className="p-2">
                                <span className={`px-2 py-0.5 rounded-full text-xs ${pendiente ? 'bg-rose-100 text-rose-800' : 'bg-emerald-100 text-emerald-800'}`}>
                                  {pendiente ? 'Pendiente' : 'Pagada'}
                                </span>
                              </td>
                              <td className="p-2 text-right">
                                {pendiente && (
                                  <button
                                    type="button"
                                    onClick={() => onPagarPendiente && onPagarPendiente(c, a.id)}
                                    className="px-2 py-1 text-xs rounded-lg border bg-green-50 text-green-800 hover:bg-green-100"
                                  >
                                    Registrar Pago
                                  </button>
                                )}
                              </td>
                            </tr>
                          );
                        })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {tab === 'pagos' && (
            <div>
              <h4 className="text-base font-semibold text-slate-700 mb-2">Pagos</h4>
              {pagosDelAlumno.length === 0 ? (
                <p className="text-sm text-slate-500">Sin pagos a√∫n.</p>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="text-left text-slate-500">
                        <th className="p-2">Fecha</th>
                        <th className="p-2">Concepto</th>
                        <th className="p-2">M√©todo</th>
                        <th className="p-2">Monto</th>
                        <th className="p-2 text-right">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      {pagosDelAlumno
                        .sort((a,b)=> (a.fecha || '').localeCompare(b.fecha || ''))
                        .map(p => (
                          <tr key={p.id || `${p.fecha}-${p.monto}-${Math.random()}`} className="border-t">
                            <td className="p-2">{p.fecha}</td>
                            <td className="p-2">{p.concepto}</td>
                            <td className="p-2">{p.metodo}</td>
                            <td className="p-2">${Number(p.monto || 0)}</td>
                            <td className="p-2 text-right">
                              {onEditarPago && (
                                <button
                                  type="button"
                                  onClick={() => onEditarPago(p)}
                                  className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50 mr-2"
                                >
                                  Editar
                                </button>
                              )}
                              {onDeletePago && (
                                <button
                                  type="button"
                                  onClick={() => onDeletePago(p.id)}
                                  className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50"
                                >
                                  Eliminar
                                </button>
                              )}
                            </td>
                          </tr>
                        ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {tab === 'cuenta' && a.plan === 'mensual' && (
  <CuentaCorrientePanel
    alumno={a}          // si en tu c√≥digo us√°s alumno/alumnoLive, dejalo igual
    clases={clases}
    pagos={pagos}
    onRegistrarPago={onRegistrarPago}
  />
)}
</div>   {/* cierra la columna derecha md:w-2/3 */}
</div>   {/* cierra la grid principal del modal */}
</Modal>
);
}

function CalendarioSemanal({
  week,
  clases,
  alumnos = [],
  onEdit,
  horarioLaboral,
  mostrarSoloHorarioLaboral
}) {
  // Colores por estado
  const getStatusColor = (status) => {
    switch (status) {
      case "Realizada": return "bg-emerald-100 border-emerald-300 text-emerald-800";
      case "Cancelada": return "bg-red-100 border-red-300 text-red-800";
      case "Ausente":   return "bg-amber-100 border-amber-300 text-amber-800";
      default:          return "bg-green-50 border-[#89C5B2] text-[#34745B]";
    }
  };

  // Mapa id -> alumno
  const alumnoMap = React.useMemo(
    () => Object.fromEntries((alumnos || []).map(a => [a.id, a])),
    [alumnos]
  );

  // Nombre corto
  function getNombreCorto(a) {
    if (!a) return "Sin alumno";
    const base = `${a.nombre || ""} ${a.apellido || ""}`.trim();
    return (base || "Sin alumno").split(" ")[0];
  }

  // Indexar clases por d√≠a/hora
  const clasesPorDiaHora = React.useMemo(() => {
    const map = {};
    (clases || []).forEach(clase => {
      const key = `${clase.fecha}_${clase.hora}`;
      if (!map[key]) map[key] = [];
      map[key].push(clase);
    });
    return map;
  }, [clases, alumnos]);

  // --- Helpers de calendario / horario ---
  const nombreDiaFromYMD = (ymd) => {
    const d = new Date(`${ymd}T00:00:00`);
    const idx = (d.getDay() + 6) % 7; // 0..6 => Lun..Dom
    return ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"][idx];
  };

  const horaToMin = (hhmm = "00:00") => {
    const [h, m] = String(hhmm).split(":").map(Number);
    return (h * 60) + (m || 0);
  };

  const incluyeHora = (bloque, hhmm) => {
    // Consideramos el slot [hh:mm, hh:mm+60)
    const t = horaToMin(hhmm);
    const desde = horaToMin(bloque?.desde || "08:00");
    const hasta = horaToMin(bloque?.hasta || "20:00");
    return t >= desde && (t + 60) <= hasta;
  };

  // Normalizamos horarioLaboral a un Map(diaNombre -> [{desde,hasta},...])
  const bloquesPorDia = React.useMemo(() => {
    const out = new Map(
      ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"].map(d => [d, []])
    );

    const raw = horarioLaboral || [];
    const lista = Array.isArray(raw) ? raw : (raw?.bloques || []);

    (lista || [])
      .filter(b => (b?.activo ?? true))
      .forEach(b => {
        const arr = out.get(b.dia) || [];
        arr.push({ desde: b.desde || "08:00", hasta: b.hasta || "20:00" });
        out.set(b.dia, arr);
      });

    return out;
  }, [horarioLaboral]);

  const esHoraLaboral = (dayYMD, hora) => {
    if (!mostrarSoloHorarioLaboral || !horarioLaboral) return true;

    const bloques = bloquesPorDia.get(nombreDiaFromYMD(dayYMD)) || [];
    if (bloques.length) return bloques.some(b => incluyeHora(b, hora));

    // Fallback si no hay bloques: rango general (si existiera)
    const inicio = horarioLaboral?.inicio || "08:00";
    const fin    = horarioLaboral?.fin    || "22:00";
    return hora >= inicio && hora < fin;
  };

  // Horas base (preferimos horarioLaboral.horas si existe)
  const horasBase = React.useMemo(() => {
    if (Array.isArray(horarioLaboral?.horas) && horarioLaboral.horas.length) return horarioLaboral.horas;
    const hs = [];
    for (let h = 8; h <= 22; h++) hs.push(String(h).padStart(2, "0") + ":00");
    return hs;
  }, [horarioLaboral]);

  // Si el toggle est√° activo, filtramos filas: solo horas con al menos un d√≠a laboral
  const horasParaMostrar = React.useMemo(() => {
  if (!mostrarSoloHorarioLaboral) return horasBase;
  return horasBase.filter(hora =>
    week.every(d => esHoraLaboral(d, hora))   // ‚Üê antes usaba .some(...)
  );
}, [mostrarSoloHorarioLaboral, horasBase, week, bloquesPorDia]);

  // ---------- RENDER ----------
  return (
    <div className="grid grid-cols-[80px_repeat(7,1fr)]">
      {/* Encabezado de d√≠as */}
      <div />
      {week.map(day => {
        const d = new Date(`${day}T00:00:00`);
        const dayIdx = (d.getDay() === 0 ? 6 : d.getDay() - 1); // 0..6 (Lun..Dom)
        const nombreDia = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"][dayIdx];
        return (
          <div key={`head-${day}`} className="text-center p-2">
            <div className="font-semibold">{nombreDia}</div>
            <div className="text-xs text-slate-500">{formatDate(day, 'dd/mm/yyyy')}</div>
          </div>
        );
      })}

      {/* Filas por hora */}
      {horasParaMostrar.map(hora => (
        <React.Fragment key={hora}>
          {/* Columna fija de horas */}
          <div className="bg-white text-center text-xs p-2 flex items-center justify-center">
            <span className="text-slate-500">{hora}</span>
          </div>

          {/* 7 columnas de d√≠as */}
          {week.map(day => {
            const laboral = esHoraLaboral(day, hora);
            const key = `${day}_${hora}`;
            const arr = clasesPorDiaHora[key] || [];

            return (
              <div
                key={`${day}-${hora}`}
                className={`${
                  laboral
                    ? "bg-white hover:bg-slate-50"
                    : (mostrarSoloHorarioLaboral
                        ? "bg-slate-100 opacity-50 pointer-events-none"
                        : "bg-slate-100")
                } min-h-[70px] p-1 border-t border-l border-slate-200`}
              >
                {arr.map(clase => (
                  <div
                    key={clase.id}
                    onClick={() => onEdit && onEdit(clase)}
                    className={`cursor-pointer border rounded-md px-2 py-1 mb-1 text-xs ${getStatusColor(clase.estado)}`}
                  >
                    <div className="font-semibold">
                      {clase.tipo || "Clase"} ¬∑ {
                        (clase.alumnoIds || [])
                          .filter(Boolean)
                          .map(id => getNombreCorto(alumnoMap[id]))
                          .join(", ") || "Sin alumno"
                      }
                    </div>
                    {clase.notas ? (
                      <div className="text-[11px] opacity-80 truncate">{clase.notas}</div>
                    ) : null}
                  </div>
                ))}
              </div>
            );
          })}
        </React.Fragment>
      ))}
    </div>
  );

  return (
    <div className="grid grid-cols-[80px_repeat(7,1fr)]">
      {/* encabezado de d√≠as */}
      <div />
      {week.map(day => (
        <div key={`head-${day}`} className="text-center font-semibold p-2">
          {day}
        </div>
      ))}

      {/* grilla por horas x d√≠as */}
      {horasParaMostrar.map(hora => (
        <React.Fragment key={hora}>
          {/* columna de horas */}
          <div className="bg-white text-center text-xs p-2 flex items-center justify-center">
            <span className="text-slate-500">{hora}</span>
          </div>

          {/* celdas por d√≠a */}
          {week.map(day => {
            const laboral = esHoraLaboral(day, hora);
            const key = `${day}_${hora}`;
            const arr = clasesPorDiaHora[key] || [];

            return (
              <div
                key={`${day}-${hora}`}
                className={`${laboral ? "bg-white hover:bg-slate-50" : "bg-slate-100"} min-h-[70px] p-1 border-t border-l border-slate-200`}
              >
                {arr.map(clase => (
                  <div
                    key={clase.id}
                    onClick={() => onEdit && onEdit(clase)}
                    className={`cursor-pointer border rounded-md px-2 py-1 mb-1 text-xs ${getStatusColor(clase.estado)}`}
                  >
                    <div className="font-semibold">
                      {clase.tipo || "Clase"} ¬∑ {
                        (clase.alumnoIds || [])
                          .filter(Boolean)
                          .map(id => getNombreCorto(alumnoMap[id]))
                          .join(", ") || "Sin alumno"
                      }
                    </div>
                    {clase.notas ? (
                      <div className="text-[11px] opacity-80 truncate">{clase.notas}</div>
                    ) : null}
                  </div>
                ))}
              </div>
            );
          })}
        </React.Fragment>
      ))}
    </div>
  );
}
    
function Clases({
  clases, alumnos, pagos, perfil,
  onCreate, onUpdate, onDelete, onPay,
  user,
  claseParaEditar, setClaseParaEditar,
  nuevoAlumnoId, setNuevoAlumnoId,
  prefillClase, onPrefillConsumed,
  grupos, clubActivoId
}) {
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);

  const emptyForm = {
    alumnoIds: [""],
    fecha: formatDate(new Date()),
    hora: "18:00",
    tipo: "Clase 1 persona",
    estado: "Programada",
    precio: (parseFloat((perfil.precios || {}).individual || 0)).toString(),
    notas: "",
    cancha: ""
  };
  const [form, setForm] = useState(emptyForm);

  const [grupoSeleccionadoId, setGrupoSeleccionadoId] = useState("");
  const handleSelectGrupo = (e) => {
    const id = e.target.value;
    setGrupoSeleccionadoId(id);
    const grupo = grupos.find(g => g.id === id);
    if (grupo) {
      setForm(prev => {
        const nuevosAlumnos = grupo.alumnoIds || [];
        const nuevoTipoClase = normalizarTipoClase(`Clase ${nuevosAlumnos.length} personas`);
        return {
          ...prev,
          alumnoIds: nuevosAlumnos,
          tipo: nuevoTipoClase,
          precio: computePrecioClase(nuevoTipoClase, nuevosAlumnos, perfil, alumnoMap)
        };
      });
      setFormStep(3);
    } else {
      setForm(prev => ({ ...prev, alumnoIds: [""] }));
      setFormStep(1);
    }
  };

  const { abrirModalPago, Modal: ModalAbono } = useModalPagoAbono();

  useEffect(() => {
    // ... tu c√≥digo existente
  }, [prefillClase]);

  useEffect(() => {
    if (prefillClase && prefillClase.fecha && prefillClase.hora) {
      setShowForm(true);
      setForm(prev => ({ ...prev, fecha: prefillClase.fecha, hora: prefillClase.hora }));
      onPrefillConsumed && onPrefillConsumed();
    }
  }, [prefillClase]);

  const [formStep, setFormStep] = useState(1);
  const [alumnoSearchQuery, setAlumnoSearchQuery] = useState("");
  const [isAlumnosListOpen, setIsAlumnosListOpen] = useState(false);
  const [filtroAlumno, setFiltroAlumno] = useState("");
  const [filtroEstado, setFiltroEstado] = useState("");
  const [filtroFechaDesde, setFiltroFechaDesde] = useState("");
  const [filtroFechaHasta, setFiltroFechaHasta] = useState("");

  useEffect(() => {
    if (!user) return;
    const unsub = db.collection('users').doc(user.uid).collection('grupos')
      .onSnapshot(snapshot => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // ojo: ac√° en tu versi√≥n us√°s setGrupos pero no existe state; dejo igual tu l√≥gica
        setGrupos(data);
      });
    return () => unsub();
  }, [user]);

  useEffect(() => {
    if (claseParaEditar) {
      openEdit(claseParaEditar);
      setClaseParaEditar(null);
    }
  }, [claseParaEditar]);

  useEffect(() => {
    if (nuevoAlumnoId) {
      setShowForm(true);
      const alumnoSeleccionado = alumnoMap.get(nuevoAlumnoId);
      if (!alumnoSeleccionado) {
        setNuevoAlumnoId(null);
        return;
      }
      setForm({
        ...emptyForm,
        alumnoIds: [nuevoAlumnoId],
      });
      if (alumnoSeleccionado.horarios && alumnoSeleccionado.horarios.length > 0) {
        setFormStep(2);
      } else {
        setFormStep(3);
      }
      setNuevoAlumnoId(null);
    }
  }, [nuevoAlumnoId, alumnoMap, emptyForm, setNuevoAlumnoId]);

  const alumnosActivos = useMemo(
    () => (alumnos || []).filter(a => a.estado === 'activo'),
    [alumnos]
  );
  const alumnoMap = useMemo(
    () => new Map((alumnos || []).map(a => [a.id, a])),
    [alumnos]
  );

  const alumnosFiltrados = useMemo(() => {
    if (!alumnoSearchQuery) return alumnosActivos;
    return alumnosActivos.filter(alumno =>
      getNombreCompleto(alumno).toLowerCase().includes(alumnoSearchQuery.toLowerCase())
    );
  }, [alumnoSearchQuery, alumnosActivos]);

  const pagosPorClase = useMemo(() => {
    const map = new Map();
    (pagos || []).forEach(p => {
      if (!map.has(p.claseId)) map.set(p.claseId, []);
      map.get(p.claseId).push(p);
    });
    return map;
  }, [pagos]);

  const clasesConDatos = useMemo(() => (clases || []).map(c => ({
    ...c,
    tipo: normalizarTipoClase(c.tipo),
    nombresAlumnos: (c.alumnoIds || []).map(id => getNombreCompleto(alumnoMap.get(id))).filter(Boolean).join(', '),
    pagos: pagosPorClase.get(c.id) || []
  })), [clases, alumnoMap, pagosPorClase]);

  const clasesFiltradas = useMemo(() => {
    return (clasesConDatos || []).filter(c => {
      const pasaFiltroAlumno = !filtroAlumno || (c.alumnoIds || []).includes(filtroAlumno);
      const pasaFiltroEstado = !filtroEstado || c.estado === filtroEstado;
      const pasaFiltroFechaDesde = !filtroFechaDesde || c.fecha >= filtroFechaDesde;
      const pasaFiltroFechaHasta = !filtroFechaHasta || c.fecha <= filtroFechaHasta;
      return pasaFiltroAlumno && pasaFiltroEstado && pasaFiltroFechaDesde && pasaFiltroFechaHasta;
    });
  }, [clasesConDatos, filtroAlumno, filtroEstado, filtroFechaDesde, filtroFechaHasta]);

  const canchasDisponibles = useMemo(
    () => (perfil.canchas || '').split('\n').filter(c => c.trim() !== ''),
    [perfil.canchas]
  );

  function handleFormChange(e) {
    const { name, value, type, checked } = e.target;
    const val = type === 'checkbox' ? checked : value;
    setForm(prev => {
      const newState = { ...prev, [name]: val };
      if (name === "tipo") {
        const canon = normalizarTipoClase(val);
        newState.tipo = canon;
        newState.precio = getPrecioSugerido(canon, perfil);
        const numAlumnos = TIPOS_CLASE_MAP[canon] || 1;
        newState.alumnoIds = Array.from({ length: numAlumnos }, (_, i) => prev.alumnoIds[i] || "");
      }
      return newState;
    });
  }

  function handleAlumnoChange(index, newId) {
    setForm(prev => {
      const newAlumnoIds = [...(prev.alumnoIds || [])];
      newAlumnoIds[index] = newId;
      const primerAlumno = alumnoMap.get(newAlumnoIds[0]);
      const esMensual = primerAlumno?.plan === 'mensual';
      const nuevoPrecio = esMensual ? "0" : getPrecioSugerido(prev.tipo, perfil);
      return { ...prev, alumnoIds: newAlumnoIds, precio: nuevoPrecio };
    });
    if (index === 0 && newId) {
      const alumnoSeleccionado = alumnoMap.get(newId);
      if (alumnoSeleccionado && alumnoSeleccionado.horarios && alumnoSeleccionado.horarios.length > 0) {
        setFormStep(2);
      } else {
        setFormStep(3);
      }
    }
  }

  function handleSelectAlumno(alumno) {
    setAlumnoSearchQuery(getNombreCompleto(alumno));
    setIsAlumnosListOpen(false);
    handleAlumnoChange(0, alumno.id);
  }

  const getNextDateForDay = (dayName) => {
    const today = new Date();
    const todayDayIndex = today.getDay(); // 0=domingo, 1=lunes, etc.
    const targetDayIndex = DIAS_SEMANA_NOMBRES.indexOf(dayName); // 0=lunes, 1=martes, etc.
    let correctedTargetIndex = targetDayIndex + 1;
    if (correctedTargetIndex === 7) correctedTargetIndex = 0;
    let dayDifference = correctedTargetIndex - todayDayIndex;
    if (dayDifference <= 0) dayDifference += 7;
    const resultDate = new Date(today.getTime());
    resultDate.setDate(today.getDate() + dayDifference);
    return resultDate;
  };

  function handleScheduleSelect(horario) {
    const proximaFecha = getNextDateForDay(horario.dia);
    setForm(prev => ({ ...prev, fecha: formatDate(proximaFecha), hora: horario.hora }));
    setFormStep(3);
  }

  function openNew() {
    setEditing(null);
    setForm(emptyForm);
    setAlumnoSearchQuery("");
    setFormStep(1);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function openEdit(c) {
    setEditing(c);
    setForm({ ...emptyForm, ...c, tipo: normalizarTipoClase(c.tipo) });
    setFormStep(3);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function cancel() {
    setShowForm(false);
    setEditing(null);
    setForm(emptyForm);
    setFormStep(1);
  }

  // ‚öôÔ∏è clubId razonable sin tocar props
  const clubId = perfil?.clubActivoId || perfil?.clubId || perfil?.clubActivo || null;

  // ‚úÖ submit con integraci√≥n de mensualidad (despu√©s de persistir)
  async function submit(e) {
  e.preventDefault();
  const validAlumnos = (form.alumnoIds || []).filter(Boolean);
  if (!validAlumnos.length) return alert("Seleccion√° al menos un alumno");

  const finalForm = { ...form, alumnoIds: validAlumnos };
  const shouldOpenPayModal = finalForm.estado === 'Realizada' || finalForm.estado === 'Ausente';

  const currentClubId = (typeof clubActivoId !== 'undefined' && clubActivoId) ? clubActivoId : clubId;

  let clasePersistida = null;

    if (editing) {
    const claseActualizada = { ...finalForm, id: editing.id };
    await onUpdate(claseActualizada);
    clasePersistida = claseActualizada;

      // üîó mensualidad tras actualizar (ya hay id)
      try {
      for (const alumnoId of (clasePersistida.alumnoIds || [])) {
        const alumno = (alumnos || []).find(a => a.id === alumnoId);
        if (alumno?.plan === 'mensual') {

          await exigirAbonoDelMesOAvisar({
            user,
            clubId: currentClubId,
            alumno,
            perfil,
            fechaClase: clasePersistida.fecha,
            abrirModalPago, // viene del hook useModalPagoAbono()
          });

            await cubrirClaseConMensualidadSiCorresponde({
              user,
              clubId: clubActivoId, 
              alumno,
              claseId: clasePersistida.id,
              fecha: clasePersistida.fecha,
              // Dej√° 0 para NO generar deuda extra al exceder;
              // si quisieras excedente, pon√© el precio por alumno real.
              precioPorAlumno: 0,
              perfil
            });
          }
        }
      } catch (err) {
      console.error('Error cubriendo con mensualidad:', err);
      }

      if (shouldOpenPayModal) onPay(clasePersistida);
  } else {
      // Crear
      let nueva = null;
      try {
        // Si onCreate devuelve la clase creada con id, lo usamos.
        await onCreate(finalForm);
      } catch (err) {
        console.error("Error al crear clase:", err);
      }

      if (nueva && nueva.id) {
        clasePersistida = nueva;

        // üîó mensualidad tras crear (si tenemos id)
        try {
          for (const alumnoId of (nueva.alumnoIds || [])) {
            const alumno = (alumnos || []).find(a => a.id === alumnoId);
            if (alumno?.plan === 'mensual') {
              await cubrirClaseConMensualidadSiCorresponde({
                user,
                clubId,
                alumno,
                claseId: nueva.id,
                fecha: nueva.fecha,
                precioPorAlumno: 0,
                perfil
              });
            }
          }
        } catch (err) {
          console.warn("Mensualidad (create) error:", err);
        }

        // En tu flujo original delegabas el modal de pago a otra capa post-create;
        // aqu√≠ respetamos eso (no abrimos modal en create).
      } else {
        // Si onCreate NO devuelve id, no podemos conectar con mensualidad aqu√≠.
        // Tu flujo de cobro por clase queda intacto.
      }
    }

    cancel();
  }

  const primerAlumnoId = form.alumnoIds ? form.alumnoIds[0] : null;
  const esMensual = alumnoMap.get(primerAlumnoId)?.plan === 'mensual';

  return (
    <div className="grid gap-4">
      <div className="flex justify-between items-center flex-wrap gap-2">
        <h2 className="text-xl font-bold text-[#34745B]">Clases</h2>
      </div>

      <Card
        title={<span className="text-[#34745B]">{editing ? "Editar clase" : "Nueva clase"}</span>}
        right={!showForm && (
          <button
            id="nueva-clase-btn"
            onClick={openNew}
            className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl"
          >
            + Nueva
          </button>
        )}
      >
        {showForm ? (
          <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
            {(formStep === 1) && (
              <div className="md:col-span-6 relative">
                <label className="text-sm text-slate-600 font-semibold">Selecciona Alumno/a</label>
                <input
                  type="text"
                  value={alumnoSearchQuery}
                  onChange={(e) => { setAlumnoSearchQuery(e.target.value); setIsAlumnosListOpen(true); }}
                  onFocus={() => setIsAlumnosListOpen(true)}
                  onBlur={() => setTimeout(() => setIsAlumnosListOpen(false), 200)}
                  placeholder="Escribe para buscar un alumno..."
                  className="w-full mt-1 border rounded-lg px-3 py-2"
                />
                {isAlumnosListOpen && (
                  <ul className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg">
                    {alumnosFiltrados.length > 0 ? (
                      alumnosFiltrados.map(alumno => (
                        <li
                          key={alumno.id}
                          onMouseDown={() => handleSelectAlumno(alumno)}
                          className="px-3 py-2 hover:bg-slate-100 cursor-pointer"
                        >
                          {getNombreCompleto(alumno)}
                        </li>
                      ))
                    ) : (
                      <li className="px-3 py-2 text-slate-500">No se encontraron alumnos.</li>
                    )}
                  </ul>
                )}
                <div className="mt-4">
                  <label className="block text-sm text-slate-600">O selecciona un grupo:</label>
                  <select
                    value={grupoSeleccionadoId}
                    onChange={handleSelectGrupo}
                    className="w-full mt-1 border rounded-lg px-3 py-2"
                  >
                    <option value="">-- Selecciona un grupo --</option>
                    {grupos.map(g => (
                      <option key={g.id} value={g.id}>{g.nombre}</option>
                    ))}
                  </select>
                </div>
              </div>
            )}

            {(formStep === 2 && alumnoMap.get(form.alumnoIds[0])) && (
              <div className="md:col-span-6">
                <p className="text-sm text-slate-700 mb-2">
                  <span className="font-bold">{getNombreCompleto(alumnoMap.get(form.alumnoIds[0]))}</span> tiene horarios fijos guardados.
                </p>
                <p className="text-sm font-semibold text-slate-600">
                  ¬øQuieres agendar una clase en uno de sus horarios habituales?
                </p>
                <div className="flex flex-wrap gap-2 my-3">
                  {(alumnoMap.get(form.alumnoIds[0]).horarios || []).map(horario => (
                    <button
                      type="button"
                      key={`${horario.dia}-${horario.hora}`}
                      onClick={() => handleScheduleSelect(horario)}
                      className="px-3 py-2 text-sm rounded-lg border bg-sky-50 text-sky-800 hover:bg-sky-100"
                    >
                      {horario.dia} {horario.hora}
                    </button>
                  ))}
                </div>
                <div className="border-t pt-3 mt-3">
                  <button
                    type="button"
                    onClick={() => setFormStep(3)}
                    className="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-slate-100"
                  >
                    O agendar una clase personalizada en otro horario
                  </button>
                </div>
              </div>
            )}

            {(formStep === 3) && (
              <>
                <div className="md:col-span-6 grid grid-cols-1 md:grid-cols-2 gap-3">
                  {(form.alumnoIds || [""]).map((alumnoId, index) => (
                    <div key={index}>
                      <label className="text-sm text-slate-600">Alumno {index + 1}</label>
                      <AlumnoSearchSelect
                        value={alumnoId}
                        onChange={(newId) => handleAlumnoChange(index, newId)}
                        alumnos={alumnosActivos}
                        excludeIds={(form.alumnoIds || []).filter((_, i) => i !== index)}
                        placeholder={`Buscar alumno ${index + 1}...`}
                        autoFocus={index === 0}
                      />
                    </div>
                  ))}
                </div>

                <div className="md:col-span-2">
                  <label className="text-sm text-slate-600">Ubicaci√≥n / Cancha</label>
                  <select name="cancha" value={form.cancha} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">
                    <option value="">Seleccionar cancha...</option>
                    {canchasDisponibles.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>

                <div>
                  <label className="text-sm text-slate-600">Fecha</label>
                  <input type="date" name="fecha" value={form.fecha} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" required />
                </div>

                <div>
                  <label className="text-sm text-slate-600">Hora</label>
                  <input type="time" name="hora" value={form.hora} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" required />
                </div>

                <div>
                  <label className="text-sm text-slate-600">Tipo de Clase</label>
                  <select name="tipo" value={form.tipo} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">
                    {TIPOS_CLASE.map(t => <option key={t}>{t}</option>)}
                  </select>
                </div>

                <div>
                  <label className="text-sm text-slate-600">Precio</label>
                  <input
                    type="number"
                    name="precio"
                    value={esMensual ? "0" : form.precio}
                    onChange={handleFormChange}
                    className={`w-full border rounded-lg px-3 py-2 ${esMensual ? 'bg-slate-100' : ''}`}
                    placeholder="0"
                    disabled={esMensual}
                  />
                </div>

                <div className="md:col-span-2">
                  <label className="text-sm text-slate-600">Estado</label>
                  <select name="estado" value={form.estado} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">
                    {ESTADOS_CLASE.map(e => <option key={e}>{e}</option>)}
                  </select>
                </div>

                <div className="md:col-span-6">
                  <label className="text-sm text-slate-600">Notas</label>
                  <textarea
                    name="notas"
                    value={form.notas}
                    onChange={handleFormChange}
                    className="w-full border rounded-lg px-3 py-2"
                    rows={2}
                    placeholder="Comentarios sobre la clase"
                  />
                </div>
              </>
            )}

            <div className="md:col-span-6 flex gap-2 justify-end">
              <button type="button" onClick={() => { cancel(); setFormStep(1); }} className="px-3 py-2 rounded-lg border">
                Cancelar
              </button>
              {editing && (
                <button type="button" onClick={() => onDelete(editing.id)} className="px-3 py-2 rounded-lg text-red-600 border border-red-300 hover:bg-red-50">
                  üóëÔ∏è Eliminar
                </button>
              )}
              {formStep === 3 && (
                <button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">
                  Guardar
                </button>
              )}
            </div>
          </form>
        ) : (
          <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nueva</b> para programar una clase.</p>
        )}
      </Card>

      <div>
        {(() => {
          const [semanaVisible, setSemanaVisible] = useState(getWeekStartDate(new Date()));
          const cambiarSemana = (dias) => setSemanaVisible(prev => addDays(prev, dias));
          const hoyString = formatDate(new Date());
          const semanaActualStrings = Array.from({ length: 7 }, (_, i) => formatDate(addDays(semanaVisible, i)));
          const clasesDeLaSemana = clasesFiltradas.filter(c => semanaActualStrings.includes(c.fecha));
          const clasesDeHoy = clasesFiltradas.filter(c => c.fecha === hoyString);
          const clasesAgrupadas = clasesDeLaSemana.reduce((acc, clase) => {
            if (clase.fecha !== hoyString) {
              if (!acc[clase.fecha]) acc[clase.fecha] = [];
              acc[clase.fecha].push(clase);
            }
            return acc;
          }, {});
          const diasLaborales = toArrayHorarioLaboral(perfil?.horarioLaboral).filter(d => d.activo).map(d => d.dia);

          const ClaseItem = ({ clase }) => {
  // üîπ calcular nombres SIEMPRE desde alumnoIds + alumnoMap (no usar clase.nombresAlumnos)
  const nombresAlumnos = (clase.alumnoIds || [])
    .filter(Boolean)
    .map(id => getNombreCompleto(alumnoMap.get(id)))
    .filter(Boolean)
    .join(', ');

  // Estado de pago (esto lo dej√°s igual)
  const totalPagado = (clase.pagos || []).reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
  const precioClase = parseFloat(clase.precio || 0);
  const estadoPago = totalPagado >= precioClase ? 'Pagada' : 'Pendiente';

  const estadoClaseBg =
    clase.estado === 'Realizada' ? 'bg-green-100 text-green-800' :
    clase.estado === 'Ausente'   ? 'bg-orange-100 text-orange-800' :
    clase.estado === 'Cancelada' ? 'bg-red-100 text-red-800' : '';

  const estadoPagoBg = estadoPago === 'Pagada'
    ? 'bg-green-100 text-green-800'
    : 'bg-red-100 text-red-800';

  return (
    <div
      onClick={() => openEdit(clase)}
      className="p-3 bg-white rounded-lg shadow-sm border border-slate-200 hover:border-blue-300 hover:shadow-md cursor-pointer transition-all"
    >
      <div className="flex justify-between items-center">
        <p className="font-semibold text-slate-800">
          {clase.hora} - {nombresAlumnos}
        </p>
        <div className="flex gap-2">
          {clase.estado !== 'Programada' && (
            <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${estadoClaseBg}`}>
              {clase.estado}
            </span>
          )}
          {clase.estado === 'Realizada' && (
            <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${estadoPagoBg}`}>
              {estadoPago}
            </span>
          )}
        </div>
      </div>
      <p className="text-xs text-slate-500 mt-1">
        {clase.tipo}{clase.cancha ? ` en ${clase.cancha}` : ''}
      </p>
    </div>
  );
};


          const DiaGroup = ({ fecha, clasesDelDia = [] }) => {
            const d = new Date(`${fecha}T00:00:00`);
            const diaNombre = DIAS_SEMANA_NOMBRES[d.getDay() === 0 ? 6 : d.getDay() - 1];
            const diaNumero = d.getDate();
            return (
              <div className="bg-slate-50 border border-slate-200 rounded-2xl p-4 min-h-[120px]">
                <h3 className="font-bold text-slate-700">{diaNombre}, {diaNumero}</h3>
                <div className="space-y-2 mt-2">
                  {clasesDelDia.length > 0 ? (
                    clasesDelDia.sort((a, b) => a.hora.localeCompare(b.hora)).map(c => <ClaseItem key={c.id} clase={c} />)
                  ) : (
                    <p className="text-sm text-slate-400 pt-2">No hay clases.</p>
                  )}
                </div>
              </div>
            );
          };

          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-xl font-bold text-[#34745B] mb-2">Agenda de Hoy</h2>
                <div className="bg-green-50 border border-green-200 rounded-2xl p-4">
                  {clasesDeHoy.length > 0 ? (
                    <div className="space-y-2">
                      {clasesDeHoy.sort((a, b) => a.hora.localeCompare(b.hora)).map(c => (
                        <ClaseItem key={c.id} clase={c} />
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-slate-500">No hay clases programadas para hoy.</p>
                  )}
                </div>
              </div>

              <div>
                <div className="flex justify-between items-center mb-3">
                  <button onClick={() => cambiarSemana(-7)} className="px-4 py-2 text-sm rounded-lg border bg-white shadow-sm hover:bg-slate-50">‚Äπ Sem. Anterior</button>
                  <p className="font-semibold text-slate-600">
                    Semana del {formatDate(semanaVisible, 'dd/mm')} al {formatDate(addDays(semanaVisible, 6), 'dd/mm')}
                  </p>
                  <button onClick={() => cambiarSemana(7)} className="px-4 py-2 text-sm rounded-lg border bg-white shadow-sm hover:bg-slate-50">Sem. Siguiente ‚Ä∫</button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {semanaActualStrings.map((fechaString, index) => {
                    const diaNombre = DIAS_SEMANA_NOMBRES[index];
                    if (diasLaborales.includes(diaNombre) && fechaString !== hoyString) {
                      return <DiaGroup key={fechaString} fecha={fechaString} clasesDelDia={clasesAgrupadas[fechaString] || []} />;
                    }
                    return null;
                  })}
                </div>
              </div>
            </div>
          );
        })()}
      </div>
      <ModalAbono />
    </div>
  );
}

       function Grupos({ alumnos, user }) {
      // --- Estados del Componente ---
      const [grupos, setGrupos] = useState([]);
      const [nombreGrupo, setNombreGrupo] = useState("");
      const [alumnosSeleccionados, setAlumnosSeleccionados] = useState([]);
      const [loading, setLoading] = useState(true);
      
      const gruposCollection = useMemo(() => {
        if (!user) return null;
        return db.collection('users').doc(user.uid).collection('grupos');
      }, [user]);

      useEffect(() => {
        if (!gruposCollection) return;
        
        const unsubscribe = gruposCollection.onSnapshot(snapshot => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setGrupos(data);
          setLoading(false);
        });

        return () => unsubscribe();
      }, [gruposCollection]);

      const handleCrearGrupo = () => {
        if (!nombreGrupo.trim() || alumnosSeleccionados.length === 0) {
          alert("Por favor, ingresa un nombre para el grupo y selecciona al menos un alumno.");
          return;
        }

        const nuevoGrupo = {
          nombre: nombreGrupo,
          alumnoIds: alumnosSeleccionados
        };

        gruposCollection.add(nuevoGrupo)
          .then(() => {
            setNombreGrupo("");
            setAlumnosSeleccionados([]);
            alert("¬°Grupo creado con √©xito!");
          })
          .catch(error => {
            console.error("Error al crear el grupo: ", error);
            alert("Hubo un error al crear el grupo.");
          });
      };
      
      const handleEliminarGrupo = (id) => {
          if(window.confirm("¬øEst√°s seguro de que quieres eliminar este grupo?")){
              gruposCollection.doc(id).delete().catch(error => {
                  console.error("Error al eliminar el grupo: ", error);
                  alert("Hubo un error al eliminar el grupo.");
              });
          }
      }

      return (
        <div className="grid md:grid-cols-2 gap-6">
          <div className="flex flex-col gap-6">
            <Card title={<span className="text-[#34745B]">Nuevo Grupo</span>}>
              <div className="grid gap-4">
                <div>
                    <label className="text-sm text-slate-600">Nombre del Grupo</label>
                    <input
                      type="text"
                      value={nombreGrupo}
                      onChange={(e) => setNombreGrupo(e.target.value)}
                      placeholder="Ej: Escuelita Martes y Jueves"
                      className="w-full mt-1 border rounded-lg px-3 py-2"
                    />
                </div>
                <div>
                    <label className="text-sm text-slate-600">Selecciona los Alumnos</label>
                    <p className="text-xs text-slate-500 mb-1">Mant√©n presionada la tecla Ctrl (o Cmd en Mac) para seleccionar varios.</p>
                    <select
                      multiple
                      value={alumnosSeleccionados}
                      onChange={(e) => {
                        const opciones = Array.from(e.target.selectedOptions, option => option.value);
                        setAlumnosSeleccionados(opciones);
                      }}
                      className="w-full border rounded-lg p-2 h-48"
                    >
                      {alumnos.map(a => (
                        <option key={a.id} value={a.id}>{getNombreCompleto(a)}</option>
                      ))}
                    </select>
                </div>
                <button 
                  onClick={handleCrearGrupo} 
                  className="px-4 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white font-semibold"
                >
                  Guardar Grupo
                </button>
              </div>
            </Card>
          </div>

          <div>
            <Card title={<span className="text-[#34745B]">Grupos Existentes</span>}>
                {loading && <p>Cargando grupos...</p>}
                {!loading && grupos.length === 0 && <p className="text-sm text-slate-500">A√∫n no has creado ning√∫n grupo.</p>}
                <ul className="space-y-3">
                    {grupos.map(grupo => {
                        const nombresAlumnos = grupo.alumnoIds.map(id => {
                            const alumno = alumnos.find(a => a.id === id);
                            return alumno ? getNombreCompleto(alumno) : 'Alumno no encontrado';
                        }).join(', ');

                        return (
                            <li key={grupo.id} className="p-3 border rounded-lg bg-slate-50">
                                <div className="flex justify-between items-center">
                                    <h4 className="font-bold text-slate-800">{grupo.nombre}</h4>
                                    <button onClick={() => handleEliminarGrupo(grupo.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                                <p className="text-xs text-slate-600 mt-1">
                                    <strong>Integrantes:</strong> {nombresAlumnos}
                                </p>
                            </li>
                        );
                    })}
                </ul>
            </Card>
          </div>
        </div>
      );
    }
    
    function Pagos({ pagos, alumnos, perfil, onPayMensual, clases, onEditarPago, onDeletePago }) {
        const [vista, setVista] = useState(perfil.metodoCobro === 'mensual' ? 'mensual' : 'historial');
        useEffect(() => {
            setVista(perfil.metodoCobro === 'mensual' ? 'mensual' : 'historial');
        }, [perfil.metodoCobro]);
        return (
            <div className="grid gap-4">
                <div className="flex items-center gap-2 bg-slate-100 p-1 rounded-xl">
                    <button onClick={() => setVista('historial')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'historial' ? 'bg-white shadow' : ''}`}>Historial de Pagos</button>
                    <button onClick={() => setVista('mensual')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'mensual' ? 'bg-white shadow' : ''}`}>Control Clases Mensuales</button>
                    <button onClick={() => setVista('deudas')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'deudas' ? 'bg-white shadow' : ''}`}>Control de Deudas</button>
                </div>
                {vista === 'historial' && <HistorialPagos pagos={pagos} alumnos={alumnos} clases={clases} onEditarPago={onEditarPago} onDeletePago={onDeletePago} />}
                {vista === 'mensual' && <ControlMensual pagos={pagos} alumnos={alumnos} perfil={perfil} onPay={onPayMensual} />}
                {vista === 'deudas' && <ControlDeudas pagos={pagos} alumnos={alumnos} clases={clases} perfil={perfil} />}
            </div>
        );
    }

function HistorialPagos({ pagos, alumnos, clases, onEditarPago, onDeletePago }) {
          const [periodo, setPeriodo] = useState("mes");
          const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
          const [metodo, setMetodo] = useState("Todos");
          const [currentPage, setCurrentPage] = useState(1);
          const ITEMS_PER_PAGE = 10;
          const alumnoMap = useMemo(() => new Map(alumnos.map(a => [a.id, getNombreCompleto(a)])), [alumnos]);

          const pagosConDatos = useMemo(() => {
              return pagos.map(pago => {
                  const nombreAlumno = alumnoMap.get(pago.alumnoId) || 'Alumno no encontrado';
                  const concepto = pago.concepto || `Pago de ${nombreAlumno}`;
                  return { ...pago, nombreAlumno, concepto };
              });
          }, [pagos, alumnoMap]);
          
          const pagosFiltrados = useMemo(() => {
            const ahora = new Date();
            return pagosConDatos.filter(p => {
                const fechaPago = new Date(p.fecha + "T00:00:00");
                if (periodo === 'dia') return formatDate(fechaPago) === formatDate(ahora);
                if (periodo === 'semana') return getWeekStartDate(fechaPago).getTime() === getWeekStartDate(ahora).getTime();
                if (periodo === 'a√±o') return fechaPago.getFullYear() === selectedYear;
                if (periodo === 'mes') {
                  // Corregimos la condici√≥n para que solo filtre por m√©todo si no es "Todos"
                  if (metodo !== 'Todos' && p.metodo !== metodo) return false;
                  return fechaPago.getMonth() === selectedMonth && fechaPago.getFullYear() === selectedYear;
                }
                if (metodo !== 'Todos' && p.metodo !== metodo) return false;
                return true;
              }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
          }, [pagosConDatos, periodo, selectedMonth, selectedYear, metodo]);
          
          const totales = useMemo(() => {
            return pagosFiltrados.reduce((acc, p) => {
              if (p.metodo !== 'Pendiente') {
                const monto = parseFloat(p.monto || 0) || 0;
                acc.total += monto;
                if (p.metodo === 'Efectivo') acc.efectivo += monto;
                if (p.metodo === 'Transferencia') acc.transferencia += monto;
              }
              return acc;
            }, { total: 0, efectivo: 0, transferencia: 0 });
          }, [pagosFiltrados]);

          const totalPages = Math.ceil(pagosFiltrados.length / ITEMS_PER_PAGE);
          const paginatedPagos = useMemo(() => {
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            return pagosFiltrados.slice(startIndex, startIndex + ITEMS_PER_PAGE);
          }, [pagosFiltrados, currentPage]);

          useEffect(() => {
            setCurrentPage(1);
          }, [periodo, selectedMonth, selectedYear, metodo]);

          const availableYears = useMemo(() => {
            const years = new Set(pagos.map(p => new Date(p.fecha).getFullYear()));
            if (!years.has(new Date().getFullYear())) {
                years.add(new Date().getFullYear());
            }
            return Array.from(years).sort((a, b) => b - a);
          }, [pagos]);

          const FilterButton = ({ onClick, isActive, children }) => (
            <button onClick={onClick} className={`px-3 py-1 rounded-md transition-colors text-sm ${isActive ? 'bg-white shadow text-slate-800 font-semibold' : 'text-slate-500 hover:text-slate-800'}`}>
                {children}
            </button>
          );

          return (
            <Card title={<span className="text-[#34745B]">Historial de Pagos</span>}>
                <div className="p-3 border rounded-xl bg-slate-50 mb-4 space-y-3">
                    <div className="flex flex-wrap items-center gap-4">
                        <div className="bg-slate-200 p-1 rounded-lg inline-flex items-center">
                            <FilterButton onClick={() => { setPeriodo('dia'); setSelectedYear(new Date().getFullYear()); }} isActive={periodo === 'dia'}>Hoy</FilterButton>
                            <FilterButton onClick={() => { setPeriodo('semana'); setSelectedYear(new Date().getFullYear()); }} isActive={periodo === 'semana'}>Semana</FilterButton>
                        </div>
                        <div className="bg-slate-200 p-1 rounded-lg flex-1 flex-wrap inline-flex items-center">
                             {MESES_NOMBRES.map((mes, index) => (
                                <FilterButton key={mes} onClick={() => { setPeriodo('mes'); setSelectedMonth(index); }} isActive={periodo === 'mes' && selectedMonth === index}>{mes}</FilterButton>
                            ))}
                        </div>
                        <div className="bg-slate-200 p-1 rounded-lg inline-flex items-center">
                           <select 
                             value={selectedYear} 
                             onChange={(e) => { setPeriodo('mes'); setSelectedYear(parseInt(e.target.value)); }}
                             className="bg-white px-2 py-1 rounded-md text-sm font-semibold shadow"
                           >
                            {availableYears.map(year => <option key={year} value={year}>{year}</option>)}
                           </select>
                        </div>
                    </div>
                     <div className="bg-slate-200 p-1 rounded-lg inline-flex items-center flex-wrap">
                        <FilterButton onClick={() => setMetodo('Todos')} isActive={metodo === 'Todos'}>Todos</FilterButton>
                        <FilterButton onClick={() => setMetodo('Efectivo')} isActive={metodo === 'Efectivo'}>Efectivo</FilterButton>
                        <FilterButton onClick={() => setMetodo('Transferencia')} isActive={metodo === 'Transferencia'}>Transferencia</FilterButton>
                        <FilterButton onClick={() => setMetodo('Pendiente')} isActive={metodo === 'Pendiente'}>Pendiente</FilterButton>
                        <FilterButton onClick={() => setMetodo('Mixto')} isActive={metodo === 'Mixto'}>Mixto</FilterButton>
                    </div>
                </div>

                <div className="grid md:grid-cols-3 gap-4 mb-4">
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl"><p className="text-sm text-green-800">Total Ingresado</p><p className="text-2xl font-bold text-[#34745B]">${totales.total.toFixed(2)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Total en Efectivo</p><p className="text-2xl font-bold text-slate-800">${totales.efectivo.toFixed(2)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Total por Transferencia</p><p className="text-2xl font-bold text-slate-800">${totales.transferencia.toFixed(2)}</p></div>
                </div>
                
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                        <tr className="text-left text-slate-600">
                            <th className="p-2">Fecha</th>
                            <th className="p-2">Alumno</th>
                            <th className="p-2">Concepto</th>
                            <th className="p-2">Monto</th>
                            <th className="p-2">M√©todo</th>
                            <th className="p-2 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                      {paginatedPagos.length === 0 && (<tr><td colSpan={6} className="text-center py-6 text-slate-400">No hay pagos que coincidan con los filtros</td></tr>)}
                      {paginatedPagos.map(p => (
                        <tr key={p.id} className="border-t">
                            <td className="p-2">{p.fecha}</td>
                            <td className="p-2 font-semibold">{p.nombreAlumno}</td>
                            <td className="p-2">{p.concepto}</td>
                            <td className="p-2">${parseFloat(p.monto || 0).toFixed(2)}</td>
                            <td className="p-2"><span className={`px-2 py-0.5 rounded-full text-xs ${p.metodo === 'Pendiente' ? 'bg-orange-100 text-orange-800' : p.metodo === 'Mixto' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>{p.metodo}</span></td>
                            <td className="p-2 text-right">
                                <div className="inline-flex gap-2">
                                    <button onClick={() => onEditarPago(p)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button>
                                    <button onClick={() => onDeletePago(p.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button>
                                </div>
                            </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {totalPages > 1 && (
                  <div className="mt-4 flex justify-center items-center gap-2">
                    <button onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} disabled={currentPage === 1} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">Anterior</button>
                    <span className="text-sm text-slate-600">P√°gina {currentPage} de {totalPages}</span>
                    <button onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} disabled={currentPage === totalPages} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">Siguiente</button>
                  </div>
                )}
            </Card>
          );
        }
    
    function ControlMensual({ pagos, alumnos, perfil, onPay }) {
        const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
        const alumnosMensuales = useMemo(() => alumnos.filter(a => a.plan === 'mensual' && a.estado === 'activo'), [alumnos]);
        
        const statusMensual = useMemo(() => {
            const anioActual = new Date().getFullYear();
            const pagosDelMes = pagos.filter(p => {
                const fechaPago = new Date(p.fecha);
                return p.concepto?.startsWith("Cuota Mensual") && fechaPago.getMonth() === selectedMonth && fechaPago.getFullYear() === anioActual;
            });

            return alumnosMensuales.map(alumno => {
                const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
                const pagosAlumno = pagosDelMes.filter(p => p.alumnoId === alumno.id);
                const totalPagado = pagosAlumno.reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
                
                let estado = 'Pendiente';
                if (totalPagado >= cuota) {
                    estado = 'Pagado';
                } else if (totalPagado > 0) {
                    estado = 'Parcial';
                }

                return { ...alumno, cuota, totalPagado, estado };
            });
        }, [alumnosMensuales, pagos, selectedMonth, perfil.preciosMensuales]);

        const getStatusColor = (status) => {
            if (status === 'Pagado') return 'bg-green-100 text-green-800';
            if (status === 'Parcial') return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        };
        const FilterButton = ({ onClick, isActive, children }) => (
            <button onClick={onClick} className={`px-3 py-1 rounded-md transition-colors text-sm ${isActive ? 'bg-white shadow text-slate-800 font-semibold' : 'text-slate-500 hover:text-slate-800'}`}>
                {children}
            </button>
        );
        return (
            <Card title="Control de Cuotas Mensuales">
                {/* --- Bloque de Filtros Redise√±ado --- */}
                <div className="p-3 border rounded-xl bg-slate-50 mb-4">
                    <div className="bg-slate-200 p-1 rounded-lg flex-1 flex-wrap inline-flex items-center w-full">
                         {MESES_NOMBRES.map((mes, index) => (
                            <FilterButton key={mes} onClick={() => setSelectedMonth(index)} isActive={selectedMonth === index}>{mes}</FilterButton>
                        ))}
                    </div>
                </div>

                <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Alumno</th><th className="p-2">Plan</th><th className="p-2">Monto Cuota</th><th className="p-2">Monto Pagado</th><th className="p-2">Estado</th><th className="p-2 text-right">Acciones</th></tr></thead><tbody>
                    {statusMensual.length === 0 && (<tr><td colSpan={6} className="text-center py-6 text-slate-400">No hay alumnos con plan mensual</td></tr>)}
                    {statusMensual.map(a => (
                        <tr key={a.id} className="border-t">
                            <td className="p-2">{`${a.apellido || ''} ${a.nombre || ''}`.trim()}</td>
                            <td className="p-2">{FRECUENCIAS_MENSUALES.find(f => f.value === a.frecuencia)?.label}</td>
                            <td className="p-2">${a.cuota.toFixed(2)}</td>
                            <td className="p-2">${a.totalPagado.toFixed(2)}</td>
                            <td className="p-2"><span className={`px-2 py-0.5 rounded-full text-xs ${getStatusColor(a.estado)}`}>{a.estado}</span></td>
                            <td className="p-2 text-right">
                                {a.estado !== 'Pagado' && <button onClick={() => onPay(a, selectedMonth)} className="px-2 py-1 text-xs rounded-lg border bg-emerald-500 text-white">Registrar Pago</button>}
                            </td>
                        </tr>
                    ))}
                </tbody></table></div>
            </Card>
        );
    }
    
    function ControlDeudas({ pagos, alumnos, clases, perfil }) {
        const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : '??';
        
        const deudas = useMemo(() => {
            const deudores = [];
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const anioActual = hoy.getFullYear();

            const alumnosMensuales = alumnos.filter(a => a.plan === 'mensual' && a.estado === 'activo');
            const pagosMensuales = pagos.filter(p => p.concepto?.startsWith("Cuota Mensual"));

            alumnosMensuales.forEach(alumno => {
                const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
                const pagosDelMes = pagosMensuales.filter(p => {
                    const fechaPago = new Date(p.fecha);
                    return p.alumnoId === alumno.id && fechaPago.getMonth() === mesActual && fechaPago.getFullYear() === anioActual;
                });
                const totalPagado = pagosDelMes.reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
                const deuda = cuota - totalPagado;
                if (deuda > 0) {
                    deudores.push({ id: alumno.id, nombre: getNombreCompleto(alumno), tipo: 'Cuota Mensual', monto: deuda });
                }
            });

            const pagosPorClaseMap = new Map();
            pagos.filter(p => p.claseId).forEach(p => {
                if(!pagosPorClaseMap.has(p.claseId)) pagosPorClaseMap.set(p.claseId, 0);
                pagosPorClaseMap.set(p.claseId, pagosPorClaseMap.get(p.claseId) + parseFloat(p.monto || 0));
            });
            const clasesRealizadas = clases.filter(c => c.estado === 'Realizada' && new Date(c.fecha) <= hoy);
            
            clasesRealizadas.forEach(clase => {
                const totalPagado = pagosPorClaseMap.get(clase.id) || 0;
                const precioClase = parseFloat(clase.precio || 0);

                if (totalPagado < precioClase) {
                    clase.alumnoIds.forEach(alumnoId => {
                        const alumno = alumnos.find(a => a.id === alumnoId);
                        if (alumno && alumno.plan === 'porClase') {
                            // Este c√°lculo asume que la deuda se reparte equitativamente.
                            const deudaClase = precioClase - totalPagado;
                            const monto = deudaClase / clase.alumnoIds.length;
                            deudores.push({ id: `${clase.id}-${alumno.id}`, nombre: getNombreCompleto(alumno), tipo: `Clase ${clase.fecha}`, monto });
                        }
                    });
                }
            });
            
            const deudasAgrupadas = deudores.reduce((acc, deuda) => {
                const alumnoId = alumnos.find(a => getNombreCompleto(a) === deuda.nombre)?.id || deuda.nombre;
                if(!acc[alumnoId]) acc[alumnoId] = { nombre: deuda.nombre, total: 0, detalles: [] };
                acc[alumnoId].total += deuda.monto;
                acc[alumnoId].detalles.push({ tipo: deuda.tipo, monto: deuda.monto });
                return acc;
            }, {});
            
            return Object.values(deudasAgrupadas).sort((a,b) => b.total - a.total);

        }, [pagos, alumnos, clases, perfil]);
        
        return (
            <Card title="Control de Deudas Pendientes (Mes Actual)">
                 <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Alumno</th><th className="p-2">Detalle de Deuda</th><th className="p-2 text-right">Total Adeudado</th></tr></thead><tbody>
                    {deudas.length === 0 && (<tr><td colSpan={3} className="text-center py-6 text-slate-400">No hay deudas pendientes registradas para el mes actual.</td></tr>)}
                    {deudas.map(deuda => (
                        <tr key={deuda.nombre} className="border-t">
                            <td className="p-2 font-semibold">{deuda.nombre}</td>
                            <td className="p-2">
                                <ul className="list-disc list-inside">
                                {deuda.detalles.map((d, i) => (
                                    <li key={i}>{d.tipo}: <span className="font-medium">${d.monto.toFixed(2)}</span></li>
                                ))}
                                </ul>
                            </td>
                            <td className="p-2 font-semibold text-red-600 text-right">${deuda.total.toFixed(2)}</td>
                        </tr>
                    ))}
                </tbody></table></div>
            </Card>
        );
    }

function Gastos({ gastos, onCreate, onUpdate, onDelete }) {
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const emptyForm = { fecha: formatDate(new Date()), concepto: "", monto: "", categoria: "Varios" };
      const [form, setForm] = useState(emptyForm);
      const [periodo, setPeriodo] = useState("mes");
      const [currentPage, setCurrentPage] = useState(1);
      const ITEMS_PER_PAGE = 10;

      const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };

      const gastosFiltrados = useMemo(() => {
        const ahora = new Date();
        const hoy = formatDate(ahora);
        const semanaInicio = formatDate(getWeekStartDate(ahora));
        const mesInicio = formatDate(new Date(ahora.getFullYear(), ahora.getMonth(), 1));
        const anioInicio = formatDate(new Date(ahora.getFullYear(), 0, 1));

        return gastos
          .filter(g => {
            if (periodo === 'dia' && g.fecha !== hoy) return false;
            if (periodo === 'semana' && g.fecha < semanaInicio) return false;
            if (periodo === 'mes' && g.fecha < mesInicio) return false;
            if (periodo === 'a√±o' && g.fecha < anioInicio) return false;
            return true;
          })
          .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      }, [gastos, periodo]);
      
      const totalGastos = useMemo(() => gastosFiltrados.reduce((acc, g) => acc + (parseFloat(g.monto || 0) || 0), 0), [gastosFiltrados]);

      const totalPages = Math.ceil(gastosFiltrados.length / ITEMS_PER_PAGE);
      const paginatedGastos = useMemo(() => {
          const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
          return gastosFiltrados.slice(startIndex, startIndex + ITEMS_PER_PAGE);
      }, [gastosFiltrados, currentPage]);

      useEffect(() => {
          setCurrentPage(1);
      }, [periodo]);

      function openNew() { setEditing(null); setForm(emptyForm); setShowForm(true); }
      function openEdit(g) { setEditing(g); setForm(g); setShowForm(true); }
      function cancel() { setShowForm(false); setEditing(null); setForm(emptyForm); }
      function submit(e) { e.preventDefault(); if (!form.concepto.trim() || !form.monto) return alert("Complet√° concepto y monto"); if (editing) { onUpdate({ ...form, id: editing.id }); } else { onCreate(form); } cancel(); }

      const PeriodoButton = ({ value, current, setter, children }) => (<button onClick={() => setter(value)} className={`px-3 py-1.5 text-sm rounded-lg ${current === value ? 'bg-[#34745B] text-white hover:bg-green-800' : 'bg-white border text-slate-700 hover:bg-slate-50'}`}>{children}</button>);
      
      return (
        <div className="grid gap-4">
          <Card 
            title={<span className="text-[#34745B]">{editing ? "Editar gasto" : "Nuevo gasto"}</span>} 
            right={!showForm && <button onClick={openNew} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">+ Nuevo</button>}
          >
            {showForm ? (
                <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
                    <div className="md:col-span-3"><label className="text-sm text-slate-600">Fecha</label><input type="date" name="fecha" value={form.fecha} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                    <div className="md:col-span-3"><label className="text-sm text-slate-600">Concepto</label><input type="text" name="concepto" value={form.concepto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: Alquiler de cancha" required /></div>
                    <div className="md:col-span-3"><label className="text-sm text-slate-600">Monto</label><input type="number" name="monto" value={form.monto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: 1500" required /></div>
                    <div className="md:col-span-3"><label className="text-sm text-slate-600">Categor√≠a</label><select name="categoria" value={form.categoria} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{CATEGORIAS_GASTOS.map(c => <option key={c}>{c}</option>)}</select></div>
                    <div className="md:col-span-6 flex gap-2 justify-end"><button type="button" onClick={cancel} className="px-3 py-2 rounded-lg border">Cancelar</button><button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">Guardar</button></div>
                </form>
            ) : ( <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nuevo</b> para registrar un gasto.</p> )}
          </Card>
          
          <Card title={<span className="text-[#34745B]">Control de Gastos</span>}>
            <div className="flex flex-wrap items-center gap-2 mb-4">
              <PeriodoButton value="dia" current={periodo} setter={setPeriodo}>Hoy</PeriodoButton>
              <PeriodoButton value="semana" current={periodo} setter={setPeriodo}>Semana</PeriodoButton>
              <PeriodoButton value="mes" current={periodo} setter={setPeriodo}>Mes</PeriodoButton>
              <PeriodoButton value="a√±o" current={periodo} setter={setPeriodo}>A√±o</PeriodoButton>
            </div>
            <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl mb-4"><p className="text-sm text-slate-600">Total de Gastos</p><p className="text-2xl font-bold text-slate-800">${totalGastos.toFixed(2)}</p></div>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-slate-600"><th className="p-2">Fecha</th><th className="p-2">Concepto</th><th className="p-2">Monto</th><th className="p-2">Categor√≠a</th><th className="p-2 text-right">Acciones</th></tr></thead>
                <tbody>
                  {paginatedGastos.length === 0 && (<tr><td colSpan={5} className="text-center py-6 text-slate-400">No hay gastos en este per√≠odo</td></tr>)}
                  {paginatedGastos.map(g => (<tr key={g.id} className="border-t"><td className="p-2">{g.fecha}</td><td className="p-2">{g.concepto}</td><td className="p-2">${g.monto}</td><td className="p-2">{g.categoria}</td><td className="p-2 text-right"><div className="inline-flex gap-2"><button onClick={() => openEdit(g)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button><button type="button" onClick={() => onDelete(g.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button></div></td></tr>))}
                </tbody>
              </table>
            </div>
            {totalPages > 1 && (
              <div className="mt-4 flex justify-center items-center gap-2">
                <button onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} disabled={currentPage === 1} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">Anterior</button>
                <span className="text-sm text-slate-600">P√°gina {currentPage} de {totalPages}</span>
                <button onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} disabled={currentPage === totalPages} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">Siguiente</button>
              </div>
            )}
          </Card>
        </div>
      );
    }
    
    function GraficoBarras({ data }) {
      const maxValue = useMemo(() => Math.max(...data.map(d => d.value), 1), [data]);
      return (
        <div className="bg-slate-50 rounded-xl p-4 h-64 flex justify-around items-end gap-4">
          {data.map(item => (
            <div key={item.label} className="flex-1 flex flex-col items-center gap-2">
              <div className="text-sm font-semibold text-slate-700">${item.value.toFixed(2)}</div>
              <div className={`w-full rounded-t-lg ${item.color}`} style={{ height: `${(item.value / maxValue) * 80}%` }} title={`${item.label}: $${item.value.toFixed(2)}`}></div>
              <div className="text-xs font-medium text-slate-600">{item.label}</div>
            </div>
          ))}
        </div>
      );
    }
    
function Reportes({ pagos, gastos, alumnos, clases, clubActivoId, clubes, perfil }) {
      const [periodo, setPeriodo] = useState("dia"); // Inicia por defecto en "Hoy"
      const [mesSeleccionado, setMesSeleccionado] = useState(formatDate(new Date()).slice(0, 7));
      const [fechaSeleccionada, setFechaSeleccionada] = useState(formatDate(new Date()));

      const filterByPeriod = useMemo(() => {
        return (item) => {
            const ahora = new Date();
            const itemDate = new Date(`${item.fecha}T00:00:00`);
            
            if (periodo === 'dia') return formatDate(itemDate) === formatDate(ahora);
            if (periodo === 'customDay') return formatDate(itemDate) === fechaSeleccionada;
            if (periodo === 'semana') return getWeekStartDate(itemDate).getTime() === getWeekStartDate(ahora).getTime();
            if (periodo === 'customMonth' && mesSeleccionado) {
                const [year, month] = mesSeleccionado.split('-');
                return itemDate.getFullYear() === parseInt(year) && (itemDate.getMonth() + 1) === parseInt(month);
            }
            if(periodo === 'mes') {
                return itemDate.getMonth() === ahora.getMonth() && itemDate.getFullYear() === ahora.getFullYear();
            }
            return false;
        };
      }, [periodo, mesSeleccionado, fechaSeleccionada]);

      const [pagosFiltrados, gastosFiltrados, clasesFiltradas] = useMemo(() => {
        const pagosF = pagos.filter(p => p.metodo !== 'Pendiente').filter(filterByPeriod);
        const gastosF = gastos.filter(filterByPeriod);
        const clasesF = clases.filter(c => c.estado === 'Realizada').filter(filterByPeriod);
        return [pagosF, gastosF, clasesF];
      }, [pagos, gastos, clases, filterByPeriod]);
      
      const totales = useMemo(() => {
        const totalIngresos = pagosFiltrados.reduce((acc, p) => acc + (parseFloat(p.monto) || 0), 0);
        const totalGastos = gastosFiltrados.reduce((acc, g) => acc + (parseFloat(g.monto) || 0), 0);
        return { ingresos: totalIngresos, gastos: totalGastos, balance: totalIngresos - totalGastos };
      }, [pagosFiltrados, gastosFiltrados]);
      
      const distribucionIngresos = useMemo(() => {
        const clubActivo = clubActivoId ? clubes.find(c => c.id === clubActivoId) : null;
        const porcentajeProfesor = clubActivo ? (clubActivo.reparto.coach || 0) / 100 : 1;
        const porcentajeClub = clubActivo ? (clubActivo.reparto.club || 0) / 100 : 0;
        const ingresosDeClases = pagosFiltrados
            .filter(p => p.claseId)
            .reduce((acc, p) => acc + (parseFloat(p.monto) || 0), 0);
        return {
            nombreLugar: clubActivo ? clubActivo.nombre : "Independiente",
            repartoTexto: clubActivo ? `${clubActivo.reparto.coach}% / ${clubActivo.reparto.club}%` : "100% Profesor",
            gananciaProfesor: ingresosDeClases * porcentajeProfesor,
            gananciaClub: ingresosDeClases * porcentajeClub,
            hayReparto: !!clubActivo
        };
      }, [pagosFiltrados, clubActivoId, clubes]);

const resumenClasesMes = useMemo(() => {
  const conteoPorTipo = clasesFiltradas.reduce((acc, clase) => {
    const tipoCanonico = normalizarTipoClase(clase.tipo || 'Clase 1 persona');
    const precio = parseFloat(clase.precio || 0);
    if (!acc[tipoCanonico]) {
      acc[tipoCanonico] = { cantidad: 0, valorTotal: 0 };
    }
    acc[tipoCanonico].cantidad += 1;
    acc[tipoCanonico].valorTotal += precio;
    return acc;
  }, {});

  return {
    totalClases: clasesFiltradas.length,
    valorTotalGeneral: clasesFiltradas.reduce((acc, c) => acc + parseFloat(c.precio || 0), 0),
    detalle: Object.entries(conteoPorTipo).sort((a, b) => b[1].cantidad - a[1].cantidad)
  };
}, [clasesFiltradas]);

      const PeriodoButton = ({ value, children }) => (
        <button 
            onClick={() => setPeriodo(value)} 
            className={`px-3 py-1.5 text-sm rounded-lg ${periodo === value ? 'bg-[#34745B] text-white hover:bg-green-800' : 'bg-white border text-slate-700 hover:bg-slate-50'}`}
        >
            {children}
        </button>
      );

      const handleExportToPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const nombreProfesor = `${perfil.nombre || ''} ${perfil.apellido || ''}`.trim();
        const nombreLugar = distribucionIngresos.nombreLugar;
        let periodoTexto = "";
        if (periodo === 'dia') periodoTexto = `el d√≠a de hoy (${formatDate(new Date(), 'dd/mm')})`;
        else if (periodo === 'customDay') periodoTexto = `el d√≠a ${formatDate(new Date(fechaSeleccionada + 'T00:00:00'), 'dd/mm')}`;
        else if (periodo === 'semana') periodoTexto = `la semana actual`;
        else if (periodo === 'mes') periodoTexto = `el mes actual`;
        else if (periodo === 'customMonth' && mesSeleccionado) {
            const [year, month] = mesSeleccionado.split('-');
            periodoTexto = `el mes de ${MESES_NOMBRES[parseInt(month) - 1]} de ${year}`;
        }
        let finalY = 20;
        doc.setFontSize(18);
        doc.text("Reporte de Actividad", 14, finalY);
        finalY += 10;
        doc.setFontSize(11);
        doc.text(`Profesor/a: ${nombreProfesor}`, 14, finalY);
        finalY += 6;
        doc.text(`Lugar de Trabajo: ${nombreLugar}`, 14, finalY);
        finalY += 6;
        doc.text(`Per√≠odo del Reporte: ${periodoTexto}`, 14, finalY);
        finalY += 10;
        doc.setFontSize(14);
        doc.text("Resumen de Clases Realizadas", 14, finalY);
        finalY += 8;
        doc.setFontSize(11);
        doc.text(`Total de Clases: ${resumenClasesMes.totalClases}`, 14, finalY);
        doc.text(`Valor Bruto Generado: $${resumenClasesMes.valorTotalGeneral.toFixed(2)}`, 100, finalY);
        finalY += 6;
        const tableHead = [['Tipo de Clase', 'Cantidad', 'Valor Generado']];
        const tableBody = resumenClasesMes.detalle.map(([tipo, data]) => [
            TIPOS_CLASE_NOMBRES[tipo] || tipo,
            data.cantidad,
            `$${data.valorTotal.toFixed(2)}`
        ]);
        doc.autoTable({ head: tableHead, body: tableBody, startY: finalY, theme: 'grid' });
        finalY = doc.autoTable.previous.finalY + 12;
        doc.setFontSize(14);
        doc.text("Distribuci√≥n de Ingresos", 14, finalY);
        finalY += 8;
        doc.setFontSize(11);
        doc.text(`(Reparto: ${distribucionIngresos.repartoTexto})`, 14, finalY);
        finalY += 8;
        doc.text(`Ganancia Neta Profesor: $${distribucionIngresos.gananciaProfesor.toFixed(2)}`, 14, finalY);
        finalY += 8;
        doc.text(`Ganancia Club: $${distribucionIngresos.gananciaClub.toFixed(2)}`, 14, finalY);
        doc.save(`Reporte_${nombreLugar.replace(/ /g, '_')}_${periodo === 'customDay' ? fechaSeleccionada : mesSeleccionado}.pdf`);
      };
      
      return (
        <div className="grid gap-6">
          <Card title={<span className="text-[#34745B]">Reportes Financieros y Operativos</span>}>
            <div className="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4">
              <div className="flex items-center gap-2">
                <PeriodoButton value="dia">Hoy</PeriodoButton>
                <PeriodoButton value="semana">Esta Semana</PeriodoButton>
                <PeriodoButton value="mes">Este Mes</PeriodoButton>
              </div>
              <div className="flex items-center gap-2">
                <label htmlFor="fecha-reporte" className="text-sm text-slate-600">Ver d√≠a:</label>
                <input
                    type="date"
                    id="fecha-reporte"
                    value={fechaSeleccionada}
                    onChange={(e) => {
                        setFechaSeleccionada(e.target.value);
                        setPeriodo('customDay');
                    }}
                    className="border rounded-lg px-3 py-1.5 text-sm"
                />
              </div>
              <div className="flex items-center gap-2">
                <label htmlFor="mes-reporte" className="text-sm text-slate-600">Ver mes:</label>
                <input
                    type="month"
                    id="mes-reporte"
                    value={mesSeleccionado}
                    onChange={(e) => {
                        setMesSeleccionado(e.target.value);
                        setPeriodo('customMonth');
                    }}
                    className="border rounded-lg px-3 py-1.5 text-sm"
                />
              </div>
              <div className="flex-grow text-right">
                <button 
                  onClick={handleExportToPDF} 
                  className="px-4 py-2 text-sm rounded-lg bg-white border border-[#34745B] text-[#34745B] hover:bg-green-50 font-semibold"
                >
                  Descargar PDF
                </button>
              </div>
            </div>
            
            <div className="p-4 border rounded-xl bg-slate-50">
                <h3 className="text-lg font-semibold text-[#4A4A4A] mb-3">Resumen Financiero General</h3>
                <div className="grid md:grid-cols-3 gap-4">
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl"><p className="text-sm text-green-800">Total Ingresos</p><p className="text-2xl font-bold text-[#34745B]">{formatCurrency(totales.ingresos)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Total Gastos</p><p className="text-2xl font-bold text-slate-800">{formatCurrency(totales.gastos)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Balance Neto</p><p className={`text-2xl font-bold ${totales.balance >= 0 ? 'text-slate-800' : 'text-red-900'}`}>{formatCurrency(totales.balance)}</p></div>
                </div>
            </div>

            <div className="p-4 border rounded-xl bg-slate-50 mt-4">
                <div className="mb-3">
                    <h3 className="text-lg font-semibold text-[#4A4A4A]">Distribuci√≥n de Ingresos por Clases</h3>
                    <p className="text-sm text-slate-500">Resultados para: <span className="font-bold">{distribucionIngresos.nombreLugar}</span> (Reparto: {distribucionIngresos.repartoTexto})</p>
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl"><p className="text-sm text-green-800">Ganancia Neta Profesor</p><p className="text-2xl font-bold text-[#34745B]">{formatCurrency(distribucionIngresos.gananciaProfesor)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Ganancia Club</p><p className="text-2xl font-bold text-slate-800">{formatCurrency(distribucionIngresos.gananciaClub)}</p></div>
                </div>
                {!distribucionIngresos.hayReparto && <p className="text-xs text-slate-400 mt-2">En modo independiente, todos los ingresos de clases se consideran ganancia del profesor.</p>}
            </div>

            <div className="p-4 border rounded-xl bg-slate-50 mt-4">
                <h3 className="text-lg font-semibold text-[#4A4A4A]">Resumen de Clases Realizadas</h3>
                <p className="text-sm text-slate-500">Resultados para el per√≠odo seleccionado</p>
                {resumenClasesMes.totalClases > 0 ? (
                    <div className="mt-3">
                        <div className="flex items-center justify-between border-b pb-2 mb-2">
                            <div>
                                <p className="text-slate-600">Total de Clases</p>
                                <p className="text-3xl font-bold text-[#34745B]">{resumenClasesMes.totalClases}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-slate-600">Valor Generado por Clases</p>
                                <p className="text-3xl font-bold text-[#34745B]">{formatCurrency(resumenClasesMes.valorTotalGeneral)}</p>
                            </div>
                        </div>
                        <ul className="text-sm text-slate-700 mt-2 space-y-2">
                            {resumenClasesMes.detalle.map(([tipo, data]) => (
                                <li key={tipo} className="flex justify-between items-center bg-white p-2 rounded-md">
                                    <span>
                                        <strong>{data.cantidad}</strong> {data.cantidad > 1 ? 'clases' : 'clase'} de <strong>{labelSinClase(tipo)}</strong>
                                    </span>
                                    <span className="font-semibold text-slate-800">
                                        {formatCurrency(data.valorTotal)}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    </div>
                ) : (
                    <p className="text-sm text-slate-500 mt-4">No se encontraron clases realizadas en este per√≠odo.</p>
                )}
            </div>
          </Card>
        </div>
      );
    }
    // Pega esta nueva funci√≥n en tu archivo

function GestionClubes({ user }) {
  const [clubes, setClubes] = useState([]);
  const [activoId, setActivoId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [form, setForm] = useState({
    nombre: "",
    modalidadPrincipal: "por_clase",
    ubicaciones: [],
    reparto: { coach: 60, club: 40 },
    preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0 },
    preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0 },
    horarioLaboral: { bloques: [] }
  });

  const clubsCollection = useMemo(() => {
    if (!user) return null;
    return db.collection('users').doc(user.uid).collection('clubs');
  }, [user]);

  // Cargar clubes + seleccionar primero
  useEffect(() => {
    if (!clubsCollection) return;
    setLoading(true);
    const unsubscribe = clubsCollection.onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setClubes(data);
      if (!activoId && data.length) setActivoId(data[0].id);
      setLoading(false);
    });
    return () => unsubscribe();
  }, [clubsCollection]);

  // Cargar datos del club activo al form
  useEffect(() => {
    if (!activoId || !clubsCollection) return;
    const unsub = clubsCollection.doc(activoId).onSnapshot(doc => {
      const d = doc.data() || {};
      setForm({
        nombre: d.nombre || "",
        modalidadPrincipal: d.modalidadPrincipal || "por_clase",
        ubicaciones: d.ubicaciones || [],
        reparto: d.reparto || { coach: 60, club: 40 },
        preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0, ...(d.preciosClase||{}) },
        preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0, ...(d.preciosMensuales||{}) },
        horarioLaboral: d.horarioLaboral || { bloques: [] },
      });
    });
    return () => unsub();
  }, [activoId, clubsCollection]);

  async function crearClub() {
    if (!clubsCollection) return;
    const base = {
      nombre: "Nuevo Club",
      modalidadPrincipal: "por_clase",
      ubicaciones: [],
      reparto: { coach: 60, club: 40 },
      preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0 },
      preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0 },
      horarioLaboral: { bloques: [] },
      createdAt: new Date().toISOString()
    };
    const ref = await clubsCollection.add(base);
    setActivoId(ref.id);
  }

  async function eliminarClub(id) {
    if (!clubsCollection || !id) return;
    if (!confirm("¬øEliminar este club? Esta acci√≥n no se puede deshacer.")) return;
    await clubsCollection.doc(id).delete();
    if (activoId === id) {
      const rest = clubes.filter(c => c.id !== id);
      setActivoId(rest[0]?.id || null);
    }
  }

  async function guardarClub() {
    if (!clubsCollection || !activoId) return;
    const pct = Number(form.reparto.coach||0) + Number(form.reparto.club||0);
    if (pct !== 100) {
      alert("El reparto debe sumar 100%");
      return;
    }
    await clubsCollection.doc(activoId).set({ ...form, updatedAt: new Date().toISOString() }, { merge: true });
    alert("Configuraci√≥n del club guardada");
  }

  // UI helpers
  const dias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
  const setField = (k, v) => setForm(f => ({ ...f, [k]: v }));
  function addUbicacion() { setField('ubicaciones', [...(form.ubicaciones||[]), ""]); }
  function updUbicacion(i, val) { const u=[...(form.ubicaciones||[])]; u[i]=val; setField('ubicaciones', u); }
  function delUbicacion(i) { const u=[...(form.ubicaciones||[])]; u.splice(i,1); setField('ubicaciones', u); }
  function addBloque() { setField('horarioLaboral', { bloques: [ ...(form.horarioLaboral?.bloques||[]), { dia:"Lunes", desde:"08:00", hasta:"12:00" } ]}); }
  function updBloque(i, patch) { const b=[...(form.horarioLaboral?.bloques||[])]; b[i]={...b[i], ...patch}; setField('horarioLaboral', { bloques: b }); }
  function delBloque(i) { const b=[...(form.horarioLaboral?.bloques||[])]; b.splice(i,1); setField('horarioLaboral', { bloques: b }); }

  if (loading) return <div className="text-sm opacity-70">Cargando clubes‚Ä¶</div>;

  return (
    <div className="space-y-6">
      {/* Selector + Acciones */}
      <div className="flex flex-wrap items-center gap-2">
        <select className="border rounded-xl px-3 py-2" value={activoId || ""} onChange={e=>setActivoId(e.target.value)}>
          {clubes.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}
        </select>
        <button className="px-3 py-2 rounded-xl border" onClick={crearClub}>Nuevo club</button>
        {activoId && <button className="px-3 py-2 rounded-xl border text-red-600" onClick={()=>eliminarClub(activoId)}>Eliminar</button>}
        <div className="grow" />
        <button className="px-3 py-2 rounded-xl bg-black text-white" onClick={guardarClub}>Guardar cambios</button>
      </div>

      {/* --- NUEVA ESTRUCTURA HORIZONTAL --- */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* Columna Izquierda de Configuraci√≥n */}
        <div className="space-y-4 p-4 border rounded-2xl bg-white">
          <h3 className="font-semibold">Configuraci√≥n General</h3>
          <label className="block text-sm">Nombre del Club</label>
          <input className="w-full border rounded-xl px-3 py-2" value={form.nombre} onChange={e=>setField('nombre', e.target.value)} />
          <label className="block text-sm mt-3">Modalidad de Cobro Principal</label>
          <select className="w-full border rounded-xl px-3 py-2" value={form.modalidadPrincipal} onChange={e=>setField('modalidadPrincipal', e.target.value)}>
            <option value="por_clase">Por Clase</option>
            <option value="mensual">Mensual</option>
          </select>
          <div className="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label className="block text-sm">Reparto % (Coach)</label>
              <input type="number" className="w-full border rounded-xl px-3 py-2" value={form.reparto.coach} onChange={e=>setField('reparto', { coach:Number(e.target.value)||0, club: Number(form.reparto.club||0) })} />
            </div>
            <div>
              <label className="block text-sm">Reparto % (Club)</label>
              <input type="number" className="w-full border rounded-xl px-3 py-2" value={form.reparto.club} onChange={e=>setField('reparto', { coach:Number(form.reparto.coach||0), club: Number(e.target.value)||0 })} />
            </div>
            <div className="col-span-2 text-xs opacity-70">Debe sumar 100%. Actual: {(Number(form.reparto.coach||0)+Number(form.reparto.club||0))}%</div>
          </div>
          <div className="mt-3">
            <label className="block text-sm">Canchas / Ubicaciones</label>
            <div className="space-y-2">
              {(form.ubicaciones||[]).map((u,i)=>(<div key={i} className="flex gap-2"><input className="flex-1 border rounded-xl px-3 py-2" value={u} onChange={e=>updUbicacion(i, e.target.value)} /><button className="px-3 py-2 rounded-xl border" onClick={()=>delUbicacion(i)}>Quitar</button></div>))}
            </div>
            <button className="mt-2 px-3 py-2 rounded-xl border" onClick={addUbicacion}>Agregar ubicaci√≥n</button>
          </div>
        </div>

        {/* Columna Derecha de Horarios */}
        <div className="space-y-4 p-4 border rounded-2xl bg-white">
          <h3 className="font-semibold">Horario Laboral (por club)</h3>
          <div className="space-y-2 max-h-80 overflow-y-auto pr-2">
            {(form.horarioLaboral?.bloques||[]).map((b,i)=>(
              <div key={i} className="grid grid-cols-4 gap-2 items-center">
                <select className="border rounded-xl px-3 py-2" value={b.dia} onChange={e=>updBloque(i,{dia:e.target.value})}>{dias.map(d=><option key={d} value={d}>{d}</option>)}</select>
                <input type="time" className="border rounded-xl px-3 py-2" value={b.desde} onChange={e=>updBloque(i,{desde:e.target.value})}/>
                <input type="time" className="border rounded-xl px-3 py-2" value={b.hasta} onChange={e=>updBloque(i,{hasta:e.target.value})}/>
                <button className="px-3 py-2 rounded-xl border" onClick={()=>delBloque(i)}>Quitar</button>
              </div>
            ))}
          </div>
          <button className="px-3 py-2 rounded-xl border" onClick={addBloque}>Agregar bloque</button>
        </div>
      </div>

      {/* --- SECCI√ìN DE PRECIOS A TODO LO ANCHO --- */}
      <div className="grid md:grid-cols-2 gap-6">
        <div className="p-4 border rounded-2xl space-y-3 bg-white">
          <h3 className="font-semibold">Precios por Clase</h3>
          {["individual","dupla","trio","cuarteto","escuelita"].map(k=>(<div key={k} className="grid grid-cols-2 gap-2 items-center"><div className="text-sm capitalize">{k}</div><input type="number" className="border rounded-xl px-3 py-2" value={form.preciosClase[k] ?? 0} onChange={e=>setField('preciosClase', { ...(form.preciosClase||{}), [k]: Number(e.target.value)||0 })} /></div>))}
        </div>
        <div className="p-4 border rounded-2xl space-y-3 bg-white">
          <h3 className="font-semibold">Precios Mensuales</h3>
          {[["1xSemana","1 vez por semana"],["2xSemana","2 veces por semana"],["3xSemana","3 veces por semana"],["libre","Libre"]].map(([key,label])=>(<div key={key} className="grid grid-cols-2 gap-2 items-center"><div className="text-sm">{label}</div><input type="number" className="border rounded-xl px-3 py-2" value={form.preciosMensuales[key] ?? 0} onChange={e=>setField('preciosMensuales', { ...(form.preciosMensuales||{}), [key]: Number(e.target.value)||0 })} /></div>))}
        </div>
      </div>
    </div>
  );
}
    
function Perfil({ perfil, alumnos, clases, pagos, gastos, grupos, onUpdate, user, setToast, getCollection, perfilCrud }) {
      const fileInputRef = React.useRef(null);
      const [form, setForm] = useState(perfil);
      const [pinInput, setPinInput] = useState({ newPin: "", confirmPin: "" });
      const [plantillas, setPlantillas] = useState([]);
      const [plantillaSeleccionada, setPlantillaSeleccionada] = useState(null);
      const [mensajePersonalizado, setMensajePersonalizado] = useState("");
      const [destinatarios, setDestinatarios] = useState([]);
      const [busquedaAlumno, setBusquedaAlumno] = useState("");
      const [listaBusquedaAbierta, setListaBusquedaAbierta] = useState(false);
      const [editingPlantilla, setEditingPlantilla] = useState(null);
      const { abrirModalPago, Modal: ModalAbono } = useModalPagoAbono();

      useEffect(() => {
        if (!user) return;
        const plantillasCollection = db.collection('users').doc(user.uid).collection('plantillas');
        const unsubscribe = plantillasCollection.onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPlantillas(data);
        });
        return () => unsubscribe();
      }, [user]);

      useEffect(() => {
        const defaultPerfil = initialState.perfil;
        setForm({
            ...defaultPerfil, ...perfil,
            datosBancarios: { ...defaultPerfil.datosBancarios, ...(perfil.datosBancarios || {}) },
            horarioLaboral: perfil.horarioLaboral || defaultPerfil.horarioLaboral,
            modoTrabajo: 'Club',
        });
      }, [perfil]);

      const handleSetPin = () => {
        if (pinInput.newPin.length !== 3 || !/^\d{3}$/.test(pinInput.newPin)) {
          alert("El PIN debe ser exactamente de 3 n√∫meros.");
          return;
        }
        if (pinInput.newPin !== pinInput.confirmPin) {
          alert("Los PINs no coinciden. Por favor, vuelve a intentarlo.");
          return;
        }
        setForm(prev => ({ ...prev, pin: pinInput.newPin }));
        setToast("PIN actualizado. No olvides guardar los cambios.");
        setPinInput({ newPin: "", confirmPin: "" });
      };

      const handlePinInputChange = (e) => {
        const { name, value } = e.target;
        if (/^\d*$/.test(value) && value.length <= 3) {
            setPinInput(prev => ({...prev, [name]: value}));
        }
      };

      const sanitizeDataForJSON = (data) => {
        const replacer = (key, value) => (value === undefined ? null : value);
        return JSON.parse(JSON.stringify(data, replacer));
      };
      
      const handleExportData = () => {
        try {
          let dataToExport = {
              alumnos: alumnos,
              clases: clases,
              pagos: pagos,
              gastos: gastos,
              perfil: perfil,
              grupos: grupos || []
          };
          const cleanData = sanitizeDataForJSON(dataToExport);
          const jsonString = JSON.stringify(cleanData, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `coachex_backup_${formatDate(new Date())}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          setToast("Datos exportados con √©xito.");
        } catch (error) {
          console.error("Error al exportar los datos:", error);
          setToast("Hubo un error al generar el archivo de respaldo.");
        }
      };
      
      const handleImportData = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                const confirmImport = window.confirm(
                    "¬°ATENCI√ìN! ¬øEst√°s seguro de que quieres importar estos datos?\n\n" + 
                    "TODOS TUS DATOS ACTUALES en el modo de trabajo seleccionado SER√ÅN BORRADOS Y REEMPLAZADOS.\n\n" +
                    "Esta acci√≥n no se puede deshacer."
                );
                if (confirmImport) {
                    setToast("Iniciando importaci√≥n... por favor espera.");
                    const collectionsToProcess = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos'];
                    for (const collectionName of collectionsToProcess) {
                        const collectionRef = getCollection(collectionName);
                        const snapshot = await collectionRef.get();
                        if (snapshot.docs.length > 0) {
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                        }
                    }
                    setToast("Datos anteriores eliminados, escribiendo nuevos datos...");
                    for (const collectionName of collectionsToProcess) {
                        if (importedData[collectionName] && importedData[collectionName].length > 0) {
                            const collectionRef = getCollection(collectionName);
                            const batch = db.batch();
                            importedData[collectionName].forEach(item => {
                                const docRef = item.id ? collectionRef.doc(item.id) : collectionRef.doc();
                                batch.set(docRef, item);
                            });
                            await batch.commit();
                        }
                    }
                    if (importedData.perfil) {
                        await perfilCrud.update(importedData.perfil);
                    }
                    setToast("¬°Importaci√≥n completada con √©xito! La p√°gina se recargar√°.");
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } catch (error) {
                alert("El archivo seleccionado no es un JSON v√°lido o est√° corrupto.");
                console.error("Error al importar datos:", error);
                setToast("Error durante la importaci√≥n.");
            } finally {
                event.target.value = null;
            }
        };
        reader.readAsText(file);
      };

      const handleWipeData = async () => {
        const confirmText = "BORRAR";
        const confirmation = prompt(`Esta acci√≥n es irreversible y borrar√° todos los alumnos, clases, pagos y gastos del modo de trabajo actual.\n\nPara confirmar, escribe "${confirmText}" en el campo de abajo.`);
        if (confirmation === confirmText) {
            setToast("Eliminando todos los datos... por favor espera.");
            try {
                const collectionsToWipe = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos'];
                for (const collectionName of collectionsToWipe) {
                    const collectionRef = getCollection(collectionName);
                    const snapshot = await collectionRef.get();
                    if (snapshot.docs.length > 0) {
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                        await batch.commit();
                    }
                }
                setToast("¬°Todos los datos han sido eliminados! La p√°gina se recargar√°.");
                setTimeout(() => { window.location.reload(); }, 2000);
            } catch (error) {
                console.error("Error al borrar los datos:", error);
                setToast("Hubo un error al eliminar los datos.");
            }
        } else {
            if (confirmation !== null) {
                alert("La confirmaci√≥n no es correcta. La acci√≥n ha sido cancelada.");
            }
        }
      };
      
      const alumnosFiltrados = useMemo(() => {
        if (!busquedaAlumno) return [];
        return (alumnos || []).filter(a => a.estado === 'activo' && getNombreCompleto(a).toLowerCase().includes(busquedaAlumno.toLowerCase()));
      }, [busquedaAlumno, alumnos]);

      const handleAgregarDestinatario = (alumno) => {
        if (!destinatarios.find(d => d.id === alumno.id)) {
          setDestinatarios([...destinatarios, alumno]);
        }
        setBusquedaAlumno("");
        setListaBusquedaAbierta(false);
      };
      const handleQuitarDestinatario = (alumnoId) => {
        setDestinatarios(destinatarios.filter(d => d.id !== alumnoId));
      };
      const handleSendMessage = (destinatario) => {
        if (!mensajePersonalizado.trim()) {
            alert("El mensaje no puede estar vac√≠o.");
            return;
        }
        const mensajeFinal = mensajePersonalizado.replace(/{nombre_alumno}/g, destinatario.nombre || '');
        const link = waLink(destinatario.telefono, mensajeFinal);
        if (link) {
            window.open(link, '_blank');
        } else {
            alert(`No se pudo generar el enlace para ${getNombreCompleto(destinatario)} porque no tiene un n√∫mero de tel√©fono v√°lido.`);
        }
      };
      const handleSavePlantilla = (plantillaData) => {
        const plantillasCollection = db.collection('users').doc(user.uid).collection('plantillas');
        if (plantillaData.id) {
          const { id, ...data } = plantillaData;
          plantillasCollection.doc(id).update(data).then(() => { setToast("Plantilla actualizada"); setEditingPlantilla(null); });
        } else {
          plantillasCollection.add(plantillaData).then(() => { setToast("Plantilla creada"); setEditingPlantilla(null); });
        }
      };
      const handleDeletePlantilla = () => {
        if (plantillaSeleccionada && window.confirm(`¬øEst√°s seguro de que quieres eliminar la plantilla "${plantillaSeleccionada.titulo}"?`)) {
            db.collection('users').doc(user.uid).collection('plantillas').doc(plantillaSeleccionada.id).delete().then(() => {
                setToast("Plantilla eliminada");
                setPlantillaSeleccionada(null);
                setMensajePersonalizado("");
            });
        }
      };
      const handleChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, [name]: value }));
      };
      const handlePrecioChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, precios: { ...prev.precios, [name]: value } }));
      };
      const handlePrecioMensualChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, preciosMensuales: { ...prev.preciosMensuales, [name]: value } }));
      };
      const handleDatosBancariosChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, datosBancarios: { ...prev.datosBancarios, [name]: value } }));
      };
      const handleHorarioChange = (index, campo, valor) => {
        setForm(prev => {
            const nuevoHorario = [...prev.horarioLaboral];
            nuevoHorario[index] = { ...nuevoHorario[index], [campo]: valor };
            return { ...prev, horarioLaboral: nuevoHorario };
        });
      };
      const handleCopyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(() => {
            setToast("¬°Copiado al portapapeles!");
        }, (err) => {
            setToast("Error al copiar");
            console.error('Error al copiar: ', err);
        });
      };
      const handleSubmit = (e) => {
        e.preventDefault();
        onUpdate(form);
      };
      const handlePasswordReset = () => {
        if(user && user.email) {
            auth.sendPasswordResetEmail(user.email)
                .then(() => setToast("Email para restablecer contrase√±a enviado."))
                .catch((error) => setToast(`Error: ${error.message}`));
        }
      };

return (
  <>
    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
      <Card title={<span className="text-[#34745B]">Perfil y Configuraci√≥n</span>}>
          <h4 className="text-md font-semibold text-slate-700 mb-2">Datos Personales</h4>
          <div className="grid gap-3">
            <div><label className="text-sm text-slate-600">Nombre del Profesor</label><input name="nombre" value={form.nombre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
            <div><label className="text-sm text-slate-600">Apellido</label><input name="apellido" value={form.apellido} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
            <div><label className="text-sm text-slate-600">Tel√©fono</label><input name="telefono" value={form.telefono} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
          </div>
          <div className="mt-6 border-t pt-6">
            <h4 className="text-md font-semibold text-slate-700 mb-2">Configuraci√≥n General</h4>
            <div>
              <label className="text-sm text-slate-600">Modo de Trabajo Principal</label>
              <select name="modoTrabajo" value={form.modoTrabajo || 'Club'} onChange={handleChange} className="w-full mt-1 border rounded-lg px-3 py-2">
                <option value="Club">Solo Clubes</option>
              </select>
            </div>
          </div>
          <div className="mt-6 border-t pt-6">
              <h4 className="text-md font-semibold text-slate-700 mb-2">Cuenta</h4>
              <div className="grid gap-3">
                <div>
                  <label className="text-sm text-slate-600">Email de la cuenta</label>
                  <p className="w-full bg-slate-100 rounded-lg px-3 py-2 text-slate-700">{user?.email}</p>
                </div>
                <div><button type="button" onClick={handlePasswordReset} className="w-full px-4 py-2 rounded-lg border text-sm bg-slate-100 hover:bg-slate-200">Restablecer Contrase√±a</button></div>
              </div>
          </div>
      </Card>
      
      <Card title={<span className="text-[#34745B]">Datos Bancarios para Transferencias</span>}>
          <div className="grid gap-4">
              {['alias', 'cbu', 'banco', 'titular'].map(field => (
                  <div key={field}>
                      <label className="text-sm font-medium text-slate-600 capitalize">{field}</label>
                      <div className="flex gap-2 mt-1">
                          <input type="text" name={field} value={(form.datosBancarios || {})[field]} onChange={handleDatosBancariosChange} className="w-full border rounded-lg px-3 py-2" />
                          <button type="button" onClick={() => handleCopyToClipboard((form.datosBancarios || {})[field])} className="px-3 py-2 rounded-lg border text-sm hover:bg-slate-100">Copiar</button>
                      </div>
                  </div>
              ))}
          </div>
      </Card>

      <div className="md:col-span-2">
        <Card title={<span className="text-[#34745B]">Centro de Comunicaciones</span>}>
            <div className="grid gap-4">
                <div>
                    <label className="text-sm font-medium text-slate-600">1. Elige una plantilla o escribe un mensaje</label>
                    <div className="flex gap-2 mt-1">
                        <select className="w-full border rounded-lg px-3 py-2" value={plantillaSeleccionada ? plantillaSeleccionada.id : ""} onChange={(e) => { const p = plantillas.find(p => p.id === e.target.value); setPlantillaSeleccionada(p || null); setMensajePersonalizado(p ? p.texto : ""); }}>
                            <option value="">Seleccionar plantilla...</option>
                            {plantillas.map(p => (<option key={p.id} value={p.id}>{p.titulo}</option>))}
                        </select>
                        <button type="button" onClick={() => setEditingPlantilla({})} className="px-3 py-2 text-sm rounded-lg bg-[#34745B] hover:bg-green-800 text-white whitespace-nowrap">+ Nueva</button>
                        <button type="button" onClick={() => plantillaSeleccionada && setEditingPlantilla(plantillaSeleccionada)} disabled={!plantillaSeleccionada} className="px-3 py-2 text-sm rounded-lg border disabled:opacity-50">Editar</button>
                        <button type="button" onClick={handleDeletePlantilla} disabled={!plantillaSeleccionada} className="px-3 py-2 text-sm rounded-lg border text-red-600 disabled:opacity-50">Eliminar</button>
                    </div>
                    <textarea value={mensajePersonalizado} onChange={(e) => setMensajePersonalizado(e.target.value)} className="w-full mt-2 border rounded-lg px-3 py-2" rows={5} placeholder="O escribe un mensaje personalizado aqu√≠... Usa {nombre_alumno} para personalizar." />
                </div>
                <div className="relative">
                    <label className="text-sm font-medium text-slate-600">2. Selecciona los destinatarios</label>
                    <input type="text" value={busquedaAlumno} onChange={(e) => { setBusquedaAlumno(e.target.value); setListaBusquedaAbierta(true); }} onBlur={() => setTimeout(() => setListaBusquedaAbierta(false), 200)} placeholder="Escribe para buscar alumnos..." className="w-full mt-1 border rounded-lg px-3 py-2" />
                    {listaBusquedaAbierta && busquedaAlumno && (
                        <ul className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg">
                            {alumnosFiltrados.length > 0 ? alumnosFiltrados.map(a => (<li key={a.id} onMouseDown={() => handleAgregarDestinatario(a)} className="px-3 py-2 hover:bg-slate-100 cursor-pointer">{getNombreCompleto(a)}</li>)) : <li className="px-3 py-2 text-slate-500">No se encontraron alumnos.</li>}
                        </ul>
                    )}
                    <div className="mt-2">
                        <p className="text-xs font-semibold text-slate-500">Destinatarios ({destinatarios.length}):</p>
                        {destinatarios.length > 0 && (<div className="flex flex-wrap gap-2 mt-1 p-2 border rounded-lg bg-slate-50">{destinatarios.map(d => (<span key={d.id} className="flex items-center gap-2 bg-sky-100 text-sky-800 text-sm rounded-full px-2 py-1">{getNombreCompleto(d)}<button type="button" onClick={() => handleQuitarDestinatario(d.id)} className="w-4 h-4 rounded-full bg-sky-200 text-sky-800 flex items-center justify-center font-bold text-xs">x</button></span>))}</div>)}
                    </div>
                </div>
                <div>
                    <label className="text-sm font-medium text-slate-600">3. Env√≠a los mensajes</label>
                    <div className="mt-2 p-3 border rounded-lg bg-slate-50 space-y-2 max-h-48 overflow-y-auto">{destinatarios.length > 0 ? (destinatarios.map(destinatario => (<button key={destinatario.id} type="button" onClick={() => handleSendMessage(destinatario)} className="w-full flex justify-between items-center text-left px-3 py-2 text-sm rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors"><span>Enviar a: <strong>{getNombreCompleto(destinatario)}</strong></span><span role="img" aria-label="send">üí¨</span></button>))) : (<p className="text-xs text-slate-400">Selecciona al menos un destinatario para ver los botones de env√≠o.</p>)}</div>
                </div>
            </div>
            <PlantillaModal isOpen={editingPlantilla !== null} plantilla={editingPlantilla?.id ? editingPlantilla : null} onCancel={() => setEditingPlantilla(null)} onSave={handleSavePlantilla} />
        </Card>
      </div>
      
      <div className="md:col-span-2">
        <Card title={<span className="text-[#34745B]">Mis Clubes</span>}>
            <GestionClubes user={user} />
        </Card>
      </div>

      <div className="md:col-span-2">
        <Card title={<span className="text-[#34745B]">Gesti√≥n de Datos</span>}>
             <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button type="button" onClick={handleExportData} className="w-full px-4 py-2 rounded-lg border bg-[#34745B] hover:bg-green-800 text-white font-semibold">Exportar Datos (Backup)</button>
                <button type="button" onClick={() => fileInputRef.current.click()} className="w-full px-4 py-2 rounded-lg border bg-slate-600 hover:bg-slate-700 text-white font-semibold">Importar Datos</button>
                <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleImportData} />
            </div>
            <p className="text-xs text-slate-500 mt-3"><strong>Atenci√≥n:</strong> La importaci√≥n de datos reemplazar√° toda la informaci√≥n existente en el modo de trabajo que tengas seleccionado.</p>
        </Card>
      </div>
      
      <div className="md:col-span-2">
        <Card title={<span className="text-[#34745B]">Seguridad y PIN</span>}>
            <div className="space-y-4">
                <div>
                    <label className="text-sm text-slate-600 block mb-1">
                        {form.pin ? "Cambiar PIN de seguridad (3 d√≠gitos)" : "Crear PIN de seguridad (3 d√≠gitos)"}
                    </label>
                    <p className="text-xs text-slate-500 mb-2">
                        Este PIN se solicitar√° para acciones cr√≠ticas.
                    </p>
                    <div className="grid grid-cols-2 gap-3">
                        <input type="password" name="newPin" value={pinInput.newPin} onChange={handlePinInputChange} placeholder="Nuevo PIN" maxLength="3" className="w-full border rounded-lg px-3 py-2 text-center" />
                        <input type="password" name="confirmPin" value={pinInput.confirmPin} onChange={handlePinInputChange} placeholder="Confirmar PIN" maxLength="3" className="w-full border rounded-lg px-3 py-2 text-center" />
                    </div>
                </div>
                <button type="button" onClick={handleSetPin} className="w-full px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-semibold">
                    {form.pin ? "Actualizar PIN" : "Establecer PIN"}
                </button>
            </div>
        </Card>
      </div>

      <div className="md:col-span-2">
        <div className="p-4 border-2 border-red-300 bg-red-50 rounded-2xl">
            <h3 className="text-base font-semibold text-red-800">Zona de Peligro</h3>
            <p className="text-sm text-red-700 mt-2 mb-3">
                La siguiente acci√≥n es permanente y no se puede deshacer.
            </p>
            <button type="button" onClick={handleWipeData} className="w-full px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">
                Borrar Todos los Datos de este Modo de Trabajo
            </button>
        </div>
      </div>

      <div className="md:col-span-2 flex justify-end">
         <button type="submit" className="px-6 py-3 rounded-xl bg-[#34745B] hover:bg-green-800 text-white font-semibold">Guardar Todos los Cambios</button>
      </div>
    </form>

    {/* üëá Montado una sola vez, fuera del <form> */}
    <ModalAbono />
  </>
);

    }
    // Reemplaza tu PagoGrupalModal completo con este c√≥digo
function PagoGrupalModal({ isOpen, clase, alumnos, onCancel, onSave, focusAlumnoId }) {
  const [pagos, setPagos] = useState({});
  const alumnosDeClase = clase ? (clase.alumnoIds || []).map(id => (alumnos || []).find(a => a.id === id)).filter(Boolean) : [];
  
  // Si nos pasan un focusAlumnoId, solo mostramos a ese alumno. Si no, a todos.
  const visibles = focusAlumnoId ? alumnosDeClase.filter(a => a.id === focusAlumnoId) : alumnosDeClase;

  useEffect(() => {
    if (clase) {
      const precioPorAlumno = (clase.alumnoIds?.length || 1) > 0 ? (parseFloat(clase.precio || 0) / (clase.alumnoIds?.length || 1)) : 0;
      const initialState = {};
      alumnosDeClase.forEach(alumno => {
        initialState[alumno.id] = {
          monto: alumno.plan === 'mensual' ? '0' : precioPorAlumno.toFixed(2),
          metodo: alumno.plan === 'mensual' ? "Mensual" : 'Efectivo',
          mixtoEfectivo: "",
          mixtoTransferencia: ""
        };
      });
      setPagos(initialState);
    }
  }, [clase, alumnos]);

  if (!isOpen || !clase) return null;

  const handlePaymentChange = (alumnoId, field, value) => {
    setPagos(prev => ({ ...prev, [alumnoId]: { ...prev[alumnoId], [field]: value } }));
  };
  
  const handleMixtoChange = (alumnoId, efectivo, transferencia) => {
      const ef = parseFloat(efectivo) || 0;
      const tx = parseFloat(transferencia) || 0;
      setPagos(prev => ({...prev, [alumnoId]: {...prev[alumnoId], mixtoEfectivo: efectivo, mixtoTransferencia: transferencia, monto: (ef + tx).toFixed(2)}}));
  }

  const handleSave = () => {
    const pagosAGuardar = Object.entries(pagos).map(([alumnoId, data]) => {
      // Solo incluimos en el guardado a los alumnos que estamos viendo
      if (visibles.some(a => a.id === alumnoId)) {
        const registro = { alumnoId, ...data };
        if (data.metodo === "Mixto") {
          registro.monto = (parseFloat(data.mixtoEfectivo || 0) + parseFloat(data.mixtoTransferencia || 0)).toFixed(2);
        }
        return registro;
      }
      return null;
    }).filter(Boolean); // Limpiamos los nulos
    onSave(pagosAGuardar);
  };

  // T√≠tulo din√°mico para mayor claridad
  const modalTitle = focusAlumnoId ? `Pagar Clase Espec√≠fica` : `Registrar Pagos de Clase`;

  return (
    <Modal isOpen={isOpen} title={modalTitle} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pagos">
      <div className="grid gap-4">
        <p className="text-sm text-center border-b pb-2">Clase de {clase.tipo} del {clase.fecha} a las {clase.hora}. Precio total: ${clase.precio}</p>
        <div className="space-y-4 max-h-64 overflow-y-auto pr-2">
          {visibles.map(alumno => (
            <div key={alumno.id} className="p-3 border rounded-lg bg-slate-50">
              <p className="font-semibold">{getNombreCompleto(alumno)}</p>
              {alumno.plan === 'mensual' ? (
                <p className="text-sm text-emerald-700 mt-2">‚úÖ Cubierto por Plan Mensual</p>
              ) : (
                <div className="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <label className="text-xs text-slate-600">Monto</label>
                    <input type="number" value={pagos[alumno.id]?.monto || ''} onChange={(e) => handlePaymentChange(alumno.id, 'monto', e.target.value)} disabled={pagos[alumno.id]?.metodo === 'Mixto'} className="w-full border rounded-lg px-2 py-1 disabled:bg-slate-200" />
                  </div>
                  <div>
                    <label className="text-xs text-slate-600">M√©todo</label>
                    <select value={pagos[alumno.id]?.metodo || 'Pendiente'} onChange={(e) => handlePaymentChange(alumno.id, 'metodo', e.target.value)} className="w-full border rounded-lg px-2 py-1">
                      {METODOS_PAGO.filter(m => m !== 'Mensual').map(m => <option key={m}>{m}</option>)}
                    </select>
                  </div>
                  {/* AQU√ç EST√Å LA L√ìGICA CORREGIDA PARA EL PAGO MIXTO */}
                  {pagos[alumno.id]?.metodo === 'Mixto' && (
                    <div className="col-span-2 grid grid-cols-2 gap-2 mt-2 pt-2 border-t">
                       <div>
                         <label className="text-xs text-slate-600">Efectivo</label>
                         <input type="number" value={pagos[alumno.id]?.mixtoEfectivo || ""} onChange={(e) => handleMixtoChange(alumno.id, e.target.value, pagos[alumno.id]?.mixtoTransferencia)} className="w-full rounded-lg px-2 py-1 border" />
                       </div>
                       <div>
                         <label className="text-xs text-slate-600">Transferencia</label>
                         <input type="number" value={pagos[alumno.id]?.mixtoTransferencia || ""} onChange={(e) => handleMixtoChange(alumno.id, pagos[alumno.id]?.mixtoEfectivo, e.target.value)} className="w-full rounded-lg px-2 py-1 border" />
                       </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    </Modal>
  );
}
// Pega esta nueva funci√≥n en tu archivo
function RegistroPagoMensualModal({ isOpen, alumno, perfil, onCancel, onSave }) {
  const [form, setForm] = useState({
    monto: "",
    metodo: "Transferencia",
    mes: new Date().getMonth(),
    fechaPago: formatDate(new Date())
  });

  useEffect(() => {
    // Cuando se abre el modal, calcula el monto sugerido del plan del alumno
    if (alumno && perfil.preciosMensuales) {
      const montoPredefinido = perfil.preciosMensuales[alumno.frecuencia] || "";
      setForm(prev => ({ ...prev, monto: montoPredefinido }));
    }
  }, [isOpen, alumno, perfil]);

  if (!isOpen || !alumno) return null;

  const handleSave = () => {
    if (!form.monto || parseFloat(form.monto) <= 0) {
      alert("Por favor, ingresa un monto v√°lido.");
      return;
    }
    onSave(form);
  };

  return (
    <Modal isOpen={isOpen} title={`Registrar Abono: ${getNombreCompleto(alumno)}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pago">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">Mes Correspondiente</label>
          <select 
            value={form.mes} 
            onChange={(e) => setForm({...form, mes: parseInt(e.target.value)})}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            {MESES_NOMBRES.map((nombre, index) => <option key={index} value={index}>{nombre}</option>)}
          </select>
        </div>
        <div>
          <label className="text-sm text-slate-600">Monto Pagado</label>
          <input 
            type="number" 
            value={form.monto} 
            onChange={(e) => setForm({...form, monto: e.target.value})} 
            className="w-full border rounded-lg px-3 py-2 mt-1" 
            placeholder="0.00" 
          />
        </div>
        <div>
          <label className="text-sm text-slate-600">M√©todo de Pago</label>
          <select 
            value={form.metodo} 
            onChange={(e) => setForm({...form, metodo: e.target.value})}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            {METODOS_PAGO.filter(m => m !== 'Pendiente').map(m => <option key={m}>{m}</option>)}
          </select>
        </div>
        <div>
          <label className="text-sm text-slate-600">Fecha de Pago</label>
          <input 
            type="date" 
            value={form.fechaPago} 
            onChange={(e) => setForm({...form, fechaPago: e.target.value})} 
            className="w-full border rounded-lg px-3 py-2 mt-1" 
          />
        </div>
      </div>
    </Modal>
  );
}
    function PagoMensualModal({ isOpen, alumno, mes, onCancel, onSave }) {
      const [form, setForm] = useState({ monto: "", metodo: "Efectivo" });
      useEffect(() => {
        if (alumno) {
          const restante = alumno.cuota - alumno.totalPagado;
          setForm({ monto: restante > 0 ? restante.toFixed(2) : "", metodo: "Efectivo" });
        }
      }, [alumno]);
      if (!isOpen || !alumno) return null;
      const handleSave = () => { onSave({ ...form, monto: form.monto || "0" }); };
      return (
        <Modal isOpen={isOpen} title={`Pago Cuota: ${alumno.nombre}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pago">
          <div className="grid gap-4">
            <p>Cuota de {MESES_NOMBRES[mes]} por ${alumno.cuota.toFixed(2)}. Pagado: ${alumno.totalPagado.toFixed(2)}.</p>
            <div><label className="text-sm text-slate-600">Monto a Pagar</label><input type="number" value={form.monto} onChange={(e) => setForm({...form, monto: e.target.value})} className="w-full border rounded-lg px-3 py-2" placeholder="0.00" /></div>
            <div><label className="text-sm text-slate-600">M√©todo de Pago</label><select value={form.metodo} onChange={(e) => setForm({...form, metodo: e.target.value})} className="w-full border rounded-lg px-3 py-2">{METODOS_PAGO.filter(m => m !== 'Pendiente').map(m => <option key={m}>{m}</option>)}</select></div>
          </div>
        </Modal>
      );
    }
    // Pega este nuevo componente en tu archivo
function EditarPagoModal({ isOpen, pago, onCancel, onSave }) {
  const [form, setForm] = useState(null);

  useEffect(() => {
    // Cuando se abre el modal, inicializamos el form con todos los campos necesarios
    if (pago) {
      setForm({
        ...pago,
        concepto: pago.concepto || "Pago General",
        mixtoEfectivo: pago.detalleMixto?.efectivo?.toString() || "",
        mixtoTransferencia: pago.detalleMixto?.transferencia?.toString() || ""
      });
    }
  }, [pago]);

  if (!isOpen || !form) return null;

  const handleChange = (e) => {
    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  };
  
  const handleMixtoChange = (efectivo, transferencia) => {
      const ef = parseFloat(efectivo) || 0;
      const tx = parseFloat(transferencia) || 0;
      setForm(prev => ({...prev, mixtoEfectivo: efectivo, mixtoTransferencia: transferencia, monto: (ef + tx).toFixed(2)}));
  }

  return (
    <Modal isOpen={isOpen} title={`Editar Pago`} onCancel={onCancel} onConfirm={() => onSave(form)} confirmText="Guardar Cambios">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">Concepto</label>
          <input type="text" name="concepto" value={form.concepto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" />
        </div>
        <div>
          <label className="text-sm text-slate-600">Monto Pagado</label>
          <input type="number" name="monto" value={form.monto} onChange={handleChange} disabled={form.metodo === 'Mixto'} className="w-full border rounded-lg px-3 py-2 mt-1 disabled:bg-slate-100" />
        </div>
        <div>
          <label className="text-sm text-slate-600">M√©todo de Pago</label>
          <select name="metodo" value={form.metodo} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1">
            {METODOS_PAGO.filter(m => m !== 'Pendiente' && m !== 'Mensual').map(m => <option key={m}>{m}</option>)}
          </select>
        </div>
        
        {/* L√≥gica corregida para el pago mixto */}
        {form.metodo === 'Mixto' && (
          <div className="p-3 border rounded-lg grid grid-cols-2 gap-3 bg-slate-50">
            <div>
              <label className="text-xs text-slate-600">Efectivo</label>
              <input type="number" value={form.mixtoEfectivo} onChange={(e) => handleMixtoChange(e.target.value, form.mixtoTransferencia)} className="w-full border rounded-lg px-2 py-1 mt-1" />
            </div>
            <div>
              <label className="text-xs text-slate-600">Transferencia</label>
              <input type="number" value={form.mixtoTransferencia} onChange={(e) => handleMixtoChange(form.mixtoEfectivo, e.target.value)} className="w-full border rounded-lg px-2 py-1 mt-1" />
            </div>
          </div>
        )}

        <div>
          <label className="text-sm text-slate-600">Fecha de Pago</label>
          <input type="date" name="fecha" value={form.fecha} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" />
        </div>
      </div>
    </Modal>
  );
}
function PlantillaModal({ isOpen, plantilla, onCancel, onSave }) {
  const [form, setForm] = useState({ titulo: '', texto: '' });

  useEffect(() => {
    // Si pasamos una plantilla, es para editar. Si no, es para crear una nueva.
    if (plantilla) {
      setForm(plantilla);
    } else {
      setForm({ titulo: '', texto: '' });
    }
  }, [plantilla]);

  if (!isOpen) return null;

  const handleChange = (e) => {
    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  };

  return (
    <Modal isOpen={isOpen} title={form.id ? "Editar Plantilla" : "Nueva Plantilla"} onCancel={onCancel} onConfirm={() => onSave(form)} confirmText="Guardar">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">T√≠tulo de la Plantilla</label>
          <input type="text" name="titulo" value={form.titulo} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Ej: Recordatorio de Clase" />
        </div>
        <div>
          <label className="text-sm text-slate-600">Texto del Mensaje</label>
          <textarea name="texto" value={form.texto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" rows={6} placeholder="Escribe tu mensaje aqu√≠. Usa {nombre_alumno} para personalizarlo."></textarea>
        </div>
      </div>
    </Modal>
  );
}
    
    function LoginScreen() {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [message, setMessage] = useState('');
        const [view, setView] = useState('login');
        const [loading, setLoading] = useState(false);

        
        // Evitar updates en componente desmontado
        const mountedRef = React.useRef(true);
        useEffect(() => () => { mountedRef.current = false; }, []);
const handleAuthAction = async (e) => {
            e.preventDefault();
            mountedRef.current && setLoading(true);
            mountedRef.current && setError('');
            mountedRef.current && setMessage('');
            try {
                if (view === 'register') {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).collection('profile').doc('main').set(initialState.perfil);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        const handlePasswordReset = async (e) => {
            e.preventDefault();
            mountedRef.current && setLoading(true);
            mountedRef.current && setError('');
            mountedRef.current && setMessage('');
            try {
                await auth.sendPasswordResetEmail(email);
                mountedRef.current && setMessage('Se envi√≥ un correo para restablecer tu contrase√±a.');
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen bg-[#2F2F2F] flex flex-col justify-center items-center p-4">
                <div className="w-full max-w-sm mx-auto">
                    <div className="flex flex-col items-center mb-8"> {/* Aumentamos un poco el margen inferior */}
    <img
    src="logo_coachex.png"
    alt="Coachex-Pro Logo"
    className="h-10 mx-auto mb-2"
  />
    <h2 className="text-slate-200 text-xl tracking-wide">
    Gesti√≥n de Profesores
  </h2>
</div>
                    
                    <div className="bg-white rounded-2xl shadow-lg p-8">
                        {view === 'login' && (
                            <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Iniciar Sesi√≥n</h2>
                                <form onSubmit={handleAuthAction} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    <div><label className="text-sm font-medium text-slate-600">Contrase√±a</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    <button
  type="submit"
  className="w-full h-11 rounded-lg bg-[#34745B] hover:bg-[#2E6D56] text-white font-semibold shadow-sm transition
             disabled:opacity-50 disabled:cursor-not-allowed
             focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#34745B]"
>
  Ingresar
</button>
                                </form>
<div className="text-center mt-4">
  <button
    onClick={() => setView('reset')}
    className="text-sm text-[#34745B] hover:text-[#2E6D56] font-medium underline underline-offset-2"
  >
    ¬øOlvidaste tu contrase√±a?
  </button>
</div>                                <div className="text-center mt-2"><button onClick={() => setView('register')} className="text-sm text-slate-600 hover:underline">¬øNo ten√©s cuenta? Registrate</button></div>
                            </div>
                        )}
                        {view === 'register' && (
                             <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Crear Cuenta</h2>
                                <form onSubmit={handleAuthAction} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    <div><label className="text-sm font-medium text-slate-600">Contrase√±a</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    <button
  type="submit"
  className="w-full px-4 py-2 rounded-lg text-white
             bg-slate-600 hover:bg-slate-700
             disabled:opacity-60 disabled:cursor-not-allowed"
>
  Registrarse
</button>
                                </form>
                                <div className="text-center mt-4"><button onClick={() => setView('login')} className="text-sm text-slate-600 hover:underline">¬øYa ten√©s cuenta? Ingres√°</button></div>
                            </div>
                        )}
                        {view === 'reset' && (
                             <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Restablecer Contrase√±a</h2>
                                <form onSubmit={handlePasswordReset} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    {message && <p className="text-sm text-green-600">{message}</p>}
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-2 rounded-lg font-semibold hover:bg-slate-600 hover:bg-slate-700">{loading ? 'Enviando...' : 'Enviar correo'}</button>
                                </form>
                                <div className="text-center mt-4"><button onClick={() => setView('login')} className="text-sm text-slate-600 hover:underline">Volver a Iniciar Sesi√≥n</button></div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

function OnboardingClubSetup({ user, setHasClubs, onLogout }) {
  // Mostrar d√≠as completos pero manejar c√≥digo corto internamente
  const DIAS = [
    { label: "Lunes",     code: "Lu" },
    { label: "Martes",    code: "Ma" },
    { label: "Mi√©rcoles", code: "Mi" },
    { label: "Jueves",    code: "Ju" },
    { label: "Viernes",   code: "Vi" },
    { label: "S√°bado",    code: "Sa" },
    { label: "Domingo",   code: "Do" },
  ];
  const getLabelByCode = (code) => DIAS.find(d => d.code === code)?.label || code;

  // ---- State
  const [nombre, setNombre] = React.useState("");
  const [modalidad, setModalidad] = React.useState("Por Clase");
  const [repProfesor, setRepProfesor] = React.useState(60); // edit√°s este
  const repClub = Math.max(0, Math.min(100, 100 - Number(repProfesor || 0))); // se calcula solo

  const [horario, setHorario] = React.useState([
    { id: cryptoRandomId(), diaCode: "Lu", desde: "08:00", hasta: "12:00" },
  ]);

  const [preciosClase, setPreciosClase] = React.useState({ p1: 0, p2: 0, p3: 0, p4: 0, escuelita: 0 });
  const [preciosMensual, setPreciosMensual] = React.useState({ x1: 0, x2: 0, x3: 0, libre: 0 });

  // ---- Validaci√≥n
  const profesorValid = Number.isFinite(Number(repProfesor)) && Number(repProfesor) >= 0 && Number(repProfesor) <= 100;
  const invalidIds = horario.filter(b => !isBlockValid(b)).map(b => b.id);
  const horariosValidos = invalidIds.length === 0;
  const canSave = user && nombre.trim().length > 0 && profesorValid && horariosValidos;

  // ---- Helpers
  function cryptoRandomId() { return Math.random().toString(36).slice(2, 10); }
  function toMinutes(hhmm) { if (!hhmm || typeof hhmm !== "string") return NaN; const [h, m] = hhmm.split(":").map(Number); return h * 60 + (m || 0); }
  function isBlockValid(b) { const d = toMinutes(b.desde); const h = toMinutes(b.hasta); return Number.isFinite(d) && Number.isFinite(h) && d < h; }

  const addBloque    = () => setHorario(h => [...h, { id: cryptoRandomId(), diaCode: "Lu", desde: "08:00", hasta: "12:00" }]);
  const removeBloque = (id) => setHorario(h => h.filter(b => b.id !== id));
  const updateBloque = (id, patch) => setHorario(h => h.map(b => b.id === id ? { ...b, ...patch } : b));

  const onChangeMoney = (objSetter) => (key) => (e) => {
    const raw = (e.target.value || "").replace(",", ".");
    const n = raw === "" ? "" : Number(raw);
    objSetter(prev => ({ ...prev, [key]: isNaN(n) ? 0 : n }));
  };

  const guardar = async () => {
    try {
      const ref = db.collection("users").doc(user.uid).collection("clubs").doc();
      const doc = {
        nombre,
        modalidadCobroPrincipal: modalidad,
        reparto: { profesor: Number(repProfesor)||0, club: repClub },
        // Guardamos tanto el code como el label para facilitar lecturas futuras
        horarioLaboral: horario.map(b => ({
          diaCode: b.diaCode,
          diaLabel: getLabelByCode(b.diaCode),
          desde: b.desde,
          hasta: b.hasta
        })),
        precios: {
          porClase: {
            "1": Number(preciosClase.p1)||0,
            "2": Number(preciosClase.p2)||0,
            "3": Number(preciosClase.p3)||0,
            "4": Number(preciosClase.p4)||0,
            escuelita: Number(preciosClase.escuelita)||0
          },
          mensuales: {
            x1: Number(preciosMensual.x1)||0,
            x2: Number(preciosMensual?.x2 ?? preciosMensual.x2)||0,
            x3: Number(preciosMensual.x3)||0,
            libre: Number(preciosMensual.libre)||0
          }
        },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await ref.set(doc);
      setHasClubs(true);
    } catch (err) {
      console.error("Error guardando club:", err);
      alert("No se pudo guardar. Revis√° la consola para m√°s detalles.");
    }
  };

  // ---- UI
  return (
    <div className="max-w-5xl mx-auto px-4">
      {/* Header */}
      <div className="pt-8 pb-6 text-center">
        <img
          src="./img/logo_coachex_N.png"
          alt="Coachex-Pro Logo"
          className="h-8 w-auto"
         onError={(e) => { 
         e.currentTarget.onerror = null; 
         e.currentTarget.src = "./logo_coachex_N.png"; // fallback si no est√° en /img
      }}
/>
        <h1 className="mt-2 text-3xl font-bold text-slate-800">Bienvenido a Coachex-Pro</h1>
        <p className="mt-2 text-slate-600 max-w-xl mx-auto">
          Gesti√≥n integral para profesores de tenis y padel.
        </p>
        <p className="text-slate-600">Carg√° la informaci√≥n del Club en donde trabaj√°s.</p>
      </div>

      {/* Cards */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* Configuraci√≥n General */}
        <SetupCard title="Configuraci√≥n General">
          <SetupLabel>Nombre del Club</SetupLabel>
          <SetupInput value={nombre} onChange={e=>setNombre(e.target.value)} placeholder="Ej: Club Mad" />

          <SetupLabel className="mt-4">Modalidad de Cobro Principal</SetupLabel>
          <SetupSelect value={modalidad} onChange={e=>setModalidad(e.target.value)}>
            <option>Por Clase</option>
            <option>Mensual</option>
          </SetupSelect>

          <div className="grid grid-cols-2 gap-3 mt-4">
            <SetupPercentField
              label="Reparto % (Profesor)"
              value={repProfesor}
              onChange={e => {
                const v = Math.max(0, Math.min(100, Number(e.target.value || 0)));
                setRepProfesor(v);
              }}
            />
            <SetupPercentField
              label="Reparto % (Club)"
              value={repClub}
              readOnly
              tooltip="Se calcula autom√°ticamente como 100% - Profesor"
            />
          </div>
          {!profesorValid && (
            <p className="mt-2 text-xs text-red-600">El % del profesor debe estar entre 0 y 100.</p>
          )}
        </SetupCard>

        {/* Horario Laboral */}
        <SetupCard title="Horario Laboral">
          <div className="space-y-3">
            {horario.map(b => {
              const invalid = !isBlockValid(b);
              return (
                <div key={b.id}>
                  <div className="flex flex-wrap items-center gap-2">
                    <SetupSelect
                      value={b.diaCode}
                      onChange={e=>updateBloque(b.id, { diaCode: e.target.value })}
                      className="w-40"
                    >
                      {DIAS.map(d => (
                        <option key={d.code} value={d.code}>{d.label}</option>
                      ))}
                    </SetupSelect>

                    <SetupTimeField
                      value={b.desde}
                      onChange={e=>updateBloque(b.id, { desde: e.target.value })}
                      invalid={invalid}
                      aria-label="Desde"
                    />
                    <span className="text-slate-400 select-none">‚Äî</span>
                    <SetupTimeField
                      value={b.hasta}
                      onChange={e=>updateBloque(b.id, { hasta: e.target.value })}
                      invalid={invalid}
                      aria-label="Hasta"
                    />

                    <button
                      className="inline-flex items-center gap-1 rounded-full border border-red-200 text-red-600 px-3 py-1.5 text-sm hover:bg-red-50"
                      onClick={()=>removeBloque(b.id)}
                    >
                      Quitar
                    </button>
                  </div>
                  {invalid && (
                    <p className="mt-1 text-xs text-red-600">
                      El horario no es v√°lido. <span className="font-medium">‚ÄúDesde‚Äù</span> debe ser menor que <span className="font-medium">‚ÄúHasta‚Äù</span>.
                    </p>
                  )}
                </div>
              );
            })}
          </div>

          <button onClick={addBloque}
                  className="mt-3 w-full border-2 border-dashed rounded-xl py-2 text-slate-500 hover:bg-slate-50">
            + Agregar bloque
          </button>

          {!horariosValidos && (
            <p className="mt-2 text-xs text-red-600">Revis√° los bloques en rojo antes de continuar.</p>
          )}
        </SetupCard>

        {/* Precios por Clase */}
        <SetupCard title="Precios por Clase">
          <div className="space-y-3">
            <SetupMoneyField label="Clase para 1 persona" value={preciosClase.p1} onChange={onChangeMoney(setPreciosClase)("p1")} />
            <SetupMoneyField label="Clase para 2 personas" value={preciosClase.p2} onChange={onChangeMoney(setPreciosClase)("p2")} />
            <SetupMoneyField label="Clase para 3 personas" value={preciosClase.p3} onChange={onChangeMoney(setPreciosClase)("p3")} />
            <SetupMoneyField label="Clase para 4 personas" value={preciosClase.p4} onChange={onChangeMoney(setPreciosClase)("p4")} />
            <SetupMoneyField label="Escuelita" value={preciosClase.escuelita} onChange={onChangeMoney(setPreciosClase)("escuelita")} />
          </div>
        </SetupCard>

        {/* Precios Mensuales */}
        <SetupCard title="Precios Mensuales">
          <div className="space-y-3">
            <SetupMoneyField label="1 vez por semana" value={preciosMensual.x1} onChange={onChangeMoney(setPreciosMensual)("x1")} />
            <SetupMoneyField label="2 veces por semana" value={preciosMensual.x2} onChange={onChangeMoney(setPreciosMensual)("x2")} />
            <SetupMoneyField label="3 veces por semana" value={preciosMensual.x3} onChange={onChangeMoney(setPreciosMensual)("x3")} />
            <SetupMoneyField label="Libre" value={preciosMensual.libre} onChange={onChangeMoney(setPreciosMensual)("libre")} />
          </div>
        </SetupCard>
      </div>

      {/* CTA */}
      <div className="mt-8 text-center">
        <button
          className="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-6 py-3 text-white font-semibold shadow hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled={!canSave}
          onClick={guardar}
        >
          Guardar y Comenzar
        </button>
        {!canSave && (
          <p className="text-xs text-slate-500 mt-2">
            Complet√° el nombre del club, un % de profesor v√°lido y correg√≠ los horarios en rojo.
          </p>
        )}
      </div>
      <div className="mt-4 text-center">
  <button
    onClick={onLogout}
    className="inline-flex items-center justify-center rounded-xl border border-slate-300 px-6 py-2 text-slate-600 hover:bg-slate-100"
  >
    Volver al inicio de sesi√≥n
  </button>
</div>
    </div>
  );
}

/* ---------- UI helpers (prefijo Setup para evitar conflictos) ---------- */

const SetupCard = ({ title, children }) => (
  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
    <h3 className="text-lg font-semibold text-emerald-700 mb-3">{title}</h3>
    {children}
  </div>
);

const SetupLabel = ({ children, className="" }) => (
  <label className={`block text-sm text-slate-600 mb-1 ${className}`}>{children}</label>
);

const SetupInput = (props) => (
  <input
    {...props}
    className={`w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-800 shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-300 ${props.className||""}`}
  />
);

const SetupSelect = (props) => (
  <select
    {...props}
    className={`w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-300 ${props.className||""}`}
  />
);

const SetupPercentField = ({ label, value, onChange, readOnly=false, tooltip }) => (
  <div>
    <SetupLabel>{label}</SetupLabel>
    <div className="relative">
      <SetupInput value={value} onChange={onChange} inputMode="numeric" className="pr-12" readOnly={readOnly} title={tooltip}/>
      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500">%</span>
    </div>
  </div>
);

const SetupMoneyField = ({ label, value, onChange }) => (
  <div>
    <SetupLabel>{label}</SetupLabel>
    <div className="relative">
      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm">ARS $</span>
      <SetupInput value={value} onChange={onChange} inputMode="decimal" placeholder="0" className="pl-16" />
    </div>
  </div>
);

const SetupTimeField = ({ value, onChange, invalid=false, ...rest }) => (
  <div className="relative">
    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 select-none">üïë</span>
    <input
      type="time"
      value={value}
      onChange={onChange}
      {...rest}
      className={[
        "w-[130px] rounded-xl border bg-white pl-8 pr-2 py-2 text-slate-800 focus:outline-none",
        invalid ? "border-red-300 focus:ring-2 focus:ring-red-300" : "border-slate-200 focus:ring-2 focus:ring-emerald-300"
      ].join(" ")}
    />
  </div>
);

    
function MainApp({ user, onLogout }) {
  const [current, setCurrent] = useState("dashboard");
  const [prefillClase, setPrefillClase] = useState(null);

  const [state, setState] = useState({ alumnos: [], clases: [], pagos: [], gastos: [], perfil: {} });
  const [loading, setLoading] = useState(true);
  const [toast, setToast] = useState("");
  const [deletingInfo, setDeletingInfo] = useState({ id: null, type: null, collection: null });
  const [payingClase, setPayingClase] = useState(null);
  const [focusAlumnoId, setFocusAlumnoId] = useState(null);
  const openPagoPendiente = (clase, alumnoId) => {
    if (clase) {
      setPayingClase(clase);
      setFocusAlumnoId(alumnoId);
    }
  };
  const [claseParaAgendar, setClaseParaAgendar] = useState(null);
  const [payingCuota, setPayingCuota] = useState({ alumno: null, mes: null });
  const [claseParaEditar, setClaseParaEditar] = useState(null);
  const [nuevoAlumnoId, setNuevoAlumnoId] = useState(null);
  const openRegistrarClaseForAlumno = (alumnoId) => { setCurrent("clases"); setNuevoAlumnoId(alumnoId); };
  const [registrandoAbono, setRegistrandoAbono] = useState(null);
  const [pagoParaEditar, setPagoParaEditar] = useState(null);
  const [clubActivoId, setClubActivoId] = useState(null);
  const [clubes, setClubes] = useState([]);
  const [hasClubs, setHasClubs] = useState(false);

  useEffect(() => {
    if (!user) return;
    setLoading(true);

    const clubsRef = db.collection('users').doc(user.uid).collection('clubs');
    const clubsUnsubscribe = clubsRef.onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setClubes(data);
      setHasClubs(data.length > 0);

      if (data.length > 0) {
        if (!clubActivoId) {
          setClubActivoId(data[0].id);
        }
      } else {
        setClubActivoId(null);
      }
      setLoading(false);
    }, error => {
      console.error("Error fetching clubs: ", error);
      setLoading(false);
    });

    return () => clubsUnsubscribe();
  }, [user]);

  useEffect(() => {
    if (!user || !clubActivoId) return;

    const baseRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId);
    
    const profileUnsubscribe = db.collection('users').doc(user.uid).collection('profile').doc('main').onSnapshot(doc => {
      if (doc.exists) {
          setState(prevState => ({ ...prevState, perfil: { ...initialState.perfil, ...doc.data()} }));
      } else {
          setState(prevState => ({ ...prevState, perfil: initialState.perfil }));
      }
    });

    const collections = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos'];
    const unsubscribes = [profileUnsubscribe];

    collections.forEach(collectionName => {
        const unsubscribe = baseRef.collection(collectionName).onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setState(prevState => ({ ...prevState, [collectionName]: data }));
        }, error => console.error(`Error fetching ${collectionName}: `, error));
        unsubscribes.push(unsubscribe);
    });

    return () => unsubscribes.forEach(unsub => unsub());
  }, [user, clubActivoId]);

  const getCollection = (collectionName) => {
    if (!clubActivoId) {
      console.error("No club active. Cannot get collection.");
      return null;
    }
    return db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId).collection(collectionName);
  };
  
  const alumnoCrud = {
    create: async (data) => {
      const collectionRef = getCollection('alumnos');
      if (!collectionRef) return;
      const docRef = await collectionRef.add(data);
      setToast("Alumno creado");
      return { ...data, id: docRef.id };
    },
    update: ({ id, ...data }) => {
      const collectionRef = getCollection('alumnos');
      if (!collectionRef) return;
      return collectionRef.doc(id).update(data).then(() => setToast("Alumno actualizado"));
    },
    delete: (id) => setDeletingInfo({ id, type: 'alumno', collection: 'alumnos' }),
  };

  const pagoCrud = {
    createPagosClase: async (pagosData) => {
      const batch = db.batch();
      const collectionRef = getCollection('pagos');
      if (!collectionRef) return;
      // Actualizar el estado 'pagada' de la clase al guardar el pago.
      const claseRef = getCollection('clases').doc(payingClase.id);

      pagosData.forEach(pago => {
        if (parseFloat(pago.monto) > 0 || pago.metodo === 'Pendiente') {
            const docRef = collectionRef.doc();
            const payload = {
                claseId: payingClase.id,
                alumnoId: pago.alumnoId,
                fecha: payingClase.fecha,
                concepto: `Pago Clase ${payingClase.tipo}`,
                metodo: pago.metodo,
                monto: pago.monto
            };
            if (pago.metodo === 'Mixto') {
                payload.detalleMixto = {
                    efectivo: parseFloat(pago.mixtoEfectivo) || 0,
                    transferencia: parseFloat(pago.mixtoTransferencia) || 0
                };
            }
            batch.set(docRef, payload);
        }
      });
      await batch.commit();

      // Recalcular el estado de la clase despu√©s de que los nuevos pagos se hayan guardado.
      const pagosExistentes = await getCollection('pagos').where('claseId', '==', payingClase.id).get();
      const totalPagadoAcumulado = pagosExistentes.docs.reduce((sum, doc) => {
          const pago = doc.data();
          return sum + parseFloat(pago.monto || 0);
      }, 0);

      const claseDoc = await claseRef.get();
      if (claseDoc.exists) {
          const precioTotalClase = parseFloat(claseDoc.data().precio);
          const estaPagada = totalPagadoAcumulado >= precioTotalClase;
          await claseRef.update({ pagada: estaPagada });
      }

      setToast("Pagos registrados");
      setPayingClase(null);
      setFocusAlumnoId(null);
      setClaseParaAgendar(payingClase);
    },
    createAbono: (pagoData, alumno) => {
      const collectionRef = getCollection('pagos');
      if (!collectionRef) return;
      const newPago = {
        alumnoId: alumno.id,
        fecha: pagoData.fechaPago,
        concepto: pagoData.concepto || `Abono Mensual - ${MESES_NOMBRES[pagoData.mes]}`,
        monto: pagoData.monto,
        metodo: pagoData.metodo
      };
      collectionRef.add(newPago).then(() => {
        setToast("Pago de abono registrado con √©xito");
        setRegistrandoAbono(null);
      });
    },
    createMensual: (pagoData) => {
      const collectionRef = getCollection('pagos');
      if (!collectionRef) return;
      const { alumno, mes } = payingCuota;
      const fecha = new Date();
      fecha.setMonth(mes);
      const newPago = { alumnoId: alumno.id, fecha: formatDate(fecha), concepto: `Cuota Mensual - ${MESES_NOMBRES[mes]}`, ...pagoData };
      collectionRef.add(newPago).then(() => {
        setToast("Pago de cuota registrado");
        setPayingCuota({ alumno: null, mes: null });
      });
    },
    update: ({ id, ...data }) => {
      const collectionRef = getCollection('pagos');
      if (!collectionRef) return;
      const dataToSave = { ...data };
      if (data.metodo === 'Mixto') {
        dataToSave.detalleMixto = {
          efectivo: parseFloat(data.mixtoEfectivo) || 0,
          transferencia: parseFloat(data.mixtoTransferencia) || 0
        };
      }
      delete dataToSave.mixtoEfectivo;
      delete dataToSave.mixtoTransferencia;
      return collectionRef.doc(id).update(dataToSave).then(() => {
        setToast("Pago actualizado con √©xito");
        setPagoParaEditar(null);
      });
    }
  };
 const claseCrud = {
  create: async (c) => {
    const collectionRef = getCollection('clases');
    if (!collectionRef) return;
    const claseData = { ...c };
    delete claseData.id;

    const shouldPay = claseData.estado === 'Realizada' || claseData.estado === 'Ausente';

    let nuevaClaseId;

    if (claseData.recurrente) {
      const batch = db.batch();
      const semanas = parseInt(claseData.mesesRecurrencia, 10) * 4;
      for (let i = 0; i < semanas; i++) {
          const nuevaFecha = addDays(new Date(claseData.fecha), i * 7);
          const newClase = { ...claseData, fecha: formatDate(nuevaFecha), recurrente: false };
          const docRef = collectionRef.doc();
          batch.set(docRef, newClase);
      }
      await batch.commit();
      setToast("Clases recurrentes creadas");
    } else {
      const docRef = await collectionRef.add(claseData);
      nuevaClaseId = docRef.id;
      setToast("Clase creada");
    }

    if (shouldPay && nuevaClaseId) {
        const claseParaPagar = { ...claseData, id: nuevaClaseId };
        setPayingClase(claseParaPagar);
    }
  },
  update: ({ id, ...data }) => {
  const collectionRef = getCollection('clases');
  if (!collectionRef) return;

  const shouldPay = data.estado === 'Realizada' || data.estado === 'Ausente';

  return collectionRef.doc(id).update(data).then(() => {
    setToast("Clase actualizada");
    if (shouldPay) {
      // ‚úÖ abrimos el modal de pagos desde MainApp igual que en create
      setPayingClase({ ...data, id });
    }
  });
},
  delete: (id) => setDeletingInfo({ id, type: 'clase', collection: 'clases' }),
};
  const gastoCrud = {
    create: (g) => {
      const collectionRef = getCollection('gastos');
      if (!collectionRef) return;
      return collectionRef.add(g).then(() => setToast("Gasto creado"));
    },
    update: ({ id, ...data }) => {
      const collectionRef = getCollection('gastos');
      if (!collectionRef) return;
      return collectionRef.doc(id).update(data).then(() => setToast("Gasto actualizado"));
    },
    delete: (id) => setDeletingInfo({ id, type: 'gasto', collection: 'gastos' }),
  };
  const perfilCrud = {
    update: (p) => db.collection('users').doc(user.uid).collection('profile').doc('main').set(p, { merge: true }).then(() => setToast("Perfil actualizado"))
  };

  const confirmDelete = async () => {
    const { id, type, collection } = deletingInfo;
    if (!id || !collection) return;
    const collectionRef = getCollection(collection);
    if (!collectionRef) return;
    await collectionRef.doc(id).delete();
    if (type === 'clase') {
      const pagosSnapshot = await getCollection('pagos').where('claseId', '==', id).get();
      const batch = db.batch();
      pagosSnapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    }
    setToast(`${type.charAt(0).toUpperCase() + type.slice(1)} eliminado/a`);
    setDeletingInfo({ id: null, type: null, collection: null });
  };
  const handleRegisterMonthlyPayment = (alumno) => {
    setRegistrandoAbono(alumno);
  };

  const handleExportData = () => {
    const dataToExport = {
      alumnos: state.alumnos,
      clases: state.clases,
      pagos: state.pagos,
      gastos: state.gastos,
      perfil: state.perfil,
      grupos: state.grupos || []
    };
    const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(dataToExport, null, 2))}`;
    const link = document.createElement("a");
    link.href = jsonString;
    const date = new Date().toISOString().slice(0, 10);
    link.download = `coachex_backup_${date}.json`;
    link.click();
    setToast("Datos exportados con √©xito.");
  };

  const handleImportData = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        const confirmImport = window.confirm(
          "¬°ATENCI√ìN! ¬øEst√°s seguro de que quieres importar estos datos?\n\n" +
          "TODOS TUS DATOS ACTUALES SER√ÅN BORRADOS Y REEMPLAZADOS.\n\n" +
          "Esta acci√≥n no se puede deshacer."
        );
        if (confirmImport) {
          setToast("Importando datos... La p√°gina se recargar√° al finalizar.");
          console.log("Datos a importar:", importedData);
          alert("La funcionalidad de escritura en la base de datos est√° pendiente. Revisa la consola para ver los datos que se importar√≠an.");
        }
      } catch (error) {
        alert("El archivo seleccionado no es un JSON v√°lido o est√° corrupto.");
        console.error("Error al parsear JSON:", error);
      } finally {
        event.target.value = null;
      }
    };
    reader.readAsText(file);
  };
  const goToEditClass = (clase) => {
    setClaseParaEditar(clase);
    setCurrent("clases");
  };
  const handleDeletePago = (pagoId) => {
    setDeletingInfo({ id: pagoId, type: 'pago', collection: 'pagos' });
  };

  if (loading) {
    return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;
  }

  if (!hasClubs) {
  return (
    <OnboardingClubSetup
      user={user}
      setHasClubs={setHasClubs}
      onLogout={onLogout}
    />
  );
}

  return (
    <div className="min-h-screen bg-slate-50 font-sans overflow-x-hidden">
      <Topbar
        current={current}
        setCurrent={setCurrent}
        onLogout={onLogout}
        clubes={clubes}
        clubActivoId={clubActivoId}
        onClubChange={setClubActivoId}
        showIndependentOption={false}
      />
      <main className="max-w-6xl mx-auto px-4 py-6 grid gap-4">
        {current === "dashboard" && <Dashboard
          perfil={state.perfil}
          clases={state.clases}
          pagos={state.pagos}
          gastos={state.gastos}
          alumnos={state.alumnos}
          clubes={clubes}
          clubActivoId={clubActivoId}
          goToNewClass={(prefill) => { setPrefillClase(prefill || null); setCurrent('clases'); setTimeout(() => document.querySelector('#nueva-clase-btn')?.click(), 50); }}
          goToEditClass={goToEditClass}
        />}
        {current === "alumnos" && <Alumnos
          clases={state.clases}
          pagos={state.pagos}
          alumnos={state.alumnos}
          onCreate={alumnoCrud.create}
          onUpdate={alumnoCrud.update}
          onDelete={alumnoCrud.delete}
          onRegisterMonthlyPayment={handleRegisterMonthlyPayment}
          onRegistrarClase={openRegistrarClaseForAlumno}
          onPagarPendiente={openPagoPendiente}
          onEditarPago={(pago) => setPagoParaEditar(pago)}
          onDeletePago={handleDeletePago}
          user={user}
          clubActivoId={clubActivoId}
          perfil={state.perfil}
        />}
        {current === "clases" && <Clases
          clases={state.clases}
          alumnos={state.alumnos}
          pagos={state.pagos}
          perfil={state.perfil}
          onCreate={claseCrud.create}
          onUpdate={claseCrud.update}
          onDelete={claseCrud.delete}
          onPay={(clase) => setPayingClase(clase)}
          user={user}
          claseParaEditar={claseParaEditar}
          setClaseParaEditar={setClaseParaEditar}
          nuevoAlumnoId={nuevoAlumnoId}
          setNuevoAlumnoId={setNuevoAlumnoId}
          prefillClase={prefillClase}
          onPrefillConsumed={() => setPrefillClase(null)}
          grupos={state.grupos}
          clubActivoId={clubActivoId}
        />}
        {current === "grupos" && <Grupos alumnos={state.alumnos} user={user} />}
        {current === "pagos" && <Pagos pagos={state.pagos} alumnos={state.alumnos} clases={state.clases} perfil={state.perfil} onPayMensual={(alumno, mes) => setPayingCuota({ alumno, mes })} onEditarPago={(pago) => setPagoParaEditar(pago)} onDeletePago={handleDeletePago} />}
        {current === "gastos" && <Gastos gastos={state.gastos} onCreate={gastoCrud.create} onUpdate={gastoCrud.update} onDelete={gastoCrud.delete} />}
        {current === "reportes" && <Reportes pagos={state.pagos} gastos={state.gastos} alumnos={state.alumnos} clases={state.clases} clubActivoId={clubActivoId} clubes={clubes} perfil={state.perfil} />}
        {current === "perfil" && <Perfil
          perfil={state.perfil}
          alumnos={state.alumnos}
          clases={state.clases}
          pagos={state.pagos}
          gastos={state.gastos}
          grupos={state.grupos}
          onUpdate={perfilCrud.update}
          user={user}
          setToast={setToast}
          getCollection={getCollection}
          perfilCrud={perfilCrud}
        />}
      </main>
      <Toast msg={toast} onClose={() => setToast("")} />
      <Modal isOpen={!!deletingInfo.id} title={`Eliminar ${deletingInfo.type}`} onConfirm={confirmDelete} onCancel={() => setDeletingInfo({ id: null, type: null, collection: null })} >
        ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.
      </Modal>
      <PagoGrupalModal
        isOpen={!!payingClase}
        clase={payingClase}
        alumnos={state.alumnos}
        onCancel={() => { setPayingClase(null); setFocusAlumnoId(null); }}
        focusAlumnoId={focusAlumnoId} onSave={pagoCrud.createPagosClase}
      />
      <RegistroPagoMensualModal
        isOpen={!!registrandoAbono}
        alumno={registrandoAbono}
        perfil={state.perfil}
        onCancel={() => setRegistrandoAbono(null)}
        onSave={(pagoData) => pagoCrud.createAbono(pagoData, registrandoAbono)}
      />
      <PagoMensualModal isOpen={!!payingCuota.alumno} alumno={payingCuota.alumno} mes={payingCuota.mes} onCancel={() => setPayingCuota({ alumno: null, mes: null })} onSave={pagoCrud.createMensual} />
      <EditarPagoModal
        isOpen={!!pagoParaEditar}
        pago={pagoParaEditar}
        onCancel={() => setPagoParaEditar(null)}
        onSave={pagoCrud.update}
            />
            <AgendarProximaClaseModal
          isOpen={!!claseParaAgendar}
          onClose={() => setClaseParaAgendar(null)}
          onSchedule={claseCrud.create}
          claseBase={claseParaAgendar}
          alumnos={state.alumnos}
      />
      <footer className="text-center text-xs text-slate-500 py-6">Coachex-Pro ¬∑ Gesti√≥n de Profesores</footer>
    </div>
  );
}

function AgendarProximaClaseModal({ isOpen, onClose, onSchedule, claseBase, alumnos }) {
  // -- Helpers --
  const parseYMDLocal = (ymd) => {
    if (!ymd) return new Date();
    const [y, m, d] = ymd.split("-").map(Number);
    return new Date(y, (m || 1) - 1, d || 1, 0, 0, 0, 0);
  };

  // TIPOS_CLASE_MAP global si existe (en tu app suele existir). Si no, parseo del texto.
  const TIPOS_CLASE_MAP_LOCAL =
    (typeof TIPOS_CLASE_MAP !== "undefined" && TIPOS_CLASE_MAP) || null;

  const requiredCountFromTipo = (tipo) => {
    if (TIPOS_CLASE_MAP_LOCAL && TIPOS_CLASE_MAP_LOCAL[tipo]) {
      return TIPOS_CLASE_MAP_LOCAL[tipo];
    }
    const m = /Clase\s+(\d+)/i.exec(tipo || "");
    return m ? Math.max(1, parseInt(m[1], 10) || 1) : 1;
  };

  const resizeAlumnoIds = (prevIds, n) => {
    const arr = Array.isArray(prevIds) ? [...prevIds] : [];
    if (arr.length < n) {
      while (arr.length < n) arr.push("");
    } else if (arr.length > n) {
      arr.length = n;
    }
    return arr;
  };

  // -- Estado inicial (respetando zona horaria local) --
  const baseDate = claseBase?.fecha ? parseYMDLocal(claseBase.fecha) : new Date();
  const nextWeekDate = addDays(baseDate, 7);
  const tipoInicial = normalizarTipoClase(claseBase?.tipo) || "Clase 1 persona";
  const reqInicial = requiredCountFromTipo(tipoInicial);

  const [form, setForm] = useState(() => ({
    fecha: formatDate(nextWeekDate),
    hora: claseBase?.hora || "",
    precio: claseBase?.precio || 0,
    tipo: tipoInicial,
    alumnoIds: resizeAlumnoIds(claseBase?.alumnoIds || [], reqInicial),
  }));

  const alumnoMap = useMemo(
    () => new Map((alumnos || []).map((a) => [a.id, a])),
    [alumnos]
  );

  useEffect(() => {
    if (claseBase) {
      const base = parseYMDLocal(claseBase.fecha);
      const next = addDays(base, 7);
      const tipo = normalizarTipoClase(claseBase.tipo) || "Clase 1 persona";
      const req = requiredCountFromTipo(tipo);
      setForm({
        fecha: formatDate(next),
        hora: claseBase.hora || "",
        precio: claseBase.precio || 0,
        tipo,
        alumnoIds: resizeAlumnoIds(claseBase.alumnoIds || [], req),
      });
    }
  }, [claseBase]);

  const handleFormChange = (e) => {
    const { name, value } = e.target;
    if (name === "tipo") {
      const canon = normalizarTipoClase(value);
      const req = requiredCountFromTipo(canon);
      setForm((prev) => ({
        ...prev,
        tipo: canon,
        alumnoIds: resizeAlumnoIds(prev.alumnoIds, req),
      }));
      return;
    }
    setForm((prev) => ({ ...prev, [name]: value }));
  };

  const handleAlumnoChange = (index, newId) => {
    setForm((prev) => {
      const next = [...(prev.alumnoIds || [])];
      next[index] = newId;
      return { ...prev, alumnoIds: next };
    });
  };

  const handleSchedule = () => {
    if (!form.fecha || !form.hora || (form.alumnoIds || []).length === 0) {
      alert("Por favor, completa la fecha, hora y al menos un alumno.");
      return;
    }
    onSchedule(form);
    onClose();
  };

  const getNombreCompleto = (a) =>
    a ? `${a.apellido || ""} ${a.nombre || ""}`.trim() : "Alumno eliminado";
  const alumnosActivos = (alumnos || []).filter((a) => a.estado === "activo");

  if (!isOpen || !claseBase) return null;

  return (
    <Modal
      isOpen={isOpen}
      title="Agendar pr√≥xima clase"
      onCancel={onClose}
      onConfirm={handleSchedule}
      confirmText="Agendar Clase"
      size="2xl"
    >
      <div className="space-y-4">
        <p className="text-sm text-slate-600">
          Se acaba de registrar el pago para la clase de hoy. ¬øDeseas agendar la pr√≥xima?
        </p>

        <div className="grid md:grid-cols-2 gap-4 p-4 border rounded-xl bg-slate-50">
          <div>
            <label className="text-sm text-slate-600">Fecha</label>
            <input
              type="date"
              name="fecha"
              value={form.fecha}
              onChange={handleFormChange}
              className="w-full border rounded-lg px-3 py-2 mt-1"
            />
          </div>

          <div>
            <label className="text-sm text-slate-600">Hora</label>
            <input
              type="time"
              name="hora"
              value={form.hora}
              onChange={handleFormChange}
              className="w-full border rounded-lg px-3 py-2 mt-1"
            />
          </div>

          <div>
            <label className="text-sm text-slate-600">Precio</label>
            <input
              type="number"
              name="precio"
              value={form.precio}
              onChange={handleFormChange}
              className="w-full border rounded-lg px-3 py-2 mt-1"
            />
          </div>

          <div>
            <label className="text-sm text-slate-600">Tipo de Clase</label>
            <select
              name="tipo"
              value={form.tipo}
              onChange={handleFormChange}
              className="w-full border rounded-lg px-3 py-2 mt-1"
            >
              {TIPOS_CLASE.map((t) => (
                <option key={t}>{t}</option>
              ))}
            </select>
          </div>
        </div>

        <div className="p-4 border rounded-xl bg-slate-50">
          <label className="text-sm text-slate-600">Alumnos</label>
          <div className="grid gap-2 mt-1">
            {(form.alumnoIds || []).map((alumnoId, index) => (
              <div key={index}>
                <select
                  value={alumnoId}
                  onChange={(e) => handleAlumnoChange(index, e.target.value)}
                  className="w-full border rounded-lg px-3 py-2"
                >
                  <option value="">Seleccionar...</option>
                  {alumnosActivos.map((a) => (
                    <option key={a.id} value={a.id}>
                      {getNombreCompleto(a)}
                    </option>
                  ))}
                </select>
              </div>
            ))}
          </div>
        </div>
      </div>
    </Modal>
  );
}



    // ------------------------------ APP WRAPPER WITH AUTH ------------------------------
    function AppGPadel() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(user => {
                setUser(user);
                setLoading(false);
            });
            return () => unsubscribe();
        }, []);

        if (loading) {
            return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;
        }

        if (!user) {
            return <LoginScreen />;
        }

        return <MainApp user={user} onLogout={() => auth.signOut()} />;
    }
    
    
class ErrorBoundary extends React.Component {
  constructor(props) { super(props); this.state = { hasError: false }; }
  static getDerivedStateFromError() { return { hasError: true }; }
  componentDidCatch(error, info) { console.error("Error en ErrorBoundary:", error, info); }
  render() {
    if (this.state.hasError) {
      return <div className="p-6 text-center text-red-700">Ocurri√≥ un error en la vista. Prob√° recargar o volver al inicio.</div>;
    }
    return this.props.children;
  }
}

ReactDOM.render(<ErrorBoundary><AppGPadel /></ErrorBoundary>, document.getElementById('root'));
</script>

</body>
</html>
