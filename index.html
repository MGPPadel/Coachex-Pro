<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>Coachex-Pro ‚Äì Gesti√≥n para Profesores</title>
  
<script src="https://cdn.tailwindcss.com"></script>

<script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>



  <style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    
  }
</style>
<link rel="icon" type="image/png" href="./logo_favicon.png">
<link rel="apple-touch-icon" href="./logo_favicon.png">
<meta name="theme-color" content="#34745B">
<link rel="manifest" href="./manifest.json">

<style id="dual-pulse-loader">
    :root{
      --loader-brand-dark:#34745B;   /* verde del logo */
      --loader-brand-light:#89C5B2;  /* verde claro de la app */
      --loader-inner:#3f3f41;        /* gris interno */
      --loader-size:56px;            /* tama√±o */
    }
    .loader{
      width:var(--loader-size);
      height:var(--loader-size);
      border-radius:50%;
      position:relative;
      background: radial-gradient(circle at 30% 30%, var(--loader-brand-light), var(--loader-brand-dark));
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      animation: loader-pulse-out 1.5s ease-in-out infinite;
      transform-origin:center center;
    }
    .loader::after{
      content:"";
      position:absolute; inset:0; margin:auto;
      width:58%; height:58%;
      border-radius:50%;
      background: var(--loader-inner);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.85);
      animation: loader-pulse-in 1.5s ease-in-out infinite;
      transform-origin:center center;
    }
    @keyframes loader-pulse-out{
      0%,100%{ transform:scale(1); opacity:1; }
      50%    { transform:scale(1.18); opacity:.85; }
    }
    @keyframes loader-pulse-in{
      0%,100%{ transform:scale(1); opacity:.9; }
      50%    { transform:scale(0.82); opacity:.75; }
    }
    @media (prefers-reduced-motion: reduce){
      .loader, .loader::after{ animation:none; }
    }
  </style>


<style id="a4-clean-export-styles">
/* A4 CLEAN EXPORT v2 */
#a4-sheet{width:1123px;min-height:794px;background:#fff;color:#0f172a;padding:40px 48px;box-sizing:border-box;border-radius:12px;box-shadow:0 0 0 1px rgba(0,0,0,.04)}
#a4-header{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:12px}
#a4-brand{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800;font-size:22px;margin:0 auto}
#a4-brand img{width:28px;height:28px;border-radius:9999px;object-fit:cover}
#a4-title{font-size:26px;line-height:1.2;font-weight:800;text-align:center;margin-top:4px}
#a4-sub{font-size:12px;line-height:1.5;color:#64748b;text-align:center}
#a4-section{margin-top:16px;display:flex;flex-direction:column;gap:8px}
.a4-card{border:1px solid #e2e8f0;border-radius:10px;padding:10px}
.a4-grid{display:grid;grid-template-columns:1fr;gap:10px}
.a4-row{display:flex;justify-content:space-between;gap:10px;font-size:12px;line-height:1.4}
.a4-muted{color:#64748b}
.a4-item{
  border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px;line-height:1.4;white-space:normal;word-break:break-word
}
#a4-sheet a{color:#0ea5e9;text-decoration:none}
</style>

</head>
<body>
  
  <div id="root"></div>

  <script type="text/babel">


    // --- INICIO DEL C√ìDIGO DE LA APLICACI√ìN ---

    const { useEffect, useMemo, useState, createContext, useContext } = React;

    /**
     * Gesti√≥n de P√°del ‚Äì MVP en React (Canvas) - v25 con Perfil Extendido
     *
     * Cambios aplicados:
     * - (PERFIL) Se a√±aden secciones para Datos Bancarios, Horario Laboral y Pol√≠ticas de Cancelaci√≥n.
     * - (PERFIL) Se a√±ade funcionalidad para copiar datos bancarios al portapapeles.
     * - (CALENDARIO) El calendario ahora lee el Horario Laboral y sombrea las horas no disponibles.
     */

    // ------------------------------ Configuraci√≥n de Firebase ------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDU33ryp3wkbx0oJdhjC6pG3VkfNiqGk0Q",
      authDomain: "coachex-b1d9b.firebaseapp.com",
      projectId: "coachex-b1d9b",
      storageBucket: "coachex-b1d9b.appspot.com",
      messagingSenderId: "894665560100",
      appId: "1:894665560100:web:e8a61e0849f7675e1f88b1"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const _db = db;

function pagosRef(user, clubId){
  return db.collection("users").doc(user.uid).collection("clubs").doc(clubId).collection("pagos");
}
function clasesRef(user, clubId){
  return db.collection("users").doc(user.uid).collection("clubs").doc(clubId).collection("clases");
}
function mensualidadesRef(user, clubId){
  return db.collection("users").doc(user.uid).collection("clubs").doc(clubId).collection("mensualidades");
}

// === Sumar puntos a un ranking concreto: rankings/{rankingId}/items/{jugadorId} ===
async function updateRankingPuntosEn(clubId, rankingId, jugadorId, delta, extraStats = {}) {
  try {
    const uid = firebase.auth().currentUser?.uid;
    if (!uid) { console.warn("updateRankingPuntosEn: no hay usuario"); return; }
    if (!clubId || !rankingId || !jugadorId) { console.warn("updateRankingPuntosEn args inv√°lidos", {clubId, rankingId, jugadorId}); return; }

    const ref = db.collection('users').doc(String(uid))
      .collection('clubs').doc(String(clubId))
      .collection('rankings').doc(String(rankingId))
      .collection('items').doc(String(jugadorId));

    await ref.set({
      puntos: firebase.firestore.FieldValue.increment(Number(delta || 0)),
      pj:     firebase.firestore.FieldValue.increment(Number(extraStats.pj || 0)),
      pg:     firebase.firestore.FieldValue.increment(Number(extraStats.pg || 0)),
      pe:     firebase.firestore.FieldValue.increment(Number(extraStats.pe || 0)),
      pp:     firebase.firestore.FieldValue.increment(Number(extraStats.pp || 0)),
      wo:     firebase.firestore.FieldValue.increment(Number(extraStats.wo || 0)),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch (e) {
    console.error('updateRankingPuntosEn error', e);
  }
}

// (Opcional) Mantener el nombre viejo para no romper llamadas antiguas
async function updateRankingPuntos(clubId, jugadorId, puntos) {
  const rankingId = window.__rankingDefaultId || null; // si quer√©s un default global
  if (!rankingId) { console.warn('No hay ranking destino por defecto.'); return; }
  return updateRankingPuntosEn(clubId, rankingId, jugadorId, puntos, { pj: 1 });
}

function Page({ children }) {
  return (
    <div className="py-6 md:py-8 px-4 sm:px-8 lg:px-12 xl:px-16">
      <div className="max-w-[1200px] mx-auto">
        {children}
      </div>
    </div>
  );
}
    
  
    // ------------------------------ Constantes y Utilidades ------------------------------
    const initialState = { 
      alumnos: [], 
      clases: [], 
      pagos: [], 
      gastos: [],
      perfil: {
        nombre: "Profe",
        apellido: "P√°del",
        telefono: "",
        precios: {},
        preciosMensuales: {},
        metodoCobro: "porClase",
        modoTrabajo: "Club",
        canchas: "",
        canchasUbicaciones: [],
        // --- NUEVOS CAMPOS A√ëADIDOS ---
        datosBancarios: {
          alias: "",
          cbu: "",
          banco: "",
          titular: ""
        },
        politicasCancelacion: "Las clases deben cancelarse con 24hs de antelaci√≥n para no ser cobradas.",
        horarioLaboral: [
          { dia: "Lunes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Martes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Mi√©rcoles", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Jueves", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Viernes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "S√°bado", activo: false, desde: "10:00", hasta: "14:00" },
          { dia: "Domingo", activo: false, desde: "10:00", hasta: "14:00" },
        ]
        // --- FIN DE NUEVOS CAMPOS ---
      }
    };
    
    const DIAS_SEMANA_NOMBRES = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
    const MESES_NOMBRES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    const DEPORTES = ["P√°del", "Tenis"];
    const ESTADOS_ALUMNO = [{value: "activo", label: "Activo"}, {value: "espera", label: "Lista de espera"}];
    const ESTADOS_CLASE = ["Programada", "Realizada", "Cancelada", "Ausente"];
const TIPOS_CLASE_MAP = { "Clase 1 persona": 1, "Clase 2 personas": 2, "Clase 3 personas": 3, "Clase 4 personas": 4, Escuelita: 1, Grupal: 1 };
const TIPOS_CLASE = Object.keys(TIPOS_CLASE_MAP);

const PRECIO_KEY_POR_TIPO = {
  "Clase 1 persona": "individual",
  "Clase 2 personas": "dupla",
  "Clase 3 personas": "trio",
  "Clase 4 personas": "cuarteto",
  "Escuelita": "escuelita"
};

// Mapeo consistente de 'tipo' -> clave de precios del perfil
// ====== REEMPLAZA TU FUNCI√ìN 'normalizarTipoClase' CON ESTA ======

function normalizarTipoClase(t) {
  if (!t) return "Clase 1 persona";
  
  const s = String(t).trim().toLowerCase().replace(/clase\s+para\s+/, '').replace(/^clase\s+/, '').replace(/\s+de\s+/, ' ').replace(/\s+/g, ' ');

  const alias = {
    'individual': 'Clase 1 persona',
    '1': 'Clase 1 persona',
    '1 persona': 'Clase 1 persona',
    'dupla': 'Clase 2 personas',
    '2': 'Clase 2 personas',
    '2 personas': 'Clase 2 personas',
    'trio': 'Clase 3 personas',
    '3': 'Clase 3 personas',
    '3 personas': 'Clase 3 personas',
    'cuarteto': 'Clase 4 personas',
    '4': 'Clase 4 personas',
    '4 personas': 'Clase 4 personas',
    'escuelita': 'Escuelita',
    'grupal': 'Grupal' // <-- ¬°LA L√çNEA A√ëADIDA QUE SOLUCIONA TODO!
  };
  if (alias[s]) return alias[s];

  // Si el tipo es exactamente uno de los de la lista (con may√∫sculas/min√∫sculas correctas)
  const tipoDirecto = TIPOS_CLASE.find(tc => tc.toLowerCase() === s);
  if (tipoDirecto) return tipoDirecto;

  const m = s.match(/^(\d)\s*personas?$/);
  if (m) {
    const n = Number(m[1]);
    if (n === 1) return 'Clase 1 persona';
    if (n > 1 && n <= 4) return `Clase ${n} personas`;
  }
  
  return 'Clase 1 persona'; // Valor por defecto si nada coincide
}
const getPrecioSugerido = (tipo, perfil) => {
  const key = PRECIO_KEY_POR_TIPO[tipo] || "individual";

  // CORRECCI√ìN: Busca en preciosClase (nuevo) o precios (antiguo)
  const tabla = (perfil && perfil.preciosClase) 
    ? perfil.preciosClase 
    : ((perfil && perfil.precios) ? perfil.precios : {});

  function resolveTipoEfectivo(tipoOriginal, alumnoIds) {
  const n = (alumnoIds || []).filter(Boolean).length;

  // Si ya es Escuelita, respetamos
  if (String(tipoOriginal).trim().toLowerCase() === 'escuelita') return 'Escuelita';

  // Si hay 4 o m√°s, usamos Escuelita
  if (n >= 4) return 'Escuelita';

  // Caso contrario, mantenemos el tipo declarado
  return tabla[key] ?? 0;
}


const computePrecioClase = (tipo, alumnoIds, perfil, alumnoMap) => {
  // üëá ajustar tipo seg√∫n cantidad (4+ => Escuelita)
  const tipoEfectivo = resolveTipoEfectivo(tipo, alumnoIds);

  // precio por alumno seg√∫n el tipo efectivo
  const perAlumno = parseFloat(getPrecioSugerido(tipoEfectivo, perfil) || 0);

  const ids = (alumnoIds || []).filter(Boolean);

  // Si a√∫n no hay IDs, usamos el fallback del tipo *original*
  const fallbackCount = TIPOS_CLASE_MAP[tipo] || 1;

  // Contar cu√°ntos NO son mensuales (para cobrarles por clase)
  const noMensuales = ids.filter(id => {
    const a = alumnoMap.get(id);
    return a ? (a.plan !== 'mensual') : true;
  }).length;

  const count = ids.length > 0 ? (noMensuales || ids.length) : fallbackCount;

  return (perAlumno * count).toString();
};

  return tabla[key] ?? "";
};

    const TIPOS_CLASE_NOMBRES = { "Clase 1 persona": "Clase 1 persona", "Clase 2 personas": "Clase 2 personas", "Clase 3 personas": "Clase 3 personas", "Clase 4 personas": "Clase 4 personas", Escuelita: "Escuelita" };
    const METODOS_PAGO = ["Efectivo", "Transferencia", "Mixto", "Mensual","Pendiente"];
    const CATEGORIAS_GASTO = ["Alquiler", "Equipamiento", "Servicios", "Varios"];
    // Alias para compatibilidad con componentes que usan CATEGORIAS_GASTOS
    const CATEGORIAS_GASTOS = CATEGORIAS_GASTO;

    const PLANES_PAGO = [{value: "porClase", label: "Por Clase"}, {value: "mensual", label: "Mensual"}, {value: "grupo_mensual", label: "Grupo Mensual"}];    const FRECUENCIAS_MENSUALES = [{value: "1xSemana", label: "1 vez por semana"}, {value: "2xSemana", label: "2 veces por semana"}, {value: "3xSemana", label: "3 veces por semana"}, {value: "libre", label: "Libre"}];
    const MESES_RECURRENCIA = [1, 2, 3, 4, 5, 6, 9, 12];
    const HORAS = Array.from({ length: 16 }, (_, i) => `${String(i + 7).padStart(2, '0')}:00`); // De 07:00 a 22:00
    
    // --- Utilidades ---
// Quita "Clase" o "Clase para" del nombre can√≥nico para evitar "clase de Clase ..."
function labelSinClase(tipo) {
  const base = (TIPOS_CLASE_NOMBRES?.[tipo] ?? tipo ?? '').trim();
  return base.replace(/^Clase\s+(?:para\s+)?/i, '').trim();
}
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toDigits = (s = "") => String(s).replace(/[^0-9]/g, "");
    
    // --- FUNCI√ìN MODIFICADA ---
    const waLink = (telefono = "", nombre = "", customMsg = "") => {
      const digits = toDigits(telefono);
      if (!digits) return null;
      
      // Si hay un mensaje personalizado, lo usamos. Si no, usamos el mensaje por defecto.
      const msgText = customMsg 
        ? customMsg 
        : `Hola ${nombre || ""}!`;
        
      const msg = encodeURIComponent(msgText);
      return `https://wa.me/${digits}?text=${msg}`;
    };
    // --- FIN DE LA MODIFICACI√ìN ---

    const getWeekStartDate = (date) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setHours(0, 0, 0, 0);
      return new Date(d.setDate(diff));
    };
    const parseYMDLocal = (ymd) => {
  if (!ymd || typeof ymd !== 'string') return null;
  const [y, m, d] = ymd.split('-').map(Number);
  return new Date(y, (m || 1) - 1, d || 1, 0, 0, 0, 0);
};
    const addDays = (date, days) => {
  const base = (date instanceof Date) ? date : parseYMDLocal(String(date)) || new Date(date);
  const y = base.getFullYear(), m = base.getMonth(), d = base.getDate();
  return new Date(y, m, d + Number(days || 0), 0, 0, 0, 0);
};
    const formatDate = (date, format = 'yyyy-mm-dd') => {
  if (!date) return '';
  const d = (typeof date === 'string') ? parseYMDLocal(date) : new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  if (format === 'dd/mm') return `${day}/${month}`;
  if (format === 'dd/mm/yyyy') return `${day}/${month}/${year}`;
  return `${year}-${month}-${day}`;
};
// Devuelve "Lunes 08/09/2025"
function labelDiaConFecha(yyyy_mm_dd) {
  const d = new Date(`${yyyy_mm_dd}T00:00:00`);
  const dayIdx = (d.getDay() === 0 ? 6 : d.getDay() - 1); // 0..6 (Lun..Dom)
  const nombre = DIAS_SEMANA_NOMBRES[dayIdx] || "";
  return `${nombre} ${formatDate(yyyy_mm_dd, 'dd/mm/yyyy')}`;
}
// Frecuencias incluidas por plan
const FRECUENCIAS_MENSUALES_INCLUIDAS = {
  "1xSemana": 4, "2xSemana": 8, "3xSemana": 12, "libre": 9999
};

const esClaseQueGeneraCobro = (c) =>
  ['realizada', 'ausente'].includes(String(c?.estado || '').toLowerCase());

const mesClave = (date) => {
  const d = (typeof date === 'string') ? parseYMDLocal(date) : (date instanceof Date ? date : new Date(date));
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
};

// Lee precios mensuales desde Perfil
function calcularMensualidadDesdePerfil(perfil, alumno) {
  const freq = alumno?.frecuencia || "1xSemana";

  // Cantidades incluidas (esto NO es precio)
  const mapIncl = { "1xSemana": 4, "2xSemana": 8, "3xSemana": 12, "4xSemana": 16, "libre": 9999 };
  const incluidas = mapIncl[freq] ?? 4;

  // ‚úÖ SOLO Perfil -> preciosMensuales
  const raw = perfil?.preciosMensuales?.[freq];

  // Devolv√© el monto crudo convertido a n√∫mero (si no est√°, queda NaN/0 y lo validamos en el flujo)
  const monto = Number(raw);

  return { incluidas, monto };
}

// Crea/asegura doc de mensualidad del mes
async function ensureMensualidadParaAlumno({ user, clubId, alumno, fechaRef, perfil }) {
  if (!user || !clubId || !alumno) return null;
  const mes = mesClave(fechaRef || new Date());
  const id = `${alumno.id}_${mes}`;
  const ref = mensualidadesRef(user, clubId).doc(id);
  const snap = await ref.get();
  if (snap.exists) return { id, ...snap.data() };

  const freq = alumno.frecuencia || '1xSemana';
  const incl = FRECUENCIAS_MENSUALES_INCLUIDAS[freq] ?? 4;
  const monto = String(perfil?.preciosMensuales?.[freq] ?? "");

  const nueva = {
  alumnoId: alumno.id, mes, frecuencia: freq,
  incluidas: incl, consumidas: 0,
  monto,                            // ‚Üê queda "" si el profe no carg√≥ nada
  deudaExtra: "0", pagado: false, estado: "pendiente",
  creadoEn: firebase.firestore.FieldValue.serverTimestamp()
};
  await ref.set(nueva, { merge: true });
  return { id, ...nueva };
}

// Registrar pago de cuota
async function acreditarCuotaMensual({ user, clubId, alumno, mensualidad }) {
  const monto = Number(mensualidad?.monto || 0);
  const mes   = mensualidad?.mes;
  const concepto = `Cuota Mensual - ${mes}`;
  await pagosRef(user, clubId).add({
    alumnoId: alumno.id,
    fecha: new Date().toISOString().slice(0,10), // YYYY-MM-DD
    concepto, monto, metodo: "Mensual", mes
  });
  await mensualidadesRef(user, clubId).doc(mensualidad.id).set({
    pagado: true, pagadoEn: new Date().toISOString()
  }, { merge: true });
}

// Consumir 1 clase del abono (suma deuda extra si se excede)
async function consumirClaseMensual({ user, clubId, alumno, fechaClase, perfil, excedentePorClase = "0" }) {
  const m = await ensureMensualidadParaAlumno({ user, clubId, alumno, fechaRef: fechaClase, perfil });
  if (!m) return;
  const ref = mensualidadesRef(user, clubId).doc(m.id);
  const consumidas = Number(m.consumidas || 0) + 1;
  let deudaExtra = Number(m.deudaExtra || 0);
  const incl = Number(m.incluidas || 0);
  const updates = { consumidas };
  if (consumidas > incl) {
    deudaExtra += Number(excedentePorClase || 0);
    updates.deudaExtra = String(deudaExtra);
  }
  await ref.set(updates, { merge: true });
}

// Cubrir clase con abono si tiene cupo; si no, suma excedente
async function cubrirClaseConMensualidadSiCorresponde({ user, clubId, alumno, claseId, fecha, precioPorAlumno, perfil }) {
  const fechaNorm = typeof fecha === "string" ? new Date(`${fecha}T00:00:00`) : fecha;
  const m = await ensureMensualidadParaAlumno({ user, clubId, alumno, perfil, fechaRef: fechaNorm });
  if (!m) return;

  const incl = Number(m.incluidas || 0);
  const cons = Number(m.consumidas || 0);
  const tieneCupo = cons < incl;

  if (tieneCupo) {
    const q = await pagosRef(user, clubId).where("claseId", "==", claseId).get();
    const yaExiste = q.docs.some(d => {
      const p = d.data();
      return p.alumnoId === alumno.id && p.metodo === "Mensual";
    });
    if (!yaExiste) {
      await pagosRef(user, clubId).add({
        claseId, alumnoId: alumno.id, fecha,
        concepto: `Cubre por abono - ${m.mes || ""}`,
        monto: "0", metodo: "Mensual"
      });
    }
  }
  const excedente = tieneCupo ? "0" : String(precioPorAlumno || 0);
  await consumirClaseMensual({ user, clubId, alumno, fechaClase: fecha, perfil, excedentePorClase: excedente });
}

// --- Exigir abono del mes (abre el modal) y, si confirma, acredita la cuota ---
async function exigirAbonoDelMesOAvisar({ user, clubId, alumno, perfil, fechaClase, abrirModalPago }) {
  // CORRECCI√ìN: Se cambi√≥ el nombre de la variable para evitar conflicto.
  const periodoDelMes = mesClave(fechaClase || new Date());
  
  // VERIFICACI√ìN ADICIONAL: Buscamos si ya existe un pago real para este mes y alumno.
  const pagosQuery = await pagosRef(user, clubId)
    .where('alumnoId', '==', alumno.id)
    .where('periodoYM', '==', periodoDelMes) // Usamos la variable correcta aqu√≠
    .where('monto', '>', 0)
    .limit(1)
    .get();

  if (!pagosQuery.empty) {
    return; // Si ya hay un pago, no hacemos nada y salimos.
  }

  const mensualidad = await ensureMensualidadParaAlumno({ user, clubId, alumno, perfil, fechaRef: fechaClase });
  if (!mensualidad || mensualidad.pagado) return;

  // Si no hay precio configurado, avisamos y salimos
  const montoNum = Number(mensualidad.monto);
  if (!montoNum || isNaN(montoNum) || montoNum <= 0) {
    alert(`Falta configurar el precio mensual para la frecuencia "${alumno.frecuencia || '1xSemana'}" en Perfil ‚Üí Precios Mensuales.`);
    return;
  }

  const confirmado = await abrirModalPago(alumno, mensualidad.mes, montoNum);
  if (confirmado) {
    await acreditarCuotaMensual({ user, clubId, alumno, mensualidad });
  }
}

// ---------- Helpers de meses ----------
function mesSiguiente(m) { // "YYYY-MM" -> siguiente
  const [y, mm] = m.split('-').map(Number);
  const d = new Date(y, mm - 1, 1);
  d.setMonth(d.getMonth() + 1);
  const y2 = d.getFullYear();
  const m2 = String(d.getMonth() + 1).padStart(2, '0');
  return `${y2}-${m2}`;
}
function rangoMeses(desdeMes, hastaMes) { // inclusive
  const res = [];
  let cur = desdeMes;
  while (cur <= hastaMes) {
    res.push(cur);
    cur = mesSiguiente(cur);
  }
  return res;
}

// ---------- Pagar excedente manual (NO toca pago por clase) ----------
async function acreditarExcedenteMensual({ user, clubId, alumno, mes, monto, metodo = "Efectivo" }) {
  if (!user || !clubId || !alumno || !mes) return;
  await pagosRef(user, clubId).add({
    alumnoId: alumno.id,
    fecha: new Date().toISOString().slice(0,10), // YYYY-MM-DD
    concepto: `Excedente Mensual - ${mes}`,
    monto: Number(monto || 0),
    metodo,
    mes
  });
}

// ---------- Construye la cuenta corriente por meses ----------
async function buildCuentaCorrienteMensual({ user, clubId, alumno, perfil, desdeMes, hastaMes }) {
  if (!user || !clubId || !alumno) return { lineas: [], saldoAcumulado: 0 };

  // Traigo mensualidades en rango
  const mensSnap = await mensualidadesRef(user, clubId)
    .where('alumnoId', '==', alumno.id)
    .where('mes', '>=', desdeMes)
    .where('mes', '<=', hastaMes)
    .get();

  const mensualidades = {};
  mensSnap.docs.forEach(d => {
    const m = d.data();
    mensualidades[m.mes] = { id: d.id, ...m };
  });

  // Traigo pagos etiquetados con "mes" (cuotas, excedentes, etc.)
  const pagosSnap = await pagosRef(user, clubId)
    .where('alumnoId', '==', alumno.id)
    .where('mes', '>=', desdeMes)
    .where('mes', '<=', hastaMes)
    .get();

  const pagos = pagosSnap.docs.map(d => d.data());

  // Indexo pagos por mes
  const pagosPorMes = {};
  pagos.forEach(p => {
    const k = p.mes || '‚Äî';
    if (!pagosPorMes[k]) pagosPorMes[k] = [];
    pagosPorMes[k].push(p);
  });

  const meses = rangoMeses(desdeMes, hastaMes);
  let saldoAcumulado = 0;
  const lineas = meses.map(mes => {
    // Aseguro tener mensualidad (pero SIN crear nada en DB)
    const men = mensualidades[mes] || {
      alumnoId: alumno.id,
      mes,
      frecuencia: alumno.frecuencia || '1xSemana',
      incluidas: ({"1xSemana":4,"2xSemana":8,"3xSemana":12,"4xSemana":16,"libre":9999}[alumno.frecuencia || '1xSemana']) ?? 4,
      consumidas: 0,
      monto: String(perfil?.preciosMensuales?.[alumno.frecuencia || '1xSemana'] ?? ""),
      deudaExtra: "0",
      pagado: false
    };

    const cuota = Number(men.monto || 0);
    const excedente = Number(men.deudaExtra || 0);

    const lst = pagosPorMes[mes] || [];
    const pagCuota = lst
      .filter(p => p.concepto?.startsWith('Cuota Mensual'))
      .reduce((acc, p) => acc + Number(p.monto || 0), 0);
    const pagExced = lst
      .filter(p => p.concepto?.startsWith('Excedente Mensual'))
      .reduce((acc, p) => acc + Number(p.monto || 0), 0);

    const totalAPagar = cuota + excedente;
    const pagosMes = pagCuota + pagExced;
    const saldoMes = totalAPagar - pagosMes;
    saldoAcumulado += saldoMes;

    return {
      mes,
      incluidas: Number(men.incluidas || 0),
      consumidas: Number(men.consumidas || 0),
      cuota,
      excedente,
      pagCuota,
      pagExced,
      pagosMes,
      totalAPagar,
      saldoMes,
      saldoAcumulado,
      pagado: men.pagado === true
    };
  });

  return { lineas, saldoAcumulado };
}


    const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : 'Alumno eliminado';
// --- Searchable alumno picker (reusable) ---
function AlumnoSearchSelect({ value, onChange, alumnos, excludeIds = [], placeholder = "Buscar alumno...", autoFocus = false }) {
  const [open, setOpen] = React.useState(false);
  const [q, setQ] = React.useState("");
  const inputRef = React.useRef(null);
  const boxRef = React.useRef(null);

  React.useEffect(() => {
    if (autoFocus && inputRef.current) inputRef.current.focus();
  }, [autoFocus]);

  React.useEffect(() => {
    function handleClickOutside(e) {
      if (boxRef.current && !boxRef.current.contains(e.target)) setOpen(false);
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const norm = (s) => (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
  const selected = React.useMemo(() => (alumnos || []).find(a => a.id === value) || null, [alumnos, value]);
  const filtered = React.useMemo(() => {
    const needle = norm(q);
    return (alumnos || []).filter(a => !excludeIds.includes(a.id) && (!needle || norm(getNombreCompleto(a)).includes(needle)));
  }, [alumnos, excludeIds, q]);

  const showList = open && (!selected || q.length > 0);

  return (
    <div className="relative" ref={boxRef}>
      <div className="flex gap-2">
        <input
          ref={inputRef}
          type="text"
          className="w-full border rounded-lg px-3 py-2"
          placeholder={placeholder}
          value={selected && q.length === 0 ? getNombreCompleto(selected) : q}
          onFocus={() => setOpen(true)}
          onChange={(e) => { setQ(e.target.value); onChange(""); }}
        />
        {value && (
          <button
            type="button"
            className="px-2 text-slate-500 hover:text-slate-700"
            onClick={() => { onChange(""); setQ(""); setOpen(true); }}
            title="Limpiar selecci√≥n"
          >
            √ó
          </button>
        )}
      </div>
      {showList && (
        <div className="absolute z-30 mt-1 w-full bg-white border rounded-lg shadow max-h-64 overflow-auto">
          {filtered.length ? filtered.map(a => (
            <button
              type="button"
              key={a.id}
              className="w-full text-left px-3 py-2 hover:bg-slate-50"
              onClick={() => { onChange(a.id); setQ(""); setOpen(false); }}
            >
              {getNombreCompleto(a)}
            </button>
          )) : (
            <div className="px-3 py-2 text-slate-500">Sin resultados</div>
          )}
        </div>
      )}
    </div>
  );
}
    const formatCurrency = (value, { withSymbol = true } = {}) => {
  const n = Number(
    typeof value === "number"
      ? value
      : String(value ?? "")
          .replace(/\./g, "")   // quita puntos miles si vinieran
          .replace(",", ".")    // coma -> punto
          .replace(/[^0-9.-]/g, "")
  );
  const opts = { minimumFractionDigits: 0, maximumFractionDigits: 0 };
  if (withSymbol) { opts.style = "currency"; opts.currency = "ARS"; }
  return new Intl.NumberFormat("es-AR", opts).format(isFinite(n) ? n : 0);
};

// --- Normalizador robusto de horarioLaboral ---
function toArrayHorarioLaboral(hl) {
  if (!hl) return [];
  if (Array.isArray(hl)) return hl;
  if (typeof hl === 'string') {
    try { const parsed = JSON.parse(hl); return Array.isArray(parsed) ? parsed : []; } catch (e) { return []; }
  }
  if (typeof hl === 'object') {
    // Convierte objetos estilo mapa a un array de valores confiable
    try { return Object.values(hl); } catch (e) { return []; }
  }
  return [];
}


    // ------------------------------ UI B√°sicos ------------------------------
    function Card({ title, right, children }) {
  const bodyRef = React.useRef(null);

React.useEffect(() => {
    const el = bodyRef.current;
    if (!el) return;

    // ¬øHay una o m√°s tablas dentro del Card?
    const tables = el.querySelectorAll('table');
    const hasTable = tables.length > 0;

    // Aplico clases s√≥lo si hay tablas (scroll horizontal)
    el.classList.toggle('overflow-x-auto', hasTable);
    if (hasTable) {
      // Suaviza scroll en iOS
      el.style.webkitOverflowScrolling = 'touch';
      tables.forEach(t => {
        // Fuerza ancho m√≠nimo para que aparezca el scroll horizontal en pantallas chicas
        if (!t.classList.contains('min-w-[720px]')) {
          t.classList.add('min-w-[720px]');
        }
        // Asegura tipograf√≠a consistente
        if (!t.classList.contains('text-sm')) {
          t.classList.add('text-sm');
        }
      });
    }
  }, [children]);

  return (
    <section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-3 sm:p-4">
      <div className="flex items-center justify-between mb-2 sm:mb-3">
        <h3 className="text-sm sm:text-base font-semibold text-slate-800">{title}</h3>
        {right}
      </div>

      {/* Contenedor del contenido del Card (se autoajusta si detecta tablas) */}
      <div ref={bodyRef} className="text-[13px] sm:text-sm overflow-x-auto sm:overflow-visible">
        {children}
      </div>
    </section>
  );
}

    function Toast({ msg, onClose }) {
  useEffect(() => {
    if (!msg) return;
    const t = setTimeout(onClose, 2500);
    return () => clearTimeout(t);
  }, [msg, onClose]);

  if (!msg) return null;
  return (
    <div className="fixed top-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-xl shadow-xl z-50">
      {msg}
    </div>
  );
}

function Modal({
  isOpen,
  title,
  children,
  onCancel,
  onConfirm,
  confirmText = "Confirmar",
  cancelText = "Cancelar",
  size = "5xl",
}) {
  if (!isOpen) return null;

  const SIZE_CLASS =
    {
      sm: "max-w-sm",
      md: "max-w-md",
      lg: "max-w-lg",
      xl: "max-w-xl",
      "2xl": "max-w-2xl",
      "3xl": "max-w-3xl",
      "4xl": "max-w-4xl",
      "5xl": "max-w-5xl",
      "6xl": "max-w-6xl",
      "7xl": "max-w-7xl",
      wide: "max-w-[1100px]",   // ancho fijo c√≥modo
      full: "max-w-[95vw]",     // casi pantalla completa
    }[size] || "max-w-5xl";

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className={`w-[95vw] md:w-auto ${SIZE_CLASS} bg-white rounded-2xl shadow-xl overflow-hidden`}>
        <div className="px-6 py-4 border-b">
          <h2 className="text-lg font-semibold text-[#34745B]">{title}</h2>
        </div>

        {/* Contenido: alto controlado, sin scroll horizontal */}
        <div className="px-6 py-4 max-h-[75vh] overflow-y-auto overflow-x-hidden">
          {children}
        </div>

        <div className="px-6 py-4 border-t flex justify-end gap-2">
          <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg border">
            {cancelText}
          </button>
          <button type="button" onClick={onConfirm} className="px-4 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">
            {confirmText}
          </button>
        </div>
      </div>
    </div>
  );
}

function InputModal({ isOpen, title, message, onCancel, onConfirm, inputType = "text", placeholder = "" }) {
  const [value, setValue] = useState("");

  if (!isOpen) return null;

  const handleConfirm = () => {
    onConfirm(value);
    setValue(""); // Resetea para la pr√≥xima vez
  };
  
  const handleCancel = () => {
    onCancel();
    setValue("");
  }

  return (
    <Modal
      isOpen={isOpen}
      title={title}
      onCancel={handleCancel}
      onConfirm={handleConfirm}
      confirmText="Aceptar"
      size="sm"
    >
      <div className="space-y-3">
        <p className="text-sm text-slate-600">{message}</p>
        <input
          type={inputType}
          value={value}
          onChange={(e) => setValue(e.target.value)}
          placeholder={placeholder}
          className="w-full border rounded-lg px-3 py-2"
          autoFocus
        />
      </div>
    </Modal>
  );
}

function ModalPagoAbono({ open, onClose, alumno, mes, monto, onConfirm }) {
  if (!open) return null;
  return (
    <div
      className="fixed inset-0 flex items-center justify-center bg-black/50 z-50"
      role="dialog"
      aria-modal="true"
      aria-labelledby="pago-abono-title"
    >
      <div className="bg-white rounded-lg shadow-lg max-w-sm w-full p-6">
        <h2 id="pago-abono-title" className="text-lg font-semibold mb-4 text-[#34745B]">
          Pago de Abono
        </h2>
        <p className="mb-2">
          Alumno: <strong>{alumno?.apellido} {alumno?.nombre}</strong>
        </p>
        <p className="mb-2">Mes: <strong>{mes}</strong></p>
        <p className="mb-4">Monto: <strong>${monto}</strong></p>

        <div className="flex justify-end gap-3">
          <button
            type="button"
            onClick={onClose}
            className="px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-800"
          >
            Cancelar
          </button>
          <button
            type="button"
            onClick={onConfirm}
            className="px-4 py-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>
  );
}


// Hook para abrir/cerrar el modal de abono
function useModalPagoAbono() {
  const [state, setState] = React.useState({
    open: false,
    alumno: null,
    mes: "",
    monto: 0,
    resolver: null,
  });

  const abrirModalPago = React.useCallback((alumno, mes, monto) => {
    return new Promise((resolve) => {
      setState({ open: true, alumno, mes, monto, resolver: resolve });
    });
  }, []);

  const handleClose = React.useCallback(() => {
    setState((s) => {
      s.resolver && s.resolver(false);
      return { ...s, open: false, resolver: null };
    });
  }, []);

  const handleConfirm = React.useCallback(() => {
    setState((s) => {
      s.resolver && s.resolver(true);
      return { ...s, open: false, resolver: null };
    });
  }, []);

  // Componente para montar una sola vez
  const Modal = React.useCallback(() => (
    <ModalPagoAbono
      open={state.open}
      onClose={handleClose}
      alumno={state.alumno}
      mes={state.mes}
      monto={state.monto}
      onConfirm={handleConfirm}
    />
  ), [state.open, state.alumno, state.mes, state.monto, handleClose, handleConfirm]);

  return { abrirModalPago, Modal };
}

// === Iconos Nav (namespaced para evitar "Identifier 'X' has already been declared") ===
window.NavIcons = window.NavIcons || {};

// Cada asignaci√≥n solo ocurre si no exist√≠a antes
window.NavIcons.Home = window.NavIcons.Home || function NavIconHome(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={p.className}>
      <path strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round" d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5z"/>
    </svg>
  );
};

window.NavIcons.Users = window.NavIcons.Users || function NavIconUsers(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={p.className}>
      <path strokeWidth="1.8" strokeLinecap="round" d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
      <circle cx="9" cy="7" r="3" strokeWidth="1.8"/>
      <path strokeWidth="1.8" strokeLinecap="round" d="M22 21v-2a4 4 0 0 0-3-3.87"/>
      <path strokeWidth="1.8" d="M16 3.13a4 4 0 0 1 0 7.75"/>
    </svg>
  );
};

window.NavIcons.Calendar = window.NavIcons.Calendar || function NavIconCalendar(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={p.className}>
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeWidth="1.8"/>
      <line x1="16" y1="2" x2="16" y2="6" strokeWidth="1.8"/>
      <line x1="8" y1="2" x2="8" y2="6" strokeWidth="1.8"/>
      <line x1="3" y1="10" x2="21" y2="10" strokeWidth="1.8"/>
    </svg>
  );
};

window.NavIcons.Layers = window.NavIcons.Layers || function NavIconLayers(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={p.className}>
      <polygon points="12 2 22 8 12 14 2 8 12 2" strokeWidth="1.8"/>
      <polyline points="2 12 12 18 22 12" strokeWidth="1.8"/>
    </svg>
  );
};

window.NavIcons.Cash = window.NavIcons.Cash || function NavIconCash(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={p.className}>
      <rect x="2" y="6" width="20" height="12" rx="2" strokeWidth="1.8"/>
      <circle cx="12" cy="12" r="3" strokeWidth="1.8"/>
      <path d="M6 10h0 M18 14h0" strokeWidth="2" strokeLinecap="round"/>
    </svg>
  );
};

window.NavIcons.Receipt = window.NavIcons.Receipt || function NavIconReceipt(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={p.className}>
      <path d="M7 21l5-2 5 2V4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2z" strokeWidth="1.8"/>
      <path d="M9 7h6M9 11h6M9 15h6" strokeWidth="1.8" strokeLinecap="round"/>
    </svg>
  );
};

window.NavIcons.Chart = window.NavIcons.Chart || function NavIconChart(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={p.className}>
      <path d="M3 3v18h18" strokeWidth="1.8"/>
      <rect x="7" y="12" width="3" height="6" strokeWidth="1.8"/>
      <rect x="12" y="9" width="3" height="9" strokeWidth="1.8"/>
      <rect x="17" y="6" width="3" height="12" strokeWidth="1.8"/>
    </svg>
  );
};

window.NavIcons.User = window.NavIcons.User || function NavIconUser(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className={p.className}>
      <circle cx="12" cy="7" r="4" strokeWidth="1.8"/>
      <path d="M4 21a8 8 0 0 1 16 0" strokeWidth="1.8"/>
    </svg>
  );
};

window.NavIcons.Logout = window.NavIcons.Logout || function NavIconLogout(p){
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round" className={p.className}>
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
      <polyline points="16 17 21 12 16 7" />
      <line x1="21" y1="12" x2="9" y2="12" />
    </svg>
  );
};

function MoreMenuSheet({ isOpen, onClose, tabs, current, setCurrent, onLogout }) {
  if (!isOpen) return null;

  // Obtenemos el √≠cono de Logout, con un respaldo por si no carga
  const IconLogout = window.NavIcons?.Logout || function(p){ return <svg {...p} /> };

  return (
    <div
      className="fixed inset-0 z-50 md:hidden"
      onClick={onClose}
      aria-modal="true"
      role="dialog"
    >
      {/* Fondo oscuro */}
      <div className="absolute inset-0 bg-black/40 transition-opacity"></div>

      {/* Panel deslizable */}
      <div
        className="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-lg transition-transform transform translate-y-full"
        style={{ transform: isOpen ? 'translateY(0)' : 'translateY(100%)' }}
        onClick={(e) => e.stopPropagation()}
      >
        <div className="p-4 border-b">
          <h3 className="text-center font-semibold text-slate-700">M√°s Opciones</h3>
        </div>
        <nav className="p-2">
          <ul className="space-y-1">
            {/* Las pesta√±as existentes no cambian */}
            {tabs.map(t => {
              const Icon = t.icon;
              const isActive = current === t.id;
              return (
                <li key={t.id}>
                  <button
                    onClick={() => {
                      setCurrent(t.id);
                      onClose();
                    }}
                    className={`w-full flex items-center gap-4 px-3 py-3 rounded-lg text-left text-slate-800 ${
                      isActive ? 'bg-emerald-50 text-emerald-800 font-semibold' : 'hover:bg-slate-100'
                    }`}
                  >
                    <Icon className="h-6 w-6" />
                    <span>{t.label}</span>
                  </button>
                </li>
              );
            })}

            {/* --- INICIO DEL C√ìDIGO A√ëADIDO --- */}
            {/* Separador visual */}
            <li>
              <div className="px-3 py-2">
                <div className="h-px bg-slate-200"></div>
              </div>
            </li>
            {/* Bot√≥n de Cerrar Sesi√≥n */}
            <li>
              <button
                onClick={() => {
                  if (onLogout) onLogout();
                  onClose();
                }}
                className="w-full flex items-center gap-4 px-3 py-3 rounded-lg text-left text-rose-600 hover:bg-rose-50"
              >
                <IconLogout className="h-6 w-6" />
                <span>Cerrar Sesi√≥n</span>
              </button>
            </li>
            {/* --- FIN DEL C√ìDIGO A√ëADIDO --- */}

          </ul>
        </nav>
      </div>
    </div>
  );
}
    
function SideNav({
  current,
  setCurrent,
  onLogout,
  clubes = [],
  clubActivoId,
  onClubChange,
  expanded = false,
  onExpandChange,
}) {

const [isMoreMenuOpen, setIsMoreMenuOpen] = React.useState(false);
  // ===== Fallback icons (monocromo, stroke=currentColor) =====
  const ic = {
    Home: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M3 10.5 12 3l9 7.5" />
        <path d="M5 10v10h14V10" />
        <path d="M9 20v-6h6v6" />
      </svg>
    ),
    Users: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
      </svg>
    ),
    Calendar: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <rect x="3" y="4" width="18" height="18" rx="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
      </svg>
    ),
    Layers: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <polygon points="12 2 2 7 12 12 22 7 12 2" />
        <polyline points="2 12 12 17 22 12" />
        <polyline points="2 17 12 22 22 17" />
      </svg>
    ),
    Cash: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <rect x="2" y="6" width="20" height="12" rx="2" />
        <circle cx="12" cy="12" r="3" />
        <path d="M18 8h.01M6 16h.01" />
      </svg>
    ),
    Receipt: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M4 2v20l3-2 3 2 3-2 3 2 3-2V2z" />
        <path d="M8 7h8M8 11h8M8 15h5" />
      </svg>
    ),
    Chart: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M3 3v18h18" />
        <rect x="7" y="8" width="3" height="8" />
        <rect x="12" y="5" width="3" height="11" />
        <rect x="17" y="11" width="3" height="5" />
      </svg>
    ),
    User: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M20 21a8 8 0 0 0-16 0" />
        <circle cx="12" cy="7" r="4" />
      </svg>
    ),
    Trophy: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M8 21h8" />
        <path d="M12 17v4" />
        <path d="M7 4h10v3a5 5 0 0 1-5 5 5 5 0 0 1-5-5V4z" />
        <path d="M5 7a3 3 0 0 1-3-3V3h5v4" />
        <path d="M19 7a3 3 0 0 0 3-3V3h-5v4" />
      </svg>
    ),
    Brackets: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M6 4H4v6h2c2 0 4 2 4 4v6H8v-6c0-1.1-.9-2-2-2H4" />
        <path d="M18 4h2v6h-2c-2 0-4 2-4 4v6h2v-6c0-1.1.9-2 2-2h2" />
      </svg>
    ),
    Logout: ({ className = "" }) => (
      <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
        <polyline points="16 17 21 12 16 7" />
        <line x1="21" y1="12" x2="9" y2="12" />
      </svg>
    ),
  };

  // Usa set de √≠conos si existe; sino, fallback
  const I = (name, fallback) => (window.NavIcons && window.NavIcons[name]) || fallback;

  const IconMore = ({ className }) => (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
      <circle cx="12" cy="12" r="1" /><circle cx="19" cy="12" r="1" /><circle cx="5" cy="12" r="1" />
    </svg>
  );

    const allTabs = [
    { id: "dashboard", label: "Dashboard", icon: I("Home", ic.Home) },
    { id: "alumnos",  label: "Alumnos",   icon: I("Users", ic.Users) },
    { id: "clases",   label: "Clases",    icon: I("Calendar", ic.Calendar) },
    { id: "grupos",   label: "Grupos",    icon: I("Layers", ic.Layers) },
    { id: "rankings", label: "Ranking",   icon: I("Trophy", ic.Trophy) },
    { id: "torneos",  label: "Torneos",   icon: (window.NavIcons && (window.NavIcons.Tournament || window.NavIcons.Brackets)) || ic.Brackets },
    { id: "reportes", label: "Reportes",  icon: I("Chart", ic.Chart) },
    { id: "pagos",    label: "Pagos",     icon: I("Cash", ic.Cash) },
    { id: "gastos",   label: "Gastos",    icon: I("Receipt", ic.Receipt) },
    { id: "perfil",   label: "Perfil",    icon: I("User", ic.User) },
  ];

  const primaryTabs = allTabs.slice(0, 4);
  const secondaryTabs = allTabs.slice(4);


  const onTab = (id) => setCurrent && setCurrent(id);

return (
    <>
      {/* Sidebar izquierda (Desktop/Tablet) - SIN CAMBIOS */}
      <aside
        className={
          "hidden md:flex fixed inset-y-0 left-0 z-40 bg-[#303030] text-white " +
          (expanded ? "w-56" : "w-16") +
          " transition-[width] duration-300 pt-5"
        }
        onMouseEnter={() => onExpandChange && onExpandChange(true)}
        onMouseLeave={() => onExpandChange && onExpandChange(false)}
      >
        <div className="flex flex-col w-full h-full">
          {/* Header / logo */}
          <div className="h-14 flex items-center px-3 border-b border-white/10">
            <img src="logo_favicon.png" alt="Coachex-Pro" className="h-10 w-auto" />
            <span
              className={
                "ml-3 text-sm font-semibold transition-opacity whitespace-nowrap " +
                (expanded ? "opacity-100" : "opacity-0")
              }
            >
              Coachex-Pro
            </span>
          </div>

          {/* Selector de club: solo visible expandido */}
          <div className={"px-2 py-2 " + (expanded ? "block" : "hidden")}>
            {Array.isArray(clubes) && clubes.length > 1 ? (
              <select
                value={clubActivoId || ""}
                onChange={(e) => onClubChange && onClubChange(e.target.value)}
                className="w-full bg-[#3b3b3b] text-white/90 text-sm rounded-lg px-2 py-1 border border-white/10 focus:ring-2 focus:ring-white/30"
                title="Seleccionar club"
              >
                {clubes.map((c) => (
                  <option key={c.id} value={c.id}>{c.nombre}</option>
                ))}
              </select>
            ) : (
              <div className="text-xs text-white/70 px-2 py-1 rounded bg-white/5 border border-white/10">
                {clubActivoId ? (clubes.find(c=>c.id===clubActivoId)?.nombre || "‚Äî") : (clubes?.[0]?.nombre || "‚Äî")}
              </div>
            )}
          </div>

          {/* Navegaci√≥n de escritorio usa la lista completa de pesta√±as */}
          <nav className="flex-1 mt-2">
            {allTabs.map((t) => {
              const active = current === t.id;
              const Icon = t.icon;
              return (
                <button
                  key={t.id}
                  onClick={() => {
                    setCurrent && setCurrent(t.id);
                    onExpandChange && onExpandChange(false);
                  }}
                  title={t.label}
                  className={
                    "relative w-full mx-2 my-1 flex items-center gap-3 px-3 py-2 rounded-xl transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-white/30 " +
                    (active ? "bg-white/15" : "hover:bg-white/10")
                  }
                >
                  <span
                    aria-hidden
                    className={
                      "absolute left-0 top-1/2 -translate-y-1/2 h-6 w-1 rounded-r transition-all " +
                      (active ? "bg-white" : "bg-transparent")
                    }
                  />
                  <Icon className="h-5 w-5 shrink-0" />
                  <span
                    className={
                      "text-sm transition-opacity whitespace-nowrap " +
                      (expanded ? "opacity-100" : "opacity-0")
                    }
                  >
                    {t.label}
                  </span>
                </button>
              );
            })}
          </nav>

          {/* Logout */}
          <div className="p-2 border-t border-white/10">
            <button
              onClick={onLogout}
              className="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white/10 focus-visible:ring-2 focus-visible:ring-white/30"
              title="Cerrar sesi√≥n"
            >
              {React.createElement((window.NavIcons && window.NavIcons.Logout) || ic.Logout, {
                className: "h-5 w-5",
              })}
              <span
                className={
                  "text-sm transition-opacity " +
                  (expanded ? "opacity-100" : "opacity-0")
                }
              >
                Cerrar Sesi√≥n
              </span>
            </button>
          </div>
        </div>
      </aside>

      {/* --- INICIO DE LA BARRA INFERIOR MODIFICADA --- */}
      <nav
        className="md:hidden fixed bottom-0 inset-x-0 z-40 bg-[#303030] text-white flex items-stretch justify-around border-t border-white/10"
        style={{
          height: "calc(56px + env(safe-area-inset-bottom))",
          paddingBottom: "env(safe-area-inset-bottom)",
        }}
      >
        {/* Mapeamos solo las pesta√±as principales */}
        {primaryTabs.map((t) => {
          const Icon = t.icon;
          return (
            <button
              key={t.id}
              onClick={() => onTab(t.id)}
              className={
                "flex-1 flex flex-col items-center justify-center text-[11px] transition-colors " +
                (current === t.id ? "bg-white/10" : "active:bg-white/5")
              }
            >
              <Icon className="h-5 w-5 mb-0.5" />
              <span className="leading-none">{t.label}</span>
            </button>
          );
        })}

        {/* Bot√≥n para abrir el men√∫ "M√°s" */}
        <button
          onClick={() => setIsMoreMenuOpen(true)}
          className={
            "flex-1 flex flex-col items-center justify-center text-[11px] transition-colors active:bg-white/5 " +
            // Se ilumina si la pesta√±a activa est√° dentro del men√∫ "M√°s"
            (secondaryTabs.some(t => t.id === current) ? "bg-white/10" : "")
          }
        >
          <IconMore className="h-5 w-5 mb-0.5" />
          <span className="leading-none">M√°s</span>
        </button>
      </nav>

      {/* Renderizamos el nuevo men√∫ desplegable que creamos */}
      <MoreMenuSheet
        isOpen={isMoreMenuOpen}
        onClose={() => setIsMoreMenuOpen(false)}
        tabs={secondaryTabs}
        current={current}
        setCurrent={setCurrent}
        onLogout={onLogout}
      />
      {/* --- FIN DE LA BARRA INFERIOR MODIFICADA --- */}
    </>
  );
}



    
    function ClasesPorTamanoMes({ clases }) {
  const resumen = useMemo(() => {
    const ahora = new Date();
    const mesActual = ahora.getMonth();
    const anioActual = ahora.getFullYear();

    const clasesDelMes = clases.filter(c => {
  const fechaClase = new Date(c.fecha);
  const esRealizada = String(c.estado || '').toLowerCase() === 'realizada';
  return (
    fechaClase.getMonth() === mesActual &&
    fechaClase.getFullYear() === anioActual &&
    esRealizada
  );
});

    return TIPOS_CLASE.reduce((acc, tipo) => {
      acc[tipo] = clasesDelMes.filter(
        c => normalizarTipoClase(c.tipo) === tipo
      ).length;
      return acc;
    }, {});
  }, [clases]);

  return (
    <Card title="Clases por cantidad de alumnos">
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 text-center">
        {TIPOS_CLASE.map(tipo => (
          <div key={tipo} className="bg-slate-50 p-2 rounded-lg flex flex-col justify-between h-full">
            <p className="text-xs text-slate-600 h-8 flex items-center justify-center">{labelSinClase(tipo)}</p>
            <p className="text-xl font-bold">{resumen[tipo] || 0}</p>
          </div>
        ))}
      </div>
    </Card>
  );
}

function fechaDDMMYYYY(iso) {
  if (!iso) return "-";
  const [y, m, d] = String(iso).split("-");
  return `${d}/${m}/${y}`;
}

// ===== Numeraci√≥n de comprobantes =====
// ===== Numeraci√≥n de comprobantes (por SERIE y por A√ëO) =====
const COMPROB_SERIE_DEFAULT = "CP"; // fallback

function _yearFromISO(iso) {
  if (iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso.slice(0,4);
  return String(new Date().getFullYear());
}

function nextComprobanteNumber(pago, serie = COMPROB_SERIE_DEFAULT) {
  try {
    // Mantenemos un mapa por SERIE para que no se mezclen
    const mapKey     = `coachex_comprob_map_${serie}`;     // pago.id -> nro
    const seqPrefix  = `coachex_comprob_seq_${serie}_`;     // por serie & a√±o

    const map = JSON.parse(localStorage.getItem(mapKey) || "{}");

    if (pago?.id && map[pago.id]) return map[pago.id]; // estable por pago

    const year  = _yearFromISO(pago?.fecha);
    const seqKey = seqPrefix + year;

    let seq = parseInt(localStorage.getItem(seqKey) || "0", 10);
    seq += 1;
    localStorage.setItem(seqKey, String(seq));

    const numStr = String(seq).padStart(6, "0");
    const nro = `${serie}-${year}-${numStr}`;

    if (pago?.id) {
      map[pago.id] = nro;
      localStorage.setItem(mapKey, JSON.stringify(map));
    }
    return nro;
  } catch (e) {
    const year = _yearFromISO(pago?.fecha);
    return `${serie}-${year}-${String(Date.now()).slice(-6)}`;
  }
}

// (opcional) reset manual
function resetComprobanteCounter(year = String(new Date().getFullYear()), serie = COMPROB_SERIE_DEFAULT) {
  localStorage.removeItem(`coachex_comprob_seq_${serie}_` + year);
}

// ====== PDF: Comprobante de Pago por Clase (GLOBAL, robusto) ======
// ====== PDF: Comprobante de Pago por Clase (GLOBAL, con soporte WhatsApp) ======
window.generarComprobanteClase = async function generarComprobanteClase(opts) {
  try {
    const { pago, clase, alumno, perfil, lugar, returnBlob } = opts || {};
    if (!pago || !clase || !alumno) {
      alert("Faltan datos: pago, clase o alumno.");
      console.warn("Payload comprobante:", opts);
      return;
    }

    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("jsPDF no est√° cargado");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const fmtMoney = (n) =>
      Number(n || 0).toLocaleString("es-AR", { minimumFractionDigits: 0 });
    const toDDMMYYYY = (iso) => {
      if (!iso) return "-";
      const [y, m, d] = String(iso).split("-");
      return `${d}/${m}/${y}`;
    };

    // Logo (si est√° en la misma carpeta que index.html)
    let logoDataUrl = null;
    try {
      const resp = await fetch("./logo_favicon.png");
      if (resp.ok) {
        const blob = await resp.blob();
        logoDataUrl = await new Promise((res) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.readAsDataURL(blob);
        });
      }
    } catch (_) {}

    // Encabezado
    try { if (logoDataUrl) doc.addImage(logoDataUrl, "PNG", 12, 10, 22, 22); } catch (_) {}
    doc.setFontSize(16);
    doc.text("Comprobante de Pago", 40, 18);
    doc.setFontSize(10);

    const profe =
      `${perfil?.nombre || ""} ${perfil?.apellido || ""}`.trim() ||
      perfil?.nombreCompleto ||
      "-";
    const serie = (perfil?.serieComprobantes || "CP");
    const compNum = nextComprobanteNumber(pago, serie);

    doc.text(`N¬∫: ${compNum}`, 40, 25);
    doc.text(`Fecha emisi√≥n: ${toDDMMYYYY(pago?.fecha || clase?.fecha)}`, 40, 31);

    // Separador
    doc.setDrawColor(150);
    doc.setLineWidth(0.2);
    doc.line(12, 36, 198, 36);

    // Datos
    const alumnoNombre = `${alumno?.apellidos || ""} ${alumno?.nombres || ""}`.trim() || (alumno?.nombre || "-");
    const fechaClase   = toDDMMYYYY(clase?.fecha || "");
    const horaClase    = clase?.hora || "-";
    const tipoClase    = clase?.tipo || "-";
    const metodo       = pago?.metodo || "-";
    const monto        = fmtMoney(pago?.monto || 0);
    const concepto     = pago?.concepto || `Pago de clase (${tipoClase})`;
    const observ       = pago?.observaciones || "";
    const sede         = lugar || perfil?.lugarTrabajoNombre || perfil?.lugar || perfil?.sede || "-";

    const detalleRows = [
      ["Alumno/a",        alumnoNombre],
      ["Fecha de clase",  `${fechaClase} - ${horaClase}`],
      ["Tipo de clase",   tipoClase],
      ["Profesor/a",      profe],
      ["Sede",            sede],
      ["M√©todo de pago",  metodo],
      ["Monto",           `$${monto}`],
      ["Concepto",        concepto],
    ];

    if (doc.autoTable) {
      doc.autoTable({
        startY: 40,
        head: [["Detalle", "Informaci√≥n"]],
        body: detalleRows,
        theme: "grid",
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [63, 63, 65], textColor: 255, fontStyle: "bold" },
        columnStyles: { 0: { cellWidth: 55, fontStyle: "bold" }, 1: { cellWidth: 125 } },
      });
    }

    let y = doc.lastAutoTable?.finalY || 40;
    if (observ) {
      y += 8;
      doc.setFontSize(10);
      doc.text("Observaciones:", 12, y);
      const wrapped = doc.splitTextToSize(observ, 184);
      doc.text(wrapped, 12, y + 6);
      y += wrapped.length * 5 + 6;
    }

    // Firma
    y = Math.max(y + 14, 120);
    doc.setDrawColor(150);
    doc.line(140, y, 198, y);
    doc.setFontSize(9);
    doc.text("Firma / Aclaraci√≥n", 146, y + 5);

    // Pie
    const pageH = doc.internal.pageSize.height;
    doc.setFontSize(8);
    doc.text("Generado por Coachex-Pro", 12, pageH - 10);

    // Nombre de archivo
    const fn = `Comprobante_${(alumnoNombre || "Alumno").replaceAll(" ", "_")}_${fechaClase.replaceAll("/", "-")}_${compNum}.pdf`;

    // ‚¨áÔ∏è Si me ped√≠s blob (para WhatsApp), NO descargo. Devuelvo {blob, filename}
    if (returnBlob) {
      const blob = doc.output("blob");
      return { blob, filename: fn };
    }

    // De lo contrario, descargo normalmente
    doc.save(fn);
  } catch (e) {
    console.error("Error generando comprobante:", e);
    alert("No se pudo generar el comprobante.");
  }
};


// ====== PDF: Reportes con logo (GLOBAL) ======
window.generarReportePDF = async function generarReportePDF({
  tipo = "Diario",
  clases = [],
  pagos = [],
  gastos = [],
  perfil
}) {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("jsPDF no est√° cargado");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const fmtMoney = (n) => Number(n || 0).toLocaleString("es-AR", { minimumFractionDigits: 0 });

  // ---------- Rango (para t√≠tulo) ----------
  let rangoTexto = "";
  if (clases?.length) {
    const ord = [...clases].sort((a,b) => (a.fecha||"").localeCompare(b.fecha||""));
    const desde = fechaDDMMYYYY(ord[0].fecha);
    const hasta = fechaDDMMYYYY(ord[ord.length - 1].fecha);
    if (desde && hasta) rangoTexto = `${desde}‚Äì${hasta}`;
  }

  // ---------- Logo (mismo folder que index.html) ----------
  let logoDataUrl = null;
  try {
    const resp = await fetch("./logo_favicon.png");
    if (resp.ok) {
      const blob = await resp.blob();
      logoDataUrl = await new Promise(res => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(blob);
      });
    }
  } catch (_) {}

  // ---------- ENCABEZADO COMPACTO Y CENTRADO ----------
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 14;
  let yPos = 12; // Empezamos un poco m√°s arriba

  // 1. Logo Centrado (m√°s peque√±o)
  const logoW = 22, logoH = 22; // Reducido de 28 a 22
  const logoX = (pageW - logoW) / 2;
  try { if (logoDataUrl) doc.addImage(logoDataUrl, "PNG", logoX, yPos, logoW, logoH); } catch(_) {}
  yPos += logoH + 6; // Menos espacio despu√©s del logo

  // 2. T√≠tulo "Coachex-Pro" Centrado (m√°s peque√±o)
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18); // Reducido de 22 a 18
  doc.text("Coachex-Pro", pageW / 2, yPos, { align: "center" });
  yPos += 10;

  // 3. Subt√≠tulo del Reporte (tambi√©n m√°s peque√±o)
  doc.setFont("helvetica", "normal");
  doc.setFontSize(14); // Reducido de 16 a 14
  doc.setTextColor(100);
  doc.text(`Reporte ${tipo}`, pageW / 2, yPos, { align: "center" });
  yPos += 10;
  
  // 4. L√≠nea separadora
  doc.setDrawColor(220);
  doc.setLineWidth(0.5);
  doc.line(margin, yPos, pageW - margin, yPos);
  yPos += 12;

  // 5. Metadatos (Profesor, Fecha) debajo de la l√≠nea
  const nombreCompleto = `${perfil?.nombre || ""} ${perfil?.apellido || ""}`.trim();
  doc.setFontSize(10);
  doc.setTextColor(0);
  doc.text(`Profesor/a: ${nombreCompleto || "-"}`, margin, yPos);
  doc.text(`Generado: ${new Date().toLocaleDateString("es-AR")}`, pageW - margin, yPos, { align: "right" });
  yPos += 6;
  if (tipo !== "Diario" && rangoTexto) {
    doc.text(`Per√≠odo: ${rangoTexto}`, pageW - margin, yPos, { align: "right" });
  }
  
  // Ajustamos la posici√≥n Y para el contenido que sigue
  const startYContenido = yPos + 15;

  // ---------- Resumen ----------
  const totalIngresos = (pagos || []).reduce((a, p) => a + Number(p.monto || 0), 0);
  const totalGastos   = (gastos || []).reduce((a, g) => a + Number(g.monto || 0), 0);
  const balance       = totalIngresos - totalGastos;

  doc.setFontSize(12);
  doc.text("Resumen", margin, startYContenido);
  doc.setFontSize(10);
  doc.text(`Clases registradas: ${clases.length}`, margin, startYContenido + 7);
  doc.text(`Ingresos: $${fmtMoney(totalIngresos)}`, margin, startYContenido + 13);
  doc.text(`Gastos: $${fmtMoney(totalGastos)}`,   margin, startYContenido + 19);
  doc.text(`Balance: $${fmtMoney(balance)}`,      margin, startYContenido + 25);

  // ---------- Por tipo (tabla compacta) ----------
  const totPorTipo = (clases || []).reduce((acc, c) => {
    const k = c?.tipo || "Otro";
    acc[k] = (acc[k] || 0) + 1;
    return acc;
  }, {});
  const tiposRows = Object.entries(totPorTipo).map(([k,v]) => [k, String(v)]);
  if (tiposRows.length && doc.autoTable) {
    doc.autoTable({
      startY: startYContenido + 31,
      head: [["Tipo", "Cantidad"]],
      body: tiposRows,
      styles: { fontSize: 9 },
      theme: "grid",
      headStyles: { fillColor: [63,63,65], textColor: 255, fontStyle: "bold" },
      alternateRowStyles: { fillColor: [245,247,248] }
    });
  }

  // ---------- Tabla de clases ----------
  const bodyClases = (clases || []).map(c => ([
    fechaDDMMYYYY(c.fecha || ""),
    c.hora || "-",
    (c.alumnoNombres && c.alumnoNombres.length
      ? c.alumnoNombres.join(", ")
      : (Array.isArray(c.alumnos)
          ? c.alumnos.map(a => `${a.apellido||""} ${a.nombre||""}`.trim()).join(", ")
          : "-"
        )
    ),
    c.tipo || "-",
    c.estado || "-"
  ]));

  const startYTabla = (doc.lastAutoTable && doc.lastAutoTable.finalY
    ? doc.lastAutoTable.finalY + 6
    : startYContenido + 38
  );

  if (bodyClases.length && doc.autoTable) {
    doc.autoTable({
      startY: startYTabla,
      head: [["Fecha","Hora","Alumno(s)","Tipo","Estado"]],
      body: bodyClases,
      tableWidth: "auto",
      margin: { left: 12, right: 12 },
      styles: { fontSize: 9, cellPadding: 2, overflow: "linebreak" },
      columnStyles: {
        0: { cellWidth: 24 },
        1: { cellWidth: 16 },
        2: { cellWidth: 82 },
        3: { cellWidth: 38 },
        4: { cellWidth: 24 },
      },
      theme: "grid",
      headStyles: { fillColor: [63,63,65], textColor: 255, fontStyle: "bold", halign: "left" },
      alternateRowStyles: { fillColor: [245,247,248] },
      didParseCell: (data) => {
        if (data.section === "body" && (data.column.index === 2 || data.column.index === 3)) {
          const maxW = data.column.index === 2 ? 82 : 38;
          data.cell.text = doc.splitTextToSize(String(data.cell.text || ""), maxW);
          data.cell.styles.valign = "top";
          data.cell.styles.minCellHeight = 6;
        }
      },
    });
  }

  // ---------- P√°gina extra: Pagos / Gastos (si hay) ----------
  const hayPagos  = (pagos?.length || 0) > 0;
  const hayGastos = (gastos?.length || 0) > 0;

  if (hayPagos || hayGastos) {
    doc.addPage();
    if (hayPagos) {
      const bodyPagos = pagos.map(p => [
        fechaDDMMYYYY(p.fecha || ""),
        p.concepto || "-",
        `$${fmtMoney(p.monto || 0)}`,
        p.metodo || "-"
      ]);
      const mlP = 16, mrP = 16;
      const availWP = pageW - mlP - mrP;
      const safeWP  = Math.floor(availWP * 0.88);
      const wFechaP   = 22;
      const wMontoP   = 26;
      const wMetodoP  = 24;
      const wConceptoP = Math.max(40, safeWP - wFechaP - wMontoP - wMetodoP);
      doc.setFontSize(12);
      doc.text("Pagos", 14, 16);
      doc.autoTable({
        startY: 20,
        head: [["Fecha","Concepto","Monto","M√©todo"]],
        body: bodyPagos,
        tableWidth: safeWP,
        margin: { left: mlP, right: mrP },
        styles: {
          fontSize: 9,
          overflow: "linebreak",
          cellPadding: { top: 2, right: 2, bottom: 2, left: 2 },
        },
        columnStyles: {
          0: { cellWidth: wFechaP },
          1: { cellWidth: wConceptoP },
          2: { cellWidth: wMontoP, halign: "right" },
          3: { cellWidth: wMetodoP },
        },
        theme: "grid",
        headStyles: { fillColor: [63,63,65], textColor: 255, fontStyle: "bold" },
        alternateRowStyles: { fillColor: [245,247,248] },
        didParseCell: (data) => {
          if (data.section === "body" && data.column.index === 1) {
            data.cell.text = doc.splitTextToSize(String(data.cell.text ?? ""), wConceptoP);
            data.cell.styles.valign = "top";
          }
        },
      });
    }
    if (hayGastos) {
      const bodyGastos = gastos.map(g => ([
        fechaDDMMYYYY(g.fecha || ""),
        g.concepto || "-",
        `$${fmtMoney(g.monto || 0)}`
      ]));
      const startYGastos = (doc.lastAutoTable?.finalY ? doc.lastAutoTable.finalY + 10 : 20);
      doc.setFontSize(12);
      doc.text("Gastos", 14, startYGastos - 4);
      const mlG = 16, mrG = 16;
      const availWG = pageW - mlG - mrG;
      const safeWG  = Math.floor(availWG * 0.88);
      const wFechaG   = 22;
      const wMontoG   = 26;
      const wConceptoG = Math.max(40, safeWG - wFechaG - wMontoG);
      doc.autoTable({
        startY: startYGastos,
        head: [["Fecha","Concepto","Monto"]],
        body: bodyGastos,
        tableWidth: safeWG,
        margin: { left: mlG, right: mrG },
        styles: {
          fontSize: 9,
          overflow: "linebreak",
          cellPadding: { top: 2, right: 2, bottom: 2, left: 2 }
        },
        columnStyles: {
          0: { cellWidth: wFechaG },
          1: { cellWidth: wConceptoG },
          2: { cellWidth: wMontoG, halign: "right" },
        },
        theme: "grid",
        headStyles: { fillColor: [63,63,65], textColor: 255, fontStyle: "bold" },
        alternateRowStyles: { fillColor: [245,247,248] },
        didParseCell: (data) => {
          if (data.section === "body" && data.column.index === 1) {
            data.cell.text = doc.splitTextToSize(String(data.cell.text || ""), wConceptoG);
            data.cell.styles.valign = "top";
          }
        },
      });
    }
  }

  // ---------- Pie + nombre de archivo ----------
  const pageH = doc.internal.pageSize.height;
  doc.setFontSize(8);
  doc.text("Generado por Coachex-Pro", 12, pageH - 10);
  const hoyISO = new Date().toISOString().slice(0, 10);
  const sufijo = (tipo === "Diario")
    ? (clases?.[0]?.fecha ? fechaDDMMYYYY(clases[0].fecha).replaceAll("/", "-") : hoyISO)
    : (rangoTexto ? rangoTexto.replaceAll("/", "-").replace("‚Äì", "_") : hoyISO);

  doc.save(`Reporte_${tipo}_${sufijo}.pdf`);
};

// Enviar PDF por WhatsApp (sin descargar en fallback, salvo que lo pidas)
async function sharePdfViaWhatsApp({ blob, filename, text, phone, autoDownloadInFallback = false }) {
  const file = new File([blob], filename, { type: "application/pdf" });
  const msg  = text || "Te env√≠o tu comprobante de pago";

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    await navigator.share({ files: [file], title: filename, text: msg });
    return;
  }
  const q = encodeURIComponent(msg);
  const waUrl = phone ? `https://wa.me/${phone}?text=${q}` : `https://wa.me/?text=${q}`;
  window.open(waUrl, "_blank");

  if (autoDownloadInFallback) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 20000);
  }
}


// ===== TEL√âFONO DEL ALUMNO (ROBUSTO) =====
const GET_TEL_DEBUG = false; // pon√© true para ver candidatos en consola

function _collectPhoneStrings(obj, depth = 0, acc = []) {
  if (!obj || depth > 2) return acc;
  if (Array.isArray(obj)) {
    obj.forEach(x => _collectPhoneStrings(x, depth + 1, acc));
    return acc;
  }
  if (typeof obj === "object") {
    for (const [k, v] of Object.entries(obj)) {
      // claves que "suenan" a tel√©fono/whatsapp
      const looksLikePhoneKey = /whats?app|wpp|celu|celular|movil|m[o√≥]vil|tel(efono)?|phone|contacto/i.test(k);
      if (looksLikePhoneKey) {
        if (typeof v === "string" || typeof v === "number") acc.push(String(v));
        else _collectPhoneStrings(v, depth + 1, acc);
      }
    }
  }
  return acc;
}

function getTelefonoAlumno(alumno) {
  if (!alumno) return null;

  // campos comunes + escaneo por claves ‚Äúphone-like‚Äù
  const candidates = [
    alumno.whatsapp, alumno.WhatsApp, alumno.wasap, alumno.wpp, alumno.wapp,
    alumno.telefono, alumno.tel√©fono, alumno.tel, alumno.cel, alumno.celular,
    alumno.movil, alumno.m√≥vil, alumno.phone, alumno.mobile,
    alumno.contactoPadre, alumno.contactoMadre,
    alumno?.contacto?.telefono, alumno?.contacto?.whatsapp,
    ..._collectPhoneStrings(alumno)
  ]
  .filter(Boolean)
  .map(s => String(s).trim());

  // limpiar y filtrar por longitud m√≠nima
  const cleaned = candidates
    .map(raw => ({ raw, digits: raw.replace(/\D+/g, "") }))
    .filter(o => o.digits.length >= 6);

  if (GET_TEL_DEBUG) console.log("‚òéÔ∏è candidatos:", candidates, "‚Üí", cleaned);

  if (!cleaned.length) return null;

  // preferir alguno que venga de campos tipo "whatsapp", si existe
  const prefer = cleaned.find(o => /whats?app|wpp/i.test(o.raw)) ||
                 cleaned.sort((a, b) => b.digits.length - a.digits.length)[0];

  return prefer.digits; // devolvemos d√≠gitos (sin s√≠mbolos)
}

// ===== NORMALIZADOR A wa.me (Argentina por defecto) =====
function normalizarTelefonoParaWhatsApp(rawDigits, defaultCountry = "54") {
  if (!rawDigits) return null;
  let num = String(rawDigits).replace(/\D+/g, "");

  // 00 + pa√≠s
  if (num.startsWith("00")) num = num.slice(2);

  // Si ya es AR
  if (num.startsWith("54")) {
    if (!num.startsWith("549")) num = "549" + num.slice(2);
    // quitar '15' pos-√°rea (l√≠neas viejas): 54938115xxxxxx ‚Üí 549381xxxxxx
    num = num.replace(/^549(11|[2368]\d{2}|9\d{3})15/, "549$1");
    return num;
  }

  // Nacional: quitar 0 y 15 inicial si corresponde
  if (num.startsWith("0")) num = num.slice(1);
  num = num.replace(/^15/, "");

  // Anteponer pa√≠s por defecto (AR)
  return defaultCountry ? ("549" + num) : num;
}

    
 function Dashboard({ perfil, clases, pagos, gastos, alumnos, clubes, clubActivoId, goToNewClass, goToEditClass }) {
  // --- L√≥gica interna (c√°lculos) ---
  const [currentDate, setCurrentDate] = useState(new Date());
  const [mostrarSoloHorarioLaboral, setMostrarSoloHorarioLaboral] = useState(false);
  const weekStartDate = getWeekStartDate(currentDate);
  const weekDates = Array.from({ length: 7 }, (_, i) => formatDate(addDays(weekStartDate, i)));
  const clubActivo = clubActivoId ? (clubes || []).find(c => c.id === clubActivoId) : null;
  const nombreLugar = clubActivo ? clubActivo.nombre : "‚Äî";
  const nombreCompleto = `${perfil?.nombre || ''} ${perfil?.apellido || ''}`.trim();
  const horarioData = clubActivo ? clubActivo.horarioLaboral : perfil?.horarioLaboral;
  const alumnoMap = useMemo(() => new Map((alumnos || []).map(a => [a.id, getNombreCompleto(a)])), [alumnos]);
  const alumnoObjMap = useMemo(() => new Map((alumnos || []).map(a => [a.id, a])), [alumnos]);
  const [contactosExpandId, setContactosExpandId] = useState(null);
  const [contactosMsg, setContactosMsg] = useState("");
  const hoy = formatDate(new Date());
  const semanaInicio = formatDate(getWeekStartDate(new Date()));
  const manana = formatDate(addDays(new Date(), 1));

  const clasesHoy = useMemo(() => (clases || []).filter(c => c.fecha === hoy && String(c.estado || '').toLowerCase() !== 'cancelada').sort((a, b) => a.hora.localeCompare(b.hora)), [clases, hoy]);
  const clasesManana = useMemo(() => (clases || []).filter(c => c.fecha === manana && String(c.estado || '').toLowerCase() !== 'cancelada').sort((a, b) => a.hora.localeCompare(b.hora)), [clases, manana]);
  const resumenClasesHoy = useMemo(() => {
    const clasesRealizadas = clasesHoy.filter(c => c.estado === 'Realizada');
    if (clasesRealizadas.length === 0) return [];
    const counts = clasesRealizadas.reduce((acc, c) => { const tipo = normalizarTipoClase(c.tipo); acc[tipo] = (acc[tipo] || 0) + 1; return acc; }, {});
    return Object.entries(counts).map(([tipo, cant]) => `${cant} clase${cant > 1 ? 's' : ''} de ${labelSinClase(tipo)}`);
  }, [clasesHoy]);
  const balanceSemana = useMemo(() => {
    const ingresos = (pagos || []).filter(p => p.fecha >= semanaInicio).reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
    const egresos = (gastos || []).filter(g => g.fecha >= semanaInicio).reduce((acc, g) => acc + parseFloat(g.monto || 0), 0);
    return ingresos - egresos;
  }, [pagos, gastos, semanaInicio]);
  const horarioFormateado = (() => {
    const data = horarioData; if (!data) return ["No configurado"];
    const lista = Array.isArray(data.bloques) ? data.bloques : (Array.isArray(data) ? data.filter(d => d.activo) : []);
    if (lista.length === 0) return ["Sin horarios definidos."];
    return lista.map(b => `${b.dia}: ${b.desde} - ${b.hasta}`);
  })();
  const generateSlots = (desde, hasta, stepMin = 60) => {
    const [h1, m1] = (desde || '08:00').split(':').map(Number); const [h2, m2] = (hasta || '20:00').split(':').map(Number);
    const start = h1 * 60 + m1; const end = h2 * 60 + m2;
    const res = [];
    for (let t = start; t < end; t += stepMin) {
      const hh = String(Math.floor(t / 60)).padStart(2, '0');
      const mm = String(t % 60).padStart(2, '0');
      res.push(`${hh}:${mm}`);
    }
    return res;
  };
  const horarioDisponibleManana = useMemo(() => {
    const ocupadas = new Set(clasesManana.map(c => c.hora));
    const slots = [];
    const diaDeManana = DIAS_SEMANA_NOMBRES[(new Date(manana + 'T00:00:00').getDay() + 6) % 7];
    const bloquesDelDia = (horarioData?.bloques || horarioData || []).filter(b => b.dia === diaDeManana && (b.activo ?? true));
    bloquesDelDia.forEach(b => { generateSlots(b.desde, b.hasta).forEach(h => { if (!ocupadas.has(h)) slots.push(h); }); });
    return slots.sort();
  }, [horarioData, clasesManana, manana]);

  // Contenedor principal en una sola columna para apilar las tarjetas en el orden deseado
  return (
    <div className="grid grid-cols-1 gap-6">

      <Card title={<span className="text-[#34745B]">Lugar y Horario</span>}>
        <div className="flex flex-col sm:flex-row justify-between text-sm">
          <div className="space-y-1">
            <p><strong>Modo actual:</strong> {nombreLugar}</p>
            <p><strong>Profesor/a:</strong> {nombreCompleto}</p>
          </div>
          <div className="mt-3 sm:mt-0 sm:text-right">
            <strong>Horario Laboral:</strong>
            <div className="text-slate-600">{horarioFormateado.map((linea, index) => (<div key={index}>{linea}</div>))}</div>
          </div>
        </div>
      </Card>
      
      <Card title={<span className="text-[#34745B]">Agenda del D√≠a</span>}>
        {clasesHoy.length === 0 ? (
          <p className="text-sm text-slate-500">No hay clases programadas para hoy.</p>
        ) : (
          <ul className="space-y-2">
            {clasesHoy.map(c => (
              <li key={c.id} className="p-2 border-b flex justify-between items-center gap-2">
                <div className="min-w-0">
                  <p className="font-semibold text-slate-700 break-words">{c.hora} - {(c.alumnoIds || []).map(id => alumnoMap.get(id)).filter(Boolean).join(', ')}</p>
                  <p className="text-xs text-slate-500">{c.tipo}{c.cancha ? ` en ${c.cancha}` : ''}</p>
                </div>
                <span className={`px-2 py-0.5 rounded-full text-xs font-semibold shrink-0 ${c.estado === 'Realizada' ? 'bg-green-100 text-green-800' : c.estado === 'Cancelada' ? 'bg-red-100 text-red-800' : c.estado === 'Ausente' ? 'bg-orange-100 text-orange-800' : 'bg-slate-100 text-slate-800'}`}>{c.estado}</span>
              </li>
            ))}
          </ul>
        )}
      </Card>

      <Card title={<span className="text-[#34745B]">Agenda de Ma√±ana ¬∑ Contactos</span>}>
         {clasesManana.length === 0 ? (
          <p className="text-sm text-slate-500">No hay clases programadas para ma√±ana.</p>
        ) : (
          <ul className="space-y-2">
            {clasesManana.map(c => (
              <li key={c.id} className="p-2 border rounded-lg">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                  <div className="min-w-0">
                    <p className="font-semibold text-slate-700 break-words">{(c.alumnoIds || []).map(id => alumnoMap.get(id)).filter(Boolean).join(', ')}</p>
                    <p className="text-xs text-slate-500">{c.hora} ¬∑ {c.tipo}{c.cancha ? ` en ${c.cancha}` : ''}</p>
                  </div>
                  <button type="button" onClick={() => { setContactosMsg(`Hola! Te recuerdo tu clase ${c.tipo} ma√±ana a las ${c.hora}.`); setContactosExpandId(contactosExpandId === c.id ? null : c.id);}} className="text-sm px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50 shrink-0">Contactos</button>
                </div>
                {contactosExpandId === c.id && (
  <div className="mt-3 p-3 bg-slate-50 rounded-lg border">
    <label className="text-xs text-slate-500 block mb-1">Mensaje (editable)</label>
    <textarea value={contactosMsg} onChange={(e)=>setContactosMsg(e.target.value)} className="w-full border rounded-lg px-2 py-1 text-sm" rows="2" />
    <table className="w-full text-sm mt-2"><tbody>
      {(c.alumnoIds || []).filter(Boolean).map(id => {
        const a = alumnoObjMap.get(id); if (!a) return null;
        
              const wa = waLink(a.telefono || a.contactoPadre, a.nombre, contactosMsg);
        
        return (<tr key={id} className="border-t"><td className="py-1">{getNombreCompleto(a)}</td><td>{a.telefono || a.contactoPadre || "-"}</td><td className="text-right">{wa && <a className="text-emerald-700 underline" href={wa} target="_blank" rel="noopener">WhatsApp</a>}</td></tr>);
      })}
    </tbody></table>
  </div>
)}
              </li>
            ))}
          </ul>
        )}
      </Card>
      
      <Card title={<span className="text-[#34745B]">Horario disponible para ma√±ana</span>}>
        <div className="text-xs text-slate-500 mb-3">{horarioDisponibleManana.length} libres</div>
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
          {horarioDisponibleManana.map(h => (
            <div key={h} className="flex items-center justify-between gap-2 px-2 py-1 rounded-full border bg-white text-slate-700 text-sm">
              <span>{h}</span>
              <button type="button" onClick={() => goToNewClass && goToNewClass({ fecha: manana, hora: h })} className="text-xs px-2 py-0.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white">Agendar</button>
            </div>
          ))}
        </div>
      </Card>

      <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
        <p className="text-sm text-green-800">Clases Realizadas Hoy</p>
        <p className="text-3xl font-bold text-[#34745B]">{clasesHoy.filter(c=>c.estado === 'Realizada').length}</p>
        {resumenClasesHoy.length > 0 && <div className="text-xs text-green-700 mt-2 border-t border-green-200 pt-2">{resumenClasesHoy.map((linea, i) => (<p key={i}>{linea}</p>))}</div>}
      </div>

      <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
        <p className="text-sm text-green-800">Balance de la Semana</p>
        <p className={`text-3xl font-bold ${balanceSemana >= 0 ? 'text-[#34745B]' : 'text-red-900'}`}>{formatCurrency(balanceSemana)}</p>
      </div>

      <Card title={<span className="text-[#34745B]">Reportes PDF</span>}>
        <p className="text-sm text-slate-600 mb-3">Descarg√° reportes listos para enviar.</p>
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <button type="button" className="px-3 py-2 rounded-lg text-sm bg-emerald-600 hover:bg-emerald-700 text-white" onClick={() => generarReportePDF({ tipo: "Diario", clases: clasesHoy.filter(c=>c.estado === 'Realizada'), pagos: (pagos || []).filter(p => p.fecha === hoy), gastos: (gastos || []).filter(g => g.fecha === hoy), perfil })}>Diario</button>
          <button type="button" className="px-3 py-2 rounded-lg text-sm bg-slate-800 hover:bg-slate-900 text-white" onClick={() => generarReportePDF({ tipo: "Semanal", clases: (clases || []).filter(c => c.fecha >= semanaInicio && c.estado === 'Realizada'), pagos: (pagos || []).filter(p => p.fecha >= semanaInicio), gastos: (gastos || []).filter(g => g.fecha >= semanaInicio), perfil })}>Semanal</button>
          <button type="button" className="px-3 py-2 rounded-lg text-sm bg-slate-600 hover:bg-slate-700 text-white" onClick={() => {
            const mesInicio = formatDate(new Date(new Date().getFullYear(), new Date().getMonth(), 1));
            generarReportePDF({ tipo: "Mensual", clases: (clases || []).filter(c => c.fecha >= mesInicio && c.estado === 'Realizada'), pagos: (pagos || []).filter(p => p.fecha >= mesInicio), gastos: (gastos || []).filter(g => g.fecha >= mesInicio), perfil });
          }}>Mensual</button>
        </div>
      </Card>
      
      <Card title={<span className="text-[#34745B]">Calendario Semanal</span>} right={
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2">
            <button onClick={() => setCurrentDate(prev => addDays(prev, -7))} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">‚Äπ Sem. Anterior</button>
            <button onClick={() => setCurrentDate(new Date())} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">Esta Semana</button>
            <button onClick={() => setCurrentDate(prev => addDays(prev, 7))} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">Sem. Siguiente ‚Ä∫</button>
          </div>
        </div>
      }>
        <CalendarioSemanal week={weekDates} clases={clases} alumnos={alumnos || []} onEdit={goToEditClass} />
      </Card>

    </div>
  );
}





    function AlumnoForm({ initialData, onSubmit, onCancel, onRegisterMonthlyPayment, studentBeingEdited, grupos = [] }) { // -- MODIFICADO: A√±adimos 'grupos'
  const [form, setForm] = useState(initialData);
  const [error, setError] = useState('');

  // -- NUEVO: Efecto para limpiar datos al cambiar de plan --
  useEffect(() => {
    // Si el plan NO es mensual, borramos la frecuencia.
    if (form.plan !== 'mensual') {
      setForm(prev => ({ ...prev, frecuencia: '' }));
    }
    // Si el plan NO es de grupo, borramos el grupoId.
    if (form.plan !== 'grupo_mensual') {
      setForm(prev => ({ ...prev, grupoId: '' }));
    }
  }, [form.plan]);
  
  const isMensual = form.plan === 'mensual';
  const isGrupoMensual = form.plan === 'grupo_mensual'; // -- NUEVO --
  const canRegisterAbono = (isMensual || isGrupoMensual) && Boolean(studentBeingEdited?.id);
  
  const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };
  const addHorario = () => setForm(f => ({ ...f, horarios: [...(f.horarios || []), { dia: "Lunes", hora: "18:00" }] }));
  const delHorario = (idx) => setForm(f => ({ ...f, horarios: f.horarios.filter((_, i) => i !== idx) }));
  const setHorario = (idx, key, val) => setForm(f => ({ ...f, horarios: f.horarios.map((h, i) => i === idx ? { ...h, [key]: val } : h) }));
  
  function handleSubmit(e) {
    e.preventDefault();
    setError('');
    if (!form.nombre.trim()) {
      setError("El campo 'Nombre' no puede estar vac√≠o.");
      return;
    }
    onSubmit(form);
  }

  return (
    <form onSubmit={handleSubmit} className="grid md:grid-cols-6 gap-3">
      <div className="md:col-span-3"><label className="text-sm text-slate-600">Nombre</label><input name="nombre" value={form.nombre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: Sof√≠a" required /></div>
      {error && <p className="text-xs text-red-600 mt-1">{error}</p>}
      <div className="md:col-span-3"><label className="text-sm text-slate-600">Apellido</label><input name="apellido" value={form.apellido} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: P√©rez" /></div>
      <div className="md:col-span-3"><label className="text-sm text-slate-600">Tel√©fono</label><input name="telefono" value={form.telefono} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: 549381..." /></div>
      <div className="md:col-span-3"><label className="text-sm text-slate-600">Contacto Padre/Madre (Escuelita)</label><input name="contactoPadre" value={form.contactoPadre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Nombre y tel√©fono" /></div>
      <div><label className="text-sm text-slate-600">Deporte</label><select name="deporte" value={form.deporte} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{DEPORTES.map(d => <option key={d}>{d}</option>)}</select></div>
      <div><label className="text-sm text-slate-600">Estado</label><select name="estado" value={form.estado} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{ESTADOS_ALUMNO.map(e => <option key={e.value} value={e.value}>{e.label}</option>)}</select></div>
      
      {/* --- SECCI√ìN DE PLANES MODIFICADA --- */}
      <div className="md:col-span-6 grid grid-cols-1 md:grid-cols-[1fr_auto] items-end gap-3">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label className="text-sm text-slate-600">Plan de Pago</label>
            <select name="plan" value={form.plan} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">
              {PLANES_PAGO.map(p => (<option key={p.value} value={p.value}>{p.label}</option>))}
            </select>
          </div>
          
          {isMensual && (
            <div>
              <label className="text-sm text-slate-600">Frecuencia (Plan Mensual)</label>
              <select name="frecuencia" value={form.frecuencia} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">
                {FRECUENCIAS_MENSUALES.map(f => (<option key={f.value} value={f.value}>{f.label}</option>))}
              </select>
            </div>
          )}

          {/* -- NUEVO: SELECTOR DE GRUPO -- */}
          {isGrupoMensual && (
            <div>
              <label className="text-sm text-slate-600">Asignar a Grupo</label>
              <select name="grupoId" value={form.grupoId || ''} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">
                <option value="">-- Selecciona un grupo --</option>
                {grupos.map(g => (<option key={g.id} value={g.id}>{g.nombre} ({formatCurrency(g.precioMensualPorAlumno)}/mes)</option>))}
              </select>
            </div>
          )}
        </div>

        {(isMensual || isGrupoMensual) && (
          <button type="button" disabled={!canRegisterAbono} onClick={() => onRegisterMonthlyPayment?.(studentBeingEdited)} title={canRegisterAbono ? 'Registrar pago de abono' : 'Guarda el alumno para registrar pago'} className={`inline-flex items-center justify-center gap-2 h-10 px-4 rounded-lg text-sm font-medium transition ${canRegisterAbono ? "bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm" : "bg-white border border-slate-200 text-slate-400 cursor-not-allowed"}`}>
            üí≥ <span>Registrar pago</span>
          </button>
        )}
      </div>

      <div className="md:col-span-6"><label className="text-sm text-slate-600">Horarios fijos</label><div className="grid gap-2">{(form.horarios || []).map((h, idx) => (<div key={idx} className="flex gap-2 items-center flex-wrap"><select value={h.dia} onChange={(e) => setHorario(idx, 'dia', e.target.value)} className="border rounded-lg px-3 py-2">{DIAS_SEMANA_NOMBRES.map(d => <option key={d}>{d}</option>)}</select><input type="time" value={h.hora} onChange={(e) => setHorario(idx, 'hora', e.target.value)} className="border rounded-lg px-3 py-2" /><button type="button" onClick={() => delHorario(idx)} className="px-2 py-2 rounded-lg border text-red-600 hover:bg-red-50">‚àí</button></div>))}<button type="button" onClick={addHorario} className="self-start px-3 py-1.5 rounded-lg border w-auto">+ Agregar horario</button></div></div>
      <div className="md:col-span-6"><label className="text-sm text-slate-600">Notas / Descripci√≥n</label><textarea name="notas" value={form.notas} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" rows={3} placeholder="Detalle particular del alumno" /></div>
      <div className="md:col-span-6 flex gap-2 justify-end"><button type="button" onClick={onCancel} className="px-3 py-2 rounded-lg border">Cancelar</button><button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">Guardar</button></div>
    </form>
  );
} 


function CuentaCorrienteAlumno({ user, clubId, alumno, perfil, desdeMes, hastaMes }) {
  const { abrirModalPago, Modal: ModalAbono } = useModalPagoAbono();
  const [lineas, setLineas] = React.useState([]);
  const [loading, setLoading] = React.useState(true);
  const [error, setError] = React.useState(null);
  const [showInputModal, setShowInputModal] = useState(false);
  const [mesParaExcedente, setMesParaExcedente] = useState(null)

  const refetch = React.useCallback(async () => {
    try {
      setLoading(true);
      const { lineas } = await buildCuentaCorrienteMensual({
        user, clubId, alumno, perfil, desdeMes, hastaMes
      });
      setLineas(lineas);
      setError(null);
    } catch (e) {
      console.error(e);
      setError('No se pudo cargar la cuenta corriente.');
    } finally {
      setLoading(false);
    }
  }, [user, clubId, alumno, perfil, desdeMes, hastaMes]);

  React.useEffect(() => { refetch(); }, [refetch]);

  const pagarCuota = async (mes, monto) => {
    const ok = await abrirModalPago(alumno, mes, Number(monto || 0));
    if (ok) {
      // aseguro doc y acredito cuota
      const m = await ensureMensualidadParaAlumno({
        user, clubId, alumno, perfil, fechaRef: `${mes}-01`
      });
      await acreditarCuotaMensual({ user, clubId, alumno, mensualidad: m });
      await refetch();
    }
  };

    const pagarExcedente = async (mes) => {
    const monto = await abrirInputModal({
      title: "Pagar Excedente",
      message: `Ingresa el importe a registrar como pago de Excedente para el mes ${mes}:`,
      inputType: "number",
      placeholder: "0"
    });

    // Si el usuario cancela, monto ser√° null
    if (monto === null) return;

    const val = Number(monto || 0);
    if (!isFinite(val) || val <= 0) return;

    await acreditarExcedenteMensual({ user, clubId, alumno, mes, monto: val, metodo: "Efectivo" });
    await refetch();
  };
  // --- FIN DE MODIFICACIONES ---

  if (loading) return <div className="p-3 text-sm text-slate-500">Cargando cuenta corriente‚Ä¶</div>;
  if (error)   return <div className="p-3 text-sm text-red-600">{error}</div>;

  const saldoFinal = lineas.length ? lineas[lineas.length - 1].saldoAcumulado : 0;

  return (
    <div className="bg-white border border-slate-200 rounded-2xl p-4">
      <div className="flex items-center justify-between mb-3">
        <h3 className="font-semibold text-[#34745B]">
          Cuenta Corriente ‚Äî {getNombreCompleto(alumno)}
        </h3>
        <div className={`text-sm font-semibold ${saldoFinal >= 0 ? 'text-slate-700' : 'text-red-700'}`}>
          Saldo acumulado: {formatCurrency(saldoFinal)}
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="min-w-full text-sm">
          <thead className="text-left text-slate-600">
            <tr>
              <th className="py-2 pr-3">Mes</th>
              <th className="py-2 pr-3">Incl./Cons.</th>
              <th className="py-2 pr-3">Cuota</th>
              <th className="py-2 pr-3">Excedente</th>
              <th className="py-2 pr-3">Pagos cuota</th>
              <th className="py-2 pr-3">Pagos exced.</th>
              <th className="py-2 pr-3">Saldo Mes</th>
              <th className="py-2 pr-3">Saldo Acum.</th>
              <th className="py-2 pr-3">Acciones</th>
            </tr>
          </thead>
          <tbody className="align-top">
            {lineas.map(l => (
              <tr key={l.mes} className="border-t">
                <td className="py-2 pr-3 whitespace-nowrap">{l.mes}</td>
                <td className="py-2 pr-3">{l.incluidas}/{l.consumidas}</td>
                <td className="py-2 pr-3">{formatCurrency(l.cuota)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.excedente)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.pagCuota)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.pagExced)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.saldoMes)}</td>
                <td className="py-2 pr-3">{formatCurrency(l.saldoAcumulado)}</td>
                <td className="py-2 pr-3">
                  <div className="flex gap-2">
                    <button
                      type="button"
                      onClick={() => pagarCuota(l.mes, l.cuota)}
                      className="px-2 py-1 rounded border text-xs bg-emerald-600 text-white hover:bg-emerald-700"
                    >
                      Pagar cuota
                    </button>
                    <button
                      type="button"
                      onClick={() => pagarExcedente(l.mes)}
                      className="px-2 py-1 rounded border text-xs bg-sky-600 text-white hover:bg-sky-700"
                    >
                      Pagar exced.
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Renderiza los modales aqu√≠ */}
      <ModalAbono />
      <InputModalExcedente />
    </div>
  );
}

    
// --- COPIA Y REEMPLAZA TU FUNCI√ìN 'Alumnos' COMPLETA CON ESTA ---

const WhatsappIcon = (props) => (
  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" {...props}>
    <path d="M16.75 13.96c.25.13.43.28.53.49.12.21.18.44.18.7v.29c0 .21-.04.4-.13.58s-.21.33-.36.44c-.15.11-.33.2-.53.26-.2.06-.42.09-.67.09-.31 0-.63-.05-.96-.14-.33-.09-.68-.22-1.05-.38-.37-.17-.74-.38-1.11-.63-.37-.25-.72-.54-1.04-.88-.32-.34-.59-.7-.81-1.08-.22-.38-.39-.77-.5-1.17s-.17-.8-.17-1.21c0-.25.03-.49.08-.71s.14-.43.26-.61.28-.33.46-.45.4-.21.66-.21h.29c.21 0 .4.06.56.17.17.11.3.27.4.46.1.19.15.39.15.59 0 .09-.01.18-.04.27s-.06.18-.1.28-.09.19-.15.28-.13.18-.21.26c-.09.09-.18.16-.29.23-.11.07-.22.13-.33.18-.08.04-.15.08-.21.11-.11.05-.19.12-.24.2a.45.45 0 0 0-.15.31c0 .06.01.12.03.18.02.06.05.12.09.19.14.24.32.48.54.7.22.22.45.4.7.54.07.04.13.07.19.09.06.02.12.03.18.03.13 0 .25-.05.34-.15.1-.1.17-.22.24-.37.04-.06.08-.12.11-.2.05-.1.11-.19.18-.26s.14-.14.22-.2c.08-.06.17-.11.26-.15.1-.04.2-.08.31-.11.11-.03.22-.05.33-.05.26.01.5.08.7.21.2.13.35.29.43.49z" />
  </svg>
);

// 2. Funci√≥n 'Alumnos' actualizada
function Alumnos({
  alumnos,
  grupos,
  onCreate, onUpdate, onDelete,
  onRegisterMonthlyPayment,
  clases, pagos, perfil, mensualidades,
  onRegistrarClase, onPagarPendiente, onEditarPago, onDeletePago,
  user,
  clubActivoId,
  setToast,
  openRegistrarClaseForAlumno = () => {}
}) {
  const [q, setQ] = useState("");
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);
  const [alumnoFicha, setAlumnoFicha] = useState(null);
  const emptyForm = {
    nombre: "", apellido: "", telefono: "", contactoPadre: "",
    deporte: "P√°del", estado: "activo", plan: "porClase",
    frecuencia: "1xSemana", notas: "", horarios: []
  };

  const [currentPage, setCurrentPage] = useState(1);
  const ITEMS_PER_PAGE = 10;

  const desdeMesCC = (() => { const d = new Date(); d.setMonth(d.getMonth() - 5); d.setDate(1); return mesClave(d); })();
  const hastaMesCC = mesClave(new Date());

  const alumnosConEstadoDePago = useMemo(() => {
    const hoy = new Date();
    const mesAnioClave = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
    const gruposMap = new Map((grupos || []).map(g => [g.id, g]));

    return (alumnos || []).map(alumno => {
      if (alumno.plan !== 'mensual' && alumno.plan !== 'grupo_mensual') {
        return { ...alumno, estadoCuota: 'N/A' };
      }

      let montoCuota = 0;
      if (alumno.plan === 'mensual') {
        montoCuota = parseFloat(perfil.preciosMensuales?.[alumno.frecuencia] || 0);
      } else if (alumno.plan === 'grupo_mensual') {
        const grupoDelAlumno = gruposMap.get(alumno.grupoId);
        montoCuota = parseFloat(grupoDelAlumno?.precioMensualPorAlumno || 0);
      }
      
      const totalPagado = (pagos || [])
        .filter(p => p.alumnoId === alumno.id && /cuota|abono/i.test(p.concepto || '') && (p.fecha || '').startsWith(mesAnioClave))
        .reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);

      let estadoCuota = 'Pendiente';
      if (montoCuota <= 0) {
        estadoCuota = 'Sin Precio';
      } else if (totalPagado >= montoCuota) {
        estadoCuota = 'Pagado';
      } else if (totalPagado > 0) {
        estadoCuota = 'Parcial';
      }

      return { ...alumno, estadoCuota };
    });
  }, [alumnos, pagos, perfil, grupos]);

  const sortedAlumnos = useMemo(() => {
    const qLower = q.trim().toLowerCase();
    const fil = alumnosConEstadoDePago.filter(a => {
      if (!qLower) return true;
      const nameMatch = getNombreCompleto(a).toLowerCase().includes(qLower);
      const scheduleMatch = (a.horarios || []).some(h => h.dia.toLowerCase().includes(qLower));
      return nameMatch || scheduleMatch;
    });
    return fil.sort((a,b)=> getNombreCompleto(a).localeCompare(getNombreCompleto(b), "es", {sensitivity:"base"}));
  }, [alumnosConEstadoDePago, q]);

  const totalPages = Math.ceil(sortedAlumnos.length / ITEMS_PER_PAGE);
  const paginatedAlumnos = useMemo(() => {
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    return sortedAlumnos.slice(startIndex, startIndex + ITEMS_PER_PAGE);
  }, [sortedAlumnos, currentPage]);

  useEffect(() => { setCurrentPage(1); }, [q]);

  function openNew() { setEditing(null); setShowForm(true); window.scrollTo({ top: 0, behavior: "smooth" }); }
  function openEdit(a) { setEditing(a); setShowForm(true); window.scrollTo({ top: 0, behavior: "smooth" }); }
  function cancel() { setShowForm(false); setEditing(null); }
  
  async function submit(formData) {
    if (editing) {
      onUpdate({ ...formData, id: editing.id });
      cancel();
    } else {
      try {
        const nuevoAlumnoConId = await onCreate(formData);
        cancel();
        if ((formData.plan === 'mensual' || formData.plan === 'grupo_mensual') && nuevoAlumnoConId) {
          onRegisterMonthlyPayment(nuevoAlumnoConId);
        }
      } catch (error) {
        console.error("Error al guardar el alumno:", error);
        alert("Hubo un error al guardar el alumno.");
      }
    }
  }

  const EstadoCuotaChip = ({ estado }) => {
    if (!estado || estado === 'N/A') return null;
    const colorClass = 
        estado === 'Pagado' ? 'bg-emerald-100 text-emerald-800' :
        estado === 'Parcial' ? 'bg-amber-100 text-amber-800' :
        estado === 'Pendiente' ? 'bg-rose-100 text-rose-800' :
        'bg-slate-100 text-slate-800';
    return <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${colorClass}`}>{estado}</span>;
  };

  return (
    <>
      <div className="grid gap-4">
        <Card title={<span className="text-[#34745B]">{editing ? "Editar alumno" : "Nuevo alumno"}</span>} right={!showForm && <button onClick={openNew} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">+ Nuevo</button>}>
          {showForm ? (
            <AlumnoForm initialData={editing ? { ...emptyForm, ...editing } : emptyForm} onSubmit={submit} onCancel={cancel} onRegisterMonthlyPayment={onRegisterMonthlyPayment} studentBeingEdited={editing} grupos={grupos}/>
          ) : (
            <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nuevo</b> para crear un alumno, o en el l√°piz para editar.</p>
          )}
        </Card>

        <Card title={<span className="text-[#34745B]">Listado de alumnos</span>} right={<input value={q} onChange={(e) => setQ(e.target.value)} placeholder="Buscar por nombre..." className="border rounded-xl px-3 py-1.5 text-sm" />}>
          
          <div className="hidden md:block overflow-x-auto border rounded-xl">
            <table className="min-w-[720px] w-full text-sm">
              <thead className="bg-slate-50 text-slate-700">
                <tr>
                  <th className="p-3 text-left font-semibold">Nombre Completo</th>
                  <th className="p-3 text-left font-semibold">Tel√©fono</th>
                  <th className="p-3 text-left font-semibold">Plan de Pago</th>
                  <th className="p-3 text-left font-semibold">Estado Cuota</th>
                  <th className="p-3 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {paginatedAlumnos.map((a) => (
                  <tr key={a.id} className="border-t hover:bg-slate-50/50">
                    <td className="p-3 whitespace-nowrap font-semibold">{getNombreCompleto(a)}</td>
                    <td className="p-3 whitespace-nowrap">
                      {/* --- INICIO DE LA CORRECCI√ìN (TABLA) --- */}
                      <div className="flex items-center gap-2">
                        <span>{a.telefono || "-"}</span>
                        {a.telefono && (
                          <a href={waLink(a.telefono, a.nombre)} target="_blank" rel="noreferrer" className="text-emerald-600 hover:text-emerald-800" title="Enviar WhatsApp">
                            <WhatsappIcon />
                          </a>
                        )}
                      </div>
                      {/* --- FIN DE LA CORRECCI√ìN (TABLA) --- */}
                    </td>
                    <td className="p-3 whitespace-nowrap">{a.plan === 'grupo_mensual' ? `Grupo: ${grupos.find(g => g.id === a.grupoId)?.nombre || 'N/A'}`: (a.plan === 'mensual' ? 'Mensual' : 'Por Clase')}</td>
                    <td className="p-3 whitespace-nowrap"><EstadoCuotaChip estado={a.estadoCuota} /></td>
                    <td className="p-3 text-right">
                      <div className="flex gap-1.5 justify-end flex-nowrap">
                        <button type="button" onClick={() => setAlumnoFicha(a)} title="Ver ficha">üìã</button>
                        <button type="button" onClick={() => openRegistrarClaseForAlumno(a.id)} title="Registrar clase">‚úîÔ∏è</button>
                        <button onClick={() => openEdit(a)} title="Editar">‚úèÔ∏è</button>
                        <button type="button" onClick={() => onDelete(a.id)} title="Eliminar">üóëÔ∏è</button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="block md:hidden space-y-3">
            {paginatedAlumnos.map((a) => (
              <div key={a.id} className="p-3 border rounded-lg bg-white shadow-sm">
                <div className="flex justify-between items-start">
                  <span className="font-semibold text-slate-800 pr-2">{getNombreCompleto(a)}</span>
                  <div className="flex gap-1.5 justify-end flex-nowrap shrink-0">
                    <button type="button" onClick={() => setAlumnoFicha(a)} title="Ver ficha">üìã</button>
                    <button type="button" onClick={() => openRegistrarClaseForAlumno(a.id)} title="Registrar clase">‚úîÔ∏è</button>
                    <button onClick={() => openEdit(a)} title="Editar">‚úèÔ∏è</button>
                    <button type="button" onClick={() => onDelete(a.id)} title="Eliminar">üóëÔ∏è</button>
                  </div>
                </div>
                <div className="mt-2 pt-2 border-t grid grid-cols-[auto,1fr] gap-x-3 gap-y-1 text-sm">
                  <span className="text-slate-500">Tel√©fono:</span>
                  {/* --- INICIO DE LA CORRECCI√ìN (TARJETA) --- */}
                  <div className="flex items-center gap-2">
                    <span className="text-slate-800">{a.telefono || "-"}</span>
                    {a.telefono && (
                      <a href={waLink(a.telefono, a.nombre)} target="_blank" rel="noreferrer" className="text-emerald-600 hover:text-emerald-800" title="Enviar WhatsApp">
                        <WhatsappIcon />
                      </a>
                    )}
                  </div>
                  {/* --- FIN DE LA CORRECCI√ìN (TARJETA) --- */}
                  <span className="text-slate-500">Plan:</span>
                  <span className="text-slate-800">{a.plan === 'grupo_mensual' ? `Grupo: ${grupos.find(g => g.id === a.grupoId)?.nombre || 'N/A'}`: (a.plan === 'mensual' ? 'Mensual' : 'Por Clase')}</span>
                  <span className="text-slate-500">Cuota:</span>
                  <span className="text-slate-800"><EstadoCuotaChip estado={a.estadoCuota} /></span>
                </div>
              </div>
            ))}
          </div>
          
          {paginatedAlumnos.length === 0 && (<div className="text-center py-6 text-slate-400">No se encontraron alumnos.</div>)}
          {totalPages > 1 && (
  <div className="mt-4 flex justify-center items-center gap-2">
    <button 
      onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} 
      disabled={currentPage === 1} 
      className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50"
    >
      Anterior
    </button>
    <span className="text-sm text-slate-600">
      P√°gina {currentPage} de {totalPages}
    </span>
    <button 
      onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} 
      disabled={currentPage === totalPages} 
      className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50"
    >
      Siguiente
    </button>
  </div>
)}
        </Card>
        
        {alumnoFicha && (alumnoFicha.plan === "mensual" || alumnoFicha.plan === "grupo_mensual") && (
            <Card title={<span className="text-[#34745B]">Cuenta Corriente</span>}>
                <CuentaCorrienteAlumno user={user} clubId={clubActivoId} alumno={alumnoFicha} perfil={perfil} desdeMes={desdeMesCC} hastaMes={hastaMesCC} grupos={grupos} />
            </Card>
        )}
      </div>

      <AlumnoFichaModal {...{alumno: alumnoFicha, clases, pagos, alumnos, grupos, mensualidades, perfil, user, clubId: clubActivoId, onClose: () => setAlumnoFicha(null), onPagarPendiente, onRegisterMonthlyPayment, onEditarPago, onDeletePago, setToast}} />
    </>
  );
}
    
// ========= NUEVO PANEL RESUMEN (uso interno del modal) =========
function CuentaCorrientePanel({ alumno, clases = [], pagos = [], mensualidades = [], onRegistrarPago }) {
  const INCL = { "1xSemana": 4, "2xSemana": 8, "3xSemana": 12, "4xSemana": 16, "libre": 9999 };
  const hoy = new Date();
  const y = hoy.getFullYear();
  const m = String(hoy.getMonth() + 1).padStart(2, '0');
  const mesClaveActual = `${y}-${m}`;

  const datosMensualidad = React.useMemo(() => {
    const docMensualidad = (mensualidades || []).find(mens => mens.alumnoId === alumno.id && mens.mes === mesClaveActual);
    const creditosDisponibles = docMensualidad?.creditosRecuperacion?.disponibles || 0;
    
    const clasesMes = (clases || []).filter(c =>
      (c.fecha || '').startsWith(mesClaveActual) &&
      (c.estado === 'Realizada' || c.estado === 'Ausente') &&
      Array.isArray(c.alumnoIds) &&
      c.alumnoIds.includes(alumno.id)
    );
    const consumidas = clasesMes.length;

    const incluidas = INCL[alumno.frecuencia] ?? 4;
    const restantes = Math.max(0, incluidas - consumidas);

    const pagosMes = (pagos || []).filter(p =>
      p.alumnoId === alumno.id &&
      (p.fecha || '').startsWith(mesClaveActual) &&
      (p.metodo === 'Mensual' || /cuota|abono/i.test(p.concepto || ''))
    );
    const montoPagadoMes = pagosMes.reduce((acc, p) => acc + Number(p.monto || 0), 0);
    const cuotaPagada = montoPagadoMes > 0;

    return { consumidas, incluidas, restantes, montoPagadoMes, cuotaPagada, creditosDisponibles, clasesMes };
  }, [alumno, clases, pagos, mensualidades, mesClaveActual]);

  return (
    <div className="grid gap-4">
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div className="p-3 rounded-xl border bg-white">
          <p className="text-xs text-slate-500">Frecuencia</p>
          <p className="font-semibold">{alumno.frecuencia || '‚Äî'}</p>
        </div>
        <div className="p-3 rounded-xl border bg-white">
          {/* --- CORREGIDO --- */}
          <p className="text-xs text-slate-500">Incluidas este mes</p>
          <p className="font-semibold">{datosMensualidad.incluidas}</p>
        </div>
        <div className="p-3 rounded-xl border bg-white">
           {/* --- CORREGIDO --- */}
          <p className="text-xs text-slate-500">Consumidas</p>
          <p className="font-semibold">{datosMensualidad.consumidas}</p>
        </div>
        <div className="p-3 rounded-xl border bg-white">
           {/* --- CORREGIDO --- */}
          <p className="text-xs text-slate-500">Restantes</p>
          <p className="font-semibold">{datosMensualidad.restantes}</p>
        </div>
        <div className="p-3 rounded-xl border bg-sky-50 border-sky-200 col-span-2 md:col-span-4">
           {/* --- CORREGIDO --- */}
          <p className="text-xs text-sky-700">Cr√©ditos para Recuperar</p>
          <p className="font-semibold text-sky-800 text-lg">{datosMensualidad.creditosDisponibles}</p>
        </div>
      </div>

      <div className="flex items-center justify-between p-3 rounded-xl border bg-slate-50">
        <div>
          <p className="text-sm text-slate-600">Cuota del mes ({mesClaveActual})</p>
          {/* --- CORREGIDO --- */}
          <p className={`text-sm font-semibold ${datosMensualidad.cuotaPagada ? 'text-emerald-700' : 'text-red-700'}`}>
            {datosMensualidad.cuotaPagada ? `Pagada ¬∑ ${formatCurrency(datosMensualidad.montoPagadoMes)}` : 'Pendiente'}
          </p>
        </div>
        <button
          type="button"
          onClick={() => onRegistrarPago && onRegistrarPago(alumno)}
          className="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm"
        >
          Registrar cuota
        </button>
      </div>

      <div>
        <p className="text-sm font-semibold text-slate-700 mb-2">Clases del mes ({datosMensualidad.clasesMes.length})</p>
        {/* --- CORREGIDO --- */}
        {datosMensualidad.clasesMes.length === 0 ? (
          <p className="text-sm text-slate-500">Sin clases realizadas a√∫n en {mesClaveActual}.</p>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="text-left text-slate-500">
                  <th className="p-2">Fecha</th>
                  <th className="p-2">Hora</th>
                  <th className="p-2">Tipo</th>
                  <th className="p-2">Estado</th>
                </tr>
              </thead>
              <tbody>
                {datosMensualidad.clasesMes.sort((a,b)=>a.hora.localeCompare(b.hora)).map(c => (
                  <tr key={c.id} className="border-t">
                    <td className="p-2">{c.fecha}</td>
                    <td className="p-2">{c.hora}</td>
                    <td className="p-2">{c.tipo}</td>
                    <td className="p-2">
                      <span className="px-2 py-0.5 rounded-full text-xs bg-emerald-100 text-emerald-800">
                        {c.estado}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

// ========= REEMPLAZ√Å TU AlumnoFichaModal POR ESTE =========
function AlumnoFichaModal({
  alumno,
  alumnos = [],
  clases = [],
  pagos = [],
  grupos = [],
  mensualidades = [],
  perfil,
  user, clubId,
  onClose,
  onPagarPendiente,
  onRegistrarPago,
  onEditarPago,
  onDeletePago,
  setToast
}) {
  // --- CORRECCI√ìN: Se mueven todos los Hooks ANTES del retorno condicional ---
  const a = alumno;
  const [tab, setTab] = React.useState('clases');
  const [editingAsistencia, setEditingAsistencia] = React.useState(null);

  const estadoCuotaMesActual = React.useMemo(() => {
    if (!a || (a.plan !== 'mensual' && a.plan !== 'grupo_mensual')) return { visible: false };
    
    const hoy = new Date();
    const mesAnioClave = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
    let montoCuota = 0;

    if (a.plan === 'mensual') {
      montoCuota = parseFloat(perfil?.preciosMensuales?.[a.frecuencia] || 0);
    } else if (a.plan === 'grupo_mensual') {
      const grupoDelAlumno = (grupos || []).find(g => g.id === a.grupoId);
      montoCuota = parseFloat(grupoDelAlumno?.precioMensualPorAlumno || 0);
    }

    if (montoCuota <= 0) return { visible: true, texto: 'Plan sin precio', status: 'N/A' };
    
    const totalPagado = (pagos || [])
      .filter(p => p.alumnoId === a.id && /cuota|abono/i.test(p.concepto || '') && (p.fecha || '').startsWith(mesAnioClave))
      .reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
    
    let status = 'Pendiente';
    if (totalPagado >= montoCuota) status = 'Pagado';
    else if (totalPagado > 0) status = 'Parcial';
    
    return { visible: true, texto: status, status };
  }, [a, pagos, perfil, grupos]);

  const clasesDelAlumno = React.useMemo(() => 
    (clases || []).filter(c => Array.isArray(c.alumnoIds) && c.alumnoIds.includes(a?.id)),
  [clases, a]);

  const pagosDelAlumno  = React.useMemo(() => 
    (pagos || []).filter(p => p.alumnoId === a?.id),
  [pagos, a]);
  
  // --- El retorno condicional ahora est√° DESPU√âS de todos los Hooks ---
  if (!a) return null;

  const getStatusChipColor = (status) => {
    switch (status) {
      case 'Pagado': return 'bg-emerald-100 text-emerald-800';
      case 'Parcial': return 'bg-amber-100 text-amber-800';
      case 'Pendiente': return 'bg-rose-100 text-rose-800';
      default: return 'bg-slate-100 text-slate-800';
    }
  };
  
  const handleMarcarAsistencia = async (clase, alumnoId, nuevoEstadoAsistencia) => {
    try {
      const clasesCollectionRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubId).collection('clases');
      const claseDocRef = clasesCollectionRef.doc(clase.id);

      const updateData = { [`asistencia.${alumnoId}`]: nuevoEstadoAsistencia };
      await claseDocRef.update(updateData);

      if (nuevoEstadoAsistencia === 'ausente_justificado') {
        const mesClaveClase = mesClave(clase.fecha);
        const mensualidadId = `${alumnoId}_${mesClaveClase}`;
        const mensualidadsRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubId).collection('mensualidades');
        const mensualidadDocRef = mensualidadsRef.doc(mensualidadId);

        await mensualidadDocRef.set({
          alumnoId: alumnoId,
          mes: mesClaveClase,
          creditosRecuperacion: {
            disponibles: firebase.firestore.FieldValue.increment(1)
          }
        }, { merge: true });
        
        setToast("Ausencia justificada registrada. Se gener√≥ 1 cr√©dito de recuperaci√≥n.");
      } else {
        setToast("Asistencia actualizada.");
      }
      
      setEditingAsistencia(null);
    } catch (error) {
      console.error("Error al marcar asistencia:", error);
      alert("No se pudo guardar el cambio.");
    }
  };

  const nombreCompleto = getNombreCompleto(a);

  return (
    <Modal
      isOpen={!!alumno}
      title={
        <div className="flex items-center gap-3">
          <span>Ficha de {nombreCompleto}</span>
          {estadoCuotaMesActual.visible && (
            <span className={`px-2 py-1 rounded-full text-xs font-semibold ${getStatusChipColor(estadoCuotaMesActual.texto)}`}>
              Cuota {MESES_NOMBRES[new Date().getMonth()]}: {estadoCuotaMesActual.texto}
            </span>
          )}
        </div>
      }
      size="7xl"
      confirmText="Cerrar"
      onConfirm={onClose}
      onCancel={onClose}
    >
      <div className="grid md:grid-cols-[280px_1fr] gap-6">
        <div className="p-4 rounded-2xl bg-slate-50 border">
          <h3 className="text-lg font-bold text-slate-800 mb-3">{nombreCompleto}</h3>
          <ul className="space-y-2 text-sm">
            <li>üè∏ Deporte: <strong>{a.deporte || '‚Äî'}</strong></li>
            <li>‚úÖ Estado: <strong>{a.estado === 'activo' ? 'Activo' : 'Espera'}</strong></li>
            <li>üí≥ Plan de Pago: <strong>{a.plan === 'grupo_mensual' ? `Grupo: ${(grupos.find(g => g.id === a.grupoId) || {}).nombre || 'N/A'}` : (a.plan === 'mensual' ? 'Mensual' : 'Por Clase')}</strong></li>
            {a.plan === 'mensual' && <li>üìÜ Frecuencia: <strong>{a.frecuencia || '‚Äî'}</strong></li>}
          </ul>
        </div>
        
        <div className="min-w-0">
          <div className="flex gap-6 border-b mb-4">
            <button className={`pb-2 -mb-px border-b-2 ${tab === 'clases' ? 'border-emerald-600 text-emerald-700' : 'border-transparent text-slate-500'}`} onClick={() => setTab('clases')}>Clases ({clasesDelAlumno.length})</button>
            <button className={`pb-2 -mb-px border-b-2 ${tab === 'pagos' ? 'border-emerald-600 text-emerald-700' : 'border-transparent text-slate-500'}`} onClick={() => setTab('pagos')}>Pagos ({pagosDelAlumno.length})</button>
            {(a.plan === 'mensual' || a.plan === 'grupo_mensual') && <button className={`pb-2 -mb-px border-b-2 ${tab === 'cuenta' ? 'border-emerald-600 text-emerald-700' : 'border-transparent text-slate-500'}`} onClick={() => setTab('cuenta')}>Cuenta Corriente</button>}
          </div>

          {tab === 'clases' && (
            <div>
              <h4 className="text-base font-semibold text-slate-700 mb-2">Historial de Clases</h4>
              {clasesDelAlumno.length === 0 ? (
                <p className="text-sm text-slate-500">Sin clases a√∫n.</p>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="text-left text-slate-500">
                        <th className="p-2">Fecha</th>
                        <th className="p-2">Tipo</th>
                        <th className="p-2">Estado de Pago</th>
                        <th className="p-2 text-right">Asistencia / Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      {clasesDelAlumno
                        .sort((a,b)=> (b.fecha+b.hora).localeCompare(a.fecha+a.hora))
                        .map(c => {
                          const esClaseGrupal = !!c.origenGrupoId;
                          const esPlanGrupal = a.plan === 'grupo_mensual';
                          let pagoLabel = 'No aplica';
                          let pagoClass = 'bg-slate-100 text-slate-700';

                          if (a.plan === 'porClase') {
                            const generaCobro = ['realizada', 'ausente'].includes(String(c.estado || '').toLowerCase());
                            if (generaCobro) {
                              const totalPagado = (pagos || []).filter(p => p.claseId === c.id && p.alumnoId === a.id).reduce((acc,p)=> acc + Number(p.monto || 0), 0);
                              const precioPorAlumno = Number(c.precio || 0) / Math.max(1, (c.alumnoIds || []).length);
                              const pendiente = totalPagado < precioPorAlumno;
                              pagoLabel = pendiente ? 'Pendiente' : 'Pagada';
                              pagoClass = pendiente ? 'bg-rose-100 text-rose-800' : 'bg-emerald-100 text-emerald-800';
                            }
                          } else {
                            pagoLabel = 'Pagada (Abono)';
                            pagoClass = 'bg-emerald-100 text-emerald-800';
                          }

                          const estadoAsistencia = c.asistencia?.[a.id] || 'presente';
                          const esPasada = new Date(`${c.fecha}T23:59:59`) < new Date();

                          return (
                            <tr key={c.id} className="border-t">
                              <td className="p-2">{fechaDDMMYYYY(c.fecha)}</td>
                              <td className="p-2 flex items-center gap-2">
                                {c.tipo}
                                {esClaseGrupal && <span className="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800" title={`Grupo: ${c.nombreGrupo}`}>G</span>}
                              </td>
                              <td className="p-2">
                                <span className={`px-2 py-0.5 rounded-full text-xs ${pagoClass}`}>
                                  {pagoLabel}
                                </span>
                              </td>
                              <td className="p-2 text-right">
                                {esPlanGrupal && esClaseGrupal && esPasada ? (
                                  editingAsistencia === c.id ? (
                                    <div className="inline-flex gap-1">
                                      <select 
                                        defaultValue={estadoAsistencia}
                                        onChange={(e) => handleMarcarAsistencia(c, a.id, e.target.value)}
                                        onBlur={() => setEditingAsistencia(null)}
                                        className="text-xs rounded border bg-white"
                                        autoFocus
                                      >
                                        <option value="presente">Presente</option>
                                        <option value="ausente">Ausente</option>
                                        <option value="ausente_justificado">Ausente (Justificado)</option>
                                      </select>
                                    </div>
                                  ) : (
                                    <button onClick={() => setEditingAsistencia(c.id)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50 mr-2">
                                      Asistencia: <span className="font-semibold capitalize">{estadoAsistencia.replace(/_/g, ' ')}</span>
                                    </button>
                                  )
                                ) : (
                                  (pagoLabel === 'Pendiente' && a.plan === 'porClase') && (
                                    <button
                                      type="button"
                                      onClick={() => onPagarPendiente && onPagarPendiente(c, a.id)}
                                      className="px-2 py-1 text-xs rounded-lg border bg-green-50 text-green-800 hover:bg-green-100"
                                    >
                                      Registrar Pago
                                    </button>
                                  )
                                )}
                              </td>
                            </tr>
                          );
                        })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {tab === 'pagos' && (
            <div>
              <h4 className="text-base font-semibold text-slate-700 mb-2">Pagos</h4>
              {pagosDelAlumno.length === 0 ? (
                <p className="text-sm text-slate-500">Sin pagos a√∫n.</p>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                      <tr className="text-left text-slate-500">
                        <th className="p-2">Fecha</th>
                        <th className="p-2">Concepto</th>
                        <th className="p-2">M√©todo</th>
                        <th className="p-2">Monto</th>
                        <th className="p-2 text-right">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      {pagosDelAlumno
                        .sort((a,b)=> (a.fecha || '').localeCompare(b.fecha || ''))
                        .map(p => (
                          <tr key={p.id || `${p.fecha}-${p.monto}-${Math.random()}`} className="border-t">
                            <td className="p-2">{p.fecha}</td>
                            <td className="p-2">{p.concepto}</td>
                            <td className="p-2">{p.metodo}</td>
                            <td className="p-2">${Number(p.monto || 0)}</td>
                            <td className="p-2 text-right">
                              {onEditarPago && (
                                <button
                                  type="button"
                                  onClick={() => onEditarPago(p)}
                                  className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50 mr-2"
                                >
                                  Editar
                                </button>
                              )}
                              {onDeletePago && (
                                <button
                                  type="button"
                                  onClick={() => onDeletePago(p.id)}
                                  className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50"
                                >
                                  Eliminar
                                </button>
                              )}
                            </td>
                          </tr>
                        ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {tab === 'cuenta' && (a.plan === 'mensual' || a.plan === 'grupo_mensual') && (
            <CuentaCorrientePanel
              alumno={a}
              clases={clases}
              pagos={pagos}
              mensualidades={mensualidades}
              onRegistrarPago={onRegistrarPago}
            />
          )}
        </div>
      </div>
    </Modal>
  );
}

// --- REEMPLAZA TU FUNCI√ìN 'CalendarioSemanal' COMPLETA CON ESTA VERSI√ìN FINAL ---

function CalendarioSemanal({
  week,
  clases,
  alumnos = [],
  onEdit,
  horarioLaboral,
  mostrarSoloHorarioLaboral
}) {
  const alumnoMap = useMemo(() => new Map((alumnos || []).map(a => [a.id, a])), [alumnos]);

  const getStatusColor = (status) => {
    switch (status) {
      case "Realizada": return "bg-emerald-100 border-emerald-300 text-emerald-800";
      case "Cancelada": return "bg-red-100 border-red-300 text-red-800";
      case "Ausente":   return "bg-amber-100 border-amber-300 text-amber-800";
      default:          return "bg-green-50 border-[#89C5B2] text-[#34745B]";
    }
  };

  // --- L√≥gica para la vista de Grilla (Desktop) ---
  const clasesPorDiaHora = React.useMemo(() => {
    const map = {};
    (clases || []).forEach(clase => {
      const key = `${clase.fecha}_${clase.hora}`;
      if (!map[key]) map[key] = [];
      map[key].push(clase);
    });
    return map;
  }, [clases]);

  const nombreDiaFromYMD = (ymd) => {
    const d = new Date(`${ymd}T00:00:00`);
    const idx = (d.getDay() + 6) % 7;
    return DIAS_SEMANA_NOMBRES[idx];
  };

  const horaToMin = (hhmm = "00:00") => {
    const [h, m] = String(hhmm).split(":").map(Number);
    return (h * 60) + (m || 0);
  };
  
  const incluyeHora = (bloque, hhmm) => {
    const t = horaToMin(hhmm);
    const desde = horaToMin(bloque?.desde || "08:00");
    const hasta = horaToMin(bloque?.hasta || "20:00");
    return t >= desde && (t + 60) <= hasta;
  };

  const bloquesPorDia = React.useMemo(() => {
    const out = new Map(DIAS_SEMANA_NOMBRES.map(d => [d, []]));
    const raw = horarioLaboral || [];
    const lista = Array.isArray(raw) ? raw : (raw?.bloques || []);
    (lista || []).filter(b => (b?.activo ?? true)).forEach(b => {
      const arr = out.get(b.dia) || [];
      arr.push({ desde: b.desde || "08:00", hasta: b.hasta || "20:00" });
      out.set(b.dia, arr);
    });
    return out;
  }, [horarioLaboral]);

  const esHoraLaboral = (dayYMD, hora) => {
    if (!mostrarSoloHorarioLaboral || !horarioLaboral) return true;
    const bloques = bloquesPorDia.get(nombreDiaFromYMD(dayYMD)) || [];
    return bloques.length > 0 ? bloques.some(b => incluyeHora(b, hora)) : false;
  };

  const horasBase = React.useMemo(() => {
    if (Array.isArray(horarioLaboral?.horas) && horarioLaboral.horas.length) return horarioLaboral.horas;
    const hs = []; for (let h = 8; h <= 22; h++) hs.push(String(h).padStart(2, "0") + ":00"); return hs;
  }, [horarioLaboral]);
  
  const horasParaMostrar = React.useMemo(() => {
    if (!mostrarSoloHorarioLaboral) return horasBase;
    return horasBase.filter(hora => week.some(d => esHoraLaboral(d, hora)));
  }, [mostrarSoloHorarioLaboral, horasBase, week, bloquesPorDia]);


  return (
    <>
      {/* --- VISTA DE ESCRITORIO (GRILLA SEMANAL) --- */}
      {/* Se oculta en pantallas peque√±as/medianas (hidden) y se muestra como grid en grandes (lg:grid) */}
      <div 
        className="hidden lg:grid" 
        style={{ gridTemplateColumns: '80px repeat(7, minmax(120px, 1fr))' }}
      >
        {/* Encabezado de d√≠as */}
        <div />
        {week.map(day => (
          <div key={`head-grid-${day}`} className="text-center p-2">
            <div className="font-semibold">{nombreDiaFromYMD(day)}</div>
            <div className="text-xs text-slate-500">{formatDate(day, 'dd/mm/yyyy')}</div>
          </div>
        ))}

        {/* Filas por hora */}
        {horasParaMostrar.map(hora => (
          <React.Fragment key={hora}>
            <div className="bg-white text-center text-xs p-2 flex items-center justify-center border-t border-l border-slate-200">
              <span className="text-slate-500">{hora}</span>
            </div>
            {week.map(day => {
              const laboral = esHoraLaboral(day, hora);
              const clasesEnCelda = clasesPorDiaHora[`${day}_${hora}`] || [];
              return (
                <div key={`${day}-${hora}`} className={`${laboral ? "bg-white hover:bg-slate-50" : "bg-slate-100"} min-h-[70px] p-1 border-t border-l border-slate-200`}>
                  {clasesEnCelda.map(clase => (
                    <div key={clase.id} onClick={() => onEdit && onEdit(clase)} className={`cursor-pointer border rounded-md px-2 py-1 mb-1 text-xs ${getStatusColor(clase.estado)}`}>
                      <div className="font-semibold truncate">{(clase.alumnoIds || []).map(id => getNombreCompleto(alumnoMap.get(id))).join(", ")}</div>
                      {clase.notas && <div className="text-[11px] opacity-80 truncate">{clase.notas}</div>}
                    </div>
                  ))}
                </div>
              );
            })}
          </React.Fragment>
        ))}
      </div>

      {/* --- VISTA M√ìVIL Y TABLET (LISTA VERTICAL) --- */}
      {/* Se muestra en pantallas peque√±as/medianas (block) y se oculta en grandes (lg:hidden) */}
      <div className="block lg:hidden space-y-4">
        {week.map(day => {
          const clasesDelDia = clases.filter(c => c.fecha === day).sort((a, b) => (a.hora || '').localeCompare(b.hora || ''));
          const diaNombre = DIAS_SEMANA_NOMBRES[(new Date(`${day}T00:00:00`).getDay() + 6) % 7];
          
          return (
            <div key={`list-${day}`}>
              <h4 className="font-semibold text-slate-800 border-b pb-1 mb-2">
                {diaNombre}, {formatDate(day, 'dd/mm')}
              </h4>
              {clasesDelDia.length > 0 ? (
                <ul className="space-y-2">
                  {clasesDelDia.map(clase => (
                    <li key={clase.id} onClick={() => onEdit && onEdit(clase)} className={`cursor-pointer border rounded-lg p-2 ${getStatusColor(clase.estado)}`}>
                      <div className="flex items-center gap-3">
                        <span className="font-bold text-sm">{clase.hora}</span>
                        <div className="text-sm min-w-0">
                          <p className="font-semibold truncate">{(clase.alumnoIds || []).map(id => getNombreCompleto(alumnoMap.get(id))).join(', ')}</p>
                          <p className="text-xs opacity-80 truncate">{clase.tipo}{clase.cancha ? ` en ${clase.cancha}` : ''}</p>
                        </div>
                      </div>
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-sm text-slate-400 pl-2">Sin clases programadas.</p>
              )}
            </div>
          );
        })}
      </div>
    </>
  );
}


/**
 * computePrecioClase(tipoDeclarado, alumnoIds, perfil, alumnoMap)
 * - Usa regla 4+ => Escuelita para el precio unitario
 * - Cobra solo a NO mensuales
 * - Devuelve string con total (mantengo compatibilidad donde esperabas string)
 */
function computePrecioClase(tipo, alumnoIds, perfil, alumnoMap = new Map()) {
  const tipoEfectivo = resolveTipoEfectivo(tipo, alumnoIds);
  
  // --- INICIO DE LA CORRECCI√ìN ---

  // 1. Obtenemos el PRECIO TOTAL SUGERIDO desde el Perfil para este tipo de clase.
  //    Ej: Para "Clase 2 personas", esto podr√≠a ser 38000.
  const precioTotalSugerido = parseFloat(getPrecioSugerido(tipoEfectivo, perfil) || 0);

  // 2. Obtenemos cu√°ntas personas se esperan en este tipo de clase (ej: 2 para "Clase 2 personas").
  const personasEnTipo = TIPOS_CLASE_MAP[tipoEfectivo] || 1;

  // 3. Calculamos el precio REAL por alumno, dividiendo el total por la cantidad de personas.
  //    Ej: 38000 / 2 = 19000 por alumno.
  const perAlumno = personasEnTipo > 0 ? precioTotalSugerido / personasEnTipo : precioTotalSugerido;

  // --- FIN DE LA CORRECCI√ìN ---

  const ids = (alumnoIds || []).filter(Boolean);
  
  let count;
  if (ids.length > 0) {
      // Contamos solo los alumnos que no tienen plan mensual para cobrarles.
      count = ids.filter(id => {
          const a = alumnoMap.get(id);
          return a ? a.plan !== 'mensual' : true;
      }).length;
  } else {
      // Si no hay alumnos, usamos la cantidad de personas del tipo de clase (para el precio sugerido).
      count = personasEnTipo;
  }

  // El c√°lculo final ahora usa el precio por alumno correcto.
  // Ej: 19000 * 2 = 38000. ¬°Correcto!
  const total = perAlumno * count;
  return String(total);
}

if (typeof window.resolveTipoEfectivo !== "function") {
  window.resolveTipoEfectivo = function (tipoOriginal, alumnoIds) {
    const n = (alumnoIds || []).filter(Boolean).length;
    if (String(tipoOriginal || "").toLowerCase() === "escuelita") return "Escuelita";
    if (n >= 4) return "Escuelita";
    return tipoOriginal || "Individual";
  };
}

// Precio por tipo (lee primero perfil.preciosClase y luego perfil.precios)
if (typeof window.getPrecioSugerido !== "function") {
  window.getPrecioSugerido = function (tipo, perfil) {
    const KEYMAP_FALLBACK = {
      Individual: "individual",
      Dupla: "dupla",
      Trio: "trio",
      Cuarteto: "cuarteto",
      Escuelita: "escuelita",
    };
    const key =
      (typeof PRECIO_KEY_POR_TIPO !== "undefined" && PRECIO_KEY_POR_TIPO?.[tipo]) ||
      KEYMAP_FALLBACK[tipo] || "individual";
    const tabla = (perfil?.preciosClase) || (perfil?.precios) || {};
    const v = tabla[key];
    return Number.isFinite(+v) ? Number(v) : 0;
  };
}

// Total por clase/grupo (cobra solo a NO mensuales; respeta 4+ => Escuelita)
// Si ya ten√©s computePrecioClase, no redefinimos (evita choques)
if (typeof window.computePrecioClase !== "function") {
  window.computePrecioClase = function (tipo, alumnoIds, perfil, alumnoMap = new Map()) {
    const tipoEfectivo = window.resolveTipoEfectivo(tipo, alumnoIds);
    const perAlumno = window.getPrecioSugerido(tipoEfectivo, perfil);
    const ids = (alumnoIds || []).filter(Boolean);
    const noMensuales = ids.filter(id => {
      const a = alumnoMap.get ? alumnoMap.get(id) : null;
      return a ? a.plan !== "mensual" : true;
    }).length;
    return String(perAlumno * (noMensuales || 0));
  };
}
function nextDateForDiaSemana(diaSemana) {
  const today = new Date();
  // JS: 0=Domingo..6=S√°bado  ‚Üí  1=Lunes..7=Domingo
  const hoy = ((today.getDay() + 6) % 7) + 1;
  let delta = diaSemana - hoy;
  if (delta < 0) delta += 7;
  const d = new Date(today);
  d.setDate(today.getDate() + delta);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

// === Helpers de canchas/ubicaciones (pegalo ANTES de function Clases) ===
function getCanchasFromPerfil(perfil) {
  if (!perfil) return [];

  // Recomendado: array de strings
  if (Array.isArray(perfil.canchasUbicaciones) && perfil.canchasUbicaciones.length) {
    return perfil.canchasUbicaciones
      .map(s => (typeof s === 'string' ? s.trim() : String(s || '').trim()))
      .filter(Boolean);
  }

  // Compatibilidad: array (strings u objetos)
  if (Array.isArray(perfil.canchas) && perfil.canchas.length) {
    return perfil.canchas.map(it => {
      if (typeof it === 'string') return it.trim();
      const sede = (it.sede || it.ubicacion || it.nombreSede || it.nombre || '').trim();
      const cancha = (it.cancha || it.pista || it.court || it.detalle || '').trim();
      const label = [sede, cancha].filter(Boolean).join(' / ').trim();
      return label || '';
    }).filter(Boolean);
  }

  // Compatibilidad: string con saltos de l√≠nea
  if (typeof perfil.canchas === 'string' && perfil.canchas.trim()) {
    return perfil.canchas.split('\n').map(s => s.trim()).filter(Boolean);
  }

  // Onboarding: perfil.ubicaciones (array de strings u objetos)
  if (Array.isArray(perfil.ubicaciones) && perfil.ubicaciones.length) {
    return perfil.ubicaciones.map(u => {
      if (typeof u === 'string') return u.trim();
      const sede = (u.nombre || u.sede || u.ubicacion || '').trim();
      const cancha = (u.cancha || u.detalle || '').trim();
      return [sede, cancha].filter(Boolean).join(' / ');
    }).filter(Boolean);
  }

  return [];
}

    
function Clases({
  clases, alumnos, pagos, perfil, mensualidades,
  onCreate, onUpdate, onDelete, onPay,
  user, clubActivoId,
  claseParaEditar, setClaseParaEditar,
  nuevoAlumnoId, setNuevoAlumnoId,
  prefillClase, onPrefillConsumed,
  grupos, setToast
}) {
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);

  const emptyForm = {
    alumnoIds: [""],
    alumnosRecuperacion: [],
    fecha: formatDate(new Date()),
    hora: "18:00",
    tipo: "Clase 1 persona",
    estado: "Programada",
    precio: "0",
    notas: "",
    cancha: ""
  };
  const [form, setForm] = useState(emptyForm);
  
  const [grupoSeleccionadoId, setGrupoSeleccionadoId] = useState("");
  const [formStep, setFormStep] = useState(1);
  const [alumnoSearchQuery, setAlumnoSearchQuery] = useState("");
  const [isAlumnosListOpen, setIsAlumnosListOpen] = useState(false);
  const [filtroAlumno, setFiltroAlumno] = useState("");
  const [filtroEstado, setFiltroEstado] = useState("");
  const [filtroFechaDesde, setFiltroFechaDesde] = useState("");
  const [filtroFechaHasta, setFiltroFechaHasta] = useState("");
  const { abrirModalPago, Modal: ModalAbono } = useModalPagoAbono();

  useEffect(() => {
    if (prefillClase && prefillClase.fecha && prefillClase.hora) {
      setShowForm(true);
      setForm(prev => ({ ...prev, fecha: prefillClase.fecha, hora: prefillClase.hora }));
      onPrefillConsumed && onPrefillConsumed();
    }
  }, [prefillClase]);

  useEffect(() => {
    if (claseParaEditar) {
      openEdit(claseParaEditar);
      setClaseParaEditar(null);
    }
  }, [claseParaEditar]);
  
  useEffect(() => {
    if (nuevoAlumnoId) {
      setShowForm(true);
      const alumnoSeleccionado = alumnoMap.get(nuevoAlumnoId);
      if (!alumnoSeleccionado) {
        setNuevoAlumnoId(null);
        return;
      }
      const precioSugerido = String(getPrecioSugerido("Clase 1 persona", perfil));
      setForm({ ...emptyForm, alumnoIds: [nuevoAlumnoId], precio: precioSugerido });
      if (alumnoSeleccionado.horarios && alumnoSeleccionado.horarios.length > 0) {
        setFormStep(2);
      } else {
        setFormStep(3);
      }
      setNuevoAlumnoId(null);
    }
  }, [nuevoAlumnoId]);

  const alumnosActivos = useMemo(() => (alumnos || []).filter(a => a.estado === 'activo'), [alumnos]);
  const alumnoMap = useMemo(() => new Map((alumnos || []).map(a => [a.id, a])), [alumnos]);

  const alumnosConCreditos = useMemo(() => {
    const mesActual = mesClave(new Date());
    return (alumnosActivos || []).filter(alumno => {
      if (alumno.plan !== 'grupo_mensual') return false;
      const mens = (mensualidades || []).find(m => m.alumnoId === alumno.id && m.mes === mesActual);
      return (mens?.creditosRecuperacion?.disponibles || 0) > 0;
    });
  }, [alumnosActivos, mensualidades]);

  const alumnosFiltrados = useMemo(() => {
    if (!alumnoSearchQuery) return alumnosActivos;
    return alumnosActivos.filter(alumno => getNombreCompleto(alumno).toLowerCase().includes(alumnoSearchQuery.toLowerCase()));
  }, [alumnoSearchQuery, alumnosActivos]);

  const pagosPorClase = useMemo(() => {
    const map = new Map();
    (pagos || []).forEach(p => {
      if (!map.has(p.claseId)) map.set(p.claseId, []);
      map.get(p.claseId).push(p);
    });
    return map;
  }, [pagos]);

  const clasesConDatos = useMemo(() => (clases || []).map(c => ({
    ...c,
    tipo: normalizarTipoClase(c.tipo),
    nombresAlumnos: (c.alumnoIds || []).map(id => getNombreCompleto(alumnoMap.get(id))).filter(Boolean).join(', '),
    pagos: pagosPorClase.get(c.id) || []
  })), [clases, alumnoMap, pagosPorClase]);

  const clasesFiltradas = useMemo(() => {
    return (clasesConDatos || []).filter(c => {
      const pasaFiltroAlumno = !filtroAlumno || (c.alumnoIds || []).includes(filtroAlumno);
      const pasaFiltroEstado = !filtroEstado || c.estado === filtroEstado;
      const pasaFiltroFechaDesde = !filtroFechaDesde || c.fecha >= filtroFechaDesde;
      const pasaFiltroFechaHasta = !filtroFechaHasta || c.fecha <= filtroFechaHasta;
      return pasaFiltroAlumno && pasaFiltroEstado && pasaFiltroFechaDesde && pasaFiltroFechaHasta;
    });
  }, [clasesConDatos, filtroAlumno, filtroEstado, filtroFechaDesde, filtroFechaHasta]);
  
  const canchasDisponibles = useMemo(() => getCanchasFromPerfil(perfil), [perfil]);
  
  function handleFormChange(e) {
    const { name, value } = e.target;
    if (name === "tipo") {
      const canon = normalizarTipoClase(value);
      const numAlumnos = TIPOS_CLASE_MAP[canon] || 1;
      setForm(prev => {
        // Al cambiar el tipo, reseteamos los alumnos y calculamos el precio base
        const nuevosAlumnoIds = Array.from({ length: numAlumnos }, () => "");
        const nuevoPrecio = String(getPrecioSugerido(canon, perfil));
        return { ...prev, tipo: canon, precio: nuevoPrecio, alumnoIds: nuevosAlumnoIds };
      });
    } else {
      setForm(prev => ({ ...prev, [name]: value }));
    }
  }
  function handleAlumnoChange(index, newId) {
    setForm(prev => {
      const newAlumnoIds = [...(prev.alumnoIds || [])];
      newAlumnoIds[index] = newId;
      // Ya no se recalcula el precio aqu√≠, solo se actualizan los alumnos
      return { ...prev, alumnoIds: newAlumnoIds };
    });
    if (index === 0 && newId) {
      const alumnoSeleccionado = alumnoMap.get(newId);
      if (alumnoSeleccionado?.horarios?.length > 0) {
        setFormStep(2);
      } else {
        setFormStep(3);
      }
    }
  }

  function handleSelectAlumno(alumno) {
    setAlumnoSearchQuery(getNombreCompleto(alumno));
    setIsAlumnosListOpen(false);
    handleAlumnoChange(0, alumno.id);
  }

  const getNextDateForDay = (dayName) => {
    const today = new Date();
    const todayDayIndex = (today.getDay() + 6) % 7;
    const targetDayIndex = DIAS_SEMANA_NOMBRES.indexOf(dayName);
    let dayDifference = targetDayIndex - todayDayIndex;
    if (dayDifference < 0) dayDifference += 7;
    const resultDate = new Date();
    resultDate.setDate(today.getDate() + dayDifference);
    return resultDate;
  };

  function handleScheduleSelect(horario) {
    const proximaFecha = getNextDateForDay(horario.dia);
    setForm(prev => ({ ...prev, fecha: formatDate(proximaFecha), hora: horario.hora }));
    setFormStep(3);
  }

  const handleAddRecuperacion = (alumnoId) => {
    if (!alumnoId || form.alumnosRecuperacion.includes(alumnoId)) return;
    setForm(prev => ({ ...prev, alumnosRecuperacion: [...prev.alumnosRecuperacion, alumnoId] }));
  };
  const handleRemoveRecuperacion = (alumnoId) => {
    setForm(prev => ({ ...prev, alumnosRecuperacion: prev.alumnosRecuperacion.filter(id => id !== alumnoId) }));
  };

  const handleSelectGrupo = (e) => {
    const id = e.target.value;
    setGrupoSeleccionadoId(id);
    const grupo = grupos.find(g => g.id === id);
    if (grupo) {
      setForm(prev => ({
        ...prev,
        alumnoIds: grupo.alumnoIds || [],
        tipo: 'Grupal', // Asignamos el tipo correcto
        precio: "0", // El precio se gestiona por el plan mensual del alumno
        origenGrupoId: grupo.id, // Guardamos la referencia al grupo
        nombreGrupo: grupo.nombre,
      }));
      setFormStep(3);
    } else {
      setForm(prev => ({ ...prev, alumnoIds: [""] }));
      setFormStep(1);
    }
  };
  
  function openNew() {
    setEditing(null);
    const precioInicial = String(getPrecioSugerido("Clase 1 persona", perfil));
    setForm({ ...emptyForm, precio: precioInicial });
    setAlumnoSearchQuery("");
    setFormStep(1);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function openEdit(c) {
    setEditing(c);

    // --- L√ìGICA INTELIGENTE A√ëADIDA ---
    let tipoFinal;
    if (c.origenGrupoId) {
      // Si la clase viene de un grupo, forzamos el tipo a 'Grupal'
      tipoFinal = 'Grupal';
    } else {
      // Si no, usamos la l√≥gica de normalizaci√≥n de siempre
      tipoFinal = normalizarTipoClase(c.tipo);
    }
    
    setForm({ 
      ...emptyForm, 
      ...c, 
      tipo: tipoFinal, // Usamos el tipo final calculado
      alumnosRecuperacion: c.alumnosRecuperacion || [] 
    });
    // --- FIN DE LA L√ìGICA A√ëADIDA ---

    setFormStep(3);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function cancel() {
    setShowForm(false);
    setEditing(null);
    setForm(emptyForm);
    setFormStep(1);
  }

  const normHour = (h) => String(h || '').slice(0, 5);
  const existeClaseEnHorario = ({ fecha, hora, cancha, excluirId = null }) => {
    const f = String(fecha);
    const h = normHour(hora);
    return (clases || []).find(c => {
      if (c?.id === excluirId) return false;
      if ((c?.estado || '') === 'Cancelada') return false;
      const mismoDiaHora = String(c?.fecha) === f && normHour(c?.hora) === h;
      if (!mismoDiaHora) return false;
      const mismaCancha = cancha ? String(c?.cancha || '').trim() === String(cancha || '').trim() : true;
      return mismaCancha;
    }) || null;
  };

  async function submit(e) {
    e.preventDefault();
    const validAlumnos = (form.alumnoIds || []).filter(Boolean);
    if (validAlumnos.length === 0 && (form.alumnosRecuperacion || []).length === 0) {
      alert("Selecciona al menos un alumno titular o de recuperaci√≥n.");
      return;
    }
    const finalForm = { ...form, tipo: normalizarTipoClase(form.tipo), alumnoIds: validAlumnos };
    const conflicto = existeClaseEnHorario({ fecha: finalForm.fecha, hora: finalForm.hora, cancha: finalForm.cancha, excluirId: editing?.id || null });
    if (conflicto) {
      alert(`Conflicto de horario: Ya existe una clase en esa fecha, hora y cancha.`);
      return;
    }
    try {
      let clasePersistida = null;
      if (editing) {
        clasePersistida = { ...finalForm, id: editing.id };
        await onUpdate(clasePersistida);
      } else {
        clasePersistida = await onCreate(finalForm);
      }
      const alumnosRecuperacionOriginales = editing?.alumnosRecuperacion || [];
      const alumnosRecuperacionNuevos = finalForm.alumnosRecuperacion || [];
      const idsQueConsumenCredito = alumnosRecuperacionNuevos.filter(id => !alumnosRecuperacionOriginales.includes(id));
      if (idsQueConsumenCredito.length > 0) {
        const mesClase = mesClave(new Date(finalForm.fecha));
        const mensualidadesRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId).collection('mensualidades');
        for (const alumnoId of idsQueConsumenCredito) {
          const mensualidadId = `${alumnoId}_${mesClase}`;
          const mensualidadDocRef = mensualidadesRef.doc(mensualidadId);
          await mensualidadDocRef.set({
            creditosRecuperacion: {
              disponibles: firebase.firestore.FieldValue.increment(-1),
              usados: firebase.firestore.FieldValue.increment(1)
            }
          }, { merge: true });
        }
        setToast(`${idsQueConsumenCredito.length} cr√©dito(s) de recuperaci√≥n consumido(s).`);
      }
      const esClaseConsumida = ['Realizada', 'Ausente'].includes(finalForm.estado);
      if (esClaseConsumida && clasePersistida) {
        for (const alumnoId of (clasePersistida.alumnoIds || [])) {
          const alumno = alumnoMap.get(alumnoId);
          if (alumno?.plan === 'mensual') {
            await exigirAbonoDelMesOAvisar({ user, clubId: clubActivoId, alumno, perfil, fechaClase: clasePersistida.fecha, abrirModalPago });
            await cubrirClaseConMensualidadSiCorresponde({ user, clubId: clubActivoId, alumno, claseId: clasePersistida.id, fecha: clasePersistida.fecha, precioPorAlumno: 0, perfil });
          }
        }
        const hayAlumnosPorClase = (clasePersistida.alumnoIds || []).some(id => alumnoMap.get(id)?.plan === 'porClase');
        if (hayAlumnosPorClase) {
          onPay(clasePersistida);
        }
      }
      cancel();
    } catch (error) {
      console.error("Error al guardar clase:", error);
      alert("Error al guardar la clase.");
    }
  }

  const primerAlumnoId = form.alumnoIds ? form.alumnoIds[0] : null;
  const esMensual = alumnoMap.get(primerAlumnoId)?.plan === 'mensual';

  return (
    <div className="grid gap-4">
      <Card
        title={<span className="text-[#34745B]">{editing ? "Editar clase" : "Nueva clase"}</span>}
        right={!showForm && <button id="nueva-clase-btn" onClick={openNew} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">+ Nueva</button>}
      >
        {showForm ? (
          <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
            {(formStep === 1) && (
              <div className="md:col-span-6 relative">
                <label className="text-sm text-slate-600 font-semibold">Selecciona Alumno/a</label>
                <input type="text" value={alumnoSearchQuery} onChange={(e) => { setAlumnoSearchQuery(e.target.value); setIsAlumnosListOpen(true); }} onFocus={() => setIsAlumnosListOpen(true)} onBlur={() => setTimeout(() => setIsAlumnosListOpen(false), 200)} placeholder="Escribe para buscar un alumno..." className="w-full mt-1 border rounded-lg px-3 py-2" />
                {isAlumnosListOpen && (
                  <ul className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg">
                    {alumnosFiltrados.length > 0 ? ( alumnosFiltrados.map(alumno => (<li key={alumno.id} onMouseDown={() => handleSelectAlumno(alumno)} className="px-3 py-2 hover:bg-slate-100 cursor-pointer">{getNombreCompleto(alumno)}</li>))) : (<li className="px-3 py-2 text-slate-500">No se encontraron alumnos.</li>)}
                  </ul>
                )}
                <div className="mt-4">
                  <label className="block text-sm text-slate-600">O selecciona un grupo:</label>
                  <select value={grupoSeleccionadoId} onChange={handleSelectGrupo} className="w-full mt-1 border rounded-lg px-3 py-2">
                    <option value="">-- Selecciona un grupo --</option>
                    {grupos.map(g => (<option key={g.id} value={g.id}>{g.nombre}</option>))}
                  </select>
                </div>
              </div>
            )}
            {(formStep === 2 && alumnoMap.get(form.alumnoIds[0])) && (
              <div className="md:col-span-6">
                <p className="text-sm text-slate-700 mb-2"><span className="font-bold">{getNombreCompleto(alumnoMap.get(form.alumnoIds[0]))}</span> tiene horarios fijos guardados.</p>
                <p className="text-sm font-semibold text-slate-600">¬øQuieres agendar una clase en uno de sus horarios habituales?</p>
                <div className="flex flex-wrap gap-2 my-3">
                  {(alumnoMap.get(form.alumnoIds[0]).horarios || []).map(horario => (
                    <button type="button" key={`${horario.dia}-${horario.hora}`} onClick={() => handleScheduleSelect(horario)} className="px-3 py-2 text-sm rounded-lg border bg-sky-50 text-sky-800 hover:bg-sky-100">{horario.dia} {horario.hora}</button>
                  ))}
                </div>
                <div className="border-t pt-3 mt-3">
                  <button type="button" onClick={() => setFormStep(3)} className="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-slate-100">O agendar una clase personalizada en otro horario</button>
                </div>
              </div>
            )}
            {(formStep === 3) && (
              <>
                {form.tipo === 'Grupal' ? (
  <div className="md:col-span-6">
    <label className="text-sm text-slate-600">Grupo Seleccionado</label>
    <div className="w-full mt-1 border rounded-lg px-3 py-2 bg-slate-100 text-slate-700">
      {form.nombreGrupo || 'N/A'} ({form.alumnoIds.length} integrantes)
    </div>
  </div>
) : (
  // SI ES CUALQUIER OTRO TIPO DE CLASE, MUESTRA LOS SELECTORES DE SIEMPRE
  <div className="md:col-span-6">
    <label className="text-sm font-semibold text-slate-700">Alumnos Titulares</label>
    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-1">
      {(form.alumnoIds || [""]).map((alumnoId, index) => (
        <div key={index}><AlumnoSearchSelect value={alumnoId} onChange={(newId) => handleAlumnoChange(index, newId)} alumnos={alumnosActivos} excludeIds={(form.alumnoIds || []).filter((_, i) => i !== index)} placeholder={`Buscar alumno ${index + 1}...`} /></div>
      ))}
    </div>
  </div>
)}
                <div className="md:col-span-2"><label className="text-sm text-slate-600">Ubicaci√≥n / Cancha</label><select name="cancha" value={form.cancha} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2"><option value="">Seleccionar cancha...</option>{canchasDisponibles.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                <div><label className="text-sm text-slate-600">Fecha</label><input type="date" name="fecha" value={form.fecha} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                <div><label className="text-sm text-slate-600">Hora</label><input type="time" name="hora" value={form.hora} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                <div><label className="text-sm text-slate-600">Tipo de Clase</label><select name="tipo" value={form.tipo} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">{TIPOS_CLASE.map(t => <option key={t}>{t}</option>)}</select></div>
                <div><label className="text-sm text-slate-600 mb-1">Precio</label><input type="number" name="precio" value={esMensual ? "0" : form.precio} onChange={handleFormChange} className={`w-full border rounded-lg px-3 py-2 ${esMensual ? 'bg-slate-100' : ''}`} placeholder="0" disabled={esMensual} /></div>
                <div className="md:col-span-2"><label className="text-sm text-slate-600">Estado</label><select name="estado" value={form.estado} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">{ESTADOS_CLASE.map(e => <option key={e}>{e}</option>)}</select></div>
                <div className="md:col-span-6"><label className="text-sm text-slate-600">Notas</label><textarea name="notas" value={form.notas} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" rows={2} placeholder="Comentarios sobre la clase" /></div>
                <div className="md:col-span-6 mt-4 pt-4 border-t">
                  <label className="text-sm font-semibold text-slate-700">Alumnos de Recuperaci√≥n</label>
                  <p className="text-xs text-slate-500 mb-2">A√±ade alumnos que usan un cr√©dito. No afectar√°n el precio de la clase.</p>
                  <div className="p-2 border rounded-lg bg-slate-50">
                    {form.alumnosRecuperacion.length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-2">
                        {form.alumnosRecuperacion.map(id => (
                          <span key={id} className="flex items-center gap-2 bg-sky-100 text-sky-800 text-sm rounded-full px-2 py-1">
                            {getNombreCompleto(alumnoMap.get(id))}
                            <button type="button" onClick={() => handleRemoveRecuperacion(id)} className="w-4 h-4 rounded-full bg-sky-200 text-sky-800 flex items-center justify-center font-bold text-xs">x</button>
                          </span>
                        ))}
                      </div>
                    )}
                    <AlumnoSearchSelect
                      value={""}
                      onChange={(alumnoId) => handleAddRecuperacion(alumnoId)}
                      alumnos={alumnosConCreditos}
                      excludeIds={[...form.alumnoIds, ...form.alumnosRecuperacion]}
                      placeholder="Buscar alumno con cr√©ditos para a√±adir..."
                    />
                  </div>
                </div>
              </>
            )}
            <div className="md:col-span-6 flex gap-2 justify-end mt-4">
              <button type="button" onClick={() => { cancel(); setFormStep(1); }} className="px-3 py-2 rounded-lg border">Cancelar</button>
              {editing && <button type="button" onClick={() => onDelete(editing.id)} className="px-3 py-2 rounded-lg text-red-600 border border-red-300 hover:bg-red-50">üóëÔ∏è Eliminar</button>}
              {formStep === 3 && <button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">Guardar</button>}
            </div>
          </form>
        ) : (
          <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nueva</b> para programar una clase.</p>
        )}
      </Card>
      
      <div className="mt-6">
        {(() => {
          const [semanaVisible, setSemanaVisible] = React.useState(getWeekStartDate(new Date()));
          const hoyString = formatDate(new Date());
          const semanaActualStrings = Array.from({ length: 7 }, (_, i) => formatDate(addDays(semanaVisible, i)));
          const clasesDeLaSemana = clasesFiltradas.filter(c => semanaActualStrings.includes(c.fecha));
          const clasesDeHoy = clasesDeLaSemana.filter(c => c.fecha === hoyString);
          const clasesAgrupadas = clasesDeLaSemana.reduce((acc, clase) => {
            if (clase.fecha !== hoyString) {
              (acc[clase.fecha] ||= []).push(clase);
            }
            return acc;
          }, {});

          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-xl font-bold text-[#34745B] mb-2">Agenda de Hoy</h2>
                <div className="bg-green-50 border border-green-200 rounded-2xl p-4 space-y-2">
                  {clasesDeHoy.length > 0 ? (
                    clasesDeHoy.sort((a, b) => a.hora.localeCompare(b.hora)).map(c => <ClaseItem key={c.id} clase={c} alumnoMap={alumnoMap} openEdit={openEdit} />)
                  ) : (<p className="text-sm text-slate-500">No hay clases programadas para hoy.</p>)}
                </div>
              </div>
              <div>
                <div className="flex justify-between items-center mb-3">
                  <button onClick={() => setSemanaVisible(prev => addDays(prev, -7))} className="px-4 py-2 text-sm rounded-lg border bg-white shadow-sm hover:bg-slate-50">‚Äπ Sem. Anterior</button>
                  <p className="font-semibold text-slate-600">Semana del {formatDate(semanaVisible, 'dd/mm')} al {formatDate(addDays(semanaVisible, 6), 'dd/mm')}</p>
                  <button onClick={() => setSemanaVisible(prev => addDays(prev, 7))} className="px-4 py-2 text-sm rounded-lg border bg-white shadow-sm hover:bg-slate-50">Sem. Siguiente ‚Ä∫</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {Object.entries(clasesAgrupadas).sort(([fechaA], [fechaB]) => fechaA.localeCompare(fechaB)).map(([fecha, clasesDelDia]) => {
                    const d = new Date(`${fecha}T00:00:00`);
                    const diaNombre = DIAS_SEMANA_NOMBRES[(d.getDay() + 6) % 7];
                    return (
                      <div key={fecha} className="bg-slate-50 border border-slate-200 rounded-2xl p-4 min-h-[120px]">
                        <h3 className="font-bold text-slate-700">{diaNombre}, {d.getDate()}</h3>
                        <div className="space-y-2 mt-2">
                          {clasesDelDia.sort((a, b) => a.hora.localeCompare(b.hora)).map(c => <ClaseItem key={c.id} clase={c} alumnoMap={alumnoMap} openEdit={openEdit} />)}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        })()}
      </div>
      <ModalAbono />
    </div>
  );
}

// Componente para item de clase, para reutilizar en el listado
function ClaseItem({ clase, alumnoMap, openEdit }) {
  const nombresAlumnos = (clase.alumnoIds || []).filter(Boolean).map(id => getNombreCompleto(alumnoMap.get(id))).filter(Boolean).join(', ');
  const nombreGrupoDeClase = clase.origenGrupoId ? `Grupo: ${clase.nombreGrupo || ''}` : null;
  
  const estadoClaseBg = clase.estado === 'Realizada' ? 'bg-green-100 text-green-800' : clase.estado === 'Ausente' ? 'bg-orange-100 text-orange-800' : clase.estado === 'Cancelada' ? 'bg-red-100 text-red-800' : 'bg-slate-100 text-slate-700';

  const estadoPago = React.useMemo(() => {
    if (clase.estado !== 'Realizada' && clase.estado !== 'Ausente') {
      return null;
    }
    const hayAlumnoPorClase = (clase.alumnoIds || []).some(id => alumnoMap.get(id)?.plan === 'porClase');
    if (!hayAlumnoPorClase) {
      return null;
    }
    const precioClase = parseFloat(clase.precio || 0);
    if (precioClase <= 0) return null;
    const totalPagado = (clase.pagos || []).reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);

    if (totalPagado >= precioClase) {
      return { texto: 'Pagada', bg: 'bg-emerald-100 text-emerald-800' };
    } else {
      return { texto: 'Pendiente', bg: 'bg-rose-100 text-rose-800' };
    }
  }, [clase, alumnoMap]);

  const descripcionClase = () => {
    if (clase.origenGrupoId) {
      const numIntegrantes = (clase.alumnoIds || []).length;
      return `Grupo de ${numIntegrantes} integrante${numIntegrantes !== 1 ? 's' : ''}`;
    }
    return clase.tipo;
  };

  return (
    <div onClick={() => openEdit(clase)} className="p-3 bg-white rounded-lg shadow-sm border border-slate-200 hover:border-blue-300 hover:shadow-md cursor-pointer transition-all">
      <div className="flex justify-between items-start">
        <div className="min-w-0">
          <p className="font-semibold text-slate-800 truncate">{clase.hora} - {nombreGrupoDeClase || nombresAlumnos}</p>
          <p className="text-xs text-slate-500 mt-1">
            {descripcionClase()}
            {clase.cancha ? ` en ${clase.cancha}` : ''}
          </p>
        </div>
        
        {/* --- DIV DE ESTADOS CORREGIDO PARA MEJOR ALINEACI√ìN --- */}
        <div className="flex flex-col items-end flex-shrink-0 ml-2">
          <span className={`inline-block px-2 py-0.5 rounded-full text-xs font-semibold ${estadoClaseBg}`}>
            {clase.estado || 'Programada'}
          </span>
          
          {estadoPago && (
            <span className={`inline-block mt-1 px-2 py-0.5 rounded-full text-xs font-semibold text-center ${estadoPago.bg}`}>
              {estadoPago.texto}
            </span>
          )}

          {!estadoPago && (clase.estado === 'Realizada' || clase.estado === 'Ausente') && (
            <p className="text-[11px] text-slate-500 mt-1 max-w-[120px] text-right leading-tight">
              Consultar estado de cuota en ficha del alumno
            </p>
          )}
        </div>
      </div>
    </div>
  );
}


{/* ====== COMIENZA A REEMPLAZAR AQU√ç ====== */}

      function Grupos({ alumnos, user, perfil, clubActivoId, clases, pagos, getCollection, setToast, goToEditClass }) {
        // --- Estados del Componente ---
        const [grupos, setGrupos] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [editingGrupo, setEditingGrupo] = React.useState(null);
        const [agendandoClase, setAgendandoClase] = React.useState(null);
        const [expandedGroupId, setExpandedGroupId] = React.useState(null);
        const [pagandoGrupo, setPagandoGrupo] = React.useState(null);

        const alumnosMap = React.useMemo(() => new Map(alumnos.map(a => [a.id, a])), [alumnos]);

        const gruposCollection = React.useMemo(() => {
          if (!user || !clubActivoId) return null;
          return getCollection('grupos');
        }, [user, clubActivoId]);

        React.useEffect(() => {
          if (!gruposCollection) return;
          const unsubscribe = gruposCollection.orderBy('nombre').onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setGrupos(data);
            setLoading(false);
          });
          return () => unsubscribe();
        }, [gruposCollection]);

        // --- L√≥gica de Negocio ---
        const handleSaveGrupo = async (grupoData) => {
          if (!gruposCollection) {
            alert("Error: No se pudo conectar a la base de datos de grupos.");
            return;
          }
          const { id, ...data } = grupoData;
          try {
            if (id) {
              await gruposCollection.doc(id).update({ ...data, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
              setToast("Grupo actualizado con √©xito.");
            } else {
              await gruposCollection.add({ ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
              setToast("Grupo creado con √©xito.");
            }
            setEditingGrupo(null);
          } catch (error) {
            console.error("Error al guardar el grupo:", error);
            alert("No se pudo guardar el grupo.");
          }
        };

        const handleCrearClaseGrupal = async (grupo, datosDelModal) => {
          // Esta funci√≥n ahora es m√°s simple, ya no crea un pago, solo la clase.
          const { fecha, hora, cancha } = datosDelModal;
          if (!fecha || !hora) { alert("Completa la fecha y hora."); return; }
          const yaExiste = (clases || []).some(c => c.origenGrupoId === grupo.id && c.fecha === fecha && c.hora === hora);
          if (yaExiste) { alert("Error: Ya existe una clase para este grupo en esa misma fecha y hora."); return; }
          
          const nuevaClase = {
            fecha, hora, cancha: cancha || "", alumnoIds: grupo.alumnoIds,
            tipo: `Clase Grupal`, estado: 'Programada',
            origenGrupoId: grupo.id, nombreGrupo: grupo.nombre,
            // Importante: no asignamos precio a la clase, ya que se cobra por abono mensual
            precio: "0",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          try {
            const clasesCollection = getCollection('clases');
            await clasesCollection.add(nuevaClase);
            setToast(`Clase para '${grupo.nombre}' agendada con √©xito.`);
            setAgendandoClase(null);
          } catch (error) { console.error("Error agendando clase grupal:", error); alert("No se pudo agendar la clase."); }
        };

        const clasesDelGrupo = React.useMemo(() => 
          (clases || []).filter(c => c.origenGrupoId === expandedGroupId).sort((a,b) => b.fecha.localeCompare(a.fecha) || b.hora.localeCompare(a.hora)),
          [clases, expandedGroupId]
        );

        return (
          <div className="space-y-4">
            <Card
              title={<span className="text-[#34745B]">Gesti√≥n de Grupos</span>}
              right={<button onClick={() => setEditingGrupo({})} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">+ Nuevo Grupo</button>}
            >
              {loading && <p>Cargando grupos...</p>}
              {!loading && grupos.length === 0 && <p className="text-sm text-slate-500">Crea tu primer grupo para empezar.</p>}
              <div className="space-y-3">
                {grupos.map(grupo => (
                  <div key={grupo.id} className="p-3 border rounded-lg bg-slate-50 transition-all">
                    <div className="flex justify-between items-start gap-3">
                      <div>
                        <h4 className="font-bold text-slate-800">{grupo.nombre}</h4>
                        <p className="text-xs text-slate-600 mt-1">
                          <span className="font-semibold">Precio:</span> {formatCurrency(grupo.precioMensualPorAlumno)} por alumno/mes.
                        </p>
                        <p className="text-xs text-slate-600">
                          <span className="font-semibold">Integrantes:</span> {(grupo.alumnoIds || []).map(id => getNombreCompleto(alumnosMap.get(id))).join(', ')}
                        </p>
                      </div>
                      <div className="flex items-center gap-2 flex-shrink-0">
                        <button onClick={() => setAgendandoClase(grupo)} className="px-3 py-1.5 text-xs rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Agendar Clase</button>
                        <button onClick={() => setEditingGrupo(grupo)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-100">Editar</button>
                        <button onClick={() => setExpandedGroupId(expandedGroupId === grupo.id ? null : grupo.id)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-100">{expandedGroupId === grupo.id ? 'Cerrar' : 'Ver+'}</button>
                      </div>
                    </div>
                    {expandedGroupId === grupo.id && (
                      <div className="mt-3 pt-3 border-t">
                        <h5 className="font-semibold text-sm mb-2">Clases Agendadas para este Grupo</h5>
                        <div className="space-y-2 max-h-48 overflow-y-auto pr-2">
                          {clasesDelGrupo.length === 0 ? <p className="text-xs text-slate-500">No hay clases agendadas.</p> : clasesDelGrupo.map(c => (
                            <div key={c.id} className="p-2 border rounded-md bg-white text-xs flex justify-between items-center">
                              <span>{fechaDDMMYYYY(c.fecha)} - {c.hora} hs</span>
                              <button onClick={() => goToEditClass(c)} className="px-2 py-1 rounded-md border text-xs hover:bg-slate-100">Editar Clase</button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </Card>
            
            <EditarGrupoModal 
              isOpen={!!editingGrupo}
              grupo={editingGrupo}
              alumnos={alumnos}
              onClose={() => setEditingGrupo(null)}
              onSave={handleSaveGrupo}
            />
            <AgendarClaseGrupalModal
              isOpen={!!agendandoClase}
              grupo={agendandoClase}
              alumnos={alumnos}
              onClose={() => setAgendandoClase(null)}
              onSave={(data) => handleCrearClaseGrupal(agendandoClase, data)}
            />
          </div>
        );
      }

      function AgendarClaseGrupalModal({ isOpen, grupo, onClose, onSave, alumnos }) {
        // -- MODIFICADO -- El modal ahora es mucho m√°s simple.
        const [form, setForm] = React.useState({
          fecha: formatDate(new Date()),
          hora: '18:00',
          cancha: ''
        });

        if (!isOpen) return null;

        return (
          <Modal isOpen={isOpen} title={`Agendar Clase para: ${grupo.nombre}`} onCancel={onClose} onConfirm={() => onSave(form)} confirmText="Agendar Clase">
            <div className="space-y-4">
              <p className="text-sm text-slate-500">
                Alumnos: {(grupo.alumnoIds || []).map(id => getNombreCompleto(alumnos.find(a => a.id === id))).join(', ')}
              </p>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label>Fecha</label>
                  <input type="date" value={form.fecha} onChange={e => setForm({...form, fecha: e.target.value})} className="w-full border rounded-lg px-3 py-2 mt-1" />
                </div>
                <div>
                  <label>Hora</label>
                  <input type="time" value={form.hora} onChange={e => setForm({...form, hora: e.target.value})} className="w-full border rounded-lg px-3 py-2 mt-1" />
                </div>
                 <div>
                  <label>Cancha (Opcional)</label>
                  <input type="text" value={form.cancha} onChange={e => setForm({...form, cancha: e.target.value})} className="w-full border rounded-lg px-3 py-2 mt-1" />
                </div>
              </div>
            </div>
          </Modal>
        );
      }

      function EditarGrupoModal({ isOpen, grupo, alumnos, onClose, onSave }) {
        const [form, setForm] = React.useState({ nombre: '', alumnoIds: [], precioMensualPorAlumno: '', horarios: [] });

        React.useEffect(() => {
          if (grupo) {
            setForm({
              nombre: grupo.nombre || '',
              alumnoIds: grupo.alumnoIds || [],
              precioMensualPorAlumno: grupo.precioMensualPorAlumno || '',
              horarios: grupo.horarios || []
            });
          }
        }, [grupo]);

        if (!isOpen) return null;

        const handleSave = () => {
          if (!form.nombre.trim() || !form.precioMensualPorAlumno) {
            alert("Completa el nombre y el precio mensual por alumno.");
            return;
          }
          onSave({ ...form, id: grupo?.id });
        };
        
        const handleAlumnosChange = (e) => setForm(prev => ({ ...prev, alumnoIds: Array.from(e.target.selectedOptions, option => option.value) }));
        const handleHorarioChange = (index, campo, valor) => setForm(prev => ({ ...prev, horarios: prev.horarios.map((h, i) => i === index ? { ...h, [campo]: valor } : h) }));
        const handleAgregarHorario = () => setForm(prev => ({ ...prev, horarios: [...(prev.horarios || []), { dia: 'Lunes', hora: '19:00' }] }));
        const handleQuitarHorario = (index) => setForm(prev => ({ ...prev, horarios: (prev.horarios || []).filter((_, i) => i !== index) }));

        return (
          <Modal isOpen={isOpen} title={grupo?.id ? "Editar Grupo" : "Nuevo Grupo"} onCancel={onClose} onConfirm={handleSave} confirmText="Guardar">
            <div className="space-y-4">
              <div>
                <label className="text-sm text-slate-600">Nombre del Grupo</label>
                <input type="text" value={form.nombre} onChange={e => setForm({...form, nombre: e.target.value})} className="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Ej: Adultos Avanzados"/>
              </div>
              <div>
                <label className="text-sm text-slate-600">Precio Mensual por Alumno</label>
                <input type="number" value={form.precioMensualPorAlumno} onChange={e => setForm({...form, precioMensualPorAlumno: e.target.value})} className="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Ej: 50000"/>
              </div>
              <div>
                <label className="text-sm text-slate-600">Integrantes</label>
                <p className="text-xs text-slate-500 mb-1">Usa Ctrl (o Cmd en Mac) para seleccionar varios.</p>
                <select multiple value={form.alumnoIds} onChange={handleAlumnosChange} className="w-full h-32 border rounded-lg p-2">
                  {alumnos.map(a => (<option key={a.id} value={a.id}>{getNombreCompleto(a)}</option>))}
                </select>
              </div>
              <div>
                <label className="text-sm text-slate-600">Horarios Fijos del Grupo (Opcional)</label>
                <div className="space-y-2 mt-1 max-h-32 overflow-auto">
                  {(form.horarios || []).map((h, i) => (
                    <div key={i} className="flex items-center gap-2">
                      <select value={h.dia} onChange={e => handleHorarioChange(i, 'dia', e.target.value)} className="w-full border rounded-lg px-3 py-2">
                        {DIAS_SEMANA_NOMBRES.map(d => <option key={d} value={d}>{d}</option>)}
                      </select>
                      <input type="time" value={h.hora} onChange={e => handleHorarioChange(i, 'hora', e.target.value)} className="w-full border rounded-lg px-3 py-2" />
                      <button type="button" onClick={() => handleQuitarHorario(i)} className="px-3 py-2 rounded-lg border text-red-600 hover:bg-red-50">-</button>
                    </div>
                  ))}
                </div>
                <button type="button" onClick={handleAgregarHorario} className="mt-2 text-sm px-3 py-1.5 rounded-lg border hover:bg-slate-50">+ Agregar Horario</button>
              </div>
            </div>
          </Modal>
        );
      }

{/* ====== FIN DEL REEMPLAZO ====== */}

function RegistrarPagoGrupalModal({ isOpen, pago, onClose, onConfirm }) {
  const [metodo, setMetodo] = React.useState('Transferencia');

  if (!isOpen) return null;

  const handleConfirm = () => {
    onConfirm(pago, metodo);
  };

  return (
    <Modal
      isOpen={isOpen}
      title="Registrar Pago de Clase Grupal"
      onCancel={onClose}
      onConfirm={handleConfirm}
      confirmText="Confirmar Pago"
      size="md"
    >
      <div className="space-y-4">
        <div>
          <label className="text-sm text-slate-500">Concepto</label>
          <p className="font-semibold text-slate-800">{pago.concepto}</p>
        </div>
        <div>
          <label className="text-sm text-slate-500">Monto a Pagar</label>
          <p className="font-semibold text-slate-800 text-lg">{formatCurrency(pago.monto)}</p>
        </div>
        <div>
          <label className="text-sm text-slate-500">M√©todo de Pago</label>
          <select 
            value={metodo} 
            onChange={e => setMetodo(e.target.value)}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            <option>Transferencia</option>
            <option>Efectivo</option>
            <option>Mixto</option>
          </select>
        </div>
      </div>
    </Modal>
  );
}

function Rankings({ alumnos = [], user, clubActivoId, perfil }) {
  // === Estados del Componente ===
  const [view, setView] = React.useState('interno');
  const [tab, setTab] = React.useState('config');
  const [rankings, setRankings] = React.useState([]);
  const [selectedId, setSelectedId] = React.useState(null);
  const [loading, setLoading] = React.useState(true);
  const [newNombre, setNewNombre] = React.useState("");
  const [newNotas, setNewNotas] = React.useState("");
  const [participantes, setParticipantes] = React.useState([]);
  const [puntosCfg, setPuntosCfg] = React.useState({ win: 3, loss: 0 });
  const [ajustesManual, setAjustesManual] = React.useState({});
  const [ajustesTorneos, setAjustesTorneos] = React.useState({});
  const [excluidosInterno, setExcluidosInterno] = React.useState([]);
  const [excluidosTorneos, setExcluidosTorneos] = React.useState([]);
  const [editRowsInterno, setEditRowsInterno] = React.useState(false);
  const [editRowsTorneos, setEditRowsTorneos] = React.useState(false);
  const [matches, setMatches] = React.useState([]);
  const [awardsTotals, setAwardsTotals] = React.useState({});
  const [awardsList, setAwardsList] = React.useState([]);
  const [pinInput, setPinInput] = React.useState('');
  const [pinVerificado, setPinVerificado] = React.useState(false);
  const [rtTab, setRtTab] = React.useState("tabla");
  const [modalidadPartido, setModalidadPartido] = React.useState("singles");
  const [teams, setTeams] = React.useState([]);
  const [sel1, setSel1] = React.useState('');
  const [sel2, setSel2] = React.useState('');
  const [matchForm, setMatchForm] = React.useState({
    fecha: formatDate(new Date()),
    jugadorA: "",
    jugadorB: "",
    equipoA: "",
    equipoB: "",
    resultado: "A",
    score: ""
  });
  const [isPinModalOpen, setIsPinModalOpen] = React.useState(false);

  const alumnosMap = React.useMemo(() => new Map(alumnos.map(a => [a.id, a])), [alumnos]);
  const teamsMap = React.useMemo(() => new Map((teams || []).map(t => [t.id, t])), [teams]);
  
  const sortedAlumnos = useMemo(() => 
    [...alumnos].sort((a, b) => getNombreCompleto(a).localeCompare(getNombreCompleto(b)))
  , [alumnos]);

  const sortedParticipantes = useMemo(() => 
    participantes.map(id => alumnosMap.get(id)).filter(Boolean)
                 .sort((a, b) => getNombreCompleto(a).localeCompare(getNombreCompleto(b)))
  , [participantes, alumnosMap]);
  
  const rankingsCol = React.useMemo(() => user && clubActivoId ? db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId).collection('rankings') : null, [user, clubActivoId]);
  const selectedRanking = React.useMemo(() => rankings.find(r => r.id === selectedId) || null, [rankings, selectedId]);
  const matchesCol = React.useMemo(() => selectedRanking ? rankingsCol.doc(selectedRanking.id).collection('matches') : null, [rankingsCol, selectedRanking]);
  const awardsCol = React.useMemo(() => selectedRanking ? rankingsCol.doc(selectedRanking.id).collection('awards') : null, [rankingsCol, selectedRanking]);
  
  const migratedRef = React.useRef(false);
  React.useEffect(() => {
    if (!rankingsCol) return;
    let mounted = true;
    const unsub = rankingsCol.orderBy('createdAt', 'desc').onSnapshot(
      async snap => {
        if (!mounted) return;
        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        setRankings(items);
        setLoading(false);
        if (!migratedRef.current) {
          const sinTipo = items.filter(r => typeof r.tipo === 'undefined' || r.tipo === null);
          if (sinTipo.length > 0) {
            try {
              const batch = db.batch();
              sinTipo.forEach(r => { batch.set(rankingsCol.doc(r.id), { tipo: 'interno', updatedAt: Date.now() }, { merge: true }); });
              await batch.commit();
            } catch (e) { console.warn('Migraci√≥n tipo->interno fall√≥:', e); }
          }
          migratedRef.current = true;
        }
        if (!selectedId && items.length > 0) {
          const firstOfView = items.find(r => ((r.tipo || 'interno') === view));
          if (firstOfView) setSelectedId(firstOfView.id);
        } else if (selectedId && !items.some(i => i.id === selectedId)) {
          const firstOfView = items.find(r => ((r.tipo || 'interno') === view));
          setSelectedId(firstOfView ? firstOfView.id : null);
        }
      },
      err => { console.error('rankings onSnapshot', err); setLoading(false); }
    );
    return () => { mounted = false; unsub && unsub(); };
  }, [rankingsCol, view]);

  React.useEffect(() => {
    const cur = rankings.find(r => r.id === selectedId);
    if (selectedId && (!cur || (cur.tipo || 'interno') !== view)) {
      const first = rankings.find(r => (r.tipo || 'interno') === view);
      setSelectedId(first ? first.id : null);
    } else if (!selectedId && rankings.length > 0) {
      const first = rankings.find(r => (r.tipo || 'interno') === view);
      setSelectedId(first ? first.id : null);
    }
    setPinVerificado(false);
    setPinInput('');
    setTab("config");
  }, [view, rankings]);
  
  React.useEffect(() => {
    if (!selectedRanking) {
      setParticipantes([]); setTeams([]); setPuntosCfg({ win: 3, loss: 0 }); setAjustesManual({});
      setAjustesTorneos({}); setExcluidosInterno([]); setExcluidosTorneos([]); setMatches([]);
      setAwardsList([]); setAwardsTotals({}); return;
    }
    setParticipantes(Array.isArray(selectedRanking.participantes) ? selectedRanking.participantes : []);
    setTeams(Array.isArray(selectedRanking.teams) ? selectedRanking.teams : []);
    setPuntosCfg(selectedRanking.puntosCfg || { win: 3, loss: 0 });
    setAjustesManual(selectedRanking.ajustesManual || selectedRanking.ajustes || {});
    setAjustesTorneos(selectedRanking.ajustesTorneos || {});
    setExcluidosInterno(selectedRanking.excluidosInterno || []);
    setExcluidosTorneos(selectedRanking.excluidosTorneos || []);
    setPinVerificado(false); setPinInput('');
  }, [selectedRanking]);
  
  React.useEffect(() => {
    if (!matchesCol) { setMatches([]); return; }
    const unsub = matchesCol.orderBy('fecha', 'desc').onSnapshot(snap => setMatches(snap.docs.map(d => ({ id: d.id, ...d.data() }))), err => console.error('matches onSnapshot', err));
    return () => unsub && unsub();
  }, [matchesCol]);

  React.useEffect(() => {
    if (!awardsCol) { setAwardsTotals({}); setAwardsList([]); return; }
    const unsub = awardsCol.onSnapshot(snap => {
      const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setAwardsList(docs);
      const tot = {};
      for (const doc of docs) {
        const res = doc.resumen || {};
        for (const [id, v] of Object.entries(res)) {
          const t = tot[id] || { PJ: 0, G: 0, P: 0 };
          t.PJ += (v.PJ || 0); t.G += (v.G || 0); t.P += (v.P || 0);
          tot[id] = t;
        }
      }
      setAwardsTotals(tot);
    }, err => { console.error('awards onSnapshot', err); setAwardsTotals({}); setAwardsList([]); });
    return () => unsub && unsub();
  }, [awardsCol]);
  
  const torneoPTS = React.useMemo(() => {
    const pts = {};
    (awardsList || []).forEach(doc => {
      const resumen = doc.resumen || {};
      Object.entries(resumen).forEach(([id, data]) => {
        pts[id] = (pts[id] || 0) + (data.PTS || 0);
      });
    });
    return pts;
  }, [awardsList]);

  const standingsInterno = useMemo(() => {
      const base = new Map();
      [...(participantes || []), ...(teams || []).flatMap(t => t.members)].forEach(id => { if (id && !base.has(id)) base.set(id, { alumnoId: id, PJ: 0, G: 0, P: 0, PTS: 0 }); });
      Object.keys(ajustesManual || {}).forEach(id => { if (id && !base.has(id)) base.set(id, { alumnoId: id, PJ: 0, G: 0, P: 0, PTS: 0 }); });
      
      for (const m of matches) {
          if (m.modalidad === 'singles') {
              const A = base.get(m.jugadorA);
              const B = base.get(m.jugadorB);
              if (!A || !B) continue;
              A.PJ++; B.PJ++;
              if (m.resultado === 'A') {
                  A.G++; B.P++;
                  A.PTS += m.puntosA || 0;
                  B.PTS += m.puntosB || 0;
              } else {
                  B.G++; A.P++;
                  B.PTS += m.puntosB || 0;
                  A.PTS += m.puntosA || 0;
              }
          } else {
              const teamA = teamsMap.get(m.equipoA);
              const teamB = teamsMap.get(m.equipoB);
              if (!teamA || !teamB) continue;
              teamA.members.forEach(id => { 
                  const p = base.get(id); 
                  if (p) { p.PJ++; if (m.resultado === 'A') { p.G++; p.PTS += m.puntosA || 0; } else { p.P++; p.PTS += m.puntosA || 0; } } 
              });
              teamB.members.forEach(id => { 
                  const p = base.get(id); 
                  if (p) { p.PJ++; if (m.resultado === 'B') { p.G++; p.PTS += m.puntosB || 0; } else { p.P++; p.PTS += m.puntosB || 0; } } 
              });
          }
      }
      base.forEach((row, id) => { row.PTS += Number(ajustesManual[id] || 0); });
      const arr = Array.from(base.values());
      arr.sort((a, b) => b.PTS - a.PTS || b.G - a.G || (getNombreCompleto(alumnosMap.get(a.alumnoId)) || "").localeCompare(getNombreCompleto(alumnosMap.get(b.alumnoId)) || ""));
      return arr.filter(r => !excluidosInterno.includes(r.alumnoId));
  }, [participantes, teams, matches, ajustesManual, alumnosMap, excluidosInterno, teamsMap]);
  
  const standingsTorneos = useMemo(() => {
    const allPlayerIds = new Set([...Object.keys(awardsTotals || {}), ...Object.keys(torneoPTS || {}), ...Object.keys(ajustesTorneos || {})]);
    const base = new Map(Array.from(allPlayerIds).map(id => [id, { alumnoId: id, PJ: 0, G: 0, P: 0, PTS: 0 }]));
    for (const [id, cnt] of Object.entries(awardsTotals || {})) {
      const row = base.get(id);
      if (row) { row.PJ += (cnt.PJ || 0); row.G += (cnt.G || 0); row.P += (cnt.P || 0); }
    }
    base.forEach((row, id) => {
      const puntosDeTorneos = torneoPTS[id] || 0;
      const ajuste = Number(ajustesTorneos[id] || 0);
      row.PTS = puntosDeTorneos + ajuste;
    });
    const arr = Array.from(base.values());
    arr.sort((a, b) => b.PTS - a.PTS || b.G - a.G || (getNombreCompleto(alumnosMap.get(a.alumnoId)) || "").localeCompare(getNombreCompleto(alumnosMap.get(b.alumnoId)) || ""));
    const excl = new Set(excluidosTorneos || []);
    return arr.filter(r => !excl.has(r.alumnoId));
  }, [awardsTotals, torneoPTS, ajustesTorneos, alumnosMap, excluidosTorneos]);

  const createRanking = async () => { if (!rankingsCol || !newNombre.trim()) return; await rankingsCol.add({ nombre: newNombre.trim(), notas: newNotas.trim(), tipo: view, createdAt: Date.now(), updatedAt: Date.now() }); setNewNombre(""); setNewNotas(""); };
  const updateRanking = async () => { if (!rankingsCol || !selectedRanking) return; const payload = { participantes, teams, puntosCfg, ajustesManual, ajustesTorneos, excluidosInterno, excluidosTorneos, torneosFinalizado: !!selectedRanking.torneosFinalizado, updatedAt: Date.now() }; await rankingsCol.doc(selectedRanking.id).set(payload, { merge: true }); alert("Ranking guardado"); };
  const handleSave = async () => { if (view === 'torneos' && ajustesBloqueados) { alert('Ingresa tu PIN para guardar.'); return; } await updateRanking(); };
  const deleteRanking = async (id) => { if (!rankingsCol || !confirm("¬øEliminar este ranking?")) return; await rankingsCol.doc(id).delete(); };
  const submitMatch = async (e) => { e.preventDefault(); if (!matchesCol) return; const { fecha, resultado, score, jugadorA, jugadorB, equipoA, equipoB } = matchForm; const cfg = puntosCfg || { win: 3, loss: 0 }; const puntosA = resultado === "A" ? cfg.win : cfg.loss; const puntosB = resultado === "B" ? cfg.win : cfg.loss; const payload = { fecha, resultado, score, puntosA, puntosB, modalidad: modalidadPartido, createdAt: Date.now() }; if (modalidadPartido === "singles") { if (!jugadorA || !jugadorB || jugadorA === jugadorB) return alert("Eleg√≠ dos alumnos distintos."); payload.jugadorA = jugadorA; payload.jugadorB = jugadorB; } else { if (!equipoA || !equipoB || equipoA === equipoB) return alert("Eleg√≠ dos equipos distintos."); payload.equipoA = equipoA; payload.equipoB = equipoB; } await matchesCol.add(payload); setMatchForm(f => ({ ...f, score: "", jugadorA: "", jugadorB: "", equipoA: "", equipoB: "" })); };
  const deleteMatch = async (id) => { if (matchesCol) await matchesCol.doc(id).delete(); };
  const addParticipante = (id) => { if(id) setParticipantes(p => p.includes(id) ? p : [...p, id]); };
  const removeParticipante = (id) => setParticipantes(p => p.filter(x => x !== id));
  const addTeam = () => { if (!sel1 || !sel2 || sel1 === sel2) return alert("Debes seleccionar dos jugadores diferentes."); setTeams(t => [...t, { id: `team_${Date.now()}`, members: [sel1, sel2] }]); setSel1(''); setSel2(''); };
  const removeTeam = (id) => { setTeams(t => t.filter(x => x.id !== id)); setMatchForm(p => ({ ...p, equipoA: p.equipoA === id ? "" : p.equipoA, equipoB: p.equipoB === id ? "" : p.equipoB })); };
  const getTeamLabel = (teamId) => { const team = teamsMap.get(teamId); if (!team) return ""; return `${getNombreCompleto(alumnosMap.get(team.members[0]))} / ${getNombreCompleto(alumnosMap.get(team.members[1]))}`; };
  
  const torneosFinalizado = !!selectedRanking?.torneosFinalizado;
  const puedeEditarTorneos = !torneosFinalizado || pinVerificado;
  const ajustesBloqueados = torneosFinalizado && !pinVerificado;
  
  const onCheckPin = () => {
      if (!perfil.pin) { return alert('No hay PIN configurado en tu Perfil.'); }
      if (pinInput === perfil.pin) {
        setPinVerificado(true);
        alert('PIN verificado. Edici√≥n habilitada.');
      } else {
        alert('PIN incorrecto.');
      }
  };

  const toggleFinalizado = async () => {
    if (!rankingsCol || !selectedRanking) return;
    const isFinished = !!selectedRanking.torneosFinalizado;
    if (isFinished) {
      setIsPinModalOpen(true);
    } else {
      await rankingsCol.doc(selectedRanking.id).set({ torneosFinalizado: true }, { merge: true });
      setPinVerificado(false);
      setPinInput('');
    }
  };
  
  const confirmarReaperturaRanking = async () => {
      if (!rankingsCol || !selectedRanking) return;
      await rankingsCol.doc(selectedRanking.id).set({ torneosFinalizado: false }, { merge: true });
      setIsPinModalOpen(false);
  };
  
  const excluirInterno = (id) => { if (confirm("¬øQuitar de la tabla?")) setExcluidosInterno(p => [...p, id]); };
  const restaurarInterno = (id) => setExcluidosInterno(p => p.filter(x => x !== id));
  const excluirTorneos = (id) => { if (confirm("¬øQuitar de la tabla?")) setExcluidosTorneos(p => [...p, id]); };
  const restaurarTorneos = (id) => setExcluidosTorneos(p => p.filter(x => x !== id));
  const tabBtn = (t) => `px-3 py-1.5 rounded-lg text-sm transition ${tab === t || rtTab === t ? "bg-white shadow-sm border border-slate-300" : "border border-transparent text-slate-600 hover:text-slate-800"}`;
  const filteredRankings = rankings.filter(r => ((r.tipo || 'interno') === view));

  return (
    <div className="space-y-3">
      <div className="mb-3 flex gap-2">
        <button className={`px-3 py-1.5 rounded-lg border ${view === 'interno' ? 'bg-emerald-50 border-emerald-300' : 'bg-white'}`} onClick={() => setView('interno')}>Ranking Interno</button>
        <button className={`px-3 py-1.5 rounded-lg border ${view === 'torneos' ? 'bg-emerald-50 border-emerald-300' : 'bg-white'}`} onClick={() => setView('torneos')}>Ranking Torneos</button>
      </div>
      <div className="grid md:grid-cols-12 gap-6">
        <div className="md:col-span-4">
          <Card title={<span className="text-[#34745B]">Rankings</span>} right={null}>
            {loading && <p className="text-sm text-slate-500">Cargando...</p>}
            <ul className="space-y-2">
              {filteredRankings.map(r => (
                <li key={r.id} className={`p-2 rounded-lg border cursor-pointer ${selectedId === r.id ? 'bg-green-50 border-green-300' : 'bg-white'}`} onClick={() => setSelectedId(r.id)}>
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="font-semibold text-slate-800">{r.nombre}</p>
                      {r.notas && <p className="text-xs text-slate-500 mt-0.5">{r.notas}</p>}
                      <p className="text-[10px] text-slate-400 mt-1 uppercase tracking-wide">Tipo: {(r.tipo || 'interno')}</p>
                    </div>
                    <button className="text-xs px-2 py-1 rounded-lg border text-red-600 hover:bg-red-50" onClick={(e) => { e.stopPropagation(); deleteRanking(r.id); }} title="Eliminar ranking">üóëÔ∏è</button>
                  </div>
                </li>
              ))}
              {filteredRankings.length === 0 && (<li className="text-sm text-slate-500 p-2">No hay rankings de tipo ‚Äú{view}‚Äù.</li>)}
            </ul>
            <div className="mt-4 border-t pt-4">
              <p className="text-sm font-semibold text-slate-700 mb-1">Nuevo ranking <span className="text-xs text-slate-500">(tipo: {view})</span></p>
              <input type="text" value={newNombre} onChange={e => setNewNombre(e.target.value)} placeholder="Ej: Ranking Avanzados 2024" className="w-full border rounded-lg px-3 py-2 mb-2" />
              <input type="text" value={newNotas} onChange={e => setNewNotas(e.target.value)} placeholder="Notas (opcional)" className="w-full border rounded-lg px-3 py-2 mb-2" />
              <button onClick={createRanking} className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white text-sm">+ Crear</button>
            </div>
          </Card>
        </div>
        <div className="md:col-span-8">
          {selectedRanking ? (
            view === 'interno' ? (
              <Card title={<span className="text-[#34745B]">{selectedRanking.nombre}</span>} right={<button onClick={handleSave} className="px-3 py-1.5 rounded-lg bg-[#34745B] hover:bg-green-800 text-white text-sm">Guardar</button>}>
                <div className="flex flex-wrap gap-2 mb-4">
                  <button className={tabBtn("config")} onClick={() => setTab("config")}>Configuraci√≥n</button>
                  <button className={tabBtn("registrar")} onClick={() => setTab("registrar")}>Registrar Partido</button>
                  <button className={tabBtn("tabla")} onClick={() => setTab("tabla")}>Tabla de Posiciones</button>
                  <button className={tabBtn("historial")} onClick={() => setTab("historial")}>Historial de Partidos</button>
                </div>
                {tab === 'config' && (
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <p className="text-sm font-semibold text-slate-700 mb-1">Agregar participante (Singles)</p>
                      <AlumnoSearchSelect value="" onChange={addParticipante} alumnos={sortedAlumnos} excludeIds={participantes} placeholder="Buscar alumno para agregar..."/>
                      {participantes.length > 0 && (<ul className="mt-2 space-y-1 text-sm">{participantes.map(id => (<li key={id} className="flex justify-between items-center border rounded-lg px-2 py-1"><span>{getNombreCompleto(alumnosMap.get(id))}</span><button className="text-xs px-2 py-0.5 rounded border hover:bg-slate-50" onClick={() => removeParticipante(id)}>Quitar</button></li>))}</ul>)}
                    </div>
                    <div>
                      <p className="text-sm font-semibold text-slate-700 mb-1">Crear parejas (Dobles)</p>
                      <div className="space-y-2">
                        <AlumnoSearchSelect value={sel1} onChange={setSel1} alumnos={sortedAlumnos} excludeIds={[sel2]} placeholder="Buscar Jugador 1"/>
                        <AlumnoSearchSelect value={sel2} onChange={setSel2} alumnos={sortedAlumnos} excludeIds={[sel1]} placeholder="Buscar Jugador 2"/>
                      </div>
                      <button type="button" onClick={addTeam} className="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 text-white disabled:opacity-50" disabled={!sel1 || !sel2}>Crear Pareja</button>
                      {teams.length > 0 && (<ul className="mt-2 space-y-1 text-sm">{teams.map(t => (<li key={t.id} className="flex justify-between items-center border rounded-lg px-2 py-1"><span>{getTeamLabel(t.id)}</span><button className="text-xs px-2 py-0.5 rounded border hover:bg-slate-50" onClick={() => removeTeam(t.id)}>Quitar</button></li>))}</ul>)}
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-sm font-semibold text-slate-700 mb-1">Puntos</p>
                      <div className="grid grid-cols-2 gap-2 mb-2">
                        <div><label className="text-xs">Ganar</label><input type="number" value={puntosCfg.win} onChange={e => setPuntosCfg(cfg => ({ ...cfg, win: Number(e.target.value) || 0 }))} className="w-full border rounded-lg px-2 py-1" /></div>
                        <div><label className="text-xs">Perder</label><input type="number" value={puntosCfg.loss} onChange={e => setPuntosCfg(cfg => ({ ...cfg, loss: Number(e.target.value) || 0 }))} className="w-full border rounded-lg px-2 py-1" /></div>
                      </div>
                    </div>
                  </div>
                )}
                {tab === 'registrar' && ( 
                  <form onSubmit={submitMatch} className="grid md:grid-cols-6 gap-2 items-end">
                    <div className="md:col-span-2"><label className="text-xs">Modalidad</label><select value={modalidadPartido} onChange={e => setModalidadPartido(e.target.value)} className="w-full border rounded-lg px-2 py-1"><option value="singles">Singles</option><option value="dobles">Dobles</option></select></div>
                    <div className="md:col-span-4"><label className="text-xs">Fecha</label><input type="date" value={matchForm.fecha} onChange={e => setMatchForm(f => ({ ...f, fecha: e.target.value }))} className="w-full border rounded-lg px-2 py-1" /></div>
                    {modalidadPartido === 'singles' ? (
                      <>
                        <div className="md:col-span-3"><label className="text-xs">Jugador A</label><AlumnoSearchSelect value={matchForm.jugadorA} onChange={v => setMatchForm(f=>({...f, jugadorA: v}))} alumnos={sortedParticipantes} excludeIds={[matchForm.jugadorB]} placeholder="Buscar Jugador A"/></div>
                        <div className="md:col-span-3"><label className="text-xs">Jugador B</label><AlumnoSearchSelect value={matchForm.jugadorB} onChange={v => setMatchForm(f=>({...f, jugadorB: v}))} alumnos={sortedParticipantes} excludeIds={[matchForm.jugadorA]} placeholder="Buscar Jugador B"/></div>
                      </>
                    ) : (
                      <>
                        <div className="md:col-span-3"><label className="text-xs">Equipo A</label><select value={matchForm.equipoA} onChange={e => setMatchForm(f => ({ ...f, equipoA: e.target.value }))} className="w-full border rounded-lg px-2 py-1"><option value="">‚Äî</option>{teams.map(t => <option key={t.id} value={t.id}>{getTeamLabel(t.id)}</option>)}</select></div>
                        <div className="md:col-span-3"><label className="text-xs">Equipo B</label><select value={matchForm.equipoB} onChange={e => setMatchForm(f => ({ ...f, equipoB: e.target.value }))} className="w-full border rounded-lg px-2 py-1"><option value="">‚Äî</option>{teams.map(t => <option key={t.id} value={t.id}>{getTeamLabel(t.id)}</option>)}</select></div>
                      </>
                    )}
                    <div className="md:col-span-2"><label className="text-xs">Resultado</label><select value={matchForm.resultado} onChange={e => setMatchForm(f => ({ ...f, resultado: e.target.value }))} className="w-full border rounded-lg px-2 py-1"><option value="A">Gana A</option><option value="B">Gana B</option></select></div>
                    <div className="md:col-span-2"><label className="text-xs">Score (opcional)</label><input type="text" value={matchForm.score} onChange={e => setMatchForm(f => ({ ...f, score: e.target.value }))} className="w-full border rounded-lg px-2 py-1" placeholder="Ej: 6-4 4-6 10-8" /></div>
                    <div className="md:col-span-2"><button type="submit" className="w-full px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white text-sm">+ Registrar</button></div>
                  </form> 
                )}
                {tab === 'tabla' && ( 
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <p className="text-sm font-semibold text-slate-700">Tabla de Posiciones ‚Äî Ranking Interno</p>
                      <button className="text-xs px-2 py-1 rounded-lg border hover:bg-slate-50" onClick={() => setEditRowsInterno(s => !s)}>{editRowsInterno ? "Listo" : "Editar tabla"}</button>
                    </div>
                    <div className="overflow-x-auto max-h-[60vh] overflow-y-auto rounded-lg border">
                      <table className="min-w-full text-sm">
                        <thead className="sticky top-0 z-10 bg-white shadow-sm"><tr className="text-left text-slate-700"><th className="p-2">#</th><th className="p-2">Alumno</th><th className="p-2">PJ</th><th className="p-2">G</th><th className="p-2">P</th><th className="p-2">PTS</th>{editRowsInterno && <th className="p-2 w-12"></th>}</tr></thead>
                        <tbody>{standingsInterno.map((row, idx) => (<tr key={row.alumnoId} className="border-t odd:bg-white even:bg-slate-50"><td className="p-2">{idx + 1}</td><td className="p-2">{getNombreCompleto(alumnosMap.get(row.alumnoId))}</td><td className="p-2">{row.PJ}</td><td className="p-2">{row.G}</td><td className="p-2">{row.P}</td><td className="p-2 font-bold">{row.PTS}</td>{editRowsInterno && ( <td className="p-2 text-right"><button className="text-xs px-2 py-1 rounded-lg border text-red-600 hover:bg-red-50" onClick={() => excluirInterno(row.alumnoId)} title="Quitar de la tabla">üóëÔ∏è</button></td> )}</tr>))}</tbody>
                      </table>
                    </div>
                    {editRowsInterno && excluidosInterno.length > 0 && ( <div className="mt-2 text-xs"><div className="font-medium mb-1">Excluidos</div><ul className="flex flex-wrap gap-2">{excluidosInterno.map(id => ( <li key={id} className="px-2 py-1 rounded border bg-slate-50">{getNombreCompleto(alumnosMap.get(id))}<button className="ml-2 underline" onClick={() => restaurarInterno(id)}>Restaurar</button></li> ))}</ul></div> )}
                  </div> 
                )}
                {tab === 'historial' && ( 
                  <div>
                    <p className="text-sm font-semibold text-slate-700 mb-2">Historial de Partidos</p>
                    {matches.length === 0 && <p className="text-sm text-slate-500">Sin partidos registrados.</p>}
                    <ul className="space-y-2">{matches.map(m => (<li key={m.id} className="p-2 border rounded-lg bg-white flex justify-between items-center"><div className="text-sm"><span className="text-slate-500 mr-2">{m.fecha}</span>{m.modalidad === 'singles' ? (<><b>{getNombreCompleto(alumnosMap.get(m.jugadorA))}</b> vs <b>{getNombreCompleto(alumnosMap.get(m.jugadorB))}</b></>) : (<><b>{getTeamLabel(m.equipoA)}</b> vs <b>{getTeamLabel(m.equipoB)}</b></>)}{m.score ? <> ‚Äî <span className="text-slate-600">{m.score}</span></> : null}<span className="ml-2 text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700">{m.resultado === "A" ? "Gana A" : "Gana B"}</span></div><button className="text-xs px-2 py-1 rounded-lg border text-red-600 hover:bg-red-50" onClick={() => deleteMatch(m.id)}>üóëÔ∏è</button></li>))}</ul>
                  </div> 
                )}
              </Card>
            ) : (
              <Card title={<span className="text-[#34745B]">{selectedRanking.nombre}</span>} right={<button onClick={handleSave} disabled={ajustesBloqueados} className={`px-3 py-1.5 rounded-lg text-white text-sm ${ajustesBloqueados ? 'bg-slate-400 cursor-not-allowed' : 'bg-[#34745B] hover:bg-green-800'}`}>Guardar</button>}>
                <div className="flex items-center justify-between mb-2">
                  <p className="text-xs text-slate-500">Vista basada en torneos aplicados</p>
                  <div className="flex items-center gap-2">
                    <span className={`text-xs ${torneosFinalizado ? 'text-rose-600' : 'text-emerald-700'}`}>Estado: {torneosFinalizado ? 'Finalizado (bloqueado)' : 'Abierto'}</span>
                    <button onClick={toggleFinalizado} className="text-xs px-2 py-1 rounded-lg border hover:bg-slate-50">{torneosFinalizado ? 'Reabrir' : 'Marcar finalizado'}</button>
                  </div>
                </div>
                {ajustesBloqueados && (<div className="mb-4 p-3 rounded-lg border bg-amber-50"><p className="text-sm font-semibold text-amber-800">Edici√≥n bloqueada</p><p className="text-xs text-amber-700 mb-2">Este ranking est√° finalizado. Ingresa tu PIN para editar.</p><div className="flex items-center gap-2"><input type="password" inputMode="numeric" maxLength="3" value={pinInput} onChange={e => setPinInput(e.target.value.replace(/\D/g, ''))} className="w-24 border rounded-lg px-2 py-1 text-sm tracking-widest text-center" placeholder="‚Ä¢‚Ä¢‚Ä¢" /><button onClick={onCheckPin} className="text-xs px-3 py-1.5 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">Desbloquear</button></div></div>)}
                <div className="inline-flex rounded-xl border border-slate-200 bg-slate-50 p-0.5 mb-3">
                  <button className={tabBtn("tabla")} onClick={() => setRtTab("tabla")}>Tabla</button>
                  <button className={tabBtn("ajustes")} onClick={() => setRtTab("ajustes")}>Ajustes Manuales</button>
                </div>
                {rtTab === "tabla" && (
                  <section>
                    <div className="flex items-center justify-end mb-2">
                      <button className="text-xs px-2 py-1 rounded-lg border hover:bg-slate-50" onClick={() => setEditRowsTorneos(s => !s)}>{editRowsTorneos ? "Listo" : "Editar tabla"}</button>
                    </div>
                    <div className="overflow-x-auto max-h-[60vh] overflow-y-auto rounded-lg border">
                      <table className="min-w-full text-sm">
                        <thead className="sticky top-0 z-10 bg-white shadow-sm"><tr className="text-left text-slate-700"><th className="p-2">#</th><th className="p-2">Alumno</th><th className="p-2 text-right">PJ</th><th className="p-2 text-right">G</th><th className="p-2 text-right">P</th><th className="p-2 text-right">Pts. Torneo</th><th className="p-2 text-right">Ajuste</th><th className="p-2 text-right font-bold">PTS Total</th>{editRowsTorneos && <th className="p-2 w-12"></th>}</tr></thead>
                        <tbody>
                          {standingsTorneos.map((row, idx) => {
                            const puntosBase = torneoPTS[row.alumnoId] || 0;
                            const ajuste = Number(ajustesTorneos[row.alumnoId] || 0);
                            return (
                              <tr key={row.alumnoId} className="border-t">
                                <td className="p-2">{idx + 1}</td>
                                <td className="p-2">{getNombreCompleto(alumnosMap.get(row.alumnoId))}</td>
                                <td className="p-2 text-right">{row.PJ}</td>
                                <td className="p-2 text-right">{row.G}</td>
                                <td className="p-2 text-right">{row.P}</td>
                                <td className="p-2 text-right text-slate-500">{puntosBase}</td>
                                <td className={`p-2 text-right ${ajuste > 0 ? 'text-green-600' : ajuste < 0 ? 'text-red-600' : ''}`}>{ajuste}</td>
                                <td className="p-2 text-right font-bold">{row.PTS}</td>
                                {editRowsTorneos && (<td className="p-2 text-right"><button className="text-xs p-1" onClick={() => excluirTorneos(row.alumnoId)} title="Quitar">üóëÔ∏è</button></td>)}
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </section>
                )}
                {rtTab === "ajustes" && (
                  <section className="mt-2">
                    <div className="font-semibold mb-1">Ajustes Manuales (Bono/Penalizaci√≥n)</div>
                    <p className="text-xs text-slate-500 mb-2">Estos puntos se suman o restan al total. No olvides "Guardar".</p>
                    <div className="space-y-1 max-w-[520px]">
                      {standingsTorneos.map(row => (
                        <div key={row.alumnoId} className="flex items-center gap-2">
                          <span className="text-sm w-56 truncate">{getNombreCompleto(alumnosMap.get(row.alumnoId))}</span>
                          <input type="number" value={ajustesTorneos[row.alumnoId] || 0} onChange={e => setAjustesTorneos(prev => ({ ...prev, [row.alumnoId]: Number(e.target.value) }))} className="w-24 border rounded-lg px-2 py-1 text-sm" disabled={!puedeEditarTorneos} />
                        </div>
                      ))}
                    </div>
                  </section>
                )}
              </Card>
            )
          ) : (
            <Card title={<span className="text-[#34745B]">Detalle</span>}>
              <p className="text-sm text-slate-500">Seleccion√° o cre√° un ranking para comenzar.</p>
            </Card>
          )}
        </div>
      </div>
      
      <PinConfirmModal
        isOpen={isPinModalOpen}
        onClose={() => setIsPinModalOpen(false)}
        onConfirm={confirmarReaperturaRanking}
        perfil={perfil}
        title="Reabrir Ranking"
        message="Ingresa tu PIN de seguridad para desbloquear la edici√≥n de este ranking."
      />
    </div>
  );
}

// =========================
// RulesEditor (usa props)
// =========================
function RulesEditor({ title, scope, reglas, setReglas, modalidadUI, disabled }) {
  const r = reglas?.[scope] || {};

  const setR = (patch) => {
    if (disabled) return;
    setReglas(prev => {
      const newScopeRules = { ...(prev?.[scope] || {}), ...patch };
      return { ...(prev || {}), [scope]: newScopeRules };
    });
  };

  const isMatchOnly = !!r.matchOnly;

  return (
    <div className="border rounded-xl p-3 bg-white">
      <p className="text-sm font-semibold text-slate-700 mb-2">{title}</p>

      {/* --- REGLAS B√ÅSICAS DE FORMATO --- */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div>
          <label className="text-xs text-slate-600">Formato de Sets</label>
          <select
            className="w-full border rounded-lg px-2 py-1 text-sm"
            value={r.formatoSets || "bo3"}
            onChange={e => setR({ formatoSets: e.target.value })}
            disabled={disabled || isMatchOnly}
          >
            <option value="bo1">A 1 Set</option>
            <option value="bo3">Al Mejor de 3 Sets</option>
          </select>
        </div>
        
        <div>
          <label className="text-xs text-slate-600">Sistema de Puntuaci√≥n</label>
          <select
            className="w-full border rounded-lg px-2 py-1 text-sm"
            value={r.puntoDeOro ? "oro" : "ventaja"}
            onChange={e => setR({ puntoDeOro: e.target.value === "oro" })}
            disabled={disabled}
          >
            <option value="oro">Punto de Oro (sin ventaja)</option>
            <option value="ventaja">Ventaja</option>
          </select>
        </div>

        <div>
          <label className="text-xs text-slate-600">Games por Set</label>
          <input
            type="number" min="1" className="w-full border rounded-lg px-2 py-1 text-sm"
            value={r.gamesPorSet ?? 6}
            onChange={e => setR({ gamesPorSet: Number(e.target.value) || 6 })}
            disabled={disabled || isMatchOnly}
          />
        </div>

        <div>
          <label className="text-xs text-slate-600">Tie-break (en 6-6)</label>
          <select
            className="w-full border rounded-lg px-2 py-1 text-sm"
            value={r.tieBreak || "TB7"}
            onChange={e => setR({ tieBreak: e.target.value })}
            disabled={disabled || isMatchOnly}
          >
            <option value="TB7">Tie-break a 7</option>
            <option value="TB10">Tie-break a 10</option>
            <option value="SinTB">Sin Tie-break</option>
          </select>
        </div>
      </div>

      {/* --- SET DECISIVO / PARTIDO CORTO --- */}
      <div className="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-4 pt-3 border-t">
        <div>
          <label className="text-xs text-slate-600 mb-1 block">En caso de 1-1 en sets, el 3er set es:</label>
          <div className="space-y-1 text-sm">
            <label className="flex items-center gap-2">
              <input type="radio" name={`decider-${scope}`} checked={(r.decider || "set") === "set"} onChange={() => setR({ decider: "set" })} disabled={disabled || isMatchOnly || r.formatoSets !== 'bo3'} />
              <span className={isMatchOnly || r.formatoSets !== 'bo3' ? "opacity-50" : ""}>Otro Set Normal</span>
            </label>
            <label className="flex items-center gap-2">
              <input type="radio" name={`decider-${scope}`} checked={(r.decider || "set") === "matchTB"} onChange={() => setR({ decider: "matchTB" })} disabled={disabled || isMatchOnly || r.formatoSets !== 'bo3'} />
              <span className={isMatchOnly || r.formatoSets !== 'bo3' ? "opacity-50" : ""}>Super Tie-break a 10 puntos</span>
            </label>
          </div>
        </div>
        <div className="sm:pl-2">
           <label className="text-xs text-slate-600 mb-1 block">Opcional: Partido R√°pido</label>
           <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" checked={isMatchOnly} onChange={e => setR({ matchOnly: e.target.checked })} disabled={disabled} />
            <span>Jugar s√≥lo un Super Tie-break a 10</span>
          </label>
        </div>
      </div>
    </div>
  );
}


// ===== Torneos ‚Äì MIGRADO A FIRESTORE =====
function Torneos({ alumnos = [], user, clubActivoId, perfil = {} }) {
  const [torneos, setTorneos] = React.useState([]);
  const [loading, setLoading] = React.useState(true);
  const [selectedId, setSelectedId] = React.useState(null);

  // --- NUEVO: Estados para controlar el modal de PIN desde la lista ---
  const [isPinModalOpen, setIsPinModalOpen] = React.useState(false);
  const [torneoParaReabrir, setTorneoParaReabrir] = React.useState(null);

  const REGLAS_BASE = React.useMemo(() => (
    (typeof DEFAULT_REGLAS !== "undefined" && DEFAULT_REGLAS) || {
      grupos: { puntos: { win: 3, draw: 1, loss: 0 }, wo: { ptsWin: 3, ptsLoss: 0, gf: 0, gc: 0 }, bye: { cuenta: false, ptsWin: 3, gf: 0, gc: 0 } }
    }
  ), []);

  const mergeReglas = React.useCallback((r = {}) => {
    const g = r.grupos || {};
    return {
      ...REGLAS_BASE, ...r,
      grupos: { ...REGLAS_BASE.grupos, ...g, puntos: { ...REGLAS_BASE.grupos.puntos, ...(g.puntos || {}) }, wo: { ...REGLAS_BASE.grupos.wo, ...(g.wo || {}) }, bye: { ...REGLAS_BASE.grupos.bye, ...(g.bye || {}) } }
    };
  }, [REGLAS_BASE]);
  
  const selected = React.useMemo(() => torneos.find(t => t.id === selectedId) || null, [torneos, selectedId]);

  const torneosCollection = React.useMemo(() => {
    if (!user || !clubActivoId) return null;
    return db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId).collection('torneos');
  }, [user, clubActivoId]);

    React.useEffect(() => {
    if (!torneosCollection) return;
    setLoading(true);
    const unsubscribe = torneosCollection.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setTorneos(data);
      
      // L√≥gica de selecci√≥n mejorada para evitar "saltos"
      setSelectedId(prevId => {
        if (prevId && data.some(t => t.id === prevId)) return prevId;
        return data[0]?.id || null;
      });

      setLoading(false);
    }, error => {
      console.error("Error al cargar torneos desde Firestore:", error);
      setLoading(false);
    });
    return () => unsubscribe();
  }, [torneosCollection]);

  const upsert = (patch) => {
    if (!torneosCollection || !patch.id) return;
    const torneoActual = torneos.find(t => t.id === patch.id);
    const finalPatch = { ...patch };
    if (patch.reglas) {
      finalPatch.reglas = mergeReglas({ ...(torneoActual?.reglas || {}), ...(patch.reglas || {}) });
    }
    torneosCollection.doc(patch.id).set(finalPatch, { merge: true }).catch(error => {
        console.error("Error al actualizar el torneo:", error);
        alert("No se pudo guardar el cambio.");
    });
  };
  
  const crearTorneo = React.useCallback(async () => {
    if (!torneosCollection) return;
    const nuevo = {
      nombre: "Torneo nuevo", formato: "grupos", modalidad: "singles",
      reglas: REGLAS_BASE, grupos: [], fixture: {}, cuadro: {},
      estado: "config", createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
      const docRef = await torneosCollection.add(nuevo);
      setSelectedId(docRef.id);
    } catch (error) {
      console.error("Error al crear el torneo:", error);
      alert("No se pudo crear el torneo.");
    }
  }, [torneosCollection, REGLAS_BASE]);

  const handleClone = async (id) => {
    if (!torneosCollection) return;
    const base = torneos.find(t => t.id === id);
    if (!base) return;
    const cloneData = deepClone(base);
    delete cloneData.id;
    const clone = {
      ...cloneData,
      nombre: (base.nombre || "Torneo") + " (copia)",
      estado: "config",
      reglas: mergeReglas(base.reglas),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
        const docRef = await torneosCollection.add(clone);
        setSelectedId(docRef.id);
    } catch (error) {
        console.error("Error al clonar el torneo:", error);
        alert("No se pudo clonar el torneo.");
    }
  };
  

  const handleDelete = async (id) => {
    if (!torneosCollection || !confirm("¬øEliminar este torneo? Esta acci√≥n es permanente.")) return;
    try {
      await torneosCollection.doc(id).delete();
      if (selectedId === id) {
        const nuevosTorneos = torneos.filter(t => t.id !== id);
        setSelectedId(nuevosTorneos.length > 0 ? nuevosTorneos[0].id : null);
      }
    } catch (error) {
        console.error("Error al eliminar el torneo:", error);
        alert("No se pudo eliminar el torneo.");
    }
  };
  
  // --- Handlers para el proceso de reapertura ---
  const handleReabrirClick = (torneo) => {
    setTorneoParaReabrir(torneo);
    setIsPinModalOpen(true);
  };

  const confirmarReapertura = () => {
    if (!torneoParaReabrir) return;
    upsert({ id: torneoParaReabrir.id, estado: 'en_juego' });
    setTorneoParaReabrir(null);
    setIsPinModalOpen(false);
  };
  // --- Fin de nuevos Handlers ---

  const labelEntradaCard = (e, t) => { /* Tu funci√≥n sin cambios, si la necesitas aqu√≠ */ };

  if (loading) {
    return <div className="p-4 text-center text-slate-500">Cargando torneos...</div>;
  } 

  return (
    <div className="grid gap-4">
      <header className="flex items-center justify-between flex-wrap gap-2">
        <h2 className="text-xl font-bold text-[#34745B]">Torneos</h2>
        <div className="flex gap-2">
          <button className="px-3 py-2 rounded-xl bg-[#34745B] text-white hover:opacity-90" onClick={crearTorneo}>
            + Nuevo torneo
          </button>
        </div>
      </header>

      <section className="border rounded-2xl p-3">
        {torneos.length === 0 ? (
          <div className="text-slate-500 text-sm">A√∫n no hay torneos. Cre√° uno con ‚Äú+ Nuevo torneo‚Äù.</div>
        ) : (
          <div className="space-y-3">
            {torneos.map(t => {
              const fin  = bracketFinalInfo(t.cuadro);
              const liga = leagueWinnersInfo(t);
              const champLabel = fin?.done ? labelEntradaCard(findEntry(fin.champion, t), t) : (liga?.done && liga.type === 'single' ? labelEntradaCard(findEntry(liga.champion, t), t) : null);
              const runnerLabel = fin?.done ? labelEntradaCard(findEntry(fin.runnerUp, t), t) : (liga?.done && liga.type === 'single' && liga.runnerUp ? labelEntradaCard(findEntry(liga.runnerUp, t), t) : null);

              return (
                <div
                  key={t.id}
                  className={cx("w-full border rounded-2xl p-3 transition cursor-pointer", selectedId === t.id ? "border-[#34745B] bg-[#34745B]/5" : "border-slate-200 hover:bg-slate-50")}
                  onClick={() => setSelectedId(t.id)}
                >
                  <div className="flex items-start justify-between gap-2">
                    <div className="min-w-0">
                      <div className="font-semibold text-slate-800 truncate">{t.nombre || "(Sin nombre)"}</div>
                      <div className="text-xs text-slate-500 flex items-center gap-2">
                        <span>{formatLabel(t.formato)} ¬∑ {t.modalidad === 'dobles' ? 'Dobles' : 'Singles'}</span>
                        {t.estado === 'finalizado' ? (
                          <span className="px-2 py-0.5 rounded-full bg-slate-200 text-slate-700 font-medium">Finalizado</span>
                        ) : (
                          <span className="text-emerald-600">{prettyEstado(t.estado)}</span>
                        )}
                      </div>
                      {(champLabel || runnerLabel) && (
                        <div className="text-xs text-emerald-700 mt-1">
                          {champLabel && <>üèÜ {champLabel}</>}
                          {runnerLabel && <> ¬∑ ü•à {runnerLabel}</>}
                        </div>
                      )}
                    </div>
                    {/* --- INICIO DE LA MODIFICACI√ìN DE BOTONES --- */}
                    <div className="flex items-center gap-1 shrink-0">
                      {t.estado === 'finalizado' && (
                        <IconButton 
                          title="Reabrir Torneo (requiere PIN)" 
                          onClick={(e)=>{e.stopPropagation(); handleReabrirClick(t);}} 
                          icon={IconUnlock} 
                        />
                      )}
                      <IconButton title="Duplicar" onClick={(e)=>{e.stopPropagation(); handleClone(t.id);}} icon={IconCopy} />
                      <IconButton title="Eliminar" onClick={(e)=>{e.stopPropagation(); handleDelete(t.id);}} icon={IconTrash} />
                    </div>
                    {/* --- FIN DE LA MODIFICACI√ìN DE BOTONES --- */}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>

      <section>
        {!selected ? (
          <div className="border border-slate-200 rounded-2xl p-8 text-center text-slate-500">Seleccion√° un torneo de la lista o cre√° uno nuevo para continuar.</div>
        ) : (
          <TorneoEditorPro
            key={selected.id}
            torneo={selected}
            onChange={upsert}
            alumnos={alumnos}
            perfil={perfil}
            clubActivoId={clubActivoId}
            user={user}
          />
        )}
      </section>

      {/* --- Modal de PIN --- */}
      <PinConfirmModal
        isOpen={isPinModalOpen}
        onClose={() => { setTorneoParaReabrir(null); setIsPinModalOpen(false); }}
        onConfirm={confirmarReapertura} // <-- Aseg√∫rate de que aqu√≠ llame a "confirmarReapertura"
        perfil={perfil}
        title={`Reabrir Torneo "${torneoParaReabrir?.nombre}"`}
        message="Para desbloquear este torneo y poder editarlo, ingresa tu PIN de seguridad."
      />
    </div>
  );
}



// ================== Editor PRO por pesta√±as ==================
function TorneoEditorPro({ torneo, onChange, alumnos, perfil, clubActivoId, user, setToast }) {
  // --- ESTADOS DE CONTROL ---
  const [tab, setTab] = React.useState(() => inferStartTab(torneo));
  const [isTemporarilyUnlocked, setIsTemporarilyUnlocked] = React.useState(false);
  const [isPinModalOpen, setIsPinModalOpen] = React.useState(false);

  // --- L√ìGICA DE BLOQUEO CENTRAL ---
  // El torneo est√° bloqueado si est√° 'en_juego' y no se ha desbloqueado, O si ya est√° 'finalizado'.
  const isLocked = (torneo.estado === 'en_juego' && !isTemporarilyUnlocked);
  const tournamentFinished = torneo.estado === 'finalizado';

  const [rankingsList, setRankingsList] = React.useState([]);

  // --- HOOKS Y HELPERS ---
  React.useEffect(() => {
    // Cada vez que cambiamos a un torneo diferente, se resetea el estado de desbloqueo.
    setIsTemporarilyUnlocked(false);
    setTab(inferStartTab(torneo));
  }, [torneo.id]);

  React.useEffect(() => {
    const uid = firebase.auth().currentUser?.uid;
    if (!uid || !clubActivoId) return;
    const q = db.collection('users').doc(String(uid)).collection('clubs').doc(String(clubActivoId)).collection('rankings').orderBy('nombre');
    const unsub = q.onSnapshot((snap) => {
      const rows = [];
      snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
      setRankingsList(rows);
    });
    return () => unsub();
  }, [clubActivoId, user]);

  const isLiga = isLeagueMode(torneo);
  const isElim = torneo.formato === 'eliminacion';
  const isMixto = torneo.formato === 'grupos_y_eliminacion';

  React.useEffect(() => {
    if (isLiga && tab === 'fase') setTab('partidos');
    if (isElim && (tab === 'estructura' || tab === 'partidos')) setTab('fase');
  }, [isLiga, isElim, tab]);

  const gotoTab = (k) => setTab(k);

  const handlePinSuccess = () => {
    setIsTemporarilyUnlocked(true);
    setIsPinModalOpen(false);
    if (setToast) setToast("Torneo desbloqueado para edici√≥n.");
  };

  const patch = (p) => onChange({ ...torneo, ...p });
  const patchReglas = (r) => patch({ reglas: { ...torneo.reglas, ...r } });
  const setNombre = (v) => patch({ nombre: v });
  const setFormato = (v) => patch({ formato: v, estado: "config" });
  const setModalidad = (v) => patch({ modalidad: v, estado: "config" });

  const generarGruposYFixture = () => {
    const seeding = torneo?.reglas?.ko?.seeding || 'serpentina';
    const baseIds = torneo.modalidad === 'dobles' ? (torneo.teams || []).map(t => t.id) : (torneo.participantes || []);
    const ids = (seeding === 'aleatorio') ? shuffle([...baseIds]) : baseIds;
    if (ids.length < 2 || (torneo.gruposCount || 0) < 1) return;
    const grupos = buildGroups(ids, torneo.gruposCount || 2);
    const fixture = {};
    grupos.forEach((g) => {
      const rondas = buildRoundRobin(g.entradas, !!torneo.idaVuelta);
      fixture[g.id] = rondas;
    });
    // ¬°AQU√ç SE ACTIVA EL BLOQUEO!
    patch({ grupos, fixture, estado: 'en_juego' });
  };

  const generarCuadroEliminacion = React.useCallback(() => {
    const ids = (torneo.modalidad === "dobles" ? (torneo.teams || []).map(t => t.id) : (torneo.participantes || []).slice()).filter(Boolean);
    const unique = Array.from(new Set(ids));
    if (unique.length < 2) { alert("Necesit√°s al menos 2 participantes/parejas para generar el cuadro."); return; }
    const cuadro = buildBracket(unique, { seeding: torneo?.reglas?.ko?.seeding || 'serpentina' });
    // ¬°AQU√ç TAMBI√âN SE ACTIVA EL BLOQUEO!
    onChange({ ...torneo, cuadro, estado: 'en_juego' });
    gotoTab("fase");
  }, [torneo, onChange, gotoTab]);

  const handleSiguientePaso = () => {
    if (!groupsAllMatchesDone(torneo)) {
      alert(`Faltan partidos de grupos por cargar. Completalos antes de pasar a Fase final.`);
      return;
    }
    const K = Math.max(1, parseInt(torneo.topK || 2, 10));
    const ids = computeQualifiers(torneo, K);
    const clean = Array.from(new Set((ids || []).filter(Boolean)));
    if (clean.length < 2) { alert(`Se necesitan al menos 2 clasificados para el cuadro. Recibidos: ${clean.length}.`); return; }
    if (torneo.cuadro && hasKOResults(torneo.cuadro)) {
      if (!confirm("Ya hay resultados cargados en Fase final. Regenerar el cuadro los borrar√°. ¬øContinuar?")) return;
    }
    const cuadro = buildBracket(clean);
    onChange({ ...torneo, cuadro, lockedGrupos: true }); // Mantenemos lockedGrupos por compatibilidad
    gotoTab("fase");
  };

  const alumnoById = React.useCallback((id) => alumnos.find(a => a.id === id) || { id, nombre: id }, [alumnos]);
  const labelAlumno = (a) => a ? `${a.apellido || ""}${a.apellido ? ", " : ""}${a.nombre || a.name || a.id}`.trim() : "";
  const labelEntrada = (e) => {
    if (torneo.modalidad !== 'dobles') {
      const id = typeof e === 'string' ? e : e?.id;
      return labelAlumno(alumnoById(id));
    } else {
      let team = (e && e.members) ? e : (torneo.teams || []).find(t => t.id === (typeof e === 'string' ? e : e?.id)) || null;
      if (!team) return '‚Äî';
      const [id1, id2] = team.members || [];
      return `${labelAlumno(alumnoById(id1))} / ${labelAlumno(alumnoById(id2))}`;
    }
  };

  const tabs = [
    { key: 'formato', label: 'Formato' },
    { key: 'reglas', label: 'Reglas' },
    { key: 'participantes', label: torneo.modalidad === 'dobles' ? 'Participantes ¬∑ Parejas' : 'Participantes' },
    ...(!isElim ? [{ key: 'estructura', label: 'Grupos / Fixture' }] : []),
    ...((isLiga || isMixto) ? [{ key: 'partidos', label: 'Partidos' }] : []),
    ...((isMixto || isElim) ? [{ key: 'fase', label: 'Fase final' }] : []),
  ];

  const canViewParticipantes = torneo && torneo.nombre && torneo.nombre.trim() !== "";
  const canViewEstructura = canViewParticipantes && ((torneo.modalidad === 'dobles' && (torneo.teams || []).length >= 2) || (torneo.modalidad !== 'dobles' && (torneo.participantes || []).length >= 2));
  const canViewJuego = canViewEstructura && ((torneo.fixture && Object.keys(torneo.fixture).length > 0) || (torneo.cuadro && Object.keys(torneo.cuadro).length > 0));

  return (
    <div className="border border-slate-200 rounded-2xl">
      {torneo.estado === 'en_juego' && (
        <div className={`p-3 rounded-t-2xl flex items-center justify-between ${isLocked ? 'bg-amber-50 border-b border-amber-200' : 'bg-emerald-50 border-b border-emerald-200'}`}>
          {isLocked ? (
            <>
              <p className="text-sm font-semibold text-amber-800">üîí Torneo en juego (Edici√≥n bloqueada)</p>
              <button onClick={() => setIsPinModalOpen(true)} className="px-3 py-1.5 text-sm rounded-lg border bg-white border-amber-300 text-amber-800 hover:bg-amber-100">Desbloquear (PIN)</button>
            </>
          ) : (
            <p className="text-sm font-semibold text-emerald-800">üîì Torneo desbloqueado para edici√≥n temporal.</p>
          )}
        </div>
      )}
      {tournamentFinished && (
         <div className="p-3 rounded-t-2xl bg-slate-100 border-b border-slate-200">
            <p className="text-sm font-semibold text-slate-700">üèÅ Torneo Finalizado (Solo lectura)</p>
         </div>
      )}

      <div className="flex flex-wrap gap-2 p-3 border-b bg-slate-50">
        {tabs.map(t => {
          const tabIsDisabledForEditing = isLocked && ['formato', 'reglas', 'participantes', 'estructura'].includes(t.key);
          let isDisabled = tabIsDisabledForEditing;
          let title = tabIsDisabledForEditing ? "El torneo est√° en juego. Desbloquea con PIN para editar." : '';
          
          if (!title) {
            if (t.key === 'participantes' && !canViewParticipantes) { isDisabled = true; title = 'Define un nombre para el torneo.'; }
            else if (t.key === 'estructura' && !canViewEstructura) { isDisabled = true; title = 'Agrega al menos 2 participantes/parejas.'; }
            else if (t.key === 'partidos' && !canViewJuego) { isDisabled = true; title = 'Genera la estructura de grupos/fixture.'; }
            else if (t.key === 'fase' && isElim && !canViewEstructura) { isDisabled = true; title = 'Agrega al menos 2 participantes/parejas.'; }
            else if (t.key === 'fase' && !isElim && !canViewJuego) { isDisabled = true; title = 'Completa la fase de grupos primero.'; }
          }
          return (
            <button key={t.key} onClick={() => !isDisabled && setTab(t.key)} disabled={isDisabled} title={title}
              className={`px-3 py-1.5 rounded-xl text-sm transition-opacity ${tab === t.key ? 'bg-white border border-slate-200 font-semibold' : 'hover:bg-white'} ${isDisabled ? 'opacity-50 cursor-not-allowed text-slate-400' : 'text-slate-700'}`}>
              {t.label}
            </button>
          );
        })}
      </div>

      <div className="p-4">
        {tab === 'formato' && <FormatoTab disabled={isLocked || tournamentFinished} {...{ nombre: torneo.nombre, setNombre: (v) => patch({ nombre: v }), formato: torneo.formato, setFormato, modalidad: torneo.modalidad, setModalidad, fechaInicio: torneo.fechaInicio, setFechaInicio: (v) => patch({ fechaInicio: v }), fechaFin: torneo.fechaFin, setFechaFin: (v) => patch({ fechaFin: v }) }} />}
        {tab === 'reglas' && <ReglasTab disabled={isLocked || tournamentFinished} {...{ reglas: torneo.reglas, setReglas: patchReglas, modalidad: torneo.modalidad, rankings: rankingsList, rankingId: torneo.rankingId || "", setRankingId: (v) => patch({ rankingId: v || null }) }} />}
        {tab === 'participantes' && <ParticipantesTab disabled={isLocked || tournamentFinished} {...{ modalidad: torneo.modalidad, participantes: torneo.participantes || [], setParticipantes: (arr) => patch({ participantes: arr }), teams: torneo.teams || [], setTeams: (arr) => patch({ teams: arr }), alumnos, labelAlumno }} />}
        {tab === 'estructura' && <EstructuraTab locked={isLocked || tournamentFinished} {...{ torneo, setGruposCount: (n) => patch({ gruposCount: n }), setIdaVuelta: (b) => patch({ idaVuelta: b }), setTopK: (n) => patch({ topK: n }), onGenerarGrupos: generarGruposYFixture, onGenerarCuadro: torneo.formato === 'eliminacion' ? generarCuadroEliminacion : undefined, onSiguientePaso: !isLiga ? handleSiguientePaso : undefined, labelEntrada }} />}
        {tab === 'partidos' && <PartidosTab disabled={tournamentFinished} {...{ torneo, onChange, labelEntrada, perfil, clubActivoId, user }} />}
        {tab === 'fase' && <FaseFinalTab disabled={tournamentFinished} {...{ torneo, onChange, labelEntrada, onGenerarCuadro: torneo.formato === 'eliminacion' ? generarCuadroEliminacion : undefined, clubActivoId, user, perfil }} />}
      </div>
      
      <PinConfirmModal
        isOpen={isPinModalOpen}
        onClose={() => setIsPinModalOpen(false)}
        onConfirm={handlePinSuccess}
        perfil={perfil}
        title="Desbloquear Edici√≥n de Torneo"
        message="Para modificar la estructura o las reglas de un torneo en curso, por favor ingresa tu PIN de seguridad."
      />
    </div>
  );
}

// ================== Tabs ‚Äì Implementaci√≥n ==================
function FormatoTab({
  nombre, setNombre,
  formato, setFormato,
  modalidad, setModalidad,
  fechaInicio, setFechaInicio,
  fechaFin, setFechaFin,
  disabled
}) {
  // Helpers para compatibilidad con distintos tipos de fecha
  const toInputDate = (v) => {
    if (!v) return '';
    const d = typeof v === 'number' ? new Date(v) : new Date(String(v));
    if (isNaN(d)) return '';
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  };
  // Guardamos como timestamp (ms) para m√°xima compatibilidad con tu c√≥digo
  const fromInputDate = (s) => s ? new Date(`${s}T00:00:00`).getTime() : null;

  return (
    <div className="grid gap-4">
      {/* Fila: Nombre + Fechas */}
      <div className="grid gap-3 md:grid-cols-[1fr,180px,180px]">
        {/* Nombre */}
        <div>
          <label className="block text-sm text-slate-600 mb-1">Nombre del torneo</label>
          <input
            type="text"
            className="w-full border rounded-xl px-3 py-2"
            placeholder="Ej: Torneo Apertura"
            value={nombre || ''}
            onChange={(e) => !disabled && setNombre(e.target.value)}
            disabled={disabled}
          />
        </div>

        {/* Fecha de inicio */}
        <div>
          <label className="block text-sm text-slate-600 mb-1">Fecha de inicio</label>
          <input
            type="date"
            className="w-full border rounded-xl px-3 py-2"
            value={toInputDate(fechaInicio)}
            onChange={(e) => !disabled && setFechaInicio(fromInputDate(e.target.value))}
            disabled={disabled}
          />
        </div>

        {/* Fecha de finalizaci√≥n */}
        <div>
          <label className="block text-sm text-slate-600 mb-1">Fecha de finalizaci√≥n</label>
          <input
            type="date"
            className="w-full border rounded-xl px-3 py-2"
            value={toInputDate(fechaFin)}
            min={toInputDate(fechaInicio) || undefined}
            onChange={(e) => !disabled && setFechaFin(fromInputDate(e.target.value))}
            disabled={disabled}
          />
        </div>
      </div>

      {/* Modalidad / Formato (lo b√°sico para que no pierdas nada) */}
      <div className="grid gap-3 sm:grid-cols-2">
        <div>
          <label className="block text-sm text-slate-600 mb-1">Modalidad</label>
          <div className="flex gap-3">
            <label className="inline-flex items-center gap-2 text-sm">
              <input
                type="radio"
                name="modalidad"
                checked={modalidad !== 'dobles'}
                onChange={() => !disabled && setModalidad('singles')}
                disabled={disabled}
              />
              Singles
            </label>
            <label className="inline-flex items-center gap-2 text-sm">
              <input
                type="radio"
                name="modalidad"
                checked={modalidad === 'dobles'}
                onChange={() => !disabled && setModalidad('dobles')}
                disabled={disabled}
              />
              Dobles
            </label>
          </div>
        </div>

        <div>
          <label className="block text-sm text-slate-600 mb-1">Formato</label>
          <select
            className="w-full border rounded-xl px-3 py-2"
            value={formato || 'grupos'}
            onChange={(e) => !disabled && setFormato(e.target.value)}
            disabled={disabled}
          >
            <option value="grupos">S√≥lo grupos (Liga)</option>
            <option value="eliminacion">Eliminaci√≥n directa</option>
            <option value="grupos_y_eliminacion">Grupos + Eliminaci√≥n</option>
          </select>
        </div>
      </div>

      {/* tip */}
      <div className="text-xs text-slate-500">
        Las fechas se usar√°n en el resumen de reglas y en las exportaciones (PDF).
      </div>
    </div>
  );
}


// REEMPLAZA TU FUNCI√ìN ReglasTab COMPLETA CON ESTA:
function ReglasTab({
  reglas,
  setReglas,          // <- patchReglas del padre: espera OBJETO final
  modalidad,
  disabled = false,
  rankings = [],
  rankingId = "",
  setRankingId = () => {}
}) {
  // Aseguramos estructura por defecto para evitar "undefined" en campos anidados
  const r = withRankingDefaults(reglas);

  // === CLAVE: wrapper que acepta funci√≥n u objeto y siempre entrega un OBJETO al padre ===
  const setReglasCompat = React.useCallback((updaterOrObj) => {
    const prev = reglas || {};
    const next = (typeof updaterOrObj === 'function') ? updaterOrObj(prev) : updaterOrObj;
    // Nos aseguramos de pasar un objeto "lleno" y no romper otras claves
    setReglas({ ...prev, ...(next || {}) });
  }, [reglas, setReglas]);

  // Helper para actualizar cualquier path anidado sin perder el resto de las reglas
  const set = React.useCallback((path, value) => {
    if (disabled) return;
    const base = reglas || {};
    const next = deepSet(base, path, value); // deepSet debe retornar una copia inmutable
    setReglasCompat(next);
  }, [disabled, reglas, setReglasCompat]);

  // Helper para inputs num√©ricos del ranking
  const setRankingPoints = React.useCallback((scope, key, value) => {
    const n = Number(value);
    set(['ranking', scope, key], Number.isFinite(n) ? n : 0);
  }, [set]);

  return (
    <div className="grid gap-6">
      {/* --- FASE DE GRUPOS --- */}
      <RulesEditor
        title="Formato de Partido - Fase de Grupos"
        scope="grupos"
        reglas={r}
        setReglas={setReglasCompat}   
        modalidadUI={modalidad}
        disabled={disabled}
      />

      {/* --- ELIMINACI√ìN DIRECTA (KO) --- */}
      <div className="border rounded-xl p-3">
        <div className="font-semibold text-slate-800 mb-2">
          Reglas de Eliminaci√≥n Directa (KO)
        </div>

        <div>
          <label className="text-sm text-slate-600 mb-1 block">M√©todo de Sorteo / Siembra</label>
          <select
            className="w-full border rounded-lg px-2 py-1 text-sm mb-3"
            value={r?.ko?.seeding || 'serpentina'}
            onChange={e => set(['ko', 'seeding'], e.target.value)}
            disabled={disabled}
          >
            <option value="serpentina">Serpentina (1 vs 8, 2 vs 7, etc.)</option>
            <option value="aleatorio">Aleatorio</option>
          </select>
        </div>

        <RulesEditor
          title="Formato de Partido - Fase de Eliminaci√≥n"
          scope="ko"
          reglas={r}
          setReglas={setReglasCompat}  
          modalidadUI={modalidad}
          disabled={disabled}
        />
      </div>

      {/* --- PUNTUACI√ìN PARA RANKING DE TORNEOS --- */}
      <div className="border-2 rounded-xl p-4 bg-emerald-50 border-emerald-200 space-y-4">
        <h3 className="text-lg font-semibold text-emerald-800">Puntuaci√≥n para Ranking de Torneos</h3>

        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">1. Ranking de Destino</label>
          <select
            className="w-full border rounded-xl px-3 py-2"
            value={rankingId}
            onChange={e => setRankingId(e.target.value)}
            disabled={disabled}
          >
            <option value="">‚Äî No aplicar a ning√∫n ranking ‚Äî</option>
            {(rankings || []).filter(rk => rk.tipo === 'torneos').map(rk => (
              <option key={rk.id} value={rk.id}>{rk.nombre || rk.id}</option>
            ))}
          </select>
          <p className="text-xs text-slate-500 mt-1">
            Elige un "Ranking de Torneos" para sumar los puntos al finalizar.
          </p>
        </div>

        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">
            2. Puntos por Posici√≥n en Fase Final (KO)
          </label>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <NumberField label="Campe√≥n"        value={r.ranking?.ko?.champion ?? 0}  onChange={v => setRankingPoints('ko', 'champion', v)}  disabled={disabled} />
            <NumberField label="Subcampe√≥n"     value={r.ranking?.ko?.runnerUp ?? 0} onChange={v => setRankingPoints('ko', 'runnerUp', v)} disabled={disabled} />
            <NumberField label="Semifinalista"  value={r.ranking?.ko?.semi ?? 0}     onChange={v => setRankingPoints('ko', 'semi', v)}      disabled={disabled} />
            <NumberField label="Cuartos de Final" value={r.ranking?.ko?.quarter ?? 0} onChange={v => setRankingPoints('ko', 'quarter', v)}  disabled={disabled} />
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">
            3. Puntos por Posici√≥n en Liga (Si no hay Fase Final)
          </label>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <NumberField label="1er Puesto"     value={r.ranking?.liga?.top?.[0] ?? 0}         onChange={v => set(['ranking','liga','top',0], v)} disabled={disabled} />
            <NumberField label="2do Puesto"     value={r.ranking?.liga?.top?.[1] ?? 0}         onChange={v => set(['ranking','liga','top',1], v)} disabled={disabled} />
            <NumberField label="3er Puesto"     value={r.ranking?.liga?.top?.[2] ?? 0}         onChange={v => set(['ranking','liga','top',2], v)} disabled={disabled} />
            <NumberField label="Por Participar" value={r.ranking?.liga?.participacion ?? 0}    onChange={v => set(['ranking','liga','participacion'], v)} disabled={disabled} />
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">
            4. Multiplicador y Opciones
          </label>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
            <NumberField label="Multiplicador" value={r.ranking?.multiplicador ?? 1} onChange={v => set(['ranking','multiplicador'], v)} disabled={disabled} min={1} />
            <ToggleField  label="Dividir puntos en dobles" checked={!!r.ranking?.dobles?.dividir} onChange={v => set(['ranking','dobles','dividir'], v)} disabled={disabled} />
          </div>
          <p className="text-xs text-slate-500 mt-1">
            El multiplicador (ej: 2) aumenta el valor de todos los puntos.
          </p>
        </div>
      </div>

      <InfoTip>
        La modalidad actual es <b>{modalidad === 'dobles' ? 'Dobles' : 'Singles'}</b>. En Dobles, arm√° las parejas
        manualmente en la pesta√±a Participantes.
      </InfoTip>
    </div>
  );
}

// Y no olvides agregar esta funci√≥n junto a tus otras funciones helper si no lo hiciste antes:
function withRankingDefaults(reglas) {
    const r = reglas || {};
    const base = {
      destinoId: null,
      modo: 'posiciones',
      multiplicador: 1,
      liga: { top: [100,60,40,20,10], participacion: 5 },
      ko:   { champion:120, runnerUp:80, semi:50, quarter:25, roundOf16:10 },
      dobles: { dividir: false }
    };
    const ranking = r.ranking || {};
    return { 
      ...r, 
      ranking: { 
        ...base, ...ranking,
        liga: { ...base.liga, ...(ranking.liga || {}) },
        ko: { ...base.ko, ...(ranking.ko || {}) },
        dobles: { ...base.dobles, ...(ranking.dobles || {}) }
      } 
    };
}



function ParticipantesTab({ modalidad, participantes, setParticipantes, teams, setTeams, alumnos, labelAlumno }) {
  const [busca, setBusca] = React.useState('');
  const pool = React.useMemo(() => alumnos
    .filter(a => (a.nombre||'').toLowerCase().includes(busca.toLowerCase()) || (a.apellido||'').toLowerCase().includes(busca.toLowerCase()))
    .sort((a,b)=> (a.apellido||'').localeCompare(b.apellido||'')), [alumnos, busca]);

  // Para dobles: creador de parejas
  const [sel1, setSel1] = React.useState('');
  const [sel2, setSel2] = React.useState('');

  const agregarParticipante = (id) => {
    if (participantes.includes(id)) return;
    setParticipantes([...participantes, id]);
  };
  const quitarParticipante = (id) => setParticipantes(participantes.filter(x => x !== id));

  const agregarPareja = () => {
    if (!sel1 || !sel2 || sel1 === sel2) return;
    // evitar repetir jugador ya usado
    const usados = new Set(teams.flatMap(t => t.members));
    if (usados.has(sel1) || usados.has(sel2)) { alert('Uno de los jugadores ya est√° en una pareja.'); return; }
    const nueva = { id: genId('team_'), members: [sel1, sel2] };
    setTeams([...(teams||[]), nueva]);
    setSel1(''); setSel2('');
  };
  const quitarPareja = (id) => setTeams((teams||[]).filter(t => t.id !== id));

  return (
    <div className="grid gap-6">
      {modalidad === 'singles' && (
        <div className="grid md:grid-cols-2 gap-4">
          <div className="border rounded-xl p-3">
            <div className="font-semibold mb-2">Alumnos</div>
            <input className="w-full border rounded-xl px-3 py-2 mb-2" value={busca} onChange={e=>setBusca(e.target.value)} placeholder="Buscar por nombre o apellido"/>
            <div className="max-h-64 overflow-auto divide-y">
              {pool.map(a => (
                <div key={a.id} className="py-2 flex items-center justify-between">
                  <div className="text-sm">{labelAlumno(a)}</div>
                  <button className="text-xs px-2 py-1 rounded-lg bg-slate-800 text-white" onClick={()=>agregarParticipante(a.id)}>Agregar</button>
                </div>
              ))}
            </div>
          </div>

          <div className="border rounded-xl p-3">
            <div className="font-semibold mb-2">Seleccionados ({participantes.length})</div>
            {participantes.length === 0 && <div className="text-sm text-slate-500">A√∫n no hay jugadores.</div>}
            <div className="flex flex-wrap gap-2">
              {participantes.map(id => (
                <span key={id} className="text-xs bg-slate-100 rounded-xl px-2 py-1 flex items-center gap-1">
                  {labelAlumno(alumnos.find(a=>a.id===id))}
                  <button className="ml-1" onClick={()=>quitarParticipante(id)} title="Quitar">‚úï</button>
                </span>
              ))}
            </div>
          </div>
        </div>
      )}

      {modalidad === 'dobles' && (
        <div className="grid gap-4">
          <div className="border rounded-xl p-3">
            <div className="font-semibold mb-2">Crear parejas</div>
            <div className="grid md:grid-cols-3 gap-2 items-end">
              <SelectAlumno value={sel1} onChange={setSel1} alumnos={alumnos} placeholder="Jugador A" />
              <SelectAlumno value={sel2} onChange={setSel2} alumnos={alumnos} placeholder="Jugador B" />
              <button className="px-3 py-2 rounded-xl bg-slate-800 text-white" onClick={agregarPareja}>Agregar pareja</button>
            </div>
            <div className="text-xs text-slate-500 mt-2">Cada jugador puede pertenecer a una √∫nica pareja.</div>
          </div>

          <div className="border rounded-xl p-3">
            <div className="font-semibold mb-2">Parejas ({(teams||[]).length})</div>
            {(teams||[]).length === 0 && <div className="text-sm text-slate-500">A√∫n no hay parejas.</div>}
            <div className="space-y-2">
              {(teams||[]).map(t => (
                <div key={t.id} className="flex items-center justify-between border rounded-xl px-3 py-2">
                  <div className="text-sm">{renderTeamLabel(t, alumnos)}</div>
                  <button className="text-xs px-2 py-1 rounded-lg bg-slate-800 text-white" onClick={()=>quitarPareja(t.id)}>Quitar</button>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      <InfoTip>
        Record√°: el orden visible se usa como orden de entrada para generar fixture/cuadro. Pod√©s reordenar m√°s adelante si lo necesit√°s.
      </InfoTip>
    </div>
  );
}

// === Layout de llaves (SVG + cajas absolutas) ===
function computeBracketLayout(cuadro, colW = 100, rowGap = 50, boxW = 100, boxH = 38) {
  if (!cuadro || Object.keys(cuadro).length === 0) {
    return { width: colW, height: rowGap, boxes: [], lines: [] };
  }

  const rnums = Object.keys(cuadro).map(n => Number(n)).sort((a, b) => a - b);
  const firstRoundMatches = (cuadro[String(rnums[0])] || []).length;
  const totalH = Math.max(1, firstRoundMatches) * rowGap;

  const boxes = [];
  rnums.forEach((rnum, rIndex) => {
    const matchesInRound = cuadro[String(rnum)] || [];
    const ySpacing = rowGap * (2 ** rIndex);
    matchesInRound.forEach((match, matchIndex) => {
      const x = 16 + rIndex * colW;
      const y = ySpacing * (matchIndex + 0.5) - (ySpacing / 2);
      boxes.push({ match, x, y: y + (ySpacing / 2) });
    });
  });

  const lines = [];
  rnums.forEach((rnum, rIndex) => {
    if (rIndex === 0) return; // No hay l√≠neas de entrada para la primera ronda

    const matchesInRound = cuadro[String(rnum)] || [];
    matchesInRound.forEach((match, matchIndex) => {
      const destBox = boxes.find(b => b.match.id === match.id);
      if (!destBox) return;

      const sourceMatches = (cuadro[String(rnum - 1)] || []);
      const sourceMatchA = sourceMatches[matchIndex * 2];
      const sourceMatchB = sourceMatches[matchIndex * 2 + 1];

      const sourceBoxA = sourceMatchA ? boxes.find(b => b.match.id === sourceMatchA.id) : null;
      const sourceBoxB = sourceMatchB ? boxes.find(b => b.match.id === sourceMatchB.id) : null;

      const midX = destBox.x - (colW / 4);

      if (sourceBoxA) {
        // L√≠nea horizontal desde el padre A
        lines.push(`M ${sourceBoxA.x + boxW} ${sourceBoxA.y} L ${midX} ${sourceBoxA.y}`);
      }
      if (sourceBoxB) {
        // L√≠nea horizontal desde el padre B
        lines.push(`M ${sourceBoxB.x + boxW} ${sourceBoxB.y} L ${midX} ${sourceBoxB.y}`);
      }
      if (sourceBoxA && sourceBoxB) {
        // L√≠nea vertical que une a los dos padres
        lines.push(`M ${midX} ${sourceBoxA.y} L ${midX} ${sourceBoxB.y}`);
      }
      
      // L√≠nea horizontal hacia el hijo
      lines.push(`M ${midX} ${destBox.y} L ${destBox.x} ${destBox.y}`);
    });
  });

  const width = 16 + rnums.length * colW + 16;
  const height = totalH + 40;

  return { width, height, boxes, lines };
}

// Render del bracket como SVG (l√≠neas) + cajas absolutas (partidos)
// REEMPLAZA TU BracketViewSVG CON ESTE
function BracketViewSVG({ cuadro, labelEntrada, resumenMarcador, onMatchClick, containerId, layout }) {
  if (!cuadro) return null;
  
  // La funci√≥n ahora devuelve 'lines', lo usamos aqu√≠
  const { width, height, boxes, lines } = computeBracketLayout(cuadro, layout?.colW, layout?.rowGap, layout?.boxW, layout?.boxH);

  const sideLabel = (side) => {
    if (!side || side?.BYE) return "‚Äî";
    return labelEntrada(side);
  };

  return (
    <div id={containerId || undefined} className="relative overflow-auto border rounded-xl" style={{ minHeight: 120 }}>
      {/* Conectores */}
      <svg width={width} height={height} style={{ display: 'block' }}>
        {/* Usamos 'lines' en lugar de 'edges' y lo dibujamos */}
        {lines.map((d, i) => (
          <path key={i} d={d} fill="none" stroke="#CBD5E1" strokeWidth="2" />
        ))}
      </svg>

      {/* Cajas (esta parte no cambia, pero la incluyo para que tengas el componente completo) */}
      <div className="absolute inset-0">
        {boxes.map(({ match: m, x, y }) => (
          <div
            key={m.id}
            className="bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow cursor-pointer"
            style={{
              position: 'absolute',
              left: x,
              top: y - (layout?.boxH || 68) / 2, // Centrado vertical
              width: layout?.boxW || 210,
              height: layout?.boxH || 68,
              padding: '8px 10px',
              boxSizing: 'border-box'
            }}
            onClick={() => onMatchClick && onMatchClick(m)}
            title="Cargar/editar resultado"
          >
            <div className="text-sm font-medium truncate">{sideLabel(m.a)} <span className="text-slate-400">vs</span> {sideLabel(m.b)}</div>
            <div className="text-xs text-slate-600 mt-2 font-semibold text-center">
              {m.done && m.result?.sets && m.result.sets.length > 0 ? (
                <span className="tracking-wider">{m.result.sets.map(set => `${set.a}-${set.b}`).join(' / ')}</span>
              ) : m.done ? (
                <span className="text-emerald-700">Finalizado</span>
              ) : (
                <span className="text-slate-400 font-normal">Pendiente de resultado</span>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- Helper: tabla de posiciones para un grupo (Liga) ---
// --- Helper: tabla de posiciones para un grupo (Liga) ---
function computeTablaGrupo(torneo, gid) {
  // --- INICIO DE LA CORRECCI√ìN ---
  // Se asegura de que la configuraci√≥n de puntos siempre tenga valores por defecto.
  const defaultPoints = { win: 3, draw: 1, loss: 0 };
  const cfg = { ...defaultPoints, ...(torneo?.reglas?.grupos?.puntos || {}) };
  // --- FIN DE LA CORRECCI√ìN ---

  // Helpers locales
  const normId = (e) => {
    if (!e) return null;
    if (typeof e === 'string') return e;
    if (e.BYE) return null;             // tratamos BYE como "no entrada"
    return e.id ?? e.alumnoId ?? null;
  };
  const parseSet = (s) => {
    if (!s) return [0, 0];
    if (Array.isArray(s)) return [Number(s[0])||0, Number(s[1])||0];
    if (typeof s === 'string') {
      const m = s.match(/(\d+)\s*[-x:]\s*(\d+)/i);
      return m ? [Number(m[1])||0, Number(m[2])||0] : [0,0];
    }
    const a = s.a ?? s.A ?? s[0];
    const b = s.b ?? s.B ?? s[1];
    return [Number(a)||0, Number(b)||0];
  };

  // Entradas del grupo
  const grupo = (torneo?.grupos || []).find(g => g.id === gid) || { entradas: [] };
  const entradas = (grupo.entradas || []).map(normId).filter(Boolean);

  // Fila base
  const mkRow = (id) => ({
    alumnoId: id,
    PJ: 0, G: 0, E: 0, P: 0,
    GF: 0, GC: 0,          // games a favor / en contra
    SF: 0, SC: 0,          // sets a favor / en contra (opcional)
    PTS: 0,
  });

  // Mapa { id -> fila }
  const rows = new Map();
  entradas.forEach(id => { if (id) rows.set(id, mkRow(id)); });

  // Flatten del fixture del grupo (puede venir por rondas o plano)
  const fx = torneo?.fixture?.[gid] || [];
  const list = Array.isArray(fx[0]) ? fx.flat() : fx;

  for (const m of list) {
    const aId = normId(m.a);
    const bId = normId(m.b);
    if (!aId || !bId) continue; // salteamos BYE o entradas inv√°lidas

    if (!rows.has(aId)) rows.set(aId, mkRow(aId));
    if (!rows.has(bId)) rows.set(bId, mkRow(bId));
    const A = rows.get(aId);
    const B = rows.get(bId);

    const res = m?.result || {};
    const wo = res.wo || m.wo || m.woWinner || null;
    const isDraw = !!(res.draw || res.empate);
    const winnerSide =
      res.winner ||
      (wo === 'a' ? 'a' : wo === 'b' ? 'b' : null);

    const played = isDraw || winnerSide === 'a' || winnerSide === 'b' || !!res.done || !!m.done;
    if (!played) continue;

    // PJ
    A.PJ++; B.PJ++;

    // Sumar GF/GC y SF/SC si hay sets cargados
    const sets = res.sets || [];
    if (Array.isArray(sets) && sets.length) {
      let sa = 0, sb = 0; // sets ganados por cada lado
      for (const s of sets) {
        const [ga, gb] = parseSet(s);
        A.GF += ga; A.GC += gb;
        B.GF += gb; B.GC += ga;
        if (ga > gb) sa++; else if (gb > ga) sb++;
      }
      A.SF += sa; A.SC += sb;
      B.SF += sb; B.SC += sa;
    }

    // Puntos de tabla
    if (isDraw) {
      A.E++; B.E++;
      A.PTS += cfg.draw; B.PTS += cfg.draw;
    } else if (winnerSide === 'a') {
      A.G++; B.P++;
      A.PTS += cfg.win;  B.PTS += cfg.loss;
    } else if (winnerSide === 'b') {
      B.G++; A.P++;
      B.PTS += cfg.win;  A.PTS += cfg.loss;
    }
  }

  // Orden: PTS desc, (GF-GC) desc, GF desc, G desc
  const arr = Array.from(rows.values());
  arr.sort((x, y) => {
    if (y.PTS !== x.PTS) return y.PTS - x.PTS;
    const dx = (x.GF - x.GC), dy = (y.GF - y.GC);
    if (dy !== dx) return dy - dx;
    if (y.GF !== x.GF) return y.GF - x.GF;
    if (y.G !== x.G)   return y.G   - x.G;
    return String(x.alumnoId).localeCompare(String(y.alumnoId));
  });

  return arr;
}



function TablaGrupo({ torneo, gid, labelEntrada }) {
  const rows = React.useMemo(() => computeTablaGrupo(torneo, gid), [torneo, gid]);

  if (!rows.length) {
    return <div className="text-sm text-slate-500">A√∫n sin posiciones.</div>;
  }

  // Resuelve un nombre ‚Äúbonito‚Äù aunque el id sea team_*
  const resolveName = (id) => {
    try {
      const ent = findEntry(id, torneo);
      // 1) Intento principal
      let s = typeof labelEntrada === "function"
        ? labelEntrada(ent, torneo)
        : (ent?.label || id);

      // 2) Si qued√≥ como team_* o vac√≠o, intento armarlo con miembros del team
      if (!s || /^team_/i.test(String(s))) {
        const team = (torneo.teams || []).find(t => t.id === (ent?.id || id));
        if (team?.members?.length) {
          const names = team.members.map(mid => {
            const me = findEntry(mid, torneo);
            return (typeof labelEntrada === "function"
              ? labelEntrada(me, torneo)
              : (me?.label || String(mid)));
          }).filter(Boolean);
          if (names.length) s = names.join(" / ");
        }
      }
      return String(s);
    } catch {
      return String(id);
    }
  };

  return (
    <div className="overflow-x-auto">
      <table className="min-w-full text-sm">
        <thead className="sticky top-0 bg-white">
          <tr className="text-left text-slate-600">
            <th className="p-2">#</th>
            <th className="p-2">Jugador</th>
            <th className="p-2">PJ</th>
            <th className="p-2">G</th>
            <th className="p-2">P</th>
            <th className="p-2">GF</th>
            <th className="p-2">GC</th>
            <th className="p-2">PTS</th>
          </tr>
        </thead>
        <tbody>
          {rows.map((r, i) => (
            <tr key={r.id || i} className={i % 2 ? "bg-slate-50" : "bg-white"}>
              <td className="p-2">{i + 1}</td>
              <td className="p-2">{resolveName(r.alumnoId || r.id)}</td>
              <td className="p-2">{r.PJ}</td>
              <td className="p-2">{r.G}</td>
              <td className="p-2">{r.P}</td>
              <td className="p-2">{r.GF}</td>
              <td className="p-2">{r.GC}</td>
              <td className="p-2 font-semibold">{r.PTS}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}


function EstructuraTab({
  torneo,
  setGruposCount,
  setIdaVuelta,
  setTopK,
  onGenerarGrupos,
  onGenerarCuadro,
  onSiguientePaso,
  onIrFaseFinal,
  labelEntrada,   // << se usa para nombres
  locked
}) {
  // Fallback de etiqueta por si no llega labelEntrada
  const labelFallback = React.useCallback((entry) => {
    try {
      if (!entry) return "‚Äî";
      // singles: entry es id
      if (torneo.modalidad !== "dobles") {
        const a = (window.alumnos || []).find(x => x.id === (entry.id || entry)) || {};
        return `${a.apellido ? a.apellido + ", " : ""}${a.nombre || a.name || a.id || "‚Äî"}`.trim();
      }
      // dobles: entry es {id} o id; busco team
      const teamId = typeof entry === "string" ? entry : entry.id;
      const team = (torneo.teams || []).find(tt => tt.id === teamId) || entry;
      if (!team || !team.members) return String(teamId || "‚Äî");
      const [id1, id2] = team.members;
      const fmt = (id) => {
        const a = (window.alumnos || []).find(x => x.id === id) || {};
        return `${a.apellido ? a.apellido + ", " : ""}${a.nombre || a.name || a.id || ""}`.trim();
      };
      const la = fmt(id1), lb = fmt(id2);
      return (la && lb) ? `${la} / ${lb}` : (la || lb || "‚Äî");
    } catch {
      return "‚Äî";
    }
  }, [torneo]);

  const _labelEntrada = React.useCallback(
    (e) => (typeof labelEntrada === "function" ? labelEntrada(e) : labelFallback(e)),
    [labelEntrada, labelFallback]
  );

  const entradasCount =
    torneo.modalidad === "dobles"
      ? (torneo.teams || []).length
      : (torneo.participantes || []).length;

  const tieneGrupos = torneo.formato !== "eliminacion";
  const tieneKO = torneo.formato !== "grupos";

  const canG =
    tieneGrupos &&
    !locked &&
    entradasCount >= 2 &&
    (torneo.gruposCount || 0) >= 1;

  const pending = countPendingGroupMatches(torneo);
  const groupsDone = groupsAllMatchesDone(torneo);
  const canNext =
    tieneKO &&
    torneo.formato === "grupos_y_eliminacion" &&
    groupsDone;

    const fixtureListo = !!torneo.fixture && Object.keys(torneo.fixture || {}).length > 0;

  return (
    <div className="grid gap-6">
      {tieneGrupos && (
        <div className="border rounded-xl p-3 grid md:grid-cols-3 gap-3 items-end">
          <NumberField
            label="# de grupos"
            value={torneo.gruposCount || 2}
            onChange={(v) => setGruposCount(v)}
            min={1}
            disabled={locked}
          />
          <ToggleField
            label="Ida y vuelta"
            checked={!!torneo.idaVuelta}
            onChange={setIdaVuelta}
            disabled={locked}
          />
          <button
            className={`px-3 py-2 rounded-xl ${canG ? "bg-[#34745B] text-white" : "border"}`}
            onClick={() => { if (canG) onGenerarGrupos && onGenerarGrupos(); }}
            disabled={!canG}
            title={locked ? "Bloqueado por PIN" : ""}
          >
            Generar grupos y fixture
          </button>
          <div className="md:col-span-3 text-xs text-slate-500">
            Entradas: {entradasCount} {locked && "¬∑ (Bloqueado)"}
          </div>
        </div>
      )}

      {tieneKO && torneo.formato === "grupos_y_eliminacion" && (
        <div className="border rounded-xl p-3 grid md:grid-cols-3 gap-3 items-end">
          <NumberField
            label="Top-K desde grupos"
            value={torneo.topK || 2}
            onChange={v => setTopK(v)}
            min={1}
            disabled={locked}
          />
          <div className="md:col-span-2" />
          <button
            className={`px-3 py-2 rounded-xl ${canNext ? "bg-[#34745B] text-white" : "border"}`}
            onClick={() => { if (canNext) onSiguientePaso && onSiguientePaso(); }}
            disabled={!canNext}
            title={!canNext ? "Gener√° grupos y carg√° TODOS los resultados primero" : ""}
          >
            Siguiente paso a Fase final (PIN de PERFIL)
          </button>

          <div className="md:col-span-3 text-xs text-slate-500">
            {groupsDone ? "Todos los partidos de grupos est√°n cargados." : `Faltan ${pending} partido(s) de grupos por cargar.`}
          </div>
        </div>
      )}

      {torneo.formato === "eliminacion" && (
        <div className="border rounded-xl p-3 grid md:grid-cols-3 gap-3 items-end">
          {!torneo.cuadro ? (
            <>
              <div className="md:col-span-2 text-sm text-slate-600">
                Gener√° el cuadro de eliminaci√≥n directa con las parejas/participantes cargados.
              </div>
              <button
                className={`px-3 py-2 rounded-xl ${!locked &&
                  ((torneo.modalidad === "dobles" ? (torneo.teams || []).length : (torneo.participantes || []).length) >= 2)
                  ? "bg-[#34745B] text-white" : "border"}`}
                onClick={() => onGenerarCuadro && onGenerarCuadro()}
                disabled={locked}
                title={locked ? "Bloqueado por PIN" : ""}
              >
                Generar cuadro de eliminaci√≥n
              </button>
            </>
          ) : (
            <>
              <div className="md:col-span-2 text-sm text-slate-600">
                Los resultados de eliminaci√≥n directa se cargan en la pesta√±a <b>Fase final</b>.
              </div>
              <button className="px-3 py-2 rounded-xl border" onClick={() => onIrFaseFinal && onIrFaseFinal()}>
                Ir a Fase final
              </button>
            </>
          )}
        </div>
      )}

      {fixtureListo && (
  <div className="border rounded-xl p-3">
    <div className="font-semibold mb-2">Vista previa de grupos</div>
    <div className="grid md:grid-cols-2 gap-4">
      {torneo.grupos.map((g) => (
        <div key={g.id} className="border rounded-xl p-2">
          <div className="font-medium">{g.nombre}</div>
          <ul className="list-disc pl-5 text-sm text-slate-700">
            {(g.entradas || []).map((e) => (
              <li key={typeof e === "string" ? e : (e?.id || Math.random())}>
                {labelEntrada(findEntry(e, torneo))}
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  </div>
)}


      {!!torneo.cuadro && (
        <div className="border rounded-xl p-3">
          <div className="font-semibold mb-2">Vista previa de cuadro</div>
          <BracketViewSVG
  cuadro={torneo.cuadro}
  labelEntrada={(id)=>labelEntrada(findEntry(id, torneo))}
  resumenMarcador={resumenMarcador /* o safeResumen si us√°s ese */}
  onMatchClick={(m) => setEdit(edit === (m?.id ?? m) ? null : (m?.id ?? m))}
  layout={{ colW: 300, rowGap: 130, boxW: 360, boxH: 68 }}  // <- si lo usabas
/>
        </div>
      )}
    </div>
  );
}

function ProgramacionEditor({ initial = {}, onSave, onCancel }) {
  const [fecha, setFecha]   = React.useState(initial.fecha  || "");
  const [hora, setHora]     = React.useState(initial.hora   || "");
  const [cancha, setCancha] = React.useState(initial.cancha || "");
  const [sede, setSede]     = React.useState(initial.sede   || initial.club || "");

  const save = () => onSave({
    fecha:  fecha  || null,
    hora:   hora   || null,
    cancha: cancha || null,
    sede:   sede   || null,
  });

  return (
    <div className="grid grid-cols-1 sm:grid-cols-6 gap-2 text-xs mt-2">
      <input
        type="date"
        className="border rounded-lg px-2 py-1 sm:col-span-2"
        value={fecha}
        onChange={e => setFecha(e.target.value)}
      />
      <input
        type="time"
        className="border rounded-lg px-2 py-1 sm:col-span-1"
        value={hora}
        onChange={e => setHora(e.target.value)}
      />
      <input
        type="text"
        placeholder="Cancha"
        className="border rounded-lg px-2 py-1 sm:col-span-1"
        value={cancha}
        onChange={e => setCancha(e.target.value)}
      />
      <input
        type="text"
        placeholder="Club"
        className="border rounded-lg px-2 py-1 sm:col-span-2"
        value={sede}
        onChange={e => setSede(e.target.value)}
      />

      <div className="flex gap-2 sm:col-span-6">
        <button className="px-2 py-1 rounded-lg border" onClick={onCancel}>Cancelar</button>
        <button className="px-2 py-1 rounded-lg bg-[#34745B] text-white" onClick={save}>Guardar</button>
      </div>
    </div>
  );
}


function PartidosTab({ torneo, onChange, labelEntrada, perfil, clubActivoId, user }) {
  // Estados para controlar qu√© partido se est√° editando (resultado o programaci√≥n)
  const [editingMatchId, setEditingMatchId] = React.useState(null); 
  const [progEdit, setProgEdit] = React.useState(null);

  // --- Helpers ---

  // Formatea la informaci√≥n de programaci√≥n de un partido para mostrarla.
  const fmtProg = (m) => {
    const p = m?.programacion || {};
    const fecha  = p.fecha  ?? m.fecha  ?? null;
    const hora   = p.hora   ?? m.hora   ?? null;
    const cancha = p.cancha ?? m.cancha ?? null;
    const sede   = p.sede   ?? m.sede   ?? m.club ?? null;
    const fmtF = (iso) => iso ? iso.split('-').reverse().join('/') : null;
    const partes = [];
    if (fecha || hora) partes.push(`${fecha ? fmtF(fecha) : ''}${fecha && hora ? ' ' : ''}${hora ? `${hora} hs` : ''}`.trim());
    if (cancha) partes.push(`Cancha: ${cancha}`);
    if (sede)   partes.push(`Club: ${sede}`);
    return partes.join(' ¬∑ ');
  };

  // Obtiene un partido espec√≠fico de un grupo.
  const getMatch = (gid, mid) => {
    if (!torneo || !torneo.fixture || !torneo.fixture[gid]) return null;
    const partidosDelGrupo = torneo.fixture[gid] || [];
    return partidosDelGrupo.find(match => match.id === mid) || null;
  };

  // Obtiene la etiqueta de un jugador o pareja.
  const sideLabel = (id) => {
    try { return labelEntrada(findEntry(id, torneo)); }
    catch { return String(id || '‚Äî'); }
  };

  // Verifica si un partido ya se jug√≥.
  const isPlayed = (m) =>
    !!m && (m.done || m?.result?.done || m?.result?.wo || m?.wo || m?.woWinner || m?.winner != null || m?.result?.winner != null);

  // Genera un resumen del resultado del partido.
  const safeResumen = (m) => {
    if (!m) return "Sin resultado";
    const wo = m?.result?.wo || m?.wo || m?.woWinner || null;
    if (wo === 'a' || wo === 'b') {
      const ganador = wo === 'a' ? sideLabel(m.a) : sideLabel(m.b);
      return `WO ${ganador}`;
    }
    return typeof resumenMarcador === 'function' ? resumenMarcador(m) : (isPlayed(m) ? 'OK' : 'Sin resultado');
  };

  // --- Funciones de guardado ---

  const guardarResultadoGrupo = async (gid, mid, result) => {
    const t = deepClone(torneo);
    const fixtureGrupo = t.fixture?.[gid] || [];
    const matchOriginal = fixtureGrupo.find(match => match.id === mid);
    if (!matchOriginal) return;

    const esWO = result?.wo === 'a' || result?.wo === 'b';
    const esEmpate = !!(result?.draw || result?.empate || result?.winner === 'draw');
    const winnerSide = esWO ? result.wo : (result?.winner === 'a' || result?.winner === 'b') ? result.winner : null;

    // Actualiza el fixture del torneo
    const patchedMatch = { ...matchOriginal, result, done: !!result?.done || esWO || !!winnerSide || esEmpate, winner: winnerSide ?? (esEmpate ? null : matchOriginal.winner) };
    t.fixture[gid] = fixtureGrupo.map(mm => (mm.id === mid ? patchedMatch : mm));
    
    // --- INICIO DE LA L√ìGICA DE RANKING ACTUALIZADA ---
    const rankingId = torneo?.rankingId || null;
    if (rankingId && typeof updateRankingPuntosEn === 'function' && typeof expandEntryToAlumnoIds === 'function') {
        const reglas = torneo?.reglas?.grupos?.puntos || {};
        const ptsWin  = Number(reglas.win  ?? 3);
        const ptsLoss = Number(reglas.loss ?? 0);
        const ptsDraw = Number(reglas.draw ?? 1);
        
        const promises = [];

        if (esEmpate) {
            const idsA = expandEntryToAlumnoIds(matchOriginal.a, torneo);
            const idsB = expandEntryToAlumnoIds(matchOriginal.b, torneo);
            
            idsA.forEach(jugadorId => {
              promises.push(updateRankingPuntosEn(clubActivoId, rankingId, jugadorId, ptsDraw, { pj: 1, pe: 1 }));
            });
            idsB.forEach(jugadorId => {
              promises.push(updateRankingPuntosEn(clubActivoId, rankingId, jugadorId, ptsDraw, { pj: 1, pe: 1 }));
            });

        } else if (winnerSide) {
            const winnerEntry = winnerSide === 'a' ? matchOriginal.a : matchOriginal.b;
            const loserEntry = winnerSide === 'a' ? matchOriginal.b : matchOriginal.a;

            const winnerIds = expandEntryToAlumnoIds(winnerEntry, torneo);
            const loserIds = expandEntryToAlumnoIds(loserEntry, torneo);

            winnerIds.forEach(jugadorId => {
              promises.push(updateRankingPuntosEn(clubActivoId, rankingId, jugadorId, ptsWin, { pj: 1, pg: 1, wo: esWO ? 1 : 0 }));
            });
            loserIds.forEach(jugadorId => {
              promises.push(updateRankingPuntosEn(clubActivoId, rankingId, jugadorId, ptsLoss, { pj: 1, pp: 1 }));
            });
        }
        
        // Ejecutamos todas las actualizaciones de ranking en paralelo
        await Promise.all(promises);
    }
    // --- FIN DE LA L√ìGICA DE RANKING ---

    onChange(t);
    setEditingMatchId(null);
  };

  const guardarProgramacionGrupo = (gid, mid, prog) => {
      const t = deepClone(torneo);
      const fixtureGrupo = t.fixture?.[gid] || [];
      t.fixture[gid] = fixtureGrupo.map(mm => (mm.id === mid ? { ...mm, programacion: prog, fecha: prog.fecha, hora: prog.hora, cancha: prog.cancha, sede: prog.sede } : mm));
      onChange(t);
      setProgEdit(null);
  };
  
  // L√≥gica para auto-generar fixture si falta
  React.useEffect(() => { /* Tu c√≥digo sin cambios aqu√≠ si lo ten√≠as */ }, [torneo.grupos, torneo.idaVuelta, onChange]);

  const gruposKeys = Object.keys(torneo.fixture || {});
  const hayGrupos = gruposKeys.length > 0;

  return (
    <div className="grid lg:grid-cols-[1fr,0px] gap-4">
      <div className="space-y-4">
        {!hayGrupos && (
          <div className="text-sm text-slate-500">No hay fixture generado.</div>
        )}

        {/* Tablas de posiciones */}
        {torneo.formato === 'grupos' && Array.isArray(torneo.grupos) && torneo.grupos.length > 0 && (
          <div className="border rounded-2xl p-3">
            <div className="font-semibold mb-2">Tablas de posiciones ‚Äî Liga</div>
            <div className="grid md:grid-cols-2 gap-4">
              {torneo.grupos.map((g) => (
                <div key={g.id} className="border rounded-xl p-2 bg-white">
                  <div className="font-medium mb-2">{g.nombre}</div>
                  <TablaGrupo torneo={torneo} gid={g.id} labelEntrada={labelEntrada} />
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Mapeo de partidos por grupo con edici√≥n en l√≠nea */}
        {gruposKeys.map((gid) => {
          const partidosPorRonda = React.useMemo(() => {
            const listaPlana = torneo.fixture[gid] || [];
            if (!Array.isArray(listaPlana)) return {};
            return listaPlana.reduce((acc, match) => {
              const rondaNum = match.round || 1;
              if (!acc[rondaNum]) acc[rondaNum] = [];
              acc[rondaNum].push(match);
              return acc;
            }, {});
          }, [torneo.fixture, gid]);

          const rondasKeys = Object.keys(partidosPorRonda).sort((a,b) => a - b);

          return (
            <div key={gid} className="border rounded-xl p-3">
              <div className="font-semibold mb-2">
                {torneo.grupos?.find(g => g.id === gid)?.nombre || `Grupo ${gid}`}
              </div>
              {rondasKeys.length === 0 ? (
                <div className="text-sm text-slate-500">Sin partidos generados.</div>
              ) : (
                rondasKeys.map(rondaNum => (
                  <div key={rondaNum} className="mt-4">
                    <h4 className="text-sm font-medium text-slate-600 mb-2 border-b pb-1">Ronda {rondaNum}</h4>
                    <div className="space-y-2">
                      {partidosPorRonda[rondaNum].map(m => {
                        const editable = !isBYE(m.a) && !isBYE(m.b);
                        
                        if (editingMatchId === m.id) {
                          return (
                            <div key={m.id} className="p-2 border-2 border-emerald-500 rounded-lg bg-white">
                              <div className="text-sm"><b>{sideLabel(m.a)}</b> vs <b>{sideLabel(m.b)}</b></div>
                              <InlineResultadoEditor match={m} aLabel={sideLabel(m.a)} bLabel={sideLabel(m.b)}
                                onSave={(result) => {
                                  guardarResultadoGrupo(gid, m.id, result);
                                  setEditingMatchId(null);
                                }}
                                onCancel={() => setEditingMatchId(null)}
                              />
                            </div>
                          );
                        }
                        
                        return (
                          <div key={m.id} className="border rounded-xl p-2 bg-white">
                            <div className="flex flex-wrap items-center justify-between gap-2 min-h-[56px]">
                              <div className="min-w-0">
                                <div className="text-sm font-medium leading-5 truncate max-w-[680px]">
                                  {sideLabel(m.a)} {" vs "} {sideLabel(m.b)}
                                </div>
                                <div className="text-xs text-slate-500 mt-0.5">
                                  üóìÔ∏è {fmtProg(m) || "Sin programaci√≥n"}
                                  <button
                                    className="ml-2 underline hover:no-underline"
                                    onClick={() => setProgEdit(progEdit === m.id ? null : m.id)}
                                  >
                                    {progEdit === m.id ? "cerrar" : (m.programacion ? 'editar' : 'programar')}
                                  </button>
                                </div>
                              </div>
                              
                              <div className="flex items-center gap-2 shrink-0">
                                <span className="text-xs text-slate-500">{safeResumen(m)}</span>
                                <button
                                  type="button"
                                  className="h-7 px-2 rounded-lg text-xs border border-slate-300 disabled:opacity-50"
                                  onClick={() => { if (editable && window.confirm(`Confirmar WO: gana ${sideLabel(m.a)}.`)) guardarResultadoGrupo(gid, m.id, { wo: 'a', done: true }); }}
                                  disabled={!editable}
                                  title={`WO para ${sideLabel(m.a)}`}
                                >
                                  WO {sideLabel(m.a)}
                                </button>
                                <button
                                  type="button"
                                  className="h-7 px-2 rounded-lg text-xs border border-slate-300 disabled:opacity-50"
                                  onClick={() => { if (editable && window.confirm(`Confirmar WO: gana ${sideLabel(m.b)}.`)) guardarResultadoGrupo(gid, m.id, { wo: 'b', done: true }); }}
                                  disabled={!editable}
                                  title={`WO para ${sideLabel(m.b)}`}
                                >
                                  WO {sideLabel(m.b)}
                                </button>
                                <button
                                  className={`h-7 px-3 rounded-lg text-xs disabled:opacity-50 ${isPlayed(m) ? 'bg-emerald-600 text-white hover:bg-emerald-700' : 'bg-slate-800 text-white hover:bg-slate-900'}`}
                                  onClick={() => editable && setEditingMatchId(m.id)}
                                  disabled={!editable}
                                >
                                  {isPlayed(m) ? "Editar" : "Cargar"}
                                </button>
                              </div>
                            </div>
                          
                            {progEdit === m.id && (
                              <div className="mt-2 pt-3 border-t">
                                <ProgramacionEditor
                                  initial={m.programacion || { fecha: m.fecha, hora: m.hora, cancha: m.cancha, sede: m.sede || m.club }}
                                  onCancel={() => setProgEdit(null)}
                                  onSave={(prog) => guardarProgramacionGrupo(gid, m.id, prog)}
                                />
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}


// === Info de la final (campe√≥n / subcampe√≥n) ===
function bracketFinalInfo(cuadro){
  if (!cuadro) return null;
  const rounds = Object.keys(cuadro).map(n => Number(n)).sort((a,b)=>a-b);
  if (!rounds.length) return null;
  const last = String(rounds[rounds.length-1]);
  const finalMatch = (cuadro[last] || [])[0];
  if (!finalMatch) return { done:false, round:last, match:null };

  if (!finalMatch.done || !finalMatch.result || !finalMatch.result.winner) {
    return { done:false, round:last, match:finalMatch };
  }
  const champion = finalMatch.result.winner === 'a' ? finalMatch.a : finalMatch.b;
  const runnerUp = finalMatch.result.winner === 'a' ? finalMatch.b : finalMatch.a;
  return { done:true, round:last, match:finalMatch, champion, runnerUp };
}

function InlineResultadoEditor({ match, onSave, onCancel, aLabel, bLabel }) {
  // Inicializamos los sets desde el resultado existente o vac√≠os
  const initialSets = React.useMemo(() => {
    const s = Array.isArray(match?.result?.sets) ? match.result.sets : [];
    const toStr = (x) => (Number.isFinite(Number(x)) ? String(Number(x)) : "");
    return [
      { a: toStr(s[0]?.a), b: toStr(s[0]?.b) },
      { a: toStr(s[1]?.a), b: toStr(s[1]?.b) },
      { a: toStr(s[2]?.a), b: toStr(s[2]?.b) },
    ];
  }, [match]);

  const [sets, setSets] = React.useState(initialSets);

  const setSetVal = (i, side, val) => {
    setSets(prev => {
      const next = [...prev];
      const clean = val === "" ? "" : Math.max(0, parseInt(val, 10));
      next[i] = { ...next[i], [side]: String(clean) };
      return next;
    });
  };

  const computeWinnerFromSets = (arr) => {
    let winA = 0, winB = 0;
    arr.forEach(s => {
      const a = Number(s.a), b = Number(s.b);
      if (Number.isFinite(a) && Number.isFinite(b) && a !== b) {
        if (a > b) winA++;
        else winB++;
      }
    });
    if (winA > winB) return 'a';
    if (winB > winA) return 'b';
    return 'draw'; // O null si prefieres que no haya empates
  };

  const handleSave = () => {
    const filled = sets.filter(s => s.a !== "" && s.b !== "");
    if (filled.length === 0) {
      alert("Carga al menos un set con ambos resultados.");
      return;
    }
    const norm = filled.map(s => ({ a: Number(s.a), b: Number(s.b) }));
    const winner = computeWinnerFromSets(norm);
    if (winner === 'draw') {
        alert("El resultado no puede ser un empate. Por favor, ingresa el resultado del set o tie-break decisivo para desempatar.");
        return;
    }

    onSave({ sets: norm, winner, done: true });
};

  return (
    <div className="p-3 bg-slate-50 border rounded-lg mt-2 space-y-3">
      <div className="grid grid-cols-3 gap-3">
        {[0, 1, 2].map(i => (
          <div key={i}>
            <label className="text-xs text-slate-500 mb-1 block">Set {i + 1}</label>
            <div className="flex items-center gap-2">
              <input type="number" min="0" value={sets[i].a} onChange={e => setSetVal(i, 'a', e.target.value)} className="w-full border rounded-md px-2 py-1 text-center" placeholder={aLabel} />
              <span>-</span>
              <input type="number" min="0" value={sets[i].b} onChange={e => setSetVal(i, 'b', e.target.value)} className="w-full border rounded-md px-2 py-1 text-center" placeholder={bLabel} />
            </div>
          </div>
        ))}
      </div>
      <div className="flex justify-end gap-2 border-t pt-3">
        <button onClick={onCancel} className="px-3 py-1.5 text-sm rounded-lg border hover:bg-slate-100">Cancelar</button>
        <button onClick={handleSave} className="px-3 py-1.5 text-sm rounded-lg bg-[#34745B] text-white hover:bg-green-800">Guardar Resultado</button>
      </div>
    </div>
  );
}

function FaseFinalTab({ torneo, onChange, labelEntrada, onGenerarCuadro, clubActivoId, user, perfil }) {
  const [editingMatchId, setEditingMatchId] = React.useState(null);
  const [progEdit, setProgEdit] = React.useState(null);
  const [showBracket, setShowBracket] = React.useState(true);
  
  // Estado para controlar el modal de PIN
  const [isPinModalOpen, setIsPinModalOpen] = React.useState(false);

  const koHasResults = React.useMemo(() => hasKOResults(torneo.cuadro), [torneo.cuadro]);
  const finalInfo = React.useMemo(() => bracketFinalInfo(torneo.cuadro), [torneo.cuadro]);

  // Funciones para finalizar y reabrir el torneo
  const handleFinalizarTorneo = () => {
    if (!finalInfo?.done) {
      if (!window.confirm("El torneo a√∫n no tiene un ganador registrado en la fase final. ¬øEst√°s seguro de que quieres marcarlo como finalizado de todas formas?")) {
        return;
      }
    } else {
      if (!window.confirm("¬øEst√°s seguro de que quieres marcar este torneo como finalizado? Se bloquear√° la edici√≥n.")) {
        return;
      }
    }
    onChange({ ...torneo, estado: 'finalizado' });
  };
  
  const handleReabrirTorneo = () => {
    // Esta funci√≥n se ejecuta si el PIN es correcto
    onChange({ ...torneo, estado: 'en_juego' });
    setIsPinModalOpen(false); // Cierra el modal despu√©s de la acci√≥n
  };
  
  // --- Tus funciones existentes (regenerar, exportar, guardar, etc.) ---

  const regenerarDesdeTabla = () => {
    if (koHasResults && !window.confirm("Ya hay resultados en KO. Regenerar borrar√° esos resultados. ¬øContinuar?")) return;

    let ids = [];
    if (torneo.formato === "eliminacion") {
      ids = torneo.modalidad === "dobles"
        ? (torneo.teams || []).map(t => t.id)
        : (torneo.participantes || []);
    } else {
      const faltan = countPendingGroupMatches(torneo);
      if (faltan > 0) {
        window.alert(`Faltan ${faltan} partido(s) de grupos. Carg√° esos resultados antes de armar la fase final.`);
        return;
      }
      const K = Math.max(1, parseInt(torneo.topK || 2, 10));
      ids = computeQualifiers(torneo, K);
    }

    const clean = Array.from(new Set((ids || []).filter(Boolean)));
    if (clean.length < 2) {
      window.alert("Se necesitan al menos 2 participantes o clasificados.");
      return;
    }

    const cuadro = buildBracket(clean, { seeding: torneo?.reglas?.ko?.seeding || 'serpentina' });
    onChange({ ...torneo, cuadro });
  };

  async function exportarPDFTorneoPro(torneo) {
      // (Aqu√≠ va tu funci√≥n completa para exportar a PDF, sin cambios)
  };

  const sideLabel = (side) => (!side || side?.BYE) ? "‚Äî" : labelEntrada(findEntry(side, torneo));
  const isPlayed = (m) => !!m && (m.done || m?.result?.done || m?.result?.wo || m?.wo || m?.woWinner || m?.winner != null || m?.result?.winner != null);

  const safeResumen = (m) => {
    if (!m) return "Sin resultado";
    const wo = m?.result?.wo || m?.wo || m?.woWinner || null;
    if (wo === 'a' || wo === 'b') {
      const ganador = wo === 'a' ? sideLabel(m.a) : sideLabel(m.b);
      return `WO ${ganador}`;
    }
    if (typeof resumenMarcador === 'function') return resumenMarcador(m);
    return isPlayed(m) ? 'OK' : 'Sin resultado';
  };

  const matchById = React.useCallback((id) => {
    for (const arr of Object.values(torneo.cuadro || {})) {
      const found = (arr || []).find(mm => mm.id === id);
      if (found) return found;
    }
    return null;
  }, [torneo.cuadro]);

  const guardar = async (matchId, result) => {
    const matchOriginal = matchById(matchId);
    if (!matchOriginal) return;

    const esWO = result?.wo === 'a' || result?.wo === 'b';
    const winnerSide = esWO ? result.wo : (result?.winner === 'a' || result?.winner === 'b') ? result.winner : null;
    
    const nuevo = applyResultToBracket(deepClone(torneo), matchId, result);

    const rankingId = torneo?.rankingId || null;
    if (rankingId && typeof updateRankingPuntosEn === 'function' && winnerSide) {
        const winnerId = winnerSide === 'a' ? matchOriginal.a : matchOriginal.b;
        const loserId  = winnerSide === 'a' ? matchOriginal.b : matchOriginal.a;
        const reglas = torneo?.reglas?.grupos?.puntos || {};
        const ptsWin  = Number(reglas.win  ?? 3);
        const ptsLoss = Number(reglas.loss ?? 0);
        if (winnerId && loserId) {
            await Promise.all([
                updateRankingPuntosEn(clubActivoId, rankingId, winnerId, ptsWin,  { pj: 1, pg: 1, wo: esWO ? 1 : 0 }),
                updateRankingPuntosEn(clubActivoId, rankingId, loserId,  ptsLoss, { pj: 1, pp: 1 }),
            ]);
        }
    }
    
    onChange(nuevo);
    setEditingMatchId(null);

    const info = bracketFinalInfo(nuevo.cuadro);
    if (info?.done) {
      const champ = labelEntrada(findEntry(info.champion, nuevo));
      const sub = labelEntrada(findEntry(info.runnerUp, nuevo));
      window.alert(`¬°Fin del torneo!\nüèÜ Campe√≥n: ${champ}\nü•à Subcampe√≥n: ${sub}`);
    }
  };

  const formatDate = (iso) => {
    if (!iso) return null;
    const [y, m, d] = iso.split("-").map(Number);
    if (!y || !m || !d) return iso;
    return `${String(d).padStart(2, "0")}/${String(m).padStart(2, "0")}/${y}`;
  };

  const fmtProg = (m) => {
    const p = m?.programacion || {};
    const fecha = p.fecha ?? m.fecha ?? null;
    const hora = p.hora ?? m.hora ?? null;
    const cancha = p.cancha ?? m.cancha ?? null;
    const sede = p.sede ?? m.sede ?? m.club ?? null;
    const partes = [];
    if (fecha || hora) {
      const fh = `${fecha ? formatDate(fecha) : ""}${fecha && hora ? " " : ""}${hora ? `${hora} hs` : ""}`.trim();
      if (fh) partes.push(fh);
    }
    if (cancha) partes.push(`Cancha: ${cancha}`);
    if (sede) partes.push(`Club: ${sede}`);
    return partes.join(" ¬∑ ");
  };

  const guardarProgramacion = (matchId, prog) => {
    const t = deepClone(torneo);
    Object.keys(t.cuadro || {}).forEach(k => {
      t.cuadro[k] = (t.cuadro[k] || []).map(mm =>
        mm.id === matchId
          ? { ...mm, programacion: prog, fecha: prog.fecha, hora: prog.hora, cancha: prog.cancha, sede: prog.sede }
          : mm
      );
    });
    onChange(t);
    setProgEdit(null);
  };
  
  const nombreRondaPorPartidos = (n) => {
    const map = { 1: "Final", 2: "Semifinales", 4: "Cuartos de final", 8: "Octavos de final", 16: "Dieciseisavos", 32: "Treintaidosavos" };
    return map[n] || `Ronda (${n} partido${n !== 1 ? "s" : ""})`;
  };

  return (
    <div className="grid gap-4">
      {/* Toolbar con los nuevos botones */}

<div className="flex items-center justify-between gap-2 flex-wrap p-3 border rounded-xl bg-slate-50">
  <div className="flex items-center gap-2">
    <div className="text-lg font-semibold">Fase final</div>
    <button className="px-3 py-1.5 rounded-lg border bg-white" onClick={() => setShowBracket(s => !s)}>
      {showBracket ? "Ver lista" : "Ver llaves"}
    </button>
  </div>
  <div className="flex items-center gap-2">
    {torneo.estado === 'finalizado' ? (
      <>
        <button 
          className="px-3 py-1.5 rounded-lg bg-blue-600 text-white font-semibold disabled:bg-slate-400 disabled:cursor-not-allowed"
          // --- L√çNEA CORREGIDA ---
          onClick={() => applyAwardsToRanking({ user, clubId: clubActivoId, torneo })}
          disabled={!torneo.rankingId}
          title={!torneo.rankingId ? "Primero selecciona un ranking de destino en la pesta√±a Reglas" : "Aplica los puntos de este torneo al ranking asociado"}
        >
          Aplicar Puntos al Ranking
        </button>
        <button 
          className="px-3 py-1.5 rounded-lg bg-amber-500 text-white font-semibold"
          onClick={() => setIsPinModalOpen(true)}
        >
          Reabrir (PIN)
        </button>
      </>
    ) : (
      <button 
        className="px-3 py-1.5 rounded-lg bg-red-600 text-white font-semibold"
        onClick={handleFinalizarTorneo}
      >
        Marcar como Finalizado
      </button>
    )}
    <button className="px-3 py-1.5 rounded-lg border" onClick={regenerarDesdeTabla}>Regenerar</button>
  </div>
</div>


      {/* Campe√≥n/Subcampe√≥n */}
      {finalInfo?.done && (
        <div className="p-3 rounded-xl bg-emerald-50 border border-emerald-300">
          <div className="font-semibold">üèÜ Campe√≥n: {labelEntrada(findEntry(finalInfo.champion, torneo))}</div>
          <div className="text-sm">ü•à Subcampe√≥n: {labelEntrada(findEntry(finalInfo.runnerUp, torneo))}</div>
        </div>
      )}

      {/* Tablas de posiciones (si hay grupos) */}
      {torneo.formato !== 'eliminacion' && Array.isArray(torneo.grupos) && torneo.grupos.length > 0 && (
        <div className="border rounded-2xl p-3">
          <div className="font-semibold mb-2">Tablas de posiciones ‚Äî Grupos</div>
          <div className="grid md:grid-cols-2 gap-4">
            {torneo.grupos.map((g) => (
              <div key={g.id} className="border rounded-xl p-2 bg-white">
                <div className="font-medium mb-2">{g.nombre}</div>
                <TablaGrupo torneo={torneo} gid={g.id} labelEntrada={labelEntrada} />
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Vista principal: llaves / lista */}
      <div className="grid lg:grid-cols-[1fr,320px] gap-4">
        <div className="border rounded-2xl p-3">
          {showBracket ? (
            <BracketViewSVG
              cuadro={torneo.cuadro}
              labelEntrada={(id) => labelEntrada(findEntry(id, torneo))}
              resumenMarcador={safeResumen}
              onMatchClick={(m) => setEditingMatchId(editingMatchId === m.id ? null : m.id)}
              layout={{ colW: 300, rowGap: 130, boxW: 360, boxH: 68 }}
            />
          ) : (
            Object.entries(torneo.cuadro || {})
              .sort((a, b) => (b[1]?.length || 0) - (a[1]?.length || 0))
              .map(([rk, matches]) => {
                const rondaName = nombreRondaPorPartidos((matches || []).length);
                return (
                  <div key={rk} className="border rounded-xl p-3 mb-3">
                    <div className="font-semibold">{rondaName}</div>
                    <div className="space-y-2 mt-2">
                      {(matches || []).map((m) => {
                        const byeA = !!(m?.a && m.a.BYE), byeB = !!(m?.b && m.b.BYE);
                        const editable = !byeA && !byeB;
                        
                        if (editingMatchId === m.id) {
                          return (
                            <div key={m.id} className="p-2 border-2 border-emerald-500 rounded-lg bg-white">
                              <div className="text-sm"><b>{sideLabel(m.a)}</b> vs <b>{sideLabel(m.b)}</b></div>
                              <InlineResultadoEditor
                                match={m}
                                aLabel={sideLabel(m.a)}
                                bLabel={sideLabel(m.b)}
                                onSave={(result) => guardar(m.id, result)}
                                onCancel={() => setEditingMatchId(null)}
                              />
                            </div>
                          );
                        }

                        return (
                          <div key={m.id} className="border rounded-xl p-2">
                            <div className="flex flex-wrap items-center justify-between gap-2 min-h-[56px]">
                              <div className="min-w-0">
                                <div className="text-sm font-medium leading-5 truncate max-w-[680px]">
                                  {sideLabel(m.a)} {" vs "} {sideLabel(m.b)}
                                </div>
                                <div className="text-xs text-slate-500 mt-0.5">
                                  üóìÔ∏è {fmtProg(m) || "Sin programaci√≥n"}
                                  <button
                                    className="ml-2 underline hover:no-underline"
                                    onClick={() => setProgEdit(progEdit === m.id ? null : m.id)}
                                  >
                                    {progEdit === m.id ? "cerrar" : "programar"}
                                  </button>
                                </div>
                              </div>
                              <div className="flex items-center gap-2 shrink-0">
                                <span className="text-xs text-slate-500">{safeResumen(m)}</span>
                                <button
                                  type="button"
                                  className="h-7 px-2 rounded-lg text-xs border border-slate-300 disabled:opacity-50"
                                  onClick={() => { if (editable && window.confirm(`Confirmar WO: gana ${sideLabel(m.a)}.`)) guardar(m.id, { wo: 'a', done: true }); }}
                                  disabled={!editable}
                                  title={`WO para ${sideLabel(m.a)}`}
                                >
                                  WO {sideLabel(m.a)}
                                </button>
                                <button
                                  type="button"
                                  className="h-7 px-2 rounded-lg text-xs border border-slate-300 disabled:opacity-50"
                                  onClick={() => { if (editable && window.confirm(`Confirmar WO: gana ${sideLabel(m.b)}.`)) guardar(m.id, { wo: 'b', done: true }); }}
                                  disabled={!editable}
                                  title={`WO para ${sideLabel(m.b)}`}
                                >
                                  WO {sideLabel(m.b)}
                                </button>
                                <button
                                  className={`h-7 px-3 rounded-lg text-xs disabled:opacity-50 ${isPlayed(m) ? 'bg-emerald-600 text-white hover:bg-emerald-700' : 'bg-slate-800 text-white hover:bg-slate-900'}`}
                                  onClick={() => editable && setEditingMatchId(m.id)}
                                  disabled={!editable}
                                >
                                  {isPlayed(m) ? "Editar" : "Cargar"}
                                </button>
                              </div>
                            </div>
                            {progEdit === m.id && (
                              <ProgramacionEditor
                                initial={m.programacion || { fecha: m.fecha, hora: m.hora, cancha: m.cancha, sede: m.sede || m.club }}
                                onCancel={() => setProgEdit(null)}
                                onSave={(prog) => guardarProgramacion(m.id, prog)}
                              />
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })
          )}
        </div>

        <aside className="lg:sticky lg:top-2 self-start border rounded-2xl p-3 bg-slate-50">
          {/* ... (el contenido del aside se mantiene igual) ... */}
        </aside>
      </div>

      {/* Modal de confirmaci√≥n con PIN */}
      <PinConfirmModal
        isOpen={isPinModalOpen}
        onClose={() => setIsPinModalOpen(false)}
        onConfirm={handleReabrirTorneo}
        perfil={perfil}
        title="Reabrir Torneo"
        message="Para desbloquear la edici√≥n de este torneo finalizado, por favor ingresa tu PIN de seguridad."
      />
    </div>
  );
}


// === Panel lateral derecha (drawer) ===
function RightDrawer({ open, title, onClose, children }) {
  return (
    <div className={cx(
      "fixed inset-0 z-[100]",
      open ? "pointer-events-auto" : "pointer-events-none"
    )}>
      {/* Fondo */}
      <div
        onClick={onClose}
        className={cx(
          "absolute inset-0 bg-black/30 transition-opacity",
          open ? "opacity-100" : "opacity-0"
        )}
      />
      {/* Panel */}
      <div
        className={cx(
          "absolute right-0 top-0 h-full w-full max-w-[520px] bg-white shadow-2xl",
          "transition-transform", open ? "translate-x-0" : "translate-x-full"
        )}
      >
        <div className="p-3 border-b flex items-center justify-between">
          <div className="font-semibold">{title}</div>
          <button onClick={onClose} className="px-2 py-1 rounded-lg border">Cerrar</button>
        </div>
        <div className="p-3 h-[calc(100%-48px)] overflow-y-auto">
          {children}
        </div>
      </div>
    </div>
  );
}


// ================== Componentes UI peque√±os ==================
function RadioItem({ checked, onChange, title, desc }) {
  return (
    <label className={cx('flex gap-3 items-start p-2 rounded-xl border cursor-pointer', checked ? 'border-slate-400 bg-white' : 'border-slate-200 hover:bg-slate-50')}>
      <input type="radio" className="mt-1" checked={!!checked} onChange={onChange} />
      <div>
        <div className="font-medium text-slate-800">{title}</div>
        {desc && <div className="text-xs text-slate-500">{desc}</div>}
      </div>
    </label>
  );
}
function NumberField({ label, value, onChange, min=0 }) {
  return (
    <label className="block">
      <div className="text-sm text-slate-600 mb-1">{label}</div>
      <input type="number" min={min} className="w-full border rounded-xl px-3 py-2" value={value ?? 0} onChange={e=>onChange(parseInt(e.target.value||0))} />
    </label>
  );
}
function SelectField({ label, value, onChange, options }) {
  return (
    <label className="block">
      <div className="text-sm text-slate-600 mb-1">{label}</div>
      <select className="w-full border rounded-xl px-3 py-2" value={value} onChange={e=>onChange(e.target.value)}>
        {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
      </select>
    </label>
  );
}
function ToggleField({ label, checked, onChange }) {
  return (
    <label className="flex items-center gap-2 text-sm">
      <input type="checkbox" checked={!!checked} onChange={e=>onChange(e.target.checked)} /> {label}
    </label>
  );
}
function SelectAlumno({ value, onChange, alumnos, placeholder }) {
  return (
    <select className="w-full border rounded-xl px-3 py-2" value={value} onChange={e=>onChange(e.target.value)}>
      <option value="">{placeholder}</option>
      {alumnos.sort((a,b)=> (a.apellido||'').localeCompare(b.apellido||'')).map(a => (
        <option key={a.id} value={a.id}>{(a.apellido? a.apellido + ', ' : '') + (a.nombre||a.name||'')}</option>
      ))}
    </select>
  );
}

// === Editor de resultado: 3 sets con A y B por set
function ResultadoEditor({ reglas, initial, onSave, onCancel, aLabel = "A", bLabel = "B" }) {
  // Modo: sets (3) vs WO
  const [mode, setMode] = React.useState(initial?.wo ? "wo" : "sets");

  // Sets: array de 3 objetos {a:"", b:""} en UI (strings para inputs)
  const initSets = (() => {
    const s = Array.isArray(initial?.sets) ? initial.sets : [];
    const toStr = (x) => (Number.isFinite(Number(x)) ? String(Number(x)) : "");
    return [
      { a: toStr(s[0]?.a), b: toStr(s[0]?.b) },
      { a: toStr(s[1]?.a), b: toStr(s[1]?.b) },
      { a: toStr(s[2]?.a), b: toStr(s[2]?.b) },
    ];
  })();
  const [sets, setSets] = React.useState(initSets);

  // WO winner
  const [woWinner, setWoWinner] = React.useState(initial?.wo || null);

  const setSetVal = (i, side, val) => {
    setSets(prev => {
      const next = prev.map(x => ({ ...x }));
      // S√≥lo n√∫meros >= 0 o vac√≠o
      const clean = val === "" ? "" : Math.max(0, Number(val));
      next[i][side] = (val === "" || Number.isFinite(clean)) ? String(val).replace(/^0+(\d)$/, "$1") : prev[i][side];
      return next;
    });
  };

  // Calcula ganador por sets ganados
  const computeWinnerFromSets = (arr) => {
    let winA = 0, winB = 0;
    arr.forEach(s => {
      const a = Number(s.a), b = Number(s.b);
      if (Number.isFinite(a) && Number.isFinite(b)) {
        if (a > b) winA++;
        else if (b > a) winB++;
      }
    });
    if (winA > winB) return 'a';
    if (winB > winA) return 'b';
    return 'draw';
  };

  const save = () => {
    if (mode === "wo") {
      if (woWinner !== "a" && woWinner !== "b") {
        alert("Eleg√≠ qui√©n gana por WO.");
        return;
      }
      onSave({ wo: woWinner, done: true });
      return;
    }

    // Validar que haya al menos 1 set con ambos lados cargados
    const filled = sets.filter(s => s.a !== "" && s.b !== "");
    if (filled.length === 0) {
      alert("Carg√° al menos un set con ambos lados.");
      return;
    }

    // Normalizar a n√∫meros (vac√≠os -> 0)
    const norm = sets.map(s => ({
      a: Number.isFinite(Number(s.a)) ? Number(s.a) : 0,
      b: Number.isFinite(Number(s.b)) ? Number(s.b) : 0,
    }));

    const winner = computeWinnerFromSets(norm);
    onSave({ sets: norm, winner, done: true });
  };

  const limpiar = () => {
    setSets([{a:"",b:""}, {a:"",b:""}, {a:"",b:""}]);
    setWoWinner(null);
    setMode("sets");
  };

  return (
    <div className="border rounded-xl p-3 space-y-3 bg-white">
      {/* Modo */}
      <div className="flex gap-4 text-sm">
        <label className="flex items-center gap-2 cursor-pointer">
          <input
            type="radio"
            name="modo-res"
            checked={mode === "sets"}
            onChange={() => setMode("sets")}
          />
          <span>Resultado por sets (3)</span>
        </label>
        <label className="flex items-center gap-2 cursor-pointer">
          <input
            type="radio"
            name="modo-res"
            checked={mode === "wo"}
            onChange={() => setMode("wo")}
          />
          <span>WO (no presentaci√≥n)</span>
        </label>
      </div>

      {mode === "wo" ? (
        // ---- UI WO ----
        <div className="space-y-2">
          <div className="text-sm text-slate-600">Marc√° qui√©n gana por WO.</div>
          <div className="flex gap-2">
            <button
              type="button"
              className={`px-3 py-1 rounded-lg border ${woWinner === "a" ? "bg-emerald-600 text-white border-emerald-600" : "border-slate-300"}`}
              onClick={() => setWoWinner("a")}
              title={`Gana ${aLabel} por WO`}
            >
              Gana {aLabel} por WO
            </button>
            <button
              type="button"
              className={`px-3 py-1 rounded-lg border ${woWinner === "b" ? "bg-emerald-600 text-white border-emerald-600" : "border-slate-300"}`}
              onClick={() => setWoWinner("b")}
              title={`Gana ${bLabel} por WO`}
            >
              Gana {bLabel} por WO
            </button>
          </div>
          <p className="text-xs text-slate-500">
            Los <b>puntos</b> por WO se toman de <code>reglas.grupos.wo</code> (si configuraste gf/gc, se usan como ‚Äúpuntos‚Äù).
          </p>
        </div>
      ) : (
        // ---- UI SETS (3) ----
        <div className="space-y-3">
          {[0,1,2].map(i => (
            <div key={i} className="grid grid-cols-2 gap-3">
              <div>
                <label
                  className="block text-xs text-slate-500 mb-1 whitespace-nowrap truncate max-w-[280px]"
                  title={aLabel}
                >
                  {`Set ${i+1} ¬∑ ${aLabel}`}
                </label>
                <input
                  type="number"
                  min="0"
                  inputMode="numeric"
                  className="w-full border rounded-lg px-3 py-2"
                  value={sets[i].a}
                  onChange={(e) => setSetVal(i, "a", e.target.value)}
                  placeholder="0"
                />
              </div>
              <div>
                <label
                  className="block text-xs text-slate-500 mb-1 whitespace-nowrap truncate max-w-[280px]"
                  title={bLabel}
                >
                  {`Set ${i+1} ¬∑ ${bLabel}`}
                </label>
                <input
                  type="number"
                  min="0"
                  inputMode="numeric"
                  className="w-full border rounded-lg px-3 py-2"
                  value={sets[i].b}
                  onChange={(e) => setSetVal(i, "b", e.target.value)}
                  placeholder="0"
                />
              </div>
            </div>
          ))}
          <p className="text-xs text-slate-500">
            Ingres√° los <b>puntos</b> de cada set (mejor de 3). El ganador se calcula por cantidad de sets ganados.
          </p>
        </div>
      )}

      <div className="flex items-center justify-end gap-2 pt-2">
        <button className="px-3 py-2 rounded-lg border border-slate-300" onClick={limpiar}>
          Limpiar
        </button>
        <button className="px-3 py-2 rounded-lg border border-slate-300" onClick={onCancel}>
          Cancelar
        </button>
        <button className="px-3 py-2 rounded-lg bg-[#34745B] text-white" onClick={save}>
          Guardar
        </button>
      </div>
    </div>
  );
}




function SetRow({ label, va, vb, setVa, setVb, placeholderA='', placeholderB='' }) {
  return (
    <div>
      <div className="text-sm text-slate-600 mb-1">{label}</div>
      <div className="flex items-center gap-2">
        <input type="number" className="w-20 border rounded-xl px-2 py-1" value={va} onChange={e=>setVa(e.target.value)} placeholder={placeholderA} />
        <span className="text-slate-500">‚Äì</span>
        <input type="number" className="w-20 border rounded-xl px-2 py-1" value={vb} onChange={e=>setVb(e.target.value)} placeholder={placeholderB} />
      </div>
    </div>
  );
}

function BracketPreview({ cuadro, labelEntrada }) {
  const rounds = Object.keys(cuadro).sort((a,b)=>parseInt(a)-parseInt(b));
  return (
    <div className="overflow-auto">
      <div className="flex gap-6 min-w-[600px]">
        {rounds.map(rk => (
          <div key={rk} className="min-w-[250px]">
            <div className="font-semibold mb-2">Ronda {rk}</div>
            <div className="space-y-2">
              {cuadro[rk].map(m => (
                <div key={m.id} className="border rounded-xl p-2 text-sm">
                  <div>{labelEntrada(m.a)}</div>
                  <div>{labelEntrada(m.b)}</div>
                  <div className="text-xs text-slate-500 mt-1">{m.done ? resumenMarcador(m) : '¬∑'}</div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function InfoTip({ children }) {
  return (
    <div className="text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-600">{children}</div>
  );
}
function IconButton({ title, onClick, icon:Icon }) {
  return (
    <button title={title} onClick={onClick} className="p-2 rounded-lg hover:bg-slate-100">
      <Icon className="w-4 h-4" />
    </button>
  );
}
function IconCopy(props){return (<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={props.className}><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>);} 
function IconTrash(props){return (<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={props.className}><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>);} 
function IconUnlock(props){return (<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={props.className}><rect x="3" y="11" width="18" height="11" rx="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>);}

// ================== Helpers de dominio ==================
function newTorneo(){
  return {
    id: genId('t_'),
    nombre: '',
    formato: 'grupos_y_eliminacion', // 'grupos' | 'eliminacion' | 'grupos_y_eliminacion'
    modalidad: 'singles', // 'singles' | 'dobles'
    reglas: normalizeReglas(),
    gruposCount: 2,
    idaVuelta: false,
    topK: 2,
    participantes: [],
    teams: [],
    grupos: [],
    fixture: {}, // { G1: [ { id,a,b,done,result }, ... por rondas ] }
    cuadro: null, // { '1': [ {id,a,b,done,result,next:{round,slot}} ], '2': [...] }
    estado: 'config',
  };
}

// ==== REGLAS POR DEFECTO (arriba del archivo) ====
const DEFAULT_REGLAS = {
  grupos: {
    // ...puntos, wo, bye
    formatoSets: "bo1", // Mejor de 1 set
    puntoDeOro: true,   // Jugar con punto de oro
    tieBreak: "tb7"
  },
  ko: { // Reglas para Knock-Out (Eliminaci√≥n)
    seeding: "serpentina",
    formatoSets: "bo3", // Mejor de 3 sets
    puntoDeOro: false,  // Jugar con ventaja
    decider: "matchTB", // El 3er set es un Match Tie-break
    matchTBPoints: 10,
    tieBreak: "tb7"
  }
};

// Normaliza reglas para que nunca tire undefined en el UI
function normalizeReglas(input) {
  const r = input || {};
  const g = r.grupos || {};
  const p = g.puntos || {};
  const s = r.sets || {};
  const k = r.ko || {};

  const toNum = (x, d) => (Number.isFinite(Number(x)) ? Number(x) : d);

  return {
    grupos: {
      puntos: {
        win:  toNum(p.win,  3),
        draw: toNum(p.draw, 1),
        loss: toNum(p.loss, 0),
      },
    },
    sets: {
      formato: s.formato || "bo1",     // "bo1" | "bo3" | "match_tb10"
      tb:      s.tb      || "tb7",     // "tb7" | "tb10" | "none"
    },
    ko: {
      seeding: k.seeding || "serpentina",
      sets:    k.sets    || "bo1",
      tb:      k.tb      || "tb7",
    },
  };
}


function formatLabel(f){
  return f==='grupos' ? 'S√≥lo grupos' : f==='eliminacion' ? 'Eliminaci√≥n directa' : 'Grupos + Eliminaci√≥n';
}
function prettyEstado(e){
  return e==='config' ? 'configuraci√≥n' : e==='en_juego' ? 'en juego' : e==='finalizado' ? 'finalizado' : 'desconocido';
}
function inferStartTab(t){
  if (!t.nombre || !t.formato) return 'formato';
  if (!t.reglas) return 'reglas';
  return 'participantes';
}



// ===== Generaci√≥n de grupos y fixture =====
function buildGroups(ids, gruposCount){
  const G = [];
  const by = Math.ceil(ids.length / gruposCount);
  for (let i=0;i<gruposCount;i++){
    const slice = ids.slice(i*by, (i+1)*by);
    if (slice.length) G.push({ id: `G${i+1}`, nombre: `Grupo ${i+1}`, entradas: slice });
  }
  return G;
}

function buildRoundRobin(entries = [], idaVuelta = false) {
  const mkId = () => (typeof genId === 'function' ? genId('m_') : `m_${Math.random().toString(36).slice(2,10)}`);
  
  const arr = (entries || []).filter(Boolean).slice();
  if (arr.length % 2 === 1) arr.push(null); // Agrega BYE si es impar

  const n = arr.length;
  if (n < 2) return [];

  const partidosPlanos = [];
  
  // Genera las rondas de ida
  for (let r = 0; r < n - 1; r++) {
    for (let i = 0; i < n / 2; i++) {
      const a = arr[i];
      const b = arr[n - 1 - i];
      if (a != null && b != null) {
        // A cada partido le agregamos su n√∫mero de ronda
        partidosPlanos.push({ id: mkId(), a, b, done: false, round: r + 1 });
      }
    }
    // Rotaci√≥n del algoritmo del c√≠rculo
    const fixed = arr[0];
    const rest = arr.slice(1);
    rest.unshift(rest.pop());
    arr.splice(0, arr.length, fixed, ...rest);
  }

  // Si es ida y vuelta, duplicamos los partidos para la vuelta
  if (idaVuelta) {
    const partidosVuelta = partidosPlanos.map(m => ({
      id: mkId(),
      a: m.b, // Invertimos los jugadores
      b: m.a,
      done: false,
      round: m.round + (n - 1) // Las rondas de vuelta contin√∫an la numeraci√≥n
    }));
    return [...partidosPlanos, ...partidosVuelta];
  }

  return partidosPlanos; // Devuelve un array plano de partidos
}

function flattenFixture(fx){
  const out = [];
  Object.entries(fx).forEach(([gid, rondas]) => {
    rondas.forEach(rs => rs.forEach(m => out.push({ ...m, grupo: gid })));
  });
  return out;
}

function resumenMarcador(m){
  if (!m?.result?.sets?.length) return '';
  const s = m.result.sets.map(x => `${x.a}-${x.b}${x.tb?' (TB)':''}`).join(', ');
  return `${s} ¬∑ Ganador ${m.result.winner?.toUpperCase?.()}`;
}

function applyResultToFixture(torneo, matchId, result){
  const fx = torneo.fixture || {};
  Object.keys(fx).forEach(gid => {
    fx[gid] = fx[gid].map(rs => rs.map(m => (m.id===matchId ? { ...m, result, done:true } : m)));
  });
  torneo.fixture = fx;
  return torneo;
}

// Espera a que carguen im√°genes dentro de un nodo
function waitImages(root) {
  const imgs = Array.from(root.querySelectorAll('img')).filter(img => !img.complete);
  if (!imgs.length) return Promise.resolve();
  return Promise.all(imgs.map(img => new Promise(res => {
    img.onload = img.onerror = () => res();
  })));
}

(function(){
  function defaultLabel(x, t){
    return (typeof x === 'string') ? x : (x?.label || x?.id || '‚Äî');
  }
  const lab = (e,t) => (window.labelEntradaCard ? window.labelEntradaCard(e,t) : defaultLabel(e,t));

  // Recorre cualquier estructura de KO (cuadro) y junta los matches
  function collectKOMatches(node, acc){
    acc = acc || [];
    if (!node) return acc;
    if (Array.isArray(node)){ node.forEach(n => collectKOMatches(n, acc)); return acc; }
    if (typeof node === 'object'){
      if ('jugadorA' in node || 'jugadorB' in node || 'resultado' in node || 'score' in node) acc.push(node);
      Object.values(node).forEach(v => { if (v && typeof v === 'object') collectKOMatches(v, acc); });
    }
    return acc;
  }

  // Aplana el fixture por grupo (si existe)
  function flattenGroupFixture(t){
    const out = [];
    const fixture = t?.fixture || {};
    const grupos = t?.grupos || [];
    grupos.forEach(g => {
      const gid = g.id || g.nombre;
      const rondas = fixture[gid];
      const list = [];
      if (Array.isArray(rondas)){
        rondas.forEach(r => ((r?.matches || r?.partidos || r || [])).forEach(m => {
          if (m && (m.jugadorA != null || m.jugadorB != null)) list.push(m);
        }));
      }
      out.push({ group: g, matches: list });
    });
    return out;
  }

  // Intenta determinar campe√≥n desde KO
  function computeChampion(t){
    const ms = collectKOMatches(t?.cuadro, []);
    if (!ms.length) return null;
    // Prefer√≠ el que marque final; sino, el √∫ltimo
    const finalM = ms.find(m => m.isFinal || m.final || m.ronda === 'final' || m.round === 'final') || ms[ms.length-1];
    const res = finalM?.resultado;
    if (res === 'A' || res === 'B') {
      const winner = res === 'A' ? finalM.jugadorA : finalM.jugadorB;
      return { label: lab(winner, t), score: finalM.score || '', match: finalM };
    }
    return null;
  }

  // Construye una hoja A4 limpia y centrada con todo el contenido
  function buildA4TorneoSheet(torneo, showBracket){
    const sheet = document.createElement('div');
    sheet.style.cssText = [
      'width:1123px','min-height:794px','background:#fff','color:#0f172a',
      'padding:40px 48px','box-sizing:border-box','border-radius:12px',
      'box-shadow:0 0 0 1px rgba(0,0,0,.04)','font-family:ui-sans-serif,system-ui'
    ].join(';');

    // ===== Header centrado =====
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px';

    const brand = document.createElement('div');
    brand.style.cssText = 'display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800;font-size:22px;margin:0 auto';
    (function setLogo(){
      const trySel = ['img[alt*="Coachex"]','img[alt*="logo"]','.topbar img','link[rel="icon"]'];
      let src = null;
      for (const s of trySel){
        const el = document.querySelector(s);
        if (!el) continue;
        src = el.tagName === 'LINK' ? el.href : el.src;
        if (src) break;
      }
      if (src){
        const img = document.createElement('img');
        img.src = src; img.alt = 'Coachex-Pro';
        img.style.cssText = 'width:28px;height:28px;border-radius:9999px;object-fit:cover';
        brand.appendChild(img);
      }
    })();
    const btxt = document.createElement('div'); btxt.textContent = 'Coachex-Pro';
    brand.appendChild(btxt);

    const title = document.createElement('div');
    title.textContent = torneo?.nombre || 'Torneo';
    title.style.cssText = 'font-size:26px;line-height:1.2;font-weight:800;text-align:center;margin-top:4px';

    const sub = document.createElement('div');
    const modo = torneo?.formato === 'eliminacion' ? 'Eliminaci√≥n' : (torneo?.formato === 'grupos_y_eliminacion' ? 'Grupos + Eliminaci√≥n' : 'Grupos');
    const count = (torneo?.modalidad === 'dobles' ? (torneo?.teams || []).length + ' parejas' : (torneo?.participantes || []).length + ' jugadores');
    const created = torneo?.createdAt ? new Date(torneo.createdAt).toLocaleDateString() : '';
    const topk = (torneo?.topK != null ? `Top-K: ${torneo.topK}` : '');
    const idaVuelta = torneo?.idaVuelta ? 'Ida y vuelta: S√≠' : 'Ida y vuelta: No';
    sub.textContent = [modo, count, (created ? 'Creado: ' + created : ''), topk, idaVuelta].filter(Boolean).join(' ¬∑ ');
    sub.style.cssText = 'font-size:12px;line-height:1.5;color:#64748b;text-align:center';

    header.appendChild(brand); header.appendChild(title); header.appendChild(sub);
    sheet.appendChild(header);

    const section = document.createElement('div');
    section.style.cssText = 'display:flex;flex-direction:column;gap:12px';

    // ===== Resultado Final =====
    const champion = computeChampion(torneo);
    if (champion){
      const card = document.createElement('div');
      card.style.cssText = 'border:1px solid #e2e8f0;border-radius:10px;padding:12px';
      const h = document.createElement('div');
      h.textContent = 'Resultado final';
      h.style.cssText = 'font-weight:700;margin-bottom:6px';
      const line = document.createElement('div');
      line.style.cssText = 'font-size:13px';
      line.textContent = `Campe√≥n: ${champion.label}${champion.score ? ' ¬∑ ' + champion.score : ''}`;
      card.appendChild(h); card.appendChild(line);
      section.appendChild(card);
    }

    // ===== Fase Final (resumen) =====
    if (showBracket && torneo?.cuadro){
      const ko = document.createElement('div');
      ko.style.cssText = 'border:1px solid #e2e8f0;border-radius:10px;padding:12px';
      const h = document.createElement('div');
      h.textContent = 'Fase Final (resumen)';
      h.style.cssText = 'font-weight:700;margin-bottom:6px';
      ko.appendChild(h);

      const list = document.createElement('div');
      list.style.cssText = 'display:grid;grid-template-columns:1fr;gap:6px';

      const matches = collectKOMatches(torneo.cuadro, []);
      if (!matches.length){
        const item = document.createElement('div');
        item.style.cssText = 'border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px';
        item.textContent = 'No hay cruces registrados.';
        list.appendChild(item);
      } else {
        matches.forEach(m => {
          const A = lab(m.jugadorA, torneo), B = lab(m.jugadorB, torneo);
          const res = (m.resultado==='A' ? 'Ganador A' : (m.resultado==='B' ? 'Ganador B' : (m.resultado==='D' ? 'Empate' : '')));
          const item = document.createElement('div');
          item.style.cssText = 'border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px';
          item.textContent = `${A || '‚Äî'} vs ${B || '‚Äî'}${m.score ? ' ¬∑ ' + m.score : ''}${res ? ' ¬∑ ' + res : ''}`;
          list.appendChild(item);
        });
      }
      ko.appendChild(list);
      section.appendChild(ko);
    }

    // ===== Grupos (resumen) =====
    if (torneo?.grupos){
      const gc = document.createElement('div');
      gc.style.cssText = 'border:1px solid #e2e8f0;border-radius:10px;padding:12px';
      const h2 = document.createElement('div');
      h2.textContent = 'Grupos (resumen)';
      h2.style.cssText = 'font-weight:700;margin-bottom:6px';
      gc.appendChild(h2);

      const fx = flattenGroupFixture(torneo);
      (torneo.grupos || []).forEach((g, idx) => {
        const gh = document.createElement('div');
        gh.textContent = `Grupo ${g.nombre || g.id || ''}`;
        gh.style.cssText = 'color:#64748b;margin:6px 0 4px 0';
        gc.appendChild(gh);

        // Entradas
        const elist = document.createElement('div');
        elist.style.cssText = 'display:grid;grid-template-columns:1fr;gap:4px';
        (g.entradas || []).forEach(e => {
          const item = document.createElement('div');
          item.style.cssText = 'border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px';
          item.textContent = lab(e, torneo);
          elist.appendChild(item);
        });
        gc.appendChild(elist);

        // Partidos del fixture (si hay)
        const mx = fx[idx]?.matches || [];
        if (mx.length){
          const t = document.createElement('div');
          t.textContent = 'Partidos:';
          t.style.cssText = 'color:#64748b;margin:6px 0 2px 0';
          gc.appendChild(t);

          const mlist = document.createElement('div');
          mlist.style.cssText = 'display:grid;grid-template-columns:1fr;gap:4px';
          mx.forEach(m => {
            const A = lab(m.jugadorA, torneo), B = lab(m.jugadorB, torneo);
            const res = (m.resultado==='A' ? 'Ganador A' : (m.resultado==='B' ? 'Ganador B' : (m.resultado==='D' ? 'Empate' : '')));
            const item = document.createElement('div');
            item.style.cssText = 'border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px';
            item.textContent = `${A || '‚Äî'} vs ${B || '‚Äî'}${m.score ? ' ¬∑ ' + m.score : ''}${res ? ' ¬∑ ' + res : ''}`;
            mlist.appendChild(item);
          });
          gc.appendChild(mlist);
        }
      });

      section.appendChild(gc);
    }

    if (!section.children.length){
      const empty = document.createElement('div');
      empty.style.cssText = 'border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px';
      empty.textContent = 'Sin datos para mostrar.';
      section.appendChild(empty);
    }

    sheet.appendChild(section);
    return sheet;
  }

  // Exponer helpers en window
  window.__buildA4TorneoSheet = buildA4TorneoSheet;
})();

// Exportar A4 a PDF (apaisado)



// ===== Bracket =====

// === Bracket (eliminaci√≥n directa) ===
// Genera todas las rondas: R1 (semis si hay 4), R2 (final), etc.
// Soporta singles y dobles (le pas√°s IDs de alumnos o de teams).
function buildBracket(entryIds = [], opts = {}) {
  const seeding = (opts.seeding || 'serpentina').toLowerCase();

  const ids = Array.from(new Set((entryIds || []).filter(Boolean)));
  const n = Math.max(2, ids.length);
  const size = 1 << Math.ceil(Math.log2(n));

  const slots = new Array(size).fill(null);
  for (let i = 0; i < ids.length; i++) slots[i] = ids[i];

  const order = (seeding === 'aleatorio') ? shuffle([...Array(size).keys()]) : serpentinaOrder(size);

  const round1 = [];
  for (let i = 0; i < size; i += 2) {
    const a = slots[order[i]];
    const b = slots[order[i + 1]];
    round1.push({
      id: `r1-m${(i / 2) + 1}`,
      a: a ?? { BYE: true },
      b: b ?? { BYE: true },
      done: false,
      result: null,
      next: { round: 2, slot: Math.floor(i / 2), side: null }
    });
  }

  const cuadro = { '1': round1 };
  let prev = round1;
  let round = 2;
  while (prev.length > 1) {
    const curr = [];
    for (let j = 0; j < Math.ceil(prev.length / 2); j++) {
      curr.push({
        id: `r${round}-m${j + 1}`, a: null, b: null, done: false, result: null,
        next: { round: round + 1, slot: Math.floor(j / 2), side: null }
      });
    }
    prev.forEach((m, j) => {
      const dest = curr[Math.floor(j / 2)];
      if (!dest) return;
      m.next.side = (j % 2 === 0) ? 'a' : 'b';
    });
    cuadro[String(round)] = curr;
    prev = curr;
    round++;
  }

  const lastKey = String(round - 1);
  (cuadro[lastKey] || []).forEach(m => { delete m.next; });

  // --- INICIO DE LA CORRECCI√ìN ---
  // 6) Avance autom√°tico de BYEs en TODAS las rondas
  const rnums = Object.keys(cuadro).map(Number).sort((a,b) => a - b);
  let keepChecking = true;
  while (keepChecking) {
    keepChecking = false;
    rnums.forEach(rnum => {
      const roundMatches = cuadro[String(rnum)] || [];
      roundMatches.forEach(m => {
        if (m.done) return; // Si ya est√° resuelto, lo saltamos

        const byeA = isBYE(m.a);
        const byeB = isBYE(m.b);
        let winnerEntry = null;
        let winnerSide = null;

        if (byeA && !byeB && m.b) {
          winnerEntry = m.b;
          winnerSide = 'b';
        } else if (byeB && !byeA && m.a) {
          winnerEntry = m.a;
          winnerSide = 'a';
        }

        if (winnerEntry) {
          m.result = { winner: winnerSide, sets: [], done: true, isBye: true };
          m.done = true;
          placeWinner(cuadro, m, winnerEntry);
          keepChecking = true; // Marcamos para volver a revisar el cuadro
        }
      });
    });
  }
  // --- FIN DE LA CORRECCI√ìN ---

  return cuadro;
}

// Siembra serpentina (0,1, size-1, size-2, 2,3, size-3, size-4, ...)
function serpentinaOrder(size) {
  const out = [];
  let l = 0, r = size - 1, dir = 1;
  for (let i = 0; i < size; i++) {
    out.push(dir > 0 ? l++ : r--);
    if ((i + 1) % 2 === 0) dir *= -1;
  }
  return out;
}

// Shuffle simple (si quer√©s seeding "aleatorio")
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function isBYE(x){ return !!(x && x.BYE); }
function findEntry(id, torneo){
  if (!id) return { id:"?" };
  if (typeof id === 'object' && id.BYE) return id; // BYE
  const arr = torneo.modalidad==='dobles' ? (torneo.teams||[]) : (torneo.participantes||[]);
  if (torneo.modalidad==='dobles') return arr.find(t => t.id===id) || { id };
  return id; // en singles, id es alumnoId
}

function placeWinner(cuadro, match, winnerEntry){
  const n = match?.next;
  if (!n) return;

  const destRound = cuadro[String(n.round)];
  if (!destRound) return;

  const dest = destRound[n.slot];
  if (!dest) return;

  // Usar el side indicado por buildBracket; si no viene, inferir por paridad
  let side = n.side;
  if (!side) {
    const prev = cuadro[String(n.round - 1)] || [];
    const idx = prev.findIndex(m => m.id === match.id); // 0,1,2,...
    side = (idx % 2 === 0) ? 'a' : 'b';
  }

  dest[side] = winnerEntry;
}

function recomputeNextSlots(cuadro) {
  if (!cuadro) return;
  const rounds = Object.keys(cuadro).map(Number).sort((a,b)=>a-b);
  for (let k = 1; k < rounds.length; k++) {
    const prev = cuadro[String(rounds[k-1])] || [];
    const curr = cuadro[String(rounds[k])]   || [];
    prev.forEach((m, j) => {
      const dest = curr[Math.floor(j / 2)];
      if (!dest) return;

      let winnerEntry = null;
      const wo = m?.result?.wo || m?.wo || m?.woWinner || null;
      if (wo === 'a') winnerEntry = m.a;
      else if (wo === 'b') winnerEntry = m.b;
      else if (m?.done && (m?.result?.winner === 'a' || m?.result?.winner === 'b')) {
        winnerEntry = (m.result.winner === 'a') ? m.a : m.b;
      }
      if (!winnerEntry) return;

      const side = m?.next?.side ?? ((j % 2 === 0) ? 'a' : 'b');
      dest[side] = winnerEntry;
    });
  }
}

function applyResultToBracket(torneo, matchId, result){
  const cuadro = torneo.cuadro; if (!cuadro) return torneo;
  let found = null;
  Object.values(cuadro).forEach(arr => {
    const f = arr.find(m => m.id === matchId);
    if (f) found = f;
  });
  if (!found) return torneo;

  found.result = result;
  found.done   = true;

  // Propagaci√≥n puntual
  const winner = result.winner === 'a' ? found.a : found.b;
  placeWinner(cuadro, found, winner);

  // RECOMPUTE: asegura que la final tenga ambos lados cuando ambas semis terminaron
  recomputeNextSlots(cuadro);

  torneo.cuadro = cuadro;
  return torneo;
}

function expandEntryToAlumnoIds(entry, torneo) {
    if (!torneo) return [];
    
    // Si es singles, la entrada es el ID del alumno
    if (torneo.modalidad !== 'dobles') {
        const id = (typeof entry === 'string') ? entry : (entry && entry.id);
        return id ? [id] : [];
    }
    
    // Si es dobles, la entrada es el equipo
    const teams = torneo.teams || [];
    const team = (entry && entry.members) ? entry
        : (typeof entry === 'string' ? teams.find(t => t.id === entry) : entry);
    
    return (team && Array.isArray(team.members)) ? team.members.filter(Boolean) : [];
}

// REEMPLAZA TU FUNCI√ìN applyAwardsToRanking COMPLETA CON ESTA:

async function applyAwardsToRanking({ user, clubId, torneo, force = false }) {
  if (!torneo) return;

  const reglas = withRankingDefaults(torneo.reglas);
  const cfg = reglas.ranking;
  const rankingId = cfg.destinoId || torneo.rankingId;

  if (!rankingId) {
    alert('No hay un "Ranking de Torneos de Destino" seleccionado en la pesta√±a Reglas.');
    return;
  }
  if (torneo.estado !== 'finalizado' && !force) {
    alert('Debes marcar el torneo como "Finalizado" antes de aplicar los puntos.');
    return;
  }

  // --- INICIO DE LA L√ìGICA MEJORADA ---

  // 1. Calcular puntos por posici√≥n final (como antes)
  const pointsMap = new Map();
  const mult = cfg.multiplicador || 1;
  const dividirDobles = torneo.modalidad === 'dobles' && cfg.dobles.dividir;

  const assignPoints = (entry, points) => {
    if (!entry || points === 0) return;
    const finalPoints = dividirDobles ? Math.round(points / 2) : points;
    const playerIds = expandEntryToAlumnoIds(entry, torneo);
    playerIds.forEach(id => {
      pointsMap.set(id, (pointsMap.get(id) || 0) + finalPoints);
    });
  };
  
  if (torneo.formato === 'eliminacion' || torneo.formato === 'grupos_y_eliminacion') {
    const finalInfo = bracketFinalInfo(torneo.cuadro);
    if (finalInfo?.done) {
      assignPoints(finalInfo.champion, cfg.ko.champion);
      assignPoints(finalInfo.runnerUp, cfg.ko.runnerUp);
    }
  } else if (torneo.formato === 'grupos') {
    const tabla = computeTablaGrupo(torneo, torneo.grupos[0].id) || [];
    tabla.forEach((row, index) => {
      // --- CORRECCI√ìN: Se usa 'alumnoId' en lugar del inexistente 'eid' ---
      assignPoints(row.alumnoId, cfg.liga.top[index] || 0);
    });
  }

  // 2. NUEVO: Calcular estad√≠sticas (PJ, G, P)
  const statsMap = new Map();
  const ensureStats = (playerId) => {
    if (!statsMap.has(playerId)) statsMap.set(playerId, { PJ: 0, G: 0, P: 0 });
    return statsMap.get(playerId);
  };

  // Estad√≠sticas de Fase de Grupos
  (torneo.grupos || []).forEach(g => {
    const tabla = computeTablaGrupo(torneo, g.id) || [];
    tabla.forEach(row => {
      // --- CORRECCI√ìN: Se usa 'alumnoId' en lugar del inexistente 'eid' ---
      const playerIds = expandEntryToAlumnoIds(row.alumnoId, torneo);
      playerIds.forEach(id => {
        const stats = ensureStats(id);
        stats.PJ += row.PJ || 0;
        stats.G += row.G || 0;
        stats.P += row.P || 0;
      });
    });
  });

  // Estad√≠sticas de Fase Final (KO)
  Object.values(torneo.cuadro || {}).flat().forEach(match => {
    if (!match.done || !match.result || !match.result.winner) return;

    const winnerEntry = match.result.winner === 'a' ? match.a : match.b;
    const loserEntry = match.result.winner === 'a' ? match.b : match.a;

    const winnerIds = expandEntryToAlumnoIds(winnerEntry, torneo);
    const loserIds = expandEntryToAlumnoIds(loserEntry, torneo);

    winnerIds.forEach(id => {
      const stats = ensureStats(id);
      stats.PJ += 1;
      stats.G += 1;
    });
    loserIds.forEach(id => {
      const stats = ensureStats(id);
      stats.PJ += 1;
      stats.P += 1;
    });
  });

  // 3. Unir Puntos y Estad√≠sticas en el objeto "resumen"
  const resumen = {};
  const allPlayerIds = new Set([...pointsMap.keys(), ...statsMap.keys()]);

  allPlayerIds.forEach(id => {
    const stats = statsMap.get(id) || { PJ: 0, G: 0, P: 0 };
    const points = (pointsMap.get(id) || 0) * mult;
    resumen[id] = { ...stats, PTS: points };
  });

  if (Object.keys(resumen).length === 0) {
    alert("No se calcularon puntos ni estad√≠sticas. Aseg√∫rate de que el torneo est√© completo y tenga resultados.");
    return;
  }
  
  // 4. Guardar en Firestore
  const rankingRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubId).collection('rankings').doc(rankingId);
  
  try {
    await db.runTransaction(async (transaction) => {
      const rankingDoc = await transaction.get(rankingRef);
      const rankingData = rankingDoc.exists ? rankingDoc.data() : {};
      
      const ajustesTorneos = { ...(rankingData.ajustesTorneos || {}) };
      // Solo sumamos los puntos, las estad√≠sticas se guardan en el 'award'
      Object.entries(resumen).forEach(([playerId, data]) => {
          ajustesTorneos[playerId] = (ajustesTorneos[playerId] || 0) + (data.PTS || 0);
      });

      // Guardar el recibo con el resumen completo (puntos Y estad√≠sticas)
      const awardRef = rankingRef.collection('awards').doc(torneo.id);
      transaction.set(awardRef, {
        torneoId: torneo.id,
        torneoNombre: torneo.nombre,
        aplicadoEn: new Date(),
        resumen // <-- AHORA CONTIENE PJ, G, P Y PTS
      }, { merge: true });

      transaction.update(rankingRef, { ajustesTorneos });
    });

    alert(`¬°√âxito! Se aplicaron los puntos y estad√≠sticas de "${torneo.nombre}" al ranking.`);

  } catch (error) {
    console.error("Error al aplicar datos al ranking:", error);
    alert("Hubo un error al guardar los datos en el ranking.");
  }
  // --- FIN DE LA L√ìGICA MEJORADA ---
}

// Devuelve los clasificados en el ORDEN DE SIEMBRA que espera buildBracket.
// - G grupos (>=2)
// - Top-K por grupo (K >= 1)
// Regla: 1¬∫ de cada grupo se cruza con 2¬∫ de OTRO grupo (evita mismo grupo).
// Para K>2, empareja 3¬∫ vs 4¬∫, 5¬∫ vs 6¬∫, etc. con la misma l√≥gica.
// Si sobra un "bucket" (K impar), esos entran al final y pueden cruzarse entre s√≠.
// REEMPLAZA ESTA FUNCI√ìN COMPLETA
function computeQualifiers(torneo, K = 2) {
  const grupos = Array.isArray(torneo?.grupos) ? torneo.grupos : [];
  if (grupos.length === 0 || K <= 0) return [];

  // Tablas ordenadas por grupo (usa tu computeTablaGrupo actual)
  const tablas = grupos.map(g => (computeTablaGrupo(torneo, g.id) || []));

  // --- INICIO DE LA CORRECCI√ìN ---
  // Caso especial y mucho m√°s simple para un solo grupo.
  if (grupos.length === 1) {
    // Simplemente tomamos los primeros K jugadores de la tabla ya ordenada.
    return (tablas[0] || []).slice(0, K).map(row => row.alumnoId).filter(Boolean);
  }
  // --- FIN DE LA CORRECCI√ìN ---

  // Buckets por posici√≥n: pos[0] => 1¬∫s, pos[1] => 2¬∫s, ...
  // Para favorecer cruces de grupos distintos, los "pares" (2¬∫, 4¬∫, ...) se invierten.
  const buckets = [];
  for (let p = 0; p < K; p++) {
    const fila = [];
    for (let gi = 0; gi < grupos.length; gi++) {
      const row = tablas[gi][p];
      const id = row && (row.alumnoId ?? row.id);
      if (id) fila.push({ id, gi }); // guardo tambi√©n √≠ndice de grupo
    }
    // pares (p=1,3,5,...) los invierto para desalinear grupos
    buckets.push(p % 2 === 1 ? fila.reverse() : fila);
  }

  // Caso s√∫per com√∫n: 2 grupos y K=2 ‚Üí [A1, B2, A2, B1]
  if (grupos.length === 2 && K === 2) {
    const A1 = buckets[0][0]?.id, B1 = buckets[0][1]?.id;
    const B2 = buckets[1][0]?.id, A2 = buckets[1][1]?.id; // buckets[1] ya est√° "reverso"
    return [A1, B2, A2, B1].filter(Boolean);
  }

  // Empareja bucket 1 con 2, 3 con 4, ... tratando de evitar mismo grupo
  const pairs = [];
  const L = Math.floor(buckets.length / 2);
  for (let i = 0; i < L; i++) {
    const A = buckets[2 * i];     // 1¬∫s, 3¬∫s, 5¬∫s, ...
    const B = buckets[2 * i + 1]; // 2¬∫s, 4¬∫s, 6¬∫s, ...
    const usedB = new Array(B.length).fill(false);

    for (let k = 0; k < A.length; k++) {
      const a = A[k];
      if (!a) continue;

      // Intento emparejar con mismo √≠ndice k
      let pick = -1;
      if (B[k] && !usedB[k] && B[k].gi !== a.gi) pick = k;

      // Si cae mismo grupo o no hay, busco otro B libre de distinto grupo
      if (pick === -1) {
        for (let j = 0; j < B.length; j++) {
          if (!usedB[j] && B[j] && B[j].gi !== a.gi) { pick = j; break; }
        }
      }

      if (pick !== -1) {
        usedB[pick] = true;
        pairs.push([a.id, B[pick].id]); // par completo
      } else {
        // No encontr√© rival ‚Äúdistinto grupo‚Äù (bucket asim√©trico o grupos dispares): entra solo ‚Üí BYE posible
        pairs.push([a.id]);
      }
    }

    // Si quedaron B sin usar (cuando B > A), los agrego solos
    for (let j = 0; j < B.length; j++) {
      if (!usedB[j] && B[j]) pairs.push([B[j].id]);
    }
  }

  // Si K es impar, queda un bucket ‚Äúsueltito‚Äù (p.ej. 3¬∫s). Los emparejo entre ellos evitando, si se puede,
  // cruces del mismo grupo. Si no se puede, van como queden.
  if (buckets.length % 2 === 1) {
    const last = buckets[buckets.length - 1]; // ej: todos los 5¬∫s
    const used = new Array(last.length).fill(false);
    for (let i = 0; i < last.length; i++) {
      if (used[i]) continue;
      let jPick = -1;
      for (let j = i + 1; j < last.length; j++) {
        if (!used[j] && last[j].gi !== last[i].gi) { jPick = j; break; }
      }
      if (jPick !== -1) {
        used[i] = used[jPick] = true;
        pairs.push([last[i].id, last[jPick].id]);
      } else {
        // sin pareja v√°lida distinta: solo ‚Üí BYE posible
        used[i] = true;
        pairs.push([last[i].id]);
      }
    }
  }

  // Aplanar a orden de siembra: [a1,b1, a2,b2, ...] (los ‚Äúsolos‚Äù quedan como est√°n)
  const seedOrder = [];
  for (const p of pairs) seedOrder.push(...p.filter(Boolean));

  // Unicidad por las dudas (y sin "undefined")
  return Array.from(new Set(seedOrder.filter(Boolean)));
}



function renderTeamLabel(team, alumnos){
  const a = alumnos.find(x=>x.id===team.members[0]);
  const b = alumnos.find(x=>x.id===team.members[1]);
  const la = a ? (a.apellido? a.apellido+", "+(a.nombre||a.name||'') : (a.nombre||a.name||'')) : team.members[0];
  const lb = b ? (b.apellido? b.apellido+", "+(b.nombre||b.name||'') : (b.nombre||b.name||'')) : team.members[1];
  return `${la} / ${lb}`;
}

// ================== Utilidades generales ==================
function genId(prefix='id_'){ return prefix + Math.random().toString(36).slice(2, 9); }
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function cx(){ return Array.from(arguments).filter(Boolean).join(' '); }
function deepSet(obj, pathArr, value){
  const o = deepClone(obj);
  let cur = o;
  for (let i=0;i<pathArr.length-1;i++){
    const k = pathArr[i];
    if (!cur[k] || typeof cur[k] !== 'object') cur[k] = {};
    cur = cur[k];
  }
  cur[pathArr[pathArr.length-1]] = value;
  return o;
}
// === Helpers robustos para alumnos ===
function alumnoId(a){
  return a?.id ?? a?.uid ?? a?._id ?? String(a?.dni ?? a?.email ?? Math.random());
}
function alumnoLabel(a){
  const ap = a?.apellido ?? a?.lastName ?? a?.apellidos ?? "";
  const no = a?.nombre   ?? a?.firstName ?? a?.name ?? a?.displayName ?? "";
  const label = (ap && no) ? `${ap}, ${no}` : (ap || no);
  return label || a?.alias || a?.nick || a?.email || alumnoId(a);
}

// Lee el PIN desde Perfil (3 d√≠gitos). Intenta por club y luego global.
function getPerfilPIN(perfil, clubId) {
  const pin =
    perfil?.clubs?.[clubId]?.pin ??
    perfil?.clubs?.[clubId]?.pinSeguridad ??
    perfil?.pin ??
    perfil?.pinSeguridad ??
    null;
  return pin != null ? String(pin).trim() : null;
}


// Bot√≥n habilitado/inhabilitado
function canButton(enabled){
  return enabled
    ? 'bg-[#34745B] text-white hover:opacity-90'
    : 'bg-slate-200 text-slate-500 cursor-not-allowed';
}

function groupsAllMatchesDone(t) {
  const fx = t.fixture || {};
  const gids = Object.keys(fx);
  if (!gids.length) return false; // Si no hay fixture, no se puede decir que est√© "listo"

  let hasAnyMatches = false;
  for (const gid of gids) {
    const partidos = fx[gid] || []; // Esto ahora es un array plano de partidos
    if (!Array.isArray(partidos)) {
        console.warn("Fixture para el grupo", gid, "no es un array. Estructura de datos incorrecta.");
        return false; // Prevenimos un error si la estructura es inv√°lida
    }

    if (partidos.length > 0) {
      hasAnyMatches = true;
    }
    
    // La doble iteraci√≥n se reemplaza por una sola que recorre el array plano
    for (const partido of partidos) {
      if (!partido || !partido.done) {
        return false; // Encontramos un partido pendiente, as√≠ que no est√° todo listo
      }
    }
  }
  
  // Devuelve 'true' solo si hubo al menos un partido y todos est√°n 'done'
  return hasAnyMatches;
}

// REEMPLAZA TU FUNCI√ìN countPendingGroupMatches CON ESTA
function countPendingGroupMatches(t) {
  let pending = 0;
  const fixture = t.fixture || {};

  // Recorremos cada grupo en el fixture (G1, G2, etc.)
  for (const gid in fixture) {
    const partidos = fixture[gid] || []; // 'partidos' es el array plano de partidos
    if (Array.isArray(partidos)) {
      // Reemplazamos los 3 forEach anidados por un bucle simple que recorre el array plano
      for (const partido of partidos) {
        if (!partido || !partido.done) {
          pending++;
        }
      }
    }
  }
  return pending;
}


// ¬øYa hay resultados en KO?
function hasKOResults(cuadro) {
  if (!cuadro) return false;
  return Object.values(cuadro).some(rounds => rounds.some(m => !!m?.done));
}

// === Liga / Solo grupos ===
function isLeagueMode(t){
  const f = t?.formato;
  return f === 'grupos' || f === 'liga' || f === 'solo_grupos' || f === 'league';
}

// Campe√≥n/Subcampe√≥n en LIGA (un grupo). Si hay varios grupos sin KO,
// devuelve ganador por cada grupo.
function leagueWinnersInfo(torneo){
  if (!isLeagueMode(torneo)) return null;
  if (!groupsAllMatchesDone(torneo)) return { done:false };

  const fx = torneo.fixture || {};
  const gids = Object.keys(fx).filter(gid => Array.isArray(fx[gid]) && fx[gid].length);

  if (gids.length <= 1) {
    // Liga de un solo grupo: top1 y top2
    const ids = computeQualifiers(torneo, 2) || [];
    const [champion, runnerUp] = ids.filter(Boolean);
    if (!champion) return { done:false };
    return { done:true, type:'single', champion, runnerUp: runnerUp || null };
  }

  // Varios grupos sin KO: ganador por cada grupo
  const byGroup = {};
  for (const gid of gids) {
    const temp = deepClone(torneo);
    temp.fixture = { [gid]: fx[gid] };
    temp.grupos  = (torneo.grupos || []).filter(g => g.id === gid);
    const top = computeQualifiers(temp, 1) || [];
    byGroup[gid] = top[0] || null;
  }
  return { done:true, type:'multi', byGroup };
}

// ===== Helper: arma el texto de reglas/formato a partir del torneo =====
function buildReglamentoTexto(t) {
  const modalidad = t?.modalidad === 'dobles' ? 'Dobles' : 'Singles';

  const fmtFecha = (v) => {
    if (!v) return '';
    const d = new Date(v);
    if (isNaN(d)) return '';
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  };
  const fIni = fmtFecha(t?.fechaInicio);
  const fFin = fmtFecha(t?.fechaFin);
  const fechasLinea = fIni && fFin
    ? `Se juega del ${fIni} al ${fFin}.`
    : fIni ? `Se juega desde el ${fIni}.`
    : fFin ? `Se juega hasta el ${fFin}.` : '';

  const setsLabel = (k) =>
    k === 'bo1' ? 'al mejor de 1 set' :
    k === 'bo5' ? 'al mejor de 5 sets' :
    k === 'match_tb10' ? 'match tiebreak a 10' :
    'al mejor de 3 sets';

  const tbLabel = (k) =>
    k === 'tb10' ? 'tiebreak a 10' :
    k === 'tb7'  ? 'tiebreak a 7'  :
    'sin tiebreak';

  const r = normalizeReglas?.(t?.reglas) || (t?.reglas || {});
  const puntos = r?.grupos?.puntos || { win: 3, draw: 1, loss: 0 };

  const partes = [];
  partes.push(`Modalidad: ${modalidad}.`);
  if (fechasLinea) partes.push(fechasLinea);

  if (t?.formato === 'grupos' || t?.formato === 'grupos_y_eliminacion') {
    const gruposCount = t?.gruposCount ?? null;
    const idaVuelta = !!t?.idaVuelta;
    const setsFmt = setsLabel(r?.sets?.formato);
    const tbFmt   = tbLabel(r?.sets?.tb);
    partes.push(
      `Fase de grupos: ${gruposCount ?? '?'} grupo(s)` +
      `${idaVuelta ? ', ida y vuelta' : ''}. ` +
      `Puntaje: victoria ${puntos.win}, empate ${puntos.draw}, derrota ${puntos.loss}. ` +
      `Partidos ${setsFmt} con ${tbFmt}.`
    );
  }

  if (t?.formato === 'eliminacion' || t?.formato === 'grupos_y_eliminacion') {
    const clasif = t?.formato === 'grupos_y_eliminacion'
      ? `Clasifican ${parseInt(t?.topK ?? 2, 10)} por grupo. `
      : '';
    const koSets = setsLabel(r?.ko?.sets);
    const koTB   = tbLabel(r?.ko?.tb);
    partes.push(`Eliminaci√≥n directa: ${clasif}Partidos ${koSets} con ${koTB}.`);
  }

  return partes.join(' ');
}

// ===== Panel reutilizable: muestra/copia/guarda el resumen =====
function ResumenReglasBox({ torneo, disabled, onGuardar }) {
  const texto = React.useMemo(() => buildReglamentoTexto(torneo), [torneo]);

  return (
    <div className="border rounded-xl p-3 mt-4">
      <div className="flex items-center justify-between mb-2">
        <div className="font-semibold text-slate-800">Resumen de formato y reglas</div>
        <div className="flex gap-2">
          <button
            type="button"
            className="px-3 py-1.5 rounded-xl border"
            onClick={() => navigator.clipboard?.writeText(texto)}
          >
            Copiar
          </button>
          <button
            type="button"
            className="px-3 py-1.5 rounded-xl bg-[#34745B] text-white disabled:opacity-50"
            onClick={() => onGuardar?.(texto)}
            disabled={disabled}
          >
            Guardar en torneo
          </button>
        </div>
      </div>

      <textarea
        readOnly
        className="w-full border rounded-xl p-2 min-h-[120px]"
        value={texto}
      />

      {!!torneo?.reglamentoTexto && (
        <div className="text-xs text-slate-500 mt-2">
          Guardado: {String(torneo.reglamentoTexto).slice(0, 140)}
          {String(torneo.reglamentoTexto).length > 140 ? '‚Ä¶' : ''}
        </div>
      )}
    </div>
  );
}


// ===== Tabla de posiciones (Standings) =====
function idKey(e){ return (typeof e === 'string') ? e : (e && e.id) ? e.id : String(e); }

function computeStandings(torneo) {
  const out = {};
  const reglas = normalizeReglas(torneo.reglas);
  const P  = (reglas?.grupos?.puntos) || { win: 3, draw: 1, loss: 0 };
  const WO = { ptsWin: P.win, ptsLoss: P.loss, gf: 0, gc: 0, ...(reglas?.grupos?.wo || {}) };
  const BYE = { cuenta: false, ptsWin: P.win, gf: 0, gc: 0, ...(reglas?.grupos?.bye || {}) };

  // === Helpers ===
  const idDe = (eid) => idKey(eid);
  const isBYE = (side) => !!(side && (side.BYE || side.id === 'BYE' || side === 'BYE'));

  const getWO = (m) => {
    // ganador por WO
    if (m?.result?.wo === 'a' || m?.wo === 'a' || m?.woWinner === 'a') return { winner: 'a', loser: 'b' };
    if (m?.result?.wo === 'b' || m?.wo === 'b' || m?.woWinner === 'b') return { winner: 'b', loser: 'a' };
    // perdedor expl√≠cito
    const np = m?.result?.noPresento ?? m?.noPresento;
    if (np === 'a') return { winner: 'b', loser: 'a' };
    if (np === 'b') return { winner: 'a', loser: 'b' };
    return null;
  };

  const sumSets = (sets) => {
    let ga = 0, gb = 0;
    (sets || []).forEach(s => {
      ga += Number(s?.a || 0);
      gb += Number(s?.b || 0);
    });
    return [ga, gb];
  };

  const parseScores = (m) => {
    if (m?.result?.sets && Array.isArray(m.result.sets)) return sumSets(m.result.sets);
    const sA = Number(m?.scoreA ?? m?.result?.scoreA ?? NaN);
    const sB = Number(m?.scoreB ?? m?.result?.scoreB ?? NaN);
    if (Number.isFinite(sA) && Number.isFinite(sB)) return [sA, sB];
    return [0, 0];
  };

  const inferWinner = (m, ga, gb) => {
    let w = m?.result?.winner ?? m?.winner ?? m?.ganador ?? m?.resultado?.winner ?? null;
    if (w === 'A') w = 'a';
    if (w === 'B') w = 'b';
    if (typeof w === 'number') w = (w === 1 ? 'a' : (w === 2 ? 'b' : null));
    if (w === 'empate') w = 'draw';
    if (!w) {
      if (Number.isFinite(ga) && Number.isFinite(gb)) {
        if (ga > gb) w = 'a';
        else if (gb > ga) w = 'b';
        else w = 'draw';
      }
    }
    return w; // 'a' | 'b' | 'draw' | null
  };

  const partidoJugado = (m) => {
    if (!m) return false;
    if (getWO(m)) return true; // WO cuenta como jugado
    if (m.done || m?.result?.done) return true;
    if (m?.result?.winner != null || m?.winner != null || m?.ganador != null) return true;
    const sA = Number(m?.scoreA ?? m?.result?.scoreA ?? NaN);
    const sB = Number(m?.scoreB ?? m?.result?.scoreB ?? NaN);
    return Number.isFinite(sA) && Number.isFinite(sB);
  };

  // === Inicializa por grupo con entradas ===
  (torneo.grupos || []).forEach(g => {
    const map = {};
    (g.entradas || []).forEach(eid => {
      const k = idDe(eid);
      map[k] = { eid, pj: 0, pg: 0, pe: 0, pp: 0, gf: 0, gc: 0, gd: 0, pts: 0 };
    });
    out[g.id] = map;
  });

  // === Recorrer fixture por grupo ===
  Object.entries(torneo.fixture || {}).forEach(([gid, rondas]) => {
    const map = out[gid];
    if (!map) return;

    const matches = Array.isArray(rondas?.[0]) ? rondas.flat() : (rondas || []);

    matches.forEach(m => {
      if (!m || !partidoJugado(m)) return;

      const aK = idDe(m.a), bK = idDe(m.b);
      const aIsBye = isBYE(m.a), bIsBye = isBYE(m.b);

      // --- Caso BYE estructural ---
      if (aIsBye || bIsBye) {
        // si no quer√©s que cuente, salimos
        if (!BYE.cuenta) return;

        // si s√≠ cuenta, gana el no-BYE (si existe en el mapa)
        const winKey = aIsBye ? bK : aK;
        const loseKey = aIsBye ? aK : bK;
        if (!map[winKey]) return;

        map[winKey].pj++; map[winKey].pg++;
        map[winKey].pts += BYE.ptsWin;
        map[winKey].gf  += BYE.gf; map[winKey].gc  += BYE.gc;

        if (map[loseKey]) {
          map[loseKey].pj++; map[loseKey].pp++;
          // por default, no sumamos puntos al que tiene BYE
          map[loseKey].gf += BYE.gc; map[loseKey].gc += BYE.gf;
        }
        return;
      }

      // --- Caso WO (no presentaci√≥n) ---
      const wo = getWO(m);
      if (wo) {
        const wKey = wo.winner === 'a' ? aK : bK;
        const lKey = wo.loser  === 'a' ? aK : bK;
        if (!map[wKey] || !map[lKey]) return;

        map[wKey].pj++; map[lKey].pj++;
        map[wKey].pg++; map[lKey].pp++;

        map[wKey].pts += WO.ptsWin;
        map[lKey].pts += (WO.ptsLoss ?? 0);

        map[wKey].gf += WO.gf; map[wKey].gc += WO.gc;
        map[lKey].gf += WO.gc; map[lKey].gc += WO.gf;
        return;
      }

      // --- Partido normal ---
      if (!map[aK] || !map[bK]) return;

      map[aK].pj++; map[bK].pj++;

      const [ga, gb] = parseScores(m);
      map[aK].gf += ga; map[aK].gc += gb;
      map[bK].gf += gb; map[bK].gc += ga;

      const w = inferWinner(m, ga, gb);
      if (w === 'a') {
        map[aK].pg++; map[bK].pp++;
        map[aK].pts += P.win; map[bK].pts += P.loss;
      } else if (w === 'b') {
        map[bK].pg++; map[aK].pp++;
        map[bK].pts += P.win; map[aK].pts += P.loss;
      } else {
        map[aK].pe++; map[bK].pe++;
        map[aK].pts += P.draw; map[bK].pts += P.draw;
      }
    });
  });

  // === Cerrar arrays y ordenar ===
  const final = {};
  Object.entries(out).forEach(([gid, map]) => {
    const rows = Object.values(map).map(r => ({ ...r, gd: (r.gf - r.gc) }));
    rows.sort((A, B) =>
      (B.pts - A.pts) ||
      (B.gd  - A.gd)  ||
      (B.gf  - A.gf)  ||
      (B.pg  - A.pg)
    );
    final[gid] = rows;
  });

  return final;
}


function StandingsTable({ rows, getLabel }){
  if (!rows || !rows.length) return <div className="text-sm text-slate-500">A√∫n sin posiciones.</div>;
  return (
    <div className="overflow-auto">
      <table className="min-w-[680px] w-full text-sm">
        <thead className="text-xs text-slate-500">
          <tr>
            <th className="text-left py-1 pr-2">#</th>
            <th className="text-left py-1">Jugador / Pareja</th>
            <th className="text-right py-1">PJ</th>
            <th className="text-right py-1">PG</th>
            <th className="text-right py-1">PE</th>
            <th className="text-right py-1">PP</th>
            <th className="text-right py-1">PF</th>
            <th className="text-right py-1">PC</th>
            <th className="text-right py-1">+/-</th>
            <th className="text-right py-1">PF/PJ</th>
            <th className="text-right py-1">Pts</th>
          </tr>
        </thead>
        <tbody>
          {rows.map((r, i) => {
            const ppg = r.pj ? (r.gf / r.pj) : 0;
            return (
              <tr key={idKey(r.eid)} className="border-t">
                <td className="py-1 pr-2">{i+1}</td>
                <td className="py-1">{getLabel ? getLabel(r.eid) : String(idKey(r.eid))}</td>
                <td className="py-1 text-right">{r.pj||0}</td>
                <td className="py-1 text-right">{r.pg||0}</td>
                <td className="py-1 text-right">{r.pe||0}</td>
                <td className="py-1 text-right">{r.pp||0}</td>
                <td className="py-1 text-right">{r.gf||0}</td>
                <td className="py-1 text-right">{r.gc||0}</td>
                <td className="py-1 text-right">{(r.gf - r.gc)||0}</td>
                <td className="py-1 text-right">{ppg.toFixed(1)}</td>
                <td className="py-1 text-right font-semibold">{r.pts||0}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}

    
    function Pagos({ pagos, alumnos, perfil, onPayMensual, clases, onEditarPago, onDeletePago, otrosIngresos, otrosIngresosCrud }) { // <-- Props actualizados
  const [vista, setVista] = useState('historial');

  const TabBtn = ({ id, children }) => (
    <button
      onClick={() => setVista(id)}
      className={`w-full text-center px-3 py-1.5 text-sm rounded-lg transition
        ${vista === id ? 'bg-white shadow' : 'bg-transparent hover:bg-white/60'}`}
    >
      {children}
    </button>
  );

  return (
    <div className="grid gap-4">
      {/* AHORA CON 5 PESTA√ëAS */}
      <div className="grid grid-cols-5 gap-1 bg-slate-100 p-1 rounded-xl">
        <TabBtn id="historial">Historial</TabBtn>
        <TabBtn id="porAlumno">Por Alumno</TabBtn>
        <TabBtn id="mensual">Cuotas</TabBtn>
        <TabBtn id="deudas">Deudas</TabBtn>
        <TabBtn id="otros">Otros Ingresos</TabBtn>
      </div>

      {vista === 'historial' && (
        <HistorialPagos
          pagos={pagos}
          alumnos={alumnos}
          clases={clases}
          onEditarPago={onEditarPago}
          onDeletePago={onDeletePago}
          perfil={perfil}
        />
      )}

      {vista === 'porAlumno' && (
        <HistorialPorAlumno pagos={pagos} alumnos={alumnos} />
      )}

      {vista === 'mensual' && (
        <ControlMensual pagos={pagos} alumnos={alumnos} perfil={perfil} onPay={onPayMensual} />
      )}

      {vista === 'deudas' && (
        <ControlDeudas pagos={pagos} alumnos={alumnos} clases={clases} perfil={perfil} />
      )}

      {/* RENDER DEL NUEVO COMPONENTE QUE CREAREMOS EN EL PASO 4 */}
      {vista === 'otros' && (
        <OtrosIngresos 
          ingresos={otrosIngresos} 
          onCreate={otrosIngresosCrud.create}
          onUpdate={otrosIngresosCrud.update}
          onDelete={otrosIngresosCrud.delete}
          perfil={perfil}
        />
      )}
    </div>
  );
}



// --- COPIAR Y REEMPLAZAR LA FUNCI√ìN COMPLETA ---
function HistorialPagos({
  pagos,
  alumnos,
  clases, // (opcional, no usado aqu√≠)
  onEditarPago,
  onDeletePago,
  perfil,
  nombreLugar: nombreLugarProp
}) {
  // ===== UI local (sin dependencias externas) =====
  const ui = {
    card: "bg-white border rounded-xl shadow-sm",
    sectionHead: "flex items-center justify-between px-3 py-2 border-b bg-slate-50 rounded-t-xl",
    sectionBody: "p-3 space-y-4",
    toolbar: "flex flex-wrap gap-2 items-center",
    select: "h-8 rounded-full border border-slate-300 bg-white px-3 text-sm",
    input:  "h-8 rounded-full border border-slate-300 bg-white px-3 text-sm",
    tableWrap: "overflow-auto border rounded-xl",
    table: "min-w-full text-sm",
    thead: "sticky top-0 z-10 bg-white text-slate-700",
    th: "text-left p-2 font-semibold",
    tr: "border-t hover:bg-slate-50",
    td: "p-2 align-middle",
    btnBase:   "inline-flex items-center rounded-full text-xs px-3 py-1 transition border",
    btnPrimary:"bg-emerald-500 border-emerald-600 text-white hover:bg-emerald-600 shadow-sm",
    btnGhost:  "bg-white border-slate-300 text-slate-700 hover:bg-white",
    btnDanger: "bg-white border-rose-300 text-rose-700 hover:bg-rose-50",
  };

  // √çcono recibo (opcional)
  const ReceiptIcon = (props) => (
    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" {...props}>
      <path d="M6 2l2 1 2-1 2 1 2-1 2 1v18l-2-1-2 1-2-1-2 1-2-1V2z" strokeWidth="1.5" />
      <path d="M8 7h8M8 11h8M8 15h6" strokeWidth="1.5" />
    </svg>
  );

  // ===== Helpers =====
  const getNombreAlumno = (a) => {
    if (!a) return "Alumno";
    const parts = [a.nombre, a.apellido].filter(Boolean);
    return (parts.join(" ") || a.alias || a.nombre || "Alumno").trim();
  };

  const toDateSafe = (v) => {
    try {
      if (!v) return new Date(NaN);
      if (v instanceof Date) return v;
      if (typeof v.toDate === "function") return v.toDate(); // Firestore Timestamp
      if (typeof v === "object" && typeof v.seconds === "number") return new Date(v.seconds * 1000);
      if (typeof v === "string") {
        const s = v.trim();
        if (/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s + (s.length === 10 ? "T00:00:00" : ""));
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
          const [dd, mm, yyyy] = s.split("/");
          return new Date(yyyy + "-" + mm + "-" + dd + "T00:00:00");
        }
        const t = Date.parse(s);
        return isFinite(t) ? new Date(t) : new Date(NaN);
      }
      return new Date(v);
    } catch { return new Date(NaN); }
  };

  const formatDMY = (d) => {
    const x = toDateSafe(d);
    if (isNaN(x)) return "-";
    const dd = String(x.getDate()).padStart(2, "0");
    const mm = String(x.getMonth() + 1).padStart(2, "0");
    const yy = x.getFullYear();
    return dd + "/" + mm + "/" + yy;
  };

  const weekStartMonday = (d) => {
    const x = new Date(d);
    if (isNaN(x)) return new Date(NaN);
    const day = x.getDay(); // 0=dom
    const diff = (day + 6) % 7; // lunes=0
    x.setDate(x.getDate() - diff);
    x.setHours(0, 0, 0, 0);
    return x;
  };

  const safeTime = (v) => {
    const t = toDateSafe(v).getTime();
    return isFinite(t) ? t : 0;
  };

  const monedaISO = (perfil && /^[A-Z]{3}$/.test(perfil.moneda || "")) ? perfil.moneda : "ARS";
  const formatCurrency = (n) => {
    const val = Number(n || 0);
    try {
      return new Intl.NumberFormat("es-AR", { style: "currency", currency: monedaISO }).format(val);
    } catch {
      return (perfil && perfil.moneda ? perfil.moneda : "$") + " " + val.toFixed(2);
    }
  };

  // ===== Estado UI =====
  const [periodo, setPeriodo] = React.useState("mes"); // "dia" | "semana" | "mes" | "a√±o" | "todos"
  const [selectedMonth, setSelectedMonth] = React.useState(new Date().getMonth());
  const [selectedYear, setSelectedYear] = React.useState(new Date().getFullYear());
  const [metodo, setMetodo] = React.useState("Todos"); // "Todos" | "Efectivo" | "Transferencia" | "Mensual" | "Mixto"
  const [currentPage, setCurrentPage] = React.useState(1);
  const ITEMS_PER_PAGE = 10;

  React.useEffect(() => { setCurrentPage(1); }, [periodo, selectedMonth, selectedYear, metodo]);

  // ===== Derivados =====
  const alumnoMap = React.useMemo(() => {
    return new Map((alumnos || []).map(a => [a.id, getNombreAlumno(a)]));
  }, [alumnos]);

  const pagosConDatos = React.useMemo(() => {
    return (pagos || []).map((pago) => {
      const nombreAlumno = alumnoMap.get(pago.alumnoId) || "Alumno no encontrado";
      const concepto = pago.concepto || ("Pago de " + nombreAlumno);
      return { ...pago, nombreAlumno, concepto };
    });
  }, [pagos, alumnoMap]);

  const availableYears = React.useMemo(() => {
    const years = new Set();
    for (const p of pagosConDatos) {
      const y = toDateSafe(p.fecha).getFullYear();
      if (isFinite(y)) years.add(y);
    }
    const arr = Array.from(years).sort((a, b) => b - a);
    if (arr.length === 0) arr.push(new Date().getFullYear());
    return arr;
  }, [pagosConDatos]);

  const pagosFiltrados = React.useMemo(() => {
    const now = new Date();
    const nowWeek = weekStartMonday(now).getTime();

    return pagosConDatos
      .filter((p) => {
        // filtro per√≠odo
        const d = toDateSafe(p.fecha);
        if (isNaN(d)) return false;

        if (periodo === "dia") {
          const same = formatDMY(d) === formatDMY(now);
          if (!same) return false;
        } else if (periodo === "semana") {
          if (weekStartMonday(d).getTime() !== nowWeek) return false;
        } else if (periodo === "mes") {
          if (d.getMonth() !== selectedMonth || d.getFullYear() !== selectedYear) return false;
        } else if (periodo === "a√±o") {
          if (d.getFullYear() !== selectedYear) return false;
        }
        // filtro m√©todo
        if (metodo !== "Todos" && String(p.metodo || "").trim() !== metodo) return false;

        return true;
      })
      .sort((a, b) => safeTime(b.fecha) - safeTime(a.fecha));
  }, [pagosConDatos, periodo, selectedMonth, selectedYear, metodo]);

  const totalFiltrado = React.useMemo(
    () => pagosFiltrados.reduce((acc, p) => acc + Number(p.monto || 0), 0),
    [pagosFiltrados]
  );

  const pageCount = Math.max(1, Math.ceil(pagosFiltrados.length / ITEMS_PER_PAGE));
  const pageStart = (currentPage - 1) * ITEMS_PER_PAGE;
  const pageItems = pagosFiltrados.slice(pageStart, pageStart + ITEMS_PER_PAGE);

  const lugarActual = nombreLugarProp
    ?? (perfil && (perfil.lugarTrabajoNombre || perfil.lugar || perfil.sede))
    ?? "-";

  // ===== Comprobante: PDF (jsPDF si est√°) =====
  async function handleComprobante(pago) {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("La librer√≠a para generar PDF no est√° cargada.");
      return;
    }
    if (!pago) {
      alert("No hay datos del pago para generar el comprobante.");
      return;
    }

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const pageW = doc.internal.pageSize.getWidth();
      const margin = 40;
      let y = 60;

      // Logo (si existe en ./logo_favicon.png)
      let logoDataURL = null;
      try {
        const resp = await fetch("./logo_favicon.png");
        if (resp.ok) {
          const blob = await resp.blob();
          logoDataURL = await new Promise((res) => {
            const r = new FileReader();
            r.onload = () => res(r.result);
            r.readAsDataURL(blob);
          });
          if (logoDataURL) {
            doc.addImage(logoDataURL, "PNG", margin, y - 10, 50, 50);
          }
        }
      } catch(_) {}

      const profeNombre = `${perfil?.nombre || ""} ${perfil?.apellido || ""}`.trim() || "Profesor/a";
      const serie = (perfil?.serieComprobantes || "CP");
      const compNum = typeof nextComprobanteNumber === 'function' ? nextComprobanteNumber(pago, serie) : `N-${(pago.id||'').slice(0,5)}`;

      // Encabezado
      doc.setFontSize(14);
      doc.setFont("helvetica", "bold");
      doc.setTextColor(52, 116, 91);
      doc.text("Comprobante de Pago", pageW - margin, y, { align: "right" });
      y += 22;
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(0, 0, 0);
      doc.text(`Profesor/a: ${profeNombre}`, pageW - margin, y, { align: "right" });
      doc.text(`Comprobante N¬∫: ${compNum}`, pageW - margin, y + 15, { align: "right" });
      doc.text(`Fecha de Emisi√≥n: ${formatDMY(pago.fecha)}`, pageW - margin, y + 30, { align: "right" });
      y += 60;

      const alumnoNombre = pago.nombreAlumno || "Alumno no encontrado";
      const totalStr = formatCurrency(pago.monto);

      const tableBody = [
        ["Recibido de", alumnoNombre],
        ["Concepto", pago.concepto || "-"],
        ["M√©todo de Pago", pago.metodo || "-"],
        ["Lugar", lugarActual || "-"],
        [{ content: "Total", styles: { fontStyle: 'bold', fontSize: 12 } }, { content: totalStr, styles: { fontStyle: 'bold', fontSize: 12 } }]
      ];

      doc.autoTable({
        startY: y,
        head: [['Detalle', 'Informaci√≥n']],
        body: tableBody,
        theme: 'grid',
        headStyles: { fillColor: [52, 116, 91], textColor: 255, fontStyle: 'bold' },
        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 120 } },
        styles: { fontSize: 10, cellPadding: 8 },
        margin: { left: margin, right: margin }
      });

      y = doc.lastAutoTable.finalY + 40;
      if (y < 650) y = 650;

      doc.setFontSize(9);
      doc.text("Firma y Aclaraci√≥n", pageW - margin - 150, y + 20, { align: "center" });
      doc.setDrawColor(150);
      doc.line(pageW - margin - 200, y, pageW - margin, y);

      doc.setFontSize(8);
      doc.setTextColor(150);
      doc.text("Documento no v√°lido como factura. Generado por Coachex-Pro.", margin, doc.internal.pageSize.getHeight() - 30);

      const safe = (s) => String(s || "").replace(/[^\w.-]+/g, "_");
      const fname = `Comprobante_${safe(alumnoNombre)}_${safe(pago.fecha)}.pdf`;
      doc.save(fname);

    } catch(e) {
      console.error("Error al generar el PDF:", e);
      alert("No se pudo generar el comprobante. Revisa la consola para m√°s detalles.");
    }
  }

  // ===== Render =====
  return (
    <div className={ui.card}>
      <div className={ui.sectionHead}>
        <h3 className="text-sm font-semibold text-slate-800">Historial de Pagos</h3>
      </div>

      <div className={ui.sectionBody}>
        {/* Filtros */}
        <div className={ui.toolbar}>
          <select className={ui.select} value={periodo} onChange={(e) => setPeriodo(e.target.value)}>
            <option value="dia">Hoy</option>
            <option value="semana">Esta semana</option>
            <option value="mes">Este mes</option>
            <option value="a√±o">Este a√±o</option>
            <option value="todos">Todos</option>
          </select>

          {(periodo === "mes" || periodo === "a√±o") && (
            <select className={ui.select} value={selectedYear} onChange={(e) => setSelectedYear(Number(e.target.value))}>
              {availableYears.map((y) => <option key={y} value={y}>{y}</option>)}
            </select>
          )}

          {periodo === "mes" && (
            <select className={ui.select} value={selectedMonth} onChange={(e) => setSelectedMonth(Number(e.target.value))}>
              {Array.from({ length: 12 }).map((_, i) => (
                <option key={i} value={i}>{new Date(2000, i, 1).toLocaleString("es-AR", { month: "long" })}</option>
              ))}
            </select>
          )}

          <select className={ui.select + " ml-auto"} value={metodo} onChange={(e) => setMetodo(e.target.value)}>
            <option>Todos</option>
            <option>Efectivo</option>
            <option>Transferencia</option>
            <option>Mensual</option>
            <option>Mixto</option>
          </select>
        </div>

        {/* Totales */}
        <div className="flex items-center justify-between bg-slate-50 border rounded-xl px-3 py-2">
          <div className="text-sm text-slate-600">
            Lugar / Sede: <span className="font-medium text-slate-800">{lugarActual}</span>
          </div>
          <div className="text-sm text-slate-600">
            Total filtrado: <span className="font-semibold text-slate-900">{formatCurrency(totalFiltrado)}</span>
          </div>
        </div>

        {/* ===== Vista M√ìVIL: Tarjetas ===== */}
        <div className="flex flex-col gap-3 md:hidden">
          {pageItems.length === 0 && (
            <div className="text-center text-slate-500 py-6 text-sm">
              No hay pagos para los filtros seleccionados.
            </div>
          )}
          {pageItems.map((p) => (
            <div key={p.id} className="rounded-2xl border px-3 py-3 bg-white shadow-sm">
              <div className="flex items-start justify-between gap-3">
                <div className="text-[12px] text-slate-600">
                  {formatDMY(p.fecha)}
                </div>
                <div className="text-right">
                  <div className="text-sm font-semibold">{formatCurrency(p.monto)}</div>
                  <div className="text-[11px] text-slate-500 capitalize">{p.metodo || "‚Äî"}</div>
                </div>
              </div>

              <div className="mt-2 space-y-1">
                <div className="text-[13px] font-medium text-slate-900">{p.nombreAlumno}</div>
                <div className="text-[12px] text-slate-600">
                  {p.concepto || "-"} {p.mes != null && <span className="text-slate-500">‚Ä¢ Mes: {p.mes + 1}</span>}
                </div>
              </div>

              <div className="mt-3 grid grid-cols-3 gap-2">
                <button
                  className="border rounded-xl px-2 py-1.5 text-[13px] hover:bg-slate-50"
                  title="Editar pago"
                  onClick={(e) => { e.stopPropagation(); onEditarPago && onEditarPago(p); }}
                >‚úèÔ∏è Editar</button>
                <button
                  className="border rounded-xl px-2 py-1.5 text-[13px] hover:bg-rose-50"
                  title="Eliminar pago"
                  onClick={(e) => { e.stopPropagation(); onDeletePago && onDeletePago(p.id); }}
                >üóëÔ∏è Eliminar</button>
                <button
                  className="border rounded-xl px-2 py-1.5 text-[13px] hover:bg-slate-50"
                  title="Descargar comprobante"
                  onClick={(e) => { e.stopPropagation(); handleComprobante(p); }}
                >üßæ Recibo</button>
              </div>
            </div>
          ))}
        </div>

        {/* ===== Vista ESCRITORIO: Tabla ===== */}
        <div className={"hidden md:block " + ui.tableWrap}>
          <table className={ui.table}>
            <thead className={ui.thead}>
              <tr>
                <th className={ui.th}>Fecha</th>
                <th className={ui.th}>Alumno</th>
                <th className={ui.th}>Concepto</th>
                <th className={ui.th}>M√©todo</th>
                <th className={ui.th + " text-right"}>Monto</th>
                <th className={ui.th + " text-right"}>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {pageItems.length === 0 && (
                <tr>
                  <td colSpan={6} className="p-6 text-center text-slate-500">
                    No hay pagos para los filtros seleccionados.
                  </td>
                </tr>
              )}

              {pageItems.map((p) => (
                <tr key={p.id} className={ui.tr}>
                  <td className={ui.td}>{formatDMY(p.fecha)}</td>
                  <td className={ui.td}>{p.nombreAlumno}</td>
                  <td className={ui.td}>
                    <div className="flex flex-col">
                      <span className="text-slate-800">{p.concepto || "-"}</span>
                      {p.mes != null && <span className="text-xs text-slate-500">Mes: {p.mes + 1}</span>}
                    </div>
                  </td>
                  <td className={ui.td}>{p.metodo || "-"}</td>
                  <td className={ui.td + " text-right"}>{formatCurrency(p.monto)}</td>
                  <td className={ui.td + " text-right"}>
                    <div className="inline-flex items-center gap-2">
                      <button
                        className="px-3 py-1.5 text-xs rounded-lg border bg-white border-slate-300 text-slate-700 hover:bg-slate-50"
                        onClick={(e) => { e.stopPropagation(); onEditarPago && onEditarPago(p); }}
                        title="Editar pago"
                      >
                        Editar
                      </button>
                      <button
                        className="px-3 py-1.5 text-xs rounded-lg border bg-white border-rose-300 text-rose-700 hover:bg-rose-50"
                        onClick={(e) => { e.stopPropagation(); onDeletePago && onDeletePago(p.id); }}
                        title="Eliminar pago"
                      >
                        Eliminar
                      </button>
                      <button
                        className="px-3 py-1.5 text-xs rounded-lg border bg-emerald-600 border-emerald-700 text-white hover:bg-emerald-700"
                        onClick={(e) => { e.stopPropagation(); handleComprobante(p); }}
                        title="Descargar comprobante"
                      >
                        Comprobante
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* Paginaci√≥n */}
        <div className="flex items-center justify-between">
          <div className="text-xs text-slate-500">
            Mostrando {pageItems.length} de {pagosFiltrados.length}
          </div>
          <div className="flex items-center gap-2">
            <button
              className={ui.btnBase + " " + ui.btnGhost + " px-2 py-1 disabled:opacity-50"}
              disabled={currentPage <= 1}
              onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}
            >
              Anterior
            </button>
            <span className="text-xs">{currentPage} / {pageCount}</span>
            <button
              className={ui.btnBase + " " + ui.btnGhost + " px-2 py-1 disabled:opacity-50"}
              disabled={currentPage >= pageCount}
              onClick={() => setCurrentPage((p) => Math.min(pageCount, p + 1))}
            >
              Siguiente
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
    
    function ControlMensual({ pagos, alumnos, perfil, onPay }) {
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
  const alumnosMensuales = useMemo(
    () => alumnos.filter(a => a.plan === 'mensual' && a.estado === 'activo'),
    [alumnos]
  );

  // VERSI√ìN CORREGIDA Y SEGURA
  const statusMensual = useMemo(() => {
    const anioActual = new Date().getFullYear();
    const mesAnioClave = `${anioActual}-${String(selectedMonth + 1).padStart(2, '0')}`;

    const pagosDelMes = pagos.filter(
      p => (/^(Cuota|Abono) Mensual/).test(p.concepto) && (p.fecha || '').startsWith(mesAnioClave)
    );

    return alumnosMensuales.map(alumno => {
      const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
      const pagosAlumno = pagosDelMes.filter(p => p.alumnoId === alumno.id);
      const totalPagado = pagosAlumno.reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);

      let estado = 'Pendiente';
      if (totalPagado >= cuota) estado = 'Pagado';
      else if (totalPagado > 0) estado = 'Parcial';

      return { ...alumno, cuota, totalPagado, estado };
    });
  }, [alumnosMensuales, pagos, selectedMonth, perfil.preciosMensuales]);

  const getStatusColor = (status) => {
    if (status === 'Pagado') return 'bg-green-100 text-green-800';
    if (status === 'Parcial') return 'bg-yellow-100 text-yellow-800';
    return 'bg-red-100 text-red-800';
  };

  const FilterButton = ({ onClick, isActive, children }) => (
    <button
      onClick={onClick}
      className={`px-3 py-1 rounded-md transition-colors text-sm ${
        isActive ? 'bg-white shadow text-slate-800 font-semibold'
                 : 'text-slate-500 hover:text-slate-800'
      }`}
    >
      {children}
    </button>
  );

  return (
    <Card title="Control de Cuotas Mensuales">
      {/* Selector de mes */}
      <div className="p-3 border rounded-xl bg-slate-50 mb-4">
        <div className="bg-slate-200 p-1 rounded-lg flex-1 flex-wrap inline-flex items-center w-full">
          {MESES_NOMBRES.map((mes, index) => (
            <FilterButton
              key={mes}
              onClick={() => setSelectedMonth(index)}
              isActive={selectedMonth === index}
            >
              {mes}
            </FilterButton>
          ))}
        </div>
      </div>

      {/* === TABLA: ancho completo + columnas fijas === */}
      <div className="w-full overflow-auto border rounded-xl">
        <table className="w-full min-w-full table-fixed text-sm">
          <thead className="sticky top-0 z-10 bg-white text-slate-700">
            <tr>
              <th className="p-2 text-left w-[26%]">Alumno</th>
              <th className="p-2 text-left w-[26%]">Plan</th>
              <th className="p-2 text-right w-[16%]">Monto Cuota</th>
              <th className="p-2 text-right w-[16%]">Monto Pagado</th>
              <th className="p-2 text-left w-[10%]">Estado</th>
              <th className="p-2 text-right w-[6%]">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {statusMensual.length === 0 && (
              <tr>
                <td colSpan={6} className="text-center py-6 text-slate-400">
                  No hay alumnos con plan mensual
                </td>
              </tr>
            )}

            {statusMensual.map(a => (
              <tr key={a.id} className="border-t hover:bg-slate-50">
                <td className="p-2 whitespace-nowrap">
                  {`${a.apellido || ''} ${a.nombre || ''}`.trim()}
                </td>
                <td className="p-2">
                  {FRECUENCIAS_MENSUALES.find(f => f.value === a.frecuencia)?.label}
                </td>
                <td className="p-2 text-right whitespace-nowrap">
                  {formatCurrency(a.cuota)}
                </td>
                <td className="p-2 text-right whitespace-nowrap">
                  {formatCurrency(a.totalPagado)}
                </td>
                <td className="p-2">
                  <span className={`px-2 py-0.5 rounded-full text-xs ${getStatusColor(a.estado)}`}>
                    {a.estado}
                  </span>
                </td>
                <td className="p-2 text-right">
  {a.estado !== 'Pagado' && (
    <button
      onClick={() => onPay(a, selectedMonth)}
      title="Registrar pago"
      aria-label="Registrar pago"
      className="inline-flex items-center rounded-full text-[11px] px-2 py-1 border bg-white border-slate-300 text-slate-700"
    >
      ‚úîÔ∏è
    </button>
  )}
</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </Card>
  );
}

    
    function ControlDeudas({ pagos, alumnos, clases, perfil }) {
      
  const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : '??';
  
  const deudas = useMemo(() => {
      const deudores = [];
      const hoy = new Date();
      const mesAnioClave = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
      
      const alumnosActivos = alumnos.filter(a => a.estado === 'activo');
      const alumnoMap = new Map(alumnos.map(a => [a.id, a]));

      // 1. Deudas de cuotas mensuales
      const alumnosMensuales = alumnosActivos.filter(a => a.plan === 'mensual');
      // Filtro seguro por texto, no por objeto Date
      const pagosMensualesEsteMes = pagos.filter(p => 
    (/^(Cuota|Abono) Mensual/).test(p.concepto) && (p.fecha || '').startsWith(mesAnioClave)
);

      alumnosMensuales.forEach(alumno => {
          const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
          if (cuota <= 0) return;

          const totalPagado = pagosMensualesEsteMes
              .filter(p => p.alumnoId === alumno.id)
              .reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
          
          if (totalPagado < cuota) {
              deudores.push({ 
                alumnoId: alumno.id, // Guardamos el ID del alumno
                nombre: getNombreCompleto(alumno), 
                tipo: 'Cuota Mensual', 
                monto: cuota - totalPagado 
              });
          }
      });

      // 2. Deudas por clase (esta parte no cambiaba, pero se mantiene)
      const clasesConDeuda = clases.filter(c => 
        (c.estado === 'Realizada' || c.estado === 'Ausente') &&
        (c.fecha ? new Date(c.fecha) <= hoy : false) && // Verificaci√≥n de fecha segura
        parseFloat(c.precio || 0) > 0
      );

      const pagosPorClaseMap = new Map();
      pagos.filter(p => p.claseId).forEach(p => {
        pagosPorClaseMap.set(p.claseId, (pagosPorClaseMap.get(p.claseId) || 0) + parseFloat(p.monto || 0));
      });

      clasesConDeuda.forEach(clase => {
          const totalPagado = pagosPorClaseMap.get(clase.id) || 0;
          const precioClase = parseFloat(clase.precio || 0);

          if (totalPagado < precioClase) {
              const deudaClase = precioClase - totalPagado;
              const alumnosPorClase = (clase.alumnoIds || [])
                .map(id => alumnoMap.get(id))
                .filter(a => a && a.plan === 'porClase');
              
              if (alumnosPorClase.length > 0) {
                const montoPorAlumno = deudaClase / alumnosPorClase.length;
                alumnosPorClase.forEach(alumno => {
                  deudores.push({ 
                    alumnoId: alumno.id, // Guardamos el ID del alumno
                    nombre: getNombreCompleto(alumno), 
                    tipo: `Clase ${clase.fecha}`, 
                    monto: montoPorAlumno 
                  });
                });
              }
          }
      });
      
      // --- INICIO DE LA CORRECCI√ìN CLAVE ---
      // Agrupamos las deudas de forma eficiente, usando el ID del alumno
      // en lugar de buscarlo por nombre en un bucle.
      const deudasAgrupadas = deudores.reduce((acc, deuda) => {
          const id = deuda.alumnoId;
          if(!acc[id]) {
            acc[id] = { nombre: deuda.nombre, total: 0, detalles: [] };
          }
          acc[id].total += deuda.monto;
          acc[id].detalles.push({ tipo: deuda.tipo, monto: deuda.monto });
          return acc;
      }, {});
      // --- FIN DE LA CORRECCI√ìN CLAVE ---
      
      return Object.values(deudasAgrupadas).sort((a,b) => b.total - a.total);

  }, [pagos, alumnos, clases, perfil]);
  
  return (
      <Card title="Control de Deudas Pendientes (Mes Actual)">
           <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Alumno</th><th className="p-2">Detalle de Deuda</th><th className="p-2 text-right">Total Adeudado</th></tr></thead><tbody>
              {deudas.length === 0 && (<tr><td colSpan={3} className="text-center py-6 text-slate-400">No hay deudas pendientes registradas para el mes actual.</td></tr>)}
              {deudas.map((deuda, index) => ( // Se a√±ade index para una key √∫nica
                  <tr key={`${deuda.nombre}-${index}`} className="border-t">
                      <td className="p-2 font-semibold">{deuda.nombre}</td>
                      <td className="p-2">
                          <ul className="list-disc list-inside">
                          {deuda.detalles.map((d, i) => (
                              <li key={i}>{d.tipo}: <span className="font-medium">{formatCurrency(d.monto)}</span></li>
                          ))}
                          </ul>
                      </td>
                      <td className="p-2 font-semibold text-red-600 text-right">{formatCurrency(deuda.total)}</td>
                  </tr>
              ))}
          </tbody></table></div>
      </Card>
  );
}

// --- COMIENZA LA FUNCI√ìN CORREGIDA ---

function OtrosIngresos({ ingresos, onCreate, onUpdate, onDelete, perfil }) {
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);
  const emptyForm = { fecha: formatDate(new Date()), concepto: "Luz Artificial (60 min)", monto: "", metodo: "Efectivo", cancha: "", notas: "" };
  const [form, setForm] = useState(emptyForm);

  const conceptosLuz = [
    { key: 'luz_30min', label: 'Luz Artificial (30 min)' },
    { key: 'luz_60min', label: 'Luz Artificial (60 min)' },
    { key: 'luz_90min', label: 'Luz Artificial (90 min)' },
    { key: 'luz_120min', label: 'Luz Artificial (120 min)' },
    { key: 'otro', label: 'Otro Ingreso...' },
  ];

  useEffect(() => {
    // Solo actuar si no estamos editando un ingreso existente
    if (perfil.preciosServicios && !editing) {
      const conceptoSeleccionado = conceptosLuz.find(c => c.label === form.concepto);
      if (conceptoSeleccionado && conceptoSeleccionado.key !== 'otro') {
        const monto = perfil.preciosServicios[conceptoSeleccionado.key] || "";
        
        // --- INICIO DE LA CORRECCI√ìN ---
        // Solo se actualiza el monto si el campo est√° vac√≠o o es cero.
        // Esto respeta cualquier valor que el usuario haya escrito manualmente.
        if (form.monto === "" || form.monto === "0" || form.monto === 0) {
          setForm(f => ({ ...f, monto: String(monto) }));
        }
        // --- FIN DE LA CORRECCI√ìN ---
      }
    }
    // Se a√±ade form.monto a las dependencias porque ahora se lee dentro del efecto.
  }, [form.concepto, perfil.preciosServicios, editing, form.monto]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, [name]: value }));
  };
  
  function openNew() { setEditing(null); setForm(emptyForm); setShowForm(true); }
  function openEdit(ingreso) { setEditing(ingreso); setForm(ingreso); setShowForm(true); }
  function cancel() { setShowForm(false); setEditing(null); }
  function submit(e) {
    e.preventDefault();
    if (!form.concepto.trim() || !form.monto) return alert("Complet√° concepto y monto");
    if (editing) { onUpdate({ ...form, id: editing.id }); } else { onCreate(form); }
    cancel();
  }

  const sortedIngresos = [...(ingresos || [])].sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

  return (
    <div className="grid gap-4">
      <Card title={<span className="text-[#34745B]">{editing ? "Editar Ingreso" : "Nuevo Ingreso"}</span>} right={!showForm && <button onClick={openNew} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">+ Nuevo</button>}>
        {showForm ? ( 
          <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
            <div className="md:col-span-2">
              <label className="text-sm">Fecha</label>
              <input type="date" name="fecha" value={form.fecha} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" required />
            </div>
            <div className="md:col-span-4">
              <label className="text-sm">Concepto</label>
              <select name="concepto" value={form.concepto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1">
                {conceptosLuz.map(c => <option key={c.key} value={c.label}>{c.label}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="text-sm">Monto</label>
              <input type="number" name="monto" value={form.monto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" placeholder="0" required />
            </div>
            <div className="md:col-span-3">
              <label className="text-sm">M√©todo</label>
              <select name="metodo" value={form.metodo} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1">
                <option>Efectivo</option>
                <option>Transferencia</option>
              </select>
            </div>
            <div className="md:col-span-6">
              <label className="text-sm">Notas (Opcional)</label>
              <textarea name="notas" value={form.notas} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" rows="2" />
            </div>
            <div className="md:col-span-6 flex justify-end gap-2">
              <button type="button" onClick={cancel} className="px-3 py-2 rounded-lg border">Cancelar</button>
              <button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] text-white">Guardar</button>
            </div>
          </form>
         ) : ( <p className="text-sm text-slate-500">Registra ingresos que no provienen de clases (ej: venta de pelotas, alquiler de luz, etc.).</p> )}
      </Card>

      <Card title={<span className="text-[#34745B]">Historial de Otros Ingresos</span>}>
        <div className="hidden md:block overflow-x-auto">
          <table className="w-full text-sm">
            <thead><tr className="text-left text-slate-600"><th className="p-2">Fecha</th><th className="p-2">Concepto</th><th className="p-2">Monto</th><th className="p-2">M√©todo</th><th className="p-2 text-right">Acciones</th></tr></thead>
            <tbody>
              {sortedIngresos.map(ingreso => (
                <tr key={ingreso.id} className="border-t"><td className="p-2">{ingreso.fecha}</td><td className="p-2 font-medium">{ingreso.concepto}</td><td className="p-2">{formatCurrency(ingreso.monto)}</td><td className="p-2">{ingreso.metodo}</td><td className="p-2 text-right"><div className="inline-flex gap-2"><button onClick={() => openEdit(ingreso)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button><button type="button" onClick={() => onDelete(ingreso.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button></div></td></tr>
              ))}
            </tbody>
          </table>
        </div>
        <div className="block md:hidden space-y-3">
          {sortedIngresos.map(ingreso => (
            <div key={ingreso.id} className="p-3 border rounded-lg bg-white shadow-sm">
              <div className="flex justify-between items-start">
                <div>
                  <div className="font-semibold text-slate-800">{ingreso.concepto}</div>
                  <div className="text-xs text-slate-500">{ingreso.fecha} ¬∑ {ingreso.metodo}</div>
                </div>
                <div className="font-bold text-emerald-700 whitespace-nowrap">{formatCurrency(ingreso.monto)}</div>
              </div>
              <div className="mt-3 pt-2 border-t flex gap-2">
                <button onClick={() => openEdit(ingreso)} className="flex-1 px-2 py-1.5 text-sm rounded-lg border hover:bg-slate-50">Editar</button>
                <button type="button" onClick={() => onDelete(ingreso.id)} className="flex-1 px-2 py-1.5 text-sm rounded-lg border text-red-600 hover:bg-red-50">Eliminar</button>
              </div>
            </div>
          ))}
        </div>
        
        {sortedIngresos.length === 0 && (<div className="text-center py-6 text-slate-400 text-sm">No hay otros ingresos registrados.</div>)}
      </Card>
    </div>
  );
}

// --- REEMPLAZA TU FUNCI√ìN 'HistorialPorAlumno' COMPLETA CON ESTA ---

function HistorialPorAlumno({ pagos = [], alumnos = [] }) {
  const [fechaDesde, setFechaDesde] = React.useState("");
  const [fechaHasta, setFechaHasta] = React.useState("");
  const [metodo, setMetodo] = React.useState("Todos");
  const [q, setQ] = React.useState("");

  const [currentPage, setCurrentPage] = React.useState(1);
  const ITEMS_PER_PAGE = 10;

  const alumnoMap = React.useMemo(() => new Map(alumnos.map(a => [a.id, a])), [alumnos]);
  const normNum = (v) => Number.isFinite(Number(v)) ? Number(v) : 0;
  const formatMoney = (n) => new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS", maximumFractionDigits: 0 }).format(normNum(n));
  const getName = (a) => (a ? getNombreCompleto(a) : "");

  const filas = React.useMemo(() => {
    const acc = new Map();
    const pagosFiltrados = pagos.filter(p => {
      if (!p.fecha) return false;
      if (fechaDesde && String(p.fecha) < fechaDesde) return false;
      if (fechaHasta && String(p.fecha) > fechaHasta) return false;
      if (metodo !== "Todos" && (p.metodo || "") !== metodo) return false;
      return true;
    });

    for (const p of pagosFiltrados) {
      const id = p.alumnoId;
      if (!id) continue;
      const cur = acc.get(id) || { alumnoId: id, nombre: getName(alumnoMap.get(id)), efectivo: 0, transferencia: 0, mensual: 0, total: 0 };
      const monto = normNum(p.monto);
      if (p.metodo === "Efectivo") cur.efectivo += monto;
      else if (p.metodo === "Transferencia") cur.transferencia += monto;
      else if (p.metodo === "Mensual") cur.mensual += monto;
      else if (p.metodo === "Mixto" && p.detalleMixto) {
        cur.efectivo += normNum(p.detalleMixto.efectivo);
        cur.transferencia += normNum(p.detalleMixto.transferencia);
      }
      cur.total = cur.efectivo + cur.transferencia + cur.mensual;
      acc.set(id, cur);
    }
    
    let resultados = Array.from(acc.values());
    if (q) {
      resultados = resultados.filter(r => r.nombre.toLowerCase().includes(q.toLowerCase()));
    }
    
    return resultados.sort((a, b) => b.total - a.total);
  }, [pagos, fechaDesde, fechaHasta, metodo, q, alumnoMap]);

  const totalPages = Math.ceil(filas.length / ITEMS_PER_PAGE);
  const paginatedFilas = React.useMemo(() => {
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    return filas.slice(startIndex, startIndex + ITEMS_PER_PAGE);
  }, [filas, currentPage]);

  useEffect(() => { setCurrentPage(1); }, [q, fechaDesde, fechaHasta, metodo]);

  return (
    <div className="space-y-3">
      <div className="grid gap-2 md:grid-cols-4 p-3 border rounded-xl bg-slate-50">
        <div><label className="block text-xs text-slate-500">Alumno</label><input value={q} onChange={e => setQ(e.target.value)} placeholder="Buscar por nombre‚Ä¶" className="w-full border rounded-lg px-3 py-2 text-sm" /></div>
        <div><label className="block text-xs text-slate-500">Desde</label><input type="date" value={fechaDesde} onChange={e => setFechaDesde(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" /></div>
        <div><label className="block text-xs text-slate-500">Hasta</label><input type="date" value={fechaHasta} onChange={e => setFechaHasta(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm" /></div>
        <div><label className="block text-xs text-slate-500">M√©todo</label><select value={metodo} onChange={e => setMetodo(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm"><option>Todos</option><option>Efectivo</option><option>Transferencia</option><option>Mensual</option></select></div>
      </div>
      
      {/* --- VISTA DE ESCRITORIO (TABLA) --- */}
      <div className="hidden md:block overflow-x-auto rounded-xl border border-slate-200">
        <table className="min-w-full text-sm">
          <thead className="bg-slate-50">
            <tr><th className="text-left p-2">Alumno</th><th className="text-right p-2">Efectivo</th><th className="text-right p-2">Transferencia</th><th className="text-right p-2">Mensual</th><th className="text-right p-2">Total</th></tr>
          </thead>
          <tbody>
            {paginatedFilas.map(row => (
              <tr key={row.alumnoId} className="border-t"><td className="p-2">{row.nombre}</td><td className="p-2 text-right">{formatMoney(row.efectivo)}</td><td className="p-2 text-right">{formatMoney(row.transferencia)}</td><td className="p-2 text-right">{formatMoney(row.mensual)}</td><td className="p-2 text-right font-semibold">{formatMoney(row.total)}</td></tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* --- VISTA M√ìVIL (TARJETAS) --- */}
      <div className="block md:hidden space-y-3">
        {paginatedFilas.map(row => (
          <div key={row.alumnoId} className="p-3 border rounded-lg bg-white shadow-sm">
            <div className="flex justify-between items-start">
              <span className="font-semibold text-slate-800 pr-2">{row.nombre}</span>
              <span className="font-bold text-lg text-emerald-700 whitespace-nowrap">{formatMoney(row.total)}</span>
            </div>
            <div className="mt-2 pt-2 border-t grid grid-cols-[auto,1fr] gap-x-3 gap-y-1 text-sm">
              <span className="text-slate-500">Efectivo:</span><span className="text-slate-800 font-medium">{formatMoney(row.efectivo)}</span>
              <span className="text-slate-500">Transferencia:</span><span className="text-slate-800 font-medium">{formatMoney(row.transferencia)}</span>
            </div>
          </div>
        ))}
      </div>

      {paginatedFilas.length === 0 && (<div className="text-center py-6 text-slate-400 text-sm">Sin movimientos en el per√≠odo.</div>)}

      {totalPages > 1 && ( <div className="mt-4 flex justify-center items-center gap-2">{/* ... paginaci√≥n ... */}</div> )}
    </div>
  );
}


function Gastos({ gastos, onCreate, onUpdate, onDelete }) {
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);
  const emptyForm = { fecha: formatDate(new Date()), concepto: "", monto: "", categoria: "Varios" };
  const [form, setForm] = useState(emptyForm);
  const [periodo, setPeriodo] = useState("mes");
  const [currentPage, setCurrentPage] = useState(1);
  const ITEMS_PER_PAGE = 10;

  // ‚úÖ FIX: sin JSX adentro
  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, [name]: value }));
  };

  const gastosFiltrados = useMemo(() => {
    const ahora = new Date();
    const hoy = formatDate(ahora);
    const semanaInicio = formatDate(getWeekStartDate(ahora));
    const mesInicio = formatDate(new Date(ahora.getFullYear(), ahora.getMonth(), 1));
    const anioInicio = formatDate(new Date(ahora.getFullYear(), 0, 1));

    return gastos
      .filter(g => {
        if (periodo === 'dia' && g.fecha !== hoy) return false;
        if (periodo === 'semana' && g.fecha < semanaInicio) return false;
        if (periodo === 'mes' && g.fecha < mesInicio) return false;
        if (periodo === 'a√±o' && g.fecha < anioInicio) return false;
        return true;
      })
      .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  }, [gastos, periodo]);

  const totalGastos = useMemo(
    () => gastosFiltrados.reduce((acc, g) => acc + (parseFloat(g.monto || 0) || 0), 0),
    [gastosFiltrados]
  );

  const totalPages = Math.ceil(gastosFiltrados.length / ITEMS_PER_PAGE);
  const paginatedGastos = useMemo(() => {
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    return gastosFiltrados.slice(startIndex, startIndex + ITEMS_PER_PAGE);
  }, [gastosFiltrados, currentPage]);

  useEffect(() => {
    setCurrentPage(1);
  }, [periodo]);

  function openNew() { setEditing(null); setForm(emptyForm); setShowForm(true); }
  function openEdit(g) { setEditing(g); setForm(g); setShowForm(true); }
  function cancel() { setShowForm(false); setEditing(null); setForm(emptyForm); }
  function submit(e) {
    e.preventDefault();
    if (!form.concepto.trim() || !form.monto) return alert("Complet√° concepto y monto");
    if (editing) { onUpdate({ ...form, id: editing.id }); } else { onCreate(form); }
    cancel();
  }

  const PeriodoButton = ({ value, current, setter, children }) => (
    <button
      onClick={() => setter(value)}
      className={`px-3 py-1.5 text-sm rounded-lg ${
        current === value
          ? 'bg-[#34745B] text-white hover:bg-green-800'
          : 'bg-white border text-slate-700 hover:bg-slate-50'
      }`}
    >
      {children}
    </button>
  );

  return (
    <div className="grid gap-4">
      <Card
        title={<span className="text-[#34745B]">{editing ? "Editar gasto" : "Nuevo gasto"}</span>}
        right={!showForm && (
          <button
            onClick={openNew}
            className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl"
          >
            + Nuevo
          </button>
        )}
      >
        {showForm ? (
          <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
            <div className="md:col-span-3">
              <label className="text-sm text-slate-600">Fecha</label>
              <input
                type="date"
                name="fecha"
                value={form.fecha}
                onChange={handleChange}
                className="w-full border rounded-lg px-3 py-2"
                required
              />
            </div>

            <div className="md:col-span-3">
              <label className="text-sm text-slate-600">Concepto</label>
              <input
                type="text"
                name="concepto"
                value={form.concepto}
                onChange={handleChange}
                className="w-full border rounded-lg px-3 py-2"
                placeholder="Ej: Alquiler de cancha"
                required
              />
            </div>

            <div className="md:col-span-3">
              <label className="text-sm text-slate-600">Monto</label>
              <input
                type="number"
                name="monto"
                value={form.monto}
                onChange={handleChange}
                className="w-full border rounded-lg px-3 py-2"
                placeholder="Ej: 1500"
                required
              />
            </div>

            <div className="md:col-span-3">
              <label className="text-sm text-slate-600">Categor√≠a</label>
              <select
                name="categoria"
                value={form.categoria}
                onChange={handleChange}
                className="w-full border rounded-lg px-3 py-2"
              >
                {CATEGORIAS_GASTOS.map(c => <option key={c}>{c}</option>)}
              </select>
            </div>

            <div className="md:col-span-6 flex gap-2 justify-end">
              <button type="button" onClick={cancel} className="px-3 py-2 rounded-lg border">
                Cancelar
              </button>
              <button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">
                Guardar
              </button>
            </div>
          </form>
        ) : (
          <p className="text-sm text-slate-500">
            Hac√© clic en <b>+ Nuevo</b> para registrar un gasto.
          </p>
        )}
      </Card>

      <Card title={<span className="text-[#34745B]">Control de Gastos</span>}>
        <div className="flex flex-wrap items-center gap-2 mb-4">
          <PeriodoButton value="dia" current={periodo} setter={setPeriodo}>Hoy</PeriodoButton>
          <PeriodoButton value="semana" current={periodo} setter={setPeriodo}>Semana</PeriodoButton>
          <PeriodoButton value="mes" current={periodo} setter={setPeriodo}>Mes</PeriodoButton>
          <PeriodoButton value="a√±o" current={periodo} setter={setPeriodo}>A√±o</PeriodoButton>
        </div>

        <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl mb-4">
          <p className="text-sm text-slate-600">Total de Gastos</p>
          <p className="text-2xl font-bold text-slate-800">{formatCurrency(totalGastos)}</p>
        </div>

        <div className="overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead>
              <tr className="text-left text-slate-600">
                <th className="p-2">Fecha</th>
                <th className="p-2">Concepto</th>
                <th className="p-2">Monto</th>
                <th className="p-2">Categor√≠a</th>
                <th className="p-2 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {paginatedGastos.length === 0 && (
                <tr>
                  <td colSpan={5} className="text-center py-6 text-slate-400">
                    No hay gastos en este per√≠odo
                  </td>
                </tr>
              )}
              {paginatedGastos.map(g => (
                <tr key={g.id} className="border-t">
                  <td className="p-2">{g.fecha}</td>
                  <td className="p-2">{g.concepto}</td>
                  <td className="p-2">${g.monto}</td>
                  <td className="p-2">{g.categoria}</td>
                  <td className="p-2 text-right">
                    <div className="inline-flex gap-2">
                      <button onClick={() => openEdit(g)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button>
                      <button type="button" onClick={() => onDelete(g.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {totalPages > 1 && (
          <div className="mt-4 flex justify-center items-center gap-2">
            <button
              onClick={() => setCurrentPage(p => Math.max(p - 1, 1))}
              disabled={currentPage === 1}
              className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50"
            >
              Anterior
            </button>
            <span className="text-sm text-slate-600">
              P√°gina {currentPage} de {totalPages}
            </span>
            <button
              onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))}
              disabled={currentPage === totalPages}
              className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50"
            >
              Siguiente
            </button>
          </div>
        )}
      </Card>
    </div>
  );
}

    
function Reportes({ pagos, gastos, alumnos, clases, clubActivoId, clubes, perfil }) {
      const [periodo, setPeriodo] = useState("dia"); // Inicia por defecto en "Hoy"
      const [mesSeleccionado, setMesSeleccionado] = useState(formatDate(new Date()).slice(0, 7));
      const [fechaSeleccionada, setFechaSeleccionada] = useState(formatDate(new Date()));

      const filterByPeriod = useMemo(() => {
        return (item) => {
            const ahora = new Date();
            const itemDate = new Date(`${item.fecha}T00:00:00`);
            
            if (periodo === 'dia') return formatDate(itemDate) === formatDate(ahora);
            if (periodo === 'customDay') return formatDate(itemDate) === fechaSeleccionada;
            if (periodo === 'semana') return getWeekStartDate(itemDate).getTime() === getWeekStartDate(ahora).getTime();
            if (periodo === 'customMonth' && mesSeleccionado) {
                const [year, month] = mesSeleccionado.split('-');
                return itemDate.getFullYear() === parseInt(year) && (itemDate.getMonth() + 1) === parseInt(month);
            }
            if(periodo === 'mes') {
                return itemDate.getMonth() === ahora.getMonth() && itemDate.getFullYear() === ahora.getFullYear();
            }
            return false;
        };
      }, [periodo, mesSeleccionado, fechaSeleccionada]);

      const [pagosFiltrados, gastosFiltrados, clasesFiltradas] = useMemo(() => {
        const pagosF = pagos.filter(p => p.metodo !== 'Pendiente').filter(filterByPeriod);
        const gastosF = gastos.filter(filterByPeriod);
        const clasesF = clases.filter(c => c.estado === 'Realizada').filter(filterByPeriod);
        return [pagosF, gastosF, clasesF];
      }, [pagos, gastos, clases, filterByPeriod]);
      
      const totales = useMemo(() => {
        const totalIngresos = pagosFiltrados.reduce((acc, p) => acc + (parseFloat(p.monto) || 0), 0);
        const totalGastos = gastosFiltrados.reduce((acc, g) => acc + (parseFloat(g.monto) || 0), 0);
        return { ingresos: totalIngresos, gastos: totalGastos, balance: totalIngresos - totalGastos };
      }, [pagosFiltrados, gastosFiltrados]);
      
      const distribucionIngresos = useMemo(() => {
        const clubActivo = clubActivoId ? clubes.find(c => c.id === clubActivoId) : null;
        const porcentajeProfesor = clubActivo ? (clubActivo.reparto.coach || 0) / 100 : 1;
        const porcentajeClub = clubActivo ? (clubActivo.reparto.club || 0) / 100 : 0;
        const ingresosDeClases = pagosFiltrados
            .filter(p => p.claseId)
            .reduce((acc, p) => acc + (parseFloat(p.monto) || 0), 0);
        return {
            nombreLugar: clubActivo ? clubActivo.nombre : "Independiente",
            repartoTexto: clubActivo ? `${clubActivo.reparto.coach}% / ${clubActivo.reparto.club}%` : "100% Profesor",
            gananciaProfesor: ingresosDeClases * porcentajeProfesor,
            gananciaClub: ingresosDeClases * porcentajeClub,
            hayReparto: !!clubActivo
        };
      }, [pagosFiltrados, clubActivoId, clubes]);

const resumenClasesMes = useMemo(() => {
  const conteoPorTipo = clasesFiltradas.reduce((acc, clase) => {
    const tipoCanonico = normalizarTipoClase(clase.tipo || 'Clase 1 persona');
    const precio = parseFloat(clase.precio || 0);
    if (!acc[tipoCanonico]) {
      acc[tipoCanonico] = { cantidad: 0, valorTotal: 0 };
    }
    acc[tipoCanonico].cantidad += 1;
    acc[tipoCanonico].valorTotal += precio;
    return acc;
  }, {});

  return {
    totalClases: clasesFiltradas.length,
    valorTotalGeneral: clasesFiltradas.reduce((acc, c) => acc + parseFloat(c.precio || 0), 0),
    detalle: Object.entries(conteoPorTipo).sort((a, b) => b[1].cantidad - a[1].cantidad)
  };
}, [clasesFiltradas]);

      const PeriodoButton = ({ value, children }) => (
        <button 
            onClick={() => setPeriodo(value)} 
            className={`px-3 py-1.5 text-sm rounded-lg ${periodo === value ? 'bg-[#34745B] text-white hover:bg-green-800' : 'bg-white border text-slate-700 hover:bg-slate-50'}`}
        >
            {children}
        </button>
      );

      const handleExportToPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const nombreProfesor = `${perfil.nombre || ''} ${perfil.apellido || ''}`.trim();
    const nombreLugar = distribucionIngresos.nombreLugar;
    let periodoTexto = "";

    // Correction 1: Dynamically determine the report period text.
    if (periodo === 'dia') {
        periodoTexto = `el d√≠a de hoy (${formatDate(new Date(), 'dd/mm')})`;
    } else if (periodo === 'customDay') {
        periodoTexto = `el d√≠a ${formatDate(new Date(fechaSeleccionada + 'T00:00:00'), 'dd/mm')}`;
    } else if (periodo === 'semana') {
        periodoTexto = `la semana actual`;
    } else if (periodo === 'mes') {
        const currentMonthName = MESES_NOMBRES[new Date().getMonth()];
        const currentYear = new Date().getFullYear();
        periodoTexto = `El mes de ${currentMonthName} de ${currentYear}`;
    } else if (periodo === 'customMonth' && mesSeleccionado) {
        const [year, month] = mesSeleccionado.split('-');
        const selectedMonthName = MESES_NOMBRES[parseInt(month) - 1];
        periodoTexto = `El mes de ${selectedMonthName} de ${year}`;
    }

    let finalY = 20;
    doc.setFontSize(18);
    doc.text("Reporte de Actividad", 14, finalY);
    finalY += 10;
    doc.setFontSize(11);
    doc.text(`Profesor/a: ${nombreProfesor}`, 14, finalY);
    finalY += 6;
    doc.text(`Lugar de Trabajo: ${nombreLugar}`, 14, finalY);
    finalY += 6;
    doc.text(`Per√≠odo del Reporte: ${periodoTexto}`, 14, finalY);
    finalY += 10;
    doc.setFontSize(14);
    doc.text("Resumen de Clases Realizadas", 14, finalY);
    finalY += 8;
    doc.setFontSize(11);
    doc.text(`Total de Clases: ${resumenClasesMes.totalClases}`, 14, finalY);
    doc.text(`Valor Bruto Generado: ${formatCurrency(resumenClasesMes.valorTotalGeneral)}`, 100, finalY);
    finalY += 6;
    const tableHead = [['Tipo de Clase', 'Cantidad', 'Valor Generado']];
    
    // Correction 2: Sort the class types alphabetically before mapping.
    const tableBody = resumenClasesMes.detalle
    .sort(([tipoA], [tipoB]) => (TIPOS_CLASE_NOMBRES[tipoA] || tipoA).localeCompare(TIPOS_CLASE_NOMBRES[tipoB] || tipoB))
    .map(([tipo, data]) => [
        TIPOS_CLASE_NOMBRES[tipo] || tipo,
        data.cantidad,
        `${formatCurrency(data.valorTotal)}`
    ]);

    doc.autoTable({ head: tableHead, body: tableBody, startY: finalY, theme: 'grid' });
    finalY = doc.lastAutoTable.finalY + 12;
    doc.setFontSize(14);
    doc.text("Distribuci√≥n de Ingresos", 14, finalY);
    finalY += 8;
    doc.setFontSize(11);
    doc.text(`(Reparto: ${distribucionIngresos.repartoTexto})`, 14, finalY);
    finalY += 8;
    doc.text(`Ganancia Neta Profesor: ${formatCurrency(distribucionIngresos.gananciaProfesor)}`, 14, finalY);
    finalY += 8;
    doc.text(`Ganancia Club: ${formatCurrency(distribucionIngresos.gananciaClub)}`, 14, finalY);
    doc.save(`Reporte_${nombreLugar.replace(/ /g, '_')}_${periodo === 'customDay' ? fechaSeleccionada : mesSeleccionado}.pdf`);
};
      
      return (
        <div className="grid gap-6">
          <Card title={<span className="text-[#34745B]">Reportes Financieros y Operativos</span>}>
            <div className="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4">
              <div className="flex items-center gap-2">
                <PeriodoButton value="dia">Hoy</PeriodoButton>
                <PeriodoButton value="semana">Esta Semana</PeriodoButton>
                <PeriodoButton value="mes">Este Mes</PeriodoButton>
              </div>
              <div className="flex items-center gap-2">
                <label htmlFor="fecha-reporte" className="text-sm text-slate-600">Ver d√≠a:</label>
                <input
                    type="date"
                    id="fecha-reporte"
                    value={fechaSeleccionada}
                    onChange={(e) => {
                        setFechaSeleccionada(e.target.value);
                        setPeriodo('customDay');
                    }}
                    className="border rounded-lg px-3 py-1.5 text-sm"
                />
              </div>
              <div className="flex items-center gap-2">
                <label htmlFor="mes-reporte" className="text-sm text-slate-600">Ver mes:</label>
                <input
                    type="month"
                    id="mes-reporte"
                    value={mesSeleccionado}
                    onChange={(e) => {
                        setMesSeleccionado(e.target.value);
                        setPeriodo('customMonth');
                    }}
                    className="border rounded-lg px-3 py-1.5 text-sm"
                />
              </div>
              <div className="flex-grow text-right">
                <button 
                  onClick={handleExportToPDF} 
                  className="px-4 py-2 text-sm rounded-lg bg-white border border-[#34745B] text-[#34745B] hover:bg-green-50 font-semibold"
                >
                  Descargar PDF
                </button>
              </div>
            </div>
            
            <div className="p-4 border rounded-xl bg-slate-50">
                <h3 className="text-lg font-semibold text-[#4A4A4A] mb-3">Resumen Financiero General</h3>
                <div className="grid md:grid-cols-3 gap-4">
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl"><p className="text-sm text-green-800">Total Ingresos</p><p className="text-2xl font-bold text-[#34745B]">{formatCurrency(totales.ingresos)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Total Gastos</p><p className="text-2xl font-bold text-slate-800">{formatCurrency(totales.gastos)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Balance Neto</p><p className={`text-2xl font-bold ${totales.balance >= 0 ? 'text-slate-800' : 'text-red-900'}`}>{formatCurrency(totales.balance)}</p></div>
                </div>
            </div>

            <div className="p-4 border rounded-xl bg-slate-50 mt-4">
                <div className="mb-3">
                    <h3 className="text-lg font-semibold text-[#4A4A4A]">Distribuci√≥n de Ingresos por Clases</h3>
                    <p className="text-sm text-slate-500">Resultados para: <span className="font-bold">{distribucionIngresos.nombreLugar}</span> (Reparto: {distribucionIngresos.repartoTexto})</p>
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl"><p className="text-sm text-green-800">Ganancia Neta Profesor</p><p className="text-2xl font-bold text-[#34745B]">{formatCurrency(distribucionIngresos.gananciaProfesor)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Ganancia Club</p><p className="text-2xl font-bold text-slate-800">{formatCurrency(distribucionIngresos.gananciaClub)}</p></div>
                </div>
                {!distribucionIngresos.hayReparto && <p className="text-xs text-slate-400 mt-2">En modo independiente, todos los ingresos de clases se consideran ganancia del profesor.</p>}
            </div>

            <div className="p-4 border rounded-xl bg-slate-50 mt-4">
                <h3 className="text-lg font-semibold text-[#4A4A4A]">Resumen de Clases Realizadas</h3>
                <p className="text-sm text-slate-500">Resultados para el per√≠odo seleccionado</p>
                {resumenClasesMes.totalClases > 0 ? (
                    <div className="mt-3">
                        <div className="flex items-center justify-between border-b pb-2 mb-2">
                            <div>
                                <p className="text-slate-600">Total de Clases</p>
                                <p className="text-3xl font-bold text-[#34745B]">{resumenClasesMes.totalClases}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-slate-600">Valor Generado por Clases</p>
                                <p className="text-3xl font-bold text-[#34745B]">{formatCurrency(resumenClasesMes.valorTotalGeneral)}</p>
                            </div>
                        </div>
                        <ul className="text-sm text-slate-700 mt-2 space-y-2">
                            {resumenClasesMes.detalle.map(([tipo, data]) => (
                                <li key={tipo} className="flex justify-between items-center bg-white p-2 rounded-md">
                                    <span>
                                        <strong>{data.cantidad}</strong> {data.cantidad > 1 ? 'clases' : 'clase'} de <strong>{labelSinClase(tipo)}</strong>
                                    </span>
                                    <span className="font-semibold text-slate-800">
                                        {formatCurrency(data.valorTotal)}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    </div>
                ) : (
                    <p className="text-sm text-slate-500 mt-4">No se encontraron clases realizadas en este per√≠odo.</p>
                )}
            </div>
          </Card>
        </div>
      );
    }
    // Pega esta nueva funci√≥n en tu archivo

function GestionClubes({ user }) {
  const [clubes, setClubes] = useState([]);
  const [activoId, setActivoId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [form, setForm] = useState({
    nombre: "",
    modalidadPrincipal: "por_clase",
    ubicaciones: [],
    reparto: { coach: 60, club: 40 },
    preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0 },
    preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0 },
    horarioLaboral: { bloques: [] }
  });

  const clubsCollection = useMemo(() => {
    if (!user) return null;
    return db.collection('users').doc(user.uid).collection('clubs');
  }, [user]);

  // Cargar clubes + seleccionar primero
  useEffect(() => {
    if (!clubsCollection) return;
    setLoading(true);
    const unsubscribe = clubsCollection.onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setClubes(data);
      if (!activoId && data.length) setActivoId(data[0].id);
      setLoading(false);
    });
    return () => unsubscribe();
  }, [clubsCollection]);

  // Cargar datos del club activo al form
  useEffect(() => {
    if (!activoId || !clubsCollection) return;
    const unsub = clubsCollection.doc(activoId).onSnapshot(doc => {
      const d = doc.data() || {};
      setForm({
        nombre: d.nombre || "",
        modalidadPrincipal: d.modalidadPrincipal || "por_clase",
        ubicaciones: d.ubicaciones || [],
        reparto: d.reparto || { coach: 60, club: 40 },
        preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0, ...(d.preciosClase||{}) },
        preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0, ...(d.preciosMensuales||{}) },
        horarioLaboral: d.horarioLaboral || { bloques: [] },
      });
    });
    return () => unsub();
  }, [activoId, clubsCollection]);

  async function crearClub() {
  // ‚¨áÔ∏è Agregado: refrescar usuario y exigir email verificado
  const u = auth.currentUser;
if (!u) return;
await u.reload();
const t = await u.getIdTokenResult();
if (!t.claims.email_verified) { alert("Verific√° tu email para continuar"); return; }
await u.getIdToken(true);

  if (!clubsCollection) return;
  const base = {
    nombre: "Nuevo Club",
    modalidadPrincipal: "por_clase",
    ubicaciones: [],
    reparto: { coach: 60, club: 40 },
    preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0 },
    preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0 },
    horarioLaboral: { bloques: [] },
    createdAt: new Date().toISOString()
  };
  const ref = await clubsCollection.add(base);
  setActivoId(ref.id);
}

  async function eliminarClub(id) {
    if (!clubsCollection || !id) return;
    if (!confirm("¬øEliminar este club? Esta acci√≥n no se puede deshacer.")) return;
    await clubsCollection.doc(id).delete();
    if (activoId === id) {
      const rest = clubes.filter(c => c.id !== id);
      setActivoId(rest[0]?.id || null);
    }
  }

  async function guardarClub() {
  // ‚¨áÔ∏è Agregado: refrescar usuario y exigir email verificado
  const u = auth.currentUser;
if (!u) return;
await u.reload();
const t = await u.getIdTokenResult();
if (!t.claims.email_verified) { alert("Verific√° tu email para continuar"); return; }
await u.getIdToken(true);
  if (!clubsCollection || !activoId) {
    alert("No hay club activo");
    return;
  }
  await clubsCollection
    .doc(activoId)
    .set({ ...form, updatedAt: new Date().toISOString() }, { merge: true });
// Despu√©s de guardar el doc del club:
const baseRef = clubsCollection.doc(activoId);

// Sincroniz√° los precios Y LAS CANCHAS al Perfil del Club
await baseRef.collection('perfil').doc('main').set({
  preciosClase: form.preciosClase || {},
  preciosMensuales: form.preciosMensuales || {},
  canchasUbicaciones: form.ubicaciones || [], // <-- L√çNEA A√ëADIDA
  updatedAt: new Date().toISOString(),
}, { merge: true });

  alert("Configuraci√≥n del club guardada");
}

  // UI helpers
  const dias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
  const setField = (k, v) => setForm(f => ({ ...f, [k]: v }));
  function addUbicacion() { setField('ubicaciones', [...(form.ubicaciones||[]), ""]); }
  function updUbicacion(i, val) { const u=[...(form.ubicaciones||[])]; u[i]=val; setField('ubicaciones', u); }
  function delUbicacion(i) { const u=[...(form.ubicaciones||[])]; u.splice(i,1); setField('ubicaciones', u); }
  function addBloque() { setField('horarioLaboral', { bloques: [ ...(form.horarioLaboral?.bloques||[]), { dia:"Lunes", desde:"08:00", hasta:"12:00" } ]}); }
  function updBloque(i, patch) { const b=[...(form.horarioLaboral?.bloques||[])]; b[i]={...b[i], ...patch}; setField('horarioLaboral', { bloques: b }); }
  function delBloque(i) { const b=[...(form.horarioLaboral?.bloques||[])]; b.splice(i,1); setField('horarioLaboral', { bloques: b }); }

  if (loading) return <div className="text-sm opacity-70">Cargando clubes‚Ä¶</div>;

  return (
    <div className="space-y-6">
      {/* Selector + Acciones */}
      <div className="flex flex-wrap items-center gap-2">
        <select className="border rounded-xl px-3 py-2" value={activoId || ""} onChange={e=>setActivoId(e.target.value)}>
          {clubes.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}
        </select>
        <button className="px-3 py-2 rounded-xl border" onClick={crearClub}>Nuevo club</button>
        {activoId && <button className="px-3 py-2 rounded-xl border text-red-600" onClick={()=>eliminarClub(activoId)}>Eliminar</button>}
        <div className="grow" />
        <button className="px-3 py-2 rounded-xl bg-black text-white" onClick={guardarClub}>Guardar cambios</button>
      </div>

      {/* --- NUEVA ESTRUCTURA HORIZONTAL --- */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* Columna Izquierda de Configuraci√≥n */}
        <div className="space-y-4 p-4 border rounded-2xl bg-white">
          <h3 className="font-semibold">Configuraci√≥n General</h3>
          <label className="block text-sm">Nombre del Club</label>
          <input className="w-full border rounded-xl px-3 py-2" value={form.nombre} onChange={e=>setField('nombre', e.target.value)} />
          <label className="block text-sm mt-3">Modalidad de Cobro Principal</label>
          <select className="w-full border rounded-xl px-3 py-2" value={form.modalidadPrincipal} onChange={e=>setField('modalidadPrincipal', e.target.value)}>
            <option value="por_clase">Por Clase</option>
            <option value="mensual">Mensual</option>
          </select>
          <div className="grid grid-cols-2 gap-3 mt-3 items-end">
            <div>
              <label className="block text-sm">Reparto % (Coach)</label>
              <input type="number" className="w-full border rounded-xl px-3 py-2" value={form.reparto.coach} onChange={e=>setField('reparto', { coach:Number(e.target.value)||0, club: Number(form.reparto.club||0) })} />
            </div>
            <div>
              <label className="block text-sm">Reparto % (Club)</label>
              <input type="number" className="w-full border rounded-xl px-3 py-2" value={form.reparto.club} onChange={e=>setField('reparto', { coach:Number(form.reparto.coach||0), club: Number(e.target.value)||0 })} />
            </div>
            <div className="col-span-2 text-xs opacity-70">Debe sumar 100%. Actual: {(Number(form.reparto.coach||0)+Number(form.reparto.club||0))}%</div>
          </div>
          <div className="mt-3">
            <label className="block text-sm">Canchas / Ubicaciones</label>
            <div className="space-y-2">
              {(form.ubicaciones||[]).map((u,i)=>(<div key={i} className="flex gap-2"><input className="flex-1 border rounded-xl px-3 py-2" value={u} onChange={e=>updUbicacion(i, e.target.value)} /><button className="px-3 py-2 rounded-xl border" onClick={()=>delUbicacion(i)}>Quitar</button></div>))}
            </div>
            <button className="mt-2 px-3 py-2 rounded-xl border" onClick={addUbicacion}>Agregar ubicaci√≥n</button>
          </div>
        </div>

        {/* Columna Derecha de Horarios */}
        <div className="space-y-4 p-4 border rounded-2xl bg-white">
          <h3 className="font-semibold">Horario Laboral (por club)</h3>
          <div className="space-y-2 max-h-80 overflow-y-auto pr-2">
            {(form.horarioLaboral?.bloques||[]).map((b,i)=>(
              <div key={i} className="grid grid-cols-4 gap-2 items-center">
                <select className="border rounded-xl px-3 py-2" value={b.dia} onChange={e=>updBloque(i,{dia:e.target.value})}>{dias.map(d=><option key={d} value={d}>{d}</option>)}</select>
                <input type="time" className="border rounded-xl px-3 py-2" value={b.desde} onChange={e=>updBloque(i,{desde:e.target.value})}/>
                <input type="time" className="border rounded-xl px-3 py-2" value={b.hasta} onChange={e=>updBloque(i,{hasta:e.target.value})}/>
                <button className="px-3 py-2 rounded-xl border" onClick={()=>delBloque(i)}>Quitar</button>
              </div>
            ))}
          </div>
          <button className="px-3 py-2 rounded-xl border" onClick={addBloque}>Agregar bloque</button>
        </div>
      </div>

      {/* --- SECCI√ìN DE PRECIOS A TODO LO ANCHO --- */}
      <div className="grid md:grid-cols-2 gap-6">
        <div className="p-4 border rounded-2xl space-y-3 bg-white">
          <h3 className="font-semibold">Precios por Clase</h3>
          {["individual","dupla","trio","cuarteto","escuelita"].map(k=>(<div key={k} className="grid grid-cols-2 gap-2 items-center"><div className="text-sm capitalize">{k}</div><input type="number" className="border rounded-xl px-3 py-2" value={form.preciosClase[k] ?? 0} onChange={e=>setField('preciosClase', { ...(form.preciosClase||{}), [k]: Number(e.target.value)||0 })} /></div>))}
        </div>
        <div className="p-4 border rounded-2xl space-y-3 bg-white">
          <h3 className="font-semibold">Precios Mensuales</h3>
          {[["1xSemana","1 vez por semana"],["2xSemana","2 veces por semana"],["3xSemana","3 veces por semana"],["libre","Libre"]].map(([key,label])=>(<div key={key} className="grid grid-cols-2 gap-2 items-center"><div className="text-sm">{label}</div><input type="number" className="border rounded-xl px-3 py-2" value={form.preciosMensuales[key] ?? 0} onChange={e=>setField('preciosMensuales', { ...(form.preciosMensuales||{}), [key]: Number(e.target.value)||0 })} /></div>))}
        </div>
      </div>
    </div>
  );
}
    
function Perfil({ perfil, alumnos, clases, pagos, gastos, grupos, onUpdate, user, setToast, getCollection, perfilCrud, clubActivoId }) {
  const fileInputRef = React.useRef(null);

  // === Estado inicial seguro (strings) ===
  const emptyPerfil = {
    moneda: 'ARS',
    preciosClase: { individual:'', dupla:'', trio:'', cuarteto:'', escuelita:'' },
    preciosMensuales: { "1xSemana":'', "2xSemana":'', "3xSemana":'', "libre":'' },
    preciosServicios: { luz_30min: '', luz_60min: '', luz_90min: '', luz_120min: '' },
    datosBancarios: { alias:'', cbu:'', banco:'', titular: '' },
    horarioLaboral: (initialState?.perfil?.horarioLaboral) || [],
    modoTrabajo: 'Club',
    pin: ''
  };
  const [form, setForm] = useState(emptyPerfil);

  // === Estados para el componente ===
  const [pinInput, setPinInput] = useState({ newPin: "", confirmPin: "" });
  const [plantillas, setPlantillas] = useState([]);
  const [plantillaSeleccionada, setPlantillaSeleccionada] = useState(null);
  const [mensajePersonalizado, setMensajePersonalizado] = useState("");
  const [destinatarios, setDestinatarios] = useState([]);
  const [busquedaAlumno, setBusquedaAlumno] = useState("");
  const [listaBusquedaAbierta, setListaBusquedaAbierta] = useState(false);
  const [editingPlantilla, setEditingPlantilla] = useState(null);
  const { abrirModalPago, Modal: ModalAbono } = useModalPagoAbono();

  // === Estados para el flujo de modales ===
  const [wipeStep, setWipeStep] = useState(0); // 0: inactivo, 1: confirmar, 2: escribir texto, 3: ingresar PIN
  const [confirmDeleteInfo, setConfirmDeleteInfo] = useState(null); // Para confirmaciones gen√©ricas

  // === Carga de Datos ===
  useEffect(() => {
    if (!user) return;
    const plantillasCollection = db.collection('users').doc(user.uid).collection('plantillas');
    const unsubscribe = plantillasCollection.onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setPlantillas(data);
    });
    return () => unsubscribe();
  }, [user]);

  useEffect(() => {
    const S = (v) => (v == null ? '' : String(v));
    const p = perfil || {};
    const pc = p.preciosClase || p.precios || {};
    setForm(prev => ({
      ...prev,
      nombre: p.nombre || '',
      apellido: p.apellido || '',
      telefono: p.telefono || '',
      moneda: p.moneda ?? 'ARS',
      datosBancarios: { ...(prev.datosBancarios||{}), ...(p.datosBancarios||{}) },
      horarioLaboral: p.horarioLaboral || prev.horarioLaboral,
      pin: p.pin ?? '',
      preciosClase: {
        individual: S(pc.individual),
        dupla:      S(pc.dupla ?? pc.duo),
        trio:       S(pc.trio),
        cuarteto:   S(pc.cuarteto),
        escuelita:  S(pc.escuelita),
      },
      preciosMensuales: {
        "1xSemana": S(p.preciosMensuales?.["1xSemana"]),
        "2xSemana": S(p.preciosMensuales?.["2xSemana"]),
        "3xSemana": S(p.preciosMensuales?.["3xSemana"]),
        "libre":    S(p.preciosMensuales?.["libre"]),
      },
      preciosServicios: p.preciosServicios || emptyPerfil.preciosServicios,
    }));
  }, [perfil]);

  // === Handlers de Formularios ===
  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, [name]: value ?? '' }));
  };
  const handleDatosBancariosChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, datosBancarios: { ...prev.datosBancarios, [name]: value ?? '' } }));
  };
  const handleHorarioChange = (index, campo, valor) => {
    setForm(prev => {
      const nuevo = Array.isArray(prev.horarioLaboral) ? [...prev.horarioLaboral] : [];
      nuevo[index] = { ...(nuevo[index]||{}), [campo]: valor ?? '' };
      return { ...prev, horarioLaboral: nuevo };
    });
  };
  const handlePrecioClaseChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, preciosClase: { ...prev.preciosClase, [name]: value ?? '' } }));
  };
  const handlePrecioMensualChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, preciosMensuales: { ...prev.preciosMensuales, [name]: value ?? '' } }));
  };
  const handlePreciosServiciosChange = (e) => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, preciosServicios: { ...prev.preciosServicios, [name]: value } }));
  };

  // === Handler de PIN ===
  const handleSetPin = () => {
    if (pinInput.newPin.length !== 3 || !/^\d{3}$/.test(pinInput.newPin)) {
      setToast("El PIN debe ser exactamente de 3 n√∫meros.");
      return;
    }
    if (pinInput.newPin !== pinInput.confirmPin) {
      setToast("Los PINs no coinciden.");
      return;
    }
    setForm(prev => ({ ...prev, pin: pinInput.newPin }));
    setToast("PIN actualizado. No olvides guardar los cambios.");
    setPinInput({ newPin: "", confirmPin: "" });
  };
  const handlePinInputChange = (e) => {
    const { name, value } = e.target;
    if (/^\d*$/.test(value) && value.length <= 3) {
      setPinInput(prev => ({ ...prev, [name]: value }));
    }
  };

  // === Gesti√≥n de Datos ===
  const sanitizeDataForJSON = (data) => {
    const replacer = (key, value) => (value === undefined ? null : value);
    return JSON.parse(JSON.stringify(data, replacer));
  };
  
  const handleExportData = () => {
    const dataToExport = {
      alumnos, clases, pagos, gastos, grupos, otrosIngresos: (state && state.otrosIngresos) || [], perfil
    };
    const sanitizedData = sanitizeDataForJSON(dataToExport);
    const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(sanitizedData, null, 2))}`;
    const link = document.createElement("a");
    link.href = jsonString;
    const date = new Date().toISOString().slice(0, 10);
    link.download = `coachex_backup_${clubActivoId}_${date}.json`;
    link.click();
    setToast("Backup de datos exportado con √©xito.");
  };

  const handleImportData = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      setConfirmDeleteInfo({
          title: "Importar Datos",
          message: "¬°ATENCI√ìN! Al importar datos, se borrar√°n TODOS los datos existentes del club actual y se reemplazar√°n por los del archivo. ¬øDeseas continuar?",
          onConfirm: async () => {
              try {
                const importedData = JSON.parse(e.target.result);
                if (!user || !clubActivoId) throw new Error("Usuario o club no identificado.");
                setToast("Iniciando importaci√≥n... Esto puede tardar.");
                const baseRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId);
                const collectionsToWipe = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos', 'otrosIngresos', 'mensualidades', 'perfil'];
                for (const coll of collectionsToWipe) {
                  const snapshot = await baseRef.collection(coll).get();
                  const batch = db.batch();
                  snapshot.docs.forEach(doc => batch.delete(doc.ref));
                  await batch.commit();
                }
                for (const coll of collectionsToWipe) {
                  if (Array.isArray(importedData[coll])) {
                    const batch = db.batch();
                    (importedData[coll] || []).forEach(item => {
                      const docRef = item.id ? baseRef.collection(coll).doc(item.id) : baseRef.collection(coll).doc();
                      batch.set(docRef, item);
                    });
                    await batch.commit();
                  }
                }
                if (importedData.perfil) {
                  await baseRef.collection('perfil').doc('main').set(importedData.perfil);
                }
                setToast("¬°Importaci√≥n completada con √©xito!");
              } catch (error) {
                console.error("Error al importar:", error);
                setToast("Error al importar el archivo. Revisa que sea un backup v√°lido.");
              } finally {
                event.target.value = null;
              }
          },
          onCancel: () => {
              event.target.value = null;
          }
      });
    };
    reader.readAsText(file);
  };
  
  const handleWipeData = () => {
    setWipeStep(1); 
  };

  const executeWipe = async () => {
    try {
      if (!user || !clubActivoId) throw new Error("Usuario o club no identificado.");
      setToast("Borrando datos... Por favor espera.");
      const baseRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId);
      const collections = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos', 'otrosIngresos', 'mensualidades', 'perfil', 'rankings', 'torneos'];
      for (const coll of collections) {
        while (true) {
          const snapshot = await baseRef.collection(coll).limit(500).get();
          if (snapshot.size === 0) break;
          const batch = db.batch();
          snapshot.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
        }
      }
      setToast("¬°Todos los datos del club han sido eliminados!");
    } catch(error) {
      console.error("Error al borrar datos:", error);
      setToast("Error: No se pudieron borrar los datos.");
    } finally {
      setWipeStep(0);
    }
  };

  // === Comunicaciones ===
  const alumnosFiltrados = useMemo(() => {
    return (alumnos || []).filter(a => a.estado === 'activo' && getNombreCompleto(a).toLowerCase().includes(busquedaAlumno.toLowerCase()));
  }, [busquedaAlumno, alumnos]);

  const handleAgregarDestinatario = (alumno) => {
    if (!destinatarios.some(d => d.id === alumno.id)) {
      setDestinatarios(prev => [...prev, alumno]);
    }
    setBusquedaAlumno("");
    setListaBusquedaAbierta(false);
  };

  const handleQuitarDestinatario = (alumnoId) => {
    setDestinatarios(prev => prev.filter(d => d.id !== alumnoId));
  };

  const handleSendMessage = (destinatario) => {
    const mensajeFinal = mensajePersonalizado.replace(/{nombre_alumno}/g, destinatario.nombre || '');
    const link = waLink(destinatario.telefono, destinatario.nombre, mensajeFinal);
    if (link) {
      window.open(link, '_blank');
    } else {
      setToast(`El alumno ${getNombreCompleto(destinatario)} no tiene un tel√©fono v√°lido.`);
    }
  };

  const handleSavePlantilla = (plantillaData) => {
    if (!user) return;
    const plantillasCollection = db.collection('users').doc(user.uid).collection('plantillas');
    if (plantillaData.id) {
      const { id, ...data } = plantillaData;
      plantillasCollection.doc(id).update(data).then(() => { setToast("Plantilla actualizada"); });
    } else {
      plantillasCollection.add(plantillaData).then(() => { setToast("Plantilla creada"); });
    }
    setEditingPlantilla(null);
  };

  const handleDeletePlantilla = () => {
    if (!plantillaSeleccionada) return;
    setConfirmDeleteInfo({
        title: "Eliminar Plantilla",
        message: `¬øEst√°s seguro de que quieres eliminar la plantilla "${plantillaSeleccionada.titulo}"?`,
        onConfirm: () => {
            db.collection('users').doc(user.uid).collection('plantillas').doc(plantillaSeleccionada.id).delete().then(() => {
                setToast("Plantilla eliminada");
                setPlantillaSeleccionada(null);
                setMensajePersonalizado("");
            });
        }
    });
  };

  // === Guardado y Submit ===
  async function guardarPerfil() {
    try {
      const u = auth.currentUser;
      if (!u) return;
      await u.reload();
      const tok = await u.getIdTokenResult();
      if (!tok.claims.email_verified) { setToast?.("Verific√° tu email para continuar"); return; }
      await u.getIdToken(true);
      const payload = {
        nombre: form.nombre || '',
        apellido: form.apellido || '',
        telefono: form.telefono || '',
        moneda: form.moneda || 'ARS',
        datosBancarios: form.datosBancarios || {},
        horarioLaboral: form.horarioLaboral || [],
        pin: form.pin || null,
        preciosClase: {
          individual: Number(form.preciosClase?.individual) || 0,
          dupla:      Number(form.preciosClase?.dupla) || 0,
          trio:       Number(form.preciosClase?.trio) || 0,
          cuarteto:   Number(form.preciosClase?.cuarteto) || 0,
          escuelita:  Number(form.preciosClase?.escuelita) || 0,
        },
        preciosMensuales: {
          "1xSemana": Number(form.preciosMensuales?.["1xSemana"]) || 0,
          "2xSemana": Number(form.preciosMensuales?.["2xSemana"]) || 0,
          "3xSemana": Number(form.preciosMensuales?.["3xSemana"]) || 0,
          "libre":    Number(form.preciosMensuales?.["libre"])    || 0,
        },
        preciosServicios: {
            luz_30min: Number(form.preciosServicios?.luz_30min) || 0,
            luz_60min: Number(form.preciosServicios?.luz_60min) || 0,
            luz_90min: Number(form.preciosServicios?.luz_90min) || 0,
            luz_120min: Number(form.preciosServicios?.luz_120min) || 0,
        },
        updatedAt: new Date().toISOString(),
      };
      if (perfilCrud && typeof perfilCrud.update === 'function') {
        await perfilCrud.update(payload);
      }
      setToast?.("Perfil guardado");
    } catch (e) {
      console.error("Error guardando perfil:", e);
      setToast?.("Error al guardar el perfil");
    }
  }

  const handleSubmit = async (e) => {
    e.preventDefault();
    await guardarPerfil();
  };
  const handlePasswordReset = () => {
      if(user && user.email) {
          auth.sendPasswordResetEmail(user.email)
              .then(() => setToast("Email para restablecer contrase√±a enviado."))
              .catch((error) => setToast(`Error: ${error.message}`));
      }
  };

  return (
    <>
      <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
        <Card title={<span className="text-[#34745B]">Perfil y Configuraci√≥n</span>}>
          <h4 className="text-md font-semibold text-slate-700 mb-2">Datos Personales</h4>
          <div className="grid gap-3">
            <div><label className="text-sm text-slate-600">Nombre del Profesor</label><input name="nombre" value={form.nombre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
            <div><label className="text-sm text-slate-600">Apellido</label><input name="apellido" value={form.apellido} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
            <div><label className="text-sm text-slate-600">Tel√©fono</label><input name="telefono" value={form.telefono} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
          </div>
          <div className="mt-6 border-t pt-6">
            <h4 className="text-md font-semibold text-slate-700 mb-2">Configuraci√≥n General</h4>
            <div>
              <label className="text-sm text-slate-600">Modo de Trabajo Principal</label>
              <select name="modoTrabajo" value={form.modoTrabajo || 'Club'} onChange={handleChange} className="w-full mt-1 border rounded-lg px-3 py-2">
                <option value="Club">Solo Clubes</option>
              </select>
            </div>
          </div>
          <div className="mt-6 border-t pt-6">
              <h4 className="text-md font-semibold text-slate-700 mb-2">Cuenta</h4>
              <div className="grid gap-3">
                <div>
                  <label className="text-sm text-slate-600">Email de la cuenta</label>
                  <p className="w-full bg-slate-100 rounded-lg px-3 py-2 text-slate-700">{user?.email}</p>
                </div>
                <div><button type="button" onClick={handlePasswordReset} className="w-full px-4 py-2 rounded-lg border text-sm bg-slate-100 hover:bg-slate-200">Restablecer Contrase√±a</button></div>
              </div>
          </div>
        </Card>
        
        <div className="space-y-6">
          <Card title={<span className="text-[#34745B]">Datos Bancarios para Transferencias</span>}>
  <div className="grid gap-4">
    {['alias', 'cbu', 'banco', 'titular'].map(field => (
      <div key={field}>
        <label className="text-sm font-medium text-slate-600 capitalize">{field}</label>
        <div className="flex gap-2 mt-1">
          <input 
            type="text" 
            name={field} 
            value={(form.datosBancarios || {})[field] || ''} 
            onChange={handleDatosBancariosChange} 
            className="w-full border rounded-lg px-3 py-2" 
          />
          <button 
            type="button" 
            onClick={() => {
              navigator.clipboard.writeText((form.datosBancarios || {})[field] || '');
              setToast(`${field.toUpperCase()} copiado al portapapeles`);
            }} 
            className="px-3 py-2 rounded-lg border text-sm hover:bg-slate-100"
          >
            Copiar
          </button>
        </div>
      </div>
    ))}
  </div>
</Card>
          <Card title={<span className="text-[#34745B]">Precios de Servicios Adicionales</span>}>
            <h4 className="text-md font-semibold text-slate-700 mb-2">Luz Artificial</h4>
            <div className="grid grid-cols-2 gap-4">
              <div><label className="text-sm text-slate-600">Precio por 30 min</label><input type="number" name="luz_30min" value={form.preciosServicios?.luz_30min || ''} onChange={handlePreciosServiciosChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div><label className="text-sm text-slate-600">Precio por 60 min (1 hr)</label><input type="number" name="luz_60min" value={form.preciosServicios?.luz_60min || ''} onChange={handlePreciosServiciosChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div><label className="text-sm text-slate-600">Precio por 90 min</label><input type="number" name="luz_90min" value={form.preciosServicios?.luz_90min || ''} onChange={handlePreciosServiciosChange} className="w-full border rounded-lg px-3 py-2" /></div>
              <div><label className="text-sm text-slate-600">Precio por 120 min (2 hs)</label><input type="number" name="luz_120min" value={form.preciosServicios?.luz_120min || ''} onChange={handlePreciosServiciosChange} className="w-full border rounded-lg px-3 py-2" /></div>
            </div>
          </Card>
        </div>

        <div className="md:col-span-2">
          <Card title={<span className="text-[#34745B]">Centro de Comunicaciones</span>}>
              <div className="grid gap-4">
                  <div>
                      <label className="text-sm font-medium text-slate-600">1. Elige una plantilla o escribe un mensaje</label>
                      <div className="flex gap-2 mt-1">
                          <select className="w-full border rounded-lg px-3 py-2" value={plantillaSeleccionada ? plantillaSeleccionada.id : ""} onChange={(e) => { const p = plantillas.find(p => p.id === e.target.value); setPlantillaSeleccionada(p || null); setMensajePersonalizado(p ? p.texto : ""); }}>
                              <option value="">Seleccionar plantilla...</option>
                              {plantillas.map(p => (<option key={p.id} value={p.id}>{p.titulo}</option>))}
                          </select>
                          <button type="button" onClick={() => setEditingPlantilla({})} className="px-3 py-2 text-sm rounded-lg bg-[#34745B] hover:bg-green-800 text-white whitespace-nowrap">+ Nueva</button>
                          <button type="button" onClick={() => plantillaSeleccionada && setEditingPlantilla(plantillaSeleccionada)} disabled={!plantillaSeleccionada} className="px-3 py-2 text-sm rounded-lg border disabled:opacity-50">Editar</button>
                          <button type="button" onClick={handleDeletePlantilla} disabled={!plantillaSeleccionada} className="px-3 py-2 text-sm rounded-lg border text-red-600 disabled:opacity-50">Eliminar</button>
                      </div>
                      <textarea value={mensajePersonalizado} onChange={(e) => setMensajePersonalizado(e.target.value)} className="w-full mt-2 border rounded-lg px-3 py-2" rows={5} placeholder="O escribe un mensaje personalizado aqu√≠... Usa {nombre_alumno} para personalizar." />
                  </div>
                  <div className="relative">
                      <label className="text-sm font-medium text-slate-600">2. Selecciona los destinatarios</label>
                      <input type="text" value={busquedaAlumno} onChange={(e) => { setBusquedaAlumno(e.target.value); setListaBusquedaAbierta(true); }} onBlur={() => setTimeout(() => setListaBusquedaAbierta(false), 200)} placeholder="Escribe para buscar alumnos..." className="w-full mt-1 border rounded-lg px-3 py-2" />
                      {listaBusquedaAbierta && busquedaAlumno && (
                          <ul className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg">
                              {alumnosFiltrados.length > 0 ? alumnosFiltrados.map(a => (<li key={a.id} onMouseDown={() => handleAgregarDestinatario(a)} className="px-3 py-2 hover:bg-slate-100 cursor-pointer">{getNombreCompleto(a)}</li>)) : <li className="px-3 py-2 text-slate-500">No se encontraron alumnos.</li>}
                          </ul>
                      )}
                      <div className="mt-2">
                          <p className="text-xs font-semibold text-slate-500">Destinatarios ({destinatarios.length}):</p>
                          {destinatarios.length > 0 && (<div className="flex flex-wrap gap-2 mt-1 p-2 border rounded-lg bg-slate-50">{destinatarios.map(d => (<span key={d.id} className="flex items-center gap-2 bg-sky-100 text-sky-800 text-sm rounded-full px-2 py-1">{getNombreCompleto(d)}<button type="button" onClick={() => handleQuitarDestinatario(d.id)} className="w-4 h-4 rounded-full bg-sky-200 text-sky-800 flex items-center justify-center font-bold text-xs">x</button></span>))}</div>)}
                      </div>
                  </div>
                  <div>
                      <label className="text-sm font-medium text-slate-600">3. Env√≠a los mensajes</label>
                      <div className="mt-2 p-3 border rounded-lg bg-slate-50 space-y-2 max-h-48 overflow-y-auto">{destinatarios.length > 0 ? (destinatarios.map(destinatario => (<button key={destinatario.id} type="button" onClick={() => handleSendMessage(destinatario)} className="w-full flex justify-between items-center text-left px-3 py-2 text-sm rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors"><span>Enviar a: <strong>{getNombreCompleto(destinatario)}</strong></span><span role="img" aria-label="send">üí¨</span></button>))) : (<p className="text-xs text-slate-400">Selecciona al menos un destinatario para ver los botones de env√≠o.</p>)}</div>
                  </div>
              </div>
              <PlantillaModal isOpen={editingPlantilla !== null} plantilla={editingPlantilla?.id ? editingPlantilla : null} onCancel={() => setEditingPlantilla(null)} onSave={handleSavePlantilla} />
          </Card>
        </div>
        
        <div className="md:col-span-2">
          <Card title={<span className="text-[#34745B]">Mis Clubes</span>}>
              <GestionClubes user={user} />
          </Card>
        </div>

        <div className="md:col-span-2">
          <Card title={<span className="text-[#34745B]">Gesti√≥n de Datos</span>}>
               <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <button type="button" onClick={handleExportData} className="w-full px-4 py-2 rounded-lg border bg-[#34745B] hover:bg-green-800 text-white font-semibold">Exportar Datos (Backup)</button>
                  <button type="button" onClick={() => fileInputRef.current.click()} className="w-full px-4 py-2 rounded-lg border bg-slate-600 hover:bg-slate-700 text-white font-semibold">Importar Datos</button>
                  <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleImportData} />
              </div>
              <p className="text-xs text-slate-500 mt-3"><strong>Atenci√≥n:</strong> La importaci√≥n de datos reemplazar√° toda la informaci√≥n existente en el modo de trabajo que tengas seleccionado.</p>
          </Card>
        </div>
        
        <div className="md:col-span-2">
          <Card title={<span className="text-[#34745B]">Seguridad y PIN</span>}>
              <div className="space-y-4">
                  <div>
                      <label className="text-sm text-slate-600 block mb-1">
                          {form.pin ? "Cambiar PIN de seguridad (3 d√≠gitos)" : "Crear PIN de seguridad (3 d√≠gitos)"}
                      </label>
                      <p className="text-xs text-slate-500 mb-2">
                          Este PIN se solicitar√° para acciones cr√≠ticas.
                      </p>
                      <div className="grid grid-cols-2 gap-3">
                          <input type="password" name="newPin" value={pinInput.newPin} onChange={handlePinInputChange} placeholder="Nuevo PIN" maxLength="3" className="w-full border rounded-lg px-3 py-2 text-center" />
                          <input type="password" name="confirmPin" value={pinInput.confirmPin} onChange={handlePinInputChange} placeholder="Confirmar PIN" maxLength="3" className="w-full border rounded-lg px-3 py-2 text-center" />
                      </div>
                  </div>
                  <button type="button" onClick={handleSetPin} className="w-full px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-semibold">
                      {form.pin ? "Actualizar PIN" : "Establecer PIN"}
                  </button>
              </div>
          </Card>
        </div>

        <div className="md:col-span-2">
          <div className="p-4 border-2 border-red-300 bg-red-50 rounded-2xl">
              <h3 className="text-base font-semibold text-red-800">Zona de Peligro</h3>
              <p className="text-sm text-red-700 mt-2 mb-3">
                  La siguiente acci√≥n es permanente y no se puede deshacer.
              </p>
              <button type="button" onClick={handleWipeData} className="w-full px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">
                  Borrar Todos los Datos de este Modo de Trabajo
              </button>
          </div>
        </div>

        <div className="md:col-span-2 flex justify-end">
           <button type="submit" className="px-6 py-3 rounded-xl bg-[#34745B] hover:bg-green-800 text-white font-semibold">Guardar Todos los Cambios</button>
        </div>
      </form>

      {/* --- INICIO DEL BLOQUE DE MODALES --- */}
      
      {/* Modal para confirmaciones gen√©ricas (ej. eliminar plantilla) */}
      <Modal
        isOpen={!!confirmDeleteInfo}
        title={confirmDeleteInfo?.title || "Confirmar Acci√≥n"}
        onCancel={() => setConfirmDeleteInfo(null)}
        onConfirm={() => {
          confirmDeleteInfo?.onConfirm();
          setConfirmDeleteInfo(null);
        }}
        confirmText="Confirmar"
        size="md"
      >
        <p className="text-slate-600">{confirmDeleteInfo?.message}</p>
      </Modal>

      {/* Flujo de Modales para Borrar Datos */}
      <Modal
        isOpen={wipeStep === 1}
        title="Confirmar Borrado de Datos"
        onCancel={() => setWipeStep(0)}
        onConfirm={() => setWipeStep(2)}
        confirmText="S√≠, quiero continuar"
        size="md"
      >
        <div className="text-center">
          <p className="text-lg font-bold text-red-700">¬°ACCI√ìN IRREVERSIBLE!</p>
          <p className="mt-2 text-slate-600">
            ¬øEst√°s absolutamente seguro de que quieres borrar TODOS los datos de este club?
            Toda la informaci√≥n de alumnos, clases, pagos y configuraciones se eliminar√° permanentemente.
          </p>
        </div>
      </Modal>

      <InputModal
        isOpen={wipeStep === 2}
        title="Confirmaci√≥n Final"
        message="Para confirmar, escribe 'BORRAR DATOS' en el campo de abajo."
        placeholder="BORRAR DATOS"
        onCancel={() => setWipeStep(0)}
        onConfirm={(inputValue) => {
          if (inputValue === "BORRAR DATOS") {
            if (perfil.pin) {
              setWipeStep(3);
            } else {
              executeWipe();
            }
          } else {
            setToast("Texto incorrecto. Borrado cancelado.");
            setWipeStep(0);
          }
        }}
      />

      <PinConfirmModal
        isOpen={wipeStep === 3}
        onClose={() => setWipeStep(0)}
        onConfirm={executeWipe}
        perfil={perfil}
        title="PIN de Seguridad Requerido"
        message="Ingresa tu PIN de 3 d√≠gitos para autorizar el borrado definitivo de los datos."
      />
      
      {/* Otros modales que ya ten√≠as */}
      <ModalAbono />
      
      {/* --- FIN DEL BLOQUE DE MODALES --- */}
    </>
  );
}

function PinConfirmModal({ isOpen, onClose, onConfirm, perfil, title, message }) {
  const [pinInput, setPinInput] = React.useState("");
  const [error, setError] = React.useState("");

  const handleConfirm = () => {
    const userPin = perfil?.pin || null;

    if (!userPin) {
      setError("No has configurado un PIN en tu Perfil. No se puede continuar.");
      return;
    }

    if (pinInput === userPin) {
      // Si el PIN es correcto, ejecuta la acci√≥n y cierra el modal
      onConfirm();
      handleClose();
    } else {
      setError("PIN incorrecto. Int√©ntalo de nuevo.");
    }
  };

  const handleClose = () => {
    setPinInput("");
    setError("");
    onClose();
  };

  if (!isOpen) return null;

  return (
    <Modal
      isOpen={isOpen}
      title={title || "Confirmaci√≥n de Seguridad"}
      onCancel={handleClose}
      onConfirm={handleConfirm}
      confirmText="Confirmar"
      cancelText="Cancelar"
      size="sm"
    >
      <div className="space-y-4">
        <p className="text-sm text-slate-700">
          {message || "Para continuar con esta acci√≥n, por favor ingresa tu PIN de seguridad de 3 d√≠gitos."}
        </p>
        <input
          type="password"
          inputMode="numeric"
          maxLength="3"
          value={pinInput}
          onChange={(e) => {
            setPinInput(e.target.value.replace(/\D/g, ''));
            setError(""); // Limpia el error al escribir
          }}
          className="w-full border rounded-lg px-3 py-2 text-center text-lg tracking-widest"
          placeholder="‚Ä¢‚Ä¢‚Ä¢"
          autoFocus
        />
        {error && (
          <p className="text-sm text-red-600 text-center">{error}</p>
        )}
      </div>
    </Modal>
  );
}    
    // Reemplaza tu PagoGrupalModal completo con este c√≥digo
function PagoGrupalModal({ isOpen, clase, alumnos, onCancel, onSave, focusAlumnoId }) {
  const [pagos, setPagos] = useState({});
  const alumnosDeClase = clase ? (clase.alumnoIds || []).map(id => (alumnos || []).find(a => a.id === id)).filter(Boolean) : [];
  
  // Si nos pasan un focusAlumnoId, solo mostramos a ese alumno. Si no, a todos.
  const visibles = focusAlumnoId ? alumnosDeClase.filter(a => a.id === focusAlumnoId) : alumnosDeClase;

  useEffect(() => {
    if (clase) {
      const precioPorAlumno = (clase.alumnoIds?.length || 1) > 0 ? (parseFloat(clase.precio || 0) / (clase.alumnoIds?.length || 1)) : 0;
      const initialState = {};
      alumnosDeClase.forEach(alumno => {
        initialState[alumno.id] = {
          monto: alumno.plan === 'mensual' ? '0' : formatCurrency(precioPorAlumno, { withSymbol: false }), // L√çNEA MODIFICADA
          metodo: alumno.plan === 'mensual' ? "Mensual" : 'Efectivo',
          mixtoEfectivo: "",
          mixtoTransferencia: ""
        };
      });
      setPagos(initialState);
    }
  }, [clase, alumnos]);

  if (!isOpen || !clase) return null;

  const handlePaymentChange = (alumnoId, field, value) => {
    setPagos(prev => ({ ...prev, [alumnoId]: { ...prev[alumnoId], [field]: value } }));
  };
  
  const handleMixtoChange = (alumnoId, efectivo, transferencia) => {
      const ef = parseFloat(efectivo) || 0;
      const tx = parseFloat(transferencia) || 0;
      setPagos(prev => ({
  ...prev,
  [alumnoId]: {
    ...prev[alumnoId],
    mixtoEfectivo: efectivo,
    mixtoTransferencia: transferencia,
    monto: formatCurrency(ef + tx), // Aplica la funci√≥n formatCurrency
  }
}));
  }

  const handleSave = () => {
    const pagosAGuardar = Object.entries(pagos).map(([alumnoId, data]) => {
      // Solo incluimos en el guardado a los alumnos que estamos viendo
      if (visibles.some(a => a.id === alumnoId)) {
        const registro = { alumnoId, ...data };
        if (data.metodo === "Mixto") {
          registro.monto = formatCurrency(parseFloat(data.mixtoEfectivo || 0) + parseFloat(data.mixtoTransferencia || 0));
        }
        return registro;
      }
      return null;
    }).filter(Boolean); // Limpiamos los nulos
    onSave(pagosAGuardar);
  };

  // T√≠tulo din√°mico para mayor claridad
  const modalTitle = focusAlumnoId ? `Pagar Clase Espec√≠fica` : `Registrar Pagos de Clase`;

  return (
    <Modal isOpen={isOpen} title={modalTitle} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pagos">
      <div className="grid gap-4">
        <p className="text-sm text-center border-b pb-2">Clase de {clase.tipo} del {clase.fecha} a las {clase.hora}. Precio total: ${formatCurrency(clase.precio)}</p>
        <div className="space-y-4 max-h-64 overflow-y-auto pr-2">
          {visibles.map(alumno => (
            <div key={alumno.id} className="p-3 border rounded-lg bg-slate-50">
              <p className="font-semibold">{getNombreCompleto(alumno)}</p>
              {alumno.plan === 'mensual' ? (
                <p className="text-sm text-emerald-700 mt-2">‚úÖ Cubierto por Plan Mensual</p>
              ) : (
                <div className="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <label className="text-xs text-slate-600">Monto</label>
                    <input type="number" value={pagos[alumno.id]?.monto || ''} onChange={(e) => handlePaymentChange(alumno.id, 'monto', e.target.value)} disabled={pagos[alumno.id]?.metodo === 'Mixto'} className="w-full border rounded-lg px-2 py-1 disabled:bg-slate-200" />
                  </div>
                  <div>
                    <label className="text-xs text-slate-600">M√©todo</label>
                    <select value={pagos[alumno.id]?.metodo || 'Pendiente'} onChange={(e) => handlePaymentChange(alumno.id, 'metodo', e.target.value)} className="w-full border rounded-lg px-2 py-1">
                      {METODOS_PAGO.filter(m => m !== 'Mensual').map(m => <option key={m}>{m}</option>)}
                    </select>
                  </div>
                  {/* AQU√ç EST√Å LA L√ìGICA CORREGIDA PARA EL PAGO MIXTO */}
                  {pagos[alumno.id]?.metodo === 'Mixto' && (
                    <div className="col-span-2 grid grid-cols-2 gap-2 mt-2 pt-2 border-t">
                       <div>
                         <label className="text-xs text-slate-600">Efectivo</label>
                         <input type="number" value={pagos[alumno.id]?.mixtoEfectivo || ""} onChange={(e) => handleMixtoChange(alumno.id, e.target.value, pagos[alumno.id]?.mixtoTransferencia)} className="w-full rounded-lg px-2 py-1 border" />
                       </div>
                       <div>
                         <label className="text-xs text-slate-600">Transferencia</label>
                         <input type="number" value={pagos[alumno.id]?.mixtoTransferencia || ""} onChange={(e) => handleMixtoChange(alumno.id, pagos[alumno.id]?.mixtoEfectivo, e.target.value)} className="w-full rounded-lg px-2 py-1 border" />
                       </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    </Modal>
  );
}
// Pega esta nueva funci√≥n en tu archivo
function RegistroPagoMensualModal({ isOpen, alumno, perfil, onCancel, onSave }) {
  const [form, setForm] = useState({
    monto: "",
    metodo: "Transferencia",
    mes: new Date().getMonth(),
    fechaPago: formatDate(new Date())
  });

  useEffect(() => {
    // Cuando se abre el modal, calcula el monto sugerido del plan del alumno
    if (alumno && perfil.preciosMensuales) {
      const montoPredefinido = perfil.preciosMensuales[alumno.frecuencia] || "";
      setForm(prev => ({ ...prev, monto: montoPredefinido }));
    }
  }, [isOpen, alumno, perfil]);

  if (!isOpen || !alumno) return null;

  const handleSave = () => {
    if (!form.monto || parseFloat(form.monto) <= 0) {
      alert("Por favor, ingresa un monto v√°lido.");
      return;
    }
    onSave(form);
  };

  return (
    <Modal isOpen={isOpen} title={`Registrar Abono: ${getNombreCompleto(alumno)}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pago">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">Mes Correspondiente</label>
          <select 
            value={form.mes} 
            onChange={(e) => setForm({...form, mes: parseInt(e.target.value)})}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            {MESES_NOMBRES.map((nombre, index) => <option key={index} value={index}>{nombre}</option>)}
          </select>
        </div>
        <div>
          <label className="text-sm text-slate-600">Monto Pagado</label>
          <input 
            type="number" 
            value={form.monto} 
            onChange={(e) => setForm({...form, monto: e.target.value})} 
            className="w-full border rounded-lg px-3 py-2 mt-1" 
            placeholder="0.00" 
          />
        </div>
        <div>
          <label className="text-sm text-slate-600">M√©todo de Pago</label>
          <select 
            value={form.metodo} 
            onChange={(e) => setForm({...form, metodo: e.target.value})}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            {METODOS_PAGO.filter(m => m !== 'Pendiente').map(m => <option key={m}>{m}</option>)}
          </select>
        </div>
        <div>
          <label className="text-sm text-slate-600">Fecha de Pago</label>
          <input 
            type="date" 
            value={form.fechaPago} 
            onChange={(e) => setForm({...form, fechaPago: e.target.value})} 
            className="w-full border rounded-lg px-3 py-2 mt-1" 
          />
        </div>
      </div>
    </Modal>
  );
}
    function PagoMensualModal({ isOpen, alumno, mes, onCancel, onSave }) {
      const [form, setForm] = useState({ monto: "", metodo: "Efectivo" });
      useEffect(() => {
        if (alumno) {
          const restante = alumno.cuota - alumno.totalPagado;
          setForm({ monto: restante > 0 ? formatCurrency(restante) : "", metodo: "Efectivo" });
        }
      }, [alumno]);
      if (!isOpen || !alumno) return null;
      const handleSave = () => { onSave({ ...form, monto: form.monto || "0" }); };
      return (
        <Modal isOpen={isOpen} title={`Pago Cuota: ${alumno.nombre}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pago">
          <div className="grid gap-4">
            <p>Cuota de {MESES_NOMBRES[mes]} por {formatCurrency(alumno.cuota)}. Pagado: {formatCurrency(alumno.totalPagado)}.</p>
            <div><label className="text-sm text-slate-600">Monto a Pagar</label><input type="number" value={form.monto} onChange={(e) => setForm({...form, monto: e.target.value})} className="w-full border rounded-lg px-3 py-2" placeholder="0.00" /></div>
            <div><label className="text-sm text-slate-600">M√©todo de Pago</label><select value={form.metodo} onChange={(e) => setForm({...form, metodo: e.target.value})} className="w-full border rounded-lg px-3 py-2">{METODOS_PAGO.filter(m => m !== 'Pendiente').map(m => <option key={m}>{m}</option>)}</select></div>
          </div>
        </Modal>
      );
    }
    // Pega este nuevo componente en tu archivo
function EditarPagoModal({ isOpen, pago, onCancel, onSave }) {
  const [form, setForm] = useState(null);

  useEffect(() => {
    // Cuando se abre el modal, inicializamos el form con todos los campos necesarios
    if (pago) {
      setForm({
        ...pago,
        concepto: pago.concepto || "Pago General",
        mixtoEfectivo: pago.detalleMixto?.efectivo?.toString() || "",
        mixtoTransferencia: pago.detalleMixto?.transferencia?.toString() || ""
      });
    }
  }, [pago]);

  if (!isOpen || !form) return null;

  const handleChange = (e) => {
    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  };
  
  const handleMixtoChange = (efectivo, transferencia) => {
      const ef = parseFloat(efectivo) || 0;
      const tx = parseFloat(transferencia) || 0;
      setForm(prev => ({
  ...prev,
  mixtoEfectivo: efectivo,
  mixtoTransferencia: transferencia,
  monto: formatCurrency(ef + tx, { withSymbol: false }),
}));
  }

  return (
    <Modal isOpen={isOpen} title={`Editar Pago`} onCancel={onCancel} onConfirm={() => onSave(form)} confirmText="Guardar Cambios">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">Concepto</label>
          <input type="text" name="concepto" value={form.concepto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" />
        </div>
        <div>
          <label className="text-sm text-slate-600">Monto Pagado</label>
          <input type="number" name="monto" value={form.monto} onChange={handleChange} disabled={form.metodo === 'Mixto'} className="w-full border rounded-lg px-3 py-2 mt-1 disabled:bg-slate-100" />
        </div>
        <div>
          <label className="text-sm text-slate-600">M√©todo de Pago</label>
          <select name="metodo" value={form.metodo} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1">
            {METODOS_PAGO.filter(m => m !== 'Pendiente' && m !== 'Mensual').map(m => <option key={m}>{m}</option>)}
          </select>
        </div>
        
        {/* L√≥gica corregida para el pago mixto */}
        {form.metodo === 'Mixto' && (
          <div className="p-3 border rounded-lg grid grid-cols-2 gap-3 bg-slate-50">
            <div>
              <label className="text-xs text-slate-600">Efectivo</label>
              <input type="number" value={form.mixtoEfectivo} onChange={(e) => handleMixtoChange(e.target.value, form.mixtoTransferencia)} className="w-full border rounded-lg px-2 py-1 mt-1" />
            </div>
            <div>
              <label className="text-xs text-slate-600">Transferencia</label>
              <input type="number" value={form.mixtoTransferencia} onChange={(e) => handleMixtoChange(form.mixtoEfectivo, e.target.value)} className="w-full border rounded-lg px-2 py-1 mt-1" />
            </div>
          </div>
        )}

        <div>
          <label className="text-sm text-slate-600">Fecha de Pago</label>
          <input type="date" name="fecha" value={form.fecha} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" />
        </div>
      </div>
    </Modal>
  );
}
function PlantillaModal({ isOpen, plantilla, onCancel, onSave }) {
  const [form, setForm] = useState({ titulo: '', texto: '' });

  useEffect(() => {
    // Si pasamos una plantilla, es para editar. Si no, es para crear una nueva.
    if (plantilla) {
      setForm(plantilla);
    } else {
      setForm({ titulo: '', texto: '' });
    }
  }, [plantilla]);

  if (!isOpen) return null;

  const handleChange = (e) => {
    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  };

  return (
    <Modal isOpen={isOpen} title={form.id ? "Editar Plantilla" : "Nueva Plantilla"} onCancel={onCancel} onConfirm={() => onSave(form)} confirmText="Guardar">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">T√≠tulo de la Plantilla</label>
          <input type="text" name="titulo" value={form.titulo} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Ej: Recordatorio de Clase" />
        </div>
        <div>
          <label className="text-sm text-slate-600">Texto del Mensaje</label>
          <textarea name="texto" value={form.texto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" rows={6} placeholder="Escribe tu mensaje aqu√≠. Usa {nombre_alumno} para personalizarlo."></textarea>
        </div>
      </div>
    </Modal>
  );
}

// === Iconos SVG (estilos neutros, heredan color actual) ===
const InfoIconCalendar = (p) => (
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" {...p}>
    <rect x="3" y="4" width="18" height="18" rx="3" strokeWidth="1.5"/>
    <path d="M16 2v4M8 2v4M3 10h18" strokeWidth="1.5"/>
  </svg>
);
const InfoIconMoney = (p) => (
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" {...p}>
    <rect x="3" y="6" width="18" height="12" rx="2" strokeWidth="1.5"/>
    <path d="M7 12h.01M17 12h.01M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" strokeWidth="1.5"/>
  </svg>
);
const InfoIconChart = (p) => (
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" {...p}>
    <path d="M3 3v18h18" strokeWidth="1.5"/>
    <path d="M7 15v3M12 11v7M17 7v11" strokeWidth="1.5"/>
  </svg>
);
const InfoIconShield = (p) => (
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" {...p}>
    <path d="M12 3l7 3v6c0 5-3.5 8-7 9-3.5-1-7-4-7-9V6l7-3Z" strokeWidth="1.5"/>
    <path d="M9.5 12.5l2 2 3-3" strokeWidth="1.5"/>
  </svg>
);
const InfoIconMessage = (p) => (
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" {...p}>
    <path d="M21 12a8 8 0 1 1-3-6.3L21 6l-.7 3.2c.5.9.7 1.9.7 2.8Z" strokeWidth="1.5"/>
    <path d="M9 10h6M9 13h4" strokeWidth="1.5"/>
  </svg>
);
const InfoIconRadio = (p) => (
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" {...p}>
    <circle cx="12" cy="12" r="3" strokeWidth="1.5"/>
    <path d="M2 12a10 10 0 0 1 20 0M5 12a7 7 0 0 1 14 0" strokeWidth="1.5"/>
  </svg>
);

function InfoModal({ type, onClose }) {
  React.useEffect(() => {
    const onKey = (e) => e.key === "Escape" && onClose();
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [onClose]);

  const copy = {
    auth: {
      title: "Auth segura con Firebase",
      body: (
        <>
          <p className="text-sm text-slate-600">
            Usamos <strong>Firebase Authentication</strong> para validar tus credenciales en forma segura.
            Tus contrase√±as <strong>no</strong> se guardan en servidores propios de Coachex-Pro.
          </p>
        </>
      ),
      cta: null,
    },
    support: {
      title: "Soporte por WhatsApp",
      body: (
        <>
          <p className="text-sm text-slate-600">
            ¬øNecesit√°s ayuda? Escribinos por WhatsApp. Atendemos de <strong>Lun a Vie, 9 a 18 hs</strong>.
          </p>
        </>
      ),
      cta: (
        <a
          href="https://wa.me/5493810000000" // ‚Üê reemplaz√° por tu n√∫mero
          target="_blank" rel="noopener"
          className="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700"
        >
          Abrir WhatsApp
        </a>
      ),
    },
    status: {
      title: "Estado del sistema",
      body: (
        <>
          <p className="text-sm text-slate-600">
            Revis√° en tiempo real si la plataforma est√° funcionando correctamente y el historial de mantenimientos.
          </p>
        </>
      ),
      cta: (
        <a
          href="/status"
          className="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700"
        >
          Ver estado
        </a>
      ),
    },
  }[type] || {};

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center"
      role="dialog" aria-modal="true"
      onClick={onClose}
    >
      <div className="absolute inset-0 bg-black/40" />
      <div
        className="relative mx-4 max-w-md w-full rounded-2xl bg-white p-6 shadow-lg"
        onClick={(e) => e.stopPropagation()}
      >
        <button
          onClick={onClose}
          aria-label="Cerrar"
          className="absolute right-3 top-3 rounded-full p-1 text-slate-500 hover:bg-slate-100"
          title="Cerrar"
        >
          ‚úï
        </button>

        <h3 className="text-lg font-semibold text-slate-900 mb-2">{copy.title}</h3>
        <div className="mb-4">{copy.body}</div>

        <div className="flex items-center justify-end gap-2">
          {copy.cta}
          <button
            onClick={onClose}
            className="rounded-lg border border-slate-300 px-3 py-2 text-slate-700 hover:bg-slate-50"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  );
}

function NewsModal(props) {
  var open = props.open;
  var onClose = props.onClose;
  var lang = props.lang === "en" ? "en" : "es"; // default a "es"

  var _React = React;
  var useState = _React.useState, useEffect = _React.useEffect;

  var _useState = useState([]), novedades = _useState[0], setNovedades = _useState[1];
  var _useState2 = useState(true), loading = _useState2[0], setLoading = _useState2[1];

  useEffect(function () {
    if (!open) return;

    setLoading(true);
    // Usa concatenaci√≥n en lugar de template string
    var url = "novedades." + lang + ".json"; // asegurate que est√© junto a tu index.html
    fetch(url)
      .then(function (res) { return res.json(); })
      .then(function (data) { setNovedades(Array.isArray(data) ? data : []); })
      .catch(function (err) {
        console.error("Error cargando novedades:", err);
        setNovedades([]);
      })
      .finally(function () {
        setLoading(false);
      });
  }, [open, lang]);

  if (!open) return null;

  var t = (lang === "es") ? {
    title: "Novedades",
    loading: "Cargando novedades...",
    empty: "No hay novedades disponibles por ahora.",
    close: "Cerrar"
  } : {
    title: "News",
    loading: "Loading updates...",
    empty: "No updates available yet.",
    close: "Close"
  };

  function stop(e) { e.stopPropagation(); }

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center"
      role="dialog" aria-modal="true" aria-labelledby="news-title"
      onClick={onClose}
    >
      <div className="absolute inset-0 bg-black/40" />
      <div
        className="relative bg-white w-full max-w-2xl mx-4 rounded-2xl shadow-xl"
        onClick={stop}
      >
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b">
          <h3 id="news-title" className="text-lg font-semibold text-slate-900">
            {t.title}
          </h3>
          <button
            onClick={onClose}
            className="rounded-full p-2 text-slate-600 hover:bg-slate-100"
            aria-label={t.close}
            title={t.close}
          >
            ‚úï
          </button>
        </div>

        {/* Contenido */}
        <div className="px-6 py-5 max-h-[70vh] overflow-y-auto space-y-6 text-slate-700">
          {loading && <p className="text-sm text-slate-500">{t.loading}</p>}
          {!loading && novedades.length === 0 && (
            <p className="text-sm text-slate-500">{t.empty}</p>
          )}
          {novedades.map(function (item, idx) {
            return (
              <div key={idx} className="border-l-4 border-emerald-500 pl-4">
                <p className="text-xs text-slate-500">{item.fecha}</p>
                <h4 className="font-semibold text-slate-900">{item.titulo}</h4>
                <p className="text-sm">{item.desc}</p>
              </div>
            );
          })}
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t flex items-center justify-end">
          <button
            onClick={onClose}
            className="rounded-lg border border-slate-300 px-3 py-2 text-slate-700 hover:bg-slate-50"
          >
            {t.close}
          </button>
        </div>
      </div>
    </div>
  );
}


function HelpModal({ open, onClose, lang = "es" }) {
  const [search, setSearch] = React.useState("");

  React.useEffect(() => {
    const onKey = (e) => e.key === "Escape" && onClose();
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [onClose]);

  if (!open) return null;

  // Diccionario base
  const dict = {
    es: {
      title: "Ayuda (FAQ)",
      placeholder: "Buscar: contrase√±a, horarios, precios‚Ä¶",
      noResults: (s) => `No encontramos resultados para ‚Äú${s}‚Äù. Prob√° con otra palabra.`,
      cta: "¬øSegu√≠s con dudas? Escribinos y te ayudamos.",
      ctaBtn: "Abrir WhatsApp",
      close: "Cerrar",
      faqs: [
        {
          q: "¬øC√≥mo creo mi cuenta?",
          a: "En la pantalla de inicio eleg√≠ ‚ÄúCrear cuenta‚Äù, ingres√° tu email y una contrase√±a (m√≠nimo 6 caracteres) y presion√° Registrarse.",
          tags: ["cuenta", "registro", "email"],
        },
        {
          q: "Olvid√© mi contrase√±a",
          a: "Desde Iniciar sesi√≥n toc√° ‚ÄúOlvid√© mi contrase√±a‚Äù. Ingres√° tu email y te enviamos un link para restablecerla.",
          tags: ["contrase√±a", "reset", "email"],
        },
        {
          q: "¬øPuedo cobrar por clase y por abono?",
          a: "S√≠. Configur√° precios por clase y mensuales en Onboarding > Precios. Luego eleg√≠s por alumno c√≥mo facturar.",
          tags: ["precios", "cobros", "clase", "mensual"],
        },
        {
          q: "¬øC√≥mo agrego mis horarios?",
          a: "En Onboarding > Horario Laboral sum√° bloques por d√≠a y defin√≠ Desde/Hasta. El bot√≥n ‚Äú+ Agregar bloque‚Äù te permite crear m√°s tramos.",
          tags: ["horarios", "agenda", "onboarding"],
        },
        {
          q: "¬øPuedo enviar comprobantes por WhatsApp?",
          a: "S√≠. Desde el detalle del cobro gener√°s el comprobante y lo compart√≠s por WhatsApp con un clic.",
          tags: ["comprobantes", "whatsapp", "cobros"],
        },
        {
          q: "¬øC√≥mo contacto soporte?",
          a: "Escribinos por WhatsApp (Lun‚ÄìVie 9 a 18 hs) y te ayudamos paso a paso.",
          tags: ["soporte", "contacto", "ayuda"],
        },
      ],
    },
    en: {
      title: "Help (FAQ)",
      placeholder: "Search: password, schedule, pricing‚Ä¶",
      noResults: (s) => `No results found for ‚Äú${s}‚Äù. Try another keyword.`,
      cta: "Still have questions? Contact us and we‚Äôll help you.",
      ctaBtn: "Open WhatsApp",
      close: "Close",
      faqs: [
        {
          q: "How do I create my account?",
          a: "On the home screen, choose ‚ÄúCreate Account‚Äù, enter your email and a password (minimum 6 characters), then click Register.",
          tags: ["account", "register", "email"],
        },
        {
          q: "I forgot my password",
          a: "From Sign In, click ‚ÄúForgot password?‚Äù. Enter your email and we‚Äôll send you a reset link.",
          tags: ["password", "reset", "email"],
        },
        {
          q: "Can I charge per class and with subscription?",
          a: "Yes. Configure per-class and monthly pricing in Onboarding > Pricing. Then choose per student how to bill.",
          tags: ["pricing", "payments", "class", "monthly"],
        },
        {
          q: "How do I add my schedule?",
          a: "In Onboarding > Work Schedule, add blocks per day and set From/To. The ‚Äú+ Add block‚Äù button lets you create more ranges.",
          tags: ["schedule", "agenda", "onboarding"],
        },
        {
          q: "Can I send receipts via WhatsApp?",
          a: "Yes. From the payment detail, generate the receipt and share it via WhatsApp with one click.",
          tags: ["receipts", "whatsapp", "payments"],
        },
        {
          q: "How do I contact support?",
          a: "Message us on WhatsApp (Mon‚ÄìFri 9am‚Äì6pm) and we‚Äôll guide you step by step.",
          tags: ["support", "contact", "help"],
        },
      ],
    },
  };

  const t = dict[lang] || dict.es;

  // B√∫squeda
  const normalized = (s) => (s || "").toLowerCase();
  const filtered = t.faqs.filter(({ q, a, tags }) => {
    if (!search) return true;
    const term = normalized(search);
    return (
      normalized(q).includes(term) ||
      normalized(a).includes(term) ||
      (tags || []).some((tg) => normalized(tg).includes(term))
    );
  });

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-labelledby="help-title"
      onClick={onClose}
    >
      <div className="absolute inset-0 bg-black/40" />
      <div
        className="relative bg-white w-full max-w-3xl mx-4 rounded-2xl shadow-xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b">
          <h3 id="help-title" className="text-lg font-semibold text-slate-900">
            {t.title}
          </h3>
          <button
            onClick={onClose}
            className="rounded-full p-2 text-slate-600 hover:bg-slate-100"
            aria-label={t.close}
            title={t.close}
          >
            ‚úï
          </button>
        </div>

        {/* Buscador */}
        <div className="px-6 pt-4">
          <div className="relative">
            <input
              type="text"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              placeholder={t.placeholder}
              className="w-full rounded-xl border border-slate-300 px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-600"
              aria-label={t.placeholder}
            />
            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">üîé</span>
          </div>
        </div>

        {/* Lista de preguntas */}
        <div className="px-6 py-4 max-h-[60vh] overflow-y-auto">
          {filtered.length === 0 ? (
            <p className="text-sm text-slate-500">{t.noResults(search)}</p>
          ) : (
            <div className="space-y-3">
              {filtered.map((item, idx) => (
                <details key={idx} className="group rounded-xl border border-slate-200 p-4 bg-white">
                  <summary className="cursor-pointer font-medium text-slate-800 flex items-center justify-between">
                    {item.q}
                    <span className="text-slate-400 group-open:rotate-180 transition">‚åÑ</span>
                  </summary>
                  <p className="mt-2 text-sm text-slate-600">{item.a}</p>
                </details>
              ))}
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t flex items-center justify-between gap-3">
          <p className="text-xs text-slate-500">{t.cta}</p>
          <a
            href="https://wa.me/5493810000000" // tu n√∫mero
            target="_blank" rel="noopener"
            className="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700"
          >
            {t.ctaBtn}
          </a>
        </div>
      </div>
    </div>
  );
}



function PrivacyModal({ open, onClose, lang = "es" }) {
  if (!open) return null;

  // Diccionario ES/EN
  const t = (lang === "en") ? {
    title: "Privacy Policy",
    close: "Close",
    updatedLabel: "Last updated",
    s1Title: "1. Introduction",
    s1Body: <>At <strong>Coachex-Pro</strong> we value your privacy. This policy explains what data we collect and how we use it.</>,
    s2Title: "2. Data collected",
    s2Items: [
      "Registration data: email and password.",
      "Management data: students, classes, payments, club settings.",
      "Technical metadata: basic usage info (date/time of access).",
    ],
    s3Title: "3. Use of information",
    s3Body: "Data is used solely to provide and improve the service. We never sell data to third parties.",
    s4Title: "4. Storage",
    s4Body: <>Your information is stored on <strong>Google Firebase</strong> servers, following international security standards.</>,
    s5Title: "5. User rights",
    s5Body: "You can request deletion of your account and data by contacting our support email.",
    dateLocale: "en-US",
  } : {
    title: "Pol√≠tica de Privacidad",
    close: "Cerrar",
    updatedLabel: "√öltima actualizaci√≥n",
    s1Title: "1. Introducci√≥n",
    s1Body: <>En <strong>Coachex-Pro</strong> valoramos tu privacidad. Esta pol√≠tica explica qu√© datos recopilamos y c√≥mo los usamos.</>,
    s2Title: "2. Datos recopilados",
    s2Items: [
      "Datos de registro: email y contrase√±a.",
      "Datos de gesti√≥n: alumnos, clases, pagos, configuraciones de club.",
      "Metadatos t√©cnicos: informaci√≥n b√°sica de uso (fecha/hora de acceso).",
    ],
    s3Title: "3. Uso de la informaci√≥n",
    s3Body: "Los datos se utilizan exclusivamente para brindar y mejorar el servicio. Nunca se venden a terceros.",
    s4Title: "4. Almacenamiento",
    s4Body: <>Tu informaci√≥n se guarda en servidores de <strong>Google Firebase</strong>, con est√°ndares de seguridad internacionales.</>,
    s5Title: "5. Derechos del usuario",
    s5Body: "Pod√©s solicitar la eliminaci√≥n de tu cuenta y datos escribiendo a nuestro correo de soporte.",
    dateLocale: "es-AR",
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-labelledby="privacy-title"
      onClick={onClose}
    >
      <div className="absolute inset-0 bg-black/40" />
      <div
        className="relative bg-white w-full max-w-3xl mx-4 rounded-2xl shadow-xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b">
          <h3 id="privacy-title" className="text-lg font-semibold text-slate-900">
            {t.title}
          </h3>
          <button
            onClick={onClose}
            className="rounded-full p-2 text-slate-600 hover:bg-slate-100"
            aria-label={t.close}
            title={t.close}
          >
            ‚úï
          </button>
        </div>

        {/* Contenido con scroll */}
        <div className="px-6 py-5 max-h-[70vh] overflow-y-auto space-y-6 text-slate-700">
          <section>
            <h4 className="font-semibold text-slate-900 mb-1">{t.s1Title}</h4>
            <p>{t.s1Body}</p>
          </section>

          <section>
            <h4 className="font-semibold text-slate-900 mb-1">{t.s2Title}</h4>
            <ul className="list-disc list-inside space-y-1">
              {t.s2Items.map((li, i) => <li key={i}>{li}</li>)}
            </ul>
          </section>

          <section>
            <h4 className="font-semibold text-slate-900 mb-1">{t.s3Title}</h4>
            <p>{t.s3Body}</p>
          </section>

          <section>
            <h4 className="font-semibold text-slate-900 mb-1">{t.s4Title}</h4>
            <p>{t.s4Body}</p>
          </section>

          <section>
            <h4 className="font-semibold text-slate-900 mb-1">{t.s5Title}</h4>
            <p>{t.s5Body}</p>
          </section>

          <p className="text-xs text-slate-500">
            {t.updatedLabel}: {new Date().toLocaleDateString(t.dateLocale, { year:'numeric', month:'long' })}
          </p>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t flex items-center justify-end gap-2">
          <button
            onClick={onClose}
            className="rounded-lg border border-slate-300 px-3 py-2 text-slate-700 hover:bg-slate-50"
          >
            {t.close}
          </button>
        </div>
      </div>
    </div>
  );
}


function TermsModal({ open, onClose, lang = "es" }) {
  if (!open) return null;

  // Diccionario ES/EN
  const t = (lang === "en") ? {
    title: "Terms of Use",
    close: "Close",
    updatedLabel: "Last updated",
    dateLocale: "en-US",
    sections: [
      {
        h: "1. Introduction",
        p: <>Welcome to <strong>Coachex-Pro</strong>, a platform for tennis/padel coaches and clubs. By using the app, you agree to these terms.</>
      },
      {
        h: "2. Permitted Use",
        p: "The app is for professional purposes only. Illegal, fraudulent, or abusive use is prohibited."
      },
      {
        h: "3. Accounts and Security",
        p: "You are responsible for maintaining the confidentiality of your credentials and for any activity under your account."
      },
      {
        h: "4. Intellectual Property",
        p: <>Software, design, and brand belong to Coachex-Pro. The data you upload remains yours, and you keep all rights over it.</>
      },
      {
        h: "5. Payments and Fees",
        p: "Some features may be subject to paid plans. Prices and billing cycles will be communicated before any charge."
      },
      {
        h: "6. Data and Privacy",
        p: <>We store information on <strong>Google Firebase</strong>. We do not sell data to third parties. See the Privacy Policy for more details.</>
      },
      {
        h: "7. Service Availability",
        p: "The service is provided ‚Äúas is‚Äù. We strive for high availability but do not guarantee uninterrupted access."
      },
      {
        h: "8. Changes to the Service/Terms",
        p: "We may update features and these terms. We will notify you of relevant changes within the app."
      },
      {
        h: "9. Contact",
        p: "Questions or requests: soporte@coachex.pro"
      }
    ]
  } : {
    title: "T√©rminos de Uso",
    close: "Cerrar",
    updatedLabel: "√öltima actualizaci√≥n",
    dateLocale: "es-AR",
    sections: [
      {
        h: "1. Introducci√≥n",
        p: <>Bienvenido a <strong>Coachex-Pro</strong>, una plataforma para profesores y clubes de tenis/p√°del. Al usar la app acept√°s estos t√©rminos.</>
      },
      {
        h: "2. Uso permitido",
        p: "La app es para fines profesionales. No se permite uso ilegal, fraudulento ni abusivo."
      },
      {
        h: "3. Cuenta y seguridad",
        p: "Sos responsable por mantener segura tu contrase√±a y por las actividades realizadas con tu cuenta."
      },
      {
        h: "4. Propiedad intelectual",
        p: <>El software, dise√±o y marca pertenecen a Coachex-Pro. Los datos que cargues siguen siendo tuyos y conserv√°s todos los derechos sobre ellos.</>
      },
      {
        h: "5. Pagos y planes",
        p: "Algunas funciones pueden requerir planes pagos. Precios y ciclos de facturaci√≥n se informar√°n antes de cualquier cobro."
      },
      {
        h: "6. Datos y privacidad",
        p: <>Almacenamos informaci√≥n en <strong>Google Firebase</strong>. No vendemos datos a terceros. Consult√° la Pol√≠tica de Privacidad para m√°s detalle.</>
      },
      {
        h: "7. Disponibilidad del servicio",
        p: "El servicio se brinda ‚Äútal cual‚Äù. Buscamos alta disponibilidad pero no garantizamos acceso ininterrumpido."
      },
      {
        h: "8. Cambios en el servicio/t√©rminos",
        p: "Podemos actualizar funcionalidades y estos t√©rminos. Avisaremos cambios relevantes dentro de la app."
      },
      {
        h: "9. Contacto",
        p: "Consultas o solicitudes: soporte@coachex.pro"
      }
    ]
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-labelledby="terms-title"
      onClick={onClose}
    >
      <div className="absolute inset-0 bg-black/40" />
      <div
        className="relative bg-white w-full max-w-3xl mx-4 rounded-2xl shadow-xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b">
          <h3 id="terms-title" className="text-lg font-semibold text-slate-900">
            {t.title}
          </h3>
          <button
            onClick={onClose}
            className="rounded-full p-2 text-slate-600 hover:bg-slate-100"
            aria-label={t.close}
            title={t.close}
          >
            ‚úï
          </button>
        </div>

        {/* Contenido con scroll */}
        <div className="px-6 py-5 max-h-[70vh] overflow-y-auto space-y-6 text-slate-700">
          {t.sections.map((sec, i) => (
            <section key={i}>
              <h4 className="font-semibold text-slate-900 mb-1">{sec.h}</h4>
              <p>{sec.p}</p>
            </section>
          ))}
          <p className="text-xs text-slate-500">
            {t.updatedLabel}: {new Date().toLocaleDateString(t.dateLocale, { year:'numeric', month:'long' })}
          </p>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t flex items-center justify-end gap-2">
          <button
            onClick={onClose}
            className="rounded-lg border border-slate-300 px-3 py-2 text-slate-700 hover:bg-slate-50"
          >
            {t.close}
          </button>
        </div>
      </div>
    </div>
  );
}



// === Diccionario de traducciones ===
const texts = {
  es: {
    login: "Iniciar Sesi√≥n",
    register: "Crear Cuenta",
    reset: "Restablecer Contrase√±a",
    email: "Email",
    password: "Contrase√±a",
    forgot: "¬øOlvidaste tu contrase√±a?",
    noAccount: "¬øNo ten√©s cuenta? Registrate",
    haveAccount: "¬øYa ten√©s cuenta? Ingres√°",
    send: "Enviar correo",
    welcome: "Bienvenido a Coachex-Pro",
    terms: "T√©rminos",
    privacy: "Privacidad",
    help: "Ayuda",
    news: "Novedades"
  },
  en: {
    login: "Sign In",
    register: "Create Account",
    reset: "Reset Password",
    email: "Email",
    password: "Password",
    forgot: "Forgot your password?",
    noAccount: "Don‚Äôt have an account? Sign up",
    haveAccount: "Already have an account? Sign in",
    send: "Send email",
    welcome: "Welcome to Coachex-Pro",
    terms: "Terms",
    privacy: "Privacy",
    help: "Help",
    news: "News"
  }
};

function MiniSpinner({ className = "h-4 w-4" }) {
  return (
    <svg className={`animate-spin ${className}`} viewBox="0 0 24 24" aria-hidden="true">
      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
      <path className="opacity-90" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
    </svg>
  );
}

function getAuthErrorInfo(code, lang = "es") {
  const L = (lang === "en")
    ? {
        generic: "There was a problem signing in.",
        userNotFound: "We couldn't find that email. Do you want to create an account?",
        wrongPassword: "Incorrect password. You can try resetting it.",
        invalidEmail: "Please enter a valid email address.",
        tooMany: "Too many attempts. Please wait a moment and try again.",
        weakPassword: "Password must be at least 6 characters.",
      }
    : {
        generic: "Hubo un problema al iniciar sesi√≥n.",
        userNotFound: "No encontramos ese email. ¬øQuer√©s crear una cuenta?",
        wrongPassword: "Contrase√±a incorrecta. Pod√©s intentar restablecerla.",
        invalidEmail: "Ingres√° un email v√°lido.",
        tooMany: "Demasiados intentos. Esper√° un momento y volv√© a intentar.",
        weakPassword: "La contrase√±a debe tener al menos 6 caracteres.",
      };

  switch (code) {
    case "auth/user-not-found":     return { msg: L.userNotFound, tip: "user-not-found" };
    case "auth/wrong-password":     return { msg: L.wrongPassword, tip: "wrong-password" };
    case "auth/invalid-email":      return { msg: L.invalidEmail, tip: "invalid-email" };
    case "auth/too-many-requests":  return { msg: L.tooMany, tip: "too-many-requests" };
    case "auth/weak-password":      return { msg: L.weakPassword, tip: "weak-password" };
    default:                        return { msg: L.generic, tip: "generic" };
  }
}
    
function LoginScreen() {
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [error, setError] = React.useState('');
  const [message, setMessage] = React.useState('');
  const [view, setView] = React.useState('login');
  const [loading, setLoading] = React.useState(false);
  const [showPwd, setShowPwd] = React.useState(false);

  // Idioma
  const [lang, setLang] = React.useState("es");


  // ‚¨áÔ∏è ESTADOS DE MODALES (A√ëADIDOS)
  const [termsOpen, setTermsOpen]     = React.useState(false);
  const [privacyOpen, setPrivacyOpen] = React.useState(false);
  const [helpOpen, setHelpOpen]       = React.useState(false);
  const [newsOpen, setNewsOpen]       = React.useState(false);
  const [errorCode, setErrorCode] = React.useState(""); // auth/error code (ej: "auth/user-not-found")
  const [capsOn, setCapsOn] = React.useState(false);


  const mountedRef = React.useRef(true);
  React.useEffect(() => () => { mountedRef.current = false; }, []);

  // ‚¨áÔ∏è acciones de auth
  const handleAuthAction = async (e) => {
    e.preventDefault();
    mountedRef.current && setLoading(true);
    mountedRef.current && setError('');
    mountedRef.current && setMessage('');
    try {
      if (view === 'register') {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(userCredential.user.uid)
          .collection('profile').doc('main').set(initialState.perfil);
      } else {
        await auth.signInWithEmailAndPassword(email, password);
      }
    } catch (err) {
  const info = getAuthErrorInfo(err?.code, lang);
  setError(info.msg);
  setErrorCode(err?.code || "");
} finally {
      setLoading(false);
    }
  };

  const handlePasswordReset = async (e) => {
    e.preventDefault();
    mountedRef.current && setLoading(true);
    mountedRef.current && setError('');
    mountedRef.current && setMessage('');
    try {
      await auth.sendPasswordResetEmail(email);
      mountedRef.current && setMessage(
        lang === "es" 
          ? "Se envi√≥ un correo para restablecer tu contrase√±a." 
          : "A password reset email has been sent."
      );
    } catch (err) {
  const info = getAuthErrorInfo(err?.code, lang);
  setError(info.msg);
  setErrorCode(err?.code || "");
} finally {
      setLoading(false);
    }
  };

return (
  <main className="min-h-screen bg-gradient-to-b from-emerald-50/40 to-white">
    <div className="mx-auto w-full max-w-[680px] px-4 pt-10 sm:pt-14 pb-8">

      {/* Header compacto */}
      <div className="flex flex-col items-center gap-2 mb-6">
        <img
          src="logo_favicon.png"
          alt="Coachex-Pro"
          className="h-12 w-12 rounded-full ring-2 ring-emerald-200 shadow-sm"
        />
        <h1 className="text-xl sm:text-2xl font-semibold text-slate-800 tracking-tight">
          {texts[lang].welcome}
        </h1>
      </div>

      {/* Card compacta */}
      <div className="rounded-xl border border-slate-200 bg-white shadow-md p-5 sm:p-6">
        {/* LOGIN */}
        {view === 'login' && (
          <div>
            <h2 className="text-xl sm:text-2xl font-semibold text-center text-slate-800">
              {texts[lang].login}
            </h2>
            <div className="h-px bg-slate-100 my-3" />

            <form onSubmit={handleAuthAction} className="space-y-3">
              <div>
                <label className="text-sm font-medium text-slate-600">
                  {texts[lang].email}
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full mt-1 h-11 text-[15px] border rounded-lg px-3 py-2
                             focus:outline-none focus:ring-2 focus:ring-emerald-600"
                  disabled={loading}
                  required
                />
              </div>

              <div>
                <label className="text-sm font-medium text-slate-600">
                  {texts[lang].password}
                </label>
                <div className="relative">
                  <input
  type={showPwd ? 'text' : 'password'}
  value={password}
  onChange={(e) => setPassword(e.target.value)}
  onKeyUp={(e) => setCapsOn(e.getModifierState && e.getModifierState('CapsLock'))}
  className="w-full mt-1 h-11 text-[15px] border rounded-lg px-3 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-600"
  disabled={loading}
  required
/>
                  <button
                    type="button"
                    onClick={() => setShowPwd((s) => !s)}
                    className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700 text-sm"
                    aria-label={showPwd ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'}
                  >
                    {showPwd ? 'üôà' : 'üëÅÔ∏è'}
                  </button>
                </div>
                {capsOn && (
                  <p className="mt-1 text-xs text-amber-600">
                    {lang === "es" ? "Bloq May√∫s activado" : "Caps Lock is on"}
                  </p>
                )}
              </div>

              {/* Error mejorado */}
              {error && (
                <div
                  role="alert" aria-live="assertive"
                  className="rounded-lg bg-red-50 border border-red-200 px-3 py-2 text-sm text-red-700"
                >
                  <p>{error}</p>
                  <div className="mt-2 flex flex-wrap items-center gap-x-3 gap-y-1">
                    {errorCode === "auth/user-not-found" && (
                      <button type="button" onClick={() => setView('register')}
                        className="inline-flex items-center gap-1 text-red-700 underline underline-offset-2 hover:text-red-800">
                        {lang === "es" ? "Crear cuenta" : "Create account"}
                      </button>
                    )}
                    {errorCode === "auth/wrong-password" && (
                      <button type="button" onClick={() => setView('reset')}
                        className="inline-flex items-center gap-1 text-red-700 underline underline-offset-2 hover:text-red-800">
                        {lang === "es" ? "Restablecer contrase√±a" : "Reset password"}
                      </button>
                    )}
                  </div>
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full h-11 rounded-lg bg-[#34745B] hover:bg-[#2E6D56]
                           text-white font-semibold shadow-sm transition
                           disabled:opacity-50 disabled:cursor-not-allowed"
                aria-busy={loading ? "true" : "false"}
              >
                {loading ? (
                  <span className="inline-flex items-center gap-2">
                    <MiniSpinner className="h-4 w-4" />
                    {lang === "es" ? "Ingresando..." : "Signing in..."}
                  </span>
                ) : (
                  texts[lang].login
                )}
              </button>
            </form>

            <div className="text-center mt-3">
              <button
                onClick={() => setView('reset')}
                className="text-sm text-[#34745B] hover:text-[#2E6D56] font-medium underline underline-offset-2"
              >
                {texts[lang].forgot}
              </button>
            </div>
            <div className="text-center mt-1">
              <button
                onClick={() => setView('register')}
                className="text-sm text-slate-600 hover:underline"
              >
                {texts[lang].noAccount}
              </button>
            </div>
          </div>
        )}

        {/* REGISTER */}
        {view === 'register' && (
          <div>
            <h2 className="text-xl sm:text-2xl font-semibold text-center text-slate-800">
              {texts[lang].register}
            </h2>
            <div className="h-px bg-slate-100 my-3" />
            <form onSubmit={handleAuthAction} className="space-y-3">
              <div>
                <label className="text-sm font-medium text-slate-600">
                  {texts[lang].email}
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full mt-1 h-11 text-[15px] border rounded-lg px-3 py-2
                             focus:outline-none focus:ring-2 focus:ring-emerald-600"
                  disabled={loading}
                  required
                />
              </div>
              <div>
                <label className="text-sm font-medium text-slate-600">
                  {texts[lang].password}
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full mt-1 h-11 text-[15px] border rounded-lg px-3 py-2
                             focus:outline-none focus:ring-2 focus:ring-emerald-600"
                  disabled={loading}
                  required
                />
                {/* Indicador simple de fuerza (opcional, si lo agregaste) */}
                {/* ... */}
              </div>

              {error && (
                <div role="alert" aria-live="assertive"
                  className="rounded-lg bg-red-50 border border-red-200 px-3 py-2 text-sm text-red-700">
                  <p>{error}</p>
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full h-11 rounded-lg bg-slate-800 hover:bg-slate-900
                           text-white font-semibold shadow-sm transition
                           disabled:opacity-60 disabled:cursor-not-allowed"
              >
                {loading ? (
                  <span className="inline-flex items-center gap-2">
                    <MiniSpinner className="h-4 w-4" />
                    {lang === "es" ? "Creando cuenta..." : "Creating account..."}
                  </span>
                ) : (
                  texts[lang].register
                )}
              </button>
            </form>

            <div className="text-center mt-3">
              <button onClick={() => setView('login')}
                className="text-sm text-slate-600 hover:underline">
                {texts[lang].haveAccount}
              </button>
            </div>
          </div>
        )}

        {/* RESET */}
        {view === 'reset' && (
          <div>
            <h2 className="text-xl sm:text-2xl font-semibold text-center text-slate-800">
              {texts[lang].reset}
            </h2>
            <div className="h-px bg-slate-100 my-3" />
            <form onSubmit={handlePasswordReset} className="space-y-3">
              <div>
                <label className="text-sm font-medium text-slate-600">
                  {texts[lang].email}
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full mt-1 h-11 text-[15px] border rounded-lg px-3 py-2
                             focus:outline-none focus:ring-2 focus:ring-emerald-600"
                  disabled={loading}
                  required
                />
              </div>

              {error && (
                <div role="alert" aria-live="assertive"
                  className="rounded-lg bg-red-50 border border-red-200 px-3 py-2 text-sm text-red-700">
                  <p>{error}</p>
                </div>
              )}
              {message && (
                <p className="text-sm text-green-600">{message}</p>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full h-11 rounded-lg bg-slate-900 hover:bg-slate-700
                           text-white font-semibold shadow-sm transition
                           disabled:opacity-60 disabled:cursor-not-allowed"
              >
                {loading ? (
                  <span className="inline-flex items-center gap-2">
                    <MiniSpinner className="h-4 w-4" />
                    {lang === "es" ? "Enviando..." : "Sending..."}
                  </span>
                ) : (
                  texts[lang].send
                )}
              </button>
            </form>

            <div className="text-center mt-3">
              <button onClick={() => setView('login')}
                className="text-sm text-slate-600 hover:underline">
                {texts[lang].login}
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Footer (igual que lo ten√©s) */}
      <footer className="px-4 sm:px-6 pb-8 mt-10">
  <div className="max-w-6xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-3 text-sm text-slate-500">
    <div className="flex items-center gap-3">
      <button type="button" onClick={() => setTermsOpen(true)}   className="hover:underline">{texts[lang].terms}</button>
      <span className="opacity-50">‚Ä¢</span>
      <button type="button" onClick={() => setPrivacyOpen(true)} className="hover:underline">{texts[lang].privacy}</button>
      <span className="opacity-50">‚Ä¢</span>
      <button type="button" onClick={() => setHelpOpen(true)}    className="hover:underline">{texts[lang].help}</button>
      <span className="opacity-50">‚Ä¢</span>
      <button type="button" onClick={() => setNewsOpen(true)}    className="hover:underline">{texts[lang].news}</button>
    </div>

    <div className="flex items-center gap-3">
      <span>v1.0.0</span>
      <span className="opacity-50">‚Ä¢</span>
      <span>¬© {new Date().getFullYear()} Coachex-Pro</span>
      <select value={lang} onChange={(e)=>setLang(e.target.value)} className="ml-2 rounded-md border px-2 py-1">
        <option value="es">ES</option><option value="en">EN</option>
      </select>
    </div>
  </div>
</footer>

      {/* Modales (igual) */}
      {termsOpen   && <TermsModal   lang={lang} open={termsOpen}   onClose={() => setTermsOpen(false)} />}
      {privacyOpen && <PrivacyModal lang={lang} open={privacyOpen} onClose={() => setPrivacyOpen(false)} />}
      {helpOpen    && <HelpModal    lang={lang} open={helpOpen}    onClose={() => setHelpOpen(false)} />}
      {newsOpen    && <NewsModal    lang={lang} open={newsOpen}    onClose={() => setNewsOpen(false)} />}

      {/* Overlay de carga global (si lo agregaste) */}
      {loading && (
        <div className="fixed inset-0 z-[60] grid place-items-center bg-white/60 backdrop-blur-sm">
          <div className="flex flex-col items-center gap-3 text-slate-700">
            <MiniSpinner className="h-6 w-6" />
            <p className="text-sm">
              {lang === "es" ? "Procesando..." : "Processing..."}
            </p>
          </div>
        </div>
      )} 

    </div> 
  </main>  
);          
}           


// === Wrapper visual reutilizable ===
function BienvenidaCoachex({ children }) {
  return (
    <main className="min-h-[calc(100vh-80px)] relative overflow-hidden bg-gradient-to-b from-gray-50 via-white to-white">
      {/* Ornamentos suaves */}
      <div className="pointer-events-none absolute -top-24 -left-24 h-72 w-72 rounded-full bg-emerald-100/50 blur-3xl" />
      <div className="pointer-events-none absolute -bottom-24 -right-24 h-72 w-72 rounded-full bg-emerald-50/70 blur-3xl" />

      <div className="max-w-5xl mx-auto px-4 sm:px-6 py-10 sm:py-12">
        {children}
      </div>
    </main>
  );
}

// === REEMPLAZAR tu componente por este ===
function OnboardingClubSetup({ user, setHasClubs, onLogout }) {
  // Mostrar d√≠as completos pero manejar c√≥digo corto internamente
  const DIAS = [
    { label: "Lunes",     code: "Lu" },
    { label: "Martes",    code: "Ma" },
    { label: "Mi√©rcoles", code: "Mi" },
    { label: "Jueves",    code: "Ju" },
    { label: "Viernes",   code: "Vi" },
    { label: "S√°bado",    code: "Sa" },
    { label: "Domingo",   code: "Do" },
  ];
  const getLabelByCode = (code) => DIAS.find(d => d.code === code)?.label || code;

  // ---- State
  const [nombre, setNombre] = React.useState("");
  const [modalidad, setModalidad] = React.useState("Por Clase");
  const [repProfesor, setRepProfesor] = React.useState(60); // edit√°s este
  const repClub = Math.max(0, Math.min(100, 100 - Number(repProfesor || 0))); // se calcula solo

  const [horario, setHorario] = React.useState([
    { id: cryptoRandomId(), diaCode: "Lu", desde: "08:00", hasta: "12:00" },
  ]);

  const [preciosClase, setPreciosClase] = React.useState({ p1: 0, p2: 0, p3: 0, p4: 0, escuelita: 0 });
  const [preciosMensual, setPreciosMensual] = React.useState({ x1: 0, x2: 0, x3: 0, libre: 0 });

  // ---- Validaci√≥n
  const profesorValid = Number.isFinite(Number(repProfesor)) && Number(repProfesor) >= 0 && Number(repProfesor) <= 100;
  const invalidIds = horario.filter(b => !isBlockValid(b)).map(b => b.id);
  const horariosValidos = invalidIds.length === 0;
  const canSave = user && nombre.trim().length > 0 && profesorValid && horariosValidos;

  // ---- Helpers
  function cryptoRandomId() { return Math.random().toString(36).slice(2, 10); }
  function toMinutes(hhmm) { if (!hhmm || typeof hhmm !== "string") return NaN; const [h, m] = hhmm.split(":").map(Number); return h * 60 + (m || 0); }
  function isBlockValid(b) { const d = toMinutes(b.desde); const h = toMinutes(b.hasta); return Number.isFinite(d) && Number.isFinite(h) && d < h; }

  const addBloque    = () => setHorario(h => [...h, { id: cryptoRandomId(), diaCode: "Lu", desde: "08:00", hasta: "12:00" }]);
  const removeBloque = (id) => setHorario(h => h.filter(b => b.id !== id));
  const updateBloque = (id, patch) => setHorario(h => h.map(b => b.id === id ? { ...b, ...patch } : b));

  const onChangeMoney = (objSetter) => (key) => (e) => {
    const raw = (e.target.value || "").replace(",", ".");
    const n = raw === "" ? "" : Number(raw);
    objSetter(prev => ({ ...prev, [key]: isNaN(n) ? 0 : n }));
  };

  const guardar = async () => {
    try {
      const ref = db.collection("users").doc(user.uid).collection("clubs").doc();
      const doc = {
        nombre,
        modalidadCobroPrincipal: modalidad,
        reparto: { profesor: Number(repProfesor)||0, club: repClub },
        // Guardamos tanto el code como el label para facilitar lecturas futuras
        horarioLaboral: horario.map(b => ({
          diaCode: b.diaCode,
          diaLabel: getLabelByCode(b.diaCode),
          desde: b.desde,
          hasta: b.hasta
        })),
        precios: {
          porClase: {
            "1": Number(preciosClase.p1)||0,
            "2": Number(preciosClase.p2)||0,
            "3": Number(preciosClase.p3)||0,
            "4": Number(preciosClase.p4)||0,
            escuelita: Number(preciosClase.escuelita)||0
          },
          mensuales: {
            x1: Number(preciosMensual.x1)||0,
            x2: Number(preciosMensual?.x2 ?? preciosMensual.x2)||0,
            x3: Number(preciosMensual.x3)||0,
            libre: Number(preciosMensual.libre)||0
          }
        },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await ref.set(doc);
      setHasClubs(true);
    } catch (err) {
      console.error("Error guardando club:", err);
      alert("No se pudo guardar. Revis√° la consola para m√°s detalles.");
    }
  };

  // ---- UI (embellecida con wrapper + layout + aside)
  return (
    <BienvenidaCoachex>
      {/* Header */}
      <div className="text-center">
        <img
          src="./logo_favicon.png"
          alt="Coachex-Pro"
          className="w-20 h-20 mx-auto rounded-full ring-2 ring-white/80 shadow-sm"
          onError={(e) => {
            e.currentTarget.onerror = null;
            e.currentTarget.src = "/img/logo_favicon.png"; // fallback por si cambia el base path
          }}
        />
        <h1 className="mt-4 text-3xl sm:text-4xl font-semibold tracking-tight text-slate-900">
          Bienvenido a Coachex-Pro
        </h1>
        <p className="mt-2 text-slate-600">
          Gesti√≥n integral para profesores de tenis y p√°del.
        </p>
        <p className="text-slate-400">
          Carg√° la informaci√≥n del Club en donde trabaj√°s.
        </p>
      </div>

      {/* Contenido principal: Cards + Lateral */}
      <div className="mt-8 grid gap-6 md:grid-cols-3">
        {/* Columna principal con tus cards */}
        <section className="md:col-span-2 space-y-6">
          {/* Card contenedora ‚ÄúSetup‚Äù (opcional: agrega borde/sombra suave) */}
          <div className="bg-white/90 backdrop-blur rounded-2xl shadow-sm border border-slate-200">
            <div className="px-5 sm:px-6 py-4 border-b">
              <h2 className="text-base sm:text-lg font-semibold text-[#34745B]">
                Completar datos del Club
              </h2>
              <p className="text-xs text-slate-500">
                Esto nos ayuda a personalizar tus comprobantes y agenda.
              </p>
            </div>

            <div className="p-5 sm:p-6">
              {/* === Tus Cards existentes (sin tocar l√≥gica) === */}
              <div className="grid md:grid-cols-2 gap-6">
                {/* Configuraci√≥n General */}
                <SetupCard title="Configuraci√≥n General">
                  <SetupLabel>Nombre del Club</SetupLabel>
                  <SetupInput value={nombre} onChange={e=>setNombre(e.target.value)} placeholder="Ej: Club..." />

                  <SetupLabel className="mt-4">Modalidad de Cobro Principal</SetupLabel>
                  <SetupSelect value={modalidad} onChange={e=>setModalidad(e.target.value)}>
                    <option>Por Clase</option>
                    <option>Mensual</option>
                  </SetupSelect>

                  <div className="grid grid-cols-2 gap-3 mt-4 items-end">
                    <SetupPercentField
                      label="Reparto (Profesor)"
                      value={repProfesor}
                      onChange={e => {
                        const v = Math.max(0, Math.min(100, Number(e.target.value || 0)));
                        setRepProfesor(v);
                      }}
                    />
                    <SetupPercentField
                      label="Reparto (Club)"
                      value={repClub}
                      readOnly
                      tooltip="Se calcula autom√°ticamente como 100% - Profesor"
                    />
                  </div>
                  {!profesorValid && (
                    <p className="mt-2 text-xs text-red-600">El % del profesor debe estar entre 0 y 100.</p>
                  )}
                </SetupCard>

                {/* Horario Laboral */}
                <SetupCard title="Horario Laboral">
                  <div className="space-y-3">
                    {horario.map(b => {
                      const invalid = !isBlockValid(b);
                      return (
                        <div key={b.id}>
                          <div className="flex flex-wrap items-center gap-2">
                            <SetupSelect
                              value={b.diaCode}
                              onChange={e=>updateBloque(b.id, { diaCode: e.target.value })}
                              className="w-40"
                            >
                              {DIAS.map(d => (
                                <option key={d.code} value={d.code}>{d.label}</option>
                              ))}
                            </SetupSelect>

                            <SetupTimeField
                              value={b.desde}
                              onChange={e=>updateBloque(b.id, { desde: e.target.value })}
                              invalid={invalid}
                              aria-label="Desde"
                            />
                            <span className="text-slate-400 select-none">‚Äî</span>
                            <SetupTimeField
                              value={b.hasta}
                              onChange={e=>updateBloque(b.id, { hasta: e.target.value })}
                              invalid={invalid}
                              aria-label="Hasta"
                            />

                            <button
                              className="inline-flex items-center gap-1 rounded-full border border-red-200 text-red-600 px-3 py-1.5 text-sm hover:bg-red-50"
                              onClick={()=>removeBloque(b.id)}
                            >
                              Quitar
                            </button>
                          </div>
                          {invalid && (
                            <p className="mt-1 text-xs text-red-600">
                              El horario no es v√°lido. <span className="font-medium">‚ÄúDesde‚Äù</span> debe ser menor que <span className="font-medium">‚ÄúHasta‚Äù</span>.
                            </p>
                          )}
                        </div>
                      );
                    })}
                  </div>

                  <button onClick={addBloque}
                          className="mt-3 w-full border-2 border-dashed rounded-xl py-2 text-slate-500 hover:bg-slate-50">
                    + Agregar bloque
                  </button>

                  {!horariosValidos && (
                    <p className="mt-2 text-xs text-red-600">Revis√° los bloques en rojo antes de continuar.</p>
                  )}
                </SetupCard>

                {/* Precios por Clase */}
                <SetupCard title="Precios por Clase">
                  <div className="space-y-3">
                    <SetupMoneyField label="Clase para 1 persona" value={preciosClase.p1} onChange={onChangeMoney(setPreciosClase)("p1")} />
                    <SetupMoneyField label="Clase para 2 personas" value={preciosClase.p2} onChange={onChangeMoney(setPreciosClase)("p2")} />
                    <SetupMoneyField label="Clase para 3 personas" value={preciosClase.p3} onChange={onChangeMoney(setPreciosClase)("p3")} />
                    <SetupMoneyField label="Clase para 4 personas" value={preciosClase.p4} onChange={onChangeMoney(setPreciosClase)("p4")} />
                    <SetupMoneyField label="Escuelita" value={preciosClase.escuelita} onChange={onChangeMoney(setPreciosClase)("escuelita")} />
                  </div>
                </SetupCard>

                {/* Precios Mensuales */}
                <SetupCard title="Precios Mensuales">
                  <div className="space-y-3">
                    <SetupMoneyField label="1 vez por semana" value={preciosMensual.x1} onChange={onChangeMoney(setPreciosMensual)("x1")} />
                    <SetupMoneyField label="2 veces por semana" value={preciosMensual.x2} onChange={onChangeMoney(setPreciosMensual)("x2")} />
                    <SetupMoneyField label="3 veces por semana" value={preciosMensual.x3} onChange={onChangeMoney(setPreciosMensual)("x3")} />
                    <SetupMoneyField label="Libre" value={preciosMensual.libre} onChange={onChangeMoney(setPreciosMensual)("libre")} />
                  </div>
                </SetupCard>
              </div>

              {/* CTA */}
              <div className="mt-8 text-center">
                <button
                  className="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-6 py-3 text-white font-semibold shadow hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled={!canSave}
                  onClick={guardar}
                >
                  Guardar y Comenzar
                </button>
                {!canSave && (
                  <p className="text-xs text-slate-500 mt-2">
                    Complet√° el nombre del club, un % de profesor v√°lido y correg√≠ los horarios en rojo.
                  </p>
                )}
              </div>

              <div className="mt-4 text-center">
                <button
                  onClick={onLogout}
                  className="inline-flex items-center justify-center rounded-xl border border-slate-300 px-6 py-2 text-slate-600 hover:bg-slate-100"
                >
                  Volver al inicio de sesi√≥n
                </button>
              </div>
            </div>
          </div>
        </section>

        {/* Lateral con ‚Äúbeneficios‚Äù + tip */}
        <aside className="space-y-3">
  {/* Beneficio: r√°pido */}
  <div className="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
    <div className="flex items-start gap-3">
      <div className="shrink-0 h-9 w-9 rounded-xl grid place-content-center bg-emerald-50">‚ö°</div>
      <div>
        <h3 className="font-semibold text-slate-800">R√°pido de completar</h3>
        <p className="text-sm text-slate-600">
          Solo pedimos lo esencial para empezar a facturar y agendar.
        </p>
      </div>
    </div>
  </div>

  {/* Beneficio: datos seguros */}
  <div className="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
    <div className="flex items-start gap-3">
      <div className="shrink-0 h-9 w-9 rounded-xl grid place-content-center bg-emerald-50">üîí</div>
      <div>
        <h3 className="font-semibold text-slate-800">Datos seguros</h3>
        <p className="text-sm text-slate-600">
          Tus datos se guardan en tu cuenta y solo vos pod√©s verlos.
        </p>
      </div>
    </div>
  </div>

  {/* Beneficio: reportes autom√°ticos */}
  <div className="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
    <div className="flex items-start gap-3">
      <div className="shrink-0 h-9 w-9 rounded-xl grid place-content-center bg-emerald-50">üìä</div>
      <div>
        <h3 className="font-semibold text-slate-800">Reportes autom√°ticos</h3>
        <p className="text-sm text-slate-600">
          Obten√© reportes mensuales y anuales listos para compartir.
        </p>
      </div>
    </div>
  </div>

  {/* Checklist inicial */}
  <div className="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
    <h3 className="font-semibold text-slate-800 mb-2">Checklist inicial</h3>
    <ul className="text-sm text-slate-600 space-y-1 list-disc list-inside">
      <li>Carg√° tu club y horarios</li>
      <li>Defin√≠ precios por clase y mensuales</li>
      <li>Agreg√° tus alumnos</li>
      <li>¬°Listo para agendar clases!</li>
    </ul>
  </div>

  {/* Soporte r√°pido */}
  <div className="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
    <div className="flex items-start gap-3">
      <div className="shrink-0 h-9 w-9 rounded-xl grid place-content-center bg-emerald-50">ü§ù</div>
      <div>
        <h3 className="font-semibold text-slate-800">¬øNecesit√°s ayuda?</h3>
        <p className="text-sm text-slate-600">
          Te acompa√±amos a configurar tu club paso a paso.
        </p>
        <a
          href="https://wa.me/5493810000000"
          target="_blank"
          rel="noopener"
          className="inline-block mt-2 text-emerald-700 text-sm font-medium hover:underline"
          title="Abrir WhatsApp"
        >
          Abrir WhatsApp ‚Üí
        </a>
      </div>
    </div>
  </div>

  {/* Tip √∫til */}
  <div className="bg-emerald-50/60 rounded-2xl border border-emerald-200 p-4">
    <h4 className="font-semibold text-emerald-900">Tip</h4>
    <p className="text-sm text-emerald-800">
      Agreg√° tus <strong>pol√≠ticas de cancelaci√≥n</strong> en Perfil para que
      figuren en los comprobantes y recordatorios de WhatsApp.
    </p>
  </div>

  {/* Inspiraci√≥n / motivacional */}
  <div className="bg-gradient-to-r from-emerald-100 to-emerald-50 rounded-2xl p-4 border border-emerald-200">
    <p className="text-sm italic text-emerald-900">
      ‚ÄúOrganiz√° tu trabajo en minutos y dedicale m√°s tiempo a lo que am√°s: ense√±ar.‚Äù
    </p>
  </div>
</aside>
      </div>
    </BienvenidaCoachex>
  );
}
/* ---------- UI helpers (prefijo Setup para evitar conflictos) ---------- */

const SetupCard = ({ title, children }) => (
  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
    <h3 className="text-lg font-semibold text-emerald-700 mb-3">{title}</h3>
    {children}
  </div>
);

const SetupLabel = ({ children, className="" }) => (
  <label className={`block text-sm text-slate-600 mb-1 ${className}`}>{children}</label>
);

const SetupInput = (props) => (
  <input
    {...props}
    className={`w-full h-11 rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-800 shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-300 ${props.className||""}`}
  />
);

const SetupSelect = (props) => (
  <select
    {...props}
    className={`w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-300 ${props.className||""}`}
  />
);

const SetupPercentField = ({ label, value, onChange, readOnly=false, tooltip }) => (
  <div>
    <SetupLabel>{label}</SetupLabel>
    <div className="relative">
      <SetupInput value={value} onChange={onChange} inputMode="numeric" className="pr-12" readOnly={readOnly} title={tooltip}/>
      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500">%</span>
    </div>
  </div>
);

const SetupMoneyField = ({ label, value, onChange }) => (
  <div>
    <SetupLabel>{label}</SetupLabel>
    <div className="relative">
      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm">ARS $</span>
      <SetupInput value={value} onChange={onChange} inputMode="decimal" placeholder="0" className="pl-16" />
    </div>
  </div>
);

const SetupTimeField = ({ value, onChange, invalid=false, ...rest }) => (
  <div className="relative">
    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 select-none">üïë</span>
    <input
      type="time"
      value={value}
      onChange={onChange}
      {...rest}
      className={[
        "w-[130px] rounded-xl border bg-white pl-8 pr-2 py-2 text-slate-800 focus:outline-none",
        invalid ? "border-red-300 focus:ring-2 focus:ring-red-300" : "border-slate-200 focus:ring-2 focus:ring-emerald-300"
      ].join(" ")}
    />
  </div>
);

    
function MainApp({ user, onLogout }) {
  // ===== Hooks arriba =====
  const [current, setCurrent] = useState("dashboard");
  const [prefillClase, setPrefillClase] = useState(null);
  const [state, setState] = useState({ alumnos: [], clases: [], pagos: [], gastos: [], perfil: {}, grupos: [], otrosIngresos: [], mensualidades: [] });
  const [loading, setLoading] = useState(true);
  const [toast, setToast] = useState("");
  const [isPinModalOpen, setIsPinModalOpen] = useState(false);
  const [actionToConfirm, setActionToConfirm] = useState(null);
  const [payingClase, setPayingClase] = useState(null);
  const [navExpanded, setNavExpanded] = React.useState(false);
  const [focusAlumnoId, setFocusAlumnoId] = useState(null);
  const [claseParaAgendar, setClaseParaAgendar] = useState(null);
  const [payingCuota, setPayingCuota] = useState({ alumno: null, mes: null, year: null }); // ‚úÖ aceptamos year opcional
  const [claseParaEditar, setClaseParaEditar] = useState(null);
  const [nuevoAlumnoId, setNuevoAlumnoId] = useState(null);
  const [clubActivoId, setClubActivoId] = useState(null);
  const [clubes, setClubes] = useState([]);
  const [hasClubs, setHasClubs] = useState(false);
  const [registrandoAbono, setRegistrandoAbono] = useState(null);
  const [pagoParaEditar, setPagoParaEditar] = useState(null);

  // === Handlers de nivel superior (usados en el render) ===
  const openRegistrarClaseForAlumno = React.useCallback((alumnoId) => {
    setCurrent('clases');
    setNuevoAlumnoId(alumnoId ?? null);
  }, []);

  const openPagoPendiente = React.useCallback((clase, alumnoId) => {
    if (!clase) return;
    setPayingClase(clase);
    setFocusAlumnoId(alumnoId ?? null);
  }, []);

  // === Efecto: lista de clubs (con cleanup) ===
  useEffect(() => {
    if (!user) return;
    let alive = true;
    setLoading(true);

    const clubsRef = db.collection('users').doc(user.uid).collection('clubs');
    const clubsUnsubscribe = clubsRef.onSnapshot(
      (snapshot) => {
        if (!alive) return;
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setClubes(data);
        setHasClubs(data.length > 0);
        setClubActivoId(prev => (prev ?? (data[0]?.id || null)));
        setLoading(false);
      },
      (error) => {
        if (!alive) return;
        console.error("Error fetching clubs: ", error);
        setLoading(false);
      }
    );

    return () => { alive = false; clubsUnsubscribe && clubsUnsubscribe(); };
  }, [user]);

  // === Efecto: perfil + colecciones del club (con cleanup) ===
  useEffect(() => {
    if (!user || !clubActivoId) return;
    let alive = true;

    const userRef = db.collection('users').doc(user.uid);
    const baseRef = userRef.collection('clubs').doc(clubActivoId);

    const perfilDocClub = baseRef.collection('perfil').doc('main');
    const perfilDocUser = userRef.collection('profile').doc('main');

    const unsubscribes = [];

    const profileUnsubscribe = perfilDocClub.onSnapshot(
      (snap) => {
        if (!alive) return;

        const perfilDelClub = snap.exists ? snap.data() : {};
        // ‚úÖ Fusi√≥n segura con estructura base (evita undefined en sub-objetos)
        const perfilCompleto = {
          ...initialState.perfil,
          ...perfilDelClub,
          preciosClase: {
            ...(initialState.perfil?.preciosClase || {}),
            ...(perfilDelClub?.preciosClase || {}),
          },
          preciosMensuales: {
            ...(initialState.perfil?.preciosMensuales || {}),
            ...(perfilDelClub?.preciosMensuales || {}),
          },
          datosBancarios: {
            ...(initialState.perfil?.datosBancarios || {}),
            ...(perfilDelClub?.datosBancarios || {}),
          }
        };

        setState(prev => ({ ...prev, perfil: perfilCompleto }));
      },
      (e) => {
        if (!alive) return;
        console.error('Error escuchando el perfil del club:', e);
        setState(prev => ({ ...prev, perfil: initialState.perfil }));
      }
    );
    unsubscribes.push(profileUnsubscribe);

    ['alumnos', 'clases', 'pagos', 'gastos', 'grupos', 'otrosIngresos', 'mensualidades'].forEach((collectionName) => {
      const unsubscribe = baseRef.collection(collectionName).onSnapshot(
        (snapshot) => {
          if (!alive) return;
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setState(prev => ({ ...prev, [collectionName]: data }));
        },
        (error) => console.error(`Error fetching ${collectionName}:`, error)
      );
      unsubscribes.push(unsubscribe);
    });

    return () => { alive = false; unsubscribes.forEach(u => { try { u && u(); } catch (_) {} }); };
  }, [user, clubActivoId]);

  // === Helpers de colecci√≥n ===
  const getCollection = (collectionName) => {
    if (!clubActivoId) {
      console.error("No club active. Cannot get collection.");
      return null;
    }
    return db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId).collection(collectionName);
  };

  // ===== Helpers de normalizaci√≥n (fechas/montos) =====
  const toISO = (d) => {
    const x = d instanceof Date ? d : new Date(d || Date.now());
    const y = x.getFullYear();
    const m = String(x.getMonth() + 1).padStart(2, '0');
    const day = String(x.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  };
  const ymFromDate = (d) => {
    const x = d instanceof Date ? d : new Date(d || Date.now());
    const y = x.getFullYear();
    const m = String(x.getMonth() + 1).padStart(2, '0');
    return `${y}-${m}`;
  };
  const normalMonto = (v) => {
    if (v == null) return 0;
    const s = String(v).replace(/\./g, '').replace(',', '.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  };

  // === CRUDs ===
  const alumnoCrud = {
  create: async (data) => {
    const collectionRef = getCollection('alumnos');
    if (!collectionRef) return;
    const docRef = await collectionRef.add(data); // Espera a que se cree el documento
    setToast("Alumno creado");
    return { ...data, id: docRef.id }; // Devuelve el alumno con su nuevo ID
  },
    update: ({ id, ...data }) => {
      const collectionRef = getCollection('alumnos');
      if (!collectionRef) return;
      return collectionRef.doc(id).update(data).then(() => setToast("Alumno actualizado"));
    },
    delete: (id) => {
    const deleteAction = () => {
      getCollection('alumnos').doc(id).delete().then(() => setToast("Alumno eliminado"));
    };
    setActionToConfirm(() => deleteAction); // Guarda la funci√≥n a ejecutar
    setIsPinModalOpen(true); // Abre el modal de PIN
  },
};

  // ==== Helpers p/ pagos mensuales (poner arriba de pagoCrud)
const pad2 = (n) => String(n).padStart(2, "0");

const toISODate = (v) => {
  if (!v) return null;
  if (v instanceof Date) return v;
  if (typeof v.toDate === "function") return v.toDate(); // Firestore Timestamp
  if (typeof v === "string") {
    const s = v.trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + "T00:00:00");
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
      const [dd, mm, yy] = s.split("/");
      return new Date(`${yy}-${mm}-${dd}T00:00:00`);
    }
  }
  return new Date(v);
};

const normalizaMetodoCobro = (s) => {
  const m = String(s || "").toLowerCase();
  if (m.startsWith("efect")) return "Efectivo";
  if (m.startsWith("transf") || m.startsWith("tx")) return "Transferencia";
  if (m.startsWith("mixto")) return "Mixto";
  if (m.startsWith("pend")) return "Pendiente";
  return s || "Efectivo";
};

  const pagoCrud = {
    createPagosClase: async (pagosData = []) => {
      try {
        const collectionRef = getCollection('pagos');
        if (!collectionRef) { alert('No hay club activo.'); return; }
        if (!payingClase || !payingClase.id) { alert('Clase no definida para pago.'); return; }

        const normMethod = (s) => {
          const m = String(s || '').trim().toLowerCase();
          if (m.startsWith('efect')) return 'Efectivo';
          if (m.startsWith('transf') || m.startsWith('tx')) return 'Transferencia';
          if (m.startsWith('mensu')) return 'Mensual';
          if (m.startsWith('pend')) return 'Pendiente';
          if (m.startsWith('mixto')) return 'Mixto';
          return s || 'Efectivo';
        };
        const isZeroLike = (x) => {
          const n = Number(x);
          return !Number.isFinite(n) || n <= 0;
        };
        const expandMixto = (p) => {
          const metodo = String(p.metodo || '').trim().toLowerCase();
          if (metodo !== 'mixto') return [p];
          const ef = normalMonto(p.mixtoEfectivo ?? p.efectivo ?? p.efectivoMonto ?? p.cash ?? p.contado);
          const tx = normalMonto(p.mixtoTransferencia ?? p.transferencia ?? p.transf ?? p.transferenciaMonto ?? p.tx);
          const out = [];
          if (!isZeroLike(ef)) out.push({ ...p, metodo: 'Efectivo', monto: ef });
          if (!isZeroLike(tx)) out.push({ ...p, metodo: 'Transferencia', monto: tx });
          if (out.length === 0) throw new Error('Pago Mixto sin montos desglosados (Efectivo/Transferencia).');
          return out;
        };

        const items = [];
        for (const p of (pagosData || [])) {
          const metodo = normMethod(p.metodo);
          if (metodo === 'Mixto') {
            items.push(...expandMixto(p));
          } else {
            items.push({ ...p, monto: normalMonto(p.monto), metodo });
          }
        }

        const batch = db.batch();
        for (const p of items) {
          if (p.metodo === 'Pendiente') continue;
          if (isZeroLike(p.monto)) continue;

          const docRef = collectionRef.doc();
          batch.set(docRef, {
            claseId: payingClase.id,
            alumnoId: p.alumnoId,
            fecha: payingClase.fecha, // asumes que ya es "YYYY-MM-DD"
            concepto: `Pago de clase de ${labelSinClase(payingClase.tipo)} (${payingClase.fecha})`,
            metodo: p.metodo,
            monto: Number(p.monto || 0),
          });
        }
        await batch.commit();

        // Recalcular pagada
        const pagosSnap = await collectionRef.where('claseId', '==', payingClase.id).get();
        let totalPagado = 0;
        pagosSnap.forEach(d => { totalPagado += Number(d.data().monto || 0); });

        const claseRef = getCollection('clases').doc(payingClase.id);
        const precioClase = Number(payingClase.precio || 0);
        await claseRef.set({ pagada: totalPagado >= precioClase }, { merge: true });

        setToast("Pagos registrados");
        setPayingClase(null);
        setFocusAlumnoId(null);
        setClaseParaAgendar(payingClase);
      } catch (err) {
        console.error('createPagosClase error:', err);
        alert('No se pudo guardar el/los pagos. Revis√° la consola para m√°s detalles.');
      }
    },

    // ‚úÖ REGISTRO DE ABONO/ CUOTA DESDE MODAL "RegistroPagoMensualModal"
    createAbono: (pagoData, alumno) => {
  const collectionRef = getCollection('pagos');
  if (!collectionRef) return;

  // fecha base -> mes/a√±o del pago
  const dt = toISODate(pagoData.fechaPago) || new Date();
  const y  = Number.isFinite(pagoData.anio) ? pagoData.anio : dt.getFullYear();
  const m  = Number.isFinite(pagoData.mes)  ? pagoData.mes  : dt.getMonth();

  const newPago = {
    alumnoId: alumno.id,
    // fecha ISO YYYY-MM-DD (f√°cil de parsear en todo el sistema)
    fecha: `${y}-${pad2(m+1)}-${pad2(dt.getDate())}`,
    concepto: pagoData.concepto || `Cuota Mensual - ${MESES_NOMBRES[m]}`,
    monto: Number(pagoData.monto || 0),
    metodo: normalizaMetodoCobro(pagoData.metodo),

    // üîë marcadores para Control de Cuotas
    tipo: "Mensualidad",
    periodoYM: `${y}-${pad2(m+1)}`, // ‚Äú2025-09‚Äù
    mes: m,                          // 0..11
    anio: y,
  };

  collectionRef.add(newPago).then(() => {
    setToast("Pago de abono registrado con √©xito");
    setRegistrandoAbono(null);
  });
},

createMensual: (pagoData) => {
  const collectionRef = getCollection('pagos');
  if (!collectionRef) return;
  const { alumno, mes } = payingCuota;

  const base = new Date();
  const y = base.getFullYear();
  const m = Number(mes); // viene del selector

  const newPago = {
    alumnoId: alumno.id,
    fecha: `${y}-${pad2(m+1)}-${pad2(base.getDate())}`,
    concepto: `Cuota Mensual - ${MESES_NOMBRES[m]}`,
    monto: Number(pagoData.monto || 0),
    metodo: normalizaMetodoCobro(pagoData.metodo),

    // üîë marcadores para Control de Cuotas
    tipo: "Mensualidad",
    periodoYM: `${y}-${pad2(m+1)}`,
    mes: m,
    anio: y,
  };

  collectionRef.add(newPago).then(() => {
    setToast("Pago de cuota registrado");
    setPayingCuota({ alumno: null, mes: null });
  });
},


    update: ({ id, ...data }) => {
      const collectionRef = getCollection('pagos');
      if (!collectionRef) return;

      const dataToSave = { ...data };
      if (data.metodo === 'Mixto') {
        dataToSave.detalleMixto = {
          efectivo: parseFloat(data.mixtoEfectivo) || 0,
          transferencia: parseFloat(data.mixtoTransferencia) || 0
        };
      }
      delete dataToSave.mixtoEfectivo;
      delete dataToSave.mixtoTransferencia;

      return collectionRef.doc(id).update(dataToSave).then(() => {
        setToast("Pago actualizado con √©xito");
        setPagoParaEditar(null);
      });
    }
  };

  const claseCrud = {
    create: async (c) => {
      const collectionRef = getCollection('clases');
      if (!collectionRef) return;
      const claseData = { ...c };
      delete claseData.id;

      const shouldPay = claseData.estado === 'Realizada' || claseData.estado === 'Ausente';

      if (claseData.recurrente) {
        const batch = db.batch();
        const semanas = parseInt(claseData.mesesRecurrencia, 10) * 4;
        for (let i = 0; i < semanas; i++) {
          const nuevaFecha = addDays(new Date(claseData.fecha), i * 7);
          const newClase = { ...claseData, fecha: formatDate(nuevaFecha), recurrente: false };
          const docRef = collectionRef.doc();
          batch.set(docRef, newClase);
        }
        await batch.commit();
        setToast("Clases recurrentes creadas");
      } else {
        const docRef = await collectionRef.add(claseData);
        const nuevaClase = { ...claseData, id: docRef.id }; 
        setToast("Clase creada");

        if (shouldPay) {
          setPayingClase(nuevaClase);
        }
        return nuevaClase;
     
      }
    },
    update: ({ id, ...data }) => {
      const collectionRef = getCollection('clases');
      if (!collectionRef) return;

      const shouldPay = data.estado === 'Realizada' || data.estado === 'Ausente';

      return collectionRef.doc(id).update(data).then(() => {
        setToast("Clase actualizada");
        if (shouldPay) setPayingClase({ ...data, id });
      });
    },
    delete: (id) => {
    const deleteAction = async () => {
      const collectionRef = getCollection('clases');
      if (!collectionRef) return;
      await collectionRef.doc(id).delete();
      // Borrar pagos asociados
      const pagosSnapshot = await getCollection('pagos').where('claseId', '==', id).get();
      const batch = db.batch();
      pagosSnapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      setToast("Clase eliminada");
    };
    setActionToConfirm(() => deleteAction);
    setIsPinModalOpen(true);
  },
};

  const gastoCrud = {
    create: (g) => {
      const collectionRef = getCollection('gastos');
      if (!collectionRef) return;
      return collectionRef.add(g).then(() => setToast("Gasto creado"));
    },
    update: ({ id, ...data }) => {
      const collectionRef = getCollection('gastos');
      if (!collectionRef) return;
      return collectionRef.doc(id).update(data).then(() => setToast("Gasto actualizado"));
    },
    delete: (id) => {
    const deleteAction = () => {
        getCollection('gastos').doc(id).delete().then(() => setToast("Gasto eliminado"));
    };
    setActionToConfirm(() => deleteAction);
    setIsPinModalOpen(true);
  },
};

const otrosIngresosCrud = {
    create: (ingreso) => {
        const collectionRef = getCollection('otrosIngresos');
        if (!collectionRef) return;
        return collectionRef.add(ingreso).then(() => setToast("Ingreso registrado"));
    },
    update: ({ id, ...data }) => {
        const collectionRef = getCollection('otrosIngresos');
        if (!collectionRef) return;
        return collectionRef.doc(id).update(data).then(() => setToast("Ingreso actualizado"));
    },
    delete: (id) => {
        const deleteAction = () => {
            getCollection('otrosIngresos').doc(id).delete().then(() => setToast("Ingreso eliminado"));
        };
        setActionToConfirm(() => deleteAction);
        setIsPinModalOpen(true);
    },
};
  // Perfil
  const perfilCrud = {
    update: async (p) => {
      const u = auth.currentUser;
      if (!u || !clubActivoId) return;

      await db.collection('users').doc(u.uid)
        .collection('clubs').doc(clubActivoId)
        .collection('perfil').doc('main')
        .set(p, { merge: true });

      await db.collection('users').doc(u.uid)
        .collection('profile').doc('main')
        .set(p, { merge: true });

      setToast("Perfil actualizado");
    }
  };

  // === Acciones auxiliares ===
  const confirmDelete = async () => {
    const { id, type, collection } = deletingInfo;
    if (!id || !collection) return;
    const collectionRef = getCollection(collection);
    if (!collectionRef) return;
    await collectionRef.doc(id).delete();
    if (type === 'clase') {
      const pagosSnapshot = await getCollection('pagos').where('claseId', '==', id).get();
      const batch = db.batch();
      pagosSnapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    }
    setToast(`${type.charAt(0).toUpperCase() + type.slice(1)} eliminado/a`);
    setDeletingInfo({ id: null, type: null, collection: null });
  };

  const handleRegisterMonthlyPayment = (alumno) => setRegistrandoAbono(alumno);

  const handleExportData = () => {
    const dataToExport = {
      alumnos: state.alumnos,
      clases: state.clases,
      pagos: state.pagos,
      gastos: state.gastos,
      perfil: state.perfil,
      grupos: state.grupos || []
    };
    const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(dataToExport, null, 2))}`;
    const link = document.createElement("a");
    link.href = jsonString;
    const date = new Date().toISOString().slice(0, 10);
    link.download = `coachex_backup_${date}.json`;
    link.click();
    setToast("Datos exportados con √©xito.");
  };

  const handleImportData = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        
        // 1. Confirmaci√≥n de seguridad con el usuario
        const confirmImport = window.confirm(
          "¬°ATENCI√ìN! ¬øEst√°s seguro de que quieres importar estos datos?\n\n" +
          "TODOS TUS DATOS ACTUALES DEL CLUB SELECCIONADO SER√ÅN BORRADOS Y REEMPLAZADOS.\n\n" +
          "Esta acci√≥n no se puede deshacer. Se recomienda exportar un backup antes de continuar."
        );

        if (!confirmImport) {
          event.target.value = null; // Limpiar el input para poder seleccionar el mismo archivo de nuevo
          return;
        }

        // 2. Verificar que el usuario y el club est√©n activos
        if (!user || !clubActivoId) {
          setToast("Error: No se pudo identificar al usuario o al club activo.");
          return;
        }
        
        setToast("Iniciando importaci√≥n... No cierres la p√°gina.");
        const baseRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId);

        // 3. Borrar todos los datos existentes en las colecciones
        const collectionsToWipe = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos', 'otrosIngresos'];
        for (const collectionName of collectionsToWipe) {
          setToast(`Borrando ${collectionName}...`);
          const collectionRef = baseRef.collection(collectionName);
          const snapshot = await collectionRef.limit(500).get(); // Trabajar en lotes de 500
          
          while (snapshot.size > 0) {
            const batch = db.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            // Obtener el siguiente lote si a√∫n hay documentos
            const nextSnapshot = await collectionRef.limit(500).get();
            if (nextSnapshot.size === snapshot.size) break; // Evitar bucle infinito si algo falla
            snapshot = nextSnapshot;
          }
        }

        // 4. Importar los nuevos datos usando Batch Writes
        const collectionsToImport = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos', 'otrosIngresos'];
        for (const collectionName of collectionsToImport) {
          const documents = importedData[collectionName] || [];
          if (documents.length > 0) {
            setToast(`Importando ${documents.length} ${collectionName}...`);
            const collectionRef = baseRef.collection(collectionName);
            let batch = db.batch();
            let count = 0;

            for (const doc of documents) {
              const { id, ...data } = doc;
              // Si el documento tiene un ID del backup, lo respetamos. Si no, Firestore crea uno nuevo.
              const docRef = id ? collectionRef.doc(id) : collectionRef.doc();
              batch.set(docRef, data);
              count++;

              // Si llegamos al l√≠mite del lote, lo ejecutamos y creamos uno nuevo
              if (count === 499) {
                await batch.commit();
                batch = db.batch();
                count = 0;
              }
            }
            // Ejecutar el √∫ltimo lote si quedaron operaciones pendientes
            if (count > 0) {
              await batch.commit();
            }
          }
        }

        // 5. Actualizar el documento de perfil por separado
        if (importedData.perfil) {
          setToast("Actualizando perfil...");
          const perfilRef = baseRef.collection('perfil').doc('main');
          // Usamos 'set' con 'merge: true' para no borrar otros campos que pudieran existir
          await perfilRef.set(importedData.perfil, { merge: true });
        }

        // 6. Feedback final y recarga de la p√°gina
        setToast("¬°Importaci√≥n completada con √©xito! La p√°gina se recargar√°.");
        setTimeout(() => window.location.reload(), 2000);

      } catch (error) {
        setToast("Error: La importaci√≥n fall√≥. Revisa la consola para m√°s detalles.");
        console.error("Error durante la importaci√≥n:", error);
      } finally {
        // Limpiar el input para permitir volver a seleccionar el mismo archivo
        if(event.target) {
            event.target.value = null;
        }
      }
    };
    reader.readAsText(file);
  };

  const goToEditClass = (clase) => { setClaseParaEditar(clase); setCurrent("clases"); };
  const handleDeletePago = (pagoId) => {
  const deleteAction = () => {
    getCollection('pagos').doc(pagoId).delete().then(() => setToast("Pago eliminado"));
  };
  setActionToConfirm(() => deleteAction);
  setIsPinModalOpen(true);
};

  // === Render ===
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="loader"></div>
      </div>
    );
  }

  if (!hasClubs) {
    return (
      <OnboardingClubSetup
        user={user}
        setHasClubs={setHasClubs}
        onLogout={onLogout}
      />
    );
  }

  return (
    <div className="min-h-[100dvh] bg-slate-50 font-sans overflow-x-hidden">
      <SideNav
        current={current}
        setCurrent={setCurrent}
        onLogout={onLogout}
        clubes={clubes}
        clubActivoId={clubActivoId}
        onClubChange={setClubActivoId}
        expanded={navExpanded}
        onExpandChange={setNavExpanded}
      />

<main
  className={
    "bg-white pt-[env(safe-area-inset-top)] " +
    "pb-[calc(72px+env(safe-area-inset-bottom))] md:pb-0 " +
    "transition-[padding] duration-300 " +
    (navExpanded ? "md:pl-56" : "md:pl-16")
  }
>

        <Page>
          {current === "dashboard" && (
            <Dashboard
              perfil={state.perfil}
              clases={state.clases}
              pagos={state.pagos}
              gastos={state.gastos}
              alumnos={state.alumnos}
              clubes={clubes}
              clubActivoId={clubActivoId}
              goToNewClass={(prefill) => { setPrefillClase(prefill || null); setCurrent('clases'); setTimeout(() => document.querySelector('#nueva-clase-btn')?.click(), 50); }}
              goToEditClass={goToEditClass}
            />
          )}

          {current === "alumnos" && (
            <Alumnos
              clases={state.clases}
              pagos={state.pagos}
              alumnos={state.alumnos}
              grupos={state.grupos}
              mensualidades={state.mensualidades} // <-- Prop agregada
              onCreate={alumnoCrud.create}
              onUpdate={alumnoCrud.update}
              onDelete={alumnoCrud.delete}
              onRegisterMonthlyPayment={handleRegisterMonthlyPayment}
              onRegistrarClase={openRegistrarClaseForAlumno}
              onPagarPendiente={openPagoPendiente}
              onEditarPago={(pago) => setPagoParaEditar(pago)}
              onDeletePago={handleDeletePago}
              user={user}
              clubActivoId={clubActivoId}
              perfil={state.perfil}
              setToast={setToast} // <-- Prop agregada
              openRegistrarClaseForAlumno={openRegistrarClaseForAlumno}
            />
          )}

          {current === "clases" && (
            <Clases
              clases={state.clases}
              alumnos={state.alumnos}
              pagos={state.pagos}
              perfil={state.perfil}
              gastos={state.gastos}               
              onCreate={claseCrud.create}
              onUpdate={claseCrud.update}
              onDelete={claseCrud.delete}
              onPay={(clase) => setPayingClase(clase)}
              user={user}
              claseParaEditar={claseParaEditar}
              setClaseParaEditar={setClaseParaEditar}
              nuevoAlumnoId={nuevoAlumnoId}
              setNuevoAlumnoId={setNuevoAlumnoId}
              prefillClase={prefillClase}
              onPrefillConsumed={() => setPrefillClase(null)}
              grupos={state.grupos}
              clubActivoId={clubActivoId}
            />
          )}

          {current === "grupos" && (
  <Grupos
    alumnos={state.alumnos}
    user={user}
    perfil={state.perfil}
    clubActivoId={clubActivoId}
    clases={state.clases}
    pagos={state.pagos}
    getCollection={getCollection}
    setToast={setToast}
  />
          )}

          {current === "pagos" && (
  <Pagos
    pagos={state.pagos}
    alumnos={state.alumnos}
    clases={state.clases}
    perfil={state.perfil}
    onPayMensual={(alumno) => setRegistrandoAbono(alumno)}
    onEditarPago={(pago) => setPagoParaEditar(pago)}
    onDeletePago={handleDeletePago}
    otrosIngresos={state.otrosIngresos}
    otrosIngresosCrud={otrosIngresosCrud}
  />
          )}

          {current === "gastos" && (
            <Gastos
              gastos={state.gastos}
              onCreate={gastoCrud.create}
              onUpdate={gastoCrud.update}
              onDelete={gastoCrud.delete}
            />
          )}

          {current === "reportes" && (
            <Reportes
              pagos={state.pagos}
              gastos={state.gastos}
              alumnos={state.alumnos}
              clases={state.clases}
              clubActivoId={clubActivoId}
              clubes={clubes}
              perfil={state.perfil}
            />
          )}

          {current === "rankings" && (
            <Rankings 
    alumnos={state.alumnos} 
    user={user} 
    clubActivoId={clubActivoId}
    perfil={state.perfil} 
  />
          )}

          {current === "torneos" && (
            <Torneos alumnos={state.alumnos} user={user} clubActivoId={clubActivoId} perfil={state.perfil} />
          )}

          {current === "perfil" && (
            <Perfil
              perfil={state.perfil}
              alumnos={state.alumnos}
              clases={state.clases}
              pagos={state.pagos}
              gastos={state.gastos}
              grupos={state.grupos}
              onUpdate={perfilCrud.update}
              user={user}
              setToast={setToast}
              getCollection={getCollection}
              perfilCrud={perfilCrud}
              openRegistrarClaseForAlumno={openRegistrarClaseForAlumno}
              onExport={handleExportData}
              onImport={handleImportData}
            />
          )}
        </Page>

        <div className="md:hidden" style={{ height: "calc(56px + env(safe-area-inset-bottom))" }} />
      </main>

      <Toast msg={toast} onClose={() => setToast("")} />

      <PinConfirmModal
    isOpen={isPinModalOpen}
    onClose={() => {
      setIsPinModalOpen(false);
      setActionToConfirm(null); // Limpia la acci√≥n al cerrar
    }}
    onConfirm={actionToConfirm} // Pasamos la funci√≥n guardada para que se ejecute si el PIN es correcto
    perfil={state.perfil}
    title="Confirmar Acci√≥n Cr√≠tica"
    message="Esta acci√≥n es irreversible y requiere confirmaci√≥n. Ingresa tu PIN para continuar."
  />

      <PagoGrupalModal
        isOpen={!!payingClase}
        clase={payingClase}
        alumnos={state.alumnos}
        onCancel={() => { setPayingClase(null); setFocusAlumnoId(null); }}
        focusAlumnoId={focusAlumnoId}
        onSave={pagoCrud.createPagosClase}
      />

      {/* ‚úÖ Modal controlado para cuota/abono mensual (desde Alumnos, bot√≥n "Registrar Pago") */}
      <RegistroPagoMensualModal
        isOpen={!!registrandoAbono}
        alumno={registrandoAbono}
        perfil={state.perfil}
        onCancel={() => setRegistrandoAbono(null)}
        onSave={(pagoData) => pagoCrud.createAbono(pagoData, registrandoAbono)}
      />

      {/* ‚úÖ Modal controlado para cuota mensual (desde Pagos ‚Üí Control Mensual) */}
      <PagoMensualModal
        isOpen={!!payingCuota.alumno}
        alumno={payingCuota.alumno}
        mes={payingCuota.mes}
        year={payingCuota.year}
        onCancel={() => setPayingCuota({ alumno: null, mes: null, year: null })}
        onSave={pagoCrud.createMensual}
      />

      <EditarPagoModal
        isOpen={!!pagoParaEditar}
        pago={pagoParaEditar}
        onCancel={() => setPagoParaEditar(null)}
        onSave={pagoCrud.update}
      />

      <AgendarProximaClaseModal
        isOpen={!!claseParaAgendar}
        onClose={() => setClaseParaAgendar(null)}
        onSchedule={claseCrud.create}
        claseBase={claseParaAgendar}
        alumnos={state.alumnos}
        perfil={state.perfil}
      />

      <footer className="text-center text-xs text-slate-500 py-6">
        Coachex-Pro ¬∑ Gesti√≥n de Profesores
      </footer>
    </div>
  );
}



function AgendarProximaClaseModal({ isOpen, onClose, onSchedule, claseBase, alumnos, perfil = {} }) {

  // -- Helpers --
  const parseYMDLocal = (ymd) => {
    if (!ymd) return new Date();
    const [y, m, d] = ymd.split("-").map(Number);
    return new Date(y, (m || 1) - 1, d || 1, 0, 0, 0, 0);
  };

  // TIPOS_CLASE_MAP global si existe (en tu app suele existir). Si no, parseo del texto.
  const TIPOS_CLASE_MAP_LOCAL =
    (typeof TIPOS_CLASE_MAP !== "undefined" && TIPOS_CLASE_MAP) || null;

  const requiredCountFromTipo = (tipo) => {
    if (TIPOS_CLASE_MAP_LOCAL && TIPOS_CLASE_MAP_LOCAL[tipo]) {
      return TIPOS_CLASE_MAP_LOCAL[tipo];
    }
    const m = /Clase\s+(\d+)/i.exec(tipo || "");
    return m ? Math.max(1, parseInt(m[1], 10) || 1) : 1;
  };

  const resizeAlumnoIds = (prevIds, n) => {
    const arr = Array.isArray(prevIds) ? [...prevIds] : [];
    if (arr.length < n) {
      while (arr.length < n) arr.push("");
    } else if (arr.length > n) {
      arr.length = n;
    }
    return arr;
  };

  // -- Estado inicial (respetando zona horaria local) --
  const baseDate = claseBase?.fecha ? parseYMDLocal(claseBase.fecha) : new Date();
  const nextWeekDate = addDays(baseDate, 7);
  const tipoInicial = normalizarTipoClase(claseBase?.tipo) || "Clase 1 persona";
  const reqInicial = requiredCountFromTipo(tipoInicial);

  const [form, setForm] = useState(() => ({
  fecha: formatDate(nextWeekDate),
  hora: claseBase?.hora || "",
  precio: String(getPrecioSugerido(tipoInicial, perfil)), // ‚Üê aqu√≠
  tipo: tipoInicial,
  alumnoIds: resizeAlumnoIds(claseBase?.alumnoIds || [], reqInicial),
}));

  const alumnoMap = useMemo(
    () => new Map((alumnos || []).map((a) => [a.id, a])),
    [alumnos]
  );

  useEffect(() => {
  if (claseBase) {
    const base = parseYMDLocal(claseBase.fecha);
    const next = addDays(base, 7);
    const tipo = normalizarTipoClase(claseBase.tipo) || "Clase 1 persona";
    const req = requiredCountFromTipo(tipo);
    setForm({
  fecha: formatDate(next),
  hora: claseBase.hora || "",
  precio: String(getPrecioSugerido(tipo, perfil)),
  tipo,
  alumnoIds: resizeAlumnoIds(claseBase.alumnoIds || [], req),
});
  }
}, [claseBase]);

  const handleFormChange = (e) => {
  const { name, value } = e.target;
  if (name === "tipo") {
    const canon = normalizarTipoClase(value);
    const req = requiredCountFromTipo(canon);
    setForm((prev) => {
      const nextAlumnoIds = resizeAlumnoIds(prev.alumnoIds, req);
      return {
        ...prev,
        tipo: canon,
        alumnoIds: nextAlumnoIds,
        // --- CORRECCI√ìN ---
        // Ahora s√≠, ponemos el precio sugerido autom√°ticamente
        precio: String(getPrecioSugerido(canon, perfil)),
      };
    });
    return;
  }
  setForm((prev) => ({ ...prev, [name]: value }));
};

  const handleAlumnoChange = (index, newId) => {
  setForm(prev => {
    const nextIds = [...(prev.alumnoIds || [])];
    nextIds[index] = newId;

    const canon = resolveTipoEfectivo(prev.tipo, nextIds); // 4+ => "Escuelita"
    return {
      ...prev,
      tipo: canon,                                           // opcional, si quer√©s reflejar el cambio de tipo
      alumnoIds: nextIds,
      precio: String(getPrecioSugerido(canon, perfil)),      // ‚Üê precio exacto de Perfil
    };
  });
};


  const handleSchedule = () => {
    if (!form.fecha || !form.hora || (form.alumnoIds || []).length === 0) {
      alert("Por favor, completa la fecha, hora y al menos un alumno.");
      return;
    }
    onSchedule(form);
    onClose();
  };

  const getNombreCompleto = (a) =>
    a ? `${a.apellido || ""} ${a.nombre || ""}`.trim() : "Alumno eliminado";
  const alumnosActivos = (alumnos || []).filter((a) => a.estado === "activo");

  if (!isOpen || !claseBase) return null;

  return (
    <Modal
      isOpen={isOpen}
      title="Agendar pr√≥xima clase"
      onCancel={onClose}
      onConfirm={handleSchedule}
      confirmText="Agendar Clase"
      size="2xl"
    >
      <div className="space-y-4">
        <p className="text-sm text-slate-600">
          Se acaba de registrar el pago para la clase de hoy. ¬øDeseas agendar la pr√≥xima?
        </p>

        <div className="grid md:grid-cols-2 gap-4 p-4 border rounded-xl bg-slate-50">
          <div>
            <label className="text-sm text-slate-600">Fecha</label>
            <input
              type="date"
              name="fecha"
              value={form.fecha}
              onChange={handleFormChange}
              className="w-full border rounded-lg px-3 py-2 mt-1"
            />
          </div>

          <div>
            <label className="text-sm text-slate-600">Hora</label>
            <input
              type="time"
              name="hora"
              value={form.hora}
              onChange={handleFormChange}
              className="w-full border rounded-lg px-3 py-2 mt-1"
            />
          </div>

          <div>
            <label className="text-sm text-slate-600">Precio</label>
            <input
              type="number"
              name="precio"
              value={form.precio}
              onChange={handleFormChange}
              className="w-full border rounded-lg px-3 py-2 mt-1"
            />
          </div>

          <div>
            <label className="text-sm text-slate-600">Tipo de Clase</label>
            <select
              name="tipo"
              value={form.tipo}
              onChange={handleFormChange}
              className="w-full border rounded-lg px-3 py-2 mt-1"
            >
              {TIPOS_CLASE.map((t) => (
                <option key={t}>{t}</option>
              ))}
            </select>
          </div>
        </div>

        <div className="p-4 border rounded-xl bg-slate-50">
          <label className="text-sm text-slate-600">Alumnos</label>
          <div className="grid gap-2 mt-1">
            {(form.alumnoIds || []).map((alumnoId, index) => (
              <div key={index}>
                <select
                  value={alumnoId}
                  onChange={(e) => handleAlumnoChange(index, e.target.value)}
                  className="w-full border rounded-lg px-3 py-2"
                >
                  <option value="">Seleccionar...</option>
                  {alumnosActivos.map((a) => (
                    <option key={a.id} value={a.id}>
                      {getNombreCompleto(a)}
                    </option>
                  ))}
                </select>
              </div>
            ))}
          </div>
        </div>
      </div>
    </Modal>
  );
}



    // ------------------------------ APP WRAPPER WITH AUTH ------------------------------
function AppGPadel() {
  const [user, setUser] = useState(null);
  const [stage, setStage] = useState('loading'); // 'loading' | 'login' | 'verify' | 'app'

  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (u) => {
      try {
        if (!u) { setUser(null); setStage('login'); return; }

        await u.reload(); // refresca emailVerified

        const providerIds = (u.providerData || []).map(p => p.providerId);
        const isEmailPwd = providerIds.includes('password');

        if (isEmailPwd && !u.emailVerified) { setUser(u); setStage('verify'); return; }
        if (isEmailPwd && u.emailVerified)  { await u.getIdToken(true); } // ‚¨ÖÔ∏è token fresco

        setUser(u);
        setStage('app');
      } catch (e) {
        console.error('onAuthStateChanged error:', e);
        setUser(null);
        setStage('login');
      }
    });
    return () => unsubscribe();
  }, []);

  if (stage === 'loading') return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;
  if (stage === 'login')   return <LoginScreen />;
  if (stage === 'verify')  return <VerifyEmail user={user} onLogout={() => auth.signOut()} />;
  return <MainApp user={user} onLogout={() => auth.signOut()} />;
}

function VerifyEmail({ user, onLogout }) {
  // --- INICIO DE LA CORRECCI√ìN ---
  // Si por alguna raz√≥n el usuario es nulo, no renderizamos nada para evitar el error.
  if (!user) {
    return (
        <div className="min-h-screen flex items-center justify-center">
            <div className="loader"></div>
        </div>
    );
  }
  // --- FIN DE LA CORRECCI√ìN ---

  const [sent, setSent] = useState(false);
  const resend = async () => { await user.sendEmailVerification(); setSent(true); };
  const recheck = async () => {
    await user.reload();
    if (user.emailVerified) { await user.getIdToken(true); window.location.reload(); }
  };
  return (
    <div className="min-h-screen flex flex-col items-center justify-center gap-4 p-6">
      <h2 className="text-xl font-semibold">Verific√° tu email</h2>
      <p>Te enviamos un correo a <b>{user.email}</b>.</p>
      <div className="flex gap-3">
        <button onClick={resend} className="btn">{sent ? 'Reenviado ‚úÖ' : 'Reenviar correo'}</button>
        <button onClick={recheck} className="btn">Ya verifiqu√©</button>
        <button onClick={onLogout} className="btn btn-outline">Cambiar de cuenta</button>
      </div>
    </div>
  );
}

class ErrorBoundary extends React.Component {
  constructor(props){ super(props); this.state = { hasError: false }; }
  static getDerivedStateFromError(){ return { hasError: true }; }
  componentDidCatch(error, info){ console.error('ErrorBoundary:', error, info); }
  render(){
    if (this.state.hasError) {
      return (
        <div className="p-6 text-center text-red-700">
          Ocurri√≥ un error en la vista. Prob√° recargar o volver al inicio.
          <div className="mt-4">
            <button onClick={() => this.setState({ hasError:false })} className="btn">Reintentar</button>
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}

ReactDOM.render(
  <ErrorBoundary><AppGPadel /></ErrorBoundary>,
  document.getElementById('root')
);
</script>

<!-- === PDF A4 (centrado + info real) - injected by ChatGPT === -->
<script>
(function(){
  function makeLabelFn(torneo){
    const pools = [
      torneo?.alumnos, torneo?.alumnosList,
      (torneo && torneo.alumnosSnapshot && torneo.alumnosSnapshot.alumnos),
      window.__alumnos, window.alumnos,
      (window.__appState && window.__appState.alumnos)
    ].filter(Boolean);
    const map = new Map();
    pools.forEach(arr => { try{ (arr||[]).forEach(a=>{ if(a?.id) map.set(a.id,a); }); }catch(_){} });
    function alumnoById(id){ return (id ? (map.get(id) || null) : null); }
    function labelAlumnoById(id){
      const a = alumnoById(id);
      if (!a) return id || "‚Äî";
      const ap = a.apellido || ""; const no = a.nombre || a.name || "";
      return `${ap ? ap + ", " : ""}${no || a.id || "‚Äî"}`.trim();
    }
    return function labelEntrada(e, t){
      t = t || torneo;
      if (t?.modalidad === "dobles") {
        const team = (e && e.members) ? e : (t.teams || []).find(tt => tt.id === (typeof e === "string" ? e : e?.id));
        if (!team) return (e?.label || e?.id || "‚Äî");
        if (team.label) return team.label;
        const [id1, id2] = team.members || [];
        const A = labelAlumnoById(id1); const B = labelAlumnoById(id2);
        return (A && B) ? `${A} / ${B}` : (A || B || "‚Äî");
      } else {
        if (e?.label) return e.label;
        const id = (typeof e === "string") ? e : e?.id;
        return labelAlumnoById(id);
      }
    };
  }

  function collectKOMatches(node, acc){
    acc = acc || [];
    if (!node) return acc;
    if (Array.isArray(node)){ node.forEach(n => collectKOMatches(n, acc)); return acc; }
    if (typeof node === "object"){
      const isMatch = ("jugadorA" in node) || ("jugadorB" in node) || ("resultado" in node) || ("score" in node);
      if (isMatch) acc.push(node);
      Object.values(node).forEach(v => { if (v && typeof v === "object") collectKOMatches(v, acc); });
    }
    return acc;
  }

  function flattenGroupFixture(t){
    const out = [];
    const fixture = t?.fixture || {};
    const grupos = t?.grupos || [];
    grupos.forEach(g => {
      const gid = g.id || g.nombre;
      const rondas = fixture[gid];
      const list = [];
      if (Array.isArray(rondas)){
        rondas.forEach(r => ((r?.matches || r?.partidos || r || [])).forEach(m => {
          if (m && (m.jugadorA != null || m.jugadorB != null)) list.push(m);
        }));
      }
      out.push({ group: g, matches: list });
    });
    return out;
  }

  function computeChampion(t){
    const ms = collectKOMatches(t?.cuadro, []);
    if (!ms.length) return null;
    const finalM = ms.find(m => m.isFinal || m.final || m.ronda === "final" || m.round === "final") || ms[ms.length-1];
    if (!finalM) return null;
    const res = finalM.resultado;
    const winner = (res === "A") ? finalM.jugadorA : (res === "B" ? finalM.jugadorB : null);
    if (!winner) return null;
    return { winner, score: finalM.score || "" };
  }

  function buildA4TorneoSheet(torneo, showBracket){
    const label = makeLabelFn(torneo);
    const sheet = document.createElement("div");
    sheet.style.cssText = [
      "width:1123px","min-height:794px","background:#fff","color:#0f172a",
      "padding:40px 48px","box-sizing:border-box","border-radius:12px",
      "box-shadow:0 0 0 1px rgba(0,0,0,.04)","font-family:ui-sans-serif,system-ui"
    ].join(";");

    const header = document.createElement("div");
    header.style.cssText = "display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px";

    const brand = document.createElement("div");
    brand.style.cssText = "display:inline-flex;align-items:center;justify-content:center;gap:10px;font-weight:800;font-size:22px;margin:0 auto;line-height:1";
    (function useLogo(){
      const trySel = ['img[alt*=\"Coachex\"]','img[alt*=\"logo\"]','.topbar img','link[rel=\"icon\"]'];
      let src = null;
      for (const s of trySel){
        const el = document.querySelector(s);
        if (!el) continue;
        src = (el.tagName === "LINK") ? el.href : el.src;
        if (src) break;
      }
      if (src){
        const img = document.createElement("img");
        img.src = src; img.alt = "Coachex-Pro";
        img.style.cssText = "width:28px;height:28px;border-radius:9999px;object-fit:cover;display:inline-block;transform:translateY(2px)";
        brand.appendChild(img);
      }
    })();
    const btxt = document.createElement("div"); btxt.textContent = "Coachex-Pro";
    brand.appendChild(btxt);

    const title = document.createElement("div");
    title.textContent = torneo?.nombre || "Torneo";
    title.style.cssText = "font-size:26px;line-height:1.2;font-weight:800;text-align:center;margin-top:4px";

    const sub = document.createElement("div");
    const modo = torneo?.formato === "eliminacion" ? "Eliminaci√≥n" : (torneo?.formato === "grupos_y_eliminacion" ? "Grupos + Eliminaci√≥n" : "Grupos");
    const count = (torneo?.modalidad === "dobles" ? (torneo?.teams || []).length + " parejas" : (torneo?.participantes || []).length + " jugadores");
    const created = torneo?.createdAt ? new Date(torneo.createdAt).toLocaleDateString() : "";
    const topk = (torneo?.topK != null ? `Top-K: ${torneo.topK}` : "");
    const idaVuelta = torneo?.idaVuelta ? "Ida y vuelta: S√≠" : "Ida y vuelta: No";
    sub.textContent = [modo, count, (created ? "Creado: " + created : ""), topk, idaVuelta].filter(Boolean).join(" ¬∑ ");
    sub.style.cssText = "font-size:12px;line-height:1.5;color:#64748b;text-align:center";

    header.appendChild(brand); header.appendChild(title); header.appendChild(sub);
    sheet.appendChild(header);

    const section = document.createElement("div");
    section.style.cssText = "display:flex;flex-direction:column;gap:12px";

    const champion = computeChampion(torneo);
    if (champion){
      const card = document.createElement("div"); card.style.cssText = "border:1px solid #e2e8f0;border-radius:10px;padding:12px";
      const h = document.createElement("div"); h.textContent = "Resultado final"; h.style.cssText = "font-weight:700;margin-bottom:6px";
      const line = document.createElement("div"); line.style.cssText = "font-size:13px";
      line.textContent = `Campe√≥n: ${label(champion.winner, torneo)}${champion.score ? " ¬∑ " + champion.score : ""}`;
      card.appendChild(h); card.appendChild(line);
      section.appendChild(card);
    }

    if (showBracket && torneo?.cuadro){
      const ko = document.createElement("div"); ko.style.cssText = "border:1px solid #e2e8f0;border-radius:10px;padding:12px";
      const h = document.createElement("div"); h.textContent = "Fase Final (resumen)"; h.style.cssText = "font-weight:700;margin-bottom:6px";
      ko.appendChild(h);
      const list = document.createElement("div"); list.style.cssText = "display:grid;grid-template-columns:1fr;gap:6px";
      const matches = collectKOMatches(torneo.cuadro, []);
      if (!matches.length){
        const item = document.createElement("div"); item.style.cssText = "border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px";
        item.textContent = "No hay cruces registrados."; list.appendChild(item);
      } else {
        matches.forEach(m => {
          const A = label(m.jugadorA, torneo), B = label(m.jugadorB, torneo);
          const res = (m.resultado==="A" ? "Ganador A" : (m.resultado==="B" ? "Ganador B" : (m.resultado==="D" ? "Empate" : "")));
          const item = document.createElement("div"); item.style.cssText = "border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px";
          item.textContent = `${A || "‚Äî"} vs ${B || "‚Äî"}${m.score ? " ¬∑ " + m.score : ""}${res ? " ¬∑ " + res : ""}`;
          list.appendChild(item);
        });
      }
      ko.appendChild(list); section.appendChild(ko);
    }

    if (torneo?.grupos){
      const gc = document.createElement("div"); gc.style.cssText = "border:1px solid #e2e8f0;border-radius:10px;padding:12px";
      const h2 = document.createElement("div"); h2.textContent = "Grupos (resumen)"; h2.style.cssText = "font-weight:700;margin-bottom:6px";
      gc.appendChild(h2);
      const fx = flattenGroupFixture(torneo);
      (torneo.grupos || []).forEach((g, idx) => {
        const gh = document.createElement("div"); gh.textContent = `Grupo ${g.nombre || g.id || ""}`; gh.style.cssText = "color:#64748b;margin:6px 0 4px 0";
        gc.appendChild(gh);
        const elist = document.createElement("div"); elist.style.cssText = "display:grid;grid-template-columns:1fr;gap:4px";
        (g.entradas || []).forEach(e => {
          const item = document.createElement("div"); item.style.cssText = "border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px";
          item.textContent = label(e, torneo); elist.appendChild(item);
        });
        gc.appendChild(elist);
        const mx = fx[idx]?.matches || [];
        if (mx.length){
          const t = document.createElement("div"); t.textContent = "Partidos:"; t.style.cssText = "color:#64748b;margin:6px 0 2px 0";
          gc.appendChild(t);
          const mlist = document.createElement("div"); mlist.style.cssText = "display:grid;grid-template-columns:1fr;gap:4px";
          mx.forEach(m => {
            const A = label(m.jugadorA, torneo), B = label(m.jugadorB, torneo);
            const res = (m.resultado==="A" ? "Ganador A" : (m.resultado==="B" ? "Ganador B" : (m.resultado==="D" ? "Empate" : "")));
            const item = document.createElement("div"); item.style.cssText = "border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px";
            item.textContent = `${A || "‚Äî"} vs ${B || "‚Äî"}${m.score ? " ¬∑ " + m.score : ""}${res ? " ¬∑ " + res : ""}`;
            mlist.appendChild(item);
          });
          gc.appendChild(mlist);
        }
      });
      section.appendChild(gc);
    }

    if (!section.children.length){
      const empty = document.createElement("div"); empty.style.cssText = "border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:12px";
      empty.textContent = "Sin datos para mostrar."; section.appendChild(empty);
    }
    sheet.appendChild(section);
    return sheet;
  }

  window.__buildA4TorneoSheet = buildA4TorneoSheet;
})();
</script>

<script>
async 
</script>

<script>
// ====== TORNEOS: Exportaci√≥n PDF A4 (clona #bracket-canvas) ======

/**
 * Construye un contenedor A4 apaisado y clona el bracket visible (id: #bracket-canvas).
 * Centra logo + "Coachex-Pro" y agrega t√≠tulo/metadatos.
 */
function buildA4Root(torneo) {
  const root = document.createElement('div');
  Object.assign(root.style, {
    position: 'fixed',
    left: '-99999px', top: '0',
    width: '1123px', minHeight: '794px',   // A4 horizontal aprox a 96 dpi
    background: '#fff',
    padding: '16px',
    border: '1px solid #e2e8f0',
    borderRadius: '12px',
    fontFamily: 'system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial'
  });

  // Header centrado (logo + Coachex-Pro)
  const header = document.createElement('div');
  header.style.display = 'flex';
  header.style.alignItems = 'center';
  header.style.justifyContent = 'center';
  header.style.gap = '10px';
  header.style.marginBottom = '8px';

  // Usa <link rel="icon"> si existe; si no, fallback a ./img/logo_favicon.png o logo_favicon.png
  let logoSrc = null;
  const linkIcon = document.querySelector('link[rel="icon"], link[rel="shortcut icon"]');
  if (linkIcon && linkIcon.href) logoSrc = linkIcon.href;
  if (!logoSrc) {
    const cands = ['./img/logo_favicon.png', './logo_favicon.png', 'img/logo_favicon.png', 'logo_favicon.png'];
    for (const c of cands) { try { logoSrc = c; break; } catch(_) {} }
  }

  const logo = new Image();
  logo.src = logoSrc || 'logo_favicon.png';
  logo.width = 28; logo.height = 28;
  logo.style.borderRadius = '9999px';
  logo.alt = 'Coachex-Pro';
  header.appendChild(logo);

  const title = document.createElement('div');
  title.style.fontSize = '20px';
  title.style.fontWeight = '800';
  title.textContent = 'Coachex-Pro';
  header.appendChild(title);
  root.appendChild(header);

  // T√≠tulo del torneo + metadatos
  const name = document.createElement('div');
  name.style.fontSize = '22px';
  name.style.fontWeight = '800';
  name.style.textAlign = 'center';
  name.style.marginBottom = '2px';
  name.textContent = torneo?.nombre || 'Torneo';
  root.appendChild(name);

  const meta = document.createElement('div');
  meta.style.fontSize = '12px';
  meta.style.color = '#64748b';
  meta.style.textAlign = 'center';
  meta.style.marginBottom = '12px';

  const esDobles = torneo?.modalidad === 'dobles';
  const parejas  = (torneo?.teams || []).length;
  const jugadores = esDobles ? parejas*2 : (torneo?.participantes || []).length;

  const formato = (torneo?.formato === 'eliminacion' ? 'Eliminaci√≥n' :
                  torneo?.formato === 'grupos_y_eliminacion' ? 'Grupos + Eliminaci√≥n' : 'Grupos');

  const creado = torneo?.createdAt || torneo?.fechaCreacion || Date.now();
  const topK = torneo?.topK != null ? ' ¬∑ Top-K: ' + torneo.topK : '';
  const idaV = (torneo?.formato !== 'eliminacion') ? (' ¬∑ Ida y vuelta: ' + (torneo?.idaVuelta ? 'S√≠' : 'No')) : '';

  meta.textContent = [
    formato,
    esDobles ? (parejas + ' parejas (' + jugadores + ' jugadores)') : (jugadores + ' jugadores'),
    'Creado: ' + new Date(creado).toLocaleDateString(),
    topK, idaV
  ].filter(Boolean).join(' ¬∑ ');
  root.appendChild(meta);

  // Clonar el bracket visible
  const src = document.getElementById('bracket-canvas');
  if (src) {
    const clone = src.cloneNode(true);
    clone.id = 'bracket-canvas-pdf';
    clone.style.transformOrigin = '0 0';
    root.appendChild(clone);
  } else {
    const warn = document.createElement('div');
    warn.style.fontSize = '12px';
    warn.style.color = '#ef4444';
    warn.textContent = '(No se pudo clonar las llaves. Mostrando s√≥lo encabezado)';
    root.appendChild(warn);
  }

  document.body.appendChild(root);
  return root;
}

// Espera a que carguen im√°genes dentro de un nodo
async function waitImages(el) {
  const imgs = Array.from(el.querySelectorAll('img')).filter(i => !i.complete || i.naturalWidth === 0);
  if (!imgs.length) return;
  await Promise.all(imgs.map(img => new Promise(res => {
    img.addEventListener('load', res, { once:true });
    img.addEventListener('error', res, { once:true });
  })));
}

// Exportar A4 a PDF (apaisado), clonando el canvas de brackets
async function exportPDF_A4(torneo, showBracket, setShowBracket) {
  try {
    let revert = false;
    if (!document.getElementById('bracket-canvas') && typeof setShowBracket === 'function') {
      setShowBracket(true);
      revert = true;
      await new Promise(r => setTimeout(r, 60));
    }

    const el = buildA4Root(torneo);
    await waitImages(el);

    if (!window.html2canvas) { alert('html2canvas no est√° disponible.'); return; }
    const canvas = await html2canvas(el, { backgroundColor: '#ffffff', scale: 2 });

    document.body.removeChild(el);
    if (revert) setShowBracket(false);

    const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
    if (!jsPDFCtor) { alert('jsPDF no est√° disponible.'); return; }

    const pdf = new jsPDFCtor('l','pt','a4');
    const W = pdf.internal.pageSize.getWidth();
    const H = pdf.internal.pageSize.getHeight();
    const ratio = Math.min(W / canvas.width, H / canvas.height);
    const w = canvas.width * ratio;
    const h = canvas.height * ratio;

    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', (W - w) / 2, (H - h) / 2, w, h);
    const fn = (torneo?.nombre ? torneo.nombre.replace(/\s+/g,'_') : 'torneo') + '.pdf';
    pdf.save(fn);
  } catch (e) {
    console.error(e);
    alert('No se pudo exportar PDF.');
  }
}
</script>

<script>
/* =================== HELPERS (definidos UNA sola vez) =================== */
if (!window.collectPhoneStrings) window.collectPhoneStrings = function collectPhoneStrings(obj, max = 30) {
  const out = [], stack = [obj], seen = new Set();
  while (stack.length && out.length < max) {
    const cur = stack.pop();
    if (!cur || typeof cur !== "object" || seen.has(cur)) continue;
    seen.add(cur);
    for (const k in cur) {
      const v = cur[k];
      if (typeof v === "string" && /\d{7,}/.test(v)) out.push(v);
      else if (v && typeof v === "object") stack.push(v);
    }
  }
  return out;
};

if (!window.toWaMsisdn) window.toWaMsisdn = function toWaMsisdn(raw, country = "AR") {
  let s = String(raw || "").trim();
  if (s.startsWith("+") || s.startsWith("00")) {
    s = s.replace(/^00/, "+").replace(/[^\d+]/g, "");
  } else {
    s = s.replace(/[^\d]/g, "");
  }
  if (country === "AR") {
    const only = s.replace(/\D/g, "");
    if (s.startsWith("+54")) {
      let rest = only.slice(2);
      rest = rest.replace(/^0+/, "");
      rest = rest.replace(/(^\d{2,4})15/, "$1");
      if (!/^9/.test(rest)) rest = "9" + rest;
      return "54" + rest;
    }
    let loc = only.replace(/^0+/, "");
    loc = loc.replace(/(^\d{2,4})15/, "$1");
    return "549" + loc;
  }
  if (s.startsWith("+")) return s.slice(1).replace(/\D/g, "");
  return s.replace(/\D/g, "");
};

if (!window.findAlumnoPhone) window.findAlumnoPhone = function findAlumnoPhone(alumnoNombre) {
  const row = [...document.querySelectorAll("table tbody tr")]
    .find(r => (r.querySelector("td:nth-child(2)")?.textContent || "").trim() === alumnoNombre);
  const id = row?.dataset?.alumnoId || null;
  let alumno = null;

  if (id && window.__alumnosById) alumno = window.__alumnosById[id];

  if (!alumno && Array.isArray(window.__alumnos)) {
    alumno = window.__alumnos.find(a => {
      const etiqueta = `${a?.apellido ? a.apellido + ", " : ""}${a?.nombre || a?.name || ""}`.trim();
      const etiqueta2 = `${a?.nombre || ""} ${a?.apellido || ""}`.trim();
      return etiqueta === alumnoNombre || etiqueta2 === alumnoNombre;
    });
  }
  if (!alumno) return null;

  const candidates = Array.from(new Set([
    alumno?.whatsapp, alumno?.WhatsApp, alumno?.wasap, alumno?.wpp, alumno?.wapp,
    alumno?.telefono, alumno?.tel, alumno?.cel, alumno?.celular,
    alumno?.movil, alumno?.phone, alumno?.mobile,
    alumno?.["tel√©fono"], alumno?.["m√≥vil"],
    alumno?.contactoPadre, alumno?.contactoMadre,
    alumno?.contacto?.telefono, alumno?.contacto?.whatsapp,
    ...window.collectPhoneStrings(alumno)
  ].filter(Boolean)));

  const raw = candidates.find(s => /\d{7,}/.test(String(s)));
  return raw ? window.toWaMsisdn(raw, "AR") : null;
};
</script>

</body>
</html>
