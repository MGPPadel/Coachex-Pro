<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Coachex-Pro ‚Äì Gesti√≥n de Profesores</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

  <style>:root{
  --brand-dark:#2e8b57;
  --brand-light:#7dd3a6;
  --inner:#3f3f41;
}

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    
      overflow-x: hidden;
    }

/* Loader Pulso Dual */
.loader{
  width:56px; height:56px; border-radius:50%;
  position:relative;
  background: radial-gradient(circle at 30% 30%, var(--brand-light), var(--brand-dark));
  box-shadow: 0 8px 18px rgba(0,0,0,.18);
  animation: pulse-out 1.5s ease-in-out infinite;
  transform-origin:center center;
}
.loader::after{
  content:""; position:absolute; inset:0; margin:auto;
  width:58%; height:58%; border-radius:50%;
  background: var(--inner);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.85);
  animation: pulse-in 1.5s ease-in-out infinite;
  transform-origin:center center;
}
@keyframes pulse-out{
  0%,100%{ transform: scale(1);   opacity:1;   }
  50%    { transform: scale(1.18); opacity:.85; }
}
@keyframes pulse-in{
  0%,100%{ transform: scale(1);   opacity:.9; }
  50%    { transform: scale(0.82); opacity:.75; }
}
@media (prefers-reduced-motion: reduce){
  .loader, .loader::after{ animation:none; }
}
</style>
</head>
<body>
  
  <div class="screen-center" id="app-loader" style="min-height:100vh;display:flex;align-items:center;justify-content:center;">
  <div class="loader" aria-label="Cargando"></div>
</div>
<div id="root"></div>

  <script type="text/babel">
    // --- INICIO DEL C√ìDIGO DE LA APLICACI√ìN ---

    const { useEffect, useMemo, useState, createContext, useContext } = React;

    /**
     * Gesti√≥n de P√°del ‚Äì MVP en React (Canvas) - v25 con Perfil Extendido
     *
     * Cambios aplicados:
     * - (PERFIL) Se a√±aden secciones para Datos Bancarios, Horario Laboral y Pol√≠ticas de Cancelaci√≥n.
     * - (PERFIL) Se a√±ade funcionalidad para copiar datos bancarios al portapapeles.
     * - (CALENDARIO) El calendario ahora lee el Horario Laboral y sombrea las horas no disponibles.
     */

    // ------------------------------ Configuraci√≥n de Firebase ------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDU33ryp3wkbx0oJdhjC6pG3VkfNiqGk0Q",
      authDomain: "coachex-b1d9b.firebaseapp.com",
      projectId: "coachex-b1d9b",
      storageBucket: "coachex-b1d9b.appspot.com",
      messagingSenderId: "894665560100",
      appId: "1:894665560100:web:e8a61e0849f7675e1f88b1"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // --- Helpers de Firebase para mensualidades/pagos/clases ---
const _db = db; // usamos el db que ya inicializaste

  // === Helpers de colecciones (usa "clubes") ===
function pagosRef(user, clubId) {
  return _db
    .collection("users").doc(user.uid)
    .collection("clubes").doc(clubId)
    .collection("pagos");
}

function clasesRef(user, clubId) {
  return _db
    .collection("users").doc(user.uid)
    .collection("clubes").doc(clubId)
    .collection("clases");
}

function mensualidadesRef(user, clubId) {
  return _db
    .collection("users").doc(user.uid)
    .collection("clubes").doc(clubId)
    .collection("mensualidades");
}


// === Componente: CuentaCorrienteAlumno (limpio, usa tu ensureMensualidadParaAlumno existente) ===
function CuentaCorrienteAlumno({ alumno, user, clubId, perfil }) {
  const [loading, setLoading] = React.useState(true);
  const [busy, setBusy] = React.useState(false);
  const [mensualidad, setMensualidad] = React.useState(null);
  const [movimientos, setMovimientos] = React.useState([]);
  const [error, setError] = React.useState("");

  // clave visual YYYY-MM (solo para mostrar)
  const mesClaveUI = React.useMemo(() => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    return `${y}-${m}`;
  }, []);

  // Rango del mes actual (para filtrar por fecha)
  function rangoMesActual() {
    const ini = new Date(`${mesClaveUI}-01T00:00:00`);
    const fin = new Date(ini);
    fin.setMonth(fin.getMonth() + 1);
    return { ini, fin };
  }

  // Carga mensualidad + movimientos
  React.useEffect(() => {
    let alive = true;
    (async () => {
      try {
        setLoading(true);
        setError("");
        if (!user || !clubId || !alumno) return;

        // Usa tu ensureMensualidadParaAlumno (con fechaRef)
        const m = await ensureMensualidadParaAlumno({
          user,
          clubId,
          alumno,
          perfil,
          fechaRef: new Date(),
        });
        setMensualidad(m ? { id: m.id, ...m } : null);

        if (m && Number(m.incluidas || 0) === 0) {
          const refFix = mensualidadesRef(user, clubId).doc(m.id);
          await refFix.set({ incluidas: 1 }, { merge: true });
          m.incluidas = 1;
        }

        if (!alive) return;

        const snap = await pagosRef(user, clubId)
  .where("alumnoId", "==", alumno.id)
  .get();

const { ini, fin } = rangoMesActual();
const movs = [];
snap.forEach((doc) => {
  const p = { id: doc.id, ...doc.data() };
  if (p.metodo === "Mensual" || p.metodo === "Mensual (d√©bito de saldo)") {
    const f = typeof p.fecha === "string"
      ? new Date(`${p.fecha}T00:00:00`)
      : p.fecha?.toDate?.() || p.fecha || null;
    if (!f || (f >= ini && f < fin)) movs.push(p);
  }
});
// ordenar en memoria
movs.sort((a, b) => {
  const fa = typeof a.fecha === "string" ? new Date(`${a.fecha}T00:00:00`) : a.fecha?.toDate?.() || a.fecha || 0;
  const fb = typeof b.fecha === "string" ? new Date(`${b.fecha}T00:00:00`) : b.fecha?.toDate?.() || b.fecha || 0;
  return fb - fa; // desc
});
setMovimientos(movs);
      } catch (e) {
        console.warn("CuentaCorrienteAlumno load:", e);
        setError("No se pudo cargar la cuenta corriente.");
      } finally {
        if (alive) setLoading(false);
      }
    })();
    return () => {
      alive = false;
    };
  }, [user, clubId, alumno, perfil, mesClaveUI]);

  // DocRef de la mensualidad actual
  async function getMensualidadDocRef() {
    if (mensualidad?.id) {
      return mensualidadesRef(user, clubId).doc(mensualidad.id);
    }
    const m = await ensureMensualidadParaAlumno({
      user,
      clubId,
      alumno,
      perfil,
      fechaRef: new Date(),
    });
    if (m?.id) return mensualidadesRef(user, clubId).doc(m.id);
    throw new Error("No se consigui√≥ el documento de mensualidad");
  }

  // Marcar cuota como pagada
  async function marcarCuotaPagada() {
    try {
      setBusy(true);
      const ref = await getMensualidadDocRef();
      await ref.set(
        { pagado: true, pagadoEn: new Date().toISOString() },
        { merge: true }
      );
      setMensualidad((prev) => (prev ? { ...prev, pagado: true } : prev));
    } catch (e) {
      console.error("marcarCuotaPagada:", e);
      setError("No se pudo marcar como pagada.");
    } finally {
      setBusy(false);
    }
  }

  // Reconciliar clases del mes
  async function reconciliarMensualidadUI() {
    try {
      setBusy(true);
      const ref = await getMensualidadDocRef();
      const mSnap = await ref.get();
      const m = { id: mSnap.id, ...mSnap.data() };

      const incluidas = Number(m.incluidas || 0);
      const consumidas = Number(m.consumidas || 0);
      let consumidasLocal = consumidas;

      const { ini, fin } = rangoMesActual();
      const clasesSnap = await clasesRef(user, clubId)
        .where("alumnoIds", "array-contains", alumno.id)
        .get();

      const clasesMes = [];
      clasesSnap.forEach((doc) => {
        const c = { id: doc.id, ...doc.data() };
        const f =
          typeof c.fecha === "string"
            ? new Date(`${c.fecha}T00:00:00`)
            : c.fecha?.toDate?.() || c.fecha || null;
        if (f && f >= ini && f < fin) clasesMes.push(c);
      });
      clasesMes.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

      const pagosMens = pagosRef(user, clubId);

      for (const c of clasesMes) {
        if (consumidasLocal >= incluidas) break;
        const q = await pagosMens
  .where("claseId", "==", c.id)
  .get();

const yaExiste = q.docs.some(doc => {
  const p = doc.data();
  return p.alumnoId === alumno.id && p.metodo === "Mensual";
});

        if (!yaExiste) {
          await pagosMens.add({
            claseId: c.id,
            alumnoId: alumno.id,
            fecha: c.fecha,
            concepto: `Cubre por abono - ${mesClaveUI}`,
            monto: "0",
            metodo: "Mensual",
          });
          consumidasLocal++;
        }
      }

      const nuevasConsumidas = Math.max(consumidas, consumidasLocal);
      await ref.set({ consumidas: nuevasConsumidas }, { merge: true });
      setMensualidad((prev) =>
        prev ? { ...prev, consumidas: nuevasConsumidas } : prev
      );

      // refrescar movimientos
const pagosMesSnap = await pagosRef(user, clubId)
  .where("alumnoId", "==", alumno.id)
  .get();

const { ini: ini2, fin: fin2 } = rangoMesActual();
const mv = [];
pagosMesSnap.forEach((doc) => {
  const p = { id: doc.id, ...doc.data() };
  const f =
    typeof p.fecha === "string"
      ? new Date(`${p.fecha}T00:00:00`)
      : p.fecha?.toDate?.() || p.fecha || null;
  if (
    (p.metodo === "Mensual" || p.metodo === "Mensual (d√©bito de saldo)") &&
    (!f || (f >= ini2 && f < fin2))
  ) {
    mv.push(p);
  }
});

// ordenar desc por fecha en memoria
mv.sort((a, b) => {
  const fa = typeof a.fecha === "string"
    ? new Date(`${a.fecha}T00:00:00`)
    : a.fecha?.toDate?.() || a.fecha || 0;
  const fb = typeof b.fecha === "string"
    ? new Date(`${b.fecha}T00:00:00`)
    : b.fecha?.toDate?.() || b.fecha || 0;
  return fb - fa; // m√°s reciente primero
});

setMovimientos(mv);
    } catch (e) {
      console.error("reconciliarMensualidadUI:", e);
      setError("No se pudo reconciliar la mensualidad.");
    } finally {
      setBusy(false);
    }
  }

  // --- Render ---
  if (!user || !clubId || !alumno) {
    return (
      <Card title="Cuenta Corriente">
        <p>Faltan datos de usuario/club/alumno.</p>
      </Card>
    );
  }
  if (loading) return <div>Cargando...</div>;

  const incluidas = Number(mensualidad?.incluidas || 0);
  const consumidas = Number(mensualidad?.consumidas || 0);
  const restantes = Math.max(incluidas - consumidas, 0);
  const deudaExtra = Number(mensualidad?.deudaExtra || 0);
  const pagado = !!mensualidad?.pagado;

  return (
    <div className="space-y-4">
      {error && (
        <div className="p-3 rounded bg-red-50 text-red-700 text-sm">{error}</div>
      )}

      <Card title={`Cuenta Corriente ‚Äî ${mesClaveUI}`}>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div className="p-3 rounded bg-slate-50">
            <div className="text-slate-500">Incluidas</div>
            <div className="text-lg font-semibold">{incluidas}</div>
          </div>
          <div className="p-3 rounded bg-slate-50">
            <div className="text-slate-500">Consumidas</div>
            <div className="text-lg font-semibold">{consumidas}</div>
          </div>
          <div className="p-3 rounded bg-slate-50">
            <div className="text-slate-500">Restantes</div>
            <div className="text-lg font-semibold">{restantes}</div>
          </div>
          <div className="p-3 rounded bg-slate-50">
            <div className="text-slate-500">Deuda Extra</div>
            <div className="text-lg font-semibold">
              {formatCurrency(deudaExtra)}
            </div>
          </div>
        </div>

        <div className="mt-4 flex items-center gap-2">
          <span
            className={`px-2 py-1 rounded-full text-xs font-semibold ${
              pagado
                ? "bg-emerald-100 text-emerald-800"
                : "bg-amber-100 text-amber-800"
            }`}
          >
            {pagado ? "Cuota Pagada" : "Cuota Pendiente"}
          </span>

          <div className="ml-auto flex gap-2">
            {!pagado && (
              <button
                disabled={busy}
                onClick={marcarCuotaPagada}
                className="px-3 py-1.5 text-sm rounded-lg border bg-emerald-50 text-emerald-700 hover:bg-emerald-100 disabled:opacity-50"
              >
                Marcar cuota como pagada
              </button>
            )}
            <button
              disabled={busy}
              onClick={reconciliarMensualidadUI}
              className="px-3 py-1.5 text-sm rounded-lg border hover:bg-slate-50 disabled:opacity-50"
            >
              Reconciliar clases del mes
            </button>
          </div>
        </div>
      </Card>

      <Card title="Movimientos del mes (Mensual)">
        <table className="min-w-full text-sm">
          <thead>
            <tr className="text-left text-slate-600">
              <th className="p-2">Fecha</th>
              <th className="p-2">Concepto</th>
              <th className="p-2">M√©todo</th>
              <th className="p-2 text-right">Monto</th>
            </tr>
          </thead>
          <tbody>
            {movimientos.length === 0 ? (
              <tr>
                <td colSpan="4" className="text-center py-4 text-slate-400">
                  Sin movimientos de mensualidad este mes.
                </td>
              </tr>
            ) : (
              movimientos.map((m) => (
                <tr key={m.id} className="border-t">
                  <td className="p-2">{formatDate(m.fecha, "dd/mm/yyyy")}</td>
                  <td className="p-2">{m.concepto || "Mensualidad"}</td>
                  <td className="p-2">{m.metodo}</td>
                  <td className="p-2 text-right">
                    {formatCurrency(Number(m.monto || 0))}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </Card>
    </div>
  );
}


    // ------------------------------ Constantes y Utilidades ------------------------------
    const initialState = { 
      alumnos: [], 
      clases: [], 
      pagos: [], 
      gastos: [],
      perfil: {
        nombre: "Profe",
        apellido: "P√°del",
        telefono: "",
        precios: { individual: "5000", dupla: "4000", trio: "3500", cuarteto: "3000", escuelita: "2500" },
        preciosMensuales: { "1xSemana": "18000", "2xSemana": "32000", "3xSemana": "45000", libre: "55000" },
        metodoCobro: "porClase",
        modoTrabajo: "Club",
        canchas: "Club A - Cancha 1\nClub B - Cancha 2",
        // --- NUEVOS CAMPOS A√ëADIDOS ---
        datosBancarios: {
          alias: "",
          cbu: "",
          banco: "",
          titular: ""
        },
        politicasCancelacion: "Las clases deben cancelarse con 24hs de antelaci√≥n para no ser cobradas.",
        horarioLaboral: [
          { dia: "Lunes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Martes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Mi√©rcoles", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Jueves", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "Viernes", activo: true, desde: "09:00", hasta: "20:00" },
          { dia: "S√°bado", activo: false, desde: "10:00", hasta: "14:00" },
          { dia: "Domingo", activo: false, desde: "10:00", hasta: "14:00" },
        ]
        // --- FIN DE NUEVOS CAMPOS ---
      }
    };
    
    const DIAS_SEMANA_NOMBRES = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
    const MESES_NOMBRES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    const DEPORTES = ["P√°del", "Tenis"];
    const ESTADOS_ALUMNO = [{value: "activo", label: "Activo"}, {value: "espera", label: "Lista de espera"}];
    const ESTADOS_CLASE = ["Programada", "Realizada", "Cancelada", "Ausente"];
    const TIPOS_CLASE_MAP = { "Clase 1 persona": 1, "Clase 2 personas": 2, "Clase 3 personas": 3, "Clase 4 personas": 4, Escuelita: 1 };
    const TIPOS_CLASE = Object.keys(TIPOS_CLASE_MAP);

// Mapeo consistente de 'tipo' -> clave de precios del perfil
const PRECIO_KEY_POR_TIPO = {
  "Clase 1 persona": "individual",
  "Clase 2 personas": "dupla",
  "Clase 3 personas": "trio",
  "Clase 4 personas": "cuarteto",
  "Escuelita": "escuelita"
};

// Normaliza etiquetas de tipo de clase a los nombres can√≥nicos usados en la app
function normalizarTipoClase(t) {
  if (!t) return "Clase 1 persona";
  const s = String(t)
    .trim().toLowerCase()
    .replace(/clase\s+para\s+/, '')
    .replace(/^clase\s+/, '')
    .replace(/\s+de\s+/, ' ')
    .replace(/\s+/g, ' ');

  const alias = {
    'individual': 'Clase 1 persona',
    '1': 'Clase 1 persona',
    '1 persona': 'Clase 1 persona',

    'dupla': 'Clase 2 personas',
    '2': 'Clase 2 personas',
    '2 personas': 'Clase 2 personas',

    'trio': 'Clase 3 personas',
    '3': 'Clase 3 personas',
    '3 personas': 'Clase 3 personas',

    'cuarteto': 'Clase 4 personas',
    '4': 'Clase 4 personas',
    '4 personas': 'Clase 4 personas',

    'escuelita': 'Escuelita'
  };
  if (alias[s]) return alias[s];

  const m = s.match(/^(\d)\s*personas?$/);
  if (m) {
    const n = Number(m[1]);
    return n === 1 ? 'Clase 1 persona' : `Clase ${n} personas`;
  }
  return TIPOS_CLASE.includes(t) ? t : 'Clase 1 persona';
}
const getPrecioSugerido = (tipo, perfil) => {
  const key = PRECIO_KEY_POR_TIPO[tipo] || "individual";
  const tabla = (perfil && perfil.precios) ? perfil.precios : {};

};

function computePrecioClase(tipo, alumnoIds, perfil, alumnoMap) {
  const perAlumno = parseFloat(getPrecioSugerido(tipo, perfil) || 0);
  const ids = (alumnoIds || []).filter(Boolean);
  // Si no hay IDs todav√≠a, usamos la cantidad del tipo como base
  const fallbackCount = TIPOS_CLASE_MAP[tipo] || 1;
  // Contar cu√°ntos NO son mensuales
  const noMensuales = ids.filter(id => {
    const a = alumnoMap.get(id);
    return a ? (a.plan !== 'mensual') : true;
  }).length;
  const count = ids.length > 0 ? (noMensuales || ids.length) : fallbackCount;
  return (perAlumno * count).toString();
};
window.computePrecioClase = computePrecioClase;



    const TIPOS_CLASE_NOMBRES = { "Clase 1 persona": "Clase 1 persona", "Clase 2 personas": "Clase 2 personas", "Clase 3 personas": "Clase 3 personas", "Clase 4 personas": "Clase 4 personas", Escuelita: "Escuelita" };
    const METODOS_PAGO = ["Efectivo", "Transferencia", "Mixto", "Mensual","Pendiente"];
    const CATEGORIAS_GASTO = ["Alquiler", "Equipamiento", "Servicios", "Varios"];
    // Alias para compatibilidad con componentes que usan CATEGORIAS_GASTOS
    const CATEGORIAS_GASTOS = CATEGORIAS_GASTO;

    const PLANES_PAGO = [{value: "porClase", label: "Por Clase"}, {value: "mensual", label: "Mensual"}];
    const FRECUENCIAS_MENSUALES = [{value: "1xSemana", label: "1 vez por semana"}, {value: "2xSemana", label: "2 veces por semana"}, {value: "3xSemana", label: "3 veces por semana"}, {value: "libre", label: "Libre"}];
    const MESES_RECURRENCIA = [1, 2, 3, 4, 5, 6, 9, 12];
    const HORAS = Array.from({ length: 16 }, (_, i) => `${String(i + 7).padStart(2, '0')}:00`); // De 07:00 a 22:00
    
    // --- Utilidades ---
// Quita "Clase" o "Clase para" del nombre can√≥nico para evitar "clase de Clase ..."
function labelSinClase(tipo) {
  const base = (TIPOS_CLASE_NOMBRES?.[tipo] ?? tipo ?? '').trim();
  return base.replace(/^Clase\s+(?:para\s+)?/i, '').trim();
}
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toDigits = (s = "") => String(s).replace(/[^0-9]/g, "");
    const waLink = (telefono = "", nombre = "") => {
      const digits = toDigits(telefono);
      if (!digits) return null;
      const msg = encodeURIComponent(`Hola ${nombre || ""}!`);
      return `https://wa.me/${digits}?text=${msg}`;
    };
    const getWeekStartDate = (date) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setHours(0, 0, 0, 0);
      return new Date(d.setDate(diff));
    };
    const parseYMDLocal = (ymd) => {
  if (!ymd || typeof ymd !== 'string') return null;
  const [y, m, d] = ymd.split('-').map(Number);
  return new Date(y, (m || 1) - 1, d || 1, 0, 0, 0, 0);
};
    const addDays = (date, days) => {
  const base = (date instanceof Date) ? date : parseYMDLocal(String(date)) || new Date(date);
  const y = base.getFullYear(), m = base.getMonth(), d = base.getDate();
  return new Date(y, m, d + Number(days || 0), 0, 0, 0, 0);
};
    const formatDate = (date, format = 'yyyy-mm-dd') => {
  if (!date) return '';
  const d = (typeof date === 'string') ? parseYMDLocal(date) : new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  if (format === 'dd/mm') return `${day}/${month}`;
  if (format === 'dd/mm/yyyy') return `${day}/${month}/${year}`;
  return `${year}-${month}-${day}`;
};

// === Mensualidades: utilidades y helpers ===
const FRECUENCIAS_MENSUALES_INCLUIDAS = {
  "1xSemana": 4,
  "2xSemana": 8,
  "3xSemana": 12,
  "libre": 9999
};

const mesClave = (date) => {
  const d = (typeof date === 'string') ? parseYMDLocal(date) : (date instanceof Date ? date : new Date(date));
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
};

async function ensureMensualidadParaAlumno({ user, clubId, alumno, fechaRef, perfil }) {
  if (!user || !clubId || !alumno) return null;
  const mes = mesClave(fechaRef || new Date());
  const id = `${alumno.id}_${mes}`;
  const ref = mensualidadesRef(user, clubId).doc(id);

  const snap = await ref.get();
  if (snap.exists) return { id, ...snap.data() };

  const freq = alumno.frecuencia || '1xSemana';
  const incl = FRECUENCIAS_MENSUALES_INCLUIDAS[freq] ?? 4;
  const monto = String((perfil?.preciosMensuales?.[freq]) || (initialState?.perfil?.preciosMensuales?.[freq]) || "0");

  const nueva = {
    alumnoId: alumno.id,
    mes,
    frecuencia: freq,
    incluidas: incl,
    consumidas: 0,
    monto,
    deudaExtra: "0",
    pagado: false,
    estado: "pendiente",
    creadoEn: firebase.firestore.FieldValue.serverTimestamp()
  };
  await ref.set(nueva, { merge: true });
  return { id, ...nueva };
}

async function consumirClaseMensual({ user, clubId, alumno, fechaClase, perfil, excedentePorClase = "0" }) {
  const m = await ensureMensualidadParaAlumno({ user, clubId, alumno, fechaRef: fechaClase, perfil });
  if (!m) return;


  const ref = mensualidadesRef(user, clubId).doc(m.id);

  const consumidas = Number(m.consumidas || 0) + 1;
  let deudaExtra = Number(m.deudaExtra || 0);
  const incl = Number(m.incluidas || 0);

  const updates = { consumidas };
  if (consumidas > incl) {
    deudaExtra += Number(excedentePorClase || 0);
    updates.deudaExtra = String(deudaExtra);
  }
  await ref.set(updates, { merge: true });
}

async function cubrirClaseConMensualidadSiCorresponde({
  user, clubId, alumno, claseId, fecha, precioPorAlumno, perfil
}) {
  const fechaNorm = typeof fecha === "string" ? new Date(`${fecha}T00:00:00`) : fecha;

  const m = await ensureMensualidadParaAlumno({
    user, clubId, alumno, perfil, fechaRef: fechaNorm
  });
  if (!m) return;

  const incl = Number(m.incluidas || 0);
  const cons = Number(m.consumidas || 0);
  const tieneCupo = cons < incl;

  if (tieneCupo) {
    const q = await pagosRef(user, clubId).where("claseId", "==", claseId).get();
    const yaExiste = q.docs.some(d => {
      const p = d.data();
      return p.alumnoId === alumno.id && p.metodo === "Mensual";
    });
    if (!yaExiste) {
      await pagosRef(user, clubId).add({
        claseId,
        alumnoId: alumno.id,
        fecha: fecha,
        concepto: `Cubre por abono - ${m.mes || ""}`,
        monto: "0",
        metodo: "Mensual",
      });
    }
  }

  const excedente = tieneCupo ? "0" : String(precioPorAlumno || 0);
  await consumirClaseMensual({
    user, clubId, alumno, fechaClase: fecha, perfil, excedentePorClase: excedente
  });
}


async function marcarPagoMensualidad({ user, clubId, alumnoId, mes }) {
  const id = `${alumnoId}_${mes}`;
  await mensualidadesRef(user, clubId).doc(id).set({
    pagado: true,
    estado: "pagado",
    fechaPago: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}


    const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : 'Alumno eliminado';
// --- Searchable alumno picker (reusable) ---
function AlumnoSearchSelect({ value, onChange, alumnos, excludeIds = [], placeholder = "Buscar alumno...", autoFocus = false }) {
  const [open, setOpen] = React.useState(false);
  const [q, setQ] = React.useState("");
  const inputRef = React.useRef(null);
  const boxRef = React.useRef(null);

  React.useEffect(() => {
    if (autoFocus && inputRef.current) inputRef.current.focus();
  }, [autoFocus]);

  React.useEffect(() => {
    function handleClickOutside(e) {
      if (boxRef.current && !boxRef.current.contains(e.target)) setOpen(false);
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const norm = (s) => (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
  const selected = React.useMemo(() => (alumnos || []).find(a => a.id === value) || null, [alumnos, value]);
  const filtered = React.useMemo(() => {
    const needle = norm(q);
    return (alumnos || []).filter(a => !excludeIds.includes(a.id) && (!needle || norm(getNombreCompleto(a)).includes(needle)));
  }, [alumnos, excludeIds, q]);

  const showList = open && (!selected || q.length > 0);

  return (
    <div className="relative" ref={boxRef}>
      <div className="flex gap-2">
        <input
          ref={inputRef}
          type="text"
          className="w-full border rounded-lg px-3 py-2"
          placeholder={placeholder}
          value={selected && q.length === 0 ? getNombreCompleto(selected) : q}
          onFocus={() => setOpen(true)}
          onChange={(e) => { setQ(e.target.value); onChange(""); }}
        />
        {value && (
          <button
            type="button"
            className="px-2 text-slate-500 hover:text-slate-700"
            onClick={() => { onChange(""); setQ(""); setOpen(true); }}
            title="Limpiar selecci√≥n"
          >
            √ó
          </button>
        )}
      </div>
      {showList && (
        <div className="absolute z-30 mt-1 w-full bg-white border rounded-lg shadow max-h-64 overflow-auto">
          {filtered.length ? filtered.map(a => (
            <button
              type="button"
              key={a.id}
              className="w-full text-left px-3 py-2 hover:bg-slate-50"
              onClick={() => { onChange(a.id); setQ(""); setOpen(false); }}
            >
              {getNombreCompleto(a)}
            </button>
          )) : (
            <div className="px-3 py-2 text-slate-500">Sin resultados</div>
          )}
        </div>
      )}
    </div>
  );
}
    const formatCurrency = (value) => {
      const number = parseFloat(value);
      if (isNaN(number)) {
        return "$ 0,00"; // Devuelve un valor por defecto si el n√∫mero no es v√°lido
      }
      // Esta funci√≥n usa el formato de Argentina ('es-AR') para los n√∫meros.
      const formatted = new Intl.NumberFormat('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(number);
      return `$ ${formatted}`;
    };

// --- Normalizador robusto de horarioLaboral ---
function toArrayHorarioLaboral(hl) {
  if (!hl) return [];
  if (Array.isArray(hl)) return hl;
  if (typeof hl === 'string') {
    try { const parsed = JSON.parse(hl); return Array.isArray(parsed) ? parsed : []; } catch (e) { return []; }
  }
  if (typeof hl === 'object') {
    // Convierte objetos estilo mapa a un array de valores confiable
    try { return Object.values(hl); } catch (e) { return []; }
  }
  return [];
}


    // ------------------------------ UI B√°sicos ------------------------------
    function Card({ title, right, children }) {
  return (
    <section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-3 sm:p-4">
      <div className="flex items-center justify-between mb-2 sm:mb-3">
        <h3 className="text-sm sm:text-base font-semibold text-slate-800">{title}</h3>
        {right}
      </div>
      <div className="text-[13px] sm:text-sm">
        {children}
      </div>
    </section>
  );
}

    function Toast({ msg, onClose }) {
  useEffect(() => {
    if (!msg) return;
    const t = setTimeout(onClose, 2500);
    return () => clearTimeout(t);
  }, [msg, onClose]);

  if (!msg) return null;
  return (
    <div className="fixed top-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-xl shadow-xl z-50">
      {msg}
    </div>
  );
}

function Modal({ isOpen, title, children, onConfirm, onCancel, confirmText = "Confirmar", size = 'md' }) {
  if (!isOpen) return null;
  const sizeToClass = {
    sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl', '2xl': 'max-w-2xl', '5xl': 'max-w-5xl'
  };
  const maxW = sizeToClass[size] || sizeToClass.md;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
      <div className={`w-full ${maxW} bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]`}>
        <div className="p-6 border-b">
          <h3 className="text-lg font-semibold">{title}</h3>
        </div>

        {/* Cuerpo scrollable */}
        <div className="flex-1 overflow-y-auto p-6 text-slate-600">
          {children}
        </div>

        {/* Footer fijo dentro del modal */}
        <div className="p-4 border-t bg-white flex justify-end gap-3 sticky bottom-0">
          <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg border">Cancelar</button>
          <button onClick={onConfirm} className={`px-4 py-2 rounded-lg text-white ${confirmText === "Confirmar" ? "bg-red-600" : "bg-emerald-600"}`}>
            {confirmText}
          </button>
        </div>
      </div>
    </div>
  );
}

function Grupos({ alumnos, user, clubActivoId, onCrearClaseDesdeGrupo }) {
  const [grupos, setGrupos] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [q, setQ] = useState("");
  const [editing, setEditing] = useState(null);
  const [nombre, setNombre] = useState("");
  const [color, setColor] = useState("#10b981");
  const [miembros, setMiembros] = useState([]);
  const [alumnoQuery, setAlumnoQuery] = useState("");
  const [agendarPara, setAgendarPara] = useState(null);
  const [fechaClase, setFechaClase] = useState(formatDate(new Date()));
  const [horaClase, setHoraClase] = useState("09:00");
  useEffect(() => {
    let mounted = true;
    if (!user || !clubActivoId) { if (mounted){ setGrupos([]); setLoading(false);} return () => { mounted=false; }; }
    setLoading(true);
    const ref = db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId).collection('grupos');
    const unsub = ref.orderBy('nombre', 'asc').onSnapshot(
      (snap) => { if (!mounted) return; setGrupos(snap.docs.map(d => ({ id: d.id, ...d.data() }))); setLoading(false); },
      (e) => { if (!mounted) return; console.error('onSnapshot grupos:', e); setError('No se pudieron cargar los grupos'); setLoading(false); }
    );
    return () => { mounted=false; unsub && unsub(); };
  }, [user, clubActivoId]);
  const refGrupos = useMemo(() => (!user || !clubActivoId) ? null : db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId).collection('grupos'), [user, clubActivoId]);
  const abrirCrear = () => { setEditing({id:null}); setNombre(""); setColor("#10b981"); setMiembros([]); setAlumnoQuery(""); };
  const abrirEditar = (g) => { setEditing(g); setNombre(g?.nombre||""); setColor(g?.color||"#10b981"); setMiembros(Array.isArray(g?.alumnoIds)?g.alumnoIds.filter(Boolean):[]); setAlumnoQuery(""); };
  const guardarGrupo = async (e) => { e&&e.preventDefault(); if(!refGrupos) return; const payload={ nombre:(nombre||"").trim(), color, alumnoIds:(miembros||[]).filter(Boolean) }; if(!payload.nombre){ alert("Ingres√° un nombre para el grupo"); return; } if(editing&&editing.id){ await refGrupos.doc(editing.id).update(payload);} else { await refGrupos.add({ ...payload, creadoEn: firebase.firestore.FieldValue.serverTimestamp() }); } setEditing(null); };
  const eliminarGrupo = async (g) => { if(!refGrupos||!g?.id) return; if(!confirm(`Eliminar el grupo "${g.nombre}"?`)) return; await refGrupos.doc(g.id).delete(); };
  const gruposFiltrados = useMemo(() => { const t=q.trim().toLowerCase(); const base=grupos||[]; return t? base.filter(g => (g.nombre||"").toLowerCase().includes(t)) : base; }, [q,grupos]);
  const alumnosFiltrados = useMemo(() => { const t=(alumnoQuery||"").trim().toLowerCase(); const arr=(alumnos||[]).filter(a => a && a.estado!=='inactivo'); if(!t) return arr; const norm = s => (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); return arr.filter(a => norm(getNombreCompleto(a)).includes(norm(t))); }, [alumnoQuery, alumnos]);
  const toggleMiembro = (id) => setMiembros(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  const abrirAgendar = (g) => { setAgendarPara(g); setFechaClase(formatDate(new Date())); setHoraClase("09:00"); };
  const confirmarAgendar = () => { if(!agendarPara) return; const ids=(agendarPara.alumnoIds||[]).filter(Boolean); if(!ids.length){ alert("El grupo no tiene alumnos."); return; } if(!fechaClase||!horaClase){ alert("Eleg√≠ fecha y hora."); return; } onCrearClaseDesdeGrupo && onCrearClaseDesdeGrupo({ fecha:fechaClase, hora:horaClase, alumnoIds:ids, grupo:agendarPara }); setAgendarPara(null); };
  const waHref = (g) => { const nombres=(g.alumnoIds||[]).map(id => getNombreCompleto((alumnos||[]).find(a => a.id===id))).filter(Boolean).join(', '); const text=encodeURIComponent(`Hola! Mensaje para el grupo "${g.nombre}":`); return `https://wa.me/?text=${text}%0A${encodeURIComponent(nombres)}`; };
  return (<div className="space-y-4">
    <Card title="Grupos" right={<div className="flex gap-2">
      <input value={q} onChange={e=>setQ(e.target.value)} placeholder="Buscar grupo..." className="border rounded-xl px-3 py-1.5 text-sm" />
      <button onClick={abrirCrear} className="px-3 py-1.5 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Nuevo grupo</button>
    </div>}>
      {loading && <div className="text-sm text-slate-500">Cargando‚Ä¶</div>}
      {error && <div className="text-sm text-red-600">{error}</div>}
      <div className="overflow-x-auto">
        <table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600">
          <th className="p-2">Nombre</th><th className="p-2">Miembros</th><th className="p-2">Acciones</th>
        </tr></thead><tbody>
          {(gruposFiltrados||[]).map(g => (<tr key={g.id} className="border-t">
            <td className="p-2"><span className="inline-flex items-center gap-2">
              <span className="inline-block w-3 h-3 rounded-full" style={{backgroundColor: g.color || '#10b981'}}></span>
              <span className="font-medium">{g.nombre}</span></span></td>
            <td className="p-2">{(g.alumnoIds||[]).filter(Boolean).length}</td>
            <td className="p-2"><div className="flex flex-wrap gap-2">
              <button onClick={()=>abrirEditar(g)} className="px-2 py-1 rounded-lg border">Editar</button>
              <button onClick={()=>abrirAgendar(g)} className="px-2 py-1 rounded-lg border">Nueva clase</button>
              <a href={waHref(g)} target="_blank" rel="noreferrer" className="px-2 py-1 rounded-lg border">WhatsApp</a>
              <button onClick={()=>eliminarGrupo(g)} className="px-2 py-1 rounded-lg border text-red-600">Eliminar</button>
            </div></td>
          </tr>))}
          {(!loading && (!gruposFiltrados || gruposFiltrados.length===0)) && (<tr><td className="p-2 text-slate-500" colSpan="3">No hay grupos.</td></tr>)}
        </tbody></table>
      </div>
    </Card>
    {editing !== null && (
      <Modal isOpen={true} title={editing?.id ? 'Editar grupo' : 'Nuevo grupo'} onCancel={()=>setEditing(null)} onConfirm={guardarGrupo} confirmText="Guardar">
        <form onSubmit={guardarGrupo} className="space-y-4">
          <div className="grid md:grid-cols-2 gap-4">
            <div><label className="block text-sm text-slate-600 mb-1">Nombre</label>
              <input value={nombre} onChange={e=>setNombre(e.target.value)} className="w-full border rounded-xl px-3 py-2" /></div>
            <div><label className="block text-sm text-slate-600 mb-1">Color</label>
              <input type="color" value={color} onChange={e=>setColor(e.target.value)} className="w-16 h-10 p-0 border rounded" /></div>
          </div>
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-sm text-slate-600">Miembros</label>
              <input value={alumnoQuery} onChange={e=>setAlumnoQuery(e.target.value)} placeholder="Buscar alumno..." className="border rounded-xl px-3 py-1.5 text-sm" />
            </div>
            <div className="max-h-60 overflow-auto border rounded-xl p-2">
              {(alumnosFiltrados||[]).map(a => (
                <label key={a.id} className="flex items-center gap-2 py-1">
                  <input type="checkbox" checked={miembros.includes(a.id)} onChange={()=>toggleMiembro(a.id)} />
                  <span>{getNombreCompleto(a)}</span>
                  <span className="ml-auto text-xs text-slate-500">{a.plan || 'porClase'}</span>
                </label>
              ))}
            </div>
          </div>
        </form>
      </Modal>
    )}
    {agendarPara && (
      <Modal isOpen={true} title={"Nueva clase: " + (agendarPara?.nombre || "")} onCancel={()=>setAgendarPara(null)} onConfirm={confirmarAgendar} confirmText="Crear en Clases">
        <div className="space-y-4">
          <div className="grid md:grid-cols-3 gap-4">
            <div><label className="block text-sm text-slate-600 mb-1">Fecha</label>
              <input type="date" value={fechaClase} onChange={e=>setFechaClase(e.target.value)} className="w-full border rounded-xl px-3 py-2" /></div>
            <div><label className="block text-sm text-slate-600 mb-1">Hora</label>
              <input type="time" value={horaClase} onChange={e=>setHoraClase(e.target.value)} className="w-full border rounded-xl px-3 py-2" /></div>
          </div>
          <div className="text-sm text-slate-600">
            <div>Miembros: {(agendarPara.alumnoIds||[]).map(id => getNombreCompleto((alumnos||[]).find(a => a.id===id))).filter(Boolean).join(', ') || '‚Äî'}</div>
          </div>
        </div>
      </Modal>
    )}
  </div>);
}

function Topbar({
  current,
  setCurrent,
  onLogout,
  clubes,
  clubActivoId,
  onClubChange,
  showIndependentOption = false,
}) {
  const LOGO_WORDMARK = "./logo_coachex_N.png";
  const BUILD_VER = "v3";

  const clubesArr = Array.isArray(clubes) ? clubes : [];
  const clubActivo = clubActivoId ? clubesArr.find(c => c.id === clubActivoId) : null;

  const tabs = [
    { id: "dashboard", label: "Dashboard" },
    { id: "alumnos", label: "Alumnos" },
    { id: "clases", label: "Clases" },
    { id: "grupos", label: "Grupos" },
    { id: "pagos", label: "Pagos" },
    { id: "gastos", label: "Gastos" },
    { id: "reportes", label: "Reportes" },
    { id: "perfil", label: "Perfil" },
  ];

  return (
    <header className="w-full bg-[#484848] text-white">
      <div className="max-w-6xl mx-auto px-3 sm:px-4 py-2 sm:py-3 flex items-center justify-between">
        {/* Izquierda: solo wordmark + subt√≠tulo */}
        <div className="flex items-center gap-2">
          <div className="flex flex-col">
            <img
              src={`${LOGO_WORDMARK}?${BUILD_VER}`}
              alt="COACHEX¬∑PRO"
              className="h-3 sm:h-4 md:h-5 w-auto shrink-0"
              onError={(e) => { e.currentTarget.onerror = null; e.currentTarget.src = "./logo_favicon.png"; }}
            />
            <p className="text-[10px] sm:text-xs opacity-80 -mt-0.5 leading-tight">
              Gesti√≥n de Profesores
            </p>
          </div>
        </div>

        {/* Derecha: selector de club + tabs + logout (desktop) */}
        <nav className="hidden md:flex items-center gap-3">
          {clubesArr.length > 1 ? (
            <select
              value={clubActivoId || ""}
              onChange={(e) => onClubChange && onClubChange(e.target.value)}
              className="text-sm px-2 py-1 rounded-lg bg-neutral-700 hover:bg-neutral-600 text-white border border-neutral-600 focus:ring-2 focus:ring-white w-full sm:w-auto max-w-[220px]"
              title="Seleccionar Club de Trabajo"
            >
              {clubesArr.map(club => (
                <option key={club.id} value={club.id}>{club.nombre}</option>
              ))}
            </select>
          ) : (
            <div className="text-neutral-200 text-sm px-2 py-1 rounded-md bg-neutral-800/40 border border-neutral-700/50">
              {clubActivo?.nombre || clubesArr[0]?.nombre || "‚Äî"}
            </div>
          )}

          {tabs.map((t) => (
            <button
              key={t.id}
              onClick={() => setCurrent && setCurrent(t.id)}
              className={`px-3 py-1.5 rounded-xl text-sm transition ${
                current === t.id ? "bg-white text-neutral-900" : "hover:bg-neutral-800"
              }`}
            >
              {t.label}
            </button>
          ))}

          <button
            onClick={onLogout}
            className="px-2 py-1 rounded-lg text-sm transition bg-red-600 hover:bg-red-700 text-white ml-4"
          >
            Cerrar Sesi√≥n
          </button>
        </nav>
      </div>

      {/* Navegaci√≥n m√≥vil */}
      <div className="md:hidden px-2 pb-2 grid grid-cols-3 sm:grid-cols-5 gap-2">
        {tabs.map((t) => (
          <button
            key={t.id}
            onClick={() => setCurrent && setCurrent(t.id)}
            className={`px-3 py-2 rounded-xl text-sm transition ${
              current === t.id ? "bg-white text-neutral-900" : "bg-neutral-800 text-white"
            }`}
          >
            {t.label}
          </button>
        ))}
      </div>

      <div className="md:hidden px-2 pb-2">
        <button
          onClick={onLogout}
          className="w-full px-3 py-1.5 rounded-lg text-sm transition bg-red-600 hover:bg-red-700 text-white mt-2"
        >
          Cerrar Sesi√≥n
        </button>
      </div>
    </header>
  );
}

    
    function ClasesPorTamanoMes({ clases }) {
  const resumen = useMemo(() => {
    const ahora = new Date();
    const mesActual = ahora.getMonth();
    const anioActual = ahora.getFullYear();

    const clasesDelMes = clases.filter(c => {
      const fechaClase = new Date(c.fecha);
      return (
        fechaClase.getMonth() === mesActual &&
        fechaClase.getFullYear() === anioActual &&
        c.estado === "realizada"
      );
    });

    return TIPOS_CLASE.reduce((acc, tipo) => {
      acc[tipo] = clasesDelMes.filter(
        c => normalizarTipoClase(c.tipo) === tipo
      ).length;
      return acc;
    }, {});
  }, [clases]);

  return (
    <Card title="Clases por cantidad de alumnos">
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 text-center">
        {TIPOS_CLASE.map(tipo => (
          <div key={tipo} className="bg-slate-50 p-2 rounded-lg flex flex-col justify-between h-full">
            <p className="text-xs text-slate-600 h-8 flex items-center justify-center">{labelSinClase(tipo)}</p>
            <p className="text-xl font-bold">{resumen[tipo] || 0}</p>
          </div>
        ))}
      </div>
    </Card>
  );
}

    
    function Dashboard({ perfil, clases, pagos, gastos, alumnos, clubes, clubActivoId, goToNewClass, goToEditClass }) {
  useEffect(() => {
    console.log("DATOS RECIBIDOS POR EL DASHBOARD:", { clubId: clubActivoId, nombrePerfil: perfil?.nombre });
  }, [clubActivoId, perfil?.nombre]);

  const [currentDate, setCurrentDate] = useState(new Date());
  const [mostrarSoloHorarioLaboral, setMostrarSoloHorarioLaboral] = useState(false);

  const weekStartDate = getWeekStartDate(currentDate);
  const weekDates = Array.from({ length: 7 }, (_, i) => formatDate(addDays(weekStartDate, i)));

  // üîπ club activo y datos de horario (debe ir ANTES de usarlo en useMemo)
  const clubActivo = clubActivoId ? (clubes || []).find(c => c.id === clubActivoId) : null;
  const nombreLugar = clubActivo ? clubActivo.nombre : "‚Äî";
  const nombreCompleto = `${perfil?.nombre || ''} ${perfil?.apellido || ''}`.trim();
  const horarioData = clubActivo ? clubActivo.horarioLaboral : perfil?.horarioLaboral;

  const alumnoMap = useMemo(
    () => new Map((alumnos || []).map(a => [a.id, getNombreCompleto(a)])),
    [alumnos]
  );
  const alumnoObjMap = useMemo(
    () => new Map((alumnos || []).map(a => [a.id, a])),
    [alumnos]
  );

  const [contactosExpandId, setContactosExpandId] = useState(null);
  const [contactosMsg, setContactosMsg] = useState("");

  const hoy = formatDate(new Date());
  const semanaInicio = formatDate(getWeekStartDate(new Date()));
  const manana = formatDate(addDays(new Date(), 1));

  const clasesHoy = useMemo(() => {
    return (clases || [])
      .filter(c => c.fecha === hoy)
      .map(c => ({
        ...c,
        nombresAlumnos: (c.alumnoIds || []).map(id => alumnoMap.get(id)).filter(Boolean).join(', ')
      }))
      .sort((a, b) => a.hora.localeCompare(b.hora));
  }, [clases, hoy, alumnoMap]);

  const clasesManana = useMemo(() => {
    return (clases || [])
      .filter(c => c.fecha === manana)
      .map(c => ({
        ...c,
        nombresAlumnos: (c.alumnoIds || []).map(id => alumnoMap.get(id)).filter(Boolean).join(', ')
      }))
      .sort((a, b) => a.hora.localeCompare(b.hora));
  }, [clases, manana, alumnoMap]);

  // --- Horario disponible para ma√±ana ---
  const getDayIndex = (d) => (d.getDay() === 0 ? 6 : d.getDay() - 1); // 0..6 (Lun..Dom)
  const getNombreDiaFromYMD = (yyyy_mm_dd) => {
    const d = new Date(`${yyyy_mm_dd}T00:00:00`);
    return DIAS_SEMANA_NOMBRES[getDayIndex(d)];
  };
  const generateSlots = (desde, hasta, stepMin = 60) => {
    const [h1, m1] = (desde || '08:00').split(':').map(Number);
    const [h2, m2] = (hasta || '20:00').split(':').map(Number);
    const start = h1 * 60 + m1;
    const end = h2 * 60 + m2;
    const res = [];
    for (let t = start; t + stepMin <= end; t += stepMin) {
      const hh = String(Math.floor(t / 60)).padStart(2, '0');
      const mm = String(t % 60).padStart(2, '0');
      res.push(`${hh}:${mm}`);
    }
    return res;
  };

  const bloquesManana = useMemo(() => {
    const nombreDia = getNombreDiaFromYMD(manana);
    const data = clubActivo ? (clubActivo.horarioLaboral || {}) : (perfil?.horarioLaboral || []);
    if (clubActivo && data && Array.isArray(data.bloques)) {
      return data.bloques
        .filter(b => b.dia === nombreDia && (b.activo ?? true))
        .map(b => ({ desde: b.desde, hasta: b.hasta }));
    }
    const arr = Array.isArray(data) ? data : [];
    return arr
      .filter(b => b.dia === nombreDia && (b.activo ?? true))
      .map(b => ({ desde: b.desde, hasta: b.hasta }));
  }, [clubActivo, perfil, manana]);

  const horarioDisponibleManana = useMemo(() => {
    const ocupadas = new Set((clasesManana || []).map(c => c.hora));
    const slots = [];
    bloquesManana.forEach(b => {
      generateSlots(b.desde, b.hasta, 60).forEach(h => {
        if (!ocupadas.has(h)) slots.push(h);
      });
    });
    return slots.sort((a, b) => a.localeCompare(b));
  }, [bloquesManana, clasesManana]);

  const resumenClasesHoy = useMemo(() => {
    if (!clasesHoy || clasesHoy.length === 0) return [];
    const counts = clasesHoy.reduce((acc, clase) => {
      const tipo = normalizarTipoClase(clase.tipo || 'Clase 1 persona');
      acc[tipo] = (acc[tipo] || 0) + 1;
      return acc;
    }, {});
    return Object.entries(counts).map(([tipo, cantidad]) => {
      const nombreClase = labelSinClase(tipo);
      const textoClase = cantidad > 1 ? 'clases' : 'clase';
      return `${cantidad} ${textoClase} de ${nombreClase}`;
    });
  }, [clasesHoy]);

  const balanceSemana = useMemo(() => {
    const ingresos = (pagos || [])
      .filter(p => p.fecha >= semanaInicio && p.metodo !== 'Pendiente')
      .reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
    const egresos = (gastos || [])
      .filter(g => g.fecha >= semanaInicio)
      .reduce((acc, g) => acc + parseFloat(g.monto || 0), 0);
    return ingresos - egresos;
  }, [pagos, gastos, semanaInicio]);

  const pagosPendientes = useMemo(() => {
    let pendientes = 0;
    const alumnosMensuales = (alumnos || []).filter(a => a.plan === 'mensual' && a.estado === 'activo');
    const pagosMensualesMesActual = (pagos || [])
      .filter(p => p.concepto?.startsWith("Cuota Mensual") && new Date(p.fecha).getMonth() === new Date().getMonth());
    alumnosMensuales.forEach(alumno => {
      const cuota = parseFloat((perfil?.preciosMensuales || {})[alumno.frecuencia] || 0);
      const totalPagado = pagosMensualesMesActual
        .filter(p => p.alumnoId === alumno.id)
        .reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
      if (cuota > totalPagado) pendientes++;
    });
    return pendientes;
  }, [pagos, alumnos, perfil]);

  const horarioFormateado = (() => {
    const data = horarioData;
    const esClub = !!clubActivo;
    if (!data) return ["No especificado"];
    if (esClub && data.bloques) {
      if (data.bloques.length === 0) return ["No hay horarios definidos para este club."];
      return data.bloques.map(b => `${b.dia}: ${b.desde} - ${b.hasta}`);
    }
    if (!esClub && Array.isArray(data)) {
      const activos = data.filter(d => d.activo);
      if (activos.length === 0) return ["No hay d√≠as de trabajo definidos."];
      return activos.map(d => `${d.dia}: ${d.desde} - ${d.hasta}`);
    }
    return ["Horario no configurado."];
  })();

  return (
    <div className="grid gap-6">
      <div className="bg-white p-4 rounded-2xl flex flex-wrap justify-between items-start shadow-sm border border-slate-200">
        <div className="text-sm space-y-2">
          <h3 className="font-semibold text-[#34745B] text-base">Lugar de Trabajo</h3>
          <p className="text-slate-600">
            <strong>Modo actual:</strong>{" "}
            <span className="font-semibold text-slate-800">{nombreLugar}</span>
          </p>
          <p className="text-slate-600"><strong>Profesor/a:</strong> {nombreCompleto}</p>
        </div>
        <div className="text-sm space-y-1 text-right">
          <strong className="block text-[#34745B]">Horario Laboral:</strong>
          <div className="text-slate-600">
            {horarioFormateado.map((linea, index) => (
              <div key={index}>{linea}</div>
            ))}
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-3 gap-4">
        <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
          <p className="text-sm text-green-800">Clases de Hoy</p>
          <p className="text-2xl font-bold text-[#34745B]">{clasesHoy.length}</p>
          {resumenClasesHoy.length > 0 && (
            <div className="text-xs text-green-700 mt-2 border-t border-green-200 pt-2">
              {resumenClasesHoy.map((linea, index) => (<p key={index}>{linea}</p>))}
            </div>
          )}
        </div>

        <div className="bg-slate-50 border border-slate-200 p-4 rounded-xl">
  <p className="text-sm text-slate-600">Horario disponible para ma√±ana</p>
  <div className="mt-1 text-xs text-slate-500">{horarioDisponibleManana.length} libres</div>

  {horarioDisponibleManana.length === 0 ? (
    <p className="text-sm text-slate-500 mt-2">
      No hay horas libres dentro del horario laboral.
    </p>
  ) : (
    <div className="mt-2 min-h-[64px] flex items-center">
      <div className="ml-auto inline-flex items-center gap-3">
        <span className="inline-flex h-8 items-center px-3 rounded-full border bg-white text-slate-700 text-sm">
          {horarioDisponibleManana[0]}
        </span>
        <button
          type="button"
          onClick={() =>
            goToNewClass && goToNewClass({ fecha: manana, hora: horarioDisponibleManana[0] })
          }
          className="text-xs px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700"
          title="Agendar clase en este horario"
        >
          Agendar
        </button>
      </div>
    </div>
  )}
</div>


        <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
          <p className="text-sm text-green-800">Balance de la Semana</p>
          <p className={`text-2xl font-bold ${balanceSemana >= 0 ? 'text-[#34745B]' : 'text-red-900'}`}>
            {formatCurrency(balanceSemana)}
          </p>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-4">
        <Card title={<span className="text-[#34745B]">Agenda del D√≠a</span>}>
          {clasesHoy.length === 0 ? (
            <p className="text-sm text-slate-500">No hay clases programadas para hoy.</p>
          ) : (
            <ul className="space-y-2">
              {clasesHoy.map(c => (
                <li key={c.id} className="p-2 border-b flex justify-between items-center">
                  <div>
                    <p className="font-semibold text-slate-700">{c.hora} - {c.nombresAlumnos}</p>
                    <p className="text-xs text-slate-500">{c.tipo}{c.cancha ? ` en ${c.cancha}` : ''}</p>
                  </div>
                  {c.estado !== 'Programada' && (
                    <span
                      className={`px-2 py-0.5 rounded-full text-xs font-semibold ${
                        c.estado === 'Realizada' ? 'bg-green-100 text-green-800' :
                        c.estado === 'Ausente'    ? 'bg-orange-100 text-orange-800' :
                        c.estado === 'Cancelada'  ? 'bg-red-100 text-red-800' : ''
                      }`}
                    >
                      {c.estado}
                    </span>
                  )}
                </li>
              ))}
            </ul>
          )}
        </Card>

        <Card title={<span className="text-[#34745B]">Agenda de Ma√±ana ¬∑ Contactos</span>}>
          {clasesManana.length === 0 ? (
            <p className="text-sm text-slate-500">No hay clases programadas para ma√±ana.</p>
          ) : (
            <ul className="space-y-2">
              {clasesManana.map(c => (
                <li key={c.id} className="p-2 border rounded-lg">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="font-semibold text-slate-700">{c.hora} - {c.nombresAlumnos}</p>
                      <p className="text-xs text-slate-500">{c.tipo}{c.cancha ? ` en ${c.cancha}` : ''}</p>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-800">{c.estado}</span>
                      <button
                        type="button"
                        onClick={() => {
                          const canchaTxt = c.cancha ? ` en ${c.cancha}` : "";
                          const def = `Hola! Te recuerdo tu clase ${c.tipo}${canchaTxt} el ${c.fecha} a las ${c.hora}.`;
                          setContactosMsg(def);
                          setContactosExpandId(contactosExpandId === c.id ? null : c.id);
                        }}
                        className="text-xs px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-50"
                      >
                        Contactos
                      </button>
                    </div>
                  </div>

                  {contactosExpandId === c.id && (
                    <div className="mt-3 p-3 bg-slate-50 rounded-lg border">
                      <div className="mb-3">
                        <label className="text-xs text-slate-500 block mb-1">Mensaje (editable)</label>
                        <textarea
                          value={contactosMsg}
                          onChange={(e)=>setContactosMsg(e.target.value)}
                          className="w-full border rounded-lg px-2 py-1 text-sm"
                          rows="2"
                        />
                      </div>

                      <table className="w-full text-sm">
                        <thead>
                          <tr className="text-slate-500">
                            <th className="text-left px-2 py-1">Alumno</th>
                            <th className="text-left px-2 py-1">Tel√©fono</th>
                            <th className="text-left px-2 py-1">Acci√≥n</th>
                          </tr>
                        </thead>
                        <tbody>
                          {(c.alumnoIds || []).filter(Boolean).map(id => {
                            const a = alumnoObjMap.get(id);
                            if (!a) return null;
                            const nombre = getNombreCompleto(a);
                            const telRaw = (a.telefono || a.contactoPadre || "").toString();
                            const digits = telRaw.replace(/\D/g, "");
                            const canchaTxt = c.cancha ? ` en ${c.cancha}` : "";
                            const base = `Hola! Te recuerdo tu clase ${c.tipo}${canchaTxt} el ${c.fecha} a las ${c.hora}.`;
                            const msg = contactosExpandId === c.id && contactosMsg ? contactosMsg : base;
                            const wa = `https://api.whatsapp.com/send?phone=${digits}&text=${encodeURIComponent(msg)}`;
                            return (
                              <tr key={id} className="border-t">
                                <td className="px-2 py-1">{nombre}</td>
                                <td className="px-2 py-1">{telRaw || '-'}</td>
                                <td className="px-2 py-1">
                                  <a className="text-emerald-700 underline" href={wa} target="_blank" rel="noopener">WhatsApp</a>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                </li>
              ))}
            </ul>
          )}
        </Card>
      </div>

      <Card
        title={<span className="text-[#34745B]">Calendario Semanal</span>}
        right={
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                id="vista-compacta"
                checked={mostrarSoloHorarioLaboral}
                onChange={(e) => setMostrarSoloHorarioLaboral(e.target.checked)}
              />
              <label htmlFor="vista-compacta" className="text-slate-600">Mostrar solo horario laboral</label>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCurrentDate(prev => addDays(prev, -7))} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">‚Äπ Ant</button>
              <button onClick={() => setCurrentDate(new Date())} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">Hoy</button>
              <button onClick={() => setCurrentDate(prev => addDays(prev, 7))} className="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-slate-50">Sig ‚Ä∫</button>
            </div>
          </div>
        }
      >
        <CalendarioSemanal
          week={weekDates}
          clases={(clases || []).filter(c => weekDates.includes(c.fecha))}
          alumnos={alumnos || []}                  
          onEdit={goToEditClass}
          horarioLaboral={horarioData}
          mostrarSoloHorarioLaboral={mostrarSoloHorarioLaboral}
        />
      </Card>
    </div>
  );
}

    function AlumnoForm({ initialData, onSubmit, onCancel, onRegisterMonthlyPayment, studentBeingEdited }) {
      const [form, setForm] = useState(initialData)
      
      useEffect(() => {
        const t = form.tipo || "";
        let size = 1;
        if (/^\d+x$/.test(t)) size = parseInt(t);
        if (/^Indiv/.test(t)) size = 1;
        if (/^Dupla|2x/.test(t)) size = 2;
        if (/^Trio|3x/.test(t)) size = 3;
        if (/^Cuart|4x/.test(t)) size = 4;
        if (/Escuelita/i.test(t)) size = 4;
        const base = (form.alumnoIds && form.alumnoIds[0]) || "";
        const ids = Array.from({length: size}, (_, i) => (i===0 ? base : (form.alumnoIds && form.alumnoIds[i]) || ""));
        if (!form.alumnoIds || form.alumnoIds.length !== size) {
          setForm(prev => ({ ...prev, alumnoIds: ids }));
        }
      }, [form.tipo]);
    const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };
      const addHorario = () => setForm(f => ({ ...f, horarios: [...(f.horarios || []), { dia: "Lunes", hora: "18:00" }] }));
      const delHorario = (idx) => setForm(f => ({ ...f, horarios: f.horarios.filter((_, i) => i !== idx) }));
      const setHorario = (idx, key, val) => setForm(f => ({ ...f, horarios: f.horarios.map((h, i) => i === idx ? { ...h, [key]: val } : h) }));
      function alumnoDocRef(id) {
  const uid = auth.currentUser?.uid;
  if (!uid) throw new Error("No hay sesi√≥n (auth.currentUser es null).");
  // Guardamos bajo el usuario autenticado
  return db.collection("users").doc(uid).collection("alumnos").doc(id);
}
async function handleSubmit(e) {
  e.preventDefault();
  if (!form.nombre?.trim()) return alert("Ingres√° un nombre");

  try {
    // normalizo tel√©fono (evito undefined)
    const tel = (form.telefono ?? "").toString().trim();
    const data = { ...form, telefono: tel || null };

    if (data.id) {
      // EDICI√ìN: guardamos directo en Firestore
      await guardarAlumnoEditado(data);
    } else {
      // CREACI√ìN: dej√° que el padre lo maneje como ya lo ten√≠as
      onSubmit(data);
    }

    // ‚úÖ feedback/cierre del editor
    onCancel?.();                  // cierra el formulario de edici√≥n
    // Si quer√©s un aviso r√°pido:
    // alert("Alumno actualizado");
    // (o pas√° un setToast desde el padre y llamalo ac√°)
  } catch (err) {
    console.error("Error guardando alumno:", err);
    alert(err.message || "No se pudo guardar. Intent√° nuevamente.");
  }
}
 return (
        <form onSubmit={handleSubmit} className="grid md:grid-cols-6 gap-3">
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Nombre</label><input name="nombre" value={form.nombre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: Sof√≠a" required /></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Apellido</label><input name="apellido" value={form.apellido} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: P√©rez" /></div>
          <div className="md:col-span-3">
  <label className="text-sm text-slate-600">Tel√©fono</label>
  <input
    type="tel"
    name="telefono"
    value={form.telefono ?? ""}                     // üëà evita undefined
    onChange={handleChange}
    className="w-full border rounded-lg px-3 py-2"
    placeholder="Ej: 549381..."
  />
</div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Contacto Padre/Madre (Escuelita)</label><input name="contactoPadre" value={form.contactoPadre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Nombre y tel√©fono" /></div>
          <div><label className="text-sm text-slate-600">Deporte</label><select name="deporte" value={form.deporte} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{DEPORTES.map(d => <option key={d}>{d}</option>)}</select></div>
          <div><label className="text-sm text-slate-600">Estado</label><select name="estado" value={form.estado} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{ESTADOS_ALUMNO.map(e => <option key={e.value} value={e.value}>{e.label}</option>)}</select></div>
          <div className="md:col-span-3"><label className="text-sm text-slate-600">Plan de Pago</label><select name="plan" value={form.plan} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{PLANES_PAGO.map(p => <option key={p.value} value={p.value}>{p.label}</option>)}</select></div>
          {form.plan === 'mensual' && (
            <div className="md:col-span-3 grid grid-cols-2 gap-3">
                <div>
                    <label className="text-sm text-slate-600">Frecuencia</label>
                    <select name="frecuencia" value={form.frecuencia} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">
                        {FRECUENCIAS_MENSUALES.map(f => <option key={f.value} value={f.value}>{f.label}</option>)}
                    </select>
                </div>
                <div className="flex items-end">
                <button 
                    type="button" 
                    onClick={() => onRegisterMonthlyPayment(studentBeingEdited)} 
                    disabled={!studentBeingEdited}
                    className={`w-full px-3 py-2 text-sm rounded-lg text-white ${!studentBeingEdited ? 'bg-slate-400 cursor-not-allowed' : 'bg-sky-600 hover:bg-sky-700'}`}
                >
                    Registrar Pago de Abono
                </button>
                {!studentBeingEdited && <p className="text-xs text-slate-500 col-span-2 mt-1">Guarda el alumno para registrar su primer pago.</p>}
                </div>
            </div>
            )}
          <div className="md:col-span-6"><label className="text-sm text-slate-600">Horarios fijos</label><div className="grid gap-2">{(form.horarios || []).map((h, idx) => (<div key={idx} className="flex gap-2 items-center flex-wrap"><select value={h.dia} onChange={(e) => setHorario(idx, 'dia', e.target.value)} className="border rounded-lg px-3 py-2">{DIAS_SEMANA_NOMBRES.map(d => <option key={d}>{d}</option>)}</select><input type="time" value={h.hora} onChange={(e) => setHorario(idx, 'hora', e.target.value)} className="border rounded-lg px-3 py-2" /><button type="button" onClick={() => delHorario(idx)} className="px-2 py-2 rounded-lg border text-red-600 hover:bg-red-50">‚àí</button></div>))}<button type="button" onClick={addHorario} className="self-start px-3 py-1.5 rounded-lg border w-auto">+ Agregar horario</button></div></div>
          <div className="md:col-span-6"><label className="text-sm text-slate-600">Notas / Descripci√≥n</label><textarea name="notas" value={form.notas} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" rows={3} placeholder="Detalle particular del alumno" /></div>
          <div className="md:col-span-6 flex gap-2 justify-end"><button type="button" onClick={onCancel} className="px-3 py-2 rounded-lg border">Cancelar</button><button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">Guardar</button></div>
        </form>
      );
    }
    
async function guardarAlumnoEditado(data) {
  const uid = auth.currentUser?.uid;
  if (!uid) {
    alert("No hay sesi√≥n. Volv√© a iniciar sesi√≥n.");
    return;
  }

  const tel = (data.telefono ?? "").toString().trim();

  const payload = {
    ...data,
    telefono: tel || null, // nunca undefined
    ownerId: uid,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
  };

  // Guarda en users/{uid}/alumnos/{id} (suele cumplir reglas)
  const ref = db.collection("users").doc(uid).collection("alumnos").doc(data.id);

  console.log("Escribiendo en:", ref.path, payload); // debug opcional
  await ref.set(payload, { merge: true });

  // Si NO us√°s onSnapshot, refresc√° el estado local:
  if (typeof setAlumnos === "function") {
    setAlumnos(prev => prev.map(a => (a.id === data.id ? { ...a, ...payload } : a)));
  }
}

    
function Alumnos({
  alumnos,
  onCreate,
  onUpdate,
  onDelete,
  onRegisterMonthlyPayment,
  clases,
  pagos,
  onRegistrarClase,
  onPagarPendiente,
  onEditarPago,
  onDeletePago,
  user,
  clubActivoId,
  perfil,
}) {
  const [q, setQ] = useState("");
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);
  const [alumnoFicha, setAlumnoFicha] = useState(null);
  const emptyForm = { nombre: "", apellido: "", telefono: "", contactoPadre: "", deporte: "P√°del", estado: "activo", plan: "porClase", frecuencia: "1xSemana", notas: "", horarios: [] };
  
  const [currentPage, setCurrentPage] = useState(1);
  const ITEMS_PER_PAGE = 10;

  const sortedAlumnos = useMemo(() => {
    const qLower = q.trim().toLowerCase();
    const fil = (alumnos || []).filter(a => !qLower || getNombreCompleto(a).toLowerCase().includes(qLower));
    return fil.sort((a,b)=> getNombreCompleto(a).localeCompare(getNombreCompleto(b), "es", {sensitivity:"base"}));
  }, [alumnos, q]);

  const totalPages = Math.ceil(sortedAlumnos.length / ITEMS_PER_PAGE);

  const paginatedAlumnos = useMemo(() => {
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    return sortedAlumnos.slice(startIndex, startIndex + ITEMS_PER_PAGE);
  }, [sortedAlumnos, currentPage]);

  useEffect(() => {
    setCurrentPage(1);
  }, [q]);

  function openNew() { setEditing(null); setShowForm(true); window.scrollTo({ top: 0, behavior: "smooth" }); }
  function openEdit(a) { setEditing(a); setShowForm(true); window.scrollTo({ top: 0, behavior: "smooth" }); }
  function cancel() { setShowForm(false); setEditing(null); }
  
  async function submit(formData) {
    if (editing) {
        onUpdate({ ...formData, id: editing.id });
        cancel();
    } else {
        if (formData.plan === 'mensual') {
            try {
                const nuevoAlumno = await onCreate(formData); 
                cancel();
                onRegisterMonthlyPayment(nuevoAlumno);
            } catch (error) {
                console.error("Error al guardar el alumno:", error);
                alert("Hubo un error al guardar el alumno.");
            }
        } else {
            onCreate(formData);
            cancel();
        }
    }
  }
  
  return (<>
    <div className="grid gap-4">
      <Card 
        title={<span className="text-[#34745B]">{editing ? "Editar alumno" : "Nuevo alumno"}</span>} 
        right={!showForm && <button onClick={openNew} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">+ Nuevo</button>}
      >
        {showForm ? (
            <AlumnoForm initialData={editing ? { ...emptyForm, ...editing } : emptyForm} onSubmit={submit} onCancel={cancel} onRegisterMonthlyPayment={onRegisterMonthlyPayment} studentBeingEdited={editing} />
         ) : (
            <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nuevo</b> para crear un alumno, o en el l√°piz para editar.</p>
        )}
      </Card>
      <Card 
        title={<span className="text-[#34745B]">Listado de alumnos</span>} 
        right={<input value={q} onChange={(e) => setQ(e.target.value)} placeholder="Buscar por nombre..." className="border rounded-xl px-3 py-1.5 text-sm" />}
      >
        <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Nombre Completo</th><th className="p-2">Tel√©fono</th><th className="p-2">Plan de Pago</th><th className="p-2">Estado</th><th className="p-2 text-right">Acciones</th></tr></thead><tbody>
          {paginatedAlumnos.length === 0 && (<tr><td colSpan={5} className="text-center py-6 text-slate-400">No se encontraron alumnos.</td></tr>)}
          {paginatedAlumnos.map((a) => (<tr key={a.id} className="border-t"><td className="p-2 font-semibold">
          {getNombreCompleto(a)}</td><td className="p-2"><div className="flex items-center gap-2"><span>{a.telefono || "-"}
            </span>{a.telefono && (<a href={waLink(a.telefono, a.nombre)} target="_blank" rel="noreferrer" className="inline-flex items-center px-2 py-0.5 text-xs rounded-full border text-green-700 bg-green-50 hover:bg-green-100">WhatsApp</a>)}
            </div></td><td className="p-2">{a.plan === 'mensual' ? 'Mensual' : 'Por Clase'}</td><td className="p-2"><span className={`px-2 py-0.5 rounded-full text-xs ${a.estado === 'espera' ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-800'}`}>{a.estado === 'espera' ? 'Espera' : 'Activo'}
            </span></td><td className="p-2 text-right"><div className="inline-flex gap-2"><button type="button" onClick={() => setAlumnoFicha(a)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">üëÅÔ∏è Ver ficha</button><button
  type="button"
  onClick={() => onRegistrarClase && onRegistrarClase(a.id)}
  className="px-2 py-1 text-xs rounded-lg border bg-green-50 text-green-800 hover:bg-green-100 inline-flex items-center gap-1"
  title="Registrar clase"
  aria-label="Registrar clase"
>
  {/* √≠cono tilde verde */}
  <svg viewBox="0 0 20 20" width="18" height="18" xmlns="http://www.w3.org/2000/svg" className="text-green-600" aria-hidden="true" role="img">
    <path fill="currentColor" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/>
    <path fill="#fff" d="M8.5 10.7l-.9-.9L6.2 11.2l2.3 2.3c.2.2.5.2.7 0l4.6-4.6-1.4-1.4-3.9 3.9z"/>
  </svg>
  Registrar clase
</button>
<button onClick={() => openEdit(a)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button><button type="button" onClick={() => onDelete(a.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button></div></td></tr>))}</tbody></table></div>

        {totalPages > 1 && (
          <div className="mt-4 flex justify-center items-center gap-2">
            <button onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} disabled={currentPage === 1} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">
              Anterior
            </button>
            <span className="text-sm text-slate-600">
              P√°gina {currentPage} de {totalPages}
            </span>
            <button onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} disabled={currentPage === totalPages} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">
              Siguiente
            </button>
          </div>
        )}
      </Card>
    </div>
  
<AlumnoFichaModal 
  alumno={alumnoFicha} 
  clases={clases} 
  pagos={pagos} 
  alumnos={alumnos} 
  onPagarPendiente={onPagarPendiente} 
  onClose={() => setAlumnoFicha(null)} 
  onRegistrarPago={onRegisterMonthlyPayment} 
  onEditarPago={onEditarPago} 
  onDeletePago={onDeletePago}
  /* üëá A√ëADIDOS */
  user={user}
  clubActivoId={clubActivoId}   // o el nombre que uses: clubIdActual / currentClubId, etc.
  perfil={perfil}
/>

  </>);
}
    
function AlumnoFichaModal({
  alumno,
  onClose,
  clases,
  pagos,
  alumnos,
  onPagarPendiente,
  onRegistrarPago,
  onEditarPago,
  onDeletePago,
  user,
  clubActivoId,
  perfil,
}) {
  // 1) Derivados b√°sicos (siempre mismos hooks, mismo orden)
  const alumnoLive = React.useMemo(
    () => (alumnos || []).find(a => a.id === (alumno?.id)) || alumno,
    [alumnos, alumno]
  );
  const [tab, setTab] = React.useState("clases");

  // 2) NUEVO: ids de clases cubiertas por movimiento "Mensual"
  const [clasesCubiertasConMensual, setClasesCubiertasConMensual] = React.useState(new Set());

  // 3) Derivados dependientes
  const clasesDelAlumno = React.useMemo(() => {
    if (!alumnoLive || !clases) return [];
    return clases.filter(c => (c.alumnoIds || []).includes(alumnoLive.id));
  }, [alumnoLive, clases]);

  const pagosDelAlumno = React.useMemo(() => {
    if (!alumnoLive || !pagos) return [];
    return pagos
      .filter(p => p.alumnoId === alumnoLive.id)
      .sort((a, b) => (b.fecha || "").localeCompare(a.fecha || ""));
  }, [alumnoLive, pagos]);

  // 4) √öNICO useEffect del componente (NO declares otro en este componente)
  React.useEffect(() => {
    let alive = true;
    (async () => {
      try {
        if (!alumnoLive || !user || !clubActivoId) return;
        const snap = await pagosRef(user, clubActivoId)
          .where("alumnoId", "==", alumnoLive.id)
          .get();

        const covered = new Set();
        snap.forEach(doc => {
          const p = doc.data();
          if ((p.metodo === "Mensual" || p.metodo === "Mensual (d√©bito de saldo)") && p.claseId) {
            covered.add(p.claseId);
          }
        });
        if (alive) setClasesCubiertasConMensual(covered);
      } catch (e) {
        console.warn("cargar pagos Mensual:", e);
      }
    })();
    return () => { alive = false; };
  }, [alumnoLive?.id, user, clubActivoId, clasesDelAlumno.length]);

  // 5) Helper: ¬øesta clase est√° pagada por este alumno?
  function isClasePagadaPorAlumno(clase, alumno, pagos) {
    try {
      // si existe pago $0 "Mensual" para la clase, est√° pagada
      if (clasesCubiertasConMensual?.has?.(clase?.id)) return true;

      const pagosLista = (pagos || []).filter(
        p => p && p.claseId === (clase?.id) && p.alumnoId === (alumno?.id)
      );

      if (pagosLista.some(p => p.metodo === 'Mensual' || p.metodo === 'Mensual (d√©bito de saldo)')) {
        return true;
      }

      const precioClase = parseFloat(clase?.precio ?? 0) || 0;
      const cant = (clase?.alumnoIds?.length || 1);
      const precioPorAlumno = cant > 0 ? (precioClase / cant) : precioClase;

      const totalAlumno = pagosLista.reduce(
        (acc, p) => acc + (parseFloat(p.monto || 0) || 0),
        0
      );
      return totalAlumno >= precioPorAlumno;
    } catch (e) {
      console.error('isClasePagadaPorAlumno error:', e);
      return !!(clase && clase.pagada);
    }
  }

  // 6) Guardas condicionales DESPU√âS de declarar TODOS los hooks
  if (!alumnoLive) return null;

  const clasesPendientes = clasesDelAlumno.filter(c => !isClasePagadaPorAlumno(c, alumnoLive, pagos));
  const clasesPagadas   = clasesDelAlumno.filter(c =>  isClasePagadaPorAlumno(c, alumnoLive, pagos));
  const totalPagos      = pagosDelAlumno.reduce((sum, p) => sum + (parseFloat(p.monto) || 0), 0);
  const totalPendiente  = clasesPendientes.reduce((sum, c) => sum + (parseFloat(c.precio) || 0), 0);

  // 7) UI (dej√© tu estructura de tabs y tablas; ajust√° las props/funciones si cambian)
  return (
    <Modal
      isOpen={!!alumno}
      title={`Ficha de ${getNombreCompleto(alumnoLive || alumno)}`}
      size="5xl"
      confirmText="Cerrar"
      onConfirm={onClose}
      onCancel={onClose}
    >
      <div className="flex flex-col md:flex-row gap-6">
        {/* Columna izquierda (datos alumno) ‚Äî deja tu contenido original aqu√≠ */}
        {/* ... */}

        <div className="md:w-2/3">
          {/* Tabs */}
          <div className="border-b border-slate-200">
            <nav className="-mb-px flex space-x-8 text-sm">
              <button
                onClick={() => setTab("clases")}
                className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium ${
                  tab === 'clases'
                    ? 'border-[#34745B] text-[#34745B]'
                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                }`}
              >
                Clases ({clasesDelAlumno.length})
              </button>

              <button
                onClick={() => setTab("pagos")}
                className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium ${
                  tab === 'pagos'
                    ? 'border-[#34745B] text-[#34745B]'
                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                }`}
              >
                Pagos ({pagosDelAlumno.length})
              </button>

              {alumnoLive?.plan === "mensual" && (
                <button
                  onClick={() => setTab("cuenta")}
                  className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium ${
                    tab === 'cuenta'
                      ? 'border-[#34745B] text-[#34745B]'
                      : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                  }`}
                >
                  Cuenta Corriente
                </button>
              )}
            </nav>
          </div>

          {/* Contenido CLASES */}
          {tab === "clases" && (
            <div className="mt-4">
              <h4 className="font-bold text-lg text-slate-800 mb-2">Historial de Clases</h4>
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="text-left text-slate-600">
                    <th className="p-2">Fecha</th>
                    <th className="p-2">Tipo</th>
                    <th className="p-2">Precio</th>
                    <th className="p-2">Estado</th>
                    <th className="p-2 text-right">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {clasesDelAlumno.length === 0 ? (
                    <tr><td colSpan="5" className="text-center py-4 text-slate-400">No hay clases registradas.</td></tr>
                  ) : (
                    clasesDelAlumno
                      .slice()
                      .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                      .map(clase => {
                        const pagada = isClasePagadaPorAlumno(clase, alumnoLive, pagos);
                        return (
                          <tr key={clase.id} className="border-t">
                            <td className="p-2">{formatDate(clase.fecha, 'dd/mm/yyyy')}</td>
                            <td className="p-2">{clase.tipo}</td>
                            <td className="p-2">${clase.precio || 0}</td>
                            <td className="p-2">
                              <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${
                                pagada ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                              }`}>
                                {pagada ? 'Pagada' : 'Pendiente'}
                              </span>
                            </td>
                            <td className="p-2 text-right">
                              {!pagada && (
                                <button
                                  onClick={() => onPagarPendiente(clase, alumnoLive.id)}
                                  className="px-2 py-1 text-xs rounded-lg border bg-green-50 text-green-800 hover:bg-green-100"
                                >
                                  Registrar Pago
                                </button>
                              )}
                            </td>
                          </tr>
                        );
                      })
                  )}
                </tbody>
              </table>
            </div>
          )}

          {/* Contenido PAGOS */}
          {tab === "pagos" && (
            <div className="mt-4">
              <h4 className="font-bold text-lg text-slate-800 mb-2">Historial de Pagos</h4>
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="text-left text-slate-600">
                    <th className="p-2">Fecha</th>
                    <th className="p-2">Concepto</th>
                    <th className="p-2">Monto</th>
                    <th className="p-2">M√©todo</th>
                    <th className="p-2 text-right">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {pagosDelAlumno.length === 0 ? (
                    <tr><td colSpan="5" className="text-center py-4 text-slate-400">No hay pagos registrados.</td></tr>
                  ) : (
                    pagosDelAlumno.map(pago => (
                      <tr key={pago.id} className="border-t">
                        <td className="p-2">{formatDate(pago.fecha, 'dd/mm/yyyy')}</td>
                        <td className="p-2">{pago.concepto}</td>
                        <td className="p-2">${pago.monto}</td>
                        <td className="p-2">{pago.metodo}</td>
                        <td className="p-2 text-right">
  <div className="inline-flex gap-2">
    <button
      onClick={() => onEditarPago({ id: pago.id, ...pago })}
      className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50"
    >
      ‚úèÔ∏è
    </button>
    <button
      onClick={() => (window.coachexComprobante && window.coachexComprobante.generarPDF) && window.coachexComprobante.generarPDF({
        alumno: alumnoLive || alumno || null,
        pago: pago,
        clase: (clases || []).find(c => c.id === pago.claseId),
        perfil
      })}
      className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50"
      title="Descargar comprobante PDF"
    >
      üìÑ
    </button>
    {(() => {
      const al = alumnoLive || alumno;
      const url = window.coachexComprobante?.waLink?.(al, "Te env√≠o el comprobante de pago");
      return url ? (
        <a
          href={url}
          target="_blank" rel="noopener noreferrer"
          className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50"
          title="Enviar por WhatsApp"
        >
          üü¢
        </a>
               ) : null;
              })()}
           </div>
         </td>
       </tr>
      ))
      )}
                </tbody>
              </table>
            </div>
          )}

          {/* Contenido CUENTA */}
          {tab === "cuenta" && alumnoLive?.plan === "mensual" && (
            <div className="mt-4">
              <CuentaCorrienteAlumno
                alumno={alumnoLive}
                user={user}
                clubId={clubActivoId}
                perfil={perfil}
              />
            </div>
          )}
        </div>
      </div>
    </Modal>
  );
}

function CalendarioSemanal({
  week,
  clases,
  alumnos = [],   // üëà agregado (con default)
  onEdit,
  horarioLaboral,
  mostrarSoloHorarioLaboral
}) {  // Colores por estado
  const getStatusColor = (status) => {
    switch (status) {
      case "Realizada": return "bg-emerald-100 border-emerald-300 text-emerald-800";
      case "Cancelada": return "bg-red-100 border-red-300 text-red-800";
      case "Ausente":   return "bg-amber-100 border-amber-300 text-amber-800";
      default:          return "bg-green-50 border-[#89C5B2] text-[#34745B]";
    }
  };

  // Mapa id -> alumno (se recalcula si cambia la lista)
  const alumnoMap = React.useMemo(
    () => Object.fromEntries((alumnos || []).map(a => [a.id, a])),
    [alumnos]
  );

  // Nombre corto para mostrar
  function getNombreCorto(a) {
    if (!a) return "Sin alumno";
    const base = `${a.nombre || ""} ${a.apellido || ""}`.trim();
    if (!base) return "Sin alumno";
    return base.split(" ")[0];
  }

  // Indexar clases por d√≠a/hora
  const clasesPorDiaHora = React.useMemo(() => {
    const map = {};
    (clases || []).forEach(clase => {
      const key = `${clase.fecha}_${clase.hora}`;
      if (!map[key]) map[key] = [];
      map[key].push(clase);
    });
    return map;
  }, [clases, alumnos]); // üëà depende de alumnos para re-renderizar nombres

  // Horas a mostrar (fallback si no vienen desde configuraci√≥n)
  const horasParaMostrar = React.useMemo(() => {
    // Si tu app ya provee un array de horas desde "horarioLaboral.horas", se usa ese
    if (Array.isArray(horarioLaboral?.horas) && horarioLaboral.horas.length) return horarioLaboral.horas;
    // Fallback 08:00‚Äì22:00 cada 1h
    const hs = [];
    for (let h = 8; h <= 22; h++) hs.push(String(h).padStart(2, "0") + ":00");
    return hs;
  }, [horarioLaboral]);

// --- helper: nombre del d√≠a desde "YYYY-MM-DD" (Lunes..Domingo)

function nombreDiaFromYMD(ymd) {
  const d = new Date(`${ymd}T00:00:00`);
  const idx = (d.getDay() + 6) % 7; // 0..6 => Lun..Dom
  return ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"][idx];
}

// --- mostrar solo horario laboral (lee bloques o inicio/fin)
function esHoraLaboral(day, hora) {
  if (!mostrarSoloHorarioLaboral || !horarioLaboral) return true;

  // Puede venir como { bloques:[{dia,desde,hasta,activo}] } o como array directo
  const bloques = Array.isArray(horarioLaboral?.bloques)
    ? horarioLaboral.bloques
    : (Array.isArray(horarioLaboral) ? horarioLaboral : []);

  if (bloques.length) {
    const diaNombre = nombreDiaFromYMD(day);
    const activos = bloques.filter(b => (b?.activo ?? true) && b?.dia === diaNombre);
    if (!activos.length) return false;
    // v√°lido si la hora cae dentro de alg√∫n bloque activo del d√≠a
    return activos.some(b => {
      const desde = b?.desde || "00:00";
      const hasta = b?.hasta || "23:59";
      return hora >= desde && hora < hasta;
    });
  }

  // Fallback: rango general
  const inicio = horarioLaboral?.inicio || "08:00";
  const fin    = horarioLaboral?.fin    || "22:00";
  return hora >= inicio && hora < fin;
}

return (
  <div className="grid grid-cols-[80px_repeat(7,1fr)]">
    {/* encabezado de d√≠as */}
    <div />
    {week.map(day => (
      <div key={`head-${day}`} className="text-center font-semibold p-2">
        {day}
      </div>
    ))}

    {/* grilla por horas x d√≠as */}
    {horasParaMostrar.map(hora => (
      <React.Fragment key={hora}>
        {/* columna de horas */}
        <div className="bg-white text-center text-xs p-2 flex items-center justify-center">
          <span className="text-slate-500">{hora}</span>
        </div>

        {/* celdas por d√≠a */}
        {week.map(day => {
          const laboral = esHoraLaboral(day, hora);
          const key = `${day}_${hora}`;
          const arr = clasesPorDiaHora[key] || [];

          return (
            <div
              key={`${day}-${hora}`}
              className={`${
                laboral
                  ? "bg-white hover:bg-slate-50"
                  : (mostrarSoloHorarioLaboral
                      ? "bg-slate-100 opacity-50 pointer-events-none"
                      : "bg-slate-100")
              } min-h-[70px] p-1 border-t border-l border-slate-200`}
            >
              {arr.map(clase => (
                <div
                  key={clase.id}
                  onClick={() => onEdit && onEdit(clase)}
                  className={`cursor-pointer border rounded-md px-2 py-1 mb-1 text-xs ${getStatusColor(clase.estado)}`}
                >
                  <div className="font-semibold">
                    {clase.tipo || "Clase"} ¬∑ {
                      (clase.alumnoIds || [])
                        .filter(Boolean)
                        .map(id => getNombreCorto(alumnoMap[id]))
                        .join(", ") || "Sin alumno"
                    }
                  </div>
                  {clase.notas ? (
                    <div className="text-[11px] opacity-80 truncate">{clase.notas}</div>
                  ) : null}
                </div>
              ))}
            </div>
          );
        })}
      </React.Fragment>
    ))}
  </div>
);
}

    
function Clases({ clases, alumnos, pagos, perfil, onCreate, onUpdate, onDelete, onPay, user, claseParaEditar, setClaseParaEditar, nuevoAlumnoId, setNuevoAlumnoId , prefillClase, onPrefillConsumed, grupos }) {
  const [showForm, setShowForm] = useState(false);
  const [editing, setEditing] = useState(null);
  const emptyForm = { alumnoIds: [""], fecha: formatDate(new Date()), hora: "18:00", tipo: "Clase 1 persona", estado: "Programada", precio: (parseFloat((perfil.precios || {}).individual || 0)).toString(), notas: "", cancha: "" };
  const [form, setForm] = useState(emptyForm);
  const [grupoSeleccionadoId, setGrupoSeleccionadoId] = useState("");
  const handleSelectGrupo = (e) => {
    const id = e.target.value;
    setGrupoSeleccionadoId(id);
    const grupo = grupos.find(g => g.id === id);
    if (grupo) {
      // Si se selecciona un grupo v√°lido, se actualiza el estado del formulario
      // con los IDs de los alumnos del grupo y se recalcula el precio.
      setForm(prev => {
        const nuevosAlumnos = grupo.alumnoIds || [];
        const nuevoTipoClase = normalizarTipoClase(`Clase ${nuevosAlumnos.length} personas`);
        return {
          ...prev,
          alumnoIds: nuevosAlumnos,
          tipo: nuevoTipoClase,
          // Recalcula el precio basado en el nuevo tipo y la cantidad de alumnos
          precio: computePrecioClase(nuevoTipoClase, nuevosAlumnos, perfil, alumnoMap)
        };
      });
      // Avanza al siguiente paso del formulario
      setFormStep(3);
    } else {
      // Si se deselecciona un grupo, se limpia el campo de alumnos y se vuelve al paso inicial.
      setForm(prev => ({...prev, alumnoIds: [""]}));
      setFormStep(1);
    }
  };


  useEffect(() => {
    if (prefillClase && prefillClase.fecha && prefillClase.hora) {
      setShowForm(true);
      setForm(prev => ({ ...prev, fecha: prefillClase.fecha, hora: prefillClase.hora }));
      onPrefillConsumed && onPrefillConsumed();
    }
  }, [prefillClase]);

  const [formStep, setFormStep] = useState(1);
  const [alumnoSearchQuery, setAlumnoSearchQuery] = useState("");
  const [isAlumnosListOpen, setIsAlumnosListOpen] = useState(false);
  const [filtroAlumno, setFiltroAlumno] = useState("");
  const [filtroEstado, setFiltroEstado] = useState("");
  const [filtroFechaDesde, setFiltroFechaDesde] = useState("");
  const [filtroFechaHasta, setFiltroFechaHasta] = useState("");

  

  useEffect(() => {
    if (claseParaEditar) {
      openEdit(claseParaEditar);
      setClaseParaEditar(null);
    }
  }, [claseParaEditar]);

  useEffect(() => {
    if (nuevoAlumnoId) {
      setShowForm(true);
      const alumnoSeleccionado = alumnoMap.get(nuevoAlumnoId);
      if (!alumnoSeleccionado) {
        setNuevoAlumnoId(null);
        return;
      }
      setForm({
        ...emptyForm,
        alumnoIds: [nuevoAlumnoId],
      });
      if (alumnoSeleccionado.horarios && alumnoSeleccionado.horarios.length > 0) {
        setFormStep(2);
      } else {
        setFormStep(3);
      }
      setNuevoAlumnoId(null);
    }
  }, [nuevoAlumnoId, alumnoMap, emptyForm, setNuevoAlumnoId]);

  const alumnosActivos = useMemo(() => (alumnos || []).filter(a => a.estado === 'activo'), [alumnos]);
  const alumnoMap = useMemo(() => new Map((alumnos || []).map(a => [a.id, a])), [alumnos]);
  const alumnosFiltrados = useMemo(() => {
    if (!alumnoSearchQuery) { return alumnosActivos; }
    return alumnosActivos.filter(alumno => getNombreCompleto(alumno).toLowerCase().includes(alumnoSearchQuery.toLowerCase()));
  }, [alumnoSearchQuery, alumnosActivos]);
  const pagosPorClase = useMemo(() => {
    const map = new Map();
    (pagos || []).forEach(p => {
      if (!map.has(p.claseId)) map.set(p.claseId, []);
      map.get(p.claseId).push(p);
    });
    return map;
  }, [pagos]);
  const clasesConDatos = useMemo(() => (clases || []).map(c => ({
    ...c,
    
    tipo: normalizarTipoClase(c.tipo), nombresAlumnos: (c.alumnoIds || []).map(id => getNombreCompleto(alumnoMap.get(id))).filter(Boolean).join(', '),
    pagos: pagosPorClase.get(c.id) || []
  })), [clases, alumnoMap, pagosPorClase]);
  const clasesFiltradas = useMemo(() => {
    return (clasesConDatos || []).filter(c => {
      const pasaFiltroAlumno = !filtroAlumno || (c.alumnoIds || []).includes(filtroAlumno);
      const pasaFiltroEstado = !filtroEstado || c.estado === filtroEstado;
      const pasaFiltroFechaDesde = !filtroFechaDesde || c.fecha >= filtroFechaDesde;
      const pasaFiltroFechaHasta = !filtroFechaHasta || c.fecha <= filtroFechaHasta;
      return pasaFiltroAlumno && pasaFiltroEstado && pasaFiltroFechaDesde && pasaFiltroFechaHasta;
    });
  }, [clasesConDatos, filtroAlumno, filtroEstado, filtroFechaDesde, filtroFechaHasta]);
  const canchasDisponibles = useMemo(() => (perfil.canchas || '').split('\n').filter(c => c.trim() !== ''), [perfil.canchas]);
  

  function handleFormChange(e) {
    const { name, value, type, checked } = e.target;
    const val = type === 'checkbox' ? checked : value;
    setForm(prev => {
      const newState = { ...prev, [name]: val };
      if (name === "tipo") {
        const canon = normalizarTipoClase(val);
        newState.tipo = canon;
        newState.precio = getPrecioSugerido(canon, perfil);
        const numAlumnos = TIPOS_CLASE_MAP[canon] || 1;
        newState.alumnoIds = Array.from({ length: numAlumnos }, (_, i) => prev.alumnoIds[i] || "");
      }
      return newState;
    });
  }
  function handleAlumnoChange(index, newId) {
    setForm(prev => {
      const newAlumnoIds = [...(prev.alumnoIds || [])];
      newAlumnoIds[index] = newId;
      const primerAlumno = alumnoMap.get(newAlumnoIds[0]);
      const esMensual = primerAlumno?.plan === 'mensual';
      const nuevoPrecio = esMensual ? "0" : getPrecioSugerido(prev.tipo, perfil);
      return { ...prev, alumnoIds: newAlumnoIds, precio: nuevoPrecio };
    });
    if (index === 0 && newId) {
      const alumnoSeleccionado = alumnoMap.get(newId);
      if (alumnoSeleccionado && alumnoSeleccionado.horarios && alumnoSeleccionado.horarios.length > 0) {
        setFormStep(2);
      } else {
        setFormStep(3);
      }
    }
  }
  function handleSelectAlumno(alumno) {
    setAlumnoSearchQuery(getNombreCompleto(alumno));
    setIsAlumnosListOpen(false);
    handleAlumnoChange(0, alumno.id);
  }
  
  const getNextDateForDay = (dayName) => {
    const today = new Date();
    const todayDayIndex = today.getDay(); // 0=domingo, 1=lunes, etc.
    const targetDayIndex = DIAS_SEMANA_NOMBRES.indexOf(dayName); // 0=lunes, 1=martes, etc.

    let correctedTargetIndex = targetDayIndex + 1;
    if (correctedTargetIndex === 7) {
        correctedTargetIndex = 0;
    }

    let dayDifference = correctedTargetIndex - todayDayIndex;
    if (dayDifference <= 0) {
      dayDifference += 7;
    }
    const resultDate = new Date(today.getTime());
    resultDate.setDate(today.getDate() + dayDifference);
    return resultDate;
  };
  
  function handleScheduleSelect(horario) {
    const proximaFecha = getNextDateForDay(horario.dia);
    setForm(prev => ({ ...prev, fecha: formatDate(proximaFecha), hora: horario.hora }));
    setFormStep(3);
  }
  function openNew() {
    setEditing(null);
    setForm(emptyForm);
    setAlumnoSearchQuery("");
    setFormStep(1);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function openEdit(c) {
    setEditing(c);
    setForm({ ...emptyForm, ...c, tipo: normalizarTipoClase(c.tipo) });
    setFormStep(3);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function cancel() {
    setShowForm(false);
    setEditing(null);
    setForm(emptyForm);
    setFormStep(1);
  }
  function submit(e) {
    e.preventDefault();
    const validAlumnos = (form.alumnoIds || []).filter(id => id);
    if (validAlumnos.length === 0) return alert("Seleccion√° al menos un alumno");
    const finalForm = { ...form, alumnoIds: validAlumnos };
    
    const shouldOpenPayModal = finalForm.estado === 'Realizada' || finalForm.estado === 'Ausente';
    
    let claseToPay = null;

    if (editing) {
      onUpdate({ ...finalForm, id: editing.id });
      if (shouldOpenPayModal) {
          claseToPay = { ...finalForm, id: editing.id };
      }
    } else {
      onCreate(finalForm);
      // Nota: NO abrimos modal aqu√≠. claseCrud.create abrir√° el pago con el ID real de la clase.
    }

    if (claseToPay) {
      onPay(claseToPay);
    }
    
    cancel();
  }
  
  const primerAlumnoId = form.alumnoIds ? form.alumnoIds[0] : null;
  const esMensual = alumnoMap.get(primerAlumnoId)?.plan === 'mensual';


  return (
    <div className="grid gap-4">
      <div className="flex justify-between items-center flex-wrap gap-2">
        <h2 className="text-xl font-bold text-[#34745B]">Clases</h2>
      </div>
      
      <Card title={<span className="text-[#34745B]">{editing ? "Editar clase" : "Nueva clase"}</span>} right={!showForm && <button id="nueva-clase-btn" onClick={openNew} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">+ Nueva</button>}>
        {showForm ? (
          <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
            {(formStep === 1) && (
              <div className="md:col-span-6 relative">
                <label className="text-sm text-slate-600 font-semibold">Selecciona Alumno/a</label>
                <input type="text" value={alumnoSearchQuery} onChange={(e) => { setAlumnoSearchQuery(e.target.value); setIsAlumnosListOpen(true); }} onFocus={() => setIsAlumnosListOpen(true)} onBlur={() => setTimeout(() => setIsAlumnosListOpen(false), 200)} placeholder="Escribe para buscar un alumno..." className="w-full mt-1 border rounded-lg px-3 py-2" />
                {isAlumnosListOpen && (
                  <ul className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg">
                    {alumnosFiltrados.length > 0 ? (
                      alumnosFiltrados.map(alumno => (<li key={alumno.id} onMouseDown={() => handleSelectAlumno(alumno)} className="px-3 py-2 hover:bg-slate-100 cursor-pointer">{getNombreCompleto(alumno)}</li>))
                    ) : (<li className="px-3 py-2 text-slate-500">No se encontraron alumnos.</li>)}
                  </ul>
                )}
                <div className="mt-4">
                  <label className="block text-sm text-slate-600">O selecciona un grupo:</label>
                  <select
                    value={grupoSeleccionadoId}
                    onChange={handleSelectGrupo}
                    className="w-full mt-1 border rounded-lg px-3 py-2"
                  >
                    <option value="">-- Selecciona un grupo --</option>
                    {grupos.map(g => (
                      <option key={g.id} value={g.id}>{g.nombre}</option>
                    ))}
                  </select>
                </div>
              </div>
            )}
            {(formStep === 2 && alumnoMap.get(form.alumnoIds[0])) && (
              <div className="md:col-span-6">
                <p className="text-sm text-slate-700 mb-2"><span className="font-bold">{getNombreCompleto(alumnoMap.get(form.alumnoIds[0]))}</span> tiene horarios fijos guardados.</p>
                <p className="text-sm font-semibold text-slate-600">¬øQuieres agendar una clase en uno de sus horarios habituales?</p>
                <div className="flex flex-wrap gap-2 my-3">
                  {(alumnoMap.get(form.alumnoIds[0]).horarios || []).map(horario => (
                    <button type="button" key={`${horario.dia}-${horario.hora}`} onClick={() => handleScheduleSelect(horario)} className="px-3 py-2 text-sm rounded-lg border bg-sky-50 text-sky-800 hover:bg-sky-100">{horario.dia} {horario.hora}</button>
                  ))}
                </div>
                <div className="border-t pt-3 mt-3">
                  <button type="button" onClick={() => setFormStep(3)} className="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-slate-100">O agendar una clase personalizada en otro horario</button>
                </div>
              </div>
            )}
            {(formStep === 3) && (
              <>
                <div className="md:col-span-6 grid grid-cols-1 md:grid-cols-2 gap-3">
                  {(form.alumnoIds || [""]).map((alumnoId, index) => (
  <div key={index}>
    <label className="text-sm text-slate-600">Alumno {index + 1}</label>
    <AlumnoSearchSelect
      value={alumnoId}
      onChange={(newId) => handleAlumnoChange(index, newId)}
      alumnos={alumnosActivos}
      excludeIds={(form.alumnoIds || []).filter((_, i) => i !== index)}
      placeholder={`Buscar alumno ${index + 1}...`}
      autoFocus={index === 0}
    />
  </div>
))}
                </div>
                <div className="md:col-span-2">
                  <label className="text-sm text-slate-600">Ubicaci√≥n / Cancha</label>
                  <select name="cancha" value={form.cancha} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">
                    <option value="">Seleccionar cancha...</option>
                    {canchasDisponibles.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div><label className="text-sm text-slate-600">Fecha</label><input type="date" name="fecha" value={form.fecha} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                <div><label className="text-sm text-slate-600">Hora</label><input type="time" name="hora" value={form.hora} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                <div><label className="text-sm text-slate-600">Tipo de Clase</label><select name="tipo" value={form.tipo} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">{TIPOS_CLASE.map(t => <option key={t}>{t}</option>)}</select></div>
                <div><label className="text-sm text-slate-600">Precio</label><input type="number" name="precio" value={esMensual ? "0" : form.precio} onChange={handleFormChange} className={`w-full border rounded-lg px-3 py-2 ${esMensual ? 'bg-slate-100' : ''}`} placeholder="0" disabled={esMensual} /></div>
                <div className="md:col-span-2"><label className="text-sm text-slate-600">Estado</label><select name="estado" value={form.estado} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2">{ESTADOS_CLASE.map(e => <option key={e}>{e}</option>)}</select></div>
                <div className="md:col-span-6"><label className="text-sm text-slate-600">Notas</label><textarea name="notas" value={form.notas} onChange={handleFormChange} className="w-full border rounded-lg px-3 py-2" rows={2} placeholder="Comentarios sobre la clase" /></div>
              </>
            )}
            <div className="md:col-span-6 flex gap-2 justify-end">
              <button type="button" onClick={() => { cancel(); setFormStep(1); }} className="px-3 py-2 rounded-lg border">Cancelar</button>
              {editing && <button type="button" onClick={() => onDelete(editing.id)} className="px-3 py-2 rounded-lg text-red-600 border border-red-300 hover:bg-red-50">üóëÔ∏è Eliminar</button>}
              {formStep === 3 && <button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">Guardar</button>}
            </div>
          </form>
        ) : (<p className="text-sm text-slate-500">Hac√© clic en <b>+ Nueva</b> para programar una clase.</p>)}
      </Card>

      <div>
        {(() => {
          const [semanaVisible, setSemanaVisible] = useState(getWeekStartDate(new Date()));
          const cambiarSemana = (dias) => setSemanaVisible(prev => addDays(prev, dias));
          const hoyString = formatDate(new Date());
          const semanaActualStrings = Array.from({ length: 7 }, (_, i) => formatDate(addDays(semanaVisible, i)));
          const clasesDeLaSemana = clasesFiltradas.filter(c => semanaActualStrings.includes(c.fecha));
          const clasesDeHoy = clasesFiltradas.filter(c => c.fecha === hoyString);
          const clasesAgrupadas = clasesDeLaSemana.reduce((acc, clase) => {
            if (clase.fecha !== hoyString) {
              if (!acc[clase.fecha]) acc[clase.fecha] = [];
              acc[clase.fecha].push(clase);
            }
            return acc;
          }, {});
          const diasLaborales = toArrayHorarioLaboral(perfil?.horarioLaboral).filter(d => d.activo).map(d => d.dia);
          const ClaseItem = ({ clase }) => {
    // Calcular el estado del pago
    const totalPagado = (clase.pagos || []).reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
    const precioClase = parseFloat(clase.precio || 0);
    const estadoPago = totalPagado >= precioClase ? 'Pagada' : 'Pendiente';

    // Determinar los colores y texto de la etiqueta de estado de la clase
    const estadoClaseBg = clase.estado === 'Realizada' ? 'bg-green-100 text-green-800' :
                         clase.estado === 'Ausente' ? 'bg-orange-100 text-orange-800' :
                         clase.estado === 'Cancelada' ? 'bg-red-100 text-red-800' : '';
    
    // Determinar los colores de la etiqueta de pago
    const estadoPagoBg = estadoPago === 'Pagada' ? 'bg-green-100 text-green-800' :
                         'bg-red-100 text-red-800';

    return (
        <div
            onClick={() => openEdit(clase)}
            className="p-3 bg-white rounded-lg shadow-sm border border-slate-200 hover:border-blue-300 hover:shadow-md cursor-pointer transition-all"
        >
            <div className="flex justify-between items-center">
                <p className="font-semibold text-slate-800">{clase.hora} - {clase.nombresAlumnos}</p>
                <div className="flex gap-2">
                    {clase.estado !== 'Programada' && (
                        <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${estadoClaseBg}`}>
                            {clase.estado}
                        </span>
                    )}
                    {clase.estado === 'Realizada' && (
                        <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${estadoPagoBg}`}>
                            {estadoPago}
                        </span>
                    )}
                </div>
            </div>
            <p className="text-xs text-slate-500 mt-1">{clase.tipo}{clase.cancha ? ` en ${clase.cancha}` : ''}</p>
        </div>
    );
};

          const DiaGroup = ({ fecha, clasesDelDia = [] }) => {
            const d = new Date(`${fecha}T00:00:00`);
            const diaNombre = DIAS_SEMANA_NOMBRES[d.getDay() === 0 ? 6 : d.getDay() - 1];
            const diaNumero = d.getDate();
            return (
              <div className="bg-slate-50 border border-slate-200 rounded-2xl p-4 min-h-[120px]">
                <h3 className="font-bold text-slate-700">{diaNombre}, {diaNumero}</h3>
                <div className="space-y-2 mt-2">
                  {clasesDelDia.length > 0 ? (
                    clasesDelDia.sort((a, b) => a.hora.localeCompare(b.hora)).map(c => <ClaseItem key={c.id} clase={c} />)
                  ) : (
                    <p className="text-sm text-slate-400 pt-2">No hay clases.</p>
                  )}
                </div>
              </div>
            );
          };
          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-xl font-bold text-[#34745B] mb-2">Agenda de Hoy</h2>
               <div className="bg-green-50 border border-green-200 rounded-2xl p-4">
    {clasesDeHoy.length > 0 ? (
        <div className="space-y-2">
            {clasesDeHoy.sort((a, b) => a.hora.localeCompare(b.hora)).map(c => (
                <ClaseItem key={c.id} clase={c} />
            ))}
        </div>
    ) : (
        <p className="text-sm text-slate-500">No hay clases programadas para hoy.</p>
    )}
</div>
              </div>
              <div>
                <div className="flex justify-between items-center mb-3">
                  <button onClick={() => cambiarSemana(-7)} className="px-4 py-2 text-sm rounded-lg border bg-white shadow-sm hover:bg-slate-50">‚Äπ Sem. Anterior</button>
                  <p className="font-semibold text-slate-600">Semana del {formatDate(semanaVisible, 'dd/mm')} al {formatDate(addDays(semanaVisible, 6), 'dd/mm')}</p>
                  <button onClick={() => cambiarSemana(7)} className="px-4 py-2 text-sm rounded-lg border bg-white shadow-sm hover:bg-slate-50">Sem. Siguiente ‚Ä∫</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {semanaActualStrings.map((fechaString, index) => {
                    const diaNombre = DIAS_SEMANA_NOMBRES[index];
                    if (diasLaborales.includes(diaNombre) && fechaString !== hoyString) {
                      return <DiaGroup key={fechaString} fecha={fechaString} clasesDelDia={clasesAgrupadas[fechaString] || []} />;
                    }
                    return null;
                  })}
                </div>
              </div>
            </div>
          );
        })()}
      </div>
    </div>
  );
}
    
    function Pagos({ pagos, alumnos, perfil, onPayMensual, clases, onEditarPago, onDeletePago }) {
        const [vista, setVista] = useState(perfil.metodoCobro === 'mensual' ? 'mensual' : 'historial');
        useEffect(() => {
            setVista(perfil.metodoCobro === 'mensual' ? 'mensual' : 'historial');
        }, [perfil.metodoCobro]);
        return (
            <div className="grid gap-4">
                <div className="flex items-center gap-2 bg-slate-100 p-1 rounded-xl">
                    <button onClick={() => setVista('historial')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'historial' ? 'bg-white shadow' : ''}`}>Historial de Pagos</button>
                    <button onClick={() => setVista('mensual')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'mensual' ? 'bg-white shadow' : ''}`}>Control Clases Mensuales</button>
                    <button onClick={() => setVista('deudas')} className={`w-full text-center px-3 py-1.5 text-sm rounded-lg ${vista === 'deudas' ? 'bg-white shadow' : ''}`}>Control de Deudas</button>
                </div>
                {vista === 'historial' && <HistorialPagos pagos={pagos} alumnos={alumnos} clases={clases} onEditarPago={onEditarPago} onDeletePago={onDeletePago} />}
                {vista === 'mensual' && <ControlMensual pagos={pagos} alumnos={alumnos} perfil={perfil} onPay={onPayMensual} />}
                {vista === 'deudas' && <ControlDeudas pagos={pagos} alumnos={alumnos} clases={clases} perfil={perfil} />}
            </div>
        );
    }

function HistorialPagos({ pagos, alumnos, clases, onEditarPago, onDeletePago }) {
          const [periodo, setPeriodo] = useState("mes");
          const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
          const [metodo, setMetodo] = useState("Todos");
          const [currentPage, setCurrentPage] = useState(1);
          const ITEMS_PER_PAGE = 10;
          const alumnoMap = useMemo(() => new Map(alumnos.map(a => [a.id, getNombreCompleto(a)])), [alumnos]);

          const pagosConDatos = useMemo(() => {
              return pagos.map(pago => {
                  const nombreAlumno = alumnoMap.get(pago.alumnoId) || 'Alumno no encontrado';
                  const concepto = pago.concepto || `Pago de ${nombreAlumno}`;
                  return { ...pago, nombreAlumno, concepto };
              });
          }, [pagos, alumnoMap]);
          
          const pagosFiltrados = useMemo(() => {
            const ahora = new Date();
            return pagosConDatos.filter(p => {
                const fechaPago = new Date(p.fecha + "T00:00:00");
                if (periodo === 'dia') return formatDate(fechaPago) === formatDate(ahora);
                if (periodo === 'semana') return getWeekStartDate(fechaPago).getTime() === getWeekStartDate(ahora).getTime();
                if (periodo === 'a√±o') return fechaPago.getFullYear() === selectedYear;
                if (periodo === 'mes') {
                  // Corregimos la condici√≥n para que solo filtre por m√©todo si no es "Todos"
                  if (metodo !== 'Todos' && p.metodo !== metodo) return false;
                  return fechaPago.getMonth() === selectedMonth && fechaPago.getFullYear() === selectedYear;
                }
                if (metodo !== 'Todos' && p.metodo !== metodo) return false;
                return true;
              }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
          }, [pagosConDatos, periodo, selectedMonth, selectedYear, metodo]);
          
          const totales = useMemo(() => {
            return pagosFiltrados.reduce((acc, p) => {
              if (p.metodo !== 'Pendiente') {
                const monto = parseFloat(p.monto || 0) || 0;
                acc.total += monto;
                if (p.metodo === 'Efectivo') acc.efectivo += monto;
                if (p.metodo === 'Transferencia') acc.transferencia += monto;
              }
              return acc;
            }, { total: 0, efectivo: 0, transferencia: 0 });
          }, [pagosFiltrados]);

          const totalPages = Math.ceil(pagosFiltrados.length / ITEMS_PER_PAGE);
          const paginatedPagos = useMemo(() => {
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            return pagosFiltrados.slice(startIndex, startIndex + ITEMS_PER_PAGE);
          }, [pagosFiltrados, currentPage]);

          useEffect(() => {
            setCurrentPage(1);
          }, [periodo, selectedMonth, selectedYear, metodo]);

          const availableYears = useMemo(() => {
            const years = new Set(pagos.map(p => new Date(p.fecha).getFullYear()));
            if (!years.has(new Date().getFullYear())) {
                years.add(new Date().getFullYear());
            }
            return Array.from(years).sort((a, b) => b - a);
          }, [pagos]);

          const FilterButton = ({ onClick, isActive, children }) => (
            <button onClick={onClick} className={`px-3 py-1 rounded-md transition-colors text-sm ${isActive ? 'bg-white shadow text-slate-800 font-semibold' : 'text-slate-500 hover:text-slate-800'}`}>
                {children}
            </button>
          );

          return (
            <Card title={<span className="text-[#34745B]">Historial de Pagos</span>}>
                <div className="p-3 border rounded-xl bg-slate-50 mb-4 space-y-3">
                    <div className="flex flex-wrap items-center gap-4">
                        <div className="bg-slate-200 p-1 rounded-lg inline-flex items-center">
                            <FilterButton onClick={() => { setPeriodo('dia'); setSelectedYear(new Date().getFullYear()); }} isActive={periodo === 'dia'}>Hoy</FilterButton>
                            <FilterButton onClick={() => { setPeriodo('semana'); setSelectedYear(new Date().getFullYear()); }} isActive={periodo === 'semana'}>Semana</FilterButton>
                        </div>
                        <div className="bg-slate-200 p-1 rounded-lg flex-1 flex-wrap inline-flex items-center">
                             {MESES_NOMBRES.map((mes, index) => (
                                <FilterButton key={mes} onClick={() => { setPeriodo('mes'); setSelectedMonth(index); }} isActive={periodo === 'mes' && selectedMonth === index}>{mes}</FilterButton>
                            ))}
                        </div>
                        <div className="bg-slate-200 p-1 rounded-lg inline-flex items-center">
                           <select 
                             value={selectedYear} 
                             onChange={(e) => { setPeriodo('mes'); setSelectedYear(parseInt(e.target.value)); }}
                             className="bg-white px-2 py-1 rounded-md text-sm font-semibold shadow"
                           >
                            {availableYears.map(year => <option key={year} value={year}>{year}</option>)}
                           </select>
                        </div>
                    </div>
                     <div className="bg-slate-200 p-1 rounded-lg inline-flex items-center flex-wrap">
                        <FilterButton onClick={() => setMetodo('Todos')} isActive={metodo === 'Todos'}>Todos</FilterButton>
                        <FilterButton onClick={() => setMetodo('Efectivo')} isActive={metodo === 'Efectivo'}>Efectivo</FilterButton>
                        <FilterButton onClick={() => setMetodo('Transferencia')} isActive={metodo === 'Transferencia'}>Transferencia</FilterButton>
                        <FilterButton onClick={() => setMetodo('Pendiente')} isActive={metodo === 'Pendiente'}>Pendiente</FilterButton>
                        <FilterButton onClick={() => setMetodo('Mixto')} isActive={metodo === 'Mixto'}>Mixto</FilterButton>
                    </div>
                </div>

                <div className="grid md:grid-cols-3 gap-4 mb-4">
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl"><p className="text-sm text-green-800">Total Ingresado</p><p className="text-2xl font-bold text-[#34745B]">${totales.total.toFixed(2)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Total en Efectivo</p><p className="text-2xl font-bold text-slate-800">${totales.efectivo.toFixed(2)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Total por Transferencia</p><p className="text-2xl font-bold text-slate-800">${totales.transferencia.toFixed(2)}</p></div>
                </div>
                
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead>
                        <tr className="text-left text-slate-600">
                            <th className="p-2">Fecha</th>
                            <th className="p-2">Alumno</th>
                            <th className="p-2">Concepto</th>
                            <th className="p-2">Monto</th>
                            <th className="p-2">M√©todo</th>
                            <th className="p-2 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                      {paginatedPagos.length === 0 && (<tr><td colSpan={6} className="text-center py-6 text-slate-400">No hay pagos que coincidan con los filtros</td></tr>)}
                      {paginatedPagos.map(p => (
                        <tr key={p.id} className="border-t">
                            <td className="p-2">{p.fecha}</td>
                            <td className="p-2 font-semibold">{p.nombreAlumno}</td>
                            <td className="p-2">{p.concepto}</td>
                            <td className="p-2">${parseFloat(p.monto || 0).toFixed(2)}</td>
                            <td className="p-2"><span className={`px-2 py-0.5 rounded-full text-xs ${p.metodo === 'Pendiente' ? 'bg-orange-100 text-orange-800' : p.metodo === 'Mixto' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>{p.metodo}</span></td>
                            <td className="p-2 text-right">
                                <div className="inline-flex gap-2">
                                    <button onClick={() => onEditarPago(p)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button>
                                    <button onClick={() => onDeletePago(p.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button>
                                
    <button
      onClick={() => (window.coachexComprobante && window.coachexComprobante.generarPDF) && window.coachexComprobante.generarPDF({
        alumno: (alumnos||[]).find(a => a.id === p.alumnoId),
        pago: p,
        clase: (clases||[]).find(c => c.id === p.claseId),
        perfil: (typeof state !== 'undefined' ? state.perfil : undefined)
      })}
      className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50"
      title="Descargar comprobante PDF"
    >üìÑ Comprobante</button>
    {(() => {
      const al = (alumnos||[]).find(a => a.id === p.alumnoId);
      const url = window.coachexComprobante?.waLink?.(al, "Te env√≠o el comprobante de pago");
      return url ? (
        <a
          href={url}
          target="_blank" rel="noopener noreferrer"
          className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50"
          title="Enviar por WhatsApp"
        >üü¢ WhatsApp</a>
      ) : null;
    })()}

                                </div>
                            </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {totalPages > 1 && (
                  <div className="mt-4 flex justify-center items-center gap-2">
                    <button onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} disabled={currentPage === 1} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">Anterior</button>
                    <span className="text-sm text-slate-600">P√°gina {currentPage} de {totalPages}</span>
                    <button onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} disabled={currentPage === totalPages} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">Siguiente</button>
                  </div>
                )}
            </Card>
          );
        }
    
    function ControlMensual({ pagos, alumnos, perfil, onPay }) {
        const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
        const alumnosMensuales = useMemo(() => alumnos.filter(a => a.plan === 'mensual' && a.estado === 'activo'), [alumnos]);
        
        const statusMensual = useMemo(() => {
            const anioActual = new Date().getFullYear();
            const pagosDelMes = pagos.filter(p => {
                const fechaPago = new Date(p.fecha);
                return p.concepto?.startsWith("Cuota Mensual") && fechaPago.getMonth() === selectedMonth && fechaPago.getFullYear() === anioActual;
            });

            return alumnosMensuales.map(alumno => {
                const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
                const pagosAlumno = pagosDelMes.filter(p => p.alumnoId === alumno.id);
                const totalPagado = pagosAlumno.reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
                
                let estado = 'Pendiente';
                if (totalPagado >= cuota) {
                    estado = 'Pagado';
                } else if (totalPagado > 0) {
                    estado = 'Parcial';
                }

                return { ...alumno, cuota, totalPagado, estado };
            });
        }, [alumnosMensuales, pagos, selectedMonth, perfil.preciosMensuales]);

        const getStatusColor = (status) => {
            if (status === 'Pagado') return 'bg-green-100 text-green-800';
            if (status === 'Parcial') return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        };
        const FilterButton = ({ onClick, isActive, children }) => (
            <button onClick={onClick} className={`px-3 py-1 rounded-md transition-colors text-sm ${isActive ? 'bg-white shadow text-slate-800 font-semibold' : 'text-slate-500 hover:text-slate-800'}`}>
                {children}
            </button>
        );
        return (
            <Card title="Control de Cuotas Mensuales">
                {/* --- Bloque de Filtros Redise√±ado --- */}
                <div className="p-3 border rounded-xl bg-slate-50 mb-4">
                    <div className="bg-slate-200 p-1 rounded-lg flex-1 flex-wrap inline-flex items-center w-full">
                         {MESES_NOMBRES.map((mes, index) => (
                            <FilterButton key={mes} onClick={() => setSelectedMonth(index)} isActive={selectedMonth === index}>{mes}</FilterButton>
                        ))}
                    </div>
                </div>

                <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Alumno</th><th className="p-2">Plan</th><th className="p-2">Monto Cuota</th><th className="p-2">Monto Pagado</th><th className="p-2">Estado</th><th className="p-2 text-right">Acciones</th></tr></thead><tbody>
                    {statusMensual.length === 0 && (<tr><td colSpan={6} className="text-center py-6 text-slate-400">No hay alumnos con plan mensual</td></tr>)}
                    {statusMensual.map(a => (
                        <tr key={a.id} className="border-t">
                            <td className="p-2">{`${a.apellido || ''} ${a.nombre || ''}`.trim()}</td>
                            <td className="p-2">{FRECUENCIAS_MENSUALES.find(f => f.value === a.frecuencia)?.label}</td>
                            <td className="p-2">${a.cuota.toFixed(2)}</td>
                            <td className="p-2">${a.totalPagado.toFixed(2)}</td>
                            <td className="p-2"><span className={`px-2 py-0.5 rounded-full text-xs ${getStatusColor(a.estado)}`}>{a.estado}</span></td>
                            <td className="p-2 text-right">
                                {a.estado !== 'Pagado' && <button onClick={() => onPay(a, selectedMonth)} className="px-2 py-1 text-xs rounded-lg border bg-emerald-500 text-white">Registrar Pago</button>}
                            </td>
                        </tr>
                    ))}
                </tbody></table></div>
            </Card>
        );
    }
    
    function ControlDeudas({ pagos, alumnos, clases, perfil }) {
        const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : '??';
        
        const deudas = useMemo(() => {
            const deudores = [];
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const anioActual = hoy.getFullYear();

            const alumnosMensuales = alumnos.filter(a => a.plan === 'mensual' && a.estado === 'activo');
            const pagosMensuales = pagos.filter(p => p.concepto?.startsWith("Cuota Mensual"));

            alumnosMensuales.forEach(alumno => {
                const cuota = parseFloat(perfil.preciosMensuales[alumno.frecuencia] || 0);
                const pagosDelMes = pagosMensuales.filter(p => {
                    const fechaPago = new Date(p.fecha);
                    return p.alumnoId === alumno.id && fechaPago.getMonth() === mesActual && fechaPago.getFullYear() === anioActual;
                });
                const totalPagado = pagosDelMes.reduce((acc, p) => acc + parseFloat(p.monto || 0), 0);
                const deuda = cuota - totalPagado;
                if (deuda > 0) {
                    deudores.push({ id: alumno.id, nombre: getNombreCompleto(alumno), tipo: 'Cuota Mensual', monto: deuda });
                }
            });

            const pagosPorClaseMap = new Map();
            pagos.filter(p => p.claseId).forEach(p => {
                if(!pagosPorClaseMap.has(p.claseId)) pagosPorClaseMap.set(p.claseId, 0);
                pagosPorClaseMap.set(p.claseId, pagosPorClaseMap.get(p.claseId) + parseFloat(p.monto || 0));
            });
            const clasesRealizadas = clases.filter(c => c.estado === 'Realizada' && new Date(c.fecha) <= hoy);
            
            clasesRealizadas.forEach(clase => {
                const totalPagado = pagosPorClaseMap.get(clase.id) || 0;
                const precioClase = parseFloat(clase.precio || 0);

                if (totalPagado < precioClase) {
                    clase.alumnoIds.forEach(alumnoId => {
                        const alumno = alumnos.find(a => a.id === alumnoId);
                        if (alumno && alumno.plan === 'porClase') {
                            // Este c√°lculo asume que la deuda se reparte equitativamente.
                            const deudaClase = precioClase - totalPagado;
                            const monto = deudaClase / clase.alumnoIds.length;
                            deudores.push({ id: `${clase.id}-${alumno.id}`, nombre: getNombreCompleto(alumno), tipo: `Clase ${clase.fecha}`, monto });
                        }
                    });
                }
            });
            
            const deudasAgrupadas = deudores.reduce((acc, deuda) => {
                const alumnoId = alumnos.find(a => getNombreCompleto(a) === deuda.nombre)?.id || deuda.nombre;
                if(!acc[alumnoId]) acc[alumnoId] = { nombre: deuda.nombre, total: 0, detalles: [] };
                acc[alumnoId].total += deuda.monto;
                acc[alumnoId].detalles.push({ tipo: deuda.tipo, monto: deuda.monto });
                return acc;
            }, {});
            
            return Object.values(deudasAgrupadas).sort((a,b) => b.total - a.total);

        }, [pagos, alumnos, clases, perfil]);
        
        return (
            <Card title="Control de Deudas Pendientes (Mes Actual)">
                 <div className="overflow-x-auto"><table className="min-w-full text-sm"><thead><tr className="text-left text-slate-600"><th className="p-2">Alumno</th><th className="p-2">Detalle de Deuda</th><th className="p-2 text-right">Total Adeudado</th></tr></thead><tbody>
                    {deudas.length === 0 && (<tr><td colSpan={3} className="text-center py-6 text-slate-400">No hay deudas pendientes registradas para el mes actual.</td></tr>)}
                    {deudas.map(deuda => (
                        <tr key={deuda.nombre} className="border-t">
                            <td className="p-2 font-semibold">{deuda.nombre}</td>
                            <td className="p-2">
                                <ul className="list-disc list-inside">
                                {deuda.detalles.map((d, i) => (
                                    <li key={i}>{d.tipo}: <span className="font-medium">${d.monto.toFixed(2)}</span></li>
                                ))}
                                </ul>
                            </td>
                            <td className="p-2 font-semibold text-red-600 text-right">${deuda.total.toFixed(2)}</td>
                        </tr>
                    ))}
                </tbody></table></div>
            </Card>
        );
    }


function Gastos({ gastos, onCreate, onUpdate, onDelete }) {
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const emptyForm = { fecha: formatDate(new Date()), concepto: "", monto: "", categoria: "Varios" };
      const [form, setForm] = useState(emptyForm);
      const [periodo, setPeriodo] = useState("mes");
      const [currentPage, setCurrentPage] = useState(1);
      const ITEMS_PER_PAGE = 10;

      const handleChange = (e) => { const { name, value } = e.target; setForm(prev => ({ ...prev, [name]: value })); };

      const gastosFiltrados = useMemo(() => {
        const ahora = new Date();
        const hoy = formatDate(ahora);
        const semanaInicio = formatDate(getWeekStartDate(ahora));
        const mesInicio = formatDate(new Date(ahora.getFullYear(), ahora.getMonth(), 1));
        const anioInicio = formatDate(new Date(ahora.getFullYear(), 0, 1));

        return gastos
          .filter(g => {
            if (periodo === 'dia' && g.fecha !== hoy) return false;
            if (periodo === 'semana' && g.fecha < semanaInicio) return false;
            if (periodo === 'mes' && g.fecha < mesInicio) return false;
            if (periodo === 'a√±o' && g.fecha < anioInicio) return false;
            return true;
          })
          .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      }, [gastos, periodo]);
      
      const totalGastos = useMemo(() => gastosFiltrados.reduce((acc, g) => acc + (parseFloat(g.monto || 0) || 0), 0), [gastosFiltrados]);

      const totalPages = Math.ceil(gastosFiltrados.length / ITEMS_PER_PAGE);
      const paginatedGastos = useMemo(() => {
          const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
          return gastosFiltrados.slice(startIndex, startIndex + ITEMS_PER_PAGE);
      }, [gastosFiltrados, currentPage]);

      useEffect(() => {
          setCurrentPage(1);
      }, [periodo]);

      function openNew() { setEditing(null); setForm(emptyForm); setShowForm(true); }
      function openEdit(g) { setEditing(g); setForm(g); setShowForm(true); }
      function cancel() { setShowForm(false); setEditing(null); setForm(emptyForm); }
      function submit(e) { e.preventDefault(); if (!form.concepto.trim() || !form.monto) return alert("Complet√° concepto y monto"); if (editing) { onUpdate({ ...form, id: editing.id }); } else { onCreate(form); } cancel(); }

      const PeriodoButton = ({ value, current, setter, children }) => (<button onClick={() => setter(value)} className={`px-3 py-1.5 text-sm rounded-lg ${current === value ? 'bg-[#34745B] text-white hover:bg-green-800' : 'bg-white border text-slate-700 hover:bg-slate-50'}`}>{children}</button>);
      
      return (
        <div className="grid gap-4">
          <Card 
            title={<span className="text-[#34745B]">{editing ? "Editar gasto" : "Nuevo gasto"}</span>} 
            right={!showForm && <button onClick={openNew} className="bg-[#34745B] hover:bg-green-800 text-white text-sm px-3 py-1.5 rounded-xl">+ Nuevo</button>}
          >
            {showForm ? (
                <form onSubmit={submit} className="grid md:grid-cols-6 gap-3">
                    <div className="md:col-span-3"><label className="text-sm text-slate-600">Fecha</label><input type="date" name="fecha" value={form.fecha} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" required /></div>
                    <div className="md:col-span-3"><label className="text-sm text-slate-600">Concepto</label><input type="text" name="concepto" value={form.concepto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: Alquiler de cancha" required /></div>
                    <div className="md:col-span-3"><label className="text-sm text-slate-600">Monto</label><input type="number" name="monto" value={form.monto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" placeholder="Ej: 1500" required /></div>
                    <div className="md:col-span-3"><label className="text-sm text-slate-600">Categor√≠a</label><select name="categoria" value={form.categoria} onChange={handleChange} className="w-full border rounded-lg px-3 py-2">{CATEGORIAS_GASTOS.map(c => <option key={c}>{c}</option>)}</select></div>
                    <div className="md:col-span-6 flex gap-2 justify-end"><button type="button" onClick={cancel} className="px-3 py-2 rounded-lg border">Cancelar</button><button type="submit" className="px-3 py-2 rounded-lg bg-[#34745B] hover:bg-green-800 text-white">Guardar</button></div>
                </form>
            ) : ( <p className="text-sm text-slate-500">Hac√© clic en <b>+ Nuevo</b> para registrar un gasto.</p> )}
          </Card>
          
          <Card title={<span className="text-[#34745B]">Control de Gastos</span>}>
            <div className="flex flex-wrap items-center gap-2 mb-4">
              <PeriodoButton value="dia" current={periodo} setter={setPeriodo}>Hoy</PeriodoButton>
              <PeriodoButton value="semana" current={periodo} setter={setPeriodo}>Semana</PeriodoButton>
              <PeriodoButton value="mes" current={periodo} setter={setPeriodo}>Mes</PeriodoButton>
              <PeriodoButton value="a√±o" current={periodo} setter={setPeriodo}>A√±o</PeriodoButton>
            </div>
            <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl mb-4"><p className="text-sm text-slate-600">Total de Gastos</p><p className="text-2xl font-bold text-slate-800">${totalGastos.toFixed(2)}</p></div>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-slate-600"><th className="p-2">Fecha</th><th className="p-2">Concepto</th><th className="p-2">Monto</th><th className="p-2">Categor√≠a</th><th className="p-2 text-right">Acciones</th></tr></thead>
                <tbody>
                  {paginatedGastos.length === 0 && (<tr><td colSpan={5} className="text-center py-6 text-slate-400">No hay gastos en este per√≠odo</td></tr>)}
                  {paginatedGastos.map(g => (<tr key={g.id} className="border-t"><td className="p-2">{g.fecha}</td><td className="p-2">{g.concepto}</td><td className="p-2">${g.monto}</td><td className="p-2">{g.categoria}</td><td className="p-2 text-right"><div className="inline-flex gap-2"><button onClick={() => openEdit(g)} className="px-2 py-1 text-xs rounded-lg border hover:bg-slate-50">‚úèÔ∏è Editar</button><button type="button" onClick={() => onDelete(g.id)} className="px-2 py-1 text-xs rounded-lg border text-red-600 hover:bg-red-50">üóëÔ∏è Eliminar</button></div></td></tr>))}
                </tbody>
              </table>
            </div>
            {totalPages > 1 && (
              <div className="mt-4 flex justify-center items-center gap-2">
                <button onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} disabled={currentPage === 1} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">Anterior</button>
                <span className="text-sm text-slate-600">P√°gina {currentPage} de {totalPages}</span>
                <button onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} disabled={currentPage === totalPages} className="px-3 py-1 text-sm border rounded-lg disabled:opacity-50">Siguiente</button>
              </div>
            )}
          </Card>
        </div>
      );
    }
    
    function GraficoBarras({ data }) {
      const maxValue = useMemo(() => Math.max(...data.map(d => d.value), 1), [data]);
      return (
        <div className="bg-slate-50 rounded-xl p-4 h-64 flex justify-around items-end gap-4">
          {data.map(item => (
            <div key={item.label} className="flex-1 flex flex-col items-center gap-2">
              <div className="text-sm font-semibold text-slate-700">${item.value.toFixed(2)}</div>
              <div className={`w-full rounded-t-lg ${item.color}`} style={{ height: `${(item.value / maxValue) * 80}%` }} title={`${item.label}: $${item.value.toFixed(2)}`}></div>
              <div className="text-xs font-medium text-slate-600">{item.label}</div>
            </div>
          ))}
        </div>
      );
    }
    
function Reportes({ pagos, gastos, alumnos, clases, clubActivoId, clubes, perfil }) {
      const [periodo, setPeriodo] = useState("dia"); // Inicia por defecto en "Hoy"
      const [mesSeleccionado, setMesSeleccionado] = useState(formatDate(new Date()).slice(0, 7));
      const [fechaSeleccionada, setFechaSeleccionada] = useState(formatDate(new Date()));

      const filterByPeriod = useMemo(() => {
        return (item) => {
            const ahora = new Date();
            const itemDate = new Date(`${item.fecha}T00:00:00`);
            
            if (periodo === 'dia') return formatDate(itemDate) === formatDate(ahora);
            if (periodo === 'customDay') return formatDate(itemDate) === fechaSeleccionada;
            if (periodo === 'semana') return getWeekStartDate(itemDate).getTime() === getWeekStartDate(ahora).getTime();
            if (periodo === 'customMonth' && mesSeleccionado) {
                const [year, month] = mesSeleccionado.split('-');
                return itemDate.getFullYear() === parseInt(year) && (itemDate.getMonth() + 1) === parseInt(month);
            }
            if(periodo === 'mes') {
                return itemDate.getMonth() === ahora.getMonth() && itemDate.getFullYear() === ahora.getFullYear();
            }
            return false;
        };
      }, [periodo, mesSeleccionado, fechaSeleccionada]);

      const [pagosFiltrados, gastosFiltrados, clasesFiltradas] = useMemo(() => {
        const pagosF = pagos.filter(p => p.metodo !== 'Pendiente').filter(filterByPeriod);
        const gastosF = gastos.filter(filterByPeriod);
        const clasesF = clases.filter(c => c.estado === 'Realizada').filter(filterByPeriod);
        return [pagosF, gastosF, clasesF];
      }, [pagos, gastos, clases, filterByPeriod]);
      
      const totales = useMemo(() => {
        const totalIngresos = pagosFiltrados.reduce((acc, p) => acc + (parseFloat(p.monto) || 0), 0);
        const totalGastos = gastosFiltrados.reduce((acc, g) => acc + (parseFloat(g.monto) || 0), 0);
        return { ingresos: totalIngresos, gastos: totalGastos, balance: totalIngresos - totalGastos };
      }, [pagosFiltrados, gastosFiltrados]);
      
      const distribucionIngresos = useMemo(() => {
        const clubActivo = clubActivoId ? clubes.find(c => c.id === clubActivoId) : null;
        const porcentajeProfesor = clubActivo ? (clubActivo.reparto.coach || 0) / 100 : 1;
        const porcentajeClub = clubActivo ? (clubActivo.reparto.club || 0) / 100 : 0;
        const ingresosDeClases = pagosFiltrados
            .filter(p => p.claseId)
            .reduce((acc, p) => acc + (parseFloat(p.monto) || 0), 0);
        return {
            nombreLugar: clubActivo ? clubActivo.nombre : "Independiente",
            repartoTexto: clubActivo ? `${clubActivo.reparto.coach}% / ${clubActivo.reparto.club}%` : "100% Profesor",
            gananciaProfesor: ingresosDeClases * porcentajeProfesor,
            gananciaClub: ingresosDeClases * porcentajeClub,
            hayReparto: !!clubActivo
        };
      }, [pagosFiltrados, clubActivoId, clubes]);

const resumenClasesMes = useMemo(() => {
  const conteoPorTipo = clasesFiltradas.reduce((acc, clase) => {
    const tipoCanonico = normalizarTipoClase(clase.tipo || 'Clase 1 persona');
    const precio = parseFloat(clase.precio || 0);
    if (!acc[tipoCanonico]) {
      acc[tipoCanonico] = { cantidad: 0, valorTotal: 0 };
    }
    acc[tipoCanonico].cantidad += 1;
    acc[tipoCanonico].valorTotal += precio;
    return acc;
  }, {});

  return {
    totalClases: clasesFiltradas.length,
    valorTotalGeneral: clasesFiltradas.reduce((acc, c) => acc + parseFloat(c.precio || 0), 0),
    detalle: Object.entries(conteoPorTipo).sort((a, b) => b[1].cantidad - a[1].cantidad)
  };
},

function PagosMensuales({ user, clubActivoId, alumnos }) {
  const [rows, setRows] = useState([]);
  const [mes, setMes] = useState(mesClave(new Date()));
  const [loading, setLoading] = useState(true);
  const alumnosMensuales = React.useMemo(() => {
  if (!Array.isArray(alumnos)) return [];
  return alumnos.filter(a => a && a.plan === 'mensual' && a.estado !== 'inactivo');
}, [alumnos]);

  useEffect(() => {
    if (!user || !clubActivoId || !mes) return;
    setLoading(true);
    const ref = mensualidadesRef(user, clubActivoId).where('mes', '==', mes);
    const unsub = ref.onSnapshot(snap => {
      setRows(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      setLoading(false);
    }, (e) => { console.error('PagosMensuales->onSnapshot', e); setLoading(false); });
    return () => unsub && unsub();
  }, [user, clubActivoId, mes]);

  const nombreAlumno = (id) => getNombreCompleto((alumnos||[]).find(a => a.id === id));

  const generarMesActual = async () => {
    try {
      for (const a of alumnosMensuales) {
        await ensureMensualidadParaAlumno({ user, clubId: clubActivoId, alumno: a, fechaRef: new Date(), perfil: (window.__perfilCache || null) });
      }
      alert('Mensualidades del mes generadas/actualizadas.');
    } catch (e) {
      console.error('generarMesActual:', e);
      alert('Error al generar mensualidades.');
    }
  };

  return (
    <Card title="Mensualidades" right={
      <div className="flex gap-2 items-center">
        <input type="month" value={mes} onChange={e=>setMes(e.target.value)} className="border rounded-lg px-3 py-2"/>
        <button onClick={generarMesActual} className="px-3 py-2 rounded-lg bg-emerald-600 text-white">Generar mes actual</button>
      </div>
    }>
      {loading ? <div className="text-sm text-slate-500">Cargando‚Ä¶</div> : (
        <div className="overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead>
              <tr className="text-left text-slate-600">
                <th className="p-2">Alumno</th>
                <th className="p-2">Mes</th>
                <th className="p-2">Frecuencia</th>
                <th className="p-2">Incluidas</th>
                <th className="p-2">Consumidas</th>
                <th className="p-2">Monto</th>
                <th className="p-2">Deuda extra</th>
                <th className="p-2">Estado</th>
                <th className="p-2">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {rows.map(r => (
                <tr key={r.id} className="border-t">
                  <td className="p-2">{nombreAlumno(r.alumnoId) || r.alumnoId}</td>
                  <td className="p-2">{r.mes}</td>
                  <td className="p-2">{r.frecuencia}</td>
                  <td className="p-2">{r.incluidas}</td>
                  <td className="p-2">{r.consumidas}</td>
                  <td className="p-2">{formatCurrency(r.monto)}</td>
                  <td className="p-2">{formatCurrency(r.deudaExtra || "0")}</td>
                  <td className="p-2">{r.pagado ? "Pagado" : (r.estado || "pendiente")}</td>
                  <td className="p-2">
                    {!r.pagado && (
                      <button className="px-2 py-1 rounded-lg bg-emerald-600 text-white"
                        onClick={() => marcarPagoMensualidad({ user, clubId: clubActivoId, alumnoId: r.alumnoId, mes: r.mes })}>
                        Marcar pago
                      </button>
                    )}
                  </td>
                </tr>
              ))}
              {!rows.length && <tr><td className="p-2 text-slate-500" colSpan="9">Sin mensualidades para {mes}.</td></tr>}
            </tbody>
          </table>
        </div>
      )}
    </Card>
  );
}

, [clasesFiltradas]);

      const PeriodoButton = ({ value, children }) => (
        <button 
            onClick={() => setPeriodo(value)} 
            className={`px-3 py-1.5 text-sm rounded-lg ${periodo === value ? 'bg-[#34745B] text-white hover:bg-green-800' : 'bg-white border text-slate-700 hover:bg-slate-50'}`}
        >
            {children}
        </button>
      );

      const handleExportToPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const nombreProfesor = `${perfil.nombre || ''} ${perfil.apellido || ''}`.trim();
        const nombreLugar = distribucionIngresos.nombreLugar;
        let periodoTexto = "";
        if (periodo === 'dia') periodoTexto = `el d√≠a de hoy (${formatDate(new Date(), 'dd/mm')})`;
        else if (periodo === 'customDay') periodoTexto = `el d√≠a ${formatDate(new Date(fechaSeleccionada + 'T00:00:00'), 'dd/mm')}`;
        else if (periodo === 'semana') periodoTexto = `la semana actual`;
        else if (periodo === 'mes') periodoTexto = `el mes actual`;
        else if (periodo === 'customMonth' && mesSeleccionado) {
            const [year, month] = mesSeleccionado.split('-');
            periodoTexto = `el mes de ${MESES_NOMBRES[parseInt(month) - 1]} de ${year}`;
        }
        let finalY = 20;
        doc.setFontSize(18);
        doc.text("Reporte de Actividad", 14, finalY);
        finalY += 10;
        doc.setFontSize(11);
        doc.text(`Profesor/a: ${nombreProfesor}`, 14, finalY);
        finalY += 6;
        doc.text(`Lugar de Trabajo: ${nombreLugar}`, 14, finalY);
        finalY += 6;
        doc.text(`Per√≠odo del Reporte: ${periodoTexto}`, 14, finalY);
        finalY += 10;
        doc.setFontSize(14);
        doc.text("Resumen de Clases Realizadas", 14, finalY);
        finalY += 8;
        doc.setFontSize(11);
        doc.text(`Total de Clases: ${resumenClasesMes.totalClases}`, 14, finalY);
        doc.text(`Valor Bruto Generado: $${resumenClasesMes.valorTotalGeneral.toFixed(2)}`, 100, finalY);
        finalY += 6;
        const tableHead = [['Tipo de Clase', 'Cantidad', 'Valor Generado']];
        const tableBody = resumenClasesMes.detalle.map(([tipo, data]) => [
            TIPOS_CLASE_NOMBRES[tipo] || tipo,
            data.cantidad,
            `$${data.valorTotal.toFixed(2)}`
        ]);
        doc.autoTable({ head: tableHead, body: tableBody, startY: finalY, theme: 'grid' });
        finalY = doc.autoTable.previous.finalY + 12;
        doc.setFontSize(14);
        doc.text("Distribuci√≥n de Ingresos", 14, finalY);
        finalY += 8;
        doc.setFontSize(11);
        doc.text(`(Reparto: ${distribucionIngresos.repartoTexto})`, 14, finalY);
        finalY += 8;
        doc.text(`Ganancia Neta Profesor: $${distribucionIngresos.gananciaProfesor.toFixed(2)}`, 14, finalY);
        finalY += 8;
        doc.text(`Ganancia Club: $${distribucionIngresos.gananciaClub.toFixed(2)}`, 14, finalY);
        doc.save(`Reporte_${nombreLugar.replace(/ /g, '_')}_${periodo === 'customDay' ? fechaSeleccionada : mesSeleccionado}.pdf`);
      };
      
      return (
        <div className="grid gap-6">
          <Card title={<span className="text-[#34745B]">Reportes Financieros y Operativos</span>}>
            <div className="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4">
              <div className="flex items-center gap-2">
                <PeriodoButton value="dia">Hoy</PeriodoButton>
                <PeriodoButton value="semana">Esta Semana</PeriodoButton>
                <PeriodoButton value="mes">Este Mes</PeriodoButton>
              </div>
              <div className="flex items-center gap-2">
                <label htmlFor="fecha-reporte" className="text-sm text-slate-600">Ver d√≠a:</label>
                <input
                    type="date"
                    id="fecha-reporte"
                    value={fechaSeleccionada}
                    onChange={(e) => {
                        setFechaSeleccionada(e.target.value);
                        setPeriodo('customDay');
                    }}
                    className="border rounded-lg px-3 py-1.5 text-sm"
                />
              </div>
              <div className="flex items-center gap-2">
                <label htmlFor="mes-reporte" className="text-sm text-slate-600">Ver mes:</label>
                <input
                    type="month"
                    id="mes-reporte"
                    value={mesSeleccionado}
                    onChange={(e) => {
                        setMesSeleccionado(e.target.value);
                        setPeriodo('customMonth');
                    }}
                    className="border rounded-lg px-3 py-1.5 text-sm"
                />
              </div>
              <div className="flex-grow text-right">
                <button 
                  onClick={handleExportToPDF} 
                  className="px-4 py-2 text-sm rounded-lg bg-white border border-[#34745B] text-[#34745B] hover:bg-green-50 font-semibold"
                >
                  Descargar PDF
                </button>
              </div>
            </div>
            
            <div className="p-4 border rounded-xl bg-slate-50">
                <h3 className="text-lg font-semibold text-[#4A4A4A] mb-3">Resumen Financiero General</h3>
                <div className="grid md:grid-cols-3 gap-4">
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl"><p className="text-sm text-green-800">Total Ingresos</p><p className="text-2xl font-bold text-[#34745B]">{formatCurrency(totales.ingresos)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Total Gastos</p><p className="text-2xl font-bold text-slate-800">{formatCurrency(totales.gastos)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Balance Neto</p><p className={`text-2xl font-bold ${totales.balance >= 0 ? 'text-slate-800' : 'text-red-900'}`}>{formatCurrency(totales.balance)}</p></div>
                </div>
            </div>

            <div className="p-4 border rounded-xl bg-slate-50 mt-4">
                <div className="mb-3">
                    <h3 className="text-lg font-semibold text-[#4A4A4A]">Distribuci√≥n de Ingresos por Clases</h3>
                    <p className="text-sm text-slate-500">Resultados para: <span className="font-bold">{distribucionIngresos.nombreLugar}</span> (Reparto: {distribucionIngresos.repartoTexto})</p>
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl"><p className="text-sm text-green-800">Ganancia Neta Profesor</p><p className="text-2xl font-bold text-[#34745B]">{formatCurrency(distribucionIngresos.gananciaProfesor)}</p></div>
                  <div className="bg-slate-100 border border-slate-200 p-4 rounded-xl"><p className="text-sm text-slate-600">Ganancia Club</p><p className="text-2xl font-bold text-slate-800">{formatCurrency(distribucionIngresos.gananciaClub)}</p></div>
                </div>
                {!distribucionIngresos.hayReparto && <p className="text-xs text-slate-400 mt-2">En modo independiente, todos los ingresos de clases se consideran ganancia del profesor.</p>}
            </div>

            <div className="p-4 border rounded-xl bg-slate-50 mt-4">
                <h3 className="text-lg font-semibold text-[#4A4A4A]">Resumen de Clases Realizadas</h3>
                <p className="text-sm text-slate-500">Resultados para el per√≠odo seleccionado</p>
                {resumenClasesMes.totalClases > 0 ? (
                    <div className="mt-3">
                        <div className="flex items-center justify-between border-b pb-2 mb-2">
                            <div>
                                <p className="text-slate-600">Total de Clases</p>
                                <p className="text-3xl font-bold text-[#34745B]">{resumenClasesMes.totalClases}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-slate-600">Valor Generado por Clases</p>
                                <p className="text-3xl font-bold text-[#34745B]">{formatCurrency(resumenClasesMes.valorTotalGeneral)}</p>
                            </div>
                        </div>
                        <ul className="text-sm text-slate-700 mt-2 space-y-2">
                            {resumenClasesMes.detalle.map(([tipo, data]) => (
                                <li key={tipo} className="flex justify-between items-center bg-white p-2 rounded-md">
                                    <span>
                                        <strong>{data.cantidad}</strong> {data.cantidad > 1 ? 'clases' : 'clase'} de <strong>{labelSinClase(tipo)}</strong>
                                    </span>
                                    <span className="font-semibold text-slate-800">
                                        {formatCurrency(data.valorTotal)}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    </div>
                ) : (
                    <p className="text-sm text-slate-500 mt-4">No se encontraron clases realizadas en este per√≠odo.</p>
                )}
            </div>
          </Card>
        </div>
      );
    }
    // Pega esta nueva funci√≥n en tu archivo

function GestionClubes({ user }) {
  const [clubes, setClubes] = useState([]);
  const [activoId, setActivoId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [form, setForm] = useState({
    nombre: "",
    modalidadPrincipal: "por_clase",
    ubicaciones: [],
    reparto: { coach: 60, club: 40 },
    preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0 },
    preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0 },
    horarioLaboral: { bloques: [] }
  });

  const clubsCollection = useMemo(() => {
    if (!user) return null;
    return db.collection('users').doc(user.uid).collection('clubs');
  }, [user]);

  // Cargar clubes + seleccionar primero
  useEffect(() => {
    if (!clubsCollection) return;
    setLoading(true);
    const unsubscribe = clubsCollection.onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setClubes(data);
      if (!activoId && data.length) setActivoId(data[0].id);
      setLoading(false);
    });
    return () => unsubscribe();
  }, [clubsCollection]);

  // Cargar datos del club activo al form
  useEffect(() => {
    if (!activoId || !clubsCollection) return;
    const unsub = clubsCollection.doc(activoId).onSnapshot(doc => {
      const d = doc.data() || {};
      setForm({
        nombre: d.nombre || "",
        modalidadPrincipal: d.modalidadPrincipal || "por_clase",
        ubicaciones: d.ubicaciones || [],
        reparto: d.reparto || { coach: 60, club: 40 },
        preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0, ...(d.preciosClase||{}) },
        preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0, ...(d.preciosMensuales||{}) },
        horarioLaboral: d.horarioLaboral || { bloques: [] },
      });
    });
    return () => unsub();
  }, [activoId, clubsCollection]);

  async function crearClub() {
    if (!clubsCollection) return;
    const base = {
      nombre: "Nuevo Club",
      modalidadPrincipal: "por_clase",
      ubicaciones: [],
      reparto: { coach: 60, club: 40 },
      preciosClase: { individual: 0, dupla: 0, trio: 0, cuarteto: 0, escuelita: 0 },
      preciosMensuales: { "1xSemana": 0, "2xSemana": 0, "3xSemana": 0, "libre": 0 },
      horarioLaboral: { bloques: [] },
      createdAt: new Date().toISOString()
    };
    const ref = await clubsCollection.add(base);
    setActivoId(ref.id);
  }

  async function eliminarClub(id) {
    if (!clubsCollection || !id) return;
    if (!confirm("¬øEliminar este club? Esta acci√≥n no se puede deshacer.")) return;
    await clubsCollection.doc(id).delete();
    if (activoId === id) {
      const rest = clubes.filter(c => c.id !== id);
      setActivoId(rest[0]?.id || null);
    }
  }

  async function guardarClub() {
    if (!clubsCollection || !activoId) return;
    const pct = Number(form.reparto.coach||0) + Number(form.reparto.club||0);
    if (pct !== 100) {
      alert("El reparto debe sumar 100%");
      return;
    }
    await clubsCollection.doc(activoId).set({ ...form, updatedAt: new Date().toISOString() }, { merge: true });
    alert("Configuraci√≥n del club guardada");
  }

  // UI helpers
  const dias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
  const setField = (k, v) => setForm(f => ({ ...f, [k]: v }));
  function addUbicacion() { setField('ubicaciones', [...(form.ubicaciones||[]), ""]); }
  function updUbicacion(i, val) { const u=[...(form.ubicaciones||[])]; u[i]=val; setField('ubicaciones', u); }
  function delUbicacion(i) { const u=[...(form.ubicaciones||[])]; u.splice(i,1); setField('ubicaciones', u); }
  function addBloque() { setField('horarioLaboral', { bloques: [ ...(form.horarioLaboral?.bloques||[]), { dia:"Lunes", desde:"08:00", hasta:"12:00" } ]}); }
  function updBloque(i, patch) { const b=[...(form.horarioLaboral?.bloques||[])]; b[i]={...b[i], ...patch}; setField('horarioLaboral', { bloques: b }); }
  function delBloque(i) { const b=[...(form.horarioLaboral?.bloques||[])]; b.splice(i,1); setField('horarioLaboral', { bloques: b }); }

  if (loading) return <div className="text-sm opacity-70">Cargando clubes‚Ä¶</div>;

  return (
    <div className="space-y-6">
      {/* Selector + Acciones */}
      <div className="flex flex-wrap items-center gap-2">
        <select className="border rounded-xl px-3 py-2" value={activoId || ""} onChange={e=>setActivoId(e.target.value)}>
          {clubes.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}
        </select>
        <button className="px-3 py-2 rounded-xl border" onClick={crearClub}>Nuevo club</button>
        {activoId && <button className="px-3 py-2 rounded-xl border text-red-600" onClick={()=>eliminarClub(activoId)}>Eliminar</button>}
        <div className="grow" />
        <button className="px-3 py-2 rounded-xl bg-black text-white" onClick={guardarClub}>Guardar cambios</button>
      </div>

      {/* --- NUEVA ESTRUCTURA HORIZONTAL --- */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* Columna Izquierda de Configuraci√≥n */}
        <div className="space-y-4 p-4 border rounded-2xl bg-white">
          <h3 className="font-semibold">Configuraci√≥n General</h3>
          <label className="block text-sm">Nombre del Club</label>
          <input className="w-full border rounded-xl px-3 py-2" value={form.nombre} onChange={e=>setField('nombre', e.target.value)} />
          <label className="block text-sm mt-3">Modalidad de Cobro Principal</label>
          <select className="w-full border rounded-xl px-3 py-2" value={form.modalidadPrincipal} onChange={e=>setField('modalidadPrincipal', e.target.value)}>
            <option value="por_clase">Por Clase</option>
            <option value="mensual">Mensual</option>
          </select>
          <div className="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label className="block text-sm">Reparto % (Coach)</label>
              <input type="number" className="w-full border rounded-xl px-3 py-2" value={form.reparto.coach} onChange={e=>setField('reparto', { coach:Number(e.target.value)||0, club: Number(form.reparto.club||0) })} />
            </div>
            <div>
              <label className="block text-sm">Reparto % (Club)</label>
              <input type="number" className="w-full border rounded-xl px-3 py-2" value={form.reparto.club} onChange={e=>setField('reparto', { coach:Number(form.reparto.coach||0), club: Number(e.target.value)||0 })} />
            </div>
            <div className="col-span-2 text-xs opacity-70">Debe sumar 100%. Actual: {(Number(form.reparto.coach||0)+Number(form.reparto.club||0))}%</div>
          </div>
          <div className="mt-3">
            <label className="block text-sm">Canchas / Ubicaciones</label>
            <div className="space-y-2">
              {(form.ubicaciones||[]).map((u,i)=>(<div key={i} className="flex gap-2"><input className="flex-1 border rounded-xl px-3 py-2" value={u} onChange={e=>updUbicacion(i, e.target.value)} /><button className="px-3 py-2 rounded-xl border" onClick={()=>delUbicacion(i)}>Quitar</button></div>))}
            </div>
            <button className="mt-2 px-3 py-2 rounded-xl border" onClick={addUbicacion}>Agregar ubicaci√≥n</button>
          </div>
        </div>

        {/* Columna Derecha de Horarios */}
        <div className="space-y-4 p-4 border rounded-2xl bg-white">
          <h3 className="font-semibold">Horario Laboral (por club)</h3>
          <div className="space-y-2 max-h-80 overflow-y-auto pr-2">
            {(form.horarioLaboral?.bloques||[]).map((b,i)=>(
              <div key={i} className="grid grid-cols-4 gap-2 items-center">
                <select className="border rounded-xl px-3 py-2" value={b.dia} onChange={e=>updBloque(i,{dia:e.target.value})}>{dias.map(d=><option key={d} value={d}>{d}</option>)}</select>
                <input type="time" className="border rounded-xl px-3 py-2" value={b.desde} onChange={e=>updBloque(i,{desde:e.target.value})}/>
                <input type="time" className="border rounded-xl px-3 py-2" value={b.hasta} onChange={e=>updBloque(i,{hasta:e.target.value})}/>
                <button className="px-3 py-2 rounded-xl border" onClick={()=>delBloque(i)}>Quitar</button>
              </div>
            ))}
          </div>
          <button className="px-3 py-2 rounded-xl border" onClick={addBloque}>Agregar bloque</button>
        </div>
      </div>

      {/* --- SECCI√ìN DE PRECIOS A TODO LO ANCHO --- */}
      <div className="grid md:grid-cols-2 gap-6">
        <div className="p-4 border rounded-2xl space-y-3 bg-white">
          <h3 className="font-semibold">Precios por Clase</h3>
          {["individual","dupla","trio","cuarteto","escuelita"].map(k=>(<div key={k} className="grid grid-cols-2 gap-2 items-center"><div className="text-sm capitalize">{k}</div><input type="number" className="border rounded-xl px-3 py-2" value={form.preciosClase[k] ?? 0} onChange={e=>setField('preciosClase', { ...(form.preciosClase||{}), [k]: Number(e.target.value)||0 })} /></div>))}
        </div>
        <div className="p-4 border rounded-2xl space-y-3 bg-white">
          <h3 className="font-semibold">Precios Mensuales</h3>
          {[["1xSemana","1 vez por semana"],["2xSemana","2 veces por semana"],["3xSemana","3 veces por semana"],["libre","Libre"]].map(([key,label])=>(<div key={key} className="grid grid-cols-2 gap-2 items-center"><div className="text-sm">{label}</div><input type="number" className="border rounded-xl px-3 py-2" value={form.preciosMensuales[key] ?? 0} onChange={e=>setField('preciosMensuales', { ...(form.preciosMensuales||{}), [key]: Number(e.target.value)||0 })} /></div>))}
        </div>
      </div>
    </div>
  );
}
    
function Perfil({ perfil, alumnos, clases, pagos, gastos, grupos, onUpdate, user, setToast, getCollection, perfilCrud }) {
      const fileInputRef = React.useRef(null);
      const [form, setForm] = useState(perfil);
      const [pinInput, setPinInput] = useState({ newPin: "", confirmPin: "" });
      const [plantillas, setPlantillas] = useState([]);
      const [plantillaSeleccionada, setPlantillaSeleccionada] = useState(null);
      const [mensajePersonalizado, setMensajePersonalizado] = useState("");
      const [destinatarios, setDestinatarios] = useState([]);
      const [busquedaAlumno, setBusquedaAlumno] = useState("");
      const [listaBusquedaAbierta, setListaBusquedaAbierta] = useState(false);
      const [editingPlantilla, setEditingPlantilla] = useState(null);

      useEffect(() => {
        if (!user) return;
        const plantillasCollection = db.collection('users').doc(user.uid).collection('plantillas');
        const unsubscribe = plantillasCollection.onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPlantillas(data);
        });
        return () => unsubscribe();
      }, [user]);

      useEffect(() => {
        const defaultPerfil = initialState.perfil;
        setForm({
            ...defaultPerfil, ...perfil,
            datosBancarios: { ...defaultPerfil.datosBancarios, ...(perfil.datosBancarios || {}) },
            horarioLaboral: perfil.horarioLaboral || defaultPerfil.horarioLaboral,
            modoTrabajo: 'Club',
        });
      }, [perfil]);

      const handleSetPin = () => {
        if (pinInput.newPin.length !== 3 || !/^\d{3}$/.test(pinInput.newPin)) {
          alert("El PIN debe ser exactamente de 3 n√∫meros.");
          return;
        }
        if (pinInput.newPin !== pinInput.confirmPin) {
          alert("Los PINs no coinciden. Por favor, vuelve a intentarlo.");
          return;
        }
        setForm(prev => ({ ...prev, pin: pinInput.newPin }));
        setToast("PIN actualizado. No olvides guardar los cambios.");
        setPinInput({ newPin: "", confirmPin: "" });
      };

      const handlePinInputChange = (e) => {
        const { name, value } = e.target;
        if (/^\d*$/.test(value) && value.length <= 3) {
            setPinInput(prev => ({...prev, [name]: value}));
        }
      };

      const sanitizeDataForJSON = (data) => {
        const replacer = (key, value) => (value === undefined ? null : value);
        return JSON.parse(JSON.stringify(data, replacer));
      };
      
      const handleExportData = () => {
        try {
          let dataToExport = {
              alumnos: alumnos,
              clases: clases,
              pagos: pagos,
              gastos: gastos,
              perfil: perfil,
              grupos: grupos || []
          };
          const cleanData = sanitizeDataForJSON(dataToExport);
          const jsonString = JSON.stringify(cleanData, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `coachex_backup_${formatDate(new Date())}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          setToast("Datos exportados con √©xito.");
        } catch (error) {
          console.error("Error al exportar los datos:", error);
          setToast("Hubo un error al generar el archivo de respaldo.");
        }
      };
      
      const handleImportData = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                const confirmImport = window.confirm(
                    "¬°ATENCI√ìN! ¬øEst√°s seguro de que quieres importar estos datos?\n\n" + 
                    "TODOS TUS DATOS ACTUALES en el modo de trabajo seleccionado SER√ÅN BORRADOS Y REEMPLAZADOS.\n\n" +
                    "Esta acci√≥n no se puede deshacer."
                );
                if (confirmImport) {
                    setToast("Iniciando importaci√≥n... por favor espera.");
                    const collectionsToProcess = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos'];
                    for (const collectionName of collectionsToProcess) {
                        const collectionRef = getCollection(collectionName);
                        const snapshot = await collectionRef.get();
                        if (snapshot.docs.length > 0) {
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                        }
                    }
                    setToast("Datos anteriores eliminados, escribiendo nuevos datos...");
                    for (const collectionName of collectionsToProcess) {
                        if (importedData[collectionName] && importedData[collectionName].length > 0) {
                            const collectionRef = getCollection(collectionName);
                            const batch = db.batch();
                            importedData[collectionName].forEach(item => {
                                const docRef = item.id ? collectionRef.doc(item.id) : collectionRef.doc();
                                batch.set(docRef, item);
                            });
                            await batch.commit();
                        }
                    }
                    if (importedData.perfil) {
                        await perfilCrud.update(importedData.perfil);
                    }
                    setToast("¬°Importaci√≥n completada con √©xito! La p√°gina se recargar√°.");
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } catch (error) {
                alert("El archivo seleccionado no es un JSON v√°lido o est√° corrupto.");
                console.error("Error al importar datos:", error);
                setToast("Error durante la importaci√≥n.");
            } finally {
                event.target.value = null;
            }
        };
        reader.readAsText(file);
      };

      const handleWipeData = async () => {
        const confirmText = "BORRAR";
        const confirmation = prompt(`Esta acci√≥n es irreversible y borrar√° todos los alumnos, clases, pagos y gastos del modo de trabajo actual.\n\nPara confirmar, escribe "${confirmText}" en el campo de abajo.`);
        if (confirmation === confirmText) {
            setToast("Eliminando todos los datos... por favor espera.");
            try {
                const collectionsToWipe = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos'];
                for (const collectionName of collectionsToWipe) {
                    const collectionRef = getCollection(collectionName);
                    const snapshot = await collectionRef.get();
                    if (snapshot.docs.length > 0) {
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                        await batch.commit();
                    }
                }
                setToast("¬°Todos los datos han sido eliminados! La p√°gina se recargar√°.");
                setTimeout(() => { window.location.reload(); }, 2000);
            } catch (error) {
                console.error("Error al borrar los datos:", error);
                setToast("Hubo un error al eliminar los datos.");
            }
        } else {
            if (confirmation !== null) {
                alert("La confirmaci√≥n no es correcta. La acci√≥n ha sido cancelada.");
            }
        }
      };
      
      const alumnosFiltrados = useMemo(() => {
        if (!busquedaAlumno) return [];
        return (alumnos || []).filter(a => a.estado === 'activo' && getNombreCompleto(a).toLowerCase().includes(busquedaAlumno.toLowerCase()));
      }, [busquedaAlumno, alumnos]);

      const handleAgregarDestinatario = (alumno) => {
        if (!destinatarios.find(d => d.id === alumno.id)) {
          setDestinatarios([...destinatarios, alumno]);
        }
        setBusquedaAlumno("");
        setListaBusquedaAbierta(false);
      };
      const handleQuitarDestinatario = (alumnoId) => {
        setDestinatarios(destinatarios.filter(d => d.id !== alumnoId));
      };
      const handleSendMessage = (destinatario) => {
        if (!mensajePersonalizado.trim()) {
            alert("El mensaje no puede estar vac√≠o.");
            return;
        }
        const mensajeFinal = mensajePersonalizado.replace(/{nombre_alumno}/g, destinatario.nombre || '');
        const link = waLink(destinatario.telefono, mensajeFinal);
        if (link) {
            window.open(link, '_blank');
        } else {
            alert(`No se pudo generar el enlace para ${getNombreCompleto(destinatario)} porque no tiene un n√∫mero de tel√©fono v√°lido.`);
        }
      };
      const handleSavePlantilla = (plantillaData) => {
        const plantillasCollection = db.collection('users').doc(user.uid).collection('plantillas');
        if (plantillaData.id) {
          const { id, ...data } = plantillaData;
          plantillasCollection.doc(id).update(data).then(() => { setToast("Plantilla actualizada"); setEditingPlantilla(null); });
        } else {
          plantillasCollection.add(plantillaData).then(() => { setToast("Plantilla creada"); setEditingPlantilla(null); });
        }
      };
      const handleDeletePlantilla = () => {
        if (plantillaSeleccionada && window.confirm(`¬øEst√°s seguro de que quieres eliminar la plantilla "${plantillaSeleccionada.titulo}"?`)) {
            db.collection('users').doc(user.uid).collection('plantillas').doc(plantillaSeleccionada.id).delete().then(() => {
                setToast("Plantilla eliminada");
                setPlantillaSeleccionada(null);
                setMensajePersonalizado("");
            });
        }
      };
      const handleChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, [name]: value }));
      };
      const handlePrecioChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, precios: { ...prev.precios, [name]: value } }));
      };
      const handlePrecioMensualChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, preciosMensuales: { ...prev.preciosMensuales, [name]: value } }));
      };
      const handleDatosBancariosChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, datosBancarios: { ...prev.datosBancarios, [name]: value } }));
      };
      const handleHorarioChange = (index, campo, valor) => {
        setForm(prev => {
            const nuevoHorario = [...prev.horarioLaboral];
            nuevoHorario[index] = { ...nuevoHorario[index], [campo]: valor };
            return { ...prev, horarioLaboral: nuevoHorario };
        });
      };
      const handleCopyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(() => {
            setToast("¬°Copiado al portapapeles!");
        }, (err) => {
            setToast("Error al copiar");
            console.error('Error al copiar: ', err);
        });
      };
      const handleSubmit = (e) => {
        e.preventDefault();
        onUpdate(form);
      };
      const handlePasswordReset = () => {
        if(user && user.email) {
            auth.sendPasswordResetEmail(user.email)
                .then(() => setToast("Email para restablecer contrase√±a enviado."))
                .catch((error) => setToast(`Error: ${error.message}`));
        }
      };

      return (
        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
          <Card title={<span className="text-[#34745B]">Perfil y Configuraci√≥n</span>}>
              <h4 className="text-md font-semibold text-slate-700 mb-2">Datos Personales</h4>
              <div className="grid gap-3">
                <div><label className="text-sm text-slate-600">Nombre del Profesor</label><input name="nombre" value={form.nombre} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
                <div><label className="text-sm text-slate-600">Apellido</label><input name="apellido" value={form.apellido} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
                <div><label className="text-sm text-slate-600">Tel√©fono</label><input name="telefono" value={form.telefono} onChange={handleChange} className="w-full border rounded-lg px-3 py-2" /></div>
              </div>
              <div className="mt-6 border-t pt-6">
                <h4 className="text-md font-semibold text-slate-700 mb-2">Configuraci√≥n General</h4>
                <div>
                  <label className="text-sm text-slate-600">Modo de Trabajo Principal</label>
                  <select name="modoTrabajo" value={form.modoTrabajo} onChange={handleChange} className="w-full mt-1 border rounded-lg px-3 py-2">
                    <option value="Club">Solo Clubes</option>
                  </select>
                </div>
              </div>
              <div className="mt-6 border-t pt-6">
                  <h4 className="text-md font-semibold text-slate-700 mb-2">Cuenta</h4>
                  <div className="grid gap-3">
                    <div>
                      <label className="text-sm text-slate-600">Email de la cuenta</label>
                      <p className="w-full bg-slate-100 rounded-lg px-3 py-2 text-slate-700">{user?.email}</p>
                    </div>
                    <div><button type="button" onClick={handlePasswordReset} className="w-full px-4 py-2 rounded-lg border text-sm bg-slate-100 hover:bg-slate-200">Restablecer Contrase√±a</button></div>
                  </div>
              </div>
          </Card>
          
          <Card title={<span className="text-[#34745B]">Datos Bancarios para Transferencias</span>}>
              <div className="grid gap-4">
                  {['alias', 'cbu', 'banco', 'titular'].map(field => (
                      <div key={field}>
                          <label className="text-sm font-medium text-slate-600 capitalize">{field}</label>
                          <div className="flex gap-2 mt-1">
                              <input type="text" name={field} value={(form.datosBancarios || {})[field]} onChange={handleDatosBancariosChange} className="w-full border rounded-lg px-3 py-2" />
                              <button type="button" onClick={() => handleCopyToClipboard((form.datosBancarios || {})[field])} className="px-3 py-2 rounded-lg border text-sm hover:bg-slate-100">Copiar</button>
                          </div>
                      </div>
                  ))}
              </div>
          </Card>

          <div className="md:col-span-2">
            <Card title={<span className="text-[#34745B]">Centro de Comunicaciones</span>}>
                <div className="grid gap-4">
                    <div>
                        <label className="text-sm font-medium text-slate-600">1. Elige una plantilla o escribe un mensaje</label>
                        <div className="flex gap-2 mt-1">
                            <select className="w-full border rounded-lg px-3 py-2" value={plantillaSeleccionada ? plantillaSeleccionada.id : ""} onChange={(e) => { const p = plantillas.find(p => p.id === e.target.value); setPlantillaSeleccionada(p || null); setMensajePersonalizado(p ? p.texto : ""); }}>
                                <option value="">Seleccionar plantilla...</option>
                                {plantillas.map(p => (<option key={p.id} value={p.id}>{p.titulo}</option>))}
                            </select>
                            <button type="button" onClick={() => setEditingPlantilla({})} className="px-3 py-2 text-sm rounded-lg bg-[#34745B] hover:bg-green-800 text-white whitespace-nowrap">+ Nueva</button>
                            <button type="button" onClick={() => plantillaSeleccionada && setEditingPlantilla(plantillaSeleccionada)} disabled={!plantillaSeleccionada} className="px-3 py-2 text-sm rounded-lg border disabled:opacity-50">Editar</button>
                            <button type="button" onClick={handleDeletePlantilla} disabled={!plantillaSeleccionada} className="px-3 py-2 text-sm rounded-lg border text-red-600 disabled:opacity-50">Eliminar</button>
                        </div>
                        <textarea value={mensajePersonalizado} onChange={(e) => setMensajePersonalizado(e.target.value)} className="w-full mt-2 border rounded-lg px-3 py-2" rows={5} placeholder="O escribe un mensaje personalizado aqu√≠... Usa {nombre_alumno} para personalizar." />
                    </div>
                    <div className="relative">
                        <label className="text-sm font-medium text-slate-600">2. Selecciona los destinatarios</label>
                        <input type="text" value={busquedaAlumno} onChange={(e) => { setBusquedaAlumno(e.target.value); setListaBusquedaAbierta(true); }} onBlur={() => setTimeout(() => setListaBusquedaAbierta(false), 200)} placeholder="Escribe para buscar alumnos..." className="w-full mt-1 border rounded-lg px-3 py-2" />
                        {listaBusquedaAbierta && busquedaAlumno && (
                            <ul className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg">
                                {alumnosFiltrados.length > 0 ? alumnosFiltrados.map(a => (<li key={a.id} onMouseDown={() => handleAgregarDestinatario(a)} className="px-3 py-2 hover:bg-slate-100 cursor-pointer">{getNombreCompleto(a)}</li>)) : <li className="px-3 py-2 text-slate-500">No se encontraron alumnos.</li>}
                            </ul>
                        )}
                        <div className="mt-2">
                            <p className="text-xs font-semibold text-slate-500">Destinatarios ({destinatarios.length}):</p>
                            {destinatarios.length > 0 && (<div className="flex flex-wrap gap-2 mt-1 p-2 border rounded-lg bg-slate-50">{destinatarios.map(d => (<span key={d.id} className="flex items-center gap-2 bg-sky-100 text-sky-800 text-sm rounded-full px-2 py-1">{getNombreCompleto(d)}<button type="button" onClick={() => handleQuitarDestinatario(d.id)} className="w-4 h-4 rounded-full bg-sky-200 text-sky-800 flex items-center justify-center font-bold text-xs">x</button></span>))}</div>)}
                        </div>
                    </div>
                    <div>
                        <label className="text-sm font-medium text-slate-600">3. Env√≠a los mensajes</label>
                        <div className="mt-2 p-3 border rounded-lg bg-slate-50 space-y-2 max-h-48 overflow-y-auto">{destinatarios.length > 0 ? (destinatarios.map(destinatario => (<button key={destinatario.id} type="button" onClick={() => handleSendMessage(destinatario)} className="w-full flex justify-between items-center text-left px-3 py-2 text-sm rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors"><span>Enviar a: <strong>{getNombreCompleto(destinatario)}</strong></span><span role="img" aria-label="send">üí¨</span></button>))) : (<p className="text-xs text-slate-400">Selecciona al menos un destinatario para ver los botones de env√≠o.</p>)}</div>
                    </div>
                </div>
                <PlantillaModal isOpen={editingPlantilla !== null} plantilla={editingPlantilla?.id ? editingPlantilla : null} onCancel={() => setEditingPlantilla(null)} onSave={handleSavePlantilla} />
            </Card>
          </div>
          
          <div className="md:col-span-2">
            <Card title={<span className="text-[#34745B]">Mis Clubes</span>}>
                <GestionClubes user={user} />
            </Card>
          </div>

          <div className="md:col-span-2">
            <Card title={<span className="text-[#34745B]">Gesti√≥n de Datos</span>}>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button type="button" onClick={handleExportData} className="w-full px-4 py-2 rounded-lg border bg-[#34745B] hover:bg-green-800 text-white font-semibold">Exportar Datos (Backup)</button>
                    <button type="button" onClick={() => fileInputRef.current.click()} className="w-full px-4 py-2 rounded-lg border bg-slate-600 hover:bg-slate-700 text-white font-semibold">Importar Datos</button>
                    <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleImportData} />
                </div>
                <p className="text-xs text-slate-500 mt-3"><strong>Atenci√≥n:</strong> La importaci√≥n de datos reemplazar√° toda la informaci√≥n existente en el modo de trabajo que tengas seleccionado.</p>
            </Card>
          </div>
          
          <div className="md:col-span-2">
            <Card title={<span className="text-[#34745B]">Seguridad y PIN</span>}>
                <div className="space-y-4">
                    <div>
                        <label className="text-sm text-slate-600 block mb-1">
                            {form.pin ? "Cambiar PIN de seguridad (3 d√≠gitos)" : "Crear PIN de seguridad (3 d√≠gitos)"}
                        </label>
                        <p className="text-xs text-slate-500 mb-2">
                            Este PIN se solicitar√° para acciones cr√≠ticas.
                        </p>
                        <div className="grid grid-cols-2 gap-3">
                            <input type="password" name="newPin" value={pinInput.newPin} onChange={handlePinInputChange} placeholder="Nuevo PIN" maxLength="3" className="w-full border rounded-lg px-3 py-2 text-center" />
                            <input type="password" name="confirmPin" value={pinInput.confirmPin} onChange={handlePinInputChange} placeholder="Confirmar PIN" maxLength="3" className="w-full border rounded-lg px-3 py-2 text-center" />
                        </div>
                    </div>
                    <button type="button" onClick={handleSetPin} className="w-full px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-semibold">
                        {form.pin ? "Actualizar PIN" : "Establecer PIN"}
                    </button>
                </div>
            </Card>
          </div>

          <div className="md:col-span-2">
                <div className="p-4 border-2 border-red-300 bg-red-50 rounded-2xl">
                    <h3 className="text-base font-semibold text-red-800">Zona de Peligro</h3>
                    <p className="text-sm text-red-700 mt-2 mb-3">
                        La siguiente acci√≥n es permanente y no se puede deshacer.
                    </p>
                    <button type="button" onClick={handleWipeData} className="w-full px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">
                        Borrar Todos los Datos de este Modo de Trabajo
                    </button>
                </div>
            </div>

          <div className="md:col-span-2 flex justify-end">
             <button type="submit" className="px-6 py-3 rounded-xl bg-[#34745B] hover:bg-green-800 text-white font-semibold">Guardar Todos los Cambios</button>
          </div>
        </form>
      );
    }
    // Reemplaza tu PagoGrupalModal completo con este c√≥digo
function PagoGrupalModal({ isOpen, clase, alumnos, onCancel, onSave, focusAlumnoId }) {
  const [pagos, setPagos] = useState({});
  const alumnosDeClase = clase ? (clase.alumnoIds || []).map(id => (alumnos || []).find(a => a.id === id)).filter(Boolean) : [];
  
  // Si nos pasan un focusAlumnoId, solo mostramos a ese alumno. Si no, a todos.
  const visibles = focusAlumnoId ? alumnosDeClase.filter(a => a.id === focusAlumnoId) : alumnosDeClase;

  useEffect(() => {
    if (clase) {
      const precioPorAlumno = (clase.alumnoIds?.length || 1) > 0 ? (parseFloat(clase.precio || 0) / (clase.alumnoIds?.length || 1)) : 0;
      const initialState = {};
      alumnosDeClase.forEach(alumno => {
        initialState[alumno.id] = {
          monto: alumno.plan === 'mensual' ? '0' : precioPorAlumno.toFixed(2),
          metodo: alumno.plan === 'mensual' ? "Mensual" : 'Efectivo',
          mixtoEfectivo: "",
          mixtoTransferencia: ""
        };
      });
      setPagos(initialState);
    }
  }, [clase, alumnos]);

  if (!isOpen || !clase) return null;

  const handlePaymentChange = (alumnoId, field, value) => {
    setPagos(prev => ({ ...prev, [alumnoId]: { ...prev[alumnoId], [field]: value } }));
  };
  
  const handleMixtoChange = (alumnoId, efectivo, transferencia) => {
      const ef = parseFloat(efectivo) || 0;
      const tx = parseFloat(transferencia) || 0;
      setPagos(prev => ({...prev, [alumnoId]: {...prev[alumnoId], mixtoEfectivo: efectivo, mixtoTransferencia: transferencia, monto: (ef + tx).toFixed(2)}}));
  }

  const handleSave = () => {
    const pagosAGuardar = Object.entries(pagos).map(([alumnoId, data]) => {
      // Solo incluimos en el guardado a los alumnos que estamos viendo
      if (visibles.some(a => a.id === alumnoId)) {
        const registro = { alumnoId, ...data };
        if (data.metodo === "Mixto") {
          registro.monto = (parseFloat(data.mixtoEfectivo || 0) + parseFloat(data.mixtoTransferencia || 0)).toFixed(2);
        }
        return registro;
      }
      return null;
    }).filter(Boolean); // Limpiamos los nulos
    onSave(pagosAGuardar);
  };

  // T√≠tulo din√°mico para mayor claridad
  const modalTitle = focusAlumnoId ? `Pagar Clase Espec√≠fica` : `Registrar Pagos de Clase`;

  return (
    <Modal isOpen={isOpen} title={modalTitle} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pagos">
      <div className="grid gap-4">
        <p className="text-sm text-center border-b pb-2">Clase de {clase.tipo} del {clase.fecha} a las {clase.hora}. Precio total: ${clase.precio}</p>
        <div className="space-y-4 max-h-64 overflow-y-auto pr-2">
          {visibles.map(alumno => (
            <div key={alumno.id} className="p-3 border rounded-lg bg-slate-50">
              <p className="font-semibold">{getNombreCompleto(alumno)}</p>
              {alumno.plan === 'mensual' ? (
                <p className="text-sm text-emerald-700 mt-2">‚úÖ Cubierto por Plan Mensual</p>
              ) : (
                <div className="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <label className="text-xs text-slate-600">Monto</label>
                    <input type="number" value={pagos[alumno.id]?.monto || ''} onChange={(e) => handlePaymentChange(alumno.id, 'monto', e.target.value)} disabled={pagos[alumno.id]?.metodo === 'Mixto'} className="w-full border rounded-lg px-2 py-1 disabled:bg-slate-200" />
                  </div>
                  <div>
                    <label className="text-xs text-slate-600">M√©todo</label>
                    <select value={pagos[alumno.id]?.metodo || 'Pendiente'} onChange={(e) => handlePaymentChange(alumno.id, 'metodo', e.target.value)} className="w-full border rounded-lg px-2 py-1">
                      {METODOS_PAGO.filter(m => m !== 'Mensual').map(m => <option key={m}>{m}</option>)}
                    </select>
                  </div>
                  {/* AQU√ç EST√Å LA L√ìGICA CORREGIDA PARA EL PAGO MIXTO */}
                  {pagos[alumno.id]?.metodo === 'Mixto' && (
                    <div className="col-span-2 grid grid-cols-2 gap-2 mt-2 pt-2 border-t">
                       <div>
                         <label className="text-xs text-slate-600">Efectivo</label>
                         <input type="number" value={pagos[alumno.id]?.mixtoEfectivo || ""} onChange={(e) => handleMixtoChange(alumno.id, e.target.value, pagos[alumno.id]?.mixtoTransferencia)} className="w-full rounded-lg px-2 py-1 border" />
                       </div>
                       <div>
                         <label className="text-xs text-slate-600">Transferencia</label>
                         <input type="number" value={pagos[alumno.id]?.mixtoTransferencia || ""} onChange={(e) => handleMixtoChange(alumno.id, pagos[alumno.id]?.mixtoEfectivo, e.target.value)} className="w-full rounded-lg px-2 py-1 border" />
                       </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    </Modal>
  );
}
// Pega esta nueva funci√≥n en tu archivo
function RegistroPagoMensualModal({ isOpen, alumno, perfil, onCancel, onSave }) {
  const [form, setForm] = useState({
    monto: "",
    metodo: "Transferencia",
    mes: new Date().getMonth(),
    fechaPago: formatDate(new Date())
  });

  useEffect(() => {
    // Cuando se abre el modal, calcula el monto sugerido del plan del alumno
    if (alumno && perfil.preciosMensuales) {
      const montoPredefinido = perfil.preciosMensuales[alumno.frecuencia] || "";
      setForm(prev => ({ ...prev, monto: montoPredefinido }));
    }
  }, [isOpen, alumno, perfil]);

  if (!isOpen || !alumno) return null;

  const handleSave = () => {
    if (!form.monto || parseFloat(form.monto) <= 0) {
      alert("Por favor, ingresa un monto v√°lido.");
      return;
    }
    onSave(form);
  };

  return (
    <Modal isOpen={isOpen} title={`Registrar Abono: ${getNombreCompleto(alumno)}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pago">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">Mes Correspondiente</label>
          <select 
            value={form.mes} 
            onChange={(e) => setForm({...form, mes: parseInt(e.target.value)})}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            {MESES_NOMBRES.map((nombre, index) => <option key={index} value={index}>{nombre}</option>)}
          </select>
        </div>
        <div>
          <label className="text-sm text-slate-600">Monto Pagado</label>
          <input 
            type="number" 
            value={form.monto} 
            onChange={(e) => setForm({...form, monto: e.target.value})} 
            className="w-full border rounded-lg px-3 py-2 mt-1" 
            placeholder="0.00" 
          />
        </div>
        <div>
          <label className="text-sm text-slate-600">M√©todo de Pago</label>
          <select 
            value={form.metodo} 
            onChange={(e) => setForm({...form, metodo: e.target.value})}
            className="w-full border rounded-lg px-3 py-2 mt-1"
          >
            {METODOS_PAGO.filter(m => m !== 'Pendiente').map(m => <option key={m}>{m}</option>)}
          </select>
        </div>
        <div>
          <label className="text-sm text-slate-600">Fecha de Pago</label>
          <input 
            type="date" 
            value={form.fechaPago} 
            onChange={(e) => setForm({...form, fechaPago: e.target.value})} 
            className="w-full border rounded-lg px-3 py-2 mt-1" 
          />
        </div>
      </div>
    </Modal>
  );
}
    function PagoMensualModal({ isOpen, alumno, mes, onCancel, onSave }) {
      const [form, setForm] = useState({ monto: "", metodo: "Efectivo" });
      useEffect(() => {
        if (alumno) {
          const restante = alumno.cuota - alumno.totalPagado;
          setForm({ monto: restante > 0 ? restante.toFixed(2) : "", metodo: "Efectivo" });
        }
      }, [alumno]);
      if (!isOpen || !alumno) return null;
      const handleSave = () => { onSave({ ...form, monto: form.monto || "0" }); };
      return (
        <Modal isOpen={isOpen} title={`Pago Cuota: ${alumno.nombre}`} onCancel={onCancel} onConfirm={handleSave} confirmText="Guardar Pago">
          <div className="grid gap-4">
            <p>Cuota de {MESES_NOMBRES[mes]} por ${alumno.cuota.toFixed(2)}. Pagado: ${alumno.totalPagado.toFixed(2)}.</p>
            <div><label className="text-sm text-slate-600">Monto a Pagar</label><input type="number" value={form.monto} onChange={(e) => setForm({...form, monto: e.target.value})} className="w-full border rounded-lg px-3 py-2" placeholder="0.00" /></div>
            <div><label className="text-sm text-slate-600">M√©todo de Pago</label><select value={form.metodo} onChange={(e) => setForm({...form, metodo: e.target.value})} className="w-full border rounded-lg px-3 py-2">{METODOS_PAGO.filter(m => m !== 'Pendiente').map(m => <option key={m}>{m}</option>)}</select></div>
          </div>
        </Modal>
      );
    }
    // Pega este nuevo componente en tu archivo
function EditarPagoModal({ isOpen, pago, onCancel, onSave }) {
  const [form, setForm] = useState(null);

  useEffect(() => {
    // Cuando se abre el modal, inicializamos el form con todos los campos necesarios
    if (pago) {
      setForm({
        ...pago,
        concepto: pago.concepto || "Pago General",
        mixtoEfectivo: pago.detalleMixto?.efectivo?.toString() || "",
        mixtoTransferencia: pago.detalleMixto?.transferencia?.toString() || ""
      });
    }
  }, [pago]);

  if (!isOpen || !form) return null;

  const handleChange = (e) => {
    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  };
  
  const handleMixtoChange = (efectivo, transferencia) => {
      const ef = parseFloat(efectivo) || 0;
      const tx = parseFloat(transferencia) || 0;
      setForm(prev => ({...prev, mixtoEfectivo: efectivo, mixtoTransferencia: transferencia, monto: (ef + tx).toFixed(2)}));
  }

  return (
    <Modal isOpen={isOpen} title={`Editar Pago`} onCancel={onCancel} onConfirm={() => onSave(form)} confirmText="Guardar Cambios">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">Concepto</label>
          <input type="text" name="concepto" value={form.concepto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" />
        </div>
        <div>
          <label className="text-sm text-slate-600">Monto Pagado</label>
          <input type="number" name="monto" value={form.monto} onChange={handleChange} disabled={form.metodo === 'Mixto'} className="w-full border rounded-lg px-3 py-2 mt-1 disabled:bg-slate-100" />
        </div>
        <div>
          <label className="text-sm text-slate-600">M√©todo de Pago</label>
          <select name="metodo" value={form.metodo} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1">
            {METODOS_PAGO.filter(m => m !== 'Pendiente' && m !== 'Mensual').map(m => <option key={m}>{m}</option>)}
          </select>
        </div>
        
        {/* L√≥gica corregida para el pago mixto */}
        {form.metodo === 'Mixto' && (
          <div className="p-3 border rounded-lg grid grid-cols-2 gap-3 bg-slate-50">
            <div>
              <label className="text-xs text-slate-600">Efectivo</label>
              <input type="number" value={form.mixtoEfectivo} onChange={(e) => handleMixtoChange(e.target.value, form.mixtoTransferencia)} className="w-full border rounded-lg px-2 py-1 mt-1" />
            </div>
            <div>
              <label className="text-xs text-slate-600">Transferencia</label>
              <input type="number" value={form.mixtoTransferencia} onChange={(e) => handleMixtoChange(form.mixtoEfectivo, e.target.value)} className="w-full border rounded-lg px-2 py-1 mt-1" />
            </div>
          </div>
        )}

        <div>
          <label className="text-sm text-slate-600">Fecha de Pago</label>
          <input type="date" name="fecha" value={form.fecha} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" />
        </div>
      </div>
    </Modal>
  );
}
function PlantillaModal({ isOpen, plantilla, onCancel, onSave }) {
  const [form, setForm] = useState({ titulo: '', texto: '' });

  useEffect(() => {
    // Si pasamos una plantilla, es para editar. Si no, es para crear una nueva.
    if (plantilla) {
      setForm(plantilla);
    } else {
      setForm({ titulo: '', texto: '' });
    }
  }, [plantilla]);

  if (!isOpen) return null;

  const handleChange = (e) => {
    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  };

  return (
    <Modal isOpen={isOpen} title={form.id ? "Editar Plantilla" : "Nueva Plantilla"} onCancel={onCancel} onConfirm={() => onSave(form)} confirmText="Guardar">
      <div className="grid gap-4">
        <div>
          <label className="text-sm text-slate-600">T√≠tulo de la Plantilla</label>
          <input type="text" name="titulo" value={form.titulo} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Ej: Recordatorio de Clase" />
        </div>
        <div>
          <label className="text-sm text-slate-600">Texto del Mensaje</label>
          <textarea name="texto" value={form.texto} onChange={handleChange} className="w-full border rounded-lg px-3 py-2 mt-1" rows={6} placeholder="Escribe tu mensaje aqu√≠. Usa {nombre_alumno} para personalizarlo."></textarea>
        </div>
      </div>
    </Modal>
  );
}
    
    function LoginScreen() {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [message, setMessage] = useState('');
        const [view, setView] = useState('login');
        const [loading, setLoading] = useState(false);

        
        // Evitar updates en componente desmontado
        const mountedRef = React.useRef(true);
        useEffect(() => () => { mountedRef.current = false; }, []);
const handleAuthAction = async (e) => {
            e.preventDefault();
            mountedRef.current && setLoading(true);
            mountedRef.current && setError('');
            mountedRef.current && setMessage('');
            try {
                if (view === 'register') {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).collection('profile').doc('main').set(initialState.perfil);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        const handlePasswordReset = async (e) => {
            e.preventDefault();
            mountedRef.current && setLoading(true);
            mountedRef.current && setError('');
            mountedRef.current && setMessage('');
            try {
                await auth.sendPasswordResetEmail(email);
                mountedRef.current && setMessage('Se envi√≥ un correo para restablecer tu contrase√±a.');
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
  <div className="w-full max-w-sm mx-auto">
    {/* encabezado: logo arriba + texto debajo, alineado a la izquierda */}
    <div className="flex flex-col items-start mb-8">
      <img
        src="./logo_coachex_N.png"   // si el archivo no est√° en /img, usa "./logo_coachex_N.png"
        alt="Coachex"
        className="h-9 w-auto"
        onError={(e) => {
          e.currentTarget.onerror = null;
          e.currentTarget.src = "./logo_coachex_N.png"; // fallback si luego lo mov√©s a la ra√≠z
        }}
      />
      <p className="text-slate-500 text-lg mt-2">Gestiona tus clases</p>
    </div>

    <div className="bg-white rounded-2xl shadow-lg p-8">
                        {view === 'login' && (
                            <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Iniciar Sesi√≥n</h2>
                                <form onSubmit={handleAuthAction} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    <div><label className="text-sm font-medium text-slate-600">Contrase√±a</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-2 rounded-lg font-semibold hover:bg-slate-800 transition disabled:bg-slate-400">{loading ? 'Cargando...' : 'Ingresar'}</button>
                                </form>
                                <div className="text-center mt-4"><button onClick={() => setView('reset')} className="text-sm text-blue-600 hover:underline">¬øOlvidaste tu contrase√±a?</button></div>
                                <div className="text-center mt-2"><button onClick={() => setView('register')} className="text-sm text-slate-600 hover:underline">¬øNo ten√©s cuenta? Registrate</button></div>
                            </div>
                        )}
                        {view === 'register' && (
                             <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Crear Cuenta</h2>
                                <form onSubmit={handleAuthAction} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    <div><label className="text-sm font-medium text-slate-600">Contrase√±a</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-2 rounded-lg font-semibold hover:bg-slate-800 transition disabled:bg-slate-400">{loading ? 'Cargando...' : 'Registrarse'}</button>
                                </form>
                                <div className="text-center mt-4"><button onClick={() => setView('login')} className="text-sm text-slate-600 hover:underline">¬øYa ten√©s cuenta? Ingres√°</button></div>
                            </div>
                        )}
                        {view === 'reset' && (
                             <div>
                                <h2 className="text-2xl font-bold text-center text-slate-800 mb-6">Restablecer Contrase√±a</h2>
                                <form onSubmit={handlePasswordReset} className="space-y-4">
                                    <div><label className="text-sm font-medium text-slate-600">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full mt-1 border rounded-lg px-3 py-2" required /></div>
                                    {error && <p className="text-sm text-red-600">{error}</p>}
                                    {message && <p className="text-sm text-green-600">{message}</p>}
                                    <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-2 rounded-lg font-semibold hover:bg-slate-800 transition disabled:bg-slate-400">{loading ? 'Enviando...' : 'Enviar correo'}</button>
                                </form>
                                <div className="text-center mt-4"><button onClick={() => setView('login')} className="text-sm text-slate-600 hover:underline">Volver a Iniciar Sesi√≥n</button></div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

function OnboardingClubSetup({ user, setHasClubs, onLogout }) {
  // Mostrar d√≠as completos pero manejar c√≥digo corto internamente
  const DIAS = [
    { label: "Lunes",     code: "Lu" },
    { label: "Martes",    code: "Ma" },
    { label: "Mi√©rcoles", code: "Mi" },
    { label: "Jueves",    code: "Ju" },
    { label: "Viernes",   code: "Vi" },
    { label: "S√°bado",    code: "Sa" },
    { label: "Domingo",   code: "Do" },
  ];
  const getLabelByCode = (code) => DIAS.find(d => d.code === code)?.label || code;

  // ---- State
  const [nombre, setNombre] = React.useState("");
  const [modalidad, setModalidad] = React.useState("Por Clase");
  const [repProfesor, setRepProfesor] = React.useState(60); // edit√°s este
  const repClub = Math.max(0, Math.min(100, 100 - Number(repProfesor || 0))); // se calcula solo

  const [horario, setHorario] = React.useState([
    { id: cryptoRandomId(), diaCode: "Lu", desde: "08:00", hasta: "12:00" },
  ]);

  const [preciosClase, setPreciosClase] = React.useState({ p1: 0, p2: 0, p3: 0, p4: 0, escuelita: 0 });
  const [preciosMensual, setPreciosMensual] = React.useState({ x1: 0, x2: 0, x3: 0, libre: 0 });

  // ---- Validaci√≥n
  const profesorValid = Number.isFinite(Number(repProfesor)) && Number(repProfesor) >= 0 && Number(repProfesor) <= 100;
  const invalidIds = horario.filter(b => !isBlockValid(b)).map(b => b.id);
  const horariosValidos = invalidIds.length === 0;
  const canSave = user && nombre.trim().length > 0 && profesorValid && horariosValidos;

  // ---- Helpers
  function cryptoRandomId() { return Math.random().toString(36).slice(2, 10); }
  function toMinutes(hhmm) { if (!hhmm || typeof hhmm !== "string") return NaN; const [h, m] = hhmm.split(":").map(Number); return h * 60 + (m || 0); }
  function isBlockValid(b) { const d = toMinutes(b.desde); const h = toMinutes(b.hasta); return Number.isFinite(d) && Number.isFinite(h) && d < h; }

  const addBloque    = () => setHorario(h => [...h, { id: cryptoRandomId(), diaCode: "Lu", desde: "08:00", hasta: "12:00" }]);
  const removeBloque = (id) => setHorario(h => h.filter(b => b.id !== id));
  const updateBloque = (id, patch) => setHorario(h => h.map(b => b.id === id ? { ...b, ...patch } : b));

  const onChangeMoney = (objSetter) => (key) => (e) => {
    const raw = (e.target.value || "").replace(",", ".");
    const n = raw === "" ? "" : Number(raw);
    objSetter(prev => ({ ...prev, [key]: isNaN(n) ? 0 : n }));
  };

  const guardar = async () => {
    try {
      const ref = db.collection("users").doc(user.uid).collection("clubs").doc();
      const doc = {
        nombre,
        modalidadCobroPrincipal: modalidad,
        reparto: { profesor: Number(repProfesor)||0, club: repClub },
        // Guardamos tanto el code como el label para facilitar lecturas futuras
        horarioLaboral: horario.map(b => ({
          diaCode: b.diaCode,
          diaLabel: getLabelByCode(b.diaCode),
          desde: b.desde,
          hasta: b.hasta
        })),
        precios: {
          porClase: {
            "1": Number(preciosClase.p1)||0,
            "2": Number(preciosClase.p2)||0,
            "3": Number(preciosClase.p3)||0,
            "4": Number(preciosClase.p4)||0,
            escuelita: Number(preciosClase.escuelita)||0
          },
          mensuales: {
            x1: Number(preciosMensual.x1)||0,
            x2: Number(preciosMensual?.x2 ?? preciosMensual.x2)||0,
            x3: Number(preciosMensual.x3)||0,
            libre: Number(preciosMensual.libre)||0
          }
        },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await ref.set(doc);
      setHasClubs(true);
    } catch (err) {
      console.error("Error guardando club:", err);
      alert("No se pudo guardar. Revis√° la consola para m√°s detalles.");
    }
  };

  // ---- UI
  return (
    <div className="max-w-5xl mx-auto px-4">
      {/* Header */}
      <div className="pt-8 pb-6 text-center">
        <img
          src="./assets/img/img/logo_coachex_N.png"
          alt="Coachex-Pro Logo"
          className="h-10 mx-auto object-contain opacity-90"
          onError={(e)=>{ e.currentTarget.style.display='none'; }}
        />
        <h1 className="mt-2 text-3xl font-bold text-slate-800">Bienvenido a Coachex-Pro</h1>
        <p className="mt-2 text-slate-600 max-w-xl mx-auto">
          Gesti√≥n integral para profesores de tenis y padel.
        </p>
        <p className="text-slate-600">Carg√° la informaci√≥n del Club en donde trabaj√°s.</p>
      </div>

      {/* Cards */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* Configuraci√≥n General */}
        <SetupCard title="Configuraci√≥n General">
          <SetupLabel>Nombre del Club</SetupLabel>
          <SetupInput value={nombre} onChange={e=>setNombre(e.target.value)} placeholder="Ej: Club Mad" />

          <SetupLabel className="mt-4">Modalidad de Cobro Principal</SetupLabel>
          <SetupSelect value={modalidad} onChange={e=>setModalidad(e.target.value)}>
            <option>Por Clase</option>
            <option>Mensual</option>
          </SetupSelect>

          <div className="grid grid-cols-2 gap-3 mt-4">
            <SetupPercentField
              label="Reparto % (Profesor)"
              value={repProfesor}
              onChange={e => {
                const v = Math.max(0, Math.min(100, Number(e.target.value || 0)));
                setRepProfesor(v);
              }}
            />
            <SetupPercentField
              label="Reparto % (Club)"
              value={repClub}
              readOnly
              tooltip="Se calcula autom√°ticamente como 100% - Profesor"
            />
          </div>
          {!profesorValid && (
            <p className="mt-2 text-xs text-red-600">El % del profesor debe estar entre 0 y 100.</p>
          )}
        </SetupCard>

        {/* Horario Laboral */}
        <SetupCard title="Horario Laboral">
          <div className="space-y-3">
            {horario.map(b => {
              const invalid = !isBlockValid(b);
              return (
                <div key={b.id}>
                  <div className="flex flex-wrap items-center gap-2">
                    <SetupSelect
                      value={b.diaCode}
                      onChange={e=>updateBloque(b.id, { diaCode: e.target.value })}
                      className="w-40"
                    >
                      {DIAS.map(d => (
                        <option key={d.code} value={d.code}>{d.label}</option>
                      ))}
                    </SetupSelect>

                    <SetupTimeField
                      value={b.desde}
                      onChange={e=>updateBloque(b.id, { desde: e.target.value })}
                      invalid={invalid}
                      aria-label="Desde"
                    />
                    <span className="text-slate-400 select-none">‚Äî</span>
                    <SetupTimeField
                      value={b.hasta}
                      onChange={e=>updateBloque(b.id, { hasta: e.target.value })}
                      invalid={invalid}
                      aria-label="Hasta"
                    />

                    <button
                      className="inline-flex items-center gap-1 rounded-full border border-red-200 text-red-600 px-3 py-1.5 text-sm hover:bg-red-50"
                      onClick={()=>removeBloque(b.id)}
                    >
                      Quitar
                    </button>
                  </div>
                  {invalid && (
                    <p className="mt-1 text-xs text-red-600">
                      El horario no es v√°lido. <span className="font-medium">‚ÄúDesde‚Äù</span> debe ser menor que <span className="font-medium">‚ÄúHasta‚Äù</span>.
                    </p>
                  )}
                </div>
              );
            })}
          </div>

          <button onClick={addBloque}
                  className="mt-3 w-full border-2 border-dashed rounded-xl py-2 text-slate-500 hover:bg-slate-50">
            + Agregar bloque
          </button>

          {!horariosValidos && (
            <p className="mt-2 text-xs text-red-600">Revis√° los bloques en rojo antes de continuar.</p>
          )}
        </SetupCard>

        {/* Precios por Clase */}
        <SetupCard title="Precios por Clase">
          <div className="space-y-3">
            <SetupMoneyField label="Clase para 1 persona" value={preciosClase.p1} onChange={onChangeMoney(setPreciosClase)("p1")} />
            <SetupMoneyField label="Clase para 2 personas" value={preciosClase.p2} onChange={onChangeMoney(setPreciosClase)("p2")} />
            <SetupMoneyField label="Clase para 3 personas" value={preciosClase.p3} onChange={onChangeMoney(setPreciosClase)("p3")} />
            <SetupMoneyField label="Clase para 4 personas" value={preciosClase.p4} onChange={onChangeMoney(setPreciosClase)("p4")} />
            <SetupMoneyField label="Escuelita" value={preciosClase.escuelita} onChange={onChangeMoney(setPreciosClase)("escuelita")} />
          </div>
        </SetupCard>

        {/* Precios Mensuales */}
        <SetupCard title="Precios Mensuales">
          <div className="space-y-3">
            <SetupMoneyField label="1 vez por semana" value={preciosMensual.x1} onChange={onChangeMoney(setPreciosMensual)("x1")} />
            <SetupMoneyField label="2 veces por semana" value={preciosMensual.x2} onChange={onChangeMoney(setPreciosMensual)("x2")} />
            <SetupMoneyField label="3 veces por semana" value={preciosMensual.x3} onChange={onChangeMoney(setPreciosMensual)("x3")} />
            <SetupMoneyField label="Libre" value={preciosMensual.libre} onChange={onChangeMoney(setPreciosMensual)("libre")} />
          </div>
        </SetupCard>
      </div>

      {/* CTA */}
      <div className="mt-8 text-center">
        <button
          className="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-6 py-3 text-white font-semibold shadow hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled={!canSave}
          onClick={guardar}
        >
          Guardar y Comenzar
        </button>
        {!canSave && (
          <p className="text-xs text-slate-500 mt-2">
            Complet√° el nombre del club, un % de profesor v√°lido y correg√≠ los horarios en rojo.
          </p>
        )}
      </div>
      <div className="mt-4 text-center">
  <button
    onClick={onLogout}
    className="inline-flex items-center justify-center rounded-xl border border-slate-300 px-6 py-2 text-slate-600 hover:bg-slate-100"
  >
    Volver al inicio de sesi√≥n
  </button>
</div>
    </div>
  );
}

/* ---------- UI helpers (prefijo Setup para evitar conflictos) ---------- */

const SetupCard = ({ title, children }) => (
  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
    <h3 className="text-lg font-semibold text-emerald-700 mb-3">{title}</h3>
    {children}
  </div>
);

const SetupLabel = ({ children, className="" }) => (
  <label className={`block text-sm text-slate-600 mb-1 ${className}`}>{children}</label>
);

const SetupInput = (props) => (
  <input
    {...props}
    className={`w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-800 shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-300 ${props.className||""}`}
  />
);

const SetupSelect = (props) => (
  <select
    {...props}
    className={`w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-300 ${props.className||""}`}
  />
);

const SetupPercentField = ({ label, value, onChange, readOnly=false, tooltip }) => (
  <div>
    <SetupLabel>{label}</SetupLabel>
    <div className="relative">
      <SetupInput value={value} onChange={onChange} inputMode="numeric" className="pr-12" readOnly={readOnly} title={tooltip}/>
      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500">%</span>
    </div>
  </div>
);

const SetupMoneyField = ({ label, value, onChange }) => (
  <div>
    <SetupLabel>{label}</SetupLabel>
    <div className="relative">
      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm">ARS $</span>
      <SetupInput value={value} onChange={onChange} inputMode="decimal" placeholder="0" className="pl-16" />
    </div>
  </div>
);

const SetupTimeField = ({ value, onChange, invalid=false, ...rest }) => (
  <div className="relative">
    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 select-none">üïë</span>
    <input
      type="time"
      value={value}
      onChange={onChange}
      {...rest}
      className={[
        "w-[130px] rounded-xl border bg-white pl-8 pr-2 py-2 text-slate-800 focus:outline-none",
        invalid ? "border-red-300 focus:ring-2 focus:ring-red-300" : "border-slate-200 focus:ring-2 focus:ring-emerald-300"
      ].join(" ")}
    />
  </div>
);

    
function MainApp({ user, onLogout }) {
  const [current, setCurrent] = useState("dashboard");
  const [prefillClase, setPrefillClase] = useState(null);

  const [state, setState] = useState({ alumnos: [], clases: [], pagos: [], gastos: [], perfil: {} });
  // Crear una clase desde un grupo (prefill en Clases y navegar)
  const crearClaseDesdeGrupo = ({ fecha, hora, alumnoIds, grupo }) => {
    setCurrent('clases');
    setPrefillClase({ fecha, hora, alumnoIds });
  };

  const [loading, setLoading] = useState(true);
  const [toast, setToast] = useState("");
  const [deletingInfo, setDeletingInfo] = useState({ id: null, type: null, collection: null });
  const [payingClase, setPayingClase] = useState(null);
  const [focusAlumnoId, setFocusAlumnoId] = useState(null);
  const openPagoPendiente = (clase, alumnoId) => {
    if (clase) {
      setPayingClase(clase);
      setFocusAlumnoId(alumnoId);
    }
  };
  const [claseParaAgendar, setClaseParaAgendar] = useState(null);
  const [payingCuota, setPayingCuota] = useState({ alumno: null, mes: null });
  const [claseParaEditar, setClaseParaEditar] = useState(null);
  const [nuevoAlumnoId, setNuevoAlumnoId] = useState(null);
  const openRegistrarClaseForAlumno = (alumnoId) => { setCurrent("clases"); setNuevoAlumnoId(alumnoId); };
  const [registrandoAbono, setRegistrandoAbono] = useState(null);
  const [pagoParaEditar, setPagoParaEditar] = useState(null);
  const [clubActivoId, setClubActivoId] = useState(null);
  const [clubes, setClubes] = useState([]);
  const [hasClubs, setHasClubs] = useState(false);

  useEffect(() => {
    if (!user) return;
    setLoading(true);

    const clubsRef = db.collection('users').doc(user.uid).collection('clubs');
    const clubsUnsubscribe = clubsRef.onSnapshot(snapshot => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setClubes(data);
      setHasClubs(data.length > 0);

      if (data.length > 0) {
        if (!clubActivoId) {
          setClubActivoId(data[0].id);
        }
      } else {
        setClubActivoId(null);
      }
      setLoading(false);
    }, error => {
      console.error("Error fetching clubs: ", error);
      setLoading(false);
    });

    return () => clubsUnsubscribe();
  }, [user]);

  useEffect(() => {
    if (!user || !clubActivoId) return;

    const baseRef = db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId);
    
    const profileUnsubscribe = db.collection('users').doc(user.uid).collection('profile').doc('main').onSnapshot(doc => {
      if (doc.exists) {
          setState(prevState => ({ ...prevState, perfil: { ...initialState.perfil, ...doc.data()} }));
      } else {
          setState(prevState => ({ ...prevState, perfil: initialState.perfil }));
      }
    });

    const collections = ['alumnos', 'clases', 'pagos', 'gastos', 'grupos'];
    const unsubscribes = [profileUnsubscribe];

    collections.forEach(collectionName => {
        const unsubscribe = baseRef.collection(collectionName).onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setState(prevState => ({ ...prevState, [collectionName]: data }));
        }, error => console.error(`Error fetching ${collectionName}: `, error));
        unsubscribes.push(unsubscribe);
    });

    return () => unsubscribes.forEach(unsub => unsub());
  }, [user, clubActivoId]);

  const getCollection = (collectionName) => {
    if (!clubActivoId) {
      console.error("No club active. Cannot get collection.");
      return null;
    }
    return db.collection('users').doc(user.uid).collection('clubs').doc(clubActivoId).collection(collectionName);
  };
  // üîπ Overlay de alumnos de users/{uid}/alumnos sobre los alumnos del club (por id)
useEffect(() => {
  if (!user) return;

  const uid = user.uid;
  const unsub = db
    .collection("users").doc(uid)
    .collection("alumnos")
    .onSnapshot(
      (snap) => {
        // Mapeo r√°pido id -> datos (tel√©fono, etc.)
        const byId = new Map(snap.docs.map(d => [d.id, d.data()]));

        // Hago merge sobre lo que ya trae el club (solo si hay coincidencia de id)
        setState(prev => ({
          ...prev,
          alumnos: (prev.alumnos || []).map(a =>
            byId.has(a.id) ? { ...a, ...byId.get(a.id) } : a
          ),
        }));
      },
      (err) => console.error("onSnapshot alumnos (users/{uid}/alumnos):", err)
    );

  return () => unsub();
}, [user, clubActivoId]);

  
  const alumnoCrud = {
  create: async (data) => {
    const collectionRef = getCollection('alumnos');
    if (!collectionRef) return;
    const docRef = await collectionRef.add(data);
    setToast("Alumno creado");
    return { ...data, id: docRef.id };
  },
  update: async ({ id, data }) => {
    const collectionRef = getCollection('alumnos');
    if (!collectionRef) return;
    await collectionRef.doc(id).update(data);
    setToast("Alumno actualizado");
  },
  delete: (id) => setDeletingInfo({ id, type: 'alumno', collection: 'alumnos' }),
};
  const pagoCrud = {
    createPagosClase: async (pagosData) => {
      const batch = db.batch();
      const collectionRef = getCollection('pagos');
      if (!collectionRef) return;
      // Actualizar el estado 'pagada' de la clase al guardar el pago.
      const claseRef = getCollection('clases').doc(payingClase.id);

      pagosData.forEach(pago => {
        if (parseFloat(pago.monto) > 0 || pago.metodo === 'Pendiente') {
            const docRef = collectionRef.doc();
            const payload = {
                claseId: payingClase.id,
                alumnoId: pago.alumnoId,
                fecha: payingClase.fecha,
                concepto: `Pago Clase ${payingClase.tipo}`,
                metodo: pago.metodo,
                monto: pago.monto
            };
            if (pago.metodo === 'Mixto') {
                payload.detalleMixto = {
                    efectivo: parseFloat(pago.mixtoEfectivo) || 0,
                    transferencia: parseFloat(pago.mixtoTransferencia) || 0
                };
            }
            batch.set(docRef, payload);
        }
      });
      await batch.commit();

      // Recalcular el estado de la clase despu√©s de que los nuevos pagos se hayan guardado.
      const pagosExistentes = await getCollection('pagos').where('claseId', '==', payingClase.id).get();
      const totalPagadoAcumulado = pagosExistentes.docs.reduce((sum, doc) => {
          const pago = doc.data();
          return sum + parseFloat(pago.monto || 0);
      }, 0);

      const claseDoc = await claseRef.get();
      if (claseDoc.exists) {
          const precioTotalClase = parseFloat(claseDoc.data().precio);
          const estaPagada = totalPagadoAcumulado >= precioTotalClase;
          await claseRef.update({ pagada: estaPagada });
      }

      setToast("Pagos registrados");
      setPayingClase(null);
      setFocusAlumnoId(null);
      setClaseParaAgendar(payingClase);
    },
    createAbono: (pagoData, alumno) => {
      const collectionRef = getCollection('pagos');
      if (!collectionRef) return;
      const newPago = {
        alumnoId: alumno.id,
        fecha: pagoData.fechaPago,
        concepto: pagoData.concepto || `Abono Mensual - ${MESES_NOMBRES[pagoData.mes]}`,
        monto: pagoData.monto,
        metodo: pagoData.metodo
      };
      collectionRef.add(newPago).then(() => {
        setToast("Pago de abono registrado con √©xito");
        setRegistrandoAbono(null);
      });
    },
    createMensual: async (pagoData) => {
  const collectionRef = getCollection('pagos');
  if (!collectionRef) return;

  const { alumno, mes } = payingCuota || {};
  if (!alumno || mes == null) {
    setToast("Seleccion√° alumno y mes");
    return;
  }

  // Fecha segura del mes (d√≠a 1 y hora 12:00 para evitar issues de TZ)
  const fecha = new Date();
  fecha.setHours(12, 0, 0, 0);
  fecha.setMonth(mes, 1); // mes es 0..11

  const newPago = {
    alumnoId: alumno.id,
    fecha: formatDate(fecha),
    concepto: `Cuota Mensual - ${MESES_NOMBRES[mes]}`,
    ...pagoData, // { monto, metodo, notas, etc. }
  };

  try {
    // 1) Guardar el pago
    await collectionRef.add(newPago);

    // 2) Marcar la mensualidad como pagada (YYYY-MM)
    const y = fecha.getFullYear();
    const mm = String(fecha.getMonth() + 1).padStart(2, "0");
    await marcarPagoMensualidad({
      user,
      clubId: clubActivoId,
      alumnoId: alumno.id,
      mes: `${y}-${mm}`,
    });

    setToast("Pago de cuota registrado");
  } catch (e) {
    console.error("createMensual error:", e);
    setToast("No se pudo registrar el pago");
  } finally {
    setPayingCuota({ alumno: null, mes: null });
  }
},

    update: ({ id, ...data }) => {
      const collectionRef = getCollection('pagos');
      if (!collectionRef) return;
      const dataToSave = { ...data };
      if (data.metodo === 'Mixto') {
        dataToSave.detalleMixto = {
          efectivo: parseFloat(data.mixtoEfectivo) || 0,
          transferencia: parseFloat(data.mixtoTransferencia) || 0
        };
      }
      delete dataToSave.mixtoEfectivo;
      delete dataToSave.mixtoTransferencia;
      return collectionRef.doc(id).update(dataToSave).then(() => {
        setToast("Pago actualizado con √©xito");
        setPagoParaEditar(null);
      });
    }
  };
 const claseCrud = {
  create: async (c) => {
    const collectionRef = getCollection('clases');
    if (!collectionRef) return;
    const claseData = { ...c };
    delete claseData.id;

    const shouldPay = claseData.estado === 'Realizada' || claseData.estado === 'Ausente';

    let nuevaClaseId;

    if (claseData.recurrente) {
      const batch = db.batch();
      const semanas = parseInt(claseData.mesesRecurrencia, 10) * 4;
      for (let i = 0; i < semanas; i++) {
          const nuevaFecha = addDays(new Date(claseData.fecha), i * 7);
          const newClase = { ...claseData, fecha: formatDate(nuevaFecha), recurrente: false };
          const docRef = collectionRef.doc();
          batch.set(docRef, newClase);
      }
      await batch.commit();
      setToast("Clases recurrentes creadas");
    } else {
      const docRef = await collectionRef.add(claseData);
      nuevaClaseId = docRef.id;
      setToast("Clase creada");
    }

    if (shouldPay && nuevaClaseId) {
  // Precio prorrateado por alumno
  const count = (claseData.alumnoIds || []).length || 1;
  const total = Number(claseData.precio) || 0;
  const precioPorAlumno = Math.round((total / count) * 100) / 100;

  for (const alumnoId of (claseData.alumnoIds || [])) {
    const alumnoObj = (state.alumnos || []).find(a => a.id === alumnoId);
    if (!alumnoObj) continue;

    // S√≥lo para planes mensuales
    if (alumnoObj.plan === "mensual") {
      await cubrirClaseConMensualidadSiCorresponde({
        user,
        clubId: clubActivoId,
        alumno: alumnoObj,
        claseId: nuevaClaseId,
        fecha: claseData.fecha,        // mismo formato que us√°s en 'pagos'
        precioPorAlumno,               // excedente si no hay cupo
        perfil: state.perfil,
      });
    }
  }
}
  },
update: async ({ id, ...data }) => {
  const collectionRef = getCollection('clases');
  if (!collectionRef) return;

  await collectionRef.doc(id).update(data);
  setToast("Clase actualizada");

  const shouldPay = data.estado === 'Realizada' || data.estado === 'Ausente';
  if (shouldPay) {
    try {
      // ‚úÖ Nuevo bloque
const fechaClase = claseData.fecha;
const precioTotal = parseFloat(claseData.precio || 0) || 0;
const cant = (claseData.alumnoIds || []).length || 1;
const precioPorAlumno = cant > 0 ? (precioTotal / cant) : precioTotal;

for (const idAl of (claseData.alumnoIds || [])) {
  const alumno = (state.alumnos || []).find(a => a.id === idAl);
  if (alumno && alumno.plan === 'mensual') {
    await cubrirClaseConMensualidadSiCorresponde({
      user,
      clubId: clubActivoId,
      alumno,
      claseId: nuevaClaseId,
      fecha: fechaClase,
      precioPorAlumno,
      perfil: state.perfil,
    });
  }
}

    } catch (e) {
      console.error('consumirClaseMensual(update):', e);
    }
    onPay({ ...data, id });
  }
},

  delete: (id) => setDeletingInfo({ id, type: 'clase', collection: 'clases' }),
};
  const gastoCrud = {
    create: (g) => {
      const collectionRef = getCollection('gastos');
      if (!collectionRef) return;
      return collectionRef.add(g).then(() => setToast("Gasto creado"));
    },
    update: ({ id, ...data }) => {
      const collectionRef = getCollection('gastos');
      if (!collectionRef) return;
      return collectionRef.doc(id).update(data).then(() => setToast("Gasto actualizado"));
    },
    delete: (id) => setDeletingInfo({ id, type: 'gasto', collection: 'gastos' }),
  };
  const perfilCrud = {
    update: (p) => db.collection('users').doc(user.uid).collection('profile').doc('main').set(p, { merge: true }).then(() => setToast("Perfil actualizado"))
  };

  const confirmDelete = async () => {
    const { id, type, collection } = deletingInfo;
    if (!id || !collection) return;
    const collectionRef = getCollection(collection);
    if (!collectionRef) return;
    await collectionRef.doc(id).delete();
    if (type === 'clase') {
      const pagosSnapshot = await getCollection('pagos').where('claseId', '==', id).get();
      const batch = db.batch();
      pagosSnapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    }
    setToast(`${type.charAt(0).toUpperCase() + type.slice(1)} eliminado/a`);
    setDeletingInfo({ id: null, type: null, collection: null });
  };
  const handleRegisterMonthlyPayment = (alumno) => {
    setRegistrandoAbono(alumno);
  };

  const handleExportData = () => {
    const dataToExport = {
      alumnos: state.alumnos,
      clases: state.clases,
      pagos: state.pagos,
      gastos: state.gastos,
      perfil: state.perfil,
      grupos: state.grupos || []
    };
    const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(dataToExport, null, 2))}`;
    const link = document.createElement("a");
    link.href = jsonString;
    const date = new Date().toISOString().slice(0, 10);
    link.download = `coachex_backup_${date}.json`;
    link.click();
    setToast("Datos exportados con √©xito.");
  };

  const handleImportData = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        const confirmImport = window.confirm(
          "¬°ATENCI√ìN! ¬øEst√°s seguro de que quieres importar estos datos?\n\n" +
          "TODOS TUS DATOS ACTUALES SER√ÅN BORRADOS Y REEMPLAZADOS.\n\n" +
          "Esta acci√≥n no se puede deshacer."
        );
        if (confirmImport) {
          setToast("Importando datos... La p√°gina se recargar√° al finalizar.");
          console.log("Datos a importar:", importedData);
          alert("La funcionalidad de escritura en la base de datos est√° pendiente. Revisa la consola para ver los datos que se importar√≠an.");
        }
      } catch (error) {
        alert("El archivo seleccionado no es un JSON v√°lido o est√° corrupto.");
        console.error("Error al parsear JSON:", error);
      } finally {
        event.target.value = null;
      }
    };
    reader.readAsText(file);
  };
  const goToEditClass = (clase) => {
    setClaseParaEditar(clase);
    setCurrent("clases");
  };
  const handleDeletePago = (pagoId) => {
    setDeletingInfo({ id: pagoId, type: 'pago', collection: 'pagos' });
  };

  if (loading) {
    return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;
  }

  if (!hasClubs) {
  return (
    <OnboardingClubSetup
      user={user}
      setHasClubs={setHasClubs}
      onLogout={onLogout}
    />
  );
}

  return (
    <div className="min-h-screen bg-slate-50 font-sans">
      <Topbar
        current={current}
        setCurrent={setCurrent}
        onLogout={onLogout}
        clubes={clubes}
        clubActivoId={clubActivoId}
        onClubChange={setClubActivoId}
        showIndependentOption={false}
      />
      <main className="max-w-6xl mx-auto px-4 py-6 grid gap-4">
        {current === "dashboard" && <Dashboard
          perfil={state.perfil}
          clases={state.clases}
          pagos={state.pagos}
          gastos={state.gastos}
          alumnos={state.alumnos}
          clubes={clubes}
          clubActivoId={clubActivoId}
          goToNewClass={(prefill) => { setPrefillClase(prefill || null); setCurrent('clases'); setTimeout(() => document.querySelector('#nueva-clase-btn')?.click(), 50); }}
          goToEditClass={goToEditClass}
        />}
        {current === "alumnos" && (
  <Alumnos
    clases={state.clases}
    pagos={state.pagos}
    alumnos={state.alumnos}
    onCreate={alumnoCrud.create}
    onUpdate={alumnoCrud.update}
    onDelete={alumnoCrud.delete}
    onRegisterMonthlyPayment={handleRegisterMonthlyPayment}
    onRegistrarClase={openRegistrarClaseForAlumno}
    onPagarPendiente={openPagoPendiente}
    onEditarPago={(pago) => setPagoParaEditar(pago)}
    onDeletePago={handleDeletePago}
    /* üëá a√±adidos */
    user={user}
    clubActivoId={clubActivoId}
    perfil={state.perfil}
  />
)}
        {current === "clases" && <Clases
          clases={state.clases}
          alumnos={state.alumnos}
          pagos={state.pagos}
          perfil={state.perfil}
          onCreate={claseCrud.create}
          onUpdate={claseCrud.update}
          onDelete={claseCrud.delete}
          onPay={(clase) => setPayingClase(clase)}
          user={user}
          claseParaEditar={claseParaEditar}
          setClaseParaEditar={setClaseParaEditar}
          nuevoAlumnoId={nuevoAlumnoId}
          setNuevoAlumnoId={setNuevoAlumnoId}
          prefillClase={prefillClase}
          onPrefillConsumed={() => setPrefillClase(null)}
          grupos={state.grupos}
        />}
        {current === "grupos" && <Grupos alumnos={state.alumnos} user={user} clubActivoId={clubActivoId} />}
        {current === "pagos" && <Pagos pagos={state.pagos} alumnos={state.alumnos} clases={state.clases} perfil={state.perfil} onPayMensual={(alumno, mes) => setPayingCuota({ alumno, mes })} onEditarPago={(pago) => setPagoParaEditar(pago)} onDeletePago={handleDeletePago} />}
        {current === "gastos" && <Gastos gastos={state.gastos} onCreate={gastoCrud.create} onUpdate={gastoCrud.update} onDelete={gastoCrud.delete} />}
        {current === "reportes" && <Reportes pagos={state.pagos} gastos={state.gastos} alumnos={state.alumnos} clases={state.clases} clubActivoId={clubActivoId} clubes={clubes} perfil={state.perfil} />}
        {current === "perfil" && <Perfil
          perfil={state.perfil}
          alumnos={state.alumnos}
          clases={state.clases}
          pagos={state.pagos}
          gastos={state.gastos}
          grupos={state.grupos}
          onUpdate={perfilCrud.update}
          user={user}
          setToast={setToast}
          getCollection={getCollection}
          perfilCrud={perfilCrud}
        />}
      </main>
      <Toast msg={toast} onClose={() => setToast("")} />
      <Modal isOpen={!!deletingInfo.id} title={`Eliminar ${deletingInfo.type}`} onConfirm={confirmDelete} onCancel={() => setDeletingInfo({ id: null, type: null, collection: null })} >
        ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.
      </Modal>
      <PagoGrupalModal
        isOpen={!!payingClase}
        clase={payingClase}
        alumnos={state.alumnos}
        onCancel={() => { setPayingClase(null); setFocusAlumnoId(null); }}
        focusAlumnoId={focusAlumnoId} onSave={pagoCrud.createPagosClase}
      />
      <RegistroPagoMensualModal
        isOpen={!!registrandoAbono}
        alumno={registrandoAbono}
        perfil={state.perfil}
        onCancel={() => setRegistrandoAbono(null)}
        onSave={(pagoData) => pagoCrud.createAbono(pagoData, registrandoAbono)}
      />
      <PagoMensualModal isOpen={!!payingCuota.alumno} alumno={payingCuota.alumno} mes={payingCuota.mes} onCancel={() => setPayingCuota({ alumno: null, mes: null })} onSave={pagoCrud.createMensual} />
      <EditarPagoModal
        isOpen={!!pagoParaEditar}
        pago={pagoParaEditar}
        onCancel={() => setPagoParaEditar(null)}
        onSave={pagoCrud.update}
            />
            <AgendarProximaClaseModal
          isOpen={!!claseParaAgendar}
          onClose={() => setClaseParaAgendar(null)}
          onSchedule={claseCrud.create}
          claseBase={claseParaAgendar}
          alumnos={state.alumnos}
      />
      <footer className="text-center text-xs text-slate-500 py-6">Coachex-Pro ¬∑ Gesti√≥n de Profesores</footer>
    </div>
  );
}

function AgendarProximaClaseModal({ isOpen, onClose, onSchedule, claseBase, alumnos }) {
    const nextWeekDate = addDays(new Date(claseBase?.fecha), 7);
    const [form, setForm] = useState({
        fecha: formatDate(nextWeekDate),
        hora: claseBase?.hora || "",
        precio: claseBase?.precio || 0,
        tipo: normalizarTipoClase(claseBase?.tipo) || "Clase 1 persona",
        alumnoIds: claseBase?.alumnoIds || []
    });

    const alumnoMap = useMemo(() => new Map((alumnos || []).map(a => [a.id, a])), [alumnos]);

    useEffect(() => {
        if (claseBase) {
            const nextWeekDate = addDays(new Date(claseBase.fecha), 7);
            setForm({
                fecha: formatDate(nextWeekDate),
                hora: claseBase.hora || "",
                precio: claseBase.precio || 0,
                tipo: normalizarTipoClase(claseBase.tipo) || "Clase 1 persona",
                alumnoIds: claseBase.alumnoIds || []
            });
        }
    }, [claseBase]);

    const handleFormChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, [name]: name === 'tipo' ? normalizarTipoClase(value) : value }));
    };

    const handleAlumnoChange = (index, newId) => {
        const newAlumnoIds = [...form.alumnoIds];
        newAlumnoIds[index] = newId;
        setForm(prev => ({ ...prev, alumnoIds: newAlumnoIds }));
    };

    const handleSchedule = () => {
        if (form.alumnoIds.length === 0 || !form.fecha || !form.hora) {
            alert("Por favor, completa la fecha, hora y al menos un alumno.");
            return;
        }
        onSchedule(form);
        onClose();
    };

    const getNombreCompleto = (a) => a ? `${a.apellido || ''} ${a.nombre || ''}`.trim() : 'Alumno eliminado';
    const alumnosActivos = (alumnos || []).filter(a => a.estado === 'activo');

    if (!isOpen || !claseBase) return null;

    return (
        <Modal 
            isOpen={isOpen} 
            title="Agendar pr√≥xima clase" 
            onCancel={onClose} 
            onConfirm={handleSchedule} 
            confirmText="Agendar Clase"
            size="2xl"
        >
            <div className="space-y-4">
                <p className="text-sm text-slate-600">
                    Se acaba de registrar el pago para la clase de hoy. ¬øDeseas agendar la pr√≥xima?
                </p>
                <div className="grid md:grid-cols-2 gap-4 p-4 border rounded-xl bg-slate-50">
                    <div>
                        <label className="text-sm text-slate-600">Fecha</label>
                        <input 
                            type="date" 
                            name="fecha" 
                            value={form.fecha} 
                            onChange={handleFormChange} 
                            className="w-full border rounded-lg px-3 py-2 mt-1" 
                        />
                    </div>
                    <div>
                        <label className="text-sm text-slate-600">Hora</label>
                        <input 
                            type="time" 
                            name="hora" 
                            value={form.hora} 
                            onChange={handleFormChange} 
                            className="w-full border rounded-lg px-3 py-2 mt-1" 
                        />
                    </div>
                    <div>
                        <label className="text-sm text-slate-600">Precio</label>
                        <input 
                            type="number" 
                            name="precio" 
                            value={form.precio} 
                            onChange={handleFormChange} 
                            className="w-full border rounded-lg px-3 py-2 mt-1" 
                        />
                    </div>
                    <div>
                        <label className="text-sm text-slate-600">Tipo de Clase</label>
                        <select 
                            name="tipo" 
                            value={form.tipo} 
                            onChange={handleFormChange} 
                            className="w-full border rounded-lg px-3 py-2 mt-1"
                        >
                            {TIPOS_CLASE.map(t => <option key={t}>{t}</option>)}
                        </select>
                    </div>
                </div>

                <div className="p-4 border rounded-xl bg-slate-50">
                    <label className="text-sm text-slate-600">Alumnos</label>
                    <div className="grid gap-2 mt-1">
                        {(form.alumnoIds || []).map((alumnoId, index) => (
                            <div key={index}>
                                <select 
                                    value={alumnoId} 
                                    onChange={e => handleAlumnoChange(index, e.target.value)} 
                                    className="w-full border rounded-lg px-3 py-2"
                                >
                                    <option value="">Seleccionar...</option>
                                    {alumnosActivos.map(a => (
                                        <option key={a.id} value={a.id}>{getNombreCompleto(a)}</option>
                                    ))}
                                </select>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </Modal>
    );
}

    // ------------------------------ APP WRAPPER WITH AUTH ------------------------------
    function AppGPadel() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(user => {
                setUser(user);
                setLoading(false);
            });
            return () => unsubscribe();
        }, []);

        if (loading) {
            return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;
        }

        if (!user) {
            return <LoginScreen />;
        }

        return <MainApp user={user} onLogout={() => auth.signOut()} />;
    }
    
    
class ErrorBoundary extends React.Component {
  constructor(props) { super(props); this.state = { hasError: false }; }
  static getDerivedStateFromError() { return { hasError: true }; }
  componentDidCatch(error, info) { console.error("Error en ErrorBoundary:", error, info); }
  render() {
    if (this.state.hasError) {
      return <div className="p-6 text-center text-red-700">Ocurri√≥ un error en la vista. Prob√° recargar o volver al inicio.</div>;
    }
    return this.props.children;
  }
}

ReactDOM.render(<ErrorBoundary><AppGPadel /></ErrorBoundary>, document.getElementById('root'));


// === Comprobante de pago (PDF) + WhatsApp ===
if (!window.coachexComprobante) {
  window.coachexComprobante = {};
}
(function(){
  // Safe guard for jsPDF
  const hasJsPDF = !!(window.jspdf && window.jspdf.jsPDF);
  function asMoney(n){ try { return Number(n || 0).toLocaleString('es-AR', {minimumFractionDigits:2, maximumFractionDigits:2}); } catch(e){ return String(n || 0); } }
  function safeDateStr(d){ try { return formatDate(d, 'dd/mm/yyyy'); } catch(e){ return formatDate(d); } }

  // Genera y descarga el PDF del comprobante
  window.coachexComprobante.generarPDF = function({ alumno, pago, clase, perfil }){
    if (!hasJsPDF) { alert("No se encontr√≥ jsPDF. Verific√° la conexi√≥n o el script de jsPDF."); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const nombreAlumno = (typeof getNombreCompleto === 'function') ? (getNombreCompleto(alumno) || 'Alumno') : (alumno?.nombre || 'Alumno');
    const fechaClase = clase?.fecha ? safeDateStr(clase.fecha) : (pago?.fecha ? safeDateStr(pago.fecha) : '-');
    const metodo = pago?.metodo || 'Efectivo';
    const monto = asMoney(pago?.monto ?? clase?.precio ?? 0);
    const concepto = pago?.concepto || (clase?.tipo ? `Pago de ${clase.tipo}` : 'Pago de clase');

    doc.setFontSize(14);
    doc.text("COMPROBANTE DE PAGO", 14, 18);
    doc.setFontSize(11);

    const filas = [
      ["Alumno", nombreAlumno],
      ["Fecha", fechaClase],
      ["Concepto", concepto],
      ["M√©todo", metodo],
      ["Monto", `$ ${monto}`],
      ["Profesor", `${perfil?.nombre || "Profe"} ${perfil?.apellido || ""}`.trim()],
    ];
    let y = 30;
    filas.forEach(([k,v]) => { doc.text(`${k}: ${v}`, 14, y); y += 8; });
    doc.setLineWidth(0.4); doc.line(14, y, 196, y); y += 10;
    doc.setFontSize(10); doc.text("¬°Gracias por entrenar!", 14, y);

    const fname = `comprobante_${nombreAlumno.replace(/\s+/g,'_')}_${Date.now()}.pdf`;
    doc.save(fname);
  };

  // Link de WhatsApp con texto prellenado
  window.coachexComprobante.waLink = function(alumno, texto){
    try {
      const digits = String(alumno?.telefono || alumno?.whatsapp || "").replace(/[^0-9]/g, "");
      if (!digits) return null;
      const msg = texto || "Te env√≠o el comprobante de pago.";
      return `https://wa.me/${digits}?text=${encodeURIComponent(msg)}`;
    } catch(e){
      return null;
    }
  };
})();
</script>


<script>
  window.addEventListener('load', function(){
    var el = document.getElementById('app-loader');
    if (el) el.style.display = 'none';
  });
</script>

</body>
</html>
